<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>终于用 pixi 搞定了用于自动构建的 recipe 和 action：踩坑与解决方案</title>
      <link href="/2026/02/02/%E7%BB%88%E4%BA%8E%E7%94%A8pixi%E6%90%9E%E5%AE%9A%E4%BA%86%E7%94%A8%E4%BA%8E%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E7%9A%84recipe%E5%92%8Caction/"/>
      <url>/2026/02/02/%E7%BB%88%E4%BA%8E%E7%94%A8pixi%E6%90%9E%E5%AE%9A%E4%BA%86%E7%94%A8%E4%BA%8E%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E7%9A%84recipe%E5%92%8Caction/</url>
      
        <content type="html"><![CDATA[<p>新工具总是这样：好用的地方让人惊艳，但尚未完善的部分却让人头疼。最近我尝试使用 pixi 和 rattler‑build 搭建一个自动化构建系统，用于定期打包并上传 opencode 到 prefix.dev。整个过程耗时约 6 小时，期间遇到了不少预料之外的问题。</p><span id="more"></span><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>之前我已经成功为 opencode 创建了 recipe 并手动上传到了 prefix.dev。但 opencode 的更新频率相当高，我不可能每次都手动跟进。于是我想构建一个类似 bioconda 的自动化系统：存放 recipe，并通过 GitHub Action 自动检测新版本、构建并上传 conda 包。</p><p>感觉这工作应该不难？毕竟 recipe 已经有了，写个 Action 应该易如反掌，更何况还有 AI 辅助。然而这其中碰到的坑比我想的多的多的多…</p><h2 id="主要挑战与解决方案"><a href="#主要挑战与解决方案" class="headerlink" title="主要挑战与解决方案"></a>主要挑战与解决方案</h2><h3 id="1-recipe-的-context-中不能使用-if‑then-判断"><a href="#1-recipe-的-context-中不能使用-if‑then-判断" class="headerlink" title="1. recipe 的 context 中不能使用 if‑then 判断"></a>1. recipe 的 context 中不能使用 if‑then 判断</h3><p>在 rattler‑build 的 recipe 中，<code>context</code> 部分用于定义变量，但这里<strong>不能</strong>像build里那样使用条件判断。AI 也是说 context 的部分只能静态的定义变量。然而这个说法… 对也不对。对的是，在 yaml 的语法内，确实是只能定义变量的，但是… rattler-build 其实是会先用 jinjia（是的又是jijia）来渲染出一个配置文件的，因此支持的 minijinjia 函数是可以实现判断的：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">context:</span></span><br><span class="line">  <span class="attr">architect:</span> <span class="string">$&#123;&#123;</span> <span class="string">&quot;linux‑x64&quot;</span> <span class="string">if</span> <span class="string">platform</span> <span class="string">==</span> <span class="string">&quot;linux‑64&quot;</span> <span class="string">else</span> <span class="string">&quot;linux‑arm64&quot;</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-bump‑recipe-与-build-部分的兼容性问题"><a href="#2-bump‑recipe-与-build-部分的兼容性问题" class="headerlink" title="2. bump‑recipe 与 build 部分的兼容性问题"></a>2. bump‑recipe 与 build 部分的兼容性问题</h3><p>rattler‑build 的 <code>bump‑recipe</code> 功能可以自动更新 recipe 中的版本和 sha256，这非常方便，我可以不用在后续的 workflow 中用额外的 step 去进行一些操作了。但是，这个功能要求 recipe 的 <code>build</code> 部分不能包含条件判断。我之前的手动 recipe 在 build 部分使用了 if‑then，导致无法使用 bump‑recipe 功能。</p><p>于是我在更新后的 recipe 中全部使用 minijinjia 的函数， 不再使用 yaml 支持的特殊语法了。</p><h3 id="3-AI-关于环境变量引用的错误描述"><a href="#3-AI-关于环境变量引用的错误描述" class="headerlink" title="3. AI 关于环境变量引用的错误描述"></a>3. AI 关于环境变量引用的错误描述</h3><p>当我询问 AI 如何在 recipe 中引用环境变量时，得到的回答是使用 <code>$&#123;&#123; VAR_NAME &#125;&#125;</code>。这也是不正确的， 同样得通过 minijinja 模板引擎实现，语法如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">context:</span></span><br><span class="line">  <span class="attr">platform:</span> &#123;&#123; <span class="string">env.get(&quot;TARGET_PLATFORM&quot;</span>, <span class="string">default=&quot;linux‑64&quot;)</span> &#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="4-pixi-build-只能指定-platform，版本控制需另寻他法"><a href="#4-pixi-build-只能指定-platform，版本控制需另寻他法" class="headerlink" title="4. pixi build 只能指定 platform，版本控制需另寻他法"></a>4. pixi build 只能指定 platform，版本控制需另寻他法</h3><p>我需要在一台机器上交叉处理其他平台的可执行文件，同时也需要指定处理的软件版本，再同时，我还希望使用 <code>pixi build</code> 来构建， 而不是 <code>rattler-build build</code>，这又踩了个坑， <code>pixi build</code> 目前是实验性质功能，因此它尚不能对 <code>rattler-build</code> 传递太多参数，目前只能通过环境变量来让 <code>pixi</code> 和 <code>rattler-build build</code> 获得一致的参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TARGET_PLATFORM=linux‑64 VERSION=1.1.35 pixi build</span><br></pre></td></tr></table></figure><p>然后在 recipe 中通过 <code>&#123;&#123; env.get("VERSION") &#125;&#125;</code> 来获取。</p><h3 id="5-pixi-内置脚本的变量传递限制"><a href="#5-pixi-内置脚本的变量传递限制" class="headerlink" title="5. pixi 内置脚本的变量传递限制"></a>5. pixi 内置脚本的变量传递限制</h3><p>由于要使用 <code>rattler-build bump-recipe</code>，为了让 action 和手动构建时输入的内容一致，也为了简单，我设置了 tasks，于是又是一坑，pixi 可以给 task 依赖传参数，但是不能指定环境变量（我前面要用环境变量来设置构建参数），当然这个问题还好，都是 shell，传不了我当参数传过去， 然后手动设置环境变量就是：</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[tasks.bump]</span></span><br><span class="line"><span class="attr">cmd</span> = <span class="string">&quot;TARGET_PLATFORM=&#123;&#123; platform &#125;&#125; rattler-build bump-recipe&quot;</span></span><br><span class="line"><span class="attr">args</span> = [    </span><br><span class="line">    &#123; arg = <span class="string">&quot;platform&quot;</span>, default = <span class="string">&quot;linux-64&quot;</span> &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="section">[tasks.build]</span></span><br><span class="line"><span class="attr">cmd</span> = <span class="string">&quot;TARGET_PLATFORM=&#123;&#123; platform &#125;&#125; pixi build -t &#123;&#123; platform &#125;&#125;&quot;</span></span><br><span class="line"><span class="attr">args</span> = [<span class="string">&quot;platform&quot;</span>]</span><br><span class="line"><span class="attr">depends-on</span> = [&#123; task = <span class="string">&quot;bump&quot;</span>, args = [<span class="string">&quot;&#123;&#123; platform &#125;&#125;&quot;</span>] &#125;]</span><br></pre></td></tr></table></figure><p>这里有要注意的一点是，build任务中必须环境变量和参数都指定平台信息，<code>pixi build</code> 似乎并不读<code>TARGET_PLATFORM</code>这个环境变量，因此要<code>-t</code>来指定平台，如果不指定，实际上会使用当前平台作为默认值，导致跨平台构建失败。</p><h3 id="6-prefix-dev-缺少查询-API，需用-pixi-search-解析"><a href="#6-prefix-dev-缺少查询-API，需用-pixi-search-解析" class="headerlink" title="6. prefix.dev 缺少查询 API，需用 pixi search 解析"></a>6. prefix.dev 缺少查询 API，需用 pixi search 解析</h3><p>目前 prefix.dev 似乎没有提供专门的 API 来指定 conda 包查询对应版本信息。这个好解决，解析 <code>pixi search</code> 命令的输出就成，shell 作为万能胶水还是必不可少啊…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">version=$(pixi search -q --no‑progress -p linux‑64 -c https://prefix.dev/sylens opencode | grep -oP <span class="string">&#x27;\K[0‑9]+\.[0‑9]+\.[0‑9]+&#x27;</span> | <span class="built_in">head</span> -1)</span><br></pre></td></tr></table></figure><h3 id="7-bump‑recipe-的重复下载问题"><a href="#7-bump‑recipe-的重复下载问题" class="headerlink" title="7. bump‑recipe 的重复下载问题"></a>7. bump‑recipe 的重复下载问题</h3><p><code>rattler‑build bump‑recipe</code> 在更新 sha256 时会下载一次源码包，而随后的 <code>pixi build</code> 又会再次下载相同的包。这种重复下载在网速较慢或包较大时会显著增加构建时间。不过，这个目前确实无解，还好不影响功能实现。</p><h2 id="完整实现"><a href="#完整实现" class="headerlink" title="完整实现"></a>完整实现</h2><p>经过多次调整，最终的 pixi 项目配置如下：</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Sylens Wong &lt;qiumin14@163.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda‑forge&quot;</span>]</span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;opencode‑recipe&quot;</span></span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux‑aarch64&quot;</span>, <span class="string">&quot;linux‑64&quot;</span>]</span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">preview</span> = [<span class="string">&quot;pixi‑build&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line">rattler‑<span class="attr">build</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tasks.bump]</span></span><br><span class="line"><span class="attr">cmd</span> = <span class="string">&quot;TARGET_PLATFORM=&#123;&#123; platform &#125;&#125; &amp;&amp; rattler‑build bump‑recipe&quot;</span></span><br><span class="line"><span class="attr">args</span> = [    </span><br><span class="line">    &#123; arg = <span class="string">&quot;platform&quot;</span>, default = <span class="string">&quot;linux‑64&quot;</span> &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="section">[tasks.build]</span></span><br><span class="line"><span class="attr">cmd</span> = <span class="string">&quot;TARGET_PLATFORM=&#123;&#123; platform &#125;&#125; &amp;&amp; pixi build -t &#123;&#123; platform &#125;&#125;&quot;</span></span><br><span class="line"><span class="attr">args</span> = [<span class="string">&quot;platform&quot;</span>]</span><br><span class="line">depends‑<span class="attr">on</span> = [&#123; task = <span class="string">&quot;bump&quot;</span>, args = [<span class="string">&quot;&#123;&#123; platform &#125;&#125;&quot;</span>] &#125;]</span><br><span class="line"></span><br><span class="line"><span class="section">[package.build.backend]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;pixi‑build‑rattler‑build&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.3.*&quot;</span></span><br></pre></td></tr></table></figure><p>recipe 文件的关键部分：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">context:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opencode</span></span><br><span class="line">  <span class="attr">version:</span> &#123;&#123; <span class="string">env.get(&quot;VERSION&quot;</span>, <span class="string">default=&quot;1.1.35&quot;)</span> &#125;&#125;</span><br><span class="line">  <span class="attr">platform:</span> &#123;&#123; <span class="string">env.get(&quot;TARGET_PLATFORM&quot;</span>, <span class="string">default=&quot;linux‑64&quot;)</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">package:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">name</span> &#125;&#125;</span><br><span class="line">  <span class="attr">version:</span> &#123;&#123; <span class="string">version</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">source:</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">https://github.com/anomalyco/opencode/releases/download/v&#123;&#123;</span> <span class="string">version</span> <span class="string">&#125;&#125;/opencode‑&#123;&#123;</span> <span class="string">&quot;linux‑x64&quot;</span> <span class="string">if</span> <span class="string">platform</span> <span class="string">==</span> <span class="string">&quot;linux‑64&quot;</span> <span class="string">else</span> <span class="string">&quot;linux‑arm64&quot;</span> <span class="string">&#125;&#125;.tar.gz</span></span><br><span class="line">  <span class="attr">sha256:</span> &#123;&#123; <span class="string">sha256</span> &#125;&#125;</span><br><span class="line">  <span class="attr">file_name:</span> <span class="string">opencode.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">number:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">string:</span> <span class="string">h&#123;&#123;</span> <span class="string">hash</span> <span class="string">&#125;&#125;_&#123;&#123;</span> <span class="string">platform</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    tar xvf opencode.tar.gz</span></span><br><span class="line"><span class="string">    mkdir -p $PREFIX/bin</span></span><br><span class="line"><span class="string">    mv opencode $PREFIX/bin/opencode</span></span><br><span class="line"><span class="string">    chmod 755 $PREFIX/bin/opencode</span></span><br></pre></td></tr></table></figure><p>GitHub Action 的核心步骤：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">Pixi</span> <span class="string">Task</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    cd opencode</span></span><br><span class="line"><span class="string"></span>    </span><br><span class="line">    <span class="comment"># 获取当前已上传版本</span></span><br><span class="line">    <span class="string">current_version=$(pixi</span> <span class="string">search</span> <span class="string">-q</span> <span class="string">--no‑progress</span> <span class="string">-p</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.platform</span> <span class="string">&#125;&#125;</span> <span class="string">-c</span> <span class="string">https://prefix.dev/sylens</span> <span class="string">opencode</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-oP</span> <span class="string">&#x27;\K[0‑9]+\.[0‑9]+\.[0‑9]+&#x27;</span> <span class="string">|</span> <span class="string">head</span> <span class="number">-1</span><span class="string">)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取上游最新版本</span></span><br><span class="line">    <span class="string">upstream_version=&quot;$&#123;&#123;</span> <span class="string">steps.origin_release.outputs.release</span> <span class="string">&#125;&#125;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">if</span> [ <span class="string">&quot;$upstream_version&quot;</span> <span class="type">!=</span> <span class="string">&quot;v$current_version&quot;</span> ]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">      <span class="string">echo</span> <span class="string">&quot;检测到新版本: $upstream_version (当前: $current_version)&quot;</span></span><br><span class="line">      <span class="string">export</span> <span class="string">VERSION=$&#123;upstream_version#v&#125;</span></span><br><span class="line">      <span class="string">pixi</span> <span class="string">run</span> <span class="string">build</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.platform</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">pixi</span> <span class="string">upload</span> <span class="string">prefix</span> <span class="string">opencode*.conda</span> <span class="string">-c</span> <span class="string">sylens</span></span><br><span class="line">    <span class="string">else</span></span><br><span class="line">      <span class="string">echo</span> <span class="string">&quot;已是最新版本&quot;</span></span><br><span class="line">    <span class="string">fi</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> conda </tag>
            
            <tag> pixi </tag>
            
            <tag> github action </tag>
            
            <tag> recipe </tag>
            
            <tag> rattler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>想打包个opencode结果又遇坑了</title>
      <link href="/2026/01/31/%E6%83%B3%E6%89%93%E5%8C%85%E4%B8%AAopencode%E7%BB%93%E6%9E%9C%E5%8F%88%E9%81%87%E5%9D%91%E4%BA%86/"/>
      <url>/2026/01/31/%E6%83%B3%E6%89%93%E5%8C%85%E4%B8%AAopencode%E7%BB%93%E6%9E%9C%E5%8F%88%E9%81%87%E5%9D%91%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>上次成功打包了我自己的程序，这想来试个别的，最近 opencode 贼火，我也有在用，刚好 conda 上到目前位置也没有，因此想打包一个。</p><span id="more"></span><h2 id="打包顺利，但是…"><a href="#打包顺利，但是…" class="headerlink" title="打包顺利，但是…"></a>打包顺利，但是…</h2><p>opencode 使用 typescript 编写，同时使用比较新的 bun.js 来进行管理，bun.js 目前在 conda 还没有。另外opencode本身已经为了能在各种环境运行，准备了各种安装包，因此本次编译准备根据 rattler-build 的文档，采用 <a href="https://rattler-build.prefix.dev/latest/tutorials/repackaging">repackaging</a> 的策略来进行，即不进行编译，而是对编译好的包进行解包然后二次打包，类似之前 AUR 中的各种 deb 转 arch 包的情况。</p><p>由于 typescipt 是单文件的程序， 其打包也尤其简单，解压缩出可执行文件放到特定目录就行了。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package:</span><br><span class="line">  name: opencode</span><br><span class="line">  version: 1.1.35</span><br><span class="line"></span><br><span class="line">source:</span><br><span class="line">  - if: <span class="attr">target_platform</span> == <span class="string">&quot;linux-64&quot;</span></span><br><span class="line">    then:</span><br><span class="line">      url: https://github.com/anomalyco/opencode/releases/download/v1.1.35/opencode-linux-x64.tar.gz</span><br><span class="line">      sha256: 451f5a36e2875b5540adf55e8cc9e144902b44959a6f31899fc21876b38b31ae</span><br><span class="line">      file_name: opencode.tar.gz</span><br><span class="line">  - if: <span class="attr">target_platform</span> == <span class="string">&quot;linux-aarch64&quot;</span></span><br><span class="line">    then:</span><br><span class="line">      url: https://github.com/anomalyco/opencode/releases/download/v1.1.35/opencode-linux-arm64.tar.gz</span><br><span class="line">      sha256: e7544ae14afb10e75d28a3623b1fd33d60e17f372106665566ca4e085c2b157b</span><br><span class="line">      file_name: opencode.tar.gz</span><br><span class="line"></span><br><span class="line">build:</span><br><span class="line">  number: 0</span><br><span class="line">  script: |</span><br><span class="line">    tar xvf opencode.tar.gz</span><br><span class="line">    mkdir -p $PREFIX/bin</span><br><span class="line">    mv opencode $PREFIX/bin/opencode</span><br><span class="line">    chmod 755 $PREFIX/bin/opencode</span><br><span class="line">    </span><br><span class="line">requirements:</span><br><span class="line">  build:  </span><br><span class="line">    - tar</span><br><span class="line"></span><br><span class="line">tests:</span><br><span class="line">  - script:</span><br><span class="line">      - opencode -h</span><br><span class="line"></span><br><span class="line">about:</span><br><span class="line">  homepage: https://opencode.ai/</span><br><span class="line">  license: MIT</span><br><span class="line">  summary: &#x27;The open source coding agent.&#x27;</span><br><span class="line">  description: |</span><br><span class="line">    The open source coding agent.</span><br><span class="line">  repository: https://github.com/anomalyco/opencode</span><br></pre></td></tr></table></figure><p>但是问题来了，虽然打包非常顺利，但是与之前无依赖的 Go 程序不同，这次的 conda 包生成后，安装到环境内是不能用的，提示段错误。</p><h2 id="找问题"><a href="#找问题" class="headerlink" title="找问题"></a>找问题</h2><p>于是开始了与 AI 的漫长讨论，最终在 AI 的指导下， 使用 <code>rattler-build</code>，解 conda 包，发现二进制被修改过（md5sum不一致）。进而了解到，不论是 <code>rattller-build</code> 还是 <code>conda-build</code>，都有特别的机制，即对二进制文件进行额外的库路径设置。</p><p>使用 <code>readelf -d opencode</code> 可以看到，相比获得的二进制文件，conda 包里的 opencode 多了一行 <code>Library rpath</code> 内容，就是这个改变导致了程序不能用。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Dynamic section at offset 0xd588 contains 32 entries:</span><br><span class="line">  标记        类型                         名称/值</span><br><span class="line"> 0x000000000000000f (RPATH)              Library rpath: [$ORIGIN/../lib]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             共享库：[libc.so.6]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             共享库：[ld-linux-aarch64.so.1]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             共享库：[libpthread.so.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             共享库：[libdl.so.2]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             共享库：[libm.so.6]</span><br></pre></td></tr></table></figure><p>根据文档，这个修改 rpath 的行为是可以关掉的：</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">package:</span><br><span class="line">  name: opencode</span><br><span class="line">  version: 1.1.35</span><br><span class="line"></span><br><span class="line">source:</span><br><span class="line">  - if: <span class="attr">target_platform</span> == <span class="string">&quot;linux-64&quot;</span></span><br><span class="line">    then:</span><br><span class="line">      url: https://github.com/anomalyco/opencode/releases/download/v1.1.35/opencode-linux-x64.tar.gz</span><br><span class="line">      sha256: 451f5a36e2875b5540adf55e8cc9e144902b44959a6f31899fc21876b38b31ae</span><br><span class="line">      file_name: opencode.tar.gz</span><br><span class="line">  - if: <span class="attr">target_platform</span> == <span class="string">&quot;linux-aarch64&quot;</span></span><br><span class="line">    then:</span><br><span class="line">      url: https://github.com/anomalyco/opencode/releases/download/v1.1.35/opencode-linux-arm64.tar.gz</span><br><span class="line">      sha256: e7544ae14afb10e75d28a3623b1fd33d60e17f372106665566ca4e085c2b157b</span><br><span class="line">      file_name: opencode.tar.gz</span><br><span class="line"></span><br><span class="line">build:</span><br><span class="line">  number: 0</span><br><span class="line">  script: |</span><br><span class="line">    tar xvf opencode.tar.gz</span><br><span class="line">    mkdir -p $PREFIX/bin</span><br><span class="line">    mv opencode $PREFIX/bin/opencode</span><br><span class="line">    chmod 755 $PREFIX/bin/opencode</span><br><span class="line">    </span><br><span class="line">  prefix_detection:</span><br><span class="line">    ignore_binary_files: true</span><br><span class="line">  dynamic_linking:</span><br><span class="line">    binary_relocation: false</span><br><span class="line"></span><br><span class="line">requirements:</span><br><span class="line">  build:  </span><br><span class="line">    - tar</span><br><span class="line"></span><br><span class="line">tests:</span><br><span class="line">  - script:</span><br><span class="line">      - opencode -h</span><br><span class="line"></span><br><span class="line">about:</span><br><span class="line">  homepage: https://opencode.ai/</span><br><span class="line">  license: MIT</span><br><span class="line">  summary: &#x27;The open source coding agent.&#x27;</span><br><span class="line">  description: |</span><br><span class="line">    The open source coding agent.</span><br><span class="line">  repository: https://github.com/anomalyco/opencode</span><br></pre></td></tr></table></figure><p>但是诡异的事情来了，在修改设置后，包内的二进制程序和打包前的 md5 一致后，安装 conda 包依然有段错误，检测安装到环境的包，发现这个 rpath 的改动依然存在。</p><p>由于 pixi 本身比较新，我自己完全检索不到这个问题的相关讨论，于是我开始了为期一周的，与 AI 的 Battle … 最后的结果是，pixi global install 的机制如此，没有办法解决。</p><p>然而，事实并不如此… 我猛然发现，不论我怎么改 Recipe 文件，似乎打出来的包的名称是固定不变的… conda 和 pixi 都有缓存机制，于是我试着把缓存清除掉… 然后，发现能运行了…</p><p>虽然浪费了比较多的时间，好在结果是好的… 目前来说，只依赖 AI，果然还是不完全现实的…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>使用 pixi 和 rattler_build 打包AI帮我写的程序</title>
      <link href="/2026/01/25/%E4%BD%BF%E7%94%A8-pixi-%E5%92%8C-rattler-build-%E6%89%93%E5%8C%85AI%E5%B8%AE%E6%88%91%E5%86%99%E7%9A%84%E7%A8%8B%E5%BA%8F/"/>
      <url>/2026/01/25/%E4%BD%BF%E7%94%A8-pixi-%E5%92%8C-rattler-build-%E6%89%93%E5%8C%85AI%E5%B8%AE%E6%88%91%E5%86%99%E7%9A%84%E7%A8%8B%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<p>之前我已经尝试了修改和添加recipe到conda的频道，这次试试把我的<a href="https://github.com/SilenWang/DevSSH">DevSSH</a>打包上传到我自己的频道内。这次我想试试自己打conda包。</p><span id="more"></span><h2 id="为什么选择pixi和rattler-build？"><a href="#为什么选择pixi和rattler-build？" class="headerlink" title="为什么选择pixi和rattler-build？"></a>为什么选择pixi和rattler-build？</h2><p>这次其实是个巧合… 本来想注册anaconda帐号用<code>conda-build</code>，结果他们官网不知道抽什么风，就是注册不成功，于是直接转prefix.dev了，正好学习一下更新的共苦</p><h2 id="rattler-build简介"><a href="#rattler-build简介" class="headerlink" title="rattler-build简介"></a>rattler-build简介</h2><p><code>rattler-build</code>是开发<code>pixi</code>团队开发的新一代conda包构建工具，它用Rust编写，自然就拥有更快的构建速度，它一定程度上与conda-forge的构建系统兼容，并且与<code>pixi</code>互相进行了一定程度的集成。</p><h2 id="配置pixi-toml"><a href="#配置pixi-toml" class="headerlink" title="配置pixi.toml"></a>配置pixi.toml</h2><p><code>pixi</code>的基本功能是配置开发环境，但是其实它也可以用来配置软件包的构建环境。进行相关的配置需要用到package关键字，同时需要在<code>[workspace]</code>内开启实验性质的<code>pixi-build</code>特性。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Sylens Wong &lt;qiumin14@163.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>]</span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;DevSSH&quot;</span></span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-aarch64&quot;</span>, <span class="string">&quot;linux-64&quot;</span>]</span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.1&quot;</span></span><br><span class="line"><span class="attr">preview</span> = [<span class="string">&quot;pixi-build&quot;</span>] <span class="comment"># 需要开启pixi-build</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tasks]</span></span><br><span class="line"><span class="attr">build</span> = &#123;cmd = <span class="string">&quot;go build -o bin/devssh cmd/devssh/main.go&quot;</span>, cwd = <span class="string">&quot;./&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">[activation.env]</span></span><br><span class="line"><span class="attr">CGO_ENABLED</span> = <span class="string">&quot;0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">go</span> = <span class="string">&quot;&gt;=1.25.4,&lt;2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是构建包的配置部分</span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;DevSSH&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[package.build.backend]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;pixi-build-rattler-build&quot;</span> <span class="comment"># 构建的是go程序，没有专门构建器，所以使用rattler-build</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.3.*&quot;</span> </span><br></pre></td></tr></table></figure><h2 id="编写rattler-build的recipe"><a href="#编写rattler-build的recipe" class="headerlink" title="编写rattler-build的recipe"></a>编写rattler-build的recipe</h2><p>rattler-build使用YAML格式的recipe文件来定义如何构建包，它与<code>conda-build</code>下的recipe是兼容的，不过并不支持所有的<code>conda-build</code> recipe语法。</p><p>以下是为DevSSH编写的recipe：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">package:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">devssh</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">0.1</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">source:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">use_gitignore:</span> <span class="literal">true</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">number:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    # 构建二进制文件</span></span><br><span class="line"><span class="string">    go build -o &quot;$PREFIX/bin/devssh&quot; cmd/devssh/main.go</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="attr">requirements:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">$&#123;&#123;</span> <span class="string">compiler(&#x27;go-nocgo&#x27;)</span> <span class="string">&#125;&#125;</span> <span class="comment"># 我的程序纯go没有c依赖，因此选择nocgo编译器</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">patchelf</span>  <span class="comment"># 执行post-process必须</span></span><br><span class="line"></span><br><span class="line"><span class="attr">about:</span></span><br><span class="line">  <span class="attr">homepage:</span> <span class="string">https://github.com/SilenWang/DevSSH</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">MPL-2.0</span></span><br><span class="line">  <span class="attr">license_file:</span> <span class="string">LICENSE</span></span><br><span class="line">  <span class="attr">summary:</span> <span class="string">&#x27;A CLI tool to quickly set up remote development tools over SSH&#x27;</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    A CLI tool to quickly set up remote development tools over SSH</span></span><br><span class="line"><span class="string"></span>  <span class="attr">repository:</span> <span class="string">https://github.com/SilenWang/DevSSH</span></span><br></pre></td></tr></table></figure><h2 id="构建和上传包"><a href="#构建和上传包" class="headerlink" title="构建和上传包"></a>构建和上传包</h2><h3 id="1-本地构建"><a href="#1-本地构建" class="headerlink" title="1. 本地构建"></a>1. 本地构建</h3><p>如果配置文件设置无问题，执行构建命令应该就能得到conda格式的包了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用pixi构建</span></span><br><span class="line">pixi build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定目标平台构建</span></span><br><span class="line">pixi build -t linux-64</span><br></pre></td></tr></table></figure><p>如果有问题，就一点点问AI，不过值得注意的是，现在rattler-build可能不是太主流，得到的答案经常会是按照conda-build来答的，还是需要自己对着文档去鉴别尝试。</p><h3 id="2-配置prefix-dev账户并上传"><a href="#2-配置prefix-dev账户并上传" class="headerlink" title="2. 配置prefix.dev账户并上传"></a>2. 配置prefix.dev账户并上传</h3><p>上传前还是需要登录了，需要在账户下创建频道和设置API_TOKEN。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置API令牌</span></span><br><span class="line">pixi auth login --token YOUR_API_TOKEN prefix.dev</span><br></pre></td></tr></table></figure><p>设置好了，直接把编译好的内容上传就是，网速好的话很快就完成了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pixi upload prefix devssh-0.1.1-hb0f4dca_0.conda -c sylens</span><br></pre></td></tr></table></figure><h3 id="3-通过频道安装包"><a href="#3-通过频道安装包" class="headerlink" title="3. 通过频道安装包"></a>3. 通过频道安装包</h3><p>用 pixi 或者 conda 都可以安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pixi global install -c https://prefix.dev/sylens devssh</span><br><span class="line"></span><br><span class="line">conda install -c https://prefix.dev/sylens devssh</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pixi </tag>
            
            <tag> rattler-build </tag>
            
            <tag> conda-build </tag>
            
            <tag> Go </tag>
            
            <tag> devssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>到处都有 cherry-pick</title>
      <link href="/2026/01/20/%E5%88%B0%E5%A4%84%E9%83%BD%E6%9C%89cherry-pick/"/>
      <url>/2026/01/20/%E5%88%B0%E5%A4%84%E9%83%BD%E6%9C%89cherry-pick/</url>
      
        <content type="html"><![CDATA[<p>之前想给 Fydetab Duo Wiki 做点贡献，但是为了本地编译博客预览，我需要向项目中加入 pixi 或者其他配置，这些内容是不适合提交到原项目的。所以学习了一下如何选择性提交，也就是 <code>git cherry-pick</code>。</p><span id="more"></span><h2 id="Git-的-cherry-pick"><a href="#Git-的-cherry-pick" class="headerlink" title="Git 的 cherry-pick"></a>Git 的 cherry-pick</h2><p>在 Git 版本控制系统中，<code>cherry-pick</code> 命令用于将某个特定的提交（commit）应用到当前分支，而不需要合并整个分支。这很适合我现在的需求：我 Fork 了源代码，创建了一个用于修改的分支（dev），分支的前两个 commit 是我进行本地配置用的文件，后面的才是对文档内容修改的部分。当我完成修改准备提交时，我可以基于未修改的原分支，再创建一个提交专用分支，然后利用 <code>cherry-pick</code> 来选择要纳入的后三个提交：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将指定提交应用到当前分支</span></span><br><span class="line">git cherry-pick COMMIT3 COMMIT4 COMMIT5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果遇到冲突，解决后继续</span></span><br><span class="line">git cherry-pick --<span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者放弃 cherry-pick</span></span><br><span class="line">git cherry-pick --abort</span><br></pre></td></tr></table></figure><p>然后再使用这个分支提交 PR，就不会把不必要的内容提交到原项目了。</p><p>同时，上游合并了我的 PR 后，我也可以再从上游拉取更改到 dev 分支，这样就能继续更新，然后再修改和使用合并专用分支。</p><h2 id="在数据分析中的-cherry-picking"><a href="#在数据分析中的-cherry-picking" class="headerlink" title="在数据分析中的 cherry-picking"></a>在数据分析中的 cherry-picking</h2><p>当时看到 <code>cherry-pick</code> 的时候觉得还挺有趣的，因为这个词之前在数据分析相关的讨论中也见过，其意思比较负面，即”选择性展示”。说实在的，这种事情工作后干的还真不少… 也是一种统计学的”魅力”时刻了… </p><p>另外，问了一下 AI，cherry pick 的说法似乎由来已久… Emmmmmm… 果然是太阳底下无新鲜事…</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
            <tag> 版本控制 </tag>
            
            <tag> cherry-pick </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>啊这...原来 devpod 已经被官方搁置了吗</title>
      <link href="/2026/01/17/%E5%95%8A%E8%BF%99-%E5%8E%9F%E6%9D%A5devpod%E5%B7%B2%E7%BB%8F%E8%A2%AB%E5%AE%98%E6%96%B9%E6%94%BE%E5%BC%83%E4%BA%86%E4%B9%88/"/>
      <url>/2026/01/17/%E5%95%8A%E8%BF%99-%E5%8E%9F%E6%9D%A5devpod%E5%B7%B2%E7%BB%8F%E8%A2%AB%E5%AE%98%E6%96%B9%E6%94%BE%E5%BC%83%E4%BA%86%E4%B9%88/</url>
      
        <content type="html"><![CDATA[<p>事情的起因是，使用 devpod 配置基于 docker-compose 的容器时，发现 devpod 似乎不能正确地调用 docker-compose 完成容器创建。结果不搜不知道，一搜… 啊？这项目居然被 loft-sh 放弃了吗？</p><span id="more"></span><p>根据 <a href="https://github.com/loft-sh/devpod/issues/1946">issue 1946</a> 和 <a href="https://github.com/loft-sh/devpod/issues/1915">issue 1915</a> 的描述，vCluster 是 loft-sh 商业化最成功、最有前景的项目，因此他们的所有精力都暂时放在上面，抽不出时间来维护社区项目了。</p><p>这个情况感觉跟 Fyde 团队类似，之前 Discord 上他们也说过，会优先倾向于能让公司继续运营的工作…</p><p>不过好在，一位<a href="https://github.com/skevetter">社区大神</a>创建了 Devpod 的社区分支，并且以惊人的速度持续更新（目前已经 0.9.* 了）！</p><p>使用 skevetter 的 Fork，可以正常地使用 docker-compose，算是不幸中的万幸吧。</p><p>不过到目前为止，绝大部分的代码都是 skevetter 一人贡献的，这其实不是太健康。就如之前 onelist 那样，项目非常有名，但是几乎所有开发工作都集中在原作者一人身上，这样用爱发电的状态终究是无法持续的，一定程度上导致了最后卖项目跑路的问题。</p><p>希望 devpod 能像 gitea 那样，衍生自 gogs，但是最后发展出了完备的社区，让好项目能一直延续下去。</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源软件 </tag>
            
            <tag> Devpod </tag>
            
            <tag> 开源项目维护 </tag>
            
            <tag> 社区分支 </tag>
            
            <tag> 项目可持续性 </tag>
            
            <tag> Docker Compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>不是，哥们你真写出来了？</title>
      <link href="/2026/01/14/%E4%B8%8D%E6%98%AF%E5%93%A5%E4%BB%AC-%E4%BD%A0%E7%9C%9F%E5%86%99%E5%87%BA%E6%9D%A5%E4%BA%86/"/>
      <url>/2026/01/14/%E4%B8%8D%E6%98%AF%E5%93%A5%E4%BB%AC-%E4%BD%A0%E7%9C%9F%E5%86%99%E5%87%BA%E6%9D%A5%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>新年又被AI惊艳到… </p><span id="more"></span><p>上周经常看到<a href="https://github.com/anomalyco/opencode">opencode</a>的推荐文，说这是目前最好的开源GitHub Copilot替代，写代码的执行率相当不错。</p><p>起初我当然是持怀疑态度的，毕竟我用过aider和openhands，它们当然都是很好的工具，但是配合DeepSeek使用的时候，效果半数时候都是比较一言难尽的… 很多时候都不能正确理解我的意思。即使用其他AI优化prompt后，依然不能很好地完成稍微复杂一丢丢的任务。</p><p>但是既然推荐的这么多，也不妨一试。不试不知道，效果还真是超出我的预期。</p><p>我去年就提到过，<a href="/2025/10/28/%E4%BD%BF%E7%94%A8devpod%E8%AE%BE%E7%BD%AE%E8%87%AA%E9%83%A8%E7%BD%B2%E7%9A%84codespace/" title="使用 DevPod 设置自部署的 Codespace">我其实想要一个能快速在远程机器上开启VS Code的工具</a>，但是奈何个人时间和能力有限，还没实施，就找到了devpod，解决了70%的需求… 于是暂时没有动力写了…</p><p>当时我就分别用了aider和openhands来尝试给我一个框架，我的要求也比较简单，能够在远程机器自动安装VS Code，然后自动将目标端口发到本地，实现过程尽量参考devpod的源码或直接用它的接口。</p><p>结果两者效果都不好，只能我自己在Copilot的指导下看代码，然而理解的相当慢，我自己调devpod接口也调不明白…</p><p>但是opencode，一次就成功搓了个能实际运行的demo出来，用的也不是更好的模型，同样是DeepSeek。虽然说尽量参考devpod的这个要求没有太做到，但是一次性能完成可运行，符合我功能描述的程序，在我看来已经是非常厉害了… </p><p>在第一版完成后，我也让opencode继续做了3次修改，除了有1次没改完直接停止外，都顺利完成了，真的出乎我意料。</p><p>虽然它的token消耗也非常的狠，但我用的毕竟是DeepSeek-Chat，过去一年只用了25块… 这次测试也就花了两三块，这个钱我还是付得起的。</p><p>另外，再试用之后，我也对Manus有所改观，没准人家是真有东西呢！原来prompt和工程上的优化，是可以带来显著的效果改善的… 果然还是要实践出真知… 试一试才是最真实的，就是… 希望试的成本能低点…</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aider </tag>
            
            <tag> 远程开发 </tag>
            
            <tag> opencode </tag>
            
            <tag> AI编程 </tag>
            
            <tag> 代码生成 </tag>
            
            <tag> devpod </tag>
            
            <tag> openhands </tag>
            
            <tag> DeepSeek </tag>
            
            <tag> 自动化工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>尝试向Bioconda/Conda‑Forge提交新的包</title>
      <link href="/2026/01/11/%E5%B0%9D%E8%AF%95%E5%90%91bioconda-conda-forge%E6%8F%90%E4%BA%A4%E6%96%B0%E7%9A%84%E5%8C%85/"/>
      <url>/2026/01/11/%E5%B0%9D%E8%AF%95%E5%90%91bioconda-conda-forge%E6%8F%90%E4%BA%A4%E6%96%B0%E7%9A%84%E5%8C%85/</url>
      
        <content type="html"><![CDATA[<p>在上次尝试了对conda‑forge的包做小贡献之后，我想继续来点更进阶的：尝试将 <a href="https://github.com/SingleR-inc/singler-py">singler‑py</a> 这个 Python 包发布到 conda 生态中。结果不做不知道，一做…还有点麻烦…</p><span id="more"></span><h2 id="罗马并不能一天建成"><a href="#罗马并不能一天建成" class="headerlink" title="罗马并不能一天建成"></a>罗马并不能一天建成</h2><p>我原本以为，设置好recipe，一次提交，通过审核就行了，但是发现了如下问题：</p><ul><li>原本打算直接提交到 <strong>conda‑forge</strong>，却在阅读贡献指南时发现：专门面向生物信息学的软件应当优先提交到 <strong>Bioconda</strong> 频道。</li><li>之后阅读<strong>Bioconda</strong>的文档并尝试逐步尝试，发现 singler‑py 依赖的不少包都未进入任何 conda 频道，AI告诉我官方并不建议在同一个 PR 中提交多个新包，因此我只能从依赖树的最底层开始一个个来。</li><li>逐级往下解析，发现BiocPy下的一系列包都是没有进入Conda生态的…</li></ul><p>梳理依赖后，singler‑py 所需的构建工作实际上是一个层层递进的依赖树。从最底层的 <strong>biocutils</strong> 开始，向上构建 <strong>biocframe</strong>、<strong>summarizedexperiment</strong> 和 <strong>singlecellexperiment</strong>，最后才是 <strong>singler‑py</strong> 本身。就目前来说，已知的依赖树就有：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">   A[biocutils] --&gt; B[biocframe]</span><br><span class="line">   B --&gt; E[summarizedexperiment]</span><br><span class="line">   E --&gt; F[singlecellexperiment]</span><br><span class="line">   F --&gt; G[singler‑py]</span><br></pre></td></tr></table></figure><p>可以看出，完成 singler‑py 的 conda 发布需要至少 <strong>4 个层级</strong>的构建工作，假设审核周期为 2‑3 个工作日，整个链条将耗时约 3‑4 周。实际上应该会在过程中发现更多的依赖包…估计只长不短…</p><h2 id="conda-forge和Bioconda不同的recipe工作流"><a href="#conda-forge和Bioconda不同的recipe工作流" class="headerlink" title="conda-forge和Bioconda不同的recipe工作流"></a>conda-forge和Bioconda不同的recipe工作流</h2><p>由于这个中实际上了解了两边的工作流，所以记录一下。</p><h3 id="conda‑forge-与-Bioconda-简介"><a href="#conda‑forge-与-Bioconda-简介" class="headerlink" title="conda‑forge 与 Bioconda 简介"></a>conda‑forge 与 Bioconda 简介</h3><p><a href="https://conda-forge.org/">conda‑forge</a> 是一个由社区主导的 conda 软件包仓库，它覆盖了大量通用领域的开源软件。任何人都可以通过 GitHub 向它的 <a href="https://github.com/conda-forge/staged-recipes">staged‑recipes</a> 仓库提交新的配方（recipe），经过自动化检查和维护者审核后，新包就会出现在 <code>conda‑forge</code> 频道中，供全球用户通过 <code>conda install -c conda-forge &lt;package&gt;</code> 安装。性质上应该跟AUR是类似的。</p><p><a href="https://bioconda.github.io/">Bioconda</a> 则是一个专注于生物信息学软件的 conda 频道，是一个专门收录生物相关包的仓库，文档里也特别强调，如果一个包并不专门服务于生物相关的目的，那么它应该被提交到<code>conda‑forge</code> 频道。</p><p>两者管理和生成 Recipe 的工具有重合，但是实际上两者的 Recipe 整理方式不太一样。<code>conda‑forge</code>准备了一个 Recipe 模板，提交 Recipe 后，CI工作流会生成 feedstock 仓库，后续的维护工作在 feedstock 仓库上进行，所以是一包一库的形式。</p><p>Bioconda 则是所有 Recipe 集中在一个仓库，直接向这个集中仓库提交 PR 就好。差异应该来自于包的数目吧，毕竟生物信息应该是数据科学的分支，所以工具的数量应该远小于前者，愿意维护和贡献的人的数量… 估计更是远小于前者了…（有代码用就不错了…标准化和打包别想太多）</p><h3 id="工具准备"><a href="#工具准备" class="headerlink" title="工具准备"></a>工具准备</h3><p>本次我暂时是使用 conda 工具集，毕竟初上手，跟着官方文档走… 所有的工具pixi都可以获取，运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pixi global install --environment conda -c conda-forge -c bioconda conda conda-build bioconda-utils greyskull grayskull </span><br></pre></td></tr></table></figure><p>这里有个小彩蛋，greyskull和grayskull同时存在，其实都指向的是grayskull，bioconda的文档有一页提到的是greyskull，不知道是不是项目开始的时候出现了什么小错误…</p><h3 id="向-conda‑forge-提交新包的简要步骤"><a href="#向-conda‑forge-提交新包的简要步骤" class="headerlink" title="向 conda‑forge 提交新包的简要步骤"></a>向 conda‑forge 提交新包的简要步骤</h3><p>conda‑forge 的方式是先提交 recipe，生成 feedstock 再维护feedstock</p><ol><li><p><strong>Fork 仓库</strong><br>访问 <a href="https://github.com/conda-forge/staged-recipes">conda‑forge&#x2F;staged‑recipes</a> 并点击 “Fork” 按钮，将仓库复制到自己的 GitHub 账号下。</p></li><li><p><strong>准备本地环境</strong><br>克隆你 fork 后的仓库，并创建一个新分支：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/&lt;你的用户名&gt;/staged-recipes.git</span><br><span class="line"><span class="built_in">cd</span> staged-recipes</span><br><span class="line">git checkout -b add-&lt;包名&gt;</span><br></pre></td></tr></table></figure></li><li><p><strong>生成配方文件</strong><br>像我提交的是pypi本来就有的包，所以直接<code>grayskull pypi --strict-conda-forge &lt;包名&gt;</code>就可以了</p></li><li><p><strong>本地验证</strong><br>使用 <code>conda smithy</code> 工具在本地运行 lint 和构建测试（需先安装 <code>conda‑smithy</code>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda smithy recipe-lint recipes/&lt;包名&gt;/</span><br><span class="line">conda build recipes/&lt;包名&gt;/</span><br></pre></td></tr></table></figure></li><li><p><strong>提交 PR</strong><br>将修改推送到你的 fork，然后在 GitHub 界面向 <code>conda‑forge/staged‑recipes</code> 发起 Pull Request。CI 会自动运行多平台构建测试，维护者会在评论中提出修改意见，直至所有检查通过后合并。</p></li></ol><h3 id="3-向-Bioconda-提交新包的简要步骤"><a href="#3-向-Bioconda-提交新包的简要步骤" class="headerlink" title="3. 向 Bioconda 提交新包的简要步骤"></a>3. 向 Bioconda 提交新包的简要步骤</h3><ol><li><p><strong>Fork 仓库</strong><br>访问 <a href="https://github.com/bioconda/bioconda-recipes">bioconda&#x2F;bioconda‑recipes</a> 并 Fork 到自己的账号。</p></li><li><p><strong>准备本地环境</strong><br>克隆仓库并创建分支（同样建议分支名称包含包名）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/&lt;你的用户名&gt;/bioconda-recipes.git</span><br><span class="line"><span class="built_in">cd</span> bioconda-recipes</span><br><span class="line">git checkout -b add-&lt;包名&gt;</span><br></pre></td></tr></table></figure></li><li><p><strong>生成配方文件</strong><br>直接<code>grayskull pypi &lt;包名&gt;</code>就行</p></li><li><p><strong>使用 bioconda‑utils 验证</strong><br>Bioconda 提供了专门的工具链来测试配方：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行 lint 检查</span></span><br><span class="line">bioconda-utils lint recipes/&lt;包名&gt;/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建测试</span></span><br><span class="line">conda build recipes/&lt;包名&gt;/</span><br></pre></td></tr></table></figure></li><li><p><strong>提交 PR</strong><br>推送到你的 fork 并向 <code>bioconda/bioconda‑recipes</code> 发起 PR。Bioconda 的 CI 会执行更严格的生物信息学软件兼容性测试，同样需要等待维护者审核并批准。</p></li></ol><h2 id="小发现"><a href="#小发现" class="headerlink" title="小发现"></a>小发现</h2><p>检查包构建文件的语法时，发现 conda 现在也引入并行了。原来下载各个平台的包配置文件是串行的，大陆这里即使用了加速也得等个好几分钟，更不用说后面的依赖计算了。现在引入了并行机制，还是比原来强了点（虽然我还是会继续用 Pixi）</p><p>另外，印象中Pixi使用了更新的包构建工具，也许速度会比现在的conda生态更快，之后如果再提交别的，我一定试试。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>还在天津工作的时候（7年前了都…），就想过自己编译 conda 包，这样就能解决没有 root 权限安装生信软件的问题了。只不过当时的文档是一个字也看不懂… 更别提写了。现在有了高度自动化的工具，也有了 AI 答疑… 确实可以来做点贡献了。</p><h2 id="BiocUtils-0-3-3-的实际提交尝试"><a href="#BiocUtils-0-3-3-的实际提交尝试" class="headerlink" title="BiocUtils 0.3.3 的实际提交尝试"></a>BiocUtils 0.3.3 的实际提交尝试</h2><p>应用前面所说的内容，我<a href="https://github.com/bioconda/bioconda-recipes/pull/61831">尝试向 Bioconda 提交了 BiocUtils</a></p><p>过程中得到几个略囧的经验：</p><ul><li>文档中说的需要指定软件证书，并不是要把软件证书附加到 recipe 中，而是指定在原项目中的位置</li><li>bioconda 并不为老版本 python 提供包，所以不用针对 3.9 以下版本去做兼容</li><li>conda-build 自动解析出来的内容不一定准确，比如 BiocUtils 原 pypi 依赖指定了 python &gt;&#x3D; 3.9，但是解析出的 recipe 并没有解析到</li></ul><p>另外，bioconda 的包提交后，后续的新版本是可以根据源代码的更新自动解析的， 所以如果没有特别问题，不需要每次更新 recipe</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> conda-forge </tag>
            
            <tag> conda-build </tag>
            
            <tag> 包管理 </tag>
            
            <tag> Bioconda </tag>
            
            <tag> singler-py </tag>
            
            <tag> biocutils </tag>
            
            <tag> biocframe </tag>
            
            <tag> summarizedexperiment </tag>
            
            <tag> singlecellexperiment </tag>
            
            <tag> 依赖解析 </tag>
            
            <tag> grayskull </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>为conda_forge做一点小贡献</title>
      <link href="/2026/01/09/%E4%B8%BAconda-forge%E5%81%9A%E4%B8%80%E7%82%B9%E5%B0%8F%E8%B4%A1%E7%8C%AE/"/>
      <url>/2026/01/09/%E4%B8%BAconda-forge%E5%81%9A%E4%B8%80%E7%82%B9%E5%B0%8F%E8%B4%A1%E7%8C%AE/</url>
      
        <content type="html"><![CDATA[<p>Conda 上的终于有 <code>aider-chat</code> 的 conda包了，这样理论上可以通过 <code>pixi global</code> 来全局安装它了。但是实际安装会发现，其依赖项之一 <code>tree_sitter_languages</code> 却没有对应的 aarch64 版本，安装过程会因此失败。于是我就想到，我能不能靠AI来解决这个。</p><span id="more"></span><h2 id="什么是-conda‑forge？"><a href="#什么是-conda‑forge？" class="headerlink" title="什么是 conda‑forge？"></a>什么是 conda‑forge？</h2><p>说来惭愧，在这之前，我一致不明白 conda 的 anaconda 和 conda‑forge 频道有什么区别… 这次翻文档才知道<a href="https://conda-forge.org/">Conda‑forge</a> 是一个社区驱动的 Conda 软件包分发频道，而 Anaconda 是 conda 的官方资源（以及如果在商业公司随便使用Anaconda，可能会被警告和要求付费…）。<br>而 Conda‑forge 上的每一个软件包都对应一个 <strong>feedstock</strong> 仓库，其中包含了构建该包所需的全部文件，其中最关键的就是 <strong>recipe</strong>。</p><h2 id="什么是-recipe？"><a href="#什么是-recipe？" class="headerlink" title="什么是 recipe？"></a>什么是 recipe？</h2><p>Recipe 是指导 Conda 如何构建一个软件包的配置文件，很形象的被叫成了“菜谱”，具体可以见<a href="https://conda-forge.org/docs/maintainer/adding_pkgs">官方文档</a>。</p><p>由于我本次并不是从头构建一个conda包，所以实际上这次并没有涉及修改 Recipe。</p><h2 id="准备-feedstock-仓库"><a href="#准备-feedstock-仓库" class="headerlink" title="准备 feedstock 仓库"></a>准备 feedstock 仓库</h2><p>如前所述，每一个软件包都对应一个 <strong>feedstock</strong> 仓库，<a href="https://github.com/conda-forge/tree_sitter_languages-feedstock"><code>tree_sitter_languages‑feedstock的仓库</code></a> 就在conda-forge组织下。根据官方文档的建议，对仓库做贡献建议先Fork仓库到自己的账户，然后开分支修改，推送到原仓库。</p><h2 id="修改文件"><a href="#修改文件" class="headerlink" title="修改文件"></a>修改文件</h2><p>根据 Aider 对这个 feedstock 的解析，这个库并没有什么特别不支持的 aarch64 的地方，可能只是单纯建立的时候就没有想支持 aarch64，并且默认状况下，feedstock 也不会自动支持 aarch64 （大概是，用户太少没人权吧…）。因此，修改很简单，只需要改 <code>conda-forge.yml</code>，加上：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">provider:</span></span><br><span class="line">  <span class="attr">linux_aarch64:</span> <span class="string">azure</span></span><br></pre></td></tr></table></figure><p>之后，根据文档，我需要手动运行<code>conda-smithy render -c auto</code>，conda 会自动对构建脚本进行更新（真自动化，这就是专业的CI和CD么…）</p><h2 id="向原项目提交-PR-以进行更新"><a href="#向原项目提交-PR-以进行更新" class="headerlink" title="向原项目提交 PR 以进行更新"></a>向原项目提交 PR 以进行更新</h2><p>最后就是将代码提交到自己仓库的fork，然后从github向原项目提交PR，PR会触发原项目库的CI，这个流程会自动完成构建和测试，测试通过，包的Maintainer接受PR后，包就能在conda上搜到了。</p><p>有了这个包，在Fydetab Duo上就能直接<code>pixi global install aider-chat</code>了，目前使用没有出现啥问题~</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> conda </tag>
            
            <tag> conda-forge </tag>
            
            <tag> tree_sitter_languages </tag>
            
            <tag> PR </tag>
            
            <tag> feedstock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>词云更新</title>
      <link href="/2026/01/08/%E8%AF%8D%E4%BA%91%E6%9B%B4%E6%96%B0/"/>
      <url>/2026/01/08/%E8%AF%8D%E4%BA%91%E6%9B%B4%E6%96%B0/</url>
      
        <content type="html"><![CDATA[<p>新单位的分析基本上全是个性化，所以每个项目都少不了要插论文，又有一阵看论文看到头疼的感觉。想起上次画词云已经是22年的事了，3年之期已过，恭迎… 好吧就是更新一下…</p><span id="more"></span><p>本次的更新比较简单，导出文献库后，再次绘制，不过使用的文本做了一些小改动，原来是只获取摘要的部分，这次我翻了以下文献库的情况，发现还是挺多文献只有标题并没有摘要的，并且论文的摘要多少有点八股文，因此这次使用的对象为关键词，和标题，有关键词用关键词，没有则用标题：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> bibliography_file:</span><br><span class="line">    entries = rispy.load(bibliography_file)</span><br><span class="line">    <span class="keyword">for</span> entry <span class="keyword">in</span> entries:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;keywords&#x27;</span> <span class="keyword">in</span> entry:</span><br><span class="line">            text +=  <span class="string">&#x27; &#x27;</span>.join(entry[<span class="string">&#x27;keywords&#x27;</span>]) + <span class="string">&#x27; &#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            text += entry[<span class="string">&#x27;title&#x27;</span>] + <span class="string">&#x27; &#x27;</span></span><br></pre></td></tr></table></figure><p>另外，感谢AI的建议，发现了之前轮廓绘制失败的原因，加上<code>Image.open(&quot;Sylens_Happy_Background.png&quot;).convert(&quot;L&quot;)</code>后，能正常的按轮廓绘制了。</p><p>新版图如下：</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2026/01/upgit_20260110_1768039212.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2026/01/upgit_20260110_1768039212.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="new_wordcloud"></p><p>附原版的图：</p><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/04/upgit_abs_20220405_1649148797.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/04/upgit_abs_20220405_1649148797.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="old_wordcloud"></p><p>出人意料的是… Emmm，变化并没有想象中的大，看来这一年半来，我确实是IT方面的工作多了… 觉得论文看到吐，也许是项目经常是扎堆过来？</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据可视化 </tag>
            
            <tag> Python </tag>
            
            <tag> 文献管理 </tag>
            
            <tag> 词云 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>这一年来AI给我带来的改变</title>
      <link href="/2026/01/06/%E8%BF%99%E4%B8%80%E5%B9%B4%E6%9D%A5AI%E7%BB%99%E6%88%91%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%94%B9%E5%8F%98/"/>
      <url>/2026/01/06/%E8%BF%99%E4%B8%80%E5%B9%B4%E6%9D%A5AI%E7%BB%99%E6%88%91%E5%B8%A6%E6%9D%A5%E7%9A%84%E6%94%B9%E5%8F%98/</url>
      
        <content type="html"><![CDATA[<p>2022年末到2023年初，ChatGPT爆火，我开始用LLM来辅助写脚本。虽然相当好用，但是价格较贵，且个人付款始终是问题，应用也就仅限于简单的代码问题了。2024年末到2025年初，DeepSeek爆火。虽然它的回答很多时候不那么令人满意，且增加了思考模式后，得到结果的时间总是会慢一拍，但是，它便宜呀！在一年之后，DeepSeek依然是输出结果还不错的前提下，Token最便宜的模型之一。年初充了50块，到现在刚好差不多一年，还剩27… 因此，我就更大胆地将LLM用在了各种其他方面。</p><span id="more"></span><h2 id="从“奢侈品”到“日用品”"><a href="#从“奢侈品”到“日用品”" class="headerlink" title="从“奢侈品”到“日用品”"></a>从“奢侈品”到“日用品”</h2><p>如果前两年使用 AI 还像是偶尔尝鲜的奢侈品，那么今年它已经彻底变成了我工作流中的日用品。DeepSeek 低廉的价格让我可以毫无心理负担地用它处理各种任务：从简单命令的查询，到整个脚本的重构，再到完全陌生领域的探索。虽然不一定达到了效率的飞跃，但是它确实扩展了我的能力边界，让我能做之前只有概念但从未实践的工作（然后成为了更牛马的牛马）。</p><h2 id="本年的成功应用案例"><a href="#本年的成功应用案例" class="headerlink" title="本年的成功应用案例"></a>本年的成功应用案例</h2><h3 id="批量翻译博客"><a href="#批量翻译博客" class="headerlink" title="批量翻译博客"></a>批量翻译博客</h3><p>利用命令行 AI 工具 <a href="https://aider.chat/">Aider</a>，我编写了一个简单的 Shell 脚本，让它自动读取中文博客目录下的每一篇文章，将其翻译成英文，并保存到对应的英文目录中。</p><p>脚本完成翻译只花了一个半小时的时间，但是我人工校对足足花了一个星期的夜晚时间… 这也是我过去虽有将博客英文化的想法，但是最终做不下去的原因——没有脚本化的工具，一篇篇复制粘贴也能弄到吐血。另外，校对英文翻译的那一周，也让我回想起了当时准备英文临床试验材料的那段时间… 即使现在看过的英文专业论文及材料已经数以千计了… 还是会觉得这个过程相当折磨… 这大概就是没有语言天赋吧…</p><h3 id="给-FydeTab-Duo-Wiki-贡献中文翻译"><a href="#给-FydeTab-Duo-Wiki-贡献中文翻译" class="headerlink" title="给 FydeTab Duo Wiki 贡献中文翻译"></a>给 FydeTab Duo Wiki 贡献中文翻译</h3><p>除了我的博客，我还向 FydeTab Duo Wiki 贡献了好几次中文翻译。也是借由 Aider 初翻，然后我再进行一遍校对，同时我也借它了解了一下 FydeTab Duo Wiki，毕竟它采用的 Wiki 框架我之前并没有用过。</p><h3 id="撰写博客初稿"><a href="#撰写博客初稿" class="headerlink" title="撰写博客初稿"></a>撰写博客初稿</h3><p>今年下半年开始，我上传的博客数目开始指数增加，这也是拜 Aider + DeepSeek 的组合所赐。因为我写博客主要是记录给自己看，没有什么风格化的要求，记录目的远大于展示目的。所以列个提纲出来，把相关代码或者 Notebook 甩给它们，生成草稿我再改就可以了。这真的很省时间。原来我一个博文就能写一整个晚上… 现在只要有题材，一晚上写5篇都不是问题… 配合之前的翻译，中英文同步发布也不是问题。</p><h3 id="批量生成-API-测试"><a href="#批量生成-API-测试" class="headerlink" title="批量生成 API 测试"></a>批量生成 API 测试</h3><p>面对多个服务组的 Swagger 描述文件，手动编写 pytest 测试用例过去是一件不难但相当耗时的事情。同样借助 Aider，我只需提供 Swagger 描述文件，它就能在几分钟内生成一套可运行的基础测试代码框架。我只需要在此基础上微调，就能快速提高测试覆盖率。</p><p>今年上半年在给接手的系统构建 CI 体系时，Aider + DeepSeek 的组合让我比预期早很多完成了工作。</p><h3 id="修复-Hexo-主题的国际化问题"><a href="#修复-Hexo-主题的国际化问题" class="headerlink" title="修复 Hexo 主题的国际化问题"></a>修复 Hexo 主题的国际化问题</h3><p>在为博客搭建英文站时，我发现主题 Volantis 的小部分文字实际上是硬编码在配置文件或者项目代码中的，且部分交互功能在子目录路由下失效。通过 DeepSeek 分析浏览器控制台报错和主题源码，我快速定位到问题根源：</p><ol><li>CDN 路径配置错误导致 <code>app.js</code> 加载失败，修复后交互功能恢复正常。</li><li>将主题配置文件中固定的中文标题、描述等字段逐一替换为英文。</li></ol><p>最终，我通过生成并应用补丁的方式，在不直接修改主题源码仓库的前提下，解决了双语支持问题。这在过去是非常难想象的，毕竟我并没有真的做过完整的 JS 项目开发，看代码找问题本身会很费劲，但是 AI 帮我缩小了检查范围，让短时间内解决问题成为了可能。</p><h3 id="配置-GitHub-Actions-进行-CI-和-CD"><a href="#配置-GitHub-Actions-进行-CI-和-CD" class="headerlink" title="配置 GitHub Actions 进行 CI 和 CD"></a>配置 GitHub Actions 进行 CI 和 CD</h3><p>这也是一个比较好的例子。我今年有两个平台的自动化流程使用经验，一个是 Azure Pipeline，另外则是 GitHub Actions。前者我是对着说明文档手动写的，花了大概一整天，因为是全英文的文档，翻译又比较一言难尽（微软很多文档的中文感觉就像是根本没有中文用户，所以全是机翻也不优化）。</p><p>GitHub Actions 则很大程度上是在 AI 指导下完成的，生成大致样例后我再改，基本上 1~2 小时就能搞定。</p><h3 id="为-conda‑forge-贡献-ARM64-包"><a href="#为-conda‑forge-贡献-ARM64-包" class="headerlink" title="为 conda‑forge 贡献 ARM64 包"></a>为 conda‑forge 贡献 ARM64 包</h3><p>当发现 <code>tree_sitter_languages</code> 缺少 ARM64 架构的 conda 包，导致 <code>aider‑chat</code> 无法在 Fydetab Duo（ARM 设备）上安装时，我决定自己动手补充。在 AI 的指引下，我：</p><ol><li>了解了 conda‑forge 的 feedstock 工作机制。</li><li>在对应的 <code>conda‑forge.yml</code> 中添加了 <code>linux_aarch64</code> 构建支持。</li><li>按照社区流程提交 PR，并成功通过 CI 测试。</li></ol><h2 id="本年的失败或部分失败案例"><a href="#本年的失败或部分失败案例" class="headerlink" title="本年的失败或部分失败案例"></a>本年的失败或部分失败案例</h2><p>AI 显然也不是万能的，其给出的方案往往需要专业判断，否则就会原地打转，甚至很多时候我也不知道我是在打转还是还没摸到尽头。</p><h3 id="尝试修改-Theia-的远程模块"><a href="#尝试修改-Theia-的远程模块" class="headerlink" title="尝试修改 Theia 的远程模块"></a>尝试修改 Theia 的远程模块</h3><p>我希望在浏览器版的 Theia IDE 中增加远程开发支持，因为我在 FydeTab Duo 上用 Linux 子系统的 VSCode 实在太卡了… Aider 和 OpenHands 都能给出代码修改建议，但由于我对 Electron&#x2F;Node.js 的大型项目一无所知，无法判断这些修改是否正确，也不知如何调试。最终，这个尝试无果而终。</p><h3 id="尝试更新-FydeOS-内核以支持-Vulkan"><a href="#尝试更新-FydeOS-内核以支持-Vulkan" class="headerlink" title="尝试更新 FydeOS 内核以支持 Vulkan"></a>尝试更新 FydeOS 内核以支持 Vulkan</h3><p>为了提升图形性能，我考虑将 FydeTab Duo 的内核升级到新版，以期支持 Vulkan 驱动。AI 帮我找到了适用于 RK3588 的新内核源码，但我无法理解编译时的 overlay 替换机制。最终我采取了简单粗暴的替换方式，结果导致设备变砖。</p><h3 id="尝试基于-DevPod-的源码直接写一个符合我要求的应用"><a href="#尝试基于-DevPod-的源码直接写一个符合我要求的应用" class="headerlink" title="尝试基于 DevPod 的源码直接写一个符合我要求的应用"></a>尝试基于 DevPod 的源码直接写一个符合我要求的应用</h3><p>DevPod 的功能非常符合我脱离 FydeOS 的 Linux 子系统创建开发环境的要求，只是它必须基于 Docker 或者 Podman，但是我目前无法在子系统外运行 Docker&#x2F;Podman。所以我曾经尝试让 AI 直接参照以及复用 DevPod 的源代码，写一个通过 SSH 连接，在远程机器上安装 VSCode 并进行端口转发的应用。然而 AI 并没有参考或复用 DevPod 已有的内容，而是根据我的描述一顿重写，然后代码却无法运行。</p><h3 id="尝试在-FydeOS-上编译运行-Podman"><a href="#尝试在-FydeOS-上编译运行-Podman" class="headerlink" title="尝试在 FydeOS 上编译运行 Podman"></a>尝试在 FydeOS 上编译运行 Podman</h3><p>我成功使用 Pixi 管理依赖，编译出了 ARM64 版本的 Podman 及其依赖库。然而在运行时，却因 FydeOS&#x2F;ChromeOS 内核的 SafeSetID 安全限制，无法完成用户命名空间映射，导致 rootless Podman 最终无法运行。AI 给我解释了这一问题的来源，但是我至今也不确定它说的对或不对，以及我该怎么解决问题。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>回顾这一年，AI 已经彻底融入我的工作学习日常。它帮我完成了大量重复劳动，解决了无数具体问题，甚至让我敢于涉足以前不敢随便涉及的领域。但与此同时，我也更加清醒地认识到，AI 的能力发挥极大程度依赖于使用者的知识储备和判断力。</p><ul><li><strong>在已有知识框架内</strong>，AI 能带来一定的效率提升，虽然绝对到不了各家宣传的可以当甩手掌柜的程度，但一定是有真实的效率提升的。</li><li><strong>在一知半解的方面</strong>，AI 能大大缩短从0到1突破的时间，这在过去是很难想象的，但是今年很多新内容的上手，实际上就只花了半天时间。</li><li><strong>在完全陌生的领域</strong>，没有足够的背景知识去验证和筛选 AI 的输出，只能被动地按照 AI 给出的建议一条条尝试，非常容易花大量时间在无用功上。</li></ul><p>简单来说，就是我的上限决定 AI 的上限，最终，还是使用的人需要好好学习，提升自己。</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 自动化 </tag>
            
            <tag> DeepSeek </tag>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搭一个用rendercv生成简历的容器</title>
      <link href="/2026/01/06/%E6%90%AD%E4%B8%80%E4%B8%AA%E7%94%A8rendercv%E7%94%9F%E6%88%90%E7%AE%80%E5%8E%86%E7%9A%84%E5%AE%B9%E5%99%A8/"/>
      <url>/2026/01/06/%E6%90%AD%E4%B8%80%E4%B8%AA%E7%94%A8rendercv%E7%94%9F%E6%88%90%E7%AE%80%E5%8E%86%E7%9A%84%E5%AE%B9%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<p>准备简历说起来是不是什么难事，但实际做起来，还是会比较耗时的。现在不少岗位会对细分领域有一些只是或者项目的要求，求职者这么多，一份没有针对岗位要求突出重点的简历，也许就被用人单位忽略掉了。所以想要达到更好的效果，最好能对每个岗位针对性的优化… 这一点AI应该是擅长的，但是至少我现在没找到比较好的免费工具。</p><p>刚好最近看到了<a href="https://github.com/rendercv/rendercv">RenderCV</a>，这是一个通过YAML配置文件生成简历的工具，它可以实现配置文件即简历，将它与<a href="https://aider.chat/">Aider</a>这种编程助手结合，基本就能构成一个快速准备简历的工作环境了。</p><span id="more"></span><h2 id="容器的构成组件"><a href="#容器的构成组件" class="headerlink" title="容器的构成组件"></a>容器的构成组件</h2><p>容器的组件很简单：</p><ul><li>Pixi：用于安装依赖，即RenderCV和Aider</li><li>Aider：用于生成大致的简历配置文件，同时也可以直接用来翻译</li><li>RenderCV：从配置文件生成简历</li><li>PDF预览插件：直接在VSCode中就能查看生成的PDF简历，配合RenderCV的<code>--watch</code>参数，也可以实现修改的实时预览</li></ul><h2 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h2><ul><li><p><strong>使用Github Codespace</strong>：最方便的方式当然是直接白嫖Gihub的Codespace，fork <a href="https://github.com/SilenWang/RenderCV_Pod">我的容器项目后</a>，就可以在Web版的VSCode里准备简历了。简历生成后也可以直接从容器里下载到本地。</p></li><li><p><strong>使用Devpod</strong>：使用Devpod也简单，有任意Provider后，运行 <code>devpod up https://github.com/SilenWang/RenderCV_Pod</code>就能开始写了</p></li></ul><h2 id="Aider生成简历配置的注意事项"><a href="#Aider生成简历配置的注意事项" class="headerlink" title="Aider生成简历配置的注意事项"></a>Aider生成简历配置的注意事项</h2><p>目前我配合DeepSeek的API进行简历生成，可能由于RenderCV项目本身比较新，DeepSeek显然是不知道RenderCV的配置文件应该是什么样的，它能给出看上去可以的文件，但是其中Section部分该怎么写完全是错误的，还是需要自行看<a href="https://docs.rendercv.com/">RenderCV的文档</a>来修正，当然RenderCV的设计就是为了简单快速，所以这些调整10分钟左右就能学会，到不是太大问题。</p><p>另外，准备一个示例完整的例子给AI以后，基本就能避免前述问题，之后有空我再在项目中补充。</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pixi </tag>
            
            <tag> 容器 </tag>
            
            <tag> 开发环境 </tag>
            
            <tag> RenderCV </tag>
            
            <tag> Aider </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>更新我的头像</title>
      <link href="/2025/12/28/%E6%9B%B4%E6%96%B0%E6%88%91%E7%9A%84%E5%A4%B4%E5%83%8F/"/>
      <url>/2025/12/28/%E6%9B%B4%E6%96%B0%E6%88%91%E7%9A%84%E5%A4%B4%E5%83%8F/</url>
      
        <content type="html"><![CDATA[<p>我的头像，印象中用了有10好几年了，自从我开始做生物信息工作之后，我就想过给它加一些复杂度，半边加上电路板的纹路，另外半边使用DNA的纹路，中间用一种过度效果连接起来，象征生物到信息的转化，这样贴合我的工作领域。但是奈何我并不怎么会P图，实现不了想要的效果。不过今年新出的图像编辑模型，让实现我的想法有了希望。</p><span id="more"></span><p>其实在最早图像生成模型开始火，网上开始出现各种AI美女图的时候，我就把我能用得上的开源和商业模型都试了个遍，试图画出一个至少实现DNA到电路板纹路过度的图，最后只有Gemini给的图形比较能看，现在成为了博客的Banner。</p><p>今年，我无意中在微信里看到了阿里qwen-image-edit的介绍，才知道原来还有专门用来进行图像编辑的模型，可以把不同的元素拼在一起生成新图。这正适合实现我更新图形的想法。于是从Github找到了一个<a href="https://github.com/chenpipi0807/qwen-image-API">简单的前端</a>（我感觉我这个需求，犯不着上comfyui那么复杂），然后<a href="https://github.com/SilenWang/qwen-image-API">自己Fork了一份</a>，加上了模型选择和多图输入。然后就开始修改我的头像了。</p><p>正式开始修改图像前，我先用我修改的小工具测试了下<code>qwen-image-edit</code>和<code>wan2.5-i2i-preview</code>的效果，实测还是万象效果更好，因此后面的工作都是用万象完成的。</p><h2 id="一步到位的尝试"><a href="#一步到位的尝试" class="headerlink" title="一步到位的尝试"></a>一步到位的尝试</h2><p><a href="https://qwenlm.github.io/blog/qwen-image-edit/">qwen-image-edit项目</a> 的例子中，编辑的功能还是相当强大的，从替换衣服、修改文字、图形融合都可以。因此我期待的是，只要我给出描述，就能一次性的完成修改。但果然，宣传是宣传，使用是使用，卖家秀和买家秀始终是不一样的。</p><p>下面是我的一步到位尝试的效果图合集，第一排最左侧是我的头像原图，其余的是我自己写简单的Prompt得到的三个效果图。我的Prompt大致是下面这样的简单描述。</p><blockquote><p>图1是一个标，我现在想将这个图标的形状，变成由特定的纹路组成的形状，图形左半边是电路板上的图样纹路，右侧则是DNA双螺旋的纹路</p></blockquote><p>尝试了几次后，发现出来的结果与预期差太远，于是我借助ChatGPT来优化Prompt，得到的Prompt大致是下面这样的</p><blockquote><p>在严格保持原始图标整体轮廓、比例、结构完全不变的前提下，对图标进行纹理重构。<br>该图标由异形字母 S 与 W 组成，其中 S 由上下羽毛状弧形构成，W 位于中央，整体呈环形动态结构。<br>修改要求：<br>图标左半部分（包括对应的 S 与 W 区域轮廓）填充为精细的电路板纹路：<br>包含 PCB 走线、芯片焊盘、微型电子线路<br>线条清晰、科技感强、具有工程精度<br>图标右半部分（包括对应的 S 与 W 区域轮廓）填充为DNA 双螺旋结构纹路：<br>可见规则的双螺旋扭转<br>包含碱基阶梯结构，具有生物科技与生命科学质感<br>整体风格要求：<br>所有纹理仅作为填充纹路，不得改变原有外轮廓<br>左右两种纹理在中轴处自然过渡，但不混杂<br>保持图标的简洁性与可识别性，适合作为科技 &#x2F; 生物信息 &#x2F; AI 相关品牌 Logo<br>背景保持纯色或透明<br>高对比度、矢量感、干净、专业<br>输出为清晰、现代、可用于品牌视觉系统的图标效果。</p></blockquote><p>有了这个更专业的Prompt后，就能得到第二排那样，极大程度接近我想要效果的图了，但是过程中发生两个问题：</p><ol><li>原图形有2个弧形颜色较浅，模型似乎大部分时候不会去修改这部分</li><li>模型没法很好区分我描述的上半部分和下半部分，毕竟这俩部分不是严格的上下，也不是严格的左右…</li></ol><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/12/upgit_20251228_1766915938.webp" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/12/upgit_20251228_1766915938.webp" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="merge1"></p><h2 id="分步走"><a href="#分步走" class="headerlink" title="分步走"></a>分步走</h2><p>在一次性无法完成任务后，我最终选择了分布完成（得，难怪专业工作流要comfyui）。首先我自行改变原图的颜色，避免模型修改遗漏，之后我自行把要分别着色的两部分拆分开，避免模型识别不了我说的两部分，导致纹路修改不准确。</p><p>最后我自己拿到两部分结果后，再拼起来。这个过程中，还出现了下半部分绘制DNA纹路时，模型没法正确着色的问题，因此还又加了最后一步的着色。</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/12/upgit_20251228_1766915942.webp" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/12/upgit_20251228_1766915942.webp" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="merge2"></p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>虽然过程不是很顺利，最终的效果不说100%达到我的预期，也完成了85%吧。而且这个过程比我想的快得多，不算改工具的时间的话，图形部分实际上只试了2小时左右。我之前看过给Vup做图的<a href="https://space.bilibili.com/174708">Naing老师</a>的工作直播，做一个小图样并没有那么简单… 尤其我要的这种电路板和DNA纹路本身有点复杂的情况。用模型能有现在的效果，我已经挺知足了…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> qwen-image-edit </tag>
            
            <tag> wan2.5-i2i-preview </tag>
            
            <tag> AI </tag>
            
            <tag> 图像编辑 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我真是用什么都会踩坑--Devcontiner使用的若干问题</title>
      <link href="/2025/12/19/%E6%88%91%E7%9C%9F%E6%98%AF%E7%94%A8%E4%BB%80%E4%B9%88%E9%83%BD%E4%BC%9A%E8%B8%A9%E5%9D%91-Devcontainer%E4%BD%BF%E7%94%A8%E7%9A%84%E8%8B%A5%E5%B9%B2%E9%97%AE%E9%A2%98/"/>
      <url>/2025/12/19/%E6%88%91%E7%9C%9F%E6%98%AF%E7%94%A8%E4%BB%80%E4%B9%88%E9%83%BD%E4%BC%9A%E8%B8%A9%E5%9D%91-Devcontainer%E4%BD%BF%E7%94%A8%E7%9A%84%E8%8B%A5%E5%B9%B2%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>我只是想设置一个devcontainer环境，更高效的完成维护公司官网的工作，没想到一件事上能踩三个坑… </p><span id="more"></span><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p><a href="https://code.visualstudio.com/docs/devcontainers/containers">Devcontainer</a> 是 Visual Studio Code 推出的一项功能，它允许我们利用 Docker 容器快速搭建与项目匹配的开发环境。这种“代码即环境”的方式可以极大地统一团队协作体验，减少“在我机器上能跑”的尴尬。我之前写的devpod就是基于这种格式的开源解决方案。</p><p>然而，理想很丰满，现实却总会在细节上给你使绊子。在最近一次为公司官网项目配置 Devcontainer 时，我接连遇到了三个意想不到的问题，每个都耗费了不少时间才找到解决方案。下面就把这些问题和解决方案记录下来，供大家参考。</p><h2 id="坑一：Git-子模块（subtree）的缺失"><a href="#坑一：Git-子模块（subtree）的缺失" class="headerlink" title="坑一：Git 子模块（subtree）的缺失"></a>坑一：Git 子模块（subtree）的缺失</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>微软官方提供的Devcontainer基础镜像有 Debian 和 Ubuntu，两者都自带的 Git，但是，版本都比较基础。不含 subtree 子命令… 嗯，我也是第一次知道，git 的功能太多，以至于一些比较新的命令，做成了可选项… </p><p>但这都不是问题，Ubuntu 和 Debian 源中的 Git 应该都是功能完整的，因为我在 Devcontainer 之外从来没有收到过 subtree 命令不存在的提示。然后问题就出现了，即使通过 <code>apt-get install git-man</code> 或者 <code>git-all</code>，也无法直接获得 <code>subtree</code> 功能。为什么呢？其实很简单，Devcontainer 内自带的git，并不来自软件源，它位于 <code>/usr/local/bin</code>，而系统安装的 git 会在 <code>/usr/bin</code>。而环境变量 <code>Path</code> 中，<code>/usr/local/bin</code> 优先级更高， 所以自行安装的git，实际上不会被使用到，于是会一致找不到 <code>subtree</code> …</p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>根据前面的问题，其实通过 <code>apt</code> 安装系统带的 git，然后把镜像里的干掉就是：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> mcr.microsoft.com/devcontainers/base:ubuntu</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">   add-apt-repository -y ppa:git-core/ppa &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">   apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">   apt-get install -y git vim &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">   <span class="comment"># 记得干掉容器里原来的git</span></span></span><br><span class="line">   rm -r /usr/local/bin/git* &amp;&amp; \</span><br><span class="line">   apt-get autoremove -y &amp;&amp; \</span><br><span class="line">   apt-get clean -y</span><br></pre></td></tr></table></figure><h2 id="坑二：Windows-平台下的换行符自动转换"><a href="#坑二：Windows-平台下的换行符自动转换" class="headerlink" title="坑二：Windows 平台下的换行符自动转换"></a>坑二：Windows 平台下的换行符自动转换</h2><h3 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h3><p>当你在 Windows 主机上使用 Docker Desktop 运行 Devcontainer 时，Git 会根据 <code>core.autocrlf</code> 的默认设置（通常为 <code>true</code>）自动将行结束符 LF 转换为 CRLF。这本身是 Windows 开发环境中的常见行为，但在容器内部，文件系统是 Linux 风格的，因此 Git 会在检出文件时执行转换，导致几乎所有文件都被标记为“已修改”。</p><p>具体现象是：在容器内执行 <code>git status</code>，会发现大量文件显示为修改（即使你什么都没做）。这种干扰不仅让人困惑，还可能影响后续的提交操作。</p><h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><p>Emmmm，我其实并没有解决这个问题，因为进行 git 的配置并不能阻止 vscode 执行这个转换… 这个问题只发生在 Windows 平台下使用 Docker Desktop 的情况，反正用 Docker Desktop 编译个网站都能导致桌面卡死，直接不用就是了… 老老实实用服务器作为 SSH Provider…</p><h2 id="坑三：Devcontainer-Desktop-与远程-SSH-Provider-的掉线问题"><a href="#坑三：Devcontainer-Desktop-与远程-SSH-Provider-的掉线问题" class="headerlink" title="坑三：Devcontainer Desktop 与远程 SSH Provider 的掉线问题"></a>坑三：Devcontainer Desktop 与远程 SSH Provider 的掉线问题</h2><h3 id="问题描述-2"><a href="#问题描述-2" class="headerlink" title="问题描述"></a>问题描述</h3><p>在尝试通过 Devpod Desktop 连接到远程 SSH Provider时，会发现连接极其不稳定，经常在几分钟内就会自动断开，且重连过程十分缓慢，连上不一会又掉。不足。由于 Devpod Desktop 也不给什么运行日志，我也不知道是啥毛病…</p><h3 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h3><p>简单粗暴，Devpod Desktop 只用来进行 Provider 和工作区的配置，发起连接由 DevPod CLI 完成就好…</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>好消息，问题最终都解决了；坏消息，本周又少睡了七八个钟，愿我不要暴毙在2025…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> docker </tag>
            
            <tag> devpod </tag>
            
            <tag> devcontainer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pixi进阶：使用Pixi作为数据科学/生物信息学/web开发的万能管理工具</title>
      <link href="/2025/12/17/Pixi%E8%BF%9B%E9%98%B6-%E4%BD%BF%E7%94%A8Pixi%E4%BD%9C%E4%B8%BA%E9%A1%B9%E7%9B%AE%E7%9A%84%E4%B8%87%E8%83%BD%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/"/>
      <url>/2025/12/17/Pixi%E8%BF%9B%E9%98%B6-%E4%BD%BF%E7%94%A8Pixi%E4%BD%9C%E4%B8%BA%E9%A1%B9%E7%9B%AE%E7%9A%84%E4%B8%87%E8%83%BD%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<p>去年我入职新公司的时候，接到了一项为生物信息培训准备教学用分析环境的任务，以此为契机，我接触到了Pixi。后来由于工作内容变动，我不仅要进行生物信息分析，还要兼任全栈维护的工作，接手的项目横跨前段后端，涉及的语言和框架不再限于数据科学常用的R、Python，Pixi也依然能充当一个跨语言&#x2F;技术栈的开发环境管理工具（Conda资源极丰富，主流的编程语言和常用框架都有资源），因此现在再次来小结下，在我的工作中用得上的Pixi实用功能。</p><span id="more"></span><h2 id="1-处理多环境的公用依赖"><a href="#1-处理多环境的公用依赖" class="headerlink" title="1. 处理多环境的公用依赖"></a>1. 处理多环境的公用依赖</h2><p>现在经手的项目七八成都是单细胞，这个领域到目前为止，都还是有两个主流的分析生态，即Python下的Scanpy，以及R下的Seurat，并且两种生态下都在持续产出前沿的新分析技术，因此不可避免的两个生态都要用，分析环境也就必然是多个。而我做的项目全部都是个性化的，因此安装和测试两套生态下的工具不可避免，单细胞数据又大，使用 Jupyter Notebook 这种工具进行交互性测试是必然的，为了避免每次创建新环境都反复配置共用软件包，将 Jupyter 以及必要的内核设为通用依赖是很必要的。</p><h3 id="设置defualt环境"><a href="#设置defualt环境" class="headerlink" title="设置defualt环境"></a>设置defualt环境</h3><p>在设置环境的关键字<code>[dependencies]</code>下配置的所有软件包都在defualt环境中，这个环境中记录的所有包都会在任一环境中被纳入依赖计算。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Sylens Wong &lt;qium@aimingmed.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>, <span class="string">&quot;bioconda&quot;</span>]</span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;DEMO1&quot;</span></span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-64&quot;</span>]</span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[environments]</span></span><br><span class="line"><span class="attr">scanpy</span> = [<span class="string">&#x27;scanpy&#x27;</span>]</span><br><span class="line"><span class="attr">seurat</span> = [<span class="string">&#x27;seurat&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">ipykernel</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">r-irkernel</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">jupyterlab</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.scanpy.dependencies]</span></span><br><span class="line"><span class="attr">python</span> = <span class="string">&#x27;3.*&#x27;</span></span><br><span class="line"><span class="attr">scanpy</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.seurat.dependencies]</span></span><br><span class="line"><span class="attr">r-base</span> = <span class="string">&#x27;4.*&#x27;</span></span><br><span class="line"><span class="attr">r-seurat</span> = <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="设置通用feature"><a href="#设置通用feature" class="headerlink" title="设置通用feature"></a>设置通用feature</h3><p>另一种方式，则是设置通用feature。在<code>pixi.toml</code>中，我们可以定义多个环境（<code>[environments]</code>），每个环境由一组feature组成。如果不同的环境有公共依赖（如<code>ipykernel</code>、<code>r-irkernel</code>、<code>jupyterlab</code>）放入一个名为<code>kernel</code>的feature中，然后在各个分析环境中引用该feature。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Sylens Wong &lt;qium@aimingmed.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>, <span class="string">&quot;bioconda&quot;</span>]</span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;DEMO1&quot;</span></span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-64&quot;</span>]</span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[environments]</span></span><br><span class="line"><span class="attr">scanpy</span> = [<span class="string">&#x27;kernel&#x27;</span>, <span class="string">&#x27;scanpy&#x27;</span>]</span><br><span class="line"><span class="attr">seurat</span> = [<span class="string">&#x27;kernel&#x27;</span>, <span class="string">&#x27;seurat&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[feature.kernel.dependencies]</span></span><br><span class="line"><span class="attr">ipykernel</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">r-irkernel</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">jupyterlab</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.scanpy.dependencies]</span></span><br><span class="line"><span class="attr">python</span> = <span class="string">&#x27;3.*&#x27;</span></span><br><span class="line"><span class="attr">scanpy</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.seurat.dependencies]</span></span><br><span class="line"><span class="attr">r-base</span> = <span class="string">&#x27;4.*&#x27;</span></span><br><span class="line"><span class="attr">r-seurat</span> = <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure><p>这样，无论是<code>scanpy</code>环境还是<code>seurat</code>环境，都会自动包含<code>kernel</code>提供的Jupyter内核支持，避免了重复定义。另外，这种配置方式更模块化，可以配置多个包组件，然后自由组合成需要的环境。</p><h2 id="2-管理简单的部署任务以及任务之间的依赖"><a href="#2-管理简单的部署任务以及任务之间的依赖" class="headerlink" title="2. 管理简单的部署任务以及任务之间的依赖"></a>2. 管理简单的部署任务以及任务之间的依赖</h2><p>除了依赖管理，Pixi还可以定义任务（<code>tasks</code>），并指定任务之间的依赖关系。等于是纳入了一个非常简单的Make工作流体系。这在需要顺序执行编译、打包、部署等步骤的项目中尤其有用。</p><p>在<code>pixi.toml</code>的<code>[tasks]</code>或<code>[feature.xxx.tasks]</code>节中，我们可以设置一系列的任务，每一个任务可以利用<code>depends-on</code>声明任务依赖。Pixi会确保所有依赖任务按顺序执行。</p><p>下面是一个生物信息分析项目中，需要依次安装几个Bioconductor数据包的任务定义：</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[feature.rplot.tasks]</span></span><br><span class="line"><span class="attr">GenomeInfoDbData</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;GenomeInfoDbData\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">BSgenome</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;BSgenome.Hsapiens.UCSC.hg38\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">EnsDb</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;EnsDb.Hsapiens.v86\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">r_dep</span> = &#123;cmd = <span class="string">&#x27;echo &quot;bio dep for R done&quot;&#x27;</span>, depends-<span class="literal">on</span>=[<span class="string">&#x27;GenomeInfoDbData&#x27;</span>, <span class="string">&#x27;BSgenome&#x27;</span>, <span class="string">&#x27;EnsDb&#x27;</span>]&#125;</span><br></pre></td></tr></table></figure><p>执行<code>pixi run r_dep</code>时，Pixi会自动先执行三个安装任务，最后输出完成信息。除了这种指定任务名为依赖的组织方式，Pixi也支持以文件作为标志，从而跳过已完成步骤的组织方式，不过… 功能过于简单，我自己没有太多使用。</p><h2 id="3-为特定软件包指定来源"><a href="#3-为特定软件包指定来源" class="headerlink" title="3. 为特定软件包指定来源"></a>3. 为特定软件包指定来源</h2><p>有时我们需要从特定的channel安装某个软件包（例如某个内部channel），而其他包仍从默认channel获取。Pixi允许在依赖声明中单独指定<code>channel</code>属性。在依赖项后面添加<code>&#123;version = &quot;*&quot;, channel = &quot;channel-name&quot;&#125;</code>即可。唯一要注意的是，<code>channel-name</code>必须在前面的<code>channel</code>中被定义过。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;DEMO1&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;1.1&quot;</span></span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>, <span class="string">&quot;bioconda&quot;</span>, <span class="string">&quot;dnachun&quot;</span>]</span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-64&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[feature.label.dependencies]</span></span><br><span class="line"><span class="attr">r-seurat</span> = <span class="string">&#x27;5.2.*&#x27;</span></span><br><span class="line"><span class="attr">r-SeuratDisk</span> = &#123;version = <span class="string">&quot;*&quot;</span>, channel = <span class="string">&quot;dnachun&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>这里<code>r-SeuratDisk</code>将从<code>dnachun</code>这个channel安装，而其他包仍使用<code>channels</code>列表中定义的默认顺序。</p><h2 id="4-混合使用PyPI依赖"><a href="#4-混合使用PyPI依赖" class="headerlink" title="4. 混合使用PyPI依赖"></a>4. 混合使用PyPI依赖</h2><p>Conda生态提供了非常丰富的Python资源，但是一些冷门或特别前沿的包还是会找不到的，这时候可以额外指定Pypi来源的依赖。</p><p>在<code>[pypi-options]</code>中设置PyPI镜像，然后在<code>[dependencies]</code>中列出conda包，在<code>[pypi-dependencies]</code>中列出PyPI包。如果使用workspace模式，也可以在feature中使用<code>[feature.xxx.pypi-dependencies]</code>。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[project]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;DEMO1&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>, <span class="string">&quot;bioconda&quot;</span>]</span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-64&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[pypi-options]</span></span><br><span class="line"><span class="attr">index-url</span> = <span class="string">&quot;https://pypi.tuna.tsinghua.edu.cn/simple&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">snakemake</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">scanpy</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[pypi-dependencies]</span></span><br><span class="line"><span class="attr">singler</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">celldex</span> = <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure><p>上述配置中，<code>singler</code>和<code>celldex</code>将通过PyPI安装，其余包通过conda安装。</p><h2 id="5-跨平台依赖管理"><a href="#5-跨平台依赖管理" class="headerlink" title="5. 跨平台依赖管理"></a>5. 跨平台依赖管理</h2><p>在团队协作或CI&#x2F;CD中，我们可能需要在Linux‑64、Linux‑aarch64（我的Fydetab Duo是Arm架构的RK3588）运行同一套环境。Pixi可以针对不同平台指定不同的依赖版本，甚至在不同的平台使用不同的包来源，以满足特定的依赖（有些包Conda上只有Linux64）。</p><p>使用<code>[target.&lt;platform&gt;.dependencies]</code>节可以为特定平台定义依赖。同时，可以在<code>[environments]</code>中利用<code>platforms</code>字段限制环境支持的平台。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>]</span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-64&quot;</span>, <span class="string">&quot;linux-aarch64&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[target.linux-64.dependencies]</span></span><br><span class="line"><span class="attr">git</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">git-subtree</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.frontend.dependencies]</span></span><br><span class="line"><span class="attr">nodejs</span> = <span class="string">&#x27;18.*&#x27;</span></span><br><span class="line"><span class="attr">pnpm</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.frontend.tasks]</span></span><br><span class="line"><span class="attr">front_init</span> = &#123; cmd = <span class="string">&quot;pnpm install&quot;</span>, cwd = <span class="string">&quot;app/Frontend_Admin&quot;</span> &#125;</span><br><span class="line"><span class="attr">front_build</span> = &#123; cmd = <span class="string">&quot;pnpm run build:prod&quot;</span>, depends-<span class="literal">on</span>=[<span class="string">&#x27;front_init&#x27;</span>]&#125;</span><br></pre></td></tr></table></figure><p>这里，<code>git</code>和<code>git-subtree</code>只在<code>linux-64</code>上安装；而<code>frontend</code>环境仅支持<code>linux-64</code>平台（例如某些前端工具链在ARM上可能不兼容）。</p><h2 id="6-子环境的环境变量设定"><a href="#6-子环境的环境变量设定" class="headerlink" title="6. 子环境的环境变量设定"></a>6. 子环境的环境变量设定</h2><p>某些工具需要在特定环境下设置环境变量（例如Node.js的<code>NODE_OPTIONS</code>、代理设置等）。Pixi允许在feature中通过<code>[feature.xxx.activation.env]</code>定义环境变量，这些变量会在进入该环境时自动设置。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>]</span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-64&quot;</span>, <span class="string">&quot;linux-aarch64&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[environments]</span></span><br><span class="line"><span class="attr">frontend</span> = [<span class="string">&quot;frontend&quot;</span>]</span><br><span class="line"><span class="attr">test</span> = [<span class="string">&quot;test&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[feature.frontend.activation.env]</span></span><br><span class="line"><span class="attr">NODE_OPTIONS</span> = <span class="string">&quot;--openssl-legacy-provider&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.frontend.dependencies]</span></span><br><span class="line"><span class="attr">nodejs</span> = <span class="string">&#x27;18.*&#x27;</span></span><br><span class="line"><span class="attr">pnpm</span> = <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure><p>这样，当运行<code>frontend</code>环境中的任务时，<code>NODE_OPTIONS</code>环境变量会自动生效，避免一些Node.js版本兼容性问题。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过以上六个典型案例，我们可以看到Pixi不仅仅是一个包管理器，更是一个统一的<strong>项目环境与任务协调中心</strong>。它用一份简洁的<code>pixi.toml</code>文件，解决了多语言、多平台、多阶段任务的依赖管理与自动化问题，大大降低了项目配置的复杂度和维护成本。目前我所有自己编写和接收维护的项目都用它来统一进行依赖管理和任务设置。唯一的限制是MySQL这种一定要系统级服务的工具不可能通过它来管理（不过用SQLite就是了，项目其实都不大…）</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 跨平台 </tag>
            
            <tag> 生物信息学 </tag>
            
            <tag> Pixi </tag>
            
            <tag> 依赖管理 </tag>
            
            <tag> 数据科学 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>还是搞不懂_为什么taipy的on_action不嵌套一下就报错</title>
      <link href="/2025/12/17/%E8%BF%98%E6%98%AF%E6%90%9E%E4%B8%8D%E6%87%82-%E4%B8%BA%E4%BB%80%E4%B9%88taipy%E7%9A%84on-action%E4%B8%8D%E5%B5%8C%E5%A5%97%E4%B8%80%E4%B8%8B%E5%B0%B1%E6%8A%A5%E9%94%99/"/>
      <url>/2025/12/17/%E8%BF%98%E6%98%AF%E6%90%9E%E4%B8%8D%E6%87%82-%E4%B8%BA%E4%BB%80%E4%B9%88taipy%E7%9A%84on-action%E4%B8%8D%E5%B5%8C%E5%A5%97%E4%B8%80%E4%B8%8B%E5%B0%B1%E6%8A%A5%E9%94%99/</url>
      
        <content type="html"><![CDATA[<p>我使用过的所有应用快速开发框架，清一色的都是将元素动作绑定到某个Python函数，从而触发信息的更新或者改变，所以应该还算比较有经验。但是Taipy这个的属实让我有点摸不着头脑，时不时的就会报错…</p><span id="more"></span><p>在 Taipy 中，当我们为 <code>on_action</code>（或 <code>on_change</code>）属性直接传递一个函数对象时，会很随机的遇到类似“函数不合法（function not valid）”的错误。例如，以下写法可能会报错：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tgb.table(</span><br><span class="line">    ...</span><br><span class="line">    on_action=update_prod_link,  <span class="comment"># 直接传递函数名</span></span><br><span class="line">    ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>但是如果用匿名函数，就不会出现前述的问题，一切正常：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tgb.table(</span><br><span class="line">    ...</span><br><span class="line">    on_action=<span class="keyword">lambda</span> s, v, p: update_prod_link(s, v, p),</span><br><span class="line">    ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>由于官方的例子都比较简单，都是写的匿名函数，Issue区也没有看到类似的问题反馈，目前阶段我也就只能这么脱裤子放屁了…</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> taipy </tag>
            
            <tag> callback </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>taipy中利用独立的html扩展出新的组件</title>
      <link href="/2025/12/17/taipy%E4%B8%AD%E5%88%A9%E7%94%A8%E7%8B%AC%E7%AB%8B%E7%9A%84html%E6%89%A9%E5%B1%95%E5%87%BA%E6%96%B0%E7%9A%84%E7%BB%84%E4%BB%B6/"/>
      <url>/2025/12/17/taipy%E4%B8%AD%E5%88%A9%E7%94%A8%E7%8B%AC%E7%AB%8B%E7%9A%84html%E6%89%A9%E5%B1%95%E5%87%BA%E6%96%B0%E7%9A%84%E7%BB%84%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<p>我之前就在疑惑，Taipy看上去是在活跃维护的，用户看上去应该也不少（一堆用户提的Issue），但是它的组件库并不能算多么丰富，甚至有些基本的功能都小bug一堆（比如我之前发现的明暗切换按钮bug）。然后我无意间看到了官网上嵌入第三方内容的教程，我突然理解了，虽然它组组件少，但是他可以缝啊！</p><span id="more"></span><h2 id="为什么需要嵌入第三方组件"><a href="#为什么需要嵌入第三方组件" class="headerlink" title="为什么需要嵌入第三方组件"></a>为什么需要嵌入第三方组件</h2><p>Taipy 作为一个以 Python 为中心的 Web 应用框架，其内置的视觉元素（Visual Elements）已经能够覆盖很多常见的交互场景。但在实际项目中，总能轻松的从甲方那收到刚好在现有组件外的要求，这时候，我们只能自己想办法将这些内容“缝”进 Taipy 的页面里。</p><p>Taipy固然提供扩展当前Python组件的说明，但是为了一个用过即丢的小项目，实在没必要先写html&#x2F;js，然后准备好接口绑定到Taipy，然后再做测试、编译、重新安装… 如果真这么干，感觉完成组件前我就被老板开了… </p><p>幸运的是，Taipy 还提供了另外一种“缝”的机制，允许我们将任意 HTML + css + js 编写的页面直接在页面中渲染（其实就是弄了个iframe 套进去）。这个机制的核心就是 <code>Gui.register_content_provider()</code> 函数。</p><h2 id="核心机制：register-content-provider"><a href="#核心机制：register-content-provider" class="headerlink" title="核心机制：register_content_provider"></a>核心机制：register_content_provider</h2><p><code>Gui.register_content_provider(type, provider_func)</code> 接受两个参数：</p><ul><li><code>type</code>：需要是一个Python类型（例如 <code>folium.folium.Map</code>）</li><li><code>provider_func</code>：一个回调函数，它接收一个该类型的对象，并返回一个 <strong>bytes</strong> 对象，这个 bytes 对象应当是该对象对应的 HTML 内容。</li></ul><p>当 Taipy 在页面中遇到一个属于该类型的变量，并且这个变量被放在 <code>part</code> 组件的 <code>content</code> 属性中时，Taipy 就会自动调用你注册的 <code>provider_func</code>，将返回的 HTML 以 iframe 的方式嵌入页面中。</p><p>这样一来，只要能最终得到 HTML 文件 的内容 Taipy 就能进行渲染，显示在页面上。</p><p>官方给的例子是<a href="https://docs.taipy.io/en/latest/tutorials/articles/3rd_party_components/">Folium地图对象</a>，这个库与plotly类似，也是将多种地图的js库进行封装后，提供python api，完成绘制后，可以直接输出html页面，因此可以将生成的html内容直接嵌入到taipy中。</p><h2 id="AI-带来了更强的扩展性"><a href="#AI-带来了更强的扩展性" class="headerlink" title="AI 带来了更强的扩展性"></a>AI 带来了更强的扩展性</h2><p>如果是在两年前，Taipy的方案其实多少有些鸡肋，因为扩展功能最终还是要老老实实的编写Web那一套，违背通过Python快速开发的初衷。但是 LLM 当道，情况发生了极大的改变，现在各种 LLM 可以在极短的时间内生成一个可用的 Web 小组件，然后只需要稍微学习 <a href="https://docs.jinkan.org/docs/jinja2/">Jinja2模板</a> ,就能快速的将数据和Web小组件连接起来，扩展Taipy的功能。虽然这不适用于要求功能特别复杂的情况，但是开发个原型程序绝对够用了。</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> taipy </tag>
            
            <tag> html </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>实操写一个自动部署的github_action</title>
      <link href="/2025/12/17/%E5%AE%9E%E6%93%8D%E5%86%99%E4%B8%80%E4%B8%AA%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E7%9A%84github-action/"/>
      <url>/2025/12/17/%E5%AE%9E%E6%93%8D%E5%86%99%E4%B8%80%E4%B8%AA%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E7%9A%84github-action/</url>
      
        <content type="html"><![CDATA[<p>随着手上要维护的内容越来越多（3个官网，2个系统，1个小程序，全部是前后端分离且数据库独立的项目），出现了很多做1次不费事，但是穿插着做很多次非常乱的工作。我之前已经尝试过用Github进行 CI，这次学习和实践了一下 CD。</p><span id="more"></span><h2 id="个人维护多项目的痛点"><a href="#个人维护多项目的痛点" class="headerlink" title="个人维护多项目的痛点"></a>个人维护多项目的痛点</h2><p>作为被迫单打独斗的打工人，我需要同时维护多个技术栈各异的项目。每个项目都有独立的代码库、构建流程和部署环境。以往的做法是：本地修改代码 → 手动运行构建脚本 → 通过 SCP 将产物上传到服务器 → 登录服务器执行替换和重启操作。这种流程重复性极高，且容易因操作遗漏或手误导致线上问题。</p><p>尤其是当修复一个紧急 bug 后，需要在多个项目间来回切换时，手动部署的耗时和心智负担会显著增加。因此，我希望将这套重复性的操作交给机器自动完成，从而让自己更聚焦于代码逻辑本身。</p><h2 id="为什么需要-CD（持续部署）"><a href="#为什么需要-CD（持续部署）" class="headerlink" title="为什么需要 CD（持续部署）"></a>为什么需要 CD（持续部署）</h2><p>CI（持续集成）负责代码的自动化构建与测试，确保每次提交都是可运行的；而 CD（持续部署）则在此基础上，将通过测试的代码自动部署到生产或预览环境。对于需要频繁更新、多项目并行的团队，CD 能极大减少重复的手动操作，降低人为错误，让开发者更专注于功能开发。</p><p>当然，我不是这样的团队，我只有一个人，但如前所述，一个可用的 CD 工作流依然能让我免于进行机械的重复工作，将精力放到代码问题本身的修复上。</p><h2 id="编写一个-GitHub-Actions-CD-工作流"><a href="#编写一个-GitHub-Actions-CD-工作流" class="headerlink" title="编写一个 GitHub Actions CD 工作流"></a>编写一个 GitHub Actions CD 工作流</h2><p>下面是我为维护的官网项目设计的部署工作流。它会在代码推送到 <code>main</code> 分支、且变更发生在 <code>app/Official_Site/**</code> 或 <code>app/Official_Site_EN/**</code> 目录时自动触发，同时也支持手动在 GitHub 界面点击运行（<code>workflow_dispatch</code>）。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">DEPLOY</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="comment"># 只有此目录发生变化才触发</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;app/Official_Site/**&#x27;</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;app/Official_Site_EN/**&#x27;</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">environment:</span> [<span class="string">website</span>]</span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Pixi</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">prefix-dev/setup-pixi@v0.9.3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">pixi-version:</span> <span class="string">v0.59.0</span></span><br><span class="line">          <span class="attr">environments:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.environment</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">Website</span> <span class="string">for</span> <span class="string">ZH/EN</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          pixi run web_build</span></span><br><span class="line"><span class="string">          mv app/Official_Site/dist front</span></span><br><span class="line"><span class="string">          mv app/Official_Site_EN/dist front-en</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">files</span> <span class="string">ZH</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">appleboy/scp-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">$&#123;&#123;</span> <span class="string">vars.PROD_IP</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PROD_PASSWD</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">22</span></span><br><span class="line">          <span class="attr">source:</span> <span class="string">&quot;front&quot;</span></span><br><span class="line">          <span class="attr">target:</span> <span class="string">/opt/project/uploadPath</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">files</span> <span class="string">EN</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">appleboy/scp-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">$&#123;&#123;</span> <span class="string">vars.PROD_IP</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PROD_PASSWD</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">22</span></span><br><span class="line">          <span class="attr">source:</span> <span class="string">&quot;front-en&quot;</span></span><br><span class="line">          <span class="attr">target:</span> <span class="string">/opt/project/uploadPath</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">appleboy/ssh-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">$&#123;&#123;</span> <span class="string">vars.PROD_IP</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PROD_PASSWD</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">22</span></span><br><span class="line">          <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            cd /opt/project</span></span><br><span class="line"><span class="string">            rm -rf front.bak front-en.bak</span></span><br><span class="line"><span class="string">            mv front front.bak</span></span><br><span class="line"><span class="string">            mv front-en front-en.bak</span></span><br><span class="line"><span class="string">            mv uploadPath/front front</span></span><br><span class="line"><span class="string">            mv uploadPath/front-en front-en</span></span><br><span class="line"><span class="string">            systemctl restart nginx</span></span><br><span class="line"><span class="string"></span>            </span><br></pre></td></tr></table></figure><h3 id="关键步骤说明"><a href="#关键步骤说明" class="headerlink" title="关键步骤说明"></a>关键步骤说明</h3><ol><li><p><strong>触发条件（<code>on</code>）</strong></p><ul><li><code>push</code> 到 <code>main</code> 分支且仅当指定目录有变动，避免无关提交触发构建。</li><li><code>workflow_dispatch</code> 提供手动触发入口，方便在需要时立即部署。</li></ul></li><li><p><strong>代码检出（Checkout）</strong></p><ul><li>使用官方 <code>actions/checkout</code> 动作拉取代码，并指定 <code>ref: main</code> 确保构建基于最新提交。</li></ul></li><li><p><strong>依赖安装（构建产物（Build Website））</strong></p><ul><li>采用 <a href="https://pixi.sh/">Pixi</a> 作为跨语言包管理工具，这里用它内置的命令同时完成环境设置和静态网站构建</li></ul></li><li><p><strong>文件传输（SCP）</strong></p><ul><li>使用 <code>appleboy/scp-action</code> 将构建产物分别上传到服务器的临时目录 <code>/opt/project/uploadPath</code>。</li><li>服务器 IP 通过 <code>vars.PROD_IP</code>（项目变量）传递，密码则存放在 <code>secrets.PROD_PASSWD</code>（仓库机密）中，避免敏感信息暴露在代码里。</li></ul></li><li><p><strong>部署与回滚（SSH）</strong></p><ul><li>通过 <code>appleboy/ssh-action</code> 登录服务器执行替换操作。</li><li>关键逻辑：先将当前运行的 <code>front</code> 和 <code>front-en</code> 目录备份为 <code>.bak</code> 后缀，再从上传目录移入新版本，最后重启 Nginx。</li><li>备份操作提供了快速回滚的能力——只需将备份目录移回即可恢复上一版本。</li></ul></li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过这个简单的 GitHub Actions 工作流，我成功将静态官网的部署时间从每次约 10+ 分钟的手动操作压缩到 2‑3 分钟的自动执行，并且完全杜绝了因操作遗漏导致的问题。</p><p>CD 并不是大团队的专利，个人项目同样可以通过自动化获得显著的效率提升。如果你也在维护多个需要频繁更新的项目，不妨花一小时配置一套属于自己的持续部署流水线，相信它会给你的开发体验带来质的飞跃。</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> github action </tag>
            
            <tag> CD </tag>
            
            <tag> 自动部署 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>对R中绘制的单细胞点图进行格栅化</title>
      <link href="/2025/12/17/%E5%AF%B9R%E4%B8%AD%E7%BB%98%E5%88%B6%E7%9A%84%E5%8D%95%E7%BB%86%E8%83%9E%E7%82%B9%E5%9B%BE%E8%BF%9B%E8%A1%8C%E6%A0%BC%E6%A0%85%E5%8C%96/"/>
      <url>/2025/12/17/%E5%AF%B9R%E4%B8%AD%E7%BB%98%E5%88%B6%E7%9A%84%E5%8D%95%E7%BB%86%E8%83%9E%E7%82%B9%E5%9B%BE%E8%BF%9B%E8%A1%8C%E6%A0%BC%E6%A0%85%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>在生物信息学绘图中，我们经常需要处理包含成千上万个数据点的图形，例如单细胞RNA测序的散点图。这类图形在保存为PDF等矢量格式时会面临文件过大、渲染缓慢的问题（除了AI其他软件基本都会直接死机），因为矢量图会记录每个数据点的坐标、颜色、大小等属性，导致PDF文件包含大量对象，进而影响查看和编辑的效率。</p><span id="more"></span><p>相比之下，位图（如PNG、JPEG）将图像存储为像素矩阵，文件大小相对固定且渲染快速，但放大时会失真。结合两种格式的优点，我们可以对图形中数据密集的图层进行<strong>格栅化（rasterization）</strong>，即只将特定图层转换为位图，同时保持其他图层（如坐标轴、文字标签）为矢量，从而在保证清晰度的前提下显著降低文件大小。</p><p>下面这段R代码展示了如何使用<code>ggrastr</code>包的<code>rasterise</code>函数对<code>ggplot2</code>体系的图形对象进行格栅化：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>ggrastr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>scRNAtoolVis<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制图形，任何会返回ggplot2对象的绘图函数原理一样       </span></span><br><span class="line">plot <span class="operator">&lt;-</span> jjVolcano<span class="punctuation">(</span></span><br><span class="line">    diffData <span class="operator">=</span> markerspbmc.markers<span class="punctuation">,</span></span><br><span class="line">    log2FC.cutoff <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span> </span><br><span class="line">    col.type <span class="operator">=</span> <span class="string">&quot;adjustP&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    size  <span class="operator">=</span> <span class="number">3.5</span><span class="punctuation">,</span></span><br><span class="line">    fontface <span class="operator">=</span> <span class="string">&#x27;italic&#x27;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">layers <span class="operator">&lt;-</span> plot<span class="operator">$</span>layers</span><br><span class="line"><span class="comment"># 查看layers内容后，第三个图层是我想格栅化的点图</span></span><br><span class="line">layers<span class="punctuation">[[</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> rasterise<span class="punctuation">(</span>layers<span class="punctuation">[[</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> dpi <span class="operator">=</span> <span class="number">300</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 替换回 plot</span></span><br><span class="line">plot<span class="operator">$</span>layers <span class="operator">&lt;-</span> layers</span><br></pre></td></tr></table></figure><p>这种方法特别适合用于单细胞点图、基因组浏览器图等大数据量的可视化场景，既能保留重要标注的矢量清晰度，又能让存下来的图形可被一般电脑编辑（当然如果你要编辑点本身、当我没说…</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R </tag>
            
            <tag> ggplot2 </tag>
            
            <tag> 格栅化 </tag>
            
            <tag> rasterization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git中的subtree与submodule</title>
      <link href="/2025/12/06/git%E4%B8%AD%E7%9A%84subtree%E5%92%8Csubmodule/"/>
      <url>/2025/12/06/git%E4%B8%AD%E7%9A%84subtree%E5%92%8Csubmodule/</url>
      
        <content type="html"><![CDATA[<p>Emmmmm，今年官网供应商的合同到期了，于是… 多了一个项目要管… 这个项目依旧是前后端分离的，不同的是，官网有英文版本，且英文版本是前端项目的一个分支。我以前用过Submodule，以将同事写的独立模块整合到主项目中，但是这次我在跟AI请教后，选择了另外一种方式，Subtree</p><span id="more"></span><h2 id="快速比较：Submodule-vs-Subtree"><a href="#快速比较：Submodule-vs-Subtree" class="headerlink" title="快速比较：Submodule vs Subtree"></a>快速比较：Submodule vs Subtree</h2><p>简单来说，Submodule 是在主仓库中创建一个指向子仓库特定提交的“链接”，而 Subtree 则是将子仓库的代码完全复制到主仓库的一个子目录中。两者各有优劣，下表可以帮助你快速了解它们的核心区别：</p><table><thead><tr><th>特性</th><th>Submodule</th><th>Subtree</th></tr></thead><tbody><tr><td>代码存放方式</td><td>主仓库仅保存子仓库的引用（commit hash）</td><td>子仓库的代码完全复制到主仓库中</td></tr><tr><td>克隆后是否需要额外初始化</td><td>需要 <code>git submodule init &amp;&amp; git submodule update</code></td><td>无需额外操作，所有文件已就绪</td></tr><tr><td>在主项目中直接修改子项目代码</td><td>必须进入子模块目录单独提交，步骤繁琐</td><td>可直接在主仓库目录中修改并提交</td></tr><tr><td>历史记录</td><td>子仓库历史与主仓库完全分离</td><td>子仓库的历史可选择性地合并（<code>--squash</code>）或完整保留</td></tr><tr><td>适合场景</td><td>子项目相对稳定，更新频率低；多个主项目共享同一个子项目</td><td>需要频繁在主项目中修改子项目；需引入同一仓库的多个不同分支</td></tr></tbody></table><p>简而言之，<code>Subtree</code>实际上是把子项目代码完整克隆了一份，修改后提交的时候是将主项目里产生的修改记录同步一份到子项目，而子项目被修改时，也可以将这些修改同步回主项目，而<code>submodule</code>实际上是软链接，主项目中只是指定用哪个版本的子项目代码，提交代码回子项目会相对麻烦一些。</p><p>对我而言，一方面，我想要<strong>将同一个仓库的两个不同分支（<code>master</code> 与 <code>en</code>）分别作为独立的子目录引入</strong>；另一方面，我实际需要频繁修改子项目的代码，主项目实际是对这前端后端的整合，根据AI的建议，<strong>Subtree</strong>是操作更简单的组合。</p><h2 id="Subtree-的实际使用方式"><a href="#Subtree-的实际使用方式" class="headerlink" title="Subtree 的实际使用方式"></a>Subtree 的实际使用方式</h2><p>下面是我在主项目中添加各个子项目的具体命令。注意，我使用了 <code>--squash</code> 参数，它可以将子项目的历史提交合并为一个，避免主项目历史被过多的子项目提交淹没。</p><h3 id="1-添加远程仓库"><a href="#1-添加远程仓库" class="headerlink" title="1. 添加远程仓库"></a>1. 添加远程仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote add Backend https://github.com/user/Backend</span><br><span class="line">git remote add Frontend https://github.com/user/Frontend</span><br></pre></td></tr></table></figure><h3 id="2-将子项目以-subtree-形式引入"><a href="#2-将子项目以-subtree-形式引入" class="headerlink" title="2. 将子项目以 subtree 形式引入"></a>2. 将子项目以 subtree 形式引入</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 中文网站（master 分支）</span></span><br><span class="line">git subtree add --prefix=app/Backend Backend master --squash</span><br><span class="line"><span class="comment"># 英文站独立分支（en 分支）</span></span><br><span class="line">git subtree add --prefix=app/Backend_EN Backend en --squash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后端管理项目</span></span><br><span class="line">git subtree add --prefix=app/Backend Backend_Admin aiming_med --squash</span><br></pre></td></tr></table></figure><h3 id="3-日常同步操作"><a href="#3-日常同步操作" class="headerlink" title="3. 日常同步操作"></a>3. 日常同步操作</h3><ul><li><strong>拉取子项目更新</strong>：<code>git subtree pull --prefix=&lt;目录&gt; &lt;远程名&gt; &lt;分支&gt; --squash</code></li><li><strong>推送主项目内对子项目的修改</strong>：<code>git subtree push --prefix=&lt;目录&gt; &lt;远程名&gt; &lt;分支&gt;</code></li></ul><p>当然为了简化操作，可以在Pixi中配置响应的命令</p><h3 id="4-注意事项"><a href="#4-注意事项" class="headerlink" title="4. 注意事项"></a>4. 注意事项</h3><ul><li>使用上述方式设置 subtree 后，子项目代码在本项目已有一份完整拷贝，因此，再次部署时，克隆主项目后<strong>无需</strong>再次运行 subtree add。</li><li>如果是为了开发而克隆，仍需添加远程仓库（如上第一步），以便后续推送更新信息到子项目。</li></ul><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>实际使用了Subtree两周，除了踩到个Devcontainer的git没有subtree模块的坑，其他方面倒是运行良好… 希望不要有什么新问题吧…</p>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 版本控制 </tag>
            
            <tag> git </tag>
            
            <tag> subtree </tag>
            
            <tag> submodule </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pixi也可以在github_action中使用了</title>
      <link href="/2025/12/06/pixi%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%9C%A8github-action%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%BA%86/"/>
      <url>/2025/12/06/pixi%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%9C%A8github-action%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>在 CI&#x2F;CD 流程中，依赖管理往往是决定构建效率与可靠性的关键因素。最近，我在一个静态网站部署流水线中尝试了 <a href="https://github.com/prefix-dev/setup-pixi">setup-pixi</a> 这个 GitHub Action，</p><span id="more"></span><h2 id="为什么选择-Pixi？"><a href="#为什么选择-Pixi？" class="headerlink" title="为什么选择 Pixi？"></a>为什么选择 Pixi？</h2><p>我最开始选择Pixi的时候，主要是出于因为它在使用 <code>conda</code> 的预编译资源基础上，具有比mamba更快的依赖计算速度，且能跟 <code>nodejs</code> 一样有依赖锁机制，适合进行快速的环境迁移部署，这些在软件经常变动的生物信息分析中都是非常需要的特性。</p><p>而在使用了一年多后，我不仅使用它管理生物信息分析的环境，也进一步用他来建立和管理开发环境，目前除了MySQL这种必须要系统常驻服务的没有办法处理外，Pixi完全可以安装所有我工作中需要用到的工具链。</p><p>使用单一的工具就可以进行各种工具链的管理，并且也内置简单的工作流设置，使用体验相当之好。</p><p>唯一的美中不足，就是之前根据领导要求使用Github Action做自动化的时候有那么一点点不便，因为 <code>pixi</code> 毕竟还是涉及虚拟环境，安装和运行的时候都需要进行一些额外的环境变量操作才能使用。</p><p>但是其实官方早就开发了<code>setup-pixi</code> <a href="https://github.com/marketplace/actions/setup-pixi">action</a>，只是我一致不知道而已…</p><h2 id="在-GitHub-Actions-中使用-setup-pixi"><a href="#在-GitHub-Actions-中使用-setup-pixi" class="headerlink" title="在 GitHub Actions 中使用 setup-pixi"></a>在 GitHub Actions 中使用 <code>setup-pixi</code></h2><p><code>setup-pixi</code> 使用起来很简单，下面是一个例子：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">DEPLOY</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">environment:</span> [<span class="string">website</span>]</span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Pixi</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">prefix-dev/setup-pixi@v0.9.3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">pixi-version:</span> <span class="string">v0.59.0</span></span><br><span class="line">          <span class="attr">environments:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.environment</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">Pixi</span> <span class="string">Task</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">pixi</span> <span class="string">run</span> <span class="string">build</span></span><br></pre></td></tr></table></figure><h3 id="步骤解析"><a href="#步骤解析" class="headerlink" title="步骤解析"></a>步骤解析</h3><ol><li><code>Checkout repository</code>：使用 <code>actions/checkout</code> 获取最新代码，需要在 <code>Setup Pixi</code> 之前，毕竟 <code>pixi.toml</code> 和 <code>pixi.lock</code> 在项目里；</li><li><code>Setup Pixi</code>：<code>prefix-dev/setup-pixi</code> Action 会下载并安装指定版本的 Pixi，并自动激活我们在<code>matrix</code> 中指定，并在 <code>pixi.toml</code> 中定义过的环境（本例中的 <code>website</code> 环境）；</li><li><code>Run Pixi Task</code>：有了环境，就可以任意调用项目中已经定义过的task了。</li></ol><p>整个过程简洁清晰，Pixi 环境保证了构建阶段依赖的一致性，一切交给它，定义一次，就不需要再做其他的设置了。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>通过在 GitHub Actions 中利用 <code>setup-pixi</code>，我们可以轻松地使用 <code>pixi</code> 的强大依赖管理能力，简化配置过程，减少人工设置的时间，并保证了从开发到生产环境的高度一致。</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pixi </tag>
            
            <tag> github action </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>又踩坑了--plotly的scattermap不能对大部分marker图标设置颜色</title>
      <link href="/2025/12/02/%E5%8F%88%E8%B8%A9%E5%9D%91%E4%BA%86-plotly%E7%9A%84scattermap%E4%B8%8D%E8%83%BD%E5%AF%B9%E5%A4%A7%E9%83%A8%E5%88%86marker%E5%9B%BE%E6%A0%87%E8%AE%BE%E7%BD%AE%E9%A2%9C%E8%89%B2/"/>
      <url>/2025/12/02/%E5%8F%88%E8%B8%A9%E5%9D%91%E4%BA%86-plotly%E7%9A%84scattermap%E4%B8%8D%E8%83%BD%E5%AF%B9%E5%A4%A7%E9%83%A8%E5%88%86marker%E5%9B%BE%E6%A0%87%E8%AE%BE%E7%BD%AE%E9%A2%9C%E8%89%B2/</url>
      
        <content type="html"><![CDATA[<p>啊, 没想到plotly这么多年了, 还是稍微一用就能触到它的能力边界, 之前是画不了时间轴图, 这次又发现地图的Marker自定义程度不够…</p><span id="more"></span><p>我需要用plotly带的<code>Scattermap</code>对象绘制一个地图, 地图上需要设置一些标点. 然后需求方看了第一版, 觉得想用地图上常见的反水滴形图标来代替默认的圆形. 正好<code>Scattermap</code>支持, 于是我这么写:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">map_fig = (</span><br><span class="line">    go.Figure()</span><br><span class="line">    .add_trace(</span><br><span class="line">        go.Scattermap(</span><br><span class="line">            lat = Lat,</span><br><span class="line">            lon = Lon,</span><br><span class="line">            mode = <span class="string">&#x27;markers&#x27;</span>,</span><br><span class="line">            marker = <span class="built_in">dict</span>(</span><br><span class="line">                size = <span class="number">12</span>,</span><br><span class="line">                color = AIMINGMED_COLOR[<span class="string">&#x27;AIMING_RED&#x27;</span>],</span><br><span class="line">                opacity = <span class="number">0.5</span>,</span><br><span class="line">                symbol = <span class="string">&#x27;marker&#x27;</span>,</span><br><span class="line">                allowoverlap = <span class="literal">True</span></span><br><span class="line">            ),</span><br><span class="line">            hoverinfo = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>结果发现, 图标虽然能自定义, 但是并不能变色… 于是又是一番查找, 最后又发现了一个去年的<a href="https://github.com/plotly/plotly.py/issues/5153">Issue</a>, 这里面给了很绝望的答案, <code>plotly</code>到目前为止就是不支持这个改变, 因为它调用的是<code>maki-icons</code>, 这里面的图标是固定黑色的, 也没有提供通过请求改颜色的接口. </p><p>这个问题的等级是P3, 也就是… 排上日程, 但是最不重要的那一级别… 又是个猴年马月的东西了…</p><p>但是我可不能等, 我又折磨了Copilot一上午, 最后得到的了一个更绝望的答案, <code>plotly.py</code>只是<code>plotly.js</code>的一个包装, 只负责将数据和参数按照要求整理好, 实际的绘制完全由<code>plotly.js</code>实现, 也就是说, 如果我要修复这个问题, 我又要看JS代码, 并且不是修改了就好, 我还要把JS部分的接口写出来, 然后再跟Python的部分对接上… 这… 不是不行, 但是我时间不够…</p><p>于是我又一排脑门想邪门办法了, 根据观察, <code>plotly.js</code>实际上会通过https请求图标的svg文件, 然后用这个文件进行绘图, 那… 有没有可能, 我靠油猴脚本, 拦截这个请求, 塞我准备好的svg文件给他呢?</p><p>这次是chatGPT救我狗命了, deepseek完败… chatGPT确实给我了我一个能够拦截并替换svg文件的脚本:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         Intercept Mapbox Maki Icon via Image.src</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      1.0</span></span><br><span class="line"><span class="comment">// @description  拦截 Mapbox 图标请求并替换成自定义 SVG</span></span><br><span class="line"><span class="comment">// @match        *://*/*</span></span><br><span class="line"><span class="comment">// @run-at       document-start</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">TARGET_PREFIX</span> = <span class="string">&quot;https://unpkg.com/maki@2.1.0/icons/&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">CUSTOM_SVG_CONTENT</span> = <span class="string">`</span></span><br><span class="line"><span class="string">&lt;svg version=&quot;1.1&quot;</span></span><br><span class="line"><span class="string"> id=&quot;svg4619&quot; inkscape:version=&quot;0.91 r13725&quot; sodipodi:docname=&quot;marker-15.svg&quot; xmlns:cc=&quot;http://creativecommons.org/ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:inkscape=&quot;http://www.inkscape.org/namespaces/inkscape&quot; xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:sodipodi=&quot;http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd&quot; xmlns:svg=&quot;http://www.w3.org/2000/svg&quot;</span></span><br><span class="line"><span class="string"> xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; x=&quot;0px&quot; y=&quot;0px&quot; width=&quot;15px&quot; height=&quot;15px&quot;</span></span><br><span class="line"><span class="string"> viewBox=&quot;0 0 15 15&quot; style=&quot;enable-background:new 0 0 15 15;&quot; xml:space=&quot;preserve&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;path id=&quot;path4133&quot; inkscape:connector-curvature=&quot;0&quot; d=&quot;M7.5,0C5.0676,0,2.2297,1.4865,2.2297,5.2703</span></span><br><span class="line"><span class="string">C2.2297,7.8378,6.2838,13.5135,7.5,15c1.0811-1.4865,5.2703-7.027,5.2703-9.7297C12.7703,1.4865,9.9324,0,7.5,0z&quot; fill=&quot;#E72410&quot;/&gt;</span></span><br><span class="line"><span class="string">&lt;/svg&gt;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">CUSTOM_SVG_URL</span> =</span><br><span class="line">        <span class="string">&quot;data:image/svg+xml;base64,&quot;</span> + <span class="title function_">btoa</span>(<span class="variable constant_">CUSTOM_SVG_CONTENT</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 劫持 Image.src</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Image</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&quot;src&quot;</span>, &#123;</span><br><span class="line">        <span class="title function_">set</span>(<span class="params">url</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> url === <span class="string">&quot;string&quot;</span> &amp;&amp; url.<span class="title function_">startsWith</span>(<span class="variable constant_">TARGET_PREFIX</span>)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[Tampermonkey] 拦截 Mapbox 图标: &quot;</span>, url);</span><br><span class="line">                url = <span class="variable constant_">CUSTOM_SVG_URL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setAttribute</span>(<span class="string">&quot;src&quot;</span>, url);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getAttribute</span>(<span class="string">&quot;src&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>总算是… 先实现了, 之后的问题, 之后再说吧哎, 继续加班了…</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> taipy </tag>
            
            <tag> scattermap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大家的想法还真是一样的--读devpod代码有感</title>
      <link href="/2025/12/01/%E5%A4%A7%E5%AE%B6%E7%9A%84%E6%83%B3%E6%B3%95%E8%BF%98%E7%9C%9F%E6%98%AF%E4%B8%80%E6%A0%B7%E7%9A%84/"/>
      <url>/2025/12/01/%E5%A4%A7%E5%AE%B6%E7%9A%84%E6%83%B3%E6%B3%95%E8%BF%98%E7%9C%9F%E6%98%AF%E4%B8%80%E6%A0%B7%E7%9A%84/</url>
      
        <content type="html"><![CDATA[<p>在使用<a href="https://github.com/loft-sh/devpod">devpod</a>一小段时间后, 我确定, 我还是需要一个能不依赖容器, 直接通过ssh在宿主机上自动安装vscode, 然后把端口转发回来的工具. 于是我开始白嫖Copilot来给我解释devpod的代码…</p><span id="more"></span><p>然后, 在拷问Copilot一段时间后, 我开始和我的<a href="https://github.com/KaikePing">前室友</a>一样, 被AI气的不轻, 给的解释很少有对的, 然后给的运行示例更是一个也运行不了… 最后回到了最基础的, 给一个文件, 一点点给我解释里头有哪些对象, 有什么方法, 我能怎么用(只是少了我自己复制代码到对话框这一步)…</p><p>在一点点的看了几个周末后, 再次发现, 果然是想法人人有, 就看谁有能力执行…</p><p>之前没有找到devpod, 我想自己从头写一个程序来快速安装vscode的时候, 我编写边总结出来需要实现的内容有:</p><ol><li>程序通过ssh登录远程机器, 检测远程机器是否安装过vscode, 没有则机器上下载vscode</li><li>由于通过ssh执行命令完成前1点很麻烦, 所以将上述功能写到主程序里, 然后给主程序设置一个上传自己的功能, 将程序本身复制到远程机器, 然后校验md5</li><li>由于远程机器的架构可能是x86可能是arm, 项目编译的时候需要一次性编译出所有架构的可执行文件, 方便直接从本地传到远程去</li><li>程序需要能转发远程机器端口到本地, 使用宿主机的ssh程序可能存在不兼容, 需要用golang下的ssh实现来完成</li></ol><p>然后我发现, 我想到的这些, devpod都干了…</p><ol><li>vscode安装支持: devpod不只支持openvscode, 还支持安装所有常用的web ide, 其中甚至有rstudio</li><li>上传自己到远程: devpod在远程宿主机和容器workspace中都会放一份自己的可执行文件, 接收客户端发送的子命令, 并通过 <code>agent</code> 子命令来完成要执行的各种子命令</li><li>远程机器的多种架构支持: 这个倒是没有在本地放不同架构的可执行文件, 但是会检测远程主机的架构, 下载对应架构的 <code>devpod</code></li><li>使用golang的ssh实现: 端口转发部分使用了<code>golang.org/x/crypto/ssh</code></li></ol><p>当然, 即使devpod已经有这么多现成的接口和示例了, 我要基于它做二次开发也不是一件简单的事情…</p><p>首要的障碍就是, golang作为静态语言, 对我来说还是有很多习惯上的不适应的, 毕竟我常用的无一例外都是弱类型的偏脚本语言, 很多golang的东西, 真是不太能理解…</p><p>另外就是, 它的语法, 跟我熟悉的语言还是很不一样的… 甚至我觉得比C#与python的差异都更大, 许多内容不能靠猜, 在AI也经常不给力的情况下, 理解内容还是相当慢的…(甚至应该伴随着挺多理解错误的)</p><p>希望我能坚持到, 弄出一个基本的demo, 祝我好运… </p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> devpod </tag>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>对发现bug的R函数进行热修复</title>
      <link href="/2025/11/26/%E5%AF%B9%E5%8F%91%E7%8E%B0bug%E7%9A%84R%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E7%83%AD%E4%BF%AE%E5%A4%8D/"/>
      <url>/2025/11/26/%E5%AF%B9%E5%8F%91%E7%8E%B0bug%E7%9A%84R%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E7%83%AD%E4%BF%AE%E5%A4%8D/</url>
      
        <content type="html"><![CDATA[<p>短时间内，我碰到两次需要修复R函数Bug的情况了，也顺便学习了一下如何进行热替换…</p><span id="more"></span><h2 id="为什么需要热修复？"><a href="#为什么需要热修复？" class="headerlink" title="为什么需要热修复？"></a>为什么需要热修复？</h2><p>在数据分析项目中，时间往往是关键因素。如果依赖的R包函数存在bug，可能会阻塞整个分析流程。虽然说向包维护者报告bug并帮助修复是最能回馈开源社区的方式，但是… 其实你总不可能跟老板说，我已经跟作者反馈Bug了，猴年马月之后，我们就能等到正确结果啦！</p><p>所以自己找到问题，并进行热修复更实际一些。</p><h2 id="最基本的修复–替换"><a href="#最基本的修复–替换" class="headerlink" title="最基本的修复–替换"></a>最基本的修复–替换</h2><p>据我这些年的使用经验，R虽然支持对象，但是真这么用的并不多，至少大多数生物信息的包还是函数式的，因此，最简单的思路，哪个函数出问题，用修改后的函数替换就是。</p><p>首先，我们可以定位到要修复的函数，然后<code>print(YOUR_FUNCTION)</code>，这样就能得到你目前工作环境中，对应函数的代码了。</p><p>当然，有些时候我们要修复的函数并不是包内导出的给用户使用的函数，可能是包的内部函数，这时需要用包名+<code>:::</code>+函数名来获得代码。</p><p>在对函数做了修改之后，直接<code>&lt;-</code>盖掉原来的函数，就能完成修改了。比如我给<code>Azimuth</code>那个问题的方案，就是直接改函数这么替换。</p><h2 id="修改函数后，进行命名空间设置"><a href="#修改函数后，进行命名空间设置" class="headerlink" title="修改函数后，进行命名空间设置"></a>修改函数后，进行命名空间设置</h2><p>当然大部分函数并不能真像上面那样那么简单就完成修复，因为大多数函数不是孤立的，它可能要在原包内调用其他函数，也可能它是一个不导出的内置函数，这样子在当前命名空间下完成替换，并不能起效，还要替换对应包命名空间下的原函数，步骤如下：</p><p>R提供了<code>assignInNamespace</code>函数，允许我们替换包命名空间中的对象。</p><ol><li>用<code>assignInNamespace</code>设置函数的环境为包的命名空间</li><li>将修改后的函数赋值回包的命名空间</li></ol><p>实际操作起来很简单：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写好修改的函数</span></span><br><span class="line">createOncoMatrix <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span></span><br><span class="line">    print<span class="punctuation">(</span><span class="string">&#x27;Mod！&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置函数环境为包的命名空间</span></span><br><span class="line">environment<span class="punctuation">(</span>createOncoMatrix<span class="punctuation">)</span> <span class="operator">&lt;-</span> asNamespace<span class="punctuation">(</span><span class="string">&quot;maftools&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将修改后的函数替换回包的命名空间</span></span><br><span class="line">assignInNamespace<span class="punctuation">(</span><span class="string">&quot;createOncoMatrix&quot;</span><span class="punctuation">,</span> createOncoMatrix<span class="punctuation">,</span> ns <span class="operator">=</span> <span class="string">&quot;maftools&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>虽然记录了热修复方案，单我还是更希望，不要再让我遇上这种问题了… 30分钟的分析变成一下午的Debug…</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R </tag>
            
            <tag> Debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>为了复现结果，需要一并复现bug</title>
      <link href="/2025/11/26/%E4%B8%BA%E4%BA%86%E5%A4%8D%E7%8E%B0%E7%BB%93%E6%9E%9C%E4%B8%80%E5%B9%B6%E5%A4%8D%E7%8E%B0bug/"/>
      <url>/2025/11/26/%E4%B8%BA%E4%BA%86%E5%A4%8D%E7%8E%B0%E7%BB%93%E6%9E%9C%E4%B8%80%E5%B9%B6%E5%A4%8D%E7%8E%B0bug/</url>
      
        <content type="html"><![CDATA[<p>只要活的够久，就会见到足够多的囧事情。</p><span id="more"></span><p>跟客户合作的一篇文章需要小修，我们需要根据审稿人的意见补充一些展示WES状况的图，由于之前负责的同事已经离职了，这项工作自然交给我了…</p><p>但是就像大部分半路接收的工作一样，拿到数据，一跑，结果不出所料的，跟文章里的图不一样。</p><p>需要绘制的是<code>maftools</code>产生的<code>oncoplot</code>，大概选择了20+个基因来展示配对样本的突变一致性，然而同样的文件，我画出来的突变类型跟前同事提供的基本都对不上。相比前同事的版本，我的图里<code>Splice_Site</code>消失了，同时虽然都检出突变，但是我的版本显示出大量的<code>MultiHit</code>，但是前同事的版本却基本都是每个基因单突变类型。</p><p>遂查看了原始文件，发现原始文件中确实有<code>Splice_Site</code>，所以判断是我的版本有问题，再次开始翻Github的Issue，经过一段折腾，没想到，涉及了2个bug，一个是我版本里的，另一个，是前同事的…</p><h2 id="背景补充"><a href="#背景补充" class="headerlink" title="背景补充"></a>背景补充</h2><p>首先补充一下，软件版本的差异。</p><p>前同事是使用个人电脑分析的，自行装的R和Rstudio，版本反正不可考了。我这边入职的是有已经购置了服务器，所以一直是使用服务器分析。然后因为我按照Pixi的原设计逻辑，一项目一配置，且我跨项目不保留<code>pixi.lock</code>，<code>pixi.toml</code>中除非有兼容性问题，并不限定版本，所以我用的包都会是依赖满足范围内，<code>bioconda</code>上有的最新版本。目前<code>maftools</code>在上面更新到<code>2.22</code>。</p><p>再然后是输入文件的情况，现在的单位使用的是ANNOVAR（跳槽了一圈又回到ANNOVAR了）</p><h2 id="Splice-Site解析问题"><a href="#Splice-Site解析问题" class="headerlink" title="Splice_Site解析问题"></a><code>Splice_Site</code>解析问题</h2><p>追溯我的版本中，<code>Splice_Site</code>的丢失情况，可以发现，是将ANNOVAR结果中的突变类型，映射成MAF对应的类型时出的问题，具体见下：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ann<span class="punctuation">[</span><span class="punctuation">,</span> `:=`<span class="punctuation">(</span>Hugo_Symbol<span class="punctuation">,</span> unlist<span class="punctuation">(</span>data.table<span class="operator">::</span>tstrsplit<span class="punctuation">(</span>Gene.refGene<span class="punctuation">,</span> </span><br><span class="line">    split <span class="operator">=</span> <span class="string">&quot;;&quot;</span><span class="punctuation">,</span> keep <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">annovar_values <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>exonic <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">,</span> splicing <span class="operator">=</span> <span class="string">&quot;Splice_Site&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    UTR5 <span class="operator">=</span> <span class="string">&quot;5&#x27;UTR&quot;</span><span class="punctuation">,</span> UTR3 <span class="operator">=</span> <span class="string">&quot;3&#x27;UTR&quot;</span><span class="punctuation">,</span> intronic <span class="operator">=</span> <span class="string">&quot;Intron&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    upstream <span class="operator">=</span> <span class="string">&quot;5&#x27;Flank&quot;</span><span class="punctuation">,</span> downstream <span class="operator">=</span> <span class="string">&quot;3&#x27;Flank&quot;</span><span class="punctuation">,</span> intergenic <span class="operator">=</span> <span class="string">&quot;IGR&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    `frameshift insertion` <span class="operator">=</span> <span class="string">&quot;Frame_Shift_Ins&quot;</span><span class="punctuation">,</span> `frameshift deletion` <span class="operator">=</span> <span class="string">&quot;Frame_Shift_Del&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    `frameshift block substitution` <span class="operator">=</span> <span class="string">&quot;Frameshift_INDEL&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    `frameshift substitution` <span class="operator">=</span> <span class="string">&quot;Frameshift_INDEL&quot;</span><span class="punctuation">,</span> stopgain <span class="operator">=</span> <span class="string">&quot;Nonsense_Mutation&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    stoploss <span class="operator">=</span> <span class="string">&quot;Nonstop_Mutation&quot;</span><span class="punctuation">,</span> startloss <span class="operator">=</span> <span class="string">&quot;Translation_Start_Site&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    startgain <span class="operator">=</span> <span class="string">&quot;Unknown&quot;</span><span class="punctuation">,</span> `nonframeshift insertion` <span class="operator">=</span> <span class="string">&quot;In_Frame_Ins&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    `nonframeshift deletion` <span class="operator">=</span> <span class="string">&quot;In_Frame_Del&quot;</span><span class="punctuation">,</span> `nonframeshift block substitution` <span class="operator">=</span> <span class="string">&quot;Inframe_INDEL&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    `nonframeshift substitution` <span class="operator">=</span> <span class="string">&quot;Inframe_INDEL&quot;</span><span class="punctuation">,</span> `nonsynonymous SNV` <span class="operator">=</span> <span class="string">&quot;`Missense`_Mutation&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    `synonymous SNV` <span class="operator">=</span> <span class="string">&quot;Silent&quot;</span><span class="punctuation">,</span> unknown <span class="operator">=</span> <span class="string">&quot;Unknown&quot;</span><span class="punctuation">,</span> ncRNA_exonic <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    ncRNA_intronic <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">,</span> ncRNA_UTR3 <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">,</span> ncRNA_UTR5 <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    ncRNA <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">,</span> ncRNA_splicing <span class="operator">=</span> <span class="string">&quot;RNA&quot;</span><span class="punctuation">)</span></span><br><span class="line">ann<span class="punctuation">[</span><span class="punctuation">,</span> `:=`<span class="punctuation">(</span>Func.refGene<span class="punctuation">,</span> unlist<span class="punctuation">(</span>data.table<span class="operator">::</span>tstrsplit<span class="punctuation">(</span>x <span class="operator">=</span> <span class="built_in">as.character</span><span class="punctuation">(</span>Func.refGene<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">    split <span class="operator">=</span> <span class="string">&quot;;&quot;</span><span class="punctuation">,</span> keep <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">ann<span class="punctuation">[</span><span class="punctuation">,</span> `:=`<span class="punctuation">(</span>ExonicFunc.refGene<span class="punctuation">,</span> unlist<span class="punctuation">(</span>data.table<span class="operator">::</span>tstrsplit<span class="punctuation">(</span>x <span class="operator">=</span> <span class="built_in">as.character</span><span class="punctuation">(</span>ExonicFunc.refGene<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">    split <span class="operator">=</span> <span class="string">&quot;;&quot;</span><span class="punctuation">,</span> keep <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">ann<span class="operator">$</span>Variant_Classification <span class="operator">=</span> ifelse<span class="punctuation">(</span></span><br><span class="line">    <span class="comment"># 出问题的地方在这里，这里的逻辑是：</span></span><br><span class="line">    <span class="comment"># 当ExonicFunc.refGene不存在数值时，使用Func.refGene数值带入命名向量以进行映射，</span></span><br><span class="line">    <span class="comment"># 否则使用ExonicFunc.refGene带入映射。但是，根据ANNOVAR的文档，进行注释时一般都会</span></span><br><span class="line">    <span class="comment"># 加上 `-nasting .`，即用点号表示缺失，因此ExonicFunc.refGene根本不会缺失</span></span><br><span class="line">    <span class="built_in">is.na</span><span class="punctuation">(</span>ann<span class="operator">$</span>ExonicFunc.refGene<span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">    annovar_values<span class="punctuation">[</span>ann<span class="operator">$</span>Func.refGene<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    annovar_values<span class="punctuation">[</span>ann<span class="operator">$</span>ExonicFunc.refGene<span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>经过上面描述的问题，由于ExonicFunc.refGene根本不会缺失，所有<code>ExonicFunc.refGene</code>为缺失的变异，其实也就是外显子区域以外的变异，都会因为<code>Variant_Classification</code>映射出缺失值被过滤掉，体现出来的效果就是，这些突变解析后全部不见了。</p><p>所以修复也很简单，额外判断一下<code>.</code>，或者前面<code>fread</code>读取的时候指定<code>.</code>是缺失就行了。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ann<span class="operator">$</span>Variant_Classification <span class="operator">=</span> ifelse<span class="punctuation">(</span></span><br><span class="line">    <span class="comment"># 我选择直接改判断</span></span><br><span class="line">    <span class="built_in">is.na</span><span class="punctuation">(</span>ann<span class="operator">$</span>ExonicFunc.refGene<span class="punctuation">)</span> <span class="operator">|</span> ann<span class="operator">$</span>ExonicFunc.refGene <span class="operator">==</span> <span class="string">&quot;.&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    annovar_values<span class="punctuation">[</span>ann<span class="operator">$</span>Func.refGene<span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    annovar_values<span class="punctuation">[</span>ann<span class="operator">$</span>ExonicFunc.refGene<span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>这个问题追溯起来，其实不一定是maftools的原因，我往前倒了好多个版本，没见这个地方有修改，说不定是<code>fread</code>改了默认的<code>nastring</code>参数…反正我的问题解决了，我也不继续追了…</p><h2 id="MultiHit解析问题"><a href="#MultiHit解析问题" class="headerlink" title="MultiHit解析问题"></a><code>MultiHit</code>解析问题</h2><p>这个问题是源自一个有<a href="https://github.com/PoisonAlien/maftools/issues/347">Issue</a>的问题了。简单来说就是，maftools的老版本中，<code>MultiHit</code>的逻辑有问题。<code>MultiHit</code>想展示的，是一个基因发生两个不同的改变氨基酸的突变（<code>Missense</code> + <code>Missense</code> &#x3D; MultiHit）。但是老版本中，实际上同一个基因发生不同类型的突变才会是<code>MultiHit</code>，如果都是<code>Missense</code>突变，则会直接显示<code>Missense</code>。</p><p>在我使用的最新版本中，这个问题已经被修复，因此我的结果中出现了大量的<code>MultiHit</code>…</p><p>那…能怎么办呢，对着Issue的修改，把Bug复现出来呗…</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>前两天才吐槽过，<code>Azimuth</code>的Bug，我真没想到这么快，用过好多次的<code>maftools</code>也会有问题。</p><p>只能说敝人不只是天煞孤星，还是特么是扫把星…</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R </tag>
            
            <tag> maftools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>出身豪门也还是会坑--Azimuth也是Bug成堆</title>
      <link href="/2025/11/22/%E5%87%BA%E8%BA%AB%E8%B1%AA%E9%97%A8%E4%B9%9F%E8%BF%98%E6%98%AF%E4%BC%9A%E5%9D%91/"/>
      <url>/2025/11/22/%E5%87%BA%E8%BA%AB%E8%B1%AA%E9%97%A8%E4%B9%9F%E8%BF%98%E6%98%AF%E4%BC%9A%E5%9D%91/</url>
      
        <content type="html"><![CDATA[<p>从事生物信息分析，研究方向越前沿，就要面临越多来自信息侧的问题。即使是文章发的非常好，原作者共享了代码，甚至写了现成软件工具，也不代表我们能轻松顺利的用这些现成的东西来复现或进行研究，混乱的环境设置只是一方面，更多时候，由于软件作者并不是专业的软件工程师，工具功能大致能用已经谢天谢地了，不能奢望这些软件没有一点毛病，更不能奢望有性能可言（除非开发时性能被来就是开发点）。即使这工具来自于有实力的大实验室，很多时候也不能幸免，比如… Azimuth。</p><span id="more"></span><h2 id="Azimuth-介绍"><a href="#Azimuth-介绍" class="headerlink" title="Azimuth 介绍"></a>Azimuth 介绍</h2><p><a href="https://github.com/satijalab/azimuth">Azimuth</a>是由Satija实验室开发的单细胞数据注释工具，旨在简化 Seurat 中的 Label Transfer 流程，快速的对待分型细胞进行 Label Transfer。</p><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在当前最新的 <code>0.5.0</code> 版本中， 在Jupyter Notebook 中运行 <code>AzimuthReference</code> 会提示 <code>Error in ValidateAzimuthReference(object = object): Reference must contain an AzimuthData object in the tools slot.</code></p><p>谷歌一搜，发现该问题在2024年4月就已经被提出（<a href="https://github.com/satijalab/azimuth/issues/219">issue #219</a>）了，提出问题的用户已经给了解决方案，但这个Issue至今开放，且问题仍未被解决（上周又有用户反馈遇到同样的问题）。</p><h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>如前所述，Issue发起人zacharyrs已经提到了问题所在，在<a href="https://github.com/satijalab/azimuth/commit/b1b6895f5235c4d0551d5673322330e2a4b468b3">b1b6895</a>这个提交中，代码作者使用<code>sys.calls()</code>来判断当前调用的函数名称，并根据这个名称来判断后续处理。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">tool.name <span class="operator">&lt;-</span> <span class="built_in">as.character</span><span class="punctuation">(</span>x <span class="operator">=</span> sys.calls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="comment"># &lt;-- 这里的sys.calls()会返回一个list，如果不是直接调用AzimuthReference，就会删除对象中的一些信息</span></span><br><span class="line">tool.name <span class="operator">&lt;-</span> lapply<span class="punctuation">(</span></span><br><span class="line">  X <span class="operator">=</span> strsplit<span class="punctuation">(</span>x <span class="operator">=</span> tool.name<span class="punctuation">,</span> split <span class="operator">=</span> <span class="string">&quot;(&quot;</span><span class="punctuation">,</span> fixed <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">  FUN <span class="operator">=</span> <span class="string">&quot;[&quot;</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="number">1</span></span><br><span class="line"><span class="punctuation">)</span><span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line"><span class="keyword">if</span> <span class="punctuation">(</span>tool.name <span class="operator">!=</span> <span class="string">&quot;AzimuthReference&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  slot<span class="punctuation">(</span>object<span class="punctuation">,</span> name <span class="operator">=</span> <span class="string">&quot;tools&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="string">&quot;AzimuthReference&quot;</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> slot<span class="punctuation">(</span>object<span class="punctuation">,</span> name <span class="operator">=</span> <span class="string">&quot;tools&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span>tool.name<span class="punctuation">]</span></span><br><span class="line">  slot<span class="punctuation">(</span>object<span class="punctuation">,</span> name <span class="operator">=</span> <span class="string">&quot;tools&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span>tool.name<span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">object <span class="operator">&lt;-</span> DietSeurat<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">,</span> </span><br><span class="line">                      counts <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> </span><br><span class="line">                      assays <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;refAssay&quot;</span><span class="punctuation">,</span> assays<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                      dimreducs <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;refDR&quot;</span><span class="punctuation">,</span> <span class="string">&quot;refUMAP&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>然而实际上我们很多时候需要将<code>AzimuthReference</code>包到函数里使用，这时候，<code>sys.calls()</code> 返回的list中，第一项内容是最外侧的函数名称，这样就会导致<code>Azimuth</code>运行需要的数据被删除，下面的检查就会报错了。</p><p>对于我的情况来说，我也是第一次知道，notebook中所有的代码都是包在IRKernel的函数下的（感谢AI给了我排查方法），所以即使我笔记中直接运行<code>AzimuthReference</code>，也会发生将<code>AzimuthReference</code>放在函数中运行时才触发的错误。</p><p>处理也很简单，修改这里的判断，<code>sys.calls()</code>返回list后，去最后一项，再做正则取函数名就行：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call_list <span class="operator">&lt;-</span> sys.calls<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">tool.name <span class="operator">&lt;-</span> <span class="built_in">as.character</span><span class="punctuation">(</span>x <span class="operator">=</span> call_list<span class="punctuation">[[</span><span class="built_in">length</span><span class="punctuation">(</span>call_list<span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>在我们的实际代码中，则可以加载<code>Azimuth</code>后，自行用修改后的函数去覆盖原来的<code>AzimuthReference</code>，这样后续代码就能运行了。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>Azimuth<span class="punctuation">)</span></span><br><span class="line">AzimuthReference <span class="operator">&lt;-</span> <span class="keyword">function</span> <span class="punctuation">(</span>object<span class="punctuation">,</span> refUMAP <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> refDR <span class="operator">=</span> <span class="string">&quot;spca&quot;</span><span class="punctuation">,</span> refAssay <span class="operator">=</span> <span class="string">&quot;SCT&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    dims <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">50</span><span class="punctuation">,</span> k.param <span class="operator">=</span> <span class="number">31</span><span class="punctuation">,</span> plotref <span class="operator">=</span> <span class="string">&quot;umap&quot;</span><span class="punctuation">,</span> plot.metadata <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> </span><br><span class="line">    ori.index <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> colormap <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> assays <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> metadata <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> </span><br><span class="line">    reference.version <span class="operator">=</span> <span class="string">&quot;0.0.0&quot;</span><span class="punctuation">,</span> verbose <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span> </span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span>refUMAP <span class="operator">%in%</span> Reductions<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        stop<span class="punctuation">(</span><span class="string">&quot;refUMAP (&quot;</span><span class="punctuation">,</span> refUMAP<span class="punctuation">,</span> <span class="string">&quot;) not found in Seurat object provided&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="punctuation">(</span><span class="built_in">is.null</span><span class="punctuation">(</span>x <span class="operator">=</span> Misc<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">[[</span>refUMAP<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> slot <span class="operator">=</span> <span class="string">&quot;model&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        stop<span class="punctuation">(</span><span class="string">&quot;refUMAP (&quot;</span><span class="punctuation">,</span> refUMAP<span class="punctuation">,</span> <span class="string">&quot;) does not have the umap model info stored. &quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="string">&quot;Please rerun RunUMAP with return.model = TRUE.&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span>refDR <span class="operator">%in%</span> Reductions<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        stop<span class="punctuation">(</span><span class="string">&quot;refDR (&quot;</span><span class="punctuation">,</span> refDR<span class="punctuation">,</span> <span class="string">&quot;) not found in Seurat object provided&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="punctuation">(</span><span class="built_in">is.null</span><span class="punctuation">(</span>x <span class="operator">=</span> metadata<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        stop<span class="punctuation">(</span><span class="string">&quot;Please specify at least one metadata field (for transfer and plotting).&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> metadata<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span>i <span class="operator">%in%</span> colnames<span class="punctuation">(</span>x <span class="operator">=</span> object<span class="punctuation">[[</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">            warning<span class="punctuation">(</span>i<span class="punctuation">,</span> <span class="string">&quot; not found in Seurat object metadata&quot;</span><span class="punctuation">)</span></span><br><span class="line">            <span class="keyword">next</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span>is.factor<span class="punctuation">(</span>x <span class="operator">=</span> object<span class="punctuation">[[</span>i<span class="punctuation">,</span> drop <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">            warning<span class="punctuation">(</span>i<span class="punctuation">,</span> <span class="string">&quot; is not a factor. Converting to factor with alphabetical &quot;</span><span class="punctuation">,</span> </span><br><span class="line">                <span class="string">&quot;levels.&quot;</span><span class="punctuation">,</span> call. <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">            object<span class="punctuation">[[</span>i<span class="punctuation">,</span> drop <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>x <span class="operator">=</span> object<span class="punctuation">[[</span>i<span class="punctuation">,</span> </span><br><span class="line">                drop <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> levels <span class="operator">=</span> sort<span class="punctuation">(</span>x <span class="operator">=</span> unique<span class="punctuation">(</span>object<span class="punctuation">[[</span>i<span class="punctuation">,</span> </span><br><span class="line">                drop <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span>refAssay <span class="operator">%in%</span> Assays<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        stop<span class="punctuation">(</span><span class="string">&quot;Seurat object provided must have the SCT Assay stored.&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span>inherits<span class="punctuation">(</span>x <span class="operator">=</span> object<span class="punctuation">[[</span>refAssay<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> what <span class="operator">=</span> <span class="string">&quot;SCTAssay&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        stop<span class="punctuation">(</span><span class="string">&quot;refAssay (&quot;</span><span class="punctuation">,</span> refAssay<span class="punctuation">,</span> <span class="string">&quot;) is not an SCTAssay.&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="punctuation">(</span><span class="built_in">length</span><span class="punctuation">(</span>x <span class="operator">=</span> levels<span class="punctuation">(</span>x <span class="operator">=</span> object<span class="punctuation">[[</span>refAssay<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">!=</span> <span class="number">1</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        stop<span class="punctuation">(</span><span class="string">&quot;refAssay (&quot;</span><span class="punctuation">,</span> refAssay<span class="punctuation">,</span> <span class="string">&quot;) should contain a single SCT model.&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    suppressWarnings<span class="punctuation">(</span>expr <span class="operator">=</span> object<span class="punctuation">[[</span><span class="string">&quot;refUMAP&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> object<span class="punctuation">[[</span>refUMAP<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">    suppressWarnings<span class="punctuation">(</span>expr <span class="operator">=</span> object<span class="punctuation">[[</span><span class="string">&quot;refDR&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> object<span class="punctuation">[[</span>refDR<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">    object <span class="operator">&lt;-</span> FindNeighbors<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">,</span> reduction <span class="operator">=</span> <span class="string">&quot;refDR&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        dims <span class="operator">=</span> dims<span class="punctuation">,</span> graph.name <span class="operator">=</span> <span class="string">&quot;refdr.annoy.neighbors&quot;</span><span class="punctuation">,</span> k.param <span class="operator">=</span> k.param<span class="punctuation">,</span> </span><br><span class="line">        nn.method <span class="operator">=</span> <span class="string">&quot;annoy&quot;</span><span class="punctuation">,</span> annoy.metric <span class="operator">=</span> <span class="string">&quot;cosine&quot;</span><span class="punctuation">,</span> cache.index <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> </span><br><span class="line">        return.neighbor <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> l2.norm <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> verbose <span class="operator">=</span> verbose<span class="punctuation">)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="punctuation">(</span>verbose<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        message<span class="punctuation">(</span><span class="string">&quot;Computing pseudobulk averages&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    features <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>x <span class="operator">=</span> Loadings<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">[[</span><span class="string">&quot;refDR&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    plot.metadata <span class="operator">&lt;-</span> plot.metadata <span class="operator">%||%</span> object<span class="punctuation">[[</span>metadata<span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">    <span class="keyword">if</span> <span class="punctuation">(</span>inherits<span class="punctuation">(</span>x <span class="operator">=</span> plotref<span class="punctuation">,</span> what <span class="operator">=</span> <span class="string">&quot;DimReduc&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        plot.metadata <span class="operator">&lt;-</span> plot.metadata<span class="punctuation">[</span>Cells<span class="punctuation">(</span>x <span class="operator">=</span> plotref<span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    ad <span class="operator">&lt;-</span> CreateAzimuthData<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">,</span> plotref <span class="operator">=</span> plotref<span class="punctuation">,</span> </span><br><span class="line">        plot.metadata <span class="operator">=</span> plot.metadata<span class="punctuation">,</span> colormap <span class="operator">=</span> colormap<span class="punctuation">,</span> reference.version <span class="operator">=</span> reference.version<span class="punctuation">)</span></span><br><span class="line">    ori.index <span class="operator">&lt;-</span> ori.index <span class="operator">%||%</span> match<span class="punctuation">(</span>Cells<span class="punctuation">(</span>x <span class="operator">=</span> object<span class="punctuation">)</span><span class="punctuation">,</span> Cells<span class="punctuation">(</span>x <span class="operator">=</span> object<span class="punctuation">[[</span><span class="string">&quot;refUMAP&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    object<span class="operator">$</span>ori.index <span class="operator">&lt;-</span> ori.index</span><br><span class="line">    DefaultAssay<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">)</span> <span class="operator">&lt;-</span> refAssay</span><br><span class="line">    object<span class="punctuation">[[</span>refAssay<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> subset<span class="punctuation">(</span>x <span class="operator">=</span> object<span class="punctuation">[[</span>refAssay<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> features <span class="operator">=</span> features<span class="punctuation">)</span></span><br><span class="line">    DefaultAssay<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">[[</span><span class="string">&quot;refDR&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">&lt;-</span> refAssay</span><br><span class="line">    object <span class="operator">&lt;-</span> DietSeurat<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">,</span> counts <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> assays <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>refAssay<span class="punctuation">,</span> </span><br><span class="line">        assays<span class="punctuation">)</span><span class="punctuation">,</span> dimreducs <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;refDR&quot;</span><span class="punctuation">,</span> <span class="string">&quot;refUMAP&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    metadata <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span>metadata<span class="punctuation">,</span> <span class="string">&quot;ori.index&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="keyword">for</span> <span class="punctuation">(</span>i <span class="keyword">in</span> colnames<span class="punctuation">(</span>x <span class="operator">=</span> object<span class="punctuation">[[</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="punctuation">(</span><span class="operator">!</span>i <span class="operator">%in%</span> metadata<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">            object<span class="punctuation">[[</span>i<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    sct.model <span class="operator">&lt;-</span> slot<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">[[</span>refAssay<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> name <span class="operator">=</span> <span class="string">&quot;SCTModel.list&quot;</span><span class="punctuation">)</span><span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">    object<span class="punctuation">[[</span><span class="string">&quot;refAssay&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> as<span class="punctuation">(</span>object <span class="operator">=</span> suppressWarnings<span class="punctuation">(</span>Seurat<span class="operator">:::</span>CreateDummyAssay<span class="punctuation">(</span>assay <span class="operator">=</span> object<span class="punctuation">[[</span>refAssay<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">        Class <span class="operator">=</span> <span class="string">&quot;SCTAssay&quot;</span><span class="punctuation">)</span></span><br><span class="line">    slot<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">[[</span><span class="string">&quot;refAssay&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> name <span class="operator">=</span> <span class="string">&quot;SCTModel.list&quot;</span><span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span>refmodel <span class="operator">=</span> sct.model<span class="punctuation">)</span></span><br><span class="line">    DefaultAssay<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="string">&quot;refAssay&quot;</span></span><br><span class="line">    DefaultAssay<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">[[</span><span class="string">&quot;refDR&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="string">&quot;refAssay&quot;</span></span><br><span class="line">    Tool<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">)</span> <span class="operator">&lt;-</span> ad</span><br><span class="line">    call_list <span class="operator">&lt;-</span> sys.calls<span class="punctuation">(</span><span class="punctuation">)</span>                                           <span class="comment"># use the last element of sys.call() to get the right function name</span></span><br><span class="line">    tool.name <span class="operator">&lt;-</span> <span class="built_in">as.character</span><span class="punctuation">(</span>x <span class="operator">=</span> call_list<span class="punctuation">[[</span><span class="built_in">length</span><span class="punctuation">(</span>call_list<span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span>      <span class="comment"># use the last element of sys.call() to get the right function name</span></span><br><span class="line">    tool.name <span class="operator">&lt;-</span> lapply<span class="punctuation">(</span>X <span class="operator">=</span> strsplit<span class="punctuation">(</span>x <span class="operator">=</span> tool.name<span class="punctuation">,</span> split <span class="operator">=</span> <span class="string">&quot;(&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        fixed <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span><span class="punctuation">,</span> FUN <span class="operator">=</span> <span class="string">&quot;[&quot;</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">    <span class="keyword">if</span> <span class="punctuation">(</span>tool.name <span class="operator">!=</span> <span class="string">&quot;AzimuthReference&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        slot<span class="punctuation">(</span>object<span class="punctuation">,</span> name <span class="operator">=</span> <span class="string">&quot;tools&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="string">&quot;AzimuthReference&quot;</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> slot<span class="punctuation">(</span>object<span class="punctuation">,</span> </span><br><span class="line">            name <span class="operator">=</span> <span class="string">&quot;tools&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span>tool.name<span class="punctuation">]</span></span><br><span class="line">        slot<span class="punctuation">(</span>object<span class="punctuation">,</span> name <span class="operator">=</span> <span class="string">&quot;tools&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span>tool.name<span class="punctuation">]</span> <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">    object <span class="operator">&lt;-</span> DietSeurat<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">,</span> counts <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> assays <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;refAssay&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        assays<span class="punctuation">)</span><span class="punctuation">,</span> dimreducs <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;refDR&quot;</span><span class="punctuation">,</span> <span class="string">&quot;refUMAP&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    ValidateAzimuthReference<span class="punctuation">(</span>object <span class="operator">=</span> object<span class="punctuation">)</span></span><br><span class="line">    <span class="built_in">return</span><span class="punctuation">(</span>object<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Azimuth感觉被放弃了"><a href="#Azimuth感觉被放弃了" class="headerlink" title="Azimuth感觉被放弃了"></a>Azimuth感觉被放弃了</h2><p>虽然出自Satija实验室，但总感觉这个项目基本已经被放弃了，github上有近百个开放Issue，去年开始提的PR到现在还有5个未合并也未拒绝。最近他们又弄了个<a href="https://github.com/satijalab/panhumanpy">基于Python和深度学习的通用细胞类型Label Transfer项目</a>，感觉是研究进入下一步，老的项目就不准备维护了。</p><p>况且要进行Label Transfer，也可以自己跟着教程一步步做，不是非要用<code>Azimuth</code>，也许再过段时间，这个项目就会被Archieve了吧…</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生物信息 </tag>
            
            <tag> 单细胞 </tag>
            
            <tag> 开源软件 </tag>
            
            <tag> 软件维护 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从一个讲RISC-V的视频想到的</title>
      <link href="/2025/11/22/%E4%BB%8E%E4%B8%80%E4%B8%AA%E8%AE%B2riscv%E7%9A%84%E8%A7%86%E9%A2%91%E6%83%B3%E5%88%B0/"/>
      <url>/2025/11/22/%E4%BB%8E%E4%B8%80%E4%B8%AA%E8%AE%B2riscv%E7%9A%84%E8%A7%86%E9%A2%91%E6%83%B3%E5%88%B0/</url>
      
        <content type="html"><![CDATA[<p>我一直有下班骑车路上听视频的习惯，这周听到了<a href="http://bilibili.com/video/BV1F1ycBmEaW">差评讲 RISC-V 的视频</a>。视频中提到一个观点：RISC-V 作为一种指令集架构，基于它的芯片产品存在严重的碎片化问题，导致应用生态发展面临很大困难，因此必须解决碎片化问题，通过统一标准才能实现快速发展。这个观点让我联想到多年来使用 Linux、安卓以及 R 语言的经历，我觉得视频中的说法可能并不完全准确。</p><span id="more"></span><p>如果真如视频中所说，碎片化问题会对技术推广产生严重阻碍，那么很难解释为何 Linux 在服务器领域的市场份额能够远超 Windows，安卓系统能够在全球移动设备市场占据自己的地位，以及 R 语言在统计计算领域的发展甚至对 SAS 等商业软件构成了强有力的竞争。</p><p>个人认为，”碎片化”这个词往往被用来强调开源技术的负面特性。很多讨论在关注这个问题时，过于放大”碎片化”的负面影响，而选择性忽视了开源技术核心的”自由”价值——即便是 GPL 协议所定义的”有限自由”。</p><p>正是这种自由度，使得有兴趣但缺乏资金和资源的人才能够参与进来，最大限度地汇集众人智慧，推动技术进步。</p><p>我详细RISC-V之后会像其他开源技术一样以超出预期的速度发展，尤其在这个保不齐哪天商业技术说不能用就不能用了的时代…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> R </tag>
            
            <tag> RISC-V </tag>
            
            <tag> SAS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AI还是改变生活--让我能做以前很难起步的事情</title>
      <link href="/2025/11/22/AI%E8%BF%98%E6%98%AF%E6%94%B9%E5%8F%98%E7%94%9F%E6%B4%BB-%E8%AE%A9%E6%88%91%E8%83%BD%E5%81%9A%E4%BB%A5%E5%89%8D%E5%BE%88%E9%9A%BE%E8%B5%B7%E6%AD%A5%E7%9A%84%E4%BA%8B%E6%83%85/"/>
      <url>/2025/11/22/AI%E8%BF%98%E6%98%AF%E6%94%B9%E5%8F%98%E7%94%9F%E6%B4%BB-%E8%AE%A9%E6%88%91%E8%83%BD%E5%81%9A%E4%BB%A5%E5%89%8D%E5%BE%88%E9%9A%BE%E8%B5%B7%E6%AD%A5%E7%9A%84%E4%BA%8B%E6%83%85/</url>
      
        <content type="html"><![CDATA[<p>我还是挺喜欢现在的 hexo 主题的，从 2021 年使用它的前身<code>material-x</code>，到2023年升级到 <code>Volantis 5.x</code>，主题的功能已经完全满足我个人的需求了，以至于没有继续升级作者后续的6和7了。不过上半年利用 AI 对博客进行批量英文翻译后，一直有一些界面元素还是中文的问题。今年就不大动工，直接在 AI 指导下自己动手修一修。</p><span id="more"></span><h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>自从使用 AI 工具将博客内容批量翻译成英文后，我的博客就具备了中英双语版本。但是修改的时候出现俩问题：</p><ol><li>英文站中部分组件的切换效果无效，如关于我页面的选项卡，点击后无法切换</li><li>主题界面上的许多元素仍然是中文的，页面最下侧的访问统计也总是会出现一段明显是加入多语言支持时忘记处理的固定中文内容。</li></ol><p>在查看了主题的代码后，感觉前者是个配置问题， 后者则更多是 hexo 这个框架本身的问题导致。比如页面中很多标题和分类的标题， 都是直接编码在配置文件中的，Deepseek 说，hexo 下更简单的方式是直接准备两个配置文件。我现在的方案本来就是中文站一个文件夹，英文站另一个，上述问题在实际尝试后发现，都是修改<code>Volantis</code>代码中的配置文件就能解决的，所以我最后选择直接写俩补丁文件，放在我的博客项目下。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="1-不能切换的问题"><a href="#1-不能切换的问题" class="headerlink" title="1. 不能切换的问题"></a>1. 不能切换的问题</h3><p>从浏览器的报错看，当我把英文站的<code>root</code>设置为<code>/en/</code>后，页面上的<code>app.js</code>这个文件的路径，被错误设置成了<code>/en/en/js/app.js</code>，这个文件应该是负责实现切换效果的，文件找不到，切换效果也就无了。</p><p>根据 Deepseek 的解释，发现修改 <code>_config.yml</code> 下的cdn设置就能解决问题，具体的diff情况如下</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/_config.yml</span></span><br><span class="line"><span class="comment">+++ b/_config.yml</span></span><br><span class="line"><span class="meta">@@ -50,7 +50,7 @@</span> cdn:</span><br><span class="line">   # 以下配置可以覆盖 cdn.prefix,配置项的值可以为空，但是要使用CDN必须依据路径填写配置项的键</span><br><span class="line">   set:</span><br><span class="line">     js:</span><br><span class="line"><span class="deletion">-      #app: /js/app.js</span></span><br><span class="line"><span class="addition">+      app: /js/app.js</span></span><br><span class="line">     css:</span><br><span class="line">       #style: /css/style.css # (异步加载样式)</span><br><span class="line"> # 静态资源版本控制</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-英文化不全的问题"><a href="#2-英文化不全的问题" class="headerlink" title="2. 英文化不全的问题"></a>2. 英文化不全的问题</h3><p>这些问题更简单，把需要显示板块的<code>title</code>替换成英文，然后找到页面底部不用的部分，去掉就行了。</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/_config.yml</span></span><br><span class="line"><span class="comment">+++ b/_config.yml</span></span><br><span class="line"><span class="meta">@@ -266,12 +266,12 @@</span> article:</span><br><span class="line">       # 文章创建日期</span><br><span class="line">       date:</span><br><span class="line">         icon: fa-solid fa-calendar-alt</span><br><span class="line"><span class="deletion">-        title: &#x27;发布于：&#x27;</span></span><br><span class="line"><span class="addition">+        title: &#x27;Published on: &#x27;</span></span><br><span class="line">         format: &#x27;ll&#x27; # 日期格式 http://momentjs.com/docs/</span><br><span class="line">       # 文章更新日期</span><br><span class="line">       updated:</span><br><span class="line">         icon: fa-solid fa-edit</span><br><span class="line"><span class="deletion">-        title: &#x27;更新于：&#x27;</span></span><br><span class="line"><span class="addition">+        title: &#x27;Updated on: &#x27;</span></span><br><span class="line">         format: &#x27;ll&#x27; # 日期格式 http://momentjs.com/docs/</span><br><span class="line">       # 文章分类</span><br><span class="line">       category:</span><br><span class="line"><span class="meta">@@ -279,15 +279,15 @@</span> article:</span><br><span class="line">       # 文章浏览计数</span><br><span class="line">       counter:</span><br><span class="line">         icon: fa-solid fa-eye</span><br><span class="line"><span class="deletion">-        unit: &#x27;次浏览&#x27;</span></span><br><span class="line"><span class="addition">+        unit: &#x27;views&#x27;</span></span><br><span class="line">       # waline 文章评论数量</span><br><span class="line">       walinecount:</span><br><span class="line">         icon: fa-solid fa-comment-dots</span><br><span class="line"><span class="deletion">-        desc: &#x27;条评论&#x27; # 条评论</span></span><br><span class="line"><span class="addition">+        desc: &#x27;comments&#x27; # 条评论</span></span><br><span class="line">       # artalk 文章评论数量</span><br><span class="line">       artalkcount:</span><br><span class="line">         icon: fa-solid fa-comment-dots</span><br><span class="line"><span class="deletion">-        desc: &#x27;条评论&#x27; # 条评论</span></span><br><span class="line"><span class="addition">+        desc: &#x27;comments&#x27; # 条评论</span></span><br><span class="line">       # 文章字数和阅读时长</span><br><span class="line">       wordcount:</span><br><span class="line">         icon_wordcount: fa-solid fa-keyboard</span><br><span class="line"><span class="meta">@@ -523,7 +523,7 @@</span> sidebar:</span><br><span class="line">       sticky: true</span><br><span class="line">       header:</span><br><span class="line">         icon: fa-solid fa-list</span><br><span class="line"><span class="deletion">-        title: 本文目录</span></span><br><span class="line"><span class="addition">+        title: TOC</span></span><br><span class="line">       list_number: false</span><br><span class="line">       min_depth: 2</span><br><span class="line">       max_depth: 5</span><br><span class="line"><span class="meta">@@ -540,7 +540,7 @@</span> sidebar:</span><br><span class="line">       display: [desktop] # [desktop, mobile]</span><br><span class="line">       header:</span><br><span class="line">         icon: fa-solid fa-folder-open</span><br><span class="line"><span class="deletion">-        title: 文章分类</span></span><br><span class="line"><span class="addition">+        title: Categories</span></span><br><span class="line">         url: /blog/categories/</span><br><span class="line">     # ---------------------------------------</span><br><span class="line">     # tagcloud widget</span><br><span class="line"><span class="meta">@@ -549,7 +549,7 @@</span> sidebar:</span><br><span class="line">       display: [desktop, mobile] # [desktop, mobile]</span><br><span class="line">       header:</span><br><span class="line">         icon: fa-solid fa-tags</span><br><span class="line"><span class="deletion">-        title: 热门标签</span></span><br><span class="line"><span class="addition">+        title: Tags</span></span><br><span class="line">         url: /blog/tags/</span><br><span class="line">       min_font: 14</span><br><span class="line">       max_font: 24</span><br><span class="line"><span class="meta">@@ -572,7 +572,7 @@</span> sidebar:</span><br><span class="line">       display: [desktop]</span><br><span class="line">       header:</span><br><span class="line">         icon: fa-solid fa-award</span><br><span class="line"><span class="deletion">-        title: 站点信息</span></span><br><span class="line"><span class="addition">+        title: Website ino</span></span><br><span class="line">       type:</span><br><span class="line">         article:</span><br><span class="line">           enable: true</span><br><span class="line"><span class="meta">@@ -608,7 +608,7 @@</span> sidebar:</span><br><span class="line">       display: [desktop, mobile]</span><br><span class="line">       header:</span><br><span class="line">         icon: fa-solid fa-clock WISTERIA</span><br><span class="line"><span class="deletion">-        title: 最近更新</span></span><br><span class="line"><span class="addition">+        title: Laste Update</span></span><br><span class="line"> ############################### Sidebar ############################### &gt; end</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@@ -647,8 +647,6 @@</span> site_footer:</span><br><span class="line">   source: https://github.com/volantis-x/volantis-docs/</span><br><span class="line">   # analytics using leancloud</span><br><span class="line">   analytics: &gt;</span><br><span class="line"><span class="deletion">-    &lt;span id=&quot;lc-sv&quot;&gt;本站总访问量为 &lt;span id=&#x27;number&#x27;&gt;&lt;i class=&quot;fa-solid fa-loader fa-spin fa-fw&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;&lt;/span&gt; 次&lt;/span&gt;</span></span><br><span class="line"><span class="deletion">-    &lt;span id=&quot;lc-uv&quot;&gt;访客数为 &lt;span id=&#x27;number&#x27;&gt;&lt;i class=&quot;fa-solid fa-loader fa-spin fa-fw&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;&lt;/span&gt; 人&lt;/span&gt;</span></span><br><span class="line">   # site copyright</span><br><span class="line">   copyright: &#x27;[Copyright © since 2017 XXX](/)&#x27;</span><br><span class="line">   # You can add your own property here. (Support markdown, for example: br: &#x27;&lt;br&gt;&#x27;)</span><br></pre></td></tr></table></figure><h3 id="3-补丁生成"><a href="#3-补丁生成" class="headerlink" title="3. 补丁生成"></a>3. 补丁生成</h3><p>将上面修改保存后，<code>git commit</code>，然后就可以使用<code>git diff COMMIT1 COMMIT2 &gt; PATCH_FILE</code>生成补丁。</p><p>由于我是克隆<code>volantis</code>原项目代码然后修改生成补丁，补丁文件中文件的路径是不对的，需要修改补丁文件中下面的路径为实际的文件路径。</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/_config.yml</span></span><br><span class="line"><span class="comment">+++ b/_config.yml</span></span><br></pre></td></tr></table></figure><p>另外上方的<code>index 91bd9709..9304175e 100644</code>需要去掉，否则会因为commit核验补上而失败。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>今年二季度以来，因为部门逐渐只剩我一个人，公司所有需要自己维护的网站和系统都跑我手上了… 如果没有AI救我狗命，我断然是无法一边做着分析，一边还要维护这么些的前后端的，现在也不可能有那么点常识后，自己修博客的小Bug… 但就跟去年用AI的感受一样，我的上限决定AI的上限，我们有办法判断拿到方案对错的时候，就只能像追自己尾巴的小狗狗一样，原地转圈圈了…</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> Volantis </tag>
            
            <tag> 博客 </tag>
            
            <tag> 国际化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>只成功了一半----利用pixi在FydeOS编译运行podman</title>
      <link href="/2025/11/11/%E5%8F%AA%E6%88%90%E5%8A%9F%E4%BA%86%E4%B8%80%E5%8D%8A-%E5%88%A9%E7%94%A8pixi%E5%9C%A8FydeOS%E7%BC%96%E8%AF%91%E8%BF%90%E8%A1%8Cpodman/"/>
      <url>/2025/11/11/%E5%8F%AA%E6%88%90%E5%8A%9F%E4%BA%86%E4%B8%80%E5%8D%8A-%E5%88%A9%E7%94%A8pixi%E5%9C%A8FydeOS%E7%BC%96%E8%AF%91%E8%BF%90%E8%A1%8Cpodman/</url>
      
        <content type="html"><![CDATA[<p>最近在FydeOS上尝试使用pixi来编译和运行podman，虽然取得了一些进展，但最终只成功了一半。在这篇博客中，我将分享整个过程以及遇到的问题。</p><span id="more"></span><h2 id="背景与动机"><a href="#背景与动机" class="headerlink" title="背景与动机"></a>背景与动机</h2><p>我使用Fydetab Duo进行本地开发，希望通过devpod来提高开发效率。然而，FydeOS自带的Linux环境存在稳定性问题：设备从休眠状态唤醒后，经常无法通过网络访问Linux环境，这严重影响了开发工作流程。</p><p>作为替代方案，我考虑在虚拟机外运行podman来管理开发环境。这样即使Linux环境不可用，也能通过podman维持开发环境的运行。但是，conda-forge提供的podman包没有ARM64架构版本，无法直接在Fydetab Duo（基于ARM架构）上使用。</p><p>因此，我决定克隆conda-forge的podman包构建代码，使用pixi环境管理工具自行编译ARM64版本的podman。Pixi是一个跨平台的包管理器和环境管理器，能够帮助管理复杂的编译依赖关系。</p><h2 id="环境配置与编译过程"><a href="#环境配置与编译过程" class="headerlink" title="环境配置与编译过程"></a>环境配置与编译过程</h2><p>首先，我克隆了conda-forge的podman包构建代码，并创建了一个pixi项目来管理编译环境。配置<code>pixi.toml</code>文件如下：</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Sylens &lt;qiumin14@163.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>, <span class="string">&quot;file:///usr/local/share/project/podman/.pixi/envs/default/conda-bld&quot;</span>]</span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;podman&quot;</span></span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-aarch64&quot;</span>]</span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tasks]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[system-requirements]</span></span><br><span class="line"><span class="attr">libc</span>   = &#123; family = <span class="string">&quot;glibc&quot;</span>, version = <span class="string">&quot;2.39&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">boa</span> = <span class="string">&quot;&gt;=0.17.0,&lt;0.18&quot;</span></span><br><span class="line"><span class="attr">mamba</span> = <span class="string">&quot;&gt;=1.5.12,&lt;2&quot;</span></span><br><span class="line"><span class="attr">conda-build</span> = <span class="string">&quot;&gt;=24.5.1,&lt;25&quot;</span></span><br><span class="line"><span class="attr">diffutils</span> = <span class="string">&quot;&gt;=3.12,&lt;4&quot;</span></span><br><span class="line"><span class="attr">podman</span> = <span class="string">&quot;&gt;=5.6.2,&lt;6&quot;</span></span><br><span class="line"><span class="attr">libcap</span> = <span class="string">&quot;&gt;=2.76,&lt;3&quot;</span></span><br></pre></td></tr></table></figure><p>这个配置指定了项目依赖和系统要求，特别是针对ARM64架构（linux-aarch64）和glibc 2.39版本。<code>[system-requirements]</code>部分的版本指定，其实是Pixi的一种虚拟包指定机制，用于在计算依赖时，告诉依赖计算器当前系统的系统库版本（万物依赖libc）。而<code>channels</code>中指定了一个本地的路径，因为<code>podman</code>还有一个必要依赖<code>netavark</code>也没有Arm64版本，需要先行编译形成本地Conda包后，才能开始编译<code>podman</code>。</p><h2 id="编译解决方案"><a href="#编译解决方案" class="headerlink" title="编译解决方案"></a>编译解决方案</h2><p>两个软件的conda包构建代码分别在<code>https://github.com/conda-forge/netavark-feedstock</code>和<code>https://github.com/conda-forge/podman-feedstock</code>，克隆下来后依次编译。在编译<code>netavark</code>和<code>podman</code>时，都会有依赖问题，我们需要修改他们的<code>recipe/conda_build_config.yaml</code>文件，具体差异别见下，其实就是指定使用sysroot作为C标准库。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">index d402d1d..7dbfd74 100644</span><br><span class="line">--- a/recipe/conda_build_config.yaml</span><br><span class="line">+++ b/recipe/conda_build_config.yaml</span><br><span class="line">@@ -1,2 +1,5 @@</span><br><span class="line">+c_stdlib:</span><br><span class="line">+  - sysroot</span><br><span class="line">+</span><br><span class="line"> c_stdlib_version:  # [linux64]</span><br><span class="line">   - 2.17           # [linux64]</span><br></pre></td></tr></table></figure><p>编译成功后，就可以使用<code>pixi add</code>添加podman到环境，就有podman命令行了</p><h2 id="运行失败的核心问题"><a href="#运行失败的核心问题" class="headerlink" title="运行失败的核心问题"></a>运行失败的核心问题</h2><p>事情到这都还挺顺利的，然而如果运行<code>podman pull alpine</code>，会提示没有<code>newgidmap</code>程序和<code>newuidmap</code>。他们是用来做用户和组编号映射的。这难不倒常年借东墙补西墙的我，Linux虚拟机内复制一个出来就行。然而，在有这两个程序后，依然会看到下面的错误：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">newuidmap: Could not set caps</span><br><span class="line">cannot set up namespace using &quot;/usr/bin/newuidmap&quot;: should have setuid or have filecaps setuid</span><br></pre></td></tr></table></figure><p>到此位置，遇到了本次无法克服的障碍，<strong>FydeOS&#x2F;Chromeos的从设计上，就不允许用户命名空间中的UID&#x2F;GID映射</strong>。</p><p>我尝试根据AI提示，通过<code>sudo chmod u+s</code>为<code>newuidmap</code>和<code>newgidmap</code>设置了setuid位，系统仍然拒绝执行。内核日志显示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SafeSetID: Operation requires CAP_SETUID, which is not available to UID 1000 for operations besides approved set*uid transitions</span><br></pre></td></tr></table></figure><p>以下是AI给我的回答：</p><blockquote><p>1.SafeSetID 是 ChromeOS 特有的安全机制（LSM&#x2F;内核补丁），用于 限制 setuid &#x2F; UID 映射<br>2.CAP_SETUID 不可用 → 即使 newuidmap 有 setuid 或 setcap，普通用户（UID 1000）也无法在 rootless Podman 中修改 UID 映射<br>3.其他日志都是正常 remount 或 USB 设备信息，与 rootless Podman 无关</p></blockquote><p>由于我没有足够的知识来判断它说的真假，所以我只能进Linux虚拟机以一样的方式编译Podman试了试，实测，虚拟机内的Podman是能正常运行的，这至少说明，宿主机部分确实有特别的限制。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这次尝试证明使用pixi在FydeOS上管理podman依赖是可行的，编译过程也能成功完成。但由于FydeOS深层的内核安全限制（特别是SafeSetID模块），运行时环境无法满足podman对用户命名空间的要求，因此只能算”成功了一半”。</p><p>所以，如果要实现我的目标，我只能自行去编译Openfyde镜像，直接在编译的时候修改内核的部分，并且直接加入podman了。</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FydeOS </tag>
            
            <tag> pixi </tag>
            
            <tag> podman </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>修复pixi部署部分bioconda_r包后出现的缺依赖问题</title>
      <link href="/2025/10/29/%E4%BF%AE%E5%A4%8Dpixi%E9%83%A8%E7%BD%B2%E9%83%A8%E5%88%86bioconda-r%E5%8C%85%E5%90%8E%E5%87%BA%E7%8E%B0%E7%9A%84%E7%BC%BA%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98/"/>
      <url>/2025/10/29/%E4%BF%AE%E5%A4%8Dpixi%E9%83%A8%E7%BD%B2%E9%83%A8%E5%88%86bioconda-r%E5%8C%85%E5%90%8E%E5%87%BA%E7%8E%B0%E7%9A%84%E7%BC%BA%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>在使用pixi管理生物信息学分析环境时，经常会遇到一些Bioconductor的R包安装后出现依赖缺失的问题。目前暂不清楚这个问题的原因，用了pixi一年了，这个问题到目前为止（2025.10）也木有修复，因此本文介绍如何通过pixi tasks功能来解决这类问题。</p><span id="more"></span><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在最近一年的pixi使用中，发现部署生物信息学分析环境时，<code>Seurat</code>和<code>maftools</code>这样的依赖<code>GenomeInfoDbData</code>、<code>BSgenome.Hsapiens.UCSC.hg38</code>获取基因组数据R包的依赖总是有问题，即使在依赖处显式的指定并安装这些包到pixi环境中，实际载入的时候还是会显示这些包并不存在，因此还需要配置额外的内容来补充这些依赖。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>我目前是通过pixi的tasks功能，将安装依赖的命令变成一个任务，以在部署环境后快速修复依赖问题，实际的配置文件示例如下：</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;azimuth_demo&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;1.1&quot;</span></span><br><span class="line"><span class="attr">description</span> = <span class="string">&quot;workspace with azimuth and jupyter&quot;</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Sylens Wong &lt;qiumin14@163.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>, <span class="string">&quot;bioconda&quot;</span>]</span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-64&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[environments]</span></span><br><span class="line"><span class="attr">label</span> = [<span class="string">&#x27;kernel&#x27;</span>, <span class="string">&#x27;label&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[feature.kernel.dependencies]</span></span><br><span class="line"><span class="attr">r-irkernel</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">jupyterlab</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.label.dependencies]</span></span><br><span class="line"><span class="attr">r-base</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">r-azimuth</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">r-BiocManager</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.label.tasks]</span></span><br><span class="line"><span class="attr">GenomeInfoDbData</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;GenomeInfoDbData\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">BSgenome</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;BSgenome.Hsapiens.UCSC.hg38\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">EnsDb</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;EnsDb.Hsapiens.v86\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">JASPAR2020</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;JASPAR2020\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">r_dep</span> = &#123;cmd = <span class="string">&#x27;echo &quot;bio dep for R done&quot;&#x27;</span>, depends-<span class="literal">on</span>=[<span class="string">&#x27;GenomeInfoDbData&#x27;</span>, <span class="string">&#x27;BSgenome&#x27;</span>, <span class="string">&#x27;EnsDb&#x27;</span>, <span class="string">&#x27;JASPAR2020&#x27;</span>]&#125;</span><br></pre></td></tr></table></figure><p>激活pixi环境后，执行<code>pixi run r_dep</code>就可以完成依赖修复，然后开始工作了。</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R </tag>
            
            <tag> 依赖管理 </tag>
            
            <tag> Bioconductor </tag>
            
            <tag> pixi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决scanpy读写loom文件格式丢失obs和var的index的问题</title>
      <link href="/2025/10/28/%E8%A7%A3%E5%86%B3scanpy%E8%AF%BB%E5%86%99loom%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E4%B8%A2%E5%A4%B1obs%E5%92%8Cvar%E7%9A%84index%E7%9A%84%E9%97%AE%E9%A2%98/"/>
      <url>/2025/10/28/%E8%A7%A3%E5%86%B3scanpy%E8%AF%BB%E5%86%99loom%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E4%B8%A2%E5%A4%B1obs%E5%92%8Cvar%E7%9A%84index%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>在我们现在基于scanp的单细胞流程中，有一步需要将AnnData对象保存为loom格式。但是与保存为h5ad不同，当我们不做任何处理，将AnnData对象写入loom文件后再次读取时，会发现<code>obs</code>和<code>var</code>的索引（index）信息丢失了，这些索引（通常是细胞条形码和基因名）变成了普通的数字编号。</p><span id="more"></span><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>根据实际的测试和<a href="https://anndata.readthedocs.io/en/latest/generated/anndata.AnnData.write_loom.html">write_loom方法的文档</a>，中的描述，可以推测实际的读写，<code>write_loom</code> 写入时，实际上的不会写入obs和var两个表中的index部分，即使通过参数指定<code>write_obsm_varm=True</code>，写入时也只会按照固定的名称分别产生两个新列（obs_names和var_names）。</p><p>而根据<a href="https://scanpy.readthedocs.io/en/stable/generated/scanpy.read_loom.html">read_loom方法的文档</a>，<code>read_loom</code>在读取的时候，实际上要在obs中找名为<code>CellID</code>的列，在var中找名为<code>Gene</code>的列来分别作为两张表的编号。</p><p>这样一来一去，默认不存index，即使存了index，<code>write_loom</code>存的和<code>read_loom</code>读的也并不一致，就像两个部门对接没有做好，关键信息就这么没了…</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>我的目的是尽可能不对原流程代码进行变更，因此直接产生原流程可读的loom文件是最好的方式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存索引信息到obs和var的列中</span></span><br><span class="line">adata.obs[<span class="string">&#x27;CellID&#x27;</span>] = adata.obs.index.tolist()</span><br><span class="line">adata.var[<span class="string">&#x27;Gene&#x27;</span>] = adata.var.index.tolist()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入loom文件（包含obsm和varm信息）</span></span><br><span class="line">merge_adata.write_loom(<span class="string">&#x27;/path/to/raw.loom&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取loom文件，由于CellID和Gene存在，</span></span><br><span class="line"><span class="comment"># 读取的adata能成功保留两个表的index信息</span></span><br><span class="line">adata = sc.read_loom(<span class="string">&#x27;/path/to/raw.loom&#x27;</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> scanpy </tag>
            
            <tag> loom </tag>
            
            <tag> adata </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在R和Python下运行milo的对比</title>
      <link href="/2025/10/28/%E5%9C%A8R%E5%92%8CPython%E4%B8%8B%E8%BF%90%E8%A1%8Cmilo%E7%9A%84%E5%AF%B9%E6%AF%94/"/>
      <url>/2025/10/28/%E5%9C%A8R%E5%92%8CPython%E4%B8%8B%E8%BF%90%E8%A1%8Cmilo%E7%9A%84%E5%AF%B9%E6%AF%94/</url>
      
        <content type="html"><![CDATA[<p>Milo是一种用于单细胞RNA测序数据的差异丰度分析方法，能够检测不同条件下细胞邻域的组成变化。</p><span id="more"></span><h2 id="milo算法简介"><a href="#milo算法简介" class="headerlink" title="milo算法简介"></a>milo算法简介</h2><p><a href="https://www.nature.com/articles/s41587-021-01033-z">milo</a>是一种专门为单细胞RNA测序数据设计的差异丰度分析方法。其核心思想是通过构建细胞邻域（neighborhoods）来检测不同实验条件下细胞群体组成的变化。</p><p>个人理解这个算法的设计目的是在不预先定义的情况下，找出两种情况下有群体比例差异的细胞，有了检测结果后，可以将这些有差异的细胞单独提出来进行进一步的分析。</p><h2 id="R环境下的miloR实现"><a href="#R环境下的miloR实现" class="headerlink" title="R环境下的miloR实现"></a>R环境下的miloR实现</h2><p>R语言中使用miloR包进行分析，以下是相应的实现：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载所需库</span></span><br><span class="line">library<span class="punctuation">(</span>Seurat<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>miloR<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>SingleCellExperiment<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>scater<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyr<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取Seurat对象并转换为SingleCellExperiment</span></span><br><span class="line">seurat_obj <span class="operator">&lt;-</span> readRDS<span class="punctuation">(</span><span class="string">&quot;seurat.rds&quot;</span><span class="punctuation">)</span></span><br><span class="line">sce <span class="operator">&lt;-</span> as.SingleCellExperiment<span class="punctuation">(</span>seurat_obj<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置随机种子保证结果可重复，本方法中主要是kNN部分有随机成分</span></span><br><span class="line">set.seed<span class="punctuation">(</span><span class="number">4466</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Milo对象</span></span><br><span class="line">milo_obj <span class="operator">&lt;-</span> Milo<span class="punctuation">(</span>sce<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建领接结构，注意合理的k是kNN中的k</span></span><br><span class="line"><span class="comment"># 而d是dimension，即需要使用多少个降维维度/成分</span></span><br><span class="line">milo_obj <span class="operator">&lt;-</span> buildGraph<span class="punctuation">(</span></span><br><span class="line">    milo_obj<span class="punctuation">,</span></span><br><span class="line">    k <span class="operator">=</span> <span class="number">30</span><span class="punctuation">,</span> d <span class="operator">=</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">    transposed <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> </span><br><span class="line">    reduced.dim <span class="operator">=</span> <span class="string">&quot;UMAP&quot;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义邻域，注意这里的k和d以及reduced_dims都要跟前一步一致</span></span><br><span class="line"><span class="comment"># 这里的refinement_scheme是为了配合后续使用一种快速算法</span></span><br><span class="line"><span class="comment"># 在数据集中细胞非常多时，有明显的计算加速作用</span></span><br><span class="line">milo_obj <span class="operator">&lt;-</span> makeNhoods<span class="punctuation">(</span></span><br><span class="line">    x <span class="operator">=</span> milo_obj<span class="punctuation">,</span></span><br><span class="line">    prop <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span> k <span class="operator">=</span> <span class="number">30</span><span class="punctuation">,</span> d <span class="operator">=</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">    refined <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">    reduced_dims <span class="operator">=</span> <span class="string">&quot;UMAP&quot;</span><span class="punctuation">,</span></span><br><span class="line">    refinement_scheme <span class="operator">=</span> <span class="string">&quot;graph&quot;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计数邻域中的细胞</span></span><br><span class="line">milo_obj <span class="operator">&lt;-</span> countCells<span class="punctuation">(</span></span><br><span class="line">    milo_obj<span class="punctuation">,</span></span><br><span class="line">    meta.data <span class="operator">=</span> data.frame<span class="punctuation">(</span>colData<span class="punctuation">(</span>milo_obj<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    sample <span class="operator">=</span> <span class="string">&quot;sample_id&quot;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备实验设计，其实就是构建一个有样品编号和分组tag的数据框</span></span><br><span class="line">traj_design <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>colData<span class="punctuation">(</span>milo_obj<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;sample_id&quot;</span><span class="punctuation">,</span> <span class="string">&quot;group&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">%&gt;%</span></span><br><span class="line">    distinct<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">    mutate<span class="punctuation">(</span></span><br><span class="line">        sample_id <span class="operator">=</span> <span class="built_in">as.character</span><span class="punctuation">(</span>sample_id<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        group <span class="operator">=</span> <span class="built_in">as.character</span><span class="punctuation">(</span>group<span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>traj_design<span class="punctuation">)</span> <span class="operator">&lt;-</span> traj_design<span class="operator">$</span>sample_id</span><br><span class="line">traj_design <span class="operator">&lt;-</span> traj_design<span class="punctuation">[</span>colnames<span class="punctuation">(</span>nhoodCounts<span class="punctuation">(</span>milo_obj<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">,</span> drop<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 差异丰度检验，这里的fdr.weighting = &quot;graph-overlap&quot;</span></span><br><span class="line"><span class="comment"># 配合前面makeNhoods中的参数，提高计算速度</span></span><br><span class="line"><span class="comment"># 注意这里可以进行比较组的指定，指定的方式比较特殊，是用类公式的语法进行指定</span></span><br><span class="line"><span class="comment"># design = ~ 0 + group 代表使用group变量进行分组，前面的 0 + 是固定写法</span></span><br><span class="line"><span class="comment"># model.contrasts = c(&#x27;groupCase - groupControl&#x27;) 的意义是</span></span><br><span class="line"><span class="comment"># 使用 group 列等于 Case 的行作为目标，等于 Control的行作为对照</span></span><br><span class="line">da_results <span class="operator">&lt;-</span> testNhoods<span class="punctuation">(</span></span><br><span class="line">    milo_obj<span class="punctuation">,</span></span><br><span class="line">    design <span class="operator">=</span> <span class="operator">~</span> <span class="number">0</span> <span class="operator">+</span> group<span class="punctuation">,</span></span><br><span class="line">    model.contrasts <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;groupCase - groupControl&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    design.df <span class="operator">=</span> traj_design<span class="punctuation">,</span></span><br><span class="line">    fdr.weighting <span class="operator">=</span> <span class="string">&quot;graph-overlap&quot;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看显著结果</span></span><br><span class="line">da_results <span class="operator">%&gt;%</span></span><br><span class="line">  arrange<span class="punctuation">(</span>SpatialFDR<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  filter<span class="punctuation">(</span>SpatialFDR <span class="operator">&lt;</span> <span class="number">0.1</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">  tail<span class="punctuation">(</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建邻域图</span></span><br><span class="line">milo_obj <span class="operator">&lt;-</span> buildNhoodGraph<span class="punctuation">(</span>milo_obj<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有计算步骤完成</span></span><br><span class="line"><span class="comment"># 后续可使用plotUMAP或其他函数进行可视化展示</span></span><br></pre></td></tr></table></figure><h2 id="Python环境下的Milo实现"><a href="#Python环境下的Milo实现" class="headerlink" title="Python环境下的Milo实现"></a>Python环境下的Milo实现</h2><p>Python中有多个milo实现，除了官方<a href="https://github.com/MarioniLab/miloR">miloR项目</a>中提到的<a href="https://github.com/emdann/milopy">Mipopy</a>，<a href="https://github.com/scverse/pertpy">pertpy</a>库也实现Milo的算法，以下是用pertpy完成计算的例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pertpy <span class="keyword">as</span> pt</span><br><span class="line"><span class="keyword">import</span> scanpy <span class="keyword">as</span> sc</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取数据</span></span><br><span class="line">adata = sc.read_h5ad(<span class="string">&#x27;adata.h5ad&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化Milo分析对象</span></span><br><span class="line">milo = pt.tl.Milo()</span><br><span class="line">mdata = milo.load(adata)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建邻居图</span></span><br><span class="line">sc.pp.neighbors(</span><br><span class="line">    mdata[<span class="string">&quot;rna&quot;</span>],</span><br><span class="line">    use_rep=<span class="string">&quot;X_umap&quot;</span>, <span class="comment"># 利用已有umap降维信息</span></span><br><span class="line">    n_pcs=<span class="number">20</span>,         <span class="comment"># 主成分数，对应miloR的d参数</span></span><br><span class="line">    n_neighbors=<span class="number">30</span>,   <span class="comment"># 邻居数，对应miloR的k参数</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建邻域</span></span><br><span class="line">milo.make_nhoods(mdata[<span class="string">&quot;rna&quot;</span>], prop=<span class="number">0.1</span>)</span><br><span class="line">mdata = milo.count_nhoods(mdata, sample_col=<span class="string">&quot;sample_id&quot;</span>)</span><br><span class="line"><span class="comment"># 这里指定Case Control的方式比miloR更容易懂一些，不过顺序有些差异，这里Control在前</span></span><br><span class="line">mdata[<span class="string">&quot;rna&quot;</span>].obs[<span class="string">&quot;group&quot;</span>] = mdata[<span class="string">&quot;rna&quot;</span>].obs[<span class="string">&quot;group&quot;</span>].cat.reorder_categories([<span class="string">&quot;Control&quot;</span>, <span class="string">&quot;Case&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 差异丰度分析（使用pydeseq2求解器）</span></span><br><span class="line">milo.da_nhoods(mdata, design=<span class="string">&quot;~group&quot;</span>, solver=<span class="string">&quot;pydeseq2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建邻域图，用于可视化</span></span><br><span class="line">milo.build_nhood_graph(mdata)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 筛选显著结果</span></span><br><span class="line">significant_results = mdata[<span class="string">&#x27;milo&#x27;</span>].var.query(<span class="string">&#x27;SpatialFDR &lt; 0.1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 完成所有计算</span></span><br></pre></td></tr></table></figure><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>实际运行的性能上，两者差距木有太大，但是计算结果上还是又差的，毕竟py版本是算法实现，而不是一点点复现。具体的计算一致性几何，后续我从cellxgene上找个数据集再来实际算算好了。</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生物信息学 </tag>
            
            <tag> 单细胞分析 </tag>
            
            <tag> 差异丰度分析 </tag>
            
            <tag> Milo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 DevPod 设置自部署的 Codespace</title>
      <link href="/2025/10/28/%E4%BD%BF%E7%94%A8devpod%E8%AE%BE%E7%BD%AE%E8%87%AA%E9%83%A8%E7%BD%B2%E7%9A%84codespace/"/>
      <url>/2025/10/28/%E4%BD%BF%E7%94%A8devpod%E8%AE%BE%E7%BD%AE%E8%87%AA%E9%83%A8%E7%BD%B2%E7%9A%84codespace/</url>
      
        <content type="html"><![CDATA[<p>DevPod 是一个开源的开发环境管理工具，可以让你在任何 Kubernetes 集群或 Docker 主机上创建类似 GitHub Codespaces 的开发环境。本文将介绍如何使用 DevPod CLI 创建工作区，并详细解析 DevContainer 配置文件的编写。</p><span id="more"></span><h2 id="DevPod-介绍"><a href="#DevPod-介绍" class="headerlink" title="DevPod 介绍"></a>DevPod 介绍</h2><p>DevPod 是由 Loft Labs 开发的开源工具，它允许开发者在任何基础设施上创建可重复、一次性的开发环境。与 GitHub Codespaces 类似，但 DevPod 是可以自托管的，可以在任何在本地机器、支持的云服务器商或 Kubernetes 集群上运行。</p><p>主要特性包括：</p><ul><li>支持多种后端（Docker、Kubernetes、AWS EC2 等）</li><li>基于 DevContainer 标准</li><li>开发环境即代码</li><li>快速启动和销毁环境</li></ul><h2 id="DevPod-Provider-和工作区创建"><a href="#DevPod-Provider-和工作区创建" class="headerlink" title="DevPod Provider 和工作区创建"></a>DevPod Provider 和工作区创建</h2><h3 id="安装-DevPod"><a href="#安装-DevPod" class="headerlink" title="安装 DevPod"></a>安装 DevPod</h3><p>Devpod 提供桌面版本，但是我现在是要在 FydeOS 上运行，所以安装 DevPod CLI。比较友好的是 Devpod CLI 几乎没有外部依赖，甚至SSH都有内建的，因此使用官方的命令就能安装到 FydeOS 的原生命令行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://raw.githubusercontent.com/loft-sh/devpod/master/scripts/install.sh | sh</span><br></pre></td></tr></table></figure><h3 id="配置-Provider"><a href="#配置-Provider" class="headerlink" title="配置 Provider"></a>配置 Provider</h3><p>Provider 是 DevPod 的后端驱动，定义了开发环境的运行位置。以 SSH 为例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">devpod provider add ssh --name amd -o HOST=AMD</span><br></pre></td></tr></table></figure><p>上面的添加方式基于已有的 ssh 配置，对应 <code>~/.ssh/config</code> 中的内容是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Host AMD</span><br><span class="line">  HostName 192.168.0.2</span><br><span class="line">  Port 22</span><br><span class="line">  User user</span><br><span class="line">  IdentityFile /home/user/.ssh/AMD_Key</span><br></pre></td></tr></table></figure><p>另须注意，DevPod 是基于容器技术的工具，因此 SSH 的目标机器需要已经安装好 docker 或者 podman。</p><p>另外，使用 Ubuntu 的话，还要额外注意 docker 软件的来源，因为 Ubuntu 下可以通过 Snap 安装 docker，这个版本的 docker 因为 Snap 的限制，是不能访问用户 Home 目录下的隐藏文件夹的（<code>.</code>开头的那些），导致 Devpod 调用 docker 执行任何构建命令都会失败。</p><h3 id="创建工作区"><a href="#创建工作区" class="headerlink" title="创建工作区"></a>创建工作区</h3><p>指定 provider 和项目路径即可启动工作区，Devpod会根据配置文件创建必要的工作环境，更重要的是，Devpod 会自动在工作区安装 web 版的 openvscode，启动该服务后，将服务的端口自动转发到本地，然后就可以快乐的写代码了，真正实现了项目介绍中说的，开发环境即配置的目标。同时，这些配置只需要服务器开 SSH 端口即可使用，可以说，真的相当方便。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">devpod up --provider amd --<span class="built_in">source</span> git https://github.com/your-username/your-repo</span><br></pre></td></tr></table></figure><p>这将基于仓库中的 <code>.devcontainer</code> 文件夹下的配置文件创建开发环境。</p><h2 id="DevContainer-格式介绍"><a href="#DevContainer-格式介绍" class="headerlink" title="DevContainer 格式介绍"></a>DevContainer 格式介绍</h2><p>DevContainer 是开发环境配置的标准格式，本次示例中包含两个主要文件：<code>devcontainer.json</code> 和 <code>Dockerfile</code>。</p><h3 id="Dockerfile-配置"><a href="#Dockerfile-配置" class="headerlink" title="Dockerfile 配置"></a>Dockerfile 配置</h3><p>Dockerfile 其实就是 docker build 时使用的配置文件，DevPod会利用这个文件来创建工作区的容器。</p><p>需要注意的是，配置构建容器最好基于 mcr.microsoft.com&#x2F;devcontainers 下的容器来构建，因为这些容器是根据一定的要求构建而成的，DevPod 的一些功能依赖容器内的文件和配置，如果使用其他容器，启动工作区会需要自行处理一些兼容性问题。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 ms 官方基础镜像，含有vscode用户，避免devpod启动时有问题</span></span><br><span class="line"><span class="keyword">FROM</span> mcr.microsoft.com/devcontainers/base:bookworm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为vscode安装pixi</span></span><br><span class="line"><span class="keyword">USER</span> vscode</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装pixi，因为我的项目都用它管理依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -fsSL https://pixi.sh/install.sh | sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 git 用户信息，同时向环境注入我需要的alias内容</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git config --global user.name <span class="string">&quot;Sylens&quot;</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">  git config --global user.email <span class="string">&quot;qiumin14@163.com&quot;</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">  <span class="built_in">echo</span> <span class="string">&#x27;alias aider=&quot;aider --no-check-update --no-show-model-warnings --yes --no-auto-commits --model deepseek/deepseek-reasoner&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PATH=<span class="string">&quot;/home/vscode/.pixi/bin:$&#123;PATH&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>另外还需要注意的一点是，DevPod的运行逻辑是先构建容器，然后再根据 <code>devcontainer.json</code> 进行项目代码挂载和进一步配置，所以一切依赖项目代码的设置都是无法在容器构建阶段进行的。</p><h3 id="devcontainer-json-配置"><a href="#devcontainer-json-配置" class="headerlink" title="devcontainer.json 配置"></a>devcontainer.json 配置</h3><p><code>devcontainer.json</code> 定义了开发容器的元数据和 IDE 配置，我这里是个最基本的配置，只设置了一些环境变量以及最低限度的插件情况。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;silen_blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;dockerfile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Dockerfile&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;postCreateCommand&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pixi run deploy&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;containerEnv&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;AIDER_DARK_MODE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;localEnv:AIDER_DARK_MODE&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AIDER_CODE_THEME&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;localEnv:AIDER_CODE_THEME&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;DEEPSEEK_API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;localEnv:DEEPSEEK_API_KEY&#125;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;customizations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;vscode&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;workbench.colorTheme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Solarized Dark&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;extensions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;naumovs.color-highlight&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;ms-ceintl.vscode-language-pack-zh-hans&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;tamasfe.even-better-toml&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>须注意，<code>postCreateCommand</code> 只能写一项，如果需要执行的内容过多，建议写成shell脚本，放在 <code>.devcontainer</code> 目录然后用 <code>postCreateCommand</code> 调用。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>早在去年写 <a href="https://github.com/SilenWang/ReviewGPT">ReviewGPT</a> 的时候，我就体会到，想法人人有，做出来最重要。</p><p>我本来是在改写ChromeOS下的终端App，希望为它加入端口转发，和在目标机器上自动安装 vscode web 并自动转发端口到本地的功能。然后做着做着，发现google 早就废弃 pNaCl 了（如此一来原生的 App 并不能访问本地端口了），于是想用 Golang 开发一个满足我要求的引用，继续做着做着，发现了 DevPod，除了它是基于容器的… 已经非常接近我的需求了… 害，那我还写啥呢… 先学 Devpod 怎么用吧…</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> DevPod </tag>
            
            <tag> DevOps </tag>
            
            <tag> 开发环境 </tag>
            
            <tag> Podman </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TypeScript和JavaScript中的调试技巧</title>
      <link href="/2025/10/13/TS-JS%E4%B8%AD%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/"/>
      <url>/2025/10/13/TS-JS%E4%B8%AD%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<p>正如我同学所说，我现在有一点”被迫转码”的趋势… 目前维护的几个网站都有各自的前端、后端数据库，部分还有测试代码和迁移代码，涉及语言从生物信息学常用的Python到之前几乎不用的JS、TS、HTML、C#等。实际工作中，不可能有太多时间从头系统学习每门语言，因此掌握最基本的调试方法至关重要。其中JavaScript和TypeScript的调试方式，我觉得特别值得记录，因为它们与其他语言相比确实有些独特之处。</p><span id="more"></span><h2 id="Web前端框架中的调试环境"><a href="#Web前端框架中的调试环境" class="headerlink" title="Web前端框架中的调试环境"></a>Web前端框架中的调试环境</h2><p>与其说是纯JS&#x2F;TS调试，不如说是Web前端框架环境下的调试更为准确。现代前端框架（如Vue、React、Angular）与传统的HTML文件结构既有相似之处，也有明显差异。这些框架本质上是通过各种编译和构建工具，将模板、脚本和样式代码转换为最终的网页代码，再由浏览器渲染显示。</p><p>这种混合编程的模式类似于Snakemake的工作流文件，单个文件中可能包含多种语言元素。在实际开发中，我们主要需要调试的是模板部分（HTML-like）和脚本部分（JavaScript&#x2F;TypeScript）。</p><h2 id="模板部分的调试技巧"><a href="#模板部分的调试技巧" class="headerlink" title="模板部分的调试技巧"></a>模板部分的调试技巧</h2><h3 id="1-直接显示变量值"><a href="#1-直接显示变量值" class="headerlink" title="1. 直接显示变量值"></a>1. 直接显示变量值</h3><p>在Vue模板中，可以使用双花括号语法直接显示变量：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;&#123;&#123; value &#125;&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure><p>在React中，则使用单花括号：</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;&#123;value&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure><h3 id="2-条件性调试显示"><a href="#2-条件性调试显示" class="headerlink" title="2. 条件性调试显示"></a>2. 条件性调试显示</h3><p>有时我们只想在开发阶段显示调试信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p v-if=&quot;isDevelopment&quot;&gt;调试信息: &#123;&#123; debugValue &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;!-- 正常内容 --&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><h2 id="脚本部分的调试方法"><a href="#脚本部分的调试方法" class="headerlink" title="脚本部分的调试方法"></a>脚本部分的调试方法</h2><h3 id="1-基础console调试"><a href="#1-基础console调试" class="headerlink" title="1. 基础console调试"></a>1. 基础console调试</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;变量值:&#x27;</span>, variable);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">table</span>(arrayData); <span class="comment">// 以表格形式显示数组或对象</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">dir</span>(<span class="built_in">object</span>); <span class="comment">// 显示对象的属性</span></span><br></pre></td></tr></table></figure><h3 id="2-分组日志"><a href="#2-分组日志" class="headerlink" title="2. 分组日志"></a>2. 分组日志</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">group</span>(<span class="string">&#x27;用户信息&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;姓名:&#x27;</span>, user.<span class="property">name</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;邮箱:&#x27;</span>, user.<span class="property">email</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">groupEnd</span>();</span><br></pre></td></tr></table></figure><h3 id="3-条件断点和debugger"><a href="#3-条件断点和debugger" class="headerlink" title="3. 条件断点和debugger"></a>3. 条件断点和debugger</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (someCondition) &#123;</span><br><span class="line">  <span class="keyword">debugger</span>; <span class="comment">// 浏览器会在该行自动暂停</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 调试 </tag>
            
            <tag> Typescript </tag>
            
            <tag> Javascript </tag>
            
            <tag> 前端开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用uptime_kuma监控我维护的网站</title>
      <link href="/2025/10/09/%E4%BD%BF%E7%94%A8uptime-kuma%E7%9B%91%E6%8E%A7%E6%88%91%E7%BB%B4%E6%8A%A4%E7%9A%84%E7%BD%91%E7%AB%99/"/>
      <url>/2025/10/09/%E4%BD%BF%E7%94%A8uptime-kuma%E7%9B%91%E6%8E%A7%E6%88%91%E7%BB%B4%E6%8A%A4%E7%9A%84%E7%BD%91%E7%AB%99/</url>
      
        <content type="html"><![CDATA[<p>Uptime Kuma 是一个极其易用的开源监控工具，它让监控各种网络服务变得简单而高效。它支持多种协议监控，包括 HTTP(s)、TCP、Ping、DNS 查询等，甚至还能通过 Chrome 内核模式模拟真实用户访问，以更真实的监控服务是否稳定运行。此外，它还支持数十种异常通知方式，可以直接接入我们日常使用的各种应用。同时还提供了独特的 Push 监控方式，让用户能够通过自定义代码扩展监控功能（比如监控 SSH 服务是否可用）。</p><span id="more"></span><h2 id="Uptime-Kuma-简介"><a href="#Uptime-Kuma-简介" class="headerlink" title="Uptime Kuma 简介"></a>Uptime Kuma 简介</h2><p><a href="https://github.com/louislam/uptime-kuma">Uptime Kuma</a> 由 Louis Lam 开发的一个服务监控应用。这个项目的设计哲学就是简单易用，即使是没有技术背景的用户也能快速上手。</p><h2 id="安装-Uptime-Kuma"><a href="#安装-Uptime-Kuma" class="headerlink" title="安装 Uptime Kuma"></a>安装 Uptime Kuma</h2><p>最简单的方式是使用 Docker 安装，在iStoreOS的商店中有现成配置好的方案，直接安装后启动即可，项目默认跑在<code>3001</code>端口，如果同时使用了Gogs，会冲突，需要改下端口。</p><h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><h3 id="1-初始设置"><a href="#1-初始设置" class="headerlink" title="1. 初始设置"></a>1. 初始设置</h3><p>首次访问时需要设置管理员账号和密码，整个过程只需几分钟就能完成。</p><h3 id="2-添加监控项"><a href="#2-添加监控项" class="headerlink" title="2. 添加监控项"></a>2. 添加监控项</h3><p>点击 “添加监控项” 按钮，填写以下信息：</p><ul><li><strong>监控类型</strong>: 选择监控类型（如 HTTP、TCP、Ping 等）</li><li><strong>显示名称</strong>: 为监控项起一个易记的名称</li><li><strong>URL&#x2F;主机名</strong>: 要监控的网站地址或主机</li><li><strong>心跳间隔</strong>: 检查间隔（默认 60 秒）</li></ul><p>特别值得一提的是<strong>Chrome 内核监控模式</strong>：在 HTTP 监控的高级设置中，可以选择浏览器内核选项。这种模式会使用真实的 Chrome 浏览器内核来访问网站，能够执行 JavaScript 并检测页面加载是否真正完成，对于单页应用（SPA）和需要用户交互的网站特别有用。</p><h3 id="3-设置通知"><a href="#3-设置通知" class="headerlink" title="3. 设置通知"></a>3. 设置通知</h3><p>在 “设置通知” 按钮中可以添加各种通知方式。Uptime Kuma 支持数十种通知渠道，包括：</p><ul><li><strong>即时通讯</strong>：Telegram、Discord、Slack、Line、Mattermost 等</li><li><strong>邮件</strong>：SMTP 邮件通知</li><li><strong>移动推送</strong>：Pushover、Gotify、NTFY 等</li><li><strong>Webhook</strong>：可通过一定方式直接接入企业微信、钉钉、飞书等国内办公软件</li></ul><p>以企业微信为例：</p><ol><li>在群里创建一个通知机器人</li><li>记下机器人的key</li><li>在 Uptime Kuma 中选择企业威信通知方式</li><li>填写 key</li></ol><p>这样在服务无法访问和恢复访问时，就能在企业微信收到通知了</p><h3 id="4-使用-Push-监控模式"><a href="#4-使用-Push-监控模式" class="headerlink" title="4. 使用 Push 监控模式"></a>4. 使用 Push 监控模式</h3><p>Push 监控是 Uptime Kuma 的一个独特功能，它允许服务主动向 Uptime Kuma 报告自己的状态。这样即使是不支持的服务（如SSH），我们也可以自己编写简单的脚本，将监控结果推送到Uptime Kuma以实现监测，准备后续有空用Go写一个监控ssh是否能正常联通的服务。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Uptime Kuma 是一个功能极其丰富且非常易用的监控工具，特别适合个人开发者和小团队使用。</p><p>如果你也在寻找一个既强大又易用的监控解决方案，我强烈推荐试试 Uptime Kuma，一起化身赛博监控室大爷！</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 监控 </tag>
            
            <tag> Uptime-Kuma </tag>
            
            <tag> 网站维护 </tag>
            
            <tag> 服务监控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>绘制一个配对样本的Circos图</title>
      <link href="/2025/10/06/%E7%BB%98%E5%88%B6%E4%B8%80%E4%B8%AA%E9%85%8D%E5%AF%B9%E6%A0%B7%E6%9C%AC%E7%9A%84Circos%E5%9B%BE/"/>
      <url>/2025/10/06/%E7%BB%98%E5%88%B6%E4%B8%80%E4%B8%AA%E9%85%8D%E5%AF%B9%E6%A0%B7%E6%9C%AC%E7%9A%84Circos%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<p>在癌症研究中，比较肿瘤样本和类器官模型的基因组特征对于验证模型的可靠性至关重要。Circos图能比较直观地展示基因组中检测到突变的情况，所以在描述代表样本的总体检测结果时非常常用。在阅读circlize的文档的时候，看到作者给了一个配对样品的展示例子，我觉得用来展示配对的原代样本和类器官挺合适的，就搓了一个用来展示配对样本的图。代码主要参考自官方文档的<a href="https://jokergoo.github.io/circlize_book/book/initialize-genomic-plot.html#concatenating-two-genomes">9.5 Concatenating two genomes</a></p><span id="more"></span><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="加载必要的R包"><a href="#加载必要的R包" class="headerlink" title="加载必要的R包"></a>加载必要的R包</h3><p>首先，我们需要加载一些必要的R包：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>circlize<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>stringr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>MutationalPatterns<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>BSgenome.Hsapiens.UCSC.hg38<span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>其中，<code>MutationalPatterns</code>主要是用来加载vcf文件，这样不用手动处理，<code>BSgenome.Hsapiens.UCSC.hg38</code>是绘制基本的染色体区间时需要包提供的信息</p><h3 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h3><p>我这次展示了三方面的信息，分别是：</p><ul><li>体细胞突变检测结果（VCF文件）</li><li>CNV检测结果（来自CNVKit）</li><li>测序覆盖度数据（直接利用CNV软件给的结果，这样不用重复）</li></ul><h2 id="构建基因组框架数据"><a href="#构建基因组框架数据" class="headerlink" title="构建基因组框架数据"></a>构建基因组框架数据</h2><p>我们首先构建一个包含肿瘤和类器官基因组的合并框架：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 去除XY，构建合并的基因组数据</span></span><br><span class="line">tumor_cytoband <span class="operator">&lt;-</span> read.cytoband<span class="punctuation">(</span>species <span class="operator">=</span> <span class="string">&quot;hg38&quot;</span><span class="punctuation">)</span><span class="operator">$</span>df <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span><span class="operator">!</span><span class="punctuation">(</span>V1 <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;chrX&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;chrY&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">organoid_cytoband <span class="operator">&lt;-</span> read.cytoband<span class="punctuation">(</span>species <span class="operator">=</span> <span class="string">&quot;hg38&quot;</span><span class="punctuation">)</span><span class="operator">$</span>df <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span><span class="operator">!</span><span class="punctuation">(</span>V1 <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;chrX&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;chrY&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">tumor_cytoband<span class="punctuation">[</span> <span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;tumor_&quot;</span><span class="punctuation">,</span> tumor_cytoband<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">organoid_cytoband<span class="punctuation">[</span> <span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;organoid_&quot;</span><span class="punctuation">,</span> organoid_cytoband<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">cytoband <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span>tumor_cytoband<span class="punctuation">,</span> organoid_cytoband<span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>这里实际上是产生了名为cytoband的数据框，这个数据框丽包含要绘制的两个基因组的基本信息。</p><h2 id="处理突变数据"><a href="#处理突变数据" class="headerlink" title="处理突变数据"></a>处理突变数据</h2><p>使用<code>MutationalPatterns</code>包读取VCF文件，并转换为适合绘制的格式：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vcfs <span class="operator">&lt;-</span> read_vcfs_as_granges<span class="punctuation">(</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span></span><br><span class="line">        <span class="string">&#x27;tumor.vcf&#x27;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&#x27;pdo.vcf&#x27;</span></span><br><span class="line">    <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;tumor&quot;</span><span class="punctuation">,</span> <span class="string">&quot;pdo&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;BSgenome.Hsapiens.UCSC.hg38&quot;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">mut_data <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span></span><br><span class="line">    data.frame<span class="punctuation">(</span>vcfs<span class="punctuation">[[</span>t_sample<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>seqnames <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;tumor_&quot;</span><span class="punctuation">,</span> seqnames<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>seqnames<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    data.frame<span class="punctuation">(</span>vcfs<span class="punctuation">[[</span>o_sample<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>seqnames <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;organoid_&quot;</span><span class="punctuation">,</span> seqnames<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>seqnames<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h2 id="处理CNV和覆盖度数据"><a href="#处理CNV和覆盖度数据" class="headerlink" title="处理CNV和覆盖度数据"></a>处理CNV和覆盖度数据</h2><p>CNV和覆盖度的数据都取自CNVkit：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CNV数据</span></span><br><span class="line">cnv_data <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span></span><br><span class="line">    read.table<span class="punctuation">(</span></span><br><span class="line">            <span class="string">&quot;tumor.cnvkit.call.cns&quot;</span><span class="punctuation">,</span></span><br><span class="line">            sep<span class="operator">=</span><span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">            col.names <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;chromosome&quot;</span><span class="punctuation">,</span> <span class="string">&quot;start&quot;</span><span class="punctuation">,</span> <span class="string">&quot;end&quot;</span><span class="punctuation">,</span> <span class="string">&quot;cn&quot;</span><span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> cn<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>chromosome <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;tumor_&quot;</span><span class="punctuation">,</span> chromosome<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>chromosome<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    read.table<span class="punctuation">(</span></span><br><span class="line">            <span class="string">&quot;pdo.cnvkit.call.cns&quot;</span><span class="punctuation">,</span></span><br><span class="line">            sep<span class="operator">=</span><span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">            col.names <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;chromosome&quot;</span><span class="punctuation">,</span> <span class="string">&quot;start&quot;</span><span class="punctuation">,</span> <span class="string">&quot;end&quot;</span><span class="punctuation">,</span> <span class="string">&quot;cn&quot;</span><span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> cn<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>chromosome <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;organoid_&quot;</span><span class="punctuation">,</span> chromosome<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>chromosome<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span> <span class="operator">%&gt;%</span> mutate<span class="punctuation">(</span>value <span class="operator">=</span> pmin<span class="punctuation">(</span>value<span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="comment"># 限制CNV值不超过4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖度数据</span></span><br><span class="line">cov_data <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span></span><br><span class="line">    read.table<span class="punctuation">(</span><span class="string">&quot;tumor.cnvkit.cov.cnn&quot;</span><span class="punctuation">,</span> sep<span class="operator">=</span><span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> log2<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>chromosome <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;tumor_&quot;</span><span class="punctuation">,</span> chromosome<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>chromosome<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    read.table<span class="punctuation">(</span><span class="string">&quot;pdo.cnvkit.cov.cnn&quot;</span><span class="punctuation">,</span> sep<span class="operator">=</span><span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> log2<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>chromosome <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;organoid_&quot;</span><span class="punctuation">,</span> chromosome<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>chromosome<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h2 id="绘制Circos图"><a href="#绘制Circos图" class="headerlink" title="绘制Circos图"></a>绘制Circos图</h2><h3 id="设置颜色和初始化"><a href="#设置颜色和初始化" class="headerlink" title="设置颜色和初始化"></a>设置颜色和初始化</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 颜色设置</span></span><br><span class="line">red <span class="operator">&lt;-</span> <span class="string">&quot;#FFC6D6&quot;</span></span><br><span class="line">blue <span class="operator">&lt;-</span> <span class="string">&quot;#bebcff&quot;</span></span><br><span class="line">green <span class="operator">&lt;-</span> <span class="string">&quot;#9CCF83&quot;</span></span><br><span class="line">orange <span class="operator">&lt;-</span> <span class="string">&quot;#fbd988ff&quot;</span></span><br><span class="line">purpule <span class="operator">&lt;-</span> <span class="string">&quot;#ff726dff&quot;</span></span><br><span class="line">black <span class="operator">&lt;-</span> <span class="string">&quot;#000000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置图形大小</span></span><br><span class="line">png<span class="punctuation">(</span>filename <span class="operator">=</span> <span class="string">&quot;demo.circos.png&quot;</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">1200</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">1200</span><span class="punctuation">,</span> res <span class="operator">=</span> <span class="number">200</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建基础的circos框架</span></span><br><span class="line">chromosome.index <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span></span><br><span class="line">    paste0<span class="punctuation">(</span><span class="string">&quot;tumor_chr&quot;</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">    rev<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;organoid_chr&quot;</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">circos.par<span class="punctuation">(</span>gap.after <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">22</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">22</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">circos.initializeWithIdeogram<span class="punctuation">(</span></span><br><span class="line">    cytoband<span class="punctuation">,</span></span><br><span class="line">    plotType <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> </span><br><span class="line">    chromosome.index <span class="operator">=</span> chromosome.index</span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h3 id="添加染色体轨道"><a href="#添加染色体轨道" class="headerlink" title="添加染色体轨道"></a>添加染色体轨道</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置染色体track</span></span><br><span class="line">circos.track<span class="punctuation">(</span></span><br><span class="line">    ylim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    panel.fun <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">,</span> y<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        circos.text<span class="punctuation">(</span>CELL_META<span class="operator">$</span>xcenter<span class="punctuation">,</span> CELL_META<span class="operator">$</span>ylim<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> <span class="operator">+</span> mm_y<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">            gsub<span class="punctuation">(</span><span class="string">&quot;.*chr&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> CELL_META<span class="operator">$</span>sector.index<span class="punctuation">)</span><span class="punctuation">,</span> cex <span class="operator">=</span> <span class="number">0.6</span><span class="punctuation">,</span> niceFacing <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    track.height <span class="operator">=</span> mm_h<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    cell.padding <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    bg.border <span class="operator">=</span> <span class="literal">NA</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line">highlight.chromosome<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;tumor_chr&quot;</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> col <span class="operator">=</span> red<span class="punctuation">,</span> track.index <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">highlight.chromosome<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;organoid_chr&quot;</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> col <span class="operator">=</span> blue<span class="punctuation">,</span> track.index <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">circos.genomicIdeogram<span class="punctuation">(</span>cytoband<span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h3 id="添加覆盖度、CNV和突变密度轨道"><a href="#添加覆盖度、CNV和突变密度轨道" class="headerlink" title="添加覆盖度、CNV和突变密度轨道"></a>添加覆盖度、CNV和突变密度轨道</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测序覆盖度</span></span><br><span class="line">circos.genomicDensity<span class="punctuation">(</span>cov_data<span class="punctuation">,</span> col<span class="operator">=</span>orange<span class="punctuation">,</span> track.height <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span> window.size <span class="operator">=</span> <span class="number">1e7</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CNV轨道</span></span><br><span class="line">circos.genomicTrackPlotRegion<span class="punctuation">(</span></span><br><span class="line">    cnv_data<span class="punctuation">,</span> </span><br><span class="line">    ylim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    panel.fun <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>region<span class="punctuation">,</span> value<span class="punctuation">,</span> ...<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        cell.xlim <span class="operator">=</span> get.cell.meta.data<span class="punctuation">(</span><span class="string">&quot;cell.xlim&quot;</span><span class="punctuation">)</span></span><br><span class="line">        <span class="keyword">for</span><span class="punctuation">(</span>h <span class="keyword">in</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">            circos.lines<span class="punctuation">(</span>cell.xlim<span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span>h<span class="punctuation">,</span> h<span class="punctuation">)</span><span class="punctuation">,</span> col <span class="operator">=</span> black<span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        col <span class="operator">=</span> ifelse<span class="punctuation">(</span>value<span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> <span class="number">2</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">            ifelse<span class="punctuation">(</span>value<span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">==</span> <span class="number">2</span><span class="punctuation">,</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">)</span></span><br><span class="line">        i <span class="operator">=</span> getI<span class="punctuation">(</span>...<span class="punctuation">)</span></span><br><span class="line">        circos.genomicRect<span class="punctuation">(</span>region<span class="punctuation">,</span> value<span class="punctuation">,</span> col <span class="operator">=</span> col<span class="punctuation">,</span> ytop <span class="operator">=</span> value <span class="operator">+</span> <span class="number">0.3</span><span class="punctuation">,</span> ybottom <span class="operator">=</span> value <span class="operator">-</span> <span class="number">0.3</span> <span class="punctuation">,</span> border <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    track.height <span class="operator">=</span> <span class="number">0.1</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 突变密度</span></span><br><span class="line">circos.genomicDensity<span class="punctuation">(</span>mut_data<span class="punctuation">,</span> col<span class="operator">=</span>purpule<span class="punctuation">,</span> track.height <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span> window.size <span class="operator">=</span> <span class="number">1e7</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h3 id="添加文本和图例"><a href="#添加文本和图例" class="headerlink" title="添加文本和图例"></a>添加文本和图例</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置中间的文字</span></span><br><span class="line">text<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">0.2</span><span class="punctuation">,</span> <span class="string">&quot;Demo&quot;</span><span class="punctuation">,</span> cex <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> font <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 设置两角的文字</span></span><br><span class="line">text<span class="punctuation">(</span><span class="operator">-</span><span class="number">0.9</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">0.8</span><span class="punctuation">,</span> <span class="string">&quot;Tumor\nGenome&quot;</span><span class="punctuation">)</span></span><br><span class="line">text<span class="punctuation">(</span><span class="number">0.9</span><span class="punctuation">,</span> <span class="number">0.8</span><span class="punctuation">,</span> <span class="string">&quot;Organoid\nGenome&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置中间文字下方的图例</span></span><br><span class="line">legend<span class="punctuation">(</span></span><br><span class="line">  x <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  y <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  legend <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Coverage&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CNV gain&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CNV neutral&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CNV loss&quot;</span><span class="punctuation">,</span>  <span class="string">&quot;Mutation density&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  col <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>orange<span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> purpule<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  pch <span class="operator">=</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">  pt.cex <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  cex <span class="operator">=</span> <span class="number">0.8</span><span class="punctuation">,</span></span><br><span class="line">  bty <span class="operator">=</span> <span class="string">&quot;n&quot;</span><span class="punctuation">,</span></span><br><span class="line">  xjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">circos.clear<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>circlize<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>dplyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>stringr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>MutationalPatterns<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>BSgenome.Hsapiens.UCSC.hg38<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">tumor_cytoband <span class="operator">&lt;-</span> read.cytoband<span class="punctuation">(</span>species <span class="operator">=</span> <span class="string">&quot;hg38&quot;</span><span class="punctuation">)</span><span class="operator">$</span>df <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span><span class="operator">!</span><span class="punctuation">(</span>V1 <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;chrX&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;chrY&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">organoid_cytoband <span class="operator">&lt;-</span> read.cytoband<span class="punctuation">(</span>species <span class="operator">=</span> <span class="string">&quot;hg38&quot;</span><span class="punctuation">)</span><span class="operator">$</span>df <span class="operator">%&gt;%</span> filter<span class="punctuation">(</span><span class="operator">!</span><span class="punctuation">(</span>V1 <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;chrX&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;chrY&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">tumor_cytoband<span class="punctuation">[</span> <span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;tumor_&quot;</span><span class="punctuation">,</span> tumor_cytoband<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">organoid_cytoband<span class="punctuation">[</span> <span class="punctuation">,</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;organoid_&quot;</span><span class="punctuation">,</span> organoid_cytoband<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">cytoband <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span>tumor_cytoband<span class="punctuation">,</span> organoid_cytoband<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">t_sample <span class="operator">&lt;-</span> <span class="string">&quot;tumor&quot;</span></span><br><span class="line">o_sample <span class="operator">&lt;-</span> <span class="string">&quot;pdo&quot;</span></span><br><span class="line"></span><br><span class="line">vcfs <span class="operator">&lt;-</span> read_vcfs_as_granges<span class="punctuation">(</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span></span><br><span class="line">        <span class="string">&#x27;tumor.vcf&#x27;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&#x27;pdo.vcf&#x27;</span></span><br><span class="line">    <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span>t_sample<span class="punctuation">,</span> o_sample<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;BSgenome.Hsapiens.UCSC.hg38&quot;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">mut_data <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span></span><br><span class="line">    data.frame<span class="punctuation">(</span>vcfs<span class="punctuation">[[</span>t_sample<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>seqnames <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;tumor_&quot;</span><span class="punctuation">,</span> seqnames<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>seqnames<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    data.frame<span class="punctuation">(</span>vcfs<span class="punctuation">[[</span>o_sample<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>seqnames <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;organoid_&quot;</span><span class="punctuation">,</span> seqnames<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>seqnames<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cnv_data <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span></span><br><span class="line">    read.table<span class="punctuation">(</span></span><br><span class="line">            <span class="string">&quot;tumor.cnvkit.call.cns&quot;</span><span class="punctuation">,</span></span><br><span class="line">            sep<span class="operator">=</span><span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span></span><br><span class="line">        <span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> cn<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>chromosome <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;tumor_&quot;</span><span class="punctuation">,</span> chromosome<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>chromosome<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    read.table<span class="punctuation">(</span></span><br><span class="line">            <span class="string">&quot;pdo.cnvkit.call.cns&quot;</span><span class="punctuation">,</span></span><br><span class="line">            sep<span class="operator">=</span><span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span></span><br><span class="line">        <span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> cn<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>chromosome <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;organoid_&quot;</span><span class="punctuation">,</span> chromosome<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>chromosome<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span> <span class="operator">%&gt;%</span> mutate<span class="punctuation">(</span>value <span class="operator">=</span> pmin<span class="punctuation">(</span>value<span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cov_data <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span></span><br><span class="line">    read.table<span class="punctuation">(</span><span class="string">&quot;tumor.cnvkit.cov.cnn&quot;</span><span class="punctuation">,</span> sep<span class="operator">=</span><span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> log2<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>chromosome <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;tumor_&quot;</span><span class="punctuation">,</span> chromosome<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>chromosome<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    read.table<span class="punctuation">(</span><span class="string">&quot;pdo.cnvkit.cov.cnn&quot;</span><span class="punctuation">,</span> sep<span class="operator">=</span><span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>value <span class="operator">=</span> log2<span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        mutate<span class="punctuation">(</span>chromosome <span class="operator">=</span> str_c<span class="punctuation">(</span><span class="string">&quot;organoid_&quot;</span><span class="punctuation">,</span> chromosome<span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span></span><br><span class="line">        select<span class="punctuation">(</span>chromosome<span class="punctuation">,</span> start<span class="punctuation">,</span> end<span class="punctuation">,</span> value<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########################################### 绘图 ###########################################</span></span><br><span class="line"></span><br><span class="line">red <span class="operator">&lt;-</span> <span class="string">&quot;#FFC6D6&quot;</span></span><br><span class="line">blue <span class="operator">&lt;-</span> <span class="string">&quot;#bebcff&quot;</span></span><br><span class="line">green <span class="operator">&lt;-</span> <span class="string">&quot;#9CCF83&quot;</span></span><br><span class="line">orange <span class="operator">&lt;-</span> <span class="string">&quot;#fbd988ff&quot;</span></span><br><span class="line">purpule <span class="operator">&lt;-</span> <span class="string">&quot;#ff726dff&quot;</span></span><br><span class="line">black <span class="operator">&lt;-</span> <span class="string">&quot;#000000&quot;</span></span><br><span class="line"></span><br><span class="line">png<span class="punctuation">(</span>filename <span class="operator">=</span> <span class="string">&quot;demo.circos.png&quot;</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">1200</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">1200</span><span class="punctuation">,</span> res <span class="operator">=</span> <span class="number">200</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">chromosome.index <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span></span><br><span class="line">    paste0<span class="punctuation">(</span><span class="string">&quot;tumor_chr&quot;</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">    rev<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;organoid_chr&quot;</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">circos.par<span class="punctuation">(</span>gap.after <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">22</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">22</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="comment"># 设置区隔？</span></span><br><span class="line">circos.initializeWithIdeogram<span class="punctuation">(</span></span><br><span class="line">    cytoband<span class="punctuation">,</span></span><br><span class="line">    plotType <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> </span><br><span class="line">    chromosome.index <span class="operator">=</span> chromosome.index</span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">circos.track<span class="punctuation">(</span></span><br><span class="line">    ylim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    panel.fun <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">,</span> y<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        circos.text<span class="punctuation">(</span>CELL_META<span class="operator">$</span>xcenter<span class="punctuation">,</span> CELL_META<span class="operator">$</span>ylim<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> <span class="operator">+</span> mm_y<span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">            gsub<span class="punctuation">(</span><span class="string">&quot;.*chr&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> CELL_META<span class="operator">$</span>sector.index<span class="punctuation">)</span><span class="punctuation">,</span> cex <span class="operator">=</span> <span class="number">0.6</span><span class="punctuation">,</span> niceFacing <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    track.height <span class="operator">=</span> mm_h<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    cell.padding <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    bg.border <span class="operator">=</span> <span class="literal">NA</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line">highlight.chromosome<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;tumor_chr&quot;</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> col <span class="operator">=</span> red<span class="punctuation">,</span> track.index <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">highlight.chromosome<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;organoid_chr&quot;</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> col <span class="operator">=</span> blue<span class="punctuation">,</span> track.index <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">circos.genomicIdeogram<span class="punctuation">(</span>cytoband<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">circos.genomicDensity<span class="punctuation">(</span>cov_data<span class="punctuation">,</span> col<span class="operator">=</span>orange<span class="punctuation">,</span> track.height <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span> window.size <span class="operator">=</span> <span class="number">1e7</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">circos.genomicTrackPlotRegion<span class="punctuation">(</span></span><br><span class="line">    cnv_data<span class="punctuation">,</span> </span><br><span class="line">    ylim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    panel.fun <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>region<span class="punctuation">,</span> value<span class="punctuation">,</span> ...<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">        cell.xlim <span class="operator">=</span> get.cell.meta.data<span class="punctuation">(</span><span class="string">&quot;cell.xlim&quot;</span><span class="punctuation">)</span></span><br><span class="line">        <span class="keyword">for</span><span class="punctuation">(</span>h <span class="keyword">in</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span> </span><br><span class="line">            circos.lines<span class="punctuation">(</span>cell.xlim<span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span>h<span class="punctuation">,</span> h<span class="punctuation">)</span><span class="punctuation">,</span> col <span class="operator">=</span> black<span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        col <span class="operator">=</span> ifelse<span class="punctuation">(</span>value<span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> <span class="number">2</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">            ifelse<span class="punctuation">(</span>value<span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">==</span> <span class="number">2</span><span class="punctuation">,</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">)</span> </span><br><span class="line">        i <span class="operator">=</span> getI<span class="punctuation">(</span>...<span class="punctuation">)</span></span><br><span class="line">        circos.genomicRect<span class="punctuation">(</span>region<span class="punctuation">,</span> value<span class="punctuation">,</span> col <span class="operator">=</span> col<span class="punctuation">,</span> ytop <span class="operator">=</span> value <span class="operator">+</span> <span class="number">0.3</span><span class="punctuation">,</span> ybottom <span class="operator">=</span> value <span class="operator">-</span> <span class="number">0.3</span> <span class="punctuation">,</span> border <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    track.height <span class="operator">=</span> <span class="number">0.1</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">circos.genomicDensity<span class="punctuation">(</span>mut_data<span class="punctuation">,</span> col<span class="operator">=</span>purpule<span class="punctuation">,</span> track.height <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span> window.size <span class="operator">=</span> <span class="number">1e7</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">text<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">0.2</span><span class="punctuation">,</span> <span class="string">&quot;Demo&quot;</span><span class="punctuation">,</span> cex <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> font <span class="operator">=</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line">text<span class="punctuation">(</span><span class="operator">-</span><span class="number">0.9</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">0.8</span><span class="punctuation">,</span> <span class="string">&quot;Tumor\nGenome&quot;</span><span class="punctuation">)</span></span><br><span class="line">text<span class="punctuation">(</span><span class="number">0.9</span><span class="punctuation">,</span> <span class="number">0.8</span><span class="punctuation">,</span> <span class="string">&quot;Organoid\nGenome&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">legend<span class="punctuation">(</span></span><br><span class="line">  x <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span>           </span><br><span class="line">  y <span class="operator">=</span> <span class="number">0</span><span class="punctuation">,</span>        </span><br><span class="line">  legend <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Coverage&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CNV gain&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CNV neutral&quot;</span><span class="punctuation">,</span> <span class="string">&quot;CNV loss&quot;</span><span class="punctuation">,</span>  <span class="string">&quot;Mutation density&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  col <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>orange<span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span> purpule<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">  pch <span class="operator">=</span> <span class="number">15</span><span class="punctuation">,</span>        </span><br><span class="line">  pt.cex <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  cex <span class="operator">=</span> <span class="number">0.8</span><span class="punctuation">,</span></span><br><span class="line">  bty <span class="operator">=</span> <span class="string">&quot;n&quot;</span><span class="punctuation">,</span>       </span><br><span class="line">  xjust <span class="operator">=</span> <span class="number">0.5</span><span class="punctuation">,</span>     </span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">circos.clear<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h2 id="成品展示"><a href="#成品展示" class="headerlink" title="成品展示"></a>成品展示</h2><ul><li>这里使用的是一个样本生成的数据画了上下两圈，所以两边检测结果看上去是一样的，实际要是配对结果能这么一致，那高低得给佛祖多磕几个了。</li></ul><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/10/upgit_20251007_1759767842.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/10/upgit_20251007_1759767842.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="circos_demo"></p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R </tag>
            
            <tag> circlize </tag>
            
            <tag> 基因组 </tag>
            
            <tag> 突变 </tag>
            
            <tag> CNV </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FydeOS下编译ffmpeg-rockchip</title>
      <link href="/2025/10/02/FydeOS%E4%B8%8B%E7%BC%96%E8%AF%91ffmpeg-rockchip/"/>
      <url>/2025/10/02/FydeOS%E4%B8%8B%E7%BC%96%E8%AF%91ffmpeg-rockchip/</url>
      
        <content type="html"><![CDATA[<p>去年其实就使用Fydetab Duo压制过旅行中的视频，当时找的某个github上给的现成库，结果现在找不到这个库了… 于是这次我又尝试自己来编译了…</p><span id="more"></span><p>编译参考了<a href="https://github.com/nyanmisaka/ffmpeg-rockchip/wiki/Compilation">库作者dnyanmisaka的文档</a>，整个过程还是相对顺利的~</p><h2 id="使用pixi准备编译环境"><a href="#使用pixi准备编译环境" class="headerlink" title="使用pixi准备编译环境"></a>使用pixi准备编译环境</h2><p>这里相比原文档中提到的<code>git</code>,<code>meson</code>,<code>cmake</code>,<code>pkg-config</code>,<code>gcc</code>,<code>libdrm-dev</code>多了很多东西，毕竟fydeos&#x2F;chromeos并不是传统的linux，缺非常多常见库，因此要补充缺失的依赖程序。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pixi init</span><br><span class="line">pixi add make gxx meson cmake pkg-config gcc libdrm libdrm-devel-conda-aarch64 pthread-stubs binutils diffutils awk</span><br></pre></td></tr></table></figure><p>创建pixi环境后，需要<code>pixi shell</code>进入虚拟环境，进入后所有后续的编译安装目的地全部指向这个虚拟环境，这样安装后的依赖在最后的ffmpeg编译时才都找的到</p><h2 id="编译rkmpp"><a href="#编译rkmpp" class="headerlink" title="编译rkmpp"></a>编译rkmpp</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b jellyfin-mpp --depth=1 https://github.com/nyanmisaka/mpp.git rkmpp</span><br><span class="line"><span class="built_in">mkdir</span> -p rkmpp/rkmpp_build</span><br><span class="line"><span class="built_in">cd</span> rkmpp/rkmpp_build</span><br><span class="line"></span><br><span class="line">cmake \</span><br><span class="line">    -DCMAKE_INSTALL_PREFIX=/usr/local/share/project/ffmpeg/.pixi/envs/default/ \</span><br><span class="line">    -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">    -DBUILD_SHARED_LIBS=ON \</span><br><span class="line">    -DBUILD_TEST=OFF \</span><br><span class="line">    ..</span><br><span class="line">make -j $(<span class="built_in">nproc</span>)</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h2 id="编译RGA"><a href="#编译RGA" class="headerlink" title="编译RGA"></a>编译RGA</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b jellyfin-rga --depth=1 https://github.com/nyanmisaka/rk-mirrors.git rkrga</span><br><span class="line">meson setup rkrga rkrga_build \</span><br><span class="line">    --prefix=/usr/local/share/project/ffmpeg/.pixi/envs/default/ \</span><br><span class="line">    --libdir=lib \</span><br><span class="line">    --buildtype=release \</span><br><span class="line">    --default-library=shared \</span><br><span class="line">    -Dcpp_args=-fpermissive \</span><br><span class="line">    -Dlibdrm=<span class="literal">false</span> \</span><br><span class="line">    -Dlibrga_demo=<span class="literal">false</span></span><br><span class="line">meson configure rkrga_build</span><br><span class="line">ninja -C rkrga_build install</span><br></pre></td></tr></table></figure><h2 id="编译ffmpeg并安装"><a href="#编译ffmpeg并安装" class="headerlink" title="编译ffmpeg并安装"></a>编译ffmpeg并安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ffmpeg部分</span></span><br><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/nyanmisaka/ffmpeg-rockchip.git ffmpeg</span><br><span class="line"><span class="built_in">cd</span> ffmpeg</span><br><span class="line">./configure --prefix=/usr/local/share/project/ffmpeg/.pixi/envs/default \</span><br><span class="line">    --enable-gpl --enable-version3 --enable-libdrm --enable-rkmpp --enable-rkrga</span><br><span class="line">make -j $(<span class="built_in">nproc</span>)</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>执行上面所有的步骤后，虚拟环境内就有rockchip芯片专用的ffmpeg了，视频处理速度比cpu版本的快了10x有多~</p><p>晚点考虑把上面的内容做一个带任务的Pixi环境，然后也学习下怎么用pixi打包和上传包。</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FydeOS </tag>
            
            <tag> ffmpeg </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用taipy开发一个数据面板以及遇到的坑</title>
      <link href="/2025/10/01/%E4%BD%BF%E7%94%A8taipy%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E9%9D%A2%E6%9D%BF%E4%BB%A5%E5%8F%8A%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/"/>
      <url>/2025/10/01/%E4%BD%BF%E7%94%A8taipy%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E9%9D%A2%E6%9D%BF%E4%BB%A5%E5%8F%8A%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/</url>
      
        <content type="html"><![CDATA[<p>Python下快速开发数据或AI相关应用的模块真的很多，我已经使用过的包括Dash、Streamlit、Gradio、NiceGUI，前段时间我甚至又发现了俩，正遇上我需要开发一个展示公司数据的简单数据看板，于是我再次不要命的用了新框架—-Taipy。</p><span id="more"></span><h2 id="Taipy的使用"><a href="#Taipy的使用" class="headerlink" title="Taipy的使用"></a>Taipy的使用</h2><h3 id="页面布局"><a href="#页面布局" class="headerlink" title="页面布局"></a>页面布局</h3><p>Taipy设计了多种编写布局的方式，根据个人熟悉的语言，可以从Markdown、HTML以及Python语法中挑选一种，进行页面布局设定。不过感觉官方主推的是Markdown。是的，非常神奇，一个用Python写的库居然主推用Markdown写布局…</p><p>我当然是选Python语法了，它的用法跟Gradio基本一致，<code>with</code>以及对象用来控制元素的包含关系。</p><p>具体来说，通过<code>taipy.gui.builder</code>模块，我们可以使用Python语法来定义页面结构。</p><p>主要布局组件包括：</p><ul><li><code>tgb.layout()</code>：创建布局容器，可以设置列数（columns）、间距（gap）</li><li><code>tgb.part()</code>：创建内容区块，用于组织相关组件</li></ul><p>在我的数据面板中，我采用了三级布局结构：</p><ol><li>顶部：公司Logo、标题和主题切换控件</li><li>中间：地图、饼图、折线图、柱状图等数据可视化组件</li><li>底部：关键指标卡片展示</li></ol><p>布局示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tgb.layout(columns=<span class="string">&quot;1 2 1&quot;</span>, gap=<span class="string">&quot;10px&quot;</span>): <span class="comment"># 三列，宽度是1:2:1</span></span><br><span class="line">    <span class="comment"># 左侧区块</span></span><br><span class="line">    <span class="keyword">with</span> tgb.part(class_name=<span class="string">&quot;card&quot;</span>):</span><br><span class="line">        tgb.text(<span class="string">&quot;里程碑&quot;</span>, class_name=<span class="string">&quot;h5&quot;</span>)</span><br><span class="line">        tgb.chart(figure=<span class="string">&quot;&#123;timeline&#125;&quot;</span>, plot_config=&#123;<span class="string">&quot;staticPlot&quot;</span>: <span class="literal">True</span>&#125;)</span><br><span class="line">    <span class="comment"># 中间和右侧区块类似</span></span><br></pre></td></tr></table></figure><h3 id="样式设定"><a href="#样式设定" class="headerlink" title="样式设定"></a>样式设定</h3><p>Taipy支持通过CSS文件和Stylekit来自定义样式。</p><ul><li><strong>CSS样式</strong>：CSS的使用跟一般写网页一样，创建了<code>style.css</code>文件来定义全局样式和组件样式：<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.card</span> &#123;</span><br><span class="line">    <span class="attr">--element-padding</span>: <span class="number">0.4rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.scrollable-part</span> &#123;</span><br><span class="line">    <span class="attribute">overflow-y</span>: auto; <span class="comment">/* 垂直滚动 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>然后在项目创建时，指定要加载的额外CSS就行了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gui = Gui(page, css_file=<span class="string">&quot;style.css&quot;</span>)</span><br><span class="line">gui.run()</span><br></pre></td></tr></table></figure><ul><li><strong>Stylekit主题</strong>：通过Python字典定义主题颜色，然后在启动GUI时传入：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">STYLEKIT = &#123;</span><br><span class="line">    <span class="string">&quot;color-primary&quot;</span>: <span class="string">&quot;#E72410&quot;</span>,</span><br><span class="line">    <span class="string">&quot;color-secondary&quot;</span>: <span class="string">&quot;#F28E2A&quot;</span>,</span><br><span class="line">    <span class="string">&quot;color-background-light&quot;</span>: <span class="string">&quot;#EDEDED&quot;</span>,</span><br><span class="line">    <span class="string">&quot;color-paper-light&quot;</span>: <span class="string">&quot;#FFFFFF&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gui.run(stylekit=STYLEKIT, dark_mode=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>注意，Stylekit能控制的内容远少于经典的设置class然后CSS文件内调整，可调整的内容见<a href="https://docs.taipy.io/en/latest/userman/gui/styling/">Taipy的文档</a>。</li></ul><p>除上述两种方式之外，Taipy的不同控件还可以通过<code>class_name</code>参数来设定一些模块预设的样式，每个控件能用的东西不同，具体需要参考各个控件的文档</p><h3 id="数值绑定"><a href="#数值绑定" class="headerlink" title="数值绑定"></a>数值绑定</h3><p>Taipy提供一种名为<a href="https://docs.taipy.io/en/latest/userman/gui/binding/">数值绑定</a>的方式，来让界面内容的更新更为简单。</p><p>具体使用花括号<code>&#123;&#125;</code>语法将Python变量绑定到界面组件。举最简单的文字例子，我可以如下设置显示一段文字：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&#x27;My Text&#x27;</span></span><br><span class="line">tgb.text(<span class="string">&quot;&#123;text&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><p>在上面的设置中，先复制变量<code>text</code>，再在文字控件的内容部分用<code>&quot;&#123;text&#125;&quot;</code>将变量于内容绑定看上去有些多此一举，但是这在Taipy中非常重要。Taipy中，会将命名控件中定义过的所有对象&#x2F;变量，放在一个名为<code>state</code>的特殊对象中。在上面的代码中，实际上同时创造了<code>state.text</code>这个属性，而任何对<code>state.text</code>进行的改变，也会反映在<code>tgb.text(&quot;&#123;text&#125;&quot;)</code>这个文字控件上。于是，如果我想更新这里显示的文字，只要在能获取state的部分中，直接修改其内容，文字就会被修改，并显示在页面上了，比如下面这样：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">state.assign(text, <span class="string">&quot;Changed Text&quot;</span>)</span><br></pre></td></tr></table></figure><p>这样相较于常用的Dash&#x2F;Steamlit&#x2F;Gradio，其实就少写了更新控件内容部分的代码，使开发更快。尤其对于数据展示的App，很多时候其实图和表的绘制代码是固定的，我们只是重新整理数据框或计算指标，Taipy的这种设计能让开发者将时间着重放在更新数据上，而不用在展示部分画太多时间。</p><h3 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h3><p>如其他框架一样，Taipy的各种控件也是可以设置回调函数的，比如最基础的按钮有<code>on_action</code>回调，就是按钮被按下时触发的回调。不同控件可用的回调不同，需要参考官方文档。</p><p>与其他框架不同的是，Taipy还可以设置全局的默认回调函数，我们可以直接定义名为<code>on_action</code>的函数，放在命名控件内，Taipy的逻辑是，如果一个控件可以触发<code>on_action</code>回调，且有名为<code>on_action</code>的函数在当前命名控件，则会直接触发回调。因此在Taipy中，用这种全局回调需要做好逻辑判断，误触回调。</p><h3 id="后台任务"><a href="#后台任务" class="headerlink" title="后台任务"></a>后台任务</h3><p>Taipy虽然内置了定时调度方法，但却放在了付费版本中。不过好在，社区版本中可以通过<code>invoke_long_callback</code>这种高负载的任务回调来时间定时刷新数据的目的。我这边参考了<a href="https://github.com/Avaiga/demo-realtime-pollution">官方给的一个例子</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countdown</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_value</span>(<span class="params">value</span>):</span><br><span class="line">    value = value + randint(<span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_display_value</span>(<span class="params">state</span>):</span><br><span class="line">    state.total_client = update_value(state.total_client)</span><br><span class="line">    state.total_visits = update_value(state.total_visits)</span><br><span class="line">    state.total_reads = update_value(state.total_reads)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_init</span>(<span class="params">state</span>):</span><br><span class="line">    set_icon(state)</span><br><span class="line">    invoke_long_callback(</span><br><span class="line">        state,</span><br><span class="line">        user_function = countdown,</span><br><span class="line">        user_status_function = update_display_value,</span><br><span class="line">        period = <span class="number">3000</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>上面的代码中，<code>invoke_long_callback</code>是Taipy提供的一个函数，我们通过它来设定一项高负载任务，也就是<code>user_function</code>，这个函数会单开线程执行，然后设定一个检查高负载任务结果的线程，调用<code>user_status_function</code>中传入的函数，来更新state中的数据。这样一旦数据更新，就能触发Taipy的数值绑定逻辑，更新页面上显示的内容了。</p><h2 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h2><p>原本想，Taipy都有明确的商业化方案了，这个模块的基本功能应该做得相当不错了，但是在实际使用的过程中，还是碰到让我卡了一天以上的坑…</p><h3 id="4-1-0版本的Toggle控件在Theme模式不触发"><a href="#4-1-0版本的Toggle控件在Theme模式不触发" class="headerlink" title="4.1.0版本的Toggle控件在Theme模式不触发"></a>4.1.0版本的Toggle控件在Theme模式不触发</h3><p>在pixi&#x2F;conda能获取的4.1.0版本中，我发现Toggle控件在设置<code>theme=True</code>，即设置为主题转换按钮时，数值绑定和函数回调都是实效的… 这个问题苦恼了我一天半… 我试着让AI给了我很多解决方法，但是Taipy似乎并不是一个那么流行的模块，不能像其他之前的框架那样，直接注入Javascript来解决。因此我最后还是跑去看了源代码… 发现在4.1.0版本中，<code>ThemeToggle.tsx</code>中定义的主题切换控件，就没有数值绑定和回调的逻辑… 只有在最新的<code>main</code>分支中才有… 最后，靠从源代码安装Taipy解决了这个问题…</p><h3 id="Stylekit并不能一次性设定所有的颜色"><a href="#Stylekit并不能一次性设定所有的颜色" class="headerlink" title="Stylekit并不能一次性设定所有的颜色"></a>Stylekit并不能一次性设定所有的颜色</h3><p>官方虽然在文档中说，使用Stylekit这个设计可以让开发者灵活和简洁的控制主题配色，但是实际使用后发现，它似乎并不能控制页面的总背景色，需要通过css额外解决：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Setting theme color */</span></span><br><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">var</span>(--color-background);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="plotly-没有绘制时间线图的函数"><a href="#plotly-没有绘制时间线图的函数" class="headerlink" title="plotly 没有绘制时间线图的函数"></a>plotly 没有绘制时间线图的函数</h3><p>这个… 纯属对plotly吐槽以下了，虽然Python在数据科学方面应用甚广，但是不论是Plotly、matplotlib、seaborn还是altair，其图形的丰富程度，还是比不过R下的生态… 当然R下有人写了，但是包管理太混乱，我用不了别人写的代码，又是另一回事了…</p><p>不过还好里程碑时间线这种东西也就是点、线加个文字，最后还是靠AI手措出来了…</p><h3 id="对Plotly的设定方式说明不足"><a href="#对Plotly的设定方式说明不足" class="headerlink" title="对Plotly的设定方式说明不足"></a>对Plotly的设定方式说明不足</h3><p>这个问题也卡了我很久，Taipy的文档中，有说明如何不使用Taipy提供的接口，而是直接传递Ploty对象，将图形绘制在页面上。但是如何对Plotly对象进行配置，文档就说参考Plotly文档了。然后我就体会到了Plotly这个文档、看上去写得很细，实际上内容很贫乏的问题了。在他们官方的文档中，很多的配置项，居然只有<code>fig.show()</code>的时候才能传入… 而不是直接对Plotly对象去配置… 然后我绕了一大圈，发现Taipy的<code>chart</code>控件有一个<code>plot_config</code>参数… 这里可以传入<code>fig.show()</code>时的参数…</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Taipy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>尝试修改chromeos中的终端app(中)</title>
      <link href="/2025/09/05/%E5%B0%9D%E8%AF%95%E4%BF%AE%E6%94%B9chromeos%E4%B8%AD%E7%9A%84%E7%BB%88%E7%AB%AFapp-%E4%B8%AD/"/>
      <url>/2025/09/05/%E5%B0%9D%E8%AF%95%E4%BF%AE%E6%94%B9chromeos%E4%B8%AD%E7%9A%84%E7%BB%88%E7%AB%AFapp-%E4%B8%AD/</url>
      
        <content type="html"><![CDATA[<p>书接上回，在成功编译libapp项目下的代码后，接下来是两部分：修改libapp的代码，以及将修改应用到镜像中</p><span id="more"></span><h2 id="terminal-app原理"><a href="#terminal-app原理" class="headerlink" title="terminal app原理"></a>terminal app原理</h2><p>上次我已经成功在浏览器中看到了<code>terminal app</code>，要修改代码，先要大致理解这个应用的原理。</p><p>在进行了一点尝试后，我对终端应的理解如下：</p><ol><li>终端用由几个页面组成，最外侧的界面实际上是 <code>terminal.html</code> 这个页面，页面调用，然后调用一系列项目内的js脚本加载页面内容</li><li>建立ssh链接时，应用实际上是，调用chromeos下才可调用的本地API（类似electron？），打开一个新的窗口，然后显示<code>terminal_ssh.html</code> 这个页面，该页面会调用nassh目录中的js脚本来进行实际的终端渲染</li><li>启动ssh连接，实际上是将ssh的参数传递给<code>terminal_ssh.html</code>页面，然后页面内的脚本拼凑出ssh命令，交由下游的api去建立ssh链接</li><li>设置也是独立的页面，对应<code>terminal_settings.html</code></li></ol><h2 id="修改libapp代码"><a href="#修改libapp代码" class="headerlink" title="修改libapp代码"></a>修改libapp代码</h2><p>了解了应用的工作原理，接下来就是尝试修改代码了。由于我并没有专门学习过html&#x2F;js&#x2F;css这些网站的技术栈，虽然大致能理解代码的逻辑，但是我并不打算自己从头设计并编写代码，主要还是参考现有的代码，组合出我需要的功能。</p><p>就我自己的使用体验来看，sftp挂载到本地的这一现有功能，逻辑上和我想要的快速端口转发有一定相似性：</p><ol><li>sftp挂载需要先设定ssh部分的端口、用户等信息</li><li>在已有的登录条目基础上，进行sftp挂载，点击挂载后，与ssh登录一样新跳出一个页面，但是不能操作，只提示挂载信息，和关闭窗口后挂载自动结束</li></ol><p>我想要的功能就参照这个逻辑来增改：</p><ol><li>端口转发需要先设定ssh部分的端口、用户等信息</li><li>在已有的登录条目基础上，端口转发，点击转发后，跳出窗口设置要转发哪个端口</li><li>与ssh登录一样新跳出一个页面，但是不能操作，只提示转发的端口，和关闭窗口后挂载自动结束</li></ol><p><a href="https://github.com/SilenWang/libapps/tree/feat/add-port-forward-button">实际修改的文件</a>主要是terminal个nassh目录下的js文件，主要是加入转发的按钮，然后是参考sftp的功能实现，改一个能执行端口转发的函数出来</p><h2 id="将修改应用到镜像"><a href="#将修改应用到镜像" class="headerlink" title="将修改应用到镜像"></a>将修改应用到镜像</h2><p>在chromeos的源代码中，libapp并不是包名，在检索项目后，发现这些内容的编译实际上在<code>crosh-extention.ebuild</code>中，找到这个ebuild的目录，使用git生成补丁，放到这个目录中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff COMMIT_HASH_1 COMMIT_HASH_2 &gt; patchfile.patch</span><br></pre></td></tr></table></figure><p>然后还要进一步的修改ebuild文件，加入下面的内容后，构建时会自动调用补丁，进行代码修改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PATCHES=(</span><br><span class="line">    &quot;$&#123;FILESDIR&#125;&quot;/0001-forward.patch</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="重新编译包和镜像"><a href="#重新编译包和镜像" class="headerlink" title="重新编译包和镜像"></a>重新编译包和镜像</h2><p>这里我碰到了一个坑，如果只修改文件，直接按照之前的方法进行编译，其实是无法应用改动的。</p><p>根据<a href="https://www.jianshu.com/p/6d8523b1f771">找到的这个内容</a>，需要使用<code>cros_sdk</code>中的<code>cros_workon</code>命令，标记对特定包进行修改，才会使用我修改后的ebuild文件来进行编译，而不是获取特定版本的源代码进行编译。</p><p>编译的过程<a href="/2025/01/04/%E7%BC%96%E8%AF%91openfyde/" title="编译openfyde">[参考以前的步骤]</a>就可以了。在执行<code>build-packages</code>时，工具会自动识别有更改的包，自动重新构建，然后将更新后的包放到chroot环境中去。</p><h2 id="刷机以及启动"><a href="#刷机以及启动" class="headerlink" title="刷机以及启动"></a>刷机以及启动</h2><a href="/2025/06/19/%E5%86%8D%E6%AC%A1%E5%B0%9D%E8%AF%95%E7%BC%96%E8%AF%91openfyde-%E4%B8%8B/" title="再次尝试编译openfyde（下)">[刷机也没有什么变化]</a>，就是上次随便改内核，导致测试用的工程机duo砖了，因此参考[fydetab duo wiki的说明](https://wiki.fydetabduo.com/unbrick_the_fydetab_duo)进maskrom模式来刷。<h2 id="进行调试？"><a href="#进行调试？" class="headerlink" title="进行调试？"></a>进行调试？</h2><p>这里其实留下了一个问题，不论做什么开发，在进行实机测试和调试之前，理论上都应该先在测试或者虚拟环境中完成测试才是，否则要来回编译、刷机，会浪费大量时间。我想这也是各种SDK和Studio套件存在的意义。</p><p>但是，我目前还真不知道… 我这样修改应该要如何在刷机前调试？根据<a href="https://www.owalle.com/2020/06/03/crosvm-chromevm/">找到的博客</a>，似乎是可以利用cros_sdk的虚拟机功能的，调用QEMU的kvm虚拟机，似乎可以对编译后的镜像进行调试。</p><p>下次就是把功能调试好，展示成果了！这次先展示一下刷机后界面的改变！</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/09/upgit_20250907_1757177833.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/09/upgit_20250907_1757177833.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="terminal_in_openfyde.png"></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> chromeos </tag>
            
            <tag> terminal </tag>
            
            <tag> libapp </tag>
            
            <tag> 终端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SteamOS确实日趋成熟</title>
      <link href="/2025/08/25/SteamOS%E7%A1%AE%E5%AE%9E%E6%97%A5%E8%B6%8B%E6%88%90%E7%86%9F/"/>
      <url>/2025/08/25/SteamOS%E7%A1%AE%E5%AE%9E%E6%97%A5%E8%B6%8B%E6%88%90%E7%86%9F/</url>
      
        <content type="html"><![CDATA[<p>去年到今年，我玩了两个PC游戏，黑神话和明末，都是首发日就下载开玩的。这在5年前，真的是很难想象的一件事。那时候我刚打完猛汉王的本体，使用的是Windows KVM虚拟机加显卡直通。等到冰原资料片发售的时候，Proton就已经能支持相当多的旧游戏了，但是最新的游戏，首发很难支持，冰原我记得PC正式发售后两三个月，才能进入游戏，同时还存在一些bug，且Proton一旦升级，游戏可能就进不去了…</p><span id="more"></span><p>再后来我记得是2077发售的时候，依然没能赶上首发日，大概等了几个星期，2077才能运行在Proton兼容层上，当时我已经换了显卡，我还测试了一下，进去没有大问题，但是中文字体和部分内置视频播片有问题。这都挺能接受的了… 只是我对2077题材并不那么感兴趣，就没有真的玩。</p><p>之后好几年，我都没有再用PC玩游戏过，因为电脑主要用来做一些分析的测试，硬盘不够，装不了游戏，一直都是玩的Switch。</p><p>然后就到了黑神话发售的24年，刚好我换了工作，电脑不需要继续用，我就索性重装了系统，试了试Bazzite，因为这是当时唯一支持N卡的类SteamOS发行版了。说实话，运行效果超出我的预期，居然发售首日就能进游戏，虽然流畅度欠佳，但是作为马赛克猎人的我…540p，30帧不到也不是没玩过，1080p 40~60的效果，我完全能接受，游戏本身也不难，就跟着大伙一起通关了。</p><p>今年的明末则更出乎我的意料，我并没有保留Bazzite系统，只是Ubuntu 22.04装了N卡的闭源驱动，居然也直接能进游戏，运行效果接近去年黑猴，甚至我iPad串流玩(为了用NS的手柄)都不会卡…</p><p>这样一来，之后发售的国产游戏，我应该都能第一时间尝试上了…</p><p>感谢G胖，祝早日干翻Windows…</p>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Steam </tag>
            
            <tag> SteamOS </tag>
            
            <tag> Bazzite </tag>
            
            <tag> Gaming </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>尝试修改chromeos中的终端app(上)</title>
      <link href="/2025/08/21/%E5%B0%9D%E8%AF%95%E4%BF%AE%E6%94%B9chromeos%E4%B8%AD%E7%9A%84%E7%BB%88%E7%AB%AFapp-%E4%B8%8A/"/>
      <url>/2025/08/21/%E5%B0%9D%E8%AF%95%E4%BF%AE%E6%94%B9chromeos%E4%B8%AD%E7%9A%84%E7%BB%88%E7%AB%AFapp-%E4%B8%8A/</url>
      
        <content type="html"><![CDATA[<p>我是用fydeos &#x2F; chromeos也有两年了, 系统中虽然提供了能用的终端app, 但是说真的, 还不是那么好用, 比如我在开发时, 常常会需要进行多个端口的转发. 虽然我可以通过输入端口转发的ssh命令来达成目的,但是这样一来会需要手动输入比较多的参数, 二来端口转发期间会一直需要保持ssh登录后的窗口, 对于我这种特别喜欢降低开启窗口数目的强迫症来说, 开着三四个不会前台使用的窗口真的很难受… 所以我就想, 我能不能自己动手, 在AI帮助下, 修改系统自带的默认终端客户端, 给他加上vscode那样的快捷转发功能呢?</p><span id="more"></span><h2 id="克隆代码"><a href="#克隆代码" class="headerlink" title="克隆代码"></a>克隆代码</h2><p>百尺竿头第一步, 先得知道项目代码是否能获取, 这个deepseek, kimi 和 chatGPT 都能给我正确答案: <code>https://chromium.googlesource.com/apps/libapps</code>, 直接克隆这个项目到本地就行.</p><h2 id="项目编译"><a href="#项目编译" class="headerlink" title="项目编译"></a>项目编译</h2><p>项目内几乎每个目录都自带说明, 有详细有简略的, 阅读一遍, 结合AI的回答可知, 关键的文件夹大致如下:</p><ul><li>hterm: js编写的终端模拟器, 登录后看到的终端所有内容都是它渲染的</li><li>nassh: chorme商店的终端模拟器插件, 结合了<code>hterm</code>和<code>ssh_client</code>的内容</li><li>ssh_client: 与openssh通信的部分</li><li>terminal: 我们看到的terminal app前端</li></ul><h2 id="在chromeos外尝试运行"><a href="#在chromeos外尝试运行" class="headerlink" title="在chromeos外尝试运行"></a>在chromeos外尝试运行</h2><p>要开发&#x2F;修改一个应用, 首先需要部署相应的开发及调试环境, 这个是这次最为难我的地方了, 虽然项目的文档内容比较丰富, 但是仍然不至于丰富到让小白如我能轻易学会怎么构建一个可以进行调试的测试版本app, 所以借助AI, 找到了一个至少能看到界面的方案:</p><ul><li>使用pixi创建一个虚拟环境(在我的机器上必须这么做, 否则下一步会提示文件无权限复制的错误)<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Sylens Wong &lt;qiumin14@163.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>]</span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;fydeos_dev&quot;</span></span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-64&quot;</span>]</span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[activation.env]</span></span><br><span class="line"><span class="attr">PATH</span> = <span class="string">&quot;$PIXI_PROJECT_ROOT/libapps/libdot/bin:$PATH&quot;</span></span><br></pre></td></tr></table></figure></li><li><code>pixi shell</code>进入虚拟环境, 然后运行项目自带的<code>kokoro/build</code>脚本完成所有子项目的构建和测试(必须要跑完测试, 测试部分直接写进去了)</li><li>进入<code>terminal</code>目录, 然后将一些这个前端需要, 但是并不在这个项目内的文件复制过来<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> ../node_modules/xterm/css/xterm.css css/ <span class="comment"># 缺少的css</span></span><br><span class="line"><span class="built_in">cp</span> ../nassh/js/* js/ <span class="comment"># 缺少的js脚本</span></span><br><span class="line"><span class="built_in">cp</span> -r ../nassh/_locales ../ <span class="comment"># 缺少的国际语言文件</span></span><br></pre></td></tr></table></figure></li><li>在项目根目录运行<code>npm run start</code>启动http服务, 然后浏览器输入如下地址, 就能看到terminal的前端页面了:<ul><li><code>http://localhost:8080/terminal/html/terminal.html</code>: 主页面</li><li><code>http://localhost:8080/terminal/html/terminal_settings.html</code>: 配置页面</li></ul></li></ul><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/08/upgit_20250821_1755708797.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/08/upgit_20250821_1755708797.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="terminal"></p><p>虽然页面上的一些内容是可以用的, 比如添加ssh配置, 但是基本的核心功能, 如实际进行ssh连接, 都是无法使用的, 因为这只是这个app的前端, 实际的连接&#x2F;终端渲染等内容都不在这里.</p><p>不过, 总算是往前进了一小步~</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> chromeos </tag>
            
            <tag> terminal </tag>
            
            <tag> libapp </tag>
            
            <tag> 终端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我是什么天煞孤星体质么</title>
      <link href="/2025/07/27/%E6%88%91%E6%98%AF%E4%BB%80%E4%B9%88%E5%A4%A9%E7%85%9E%E5%AD%A4%E6%98%9F%E4%BD%93%E8%B4%A8%E4%B9%88/"/>
      <url>/2025/07/27/%E6%88%91%E6%98%AF%E4%BB%80%E4%B9%88%E5%A4%A9%E7%85%9E%E5%AD%A4%E6%98%9F%E4%BD%93%E8%B4%A8%E4%B9%88/</url>
      
        <content type="html"><![CDATA[<p>人无语的时候，真的会笑出来，我的直接领导又又又又又又离职了，为什么这么多又，来来来，我们画个时间线盘一盘，我到底克过多少顶头上司。</p><span id="more"></span><p>部分时间点可能不甚准确，可能偏差了一俩月，但克领导这件事，绝对确有其事…</p><div class="timeline">  <div class="timenode"><div class="meta"><p><p>2017.07-2018.01</p></p></div><div class="body"><ul><li>公司: 天津某生信服务公司</li><li>经过: 我的第一份工作，两个月转正后，我被分配到了专门做个性化的大项目组，然后我的组长，在次年出拿到年终之后就辞职去北京了，然后我就直接向总监管汇报了。之后我18年8月份也跑路了。</li></ul></div></div>  <div class="timenode"><div class="meta"><p><p>2018.08-2018.10</p></p></div><div class="body"><ul><li>公司: 杭州某基因科技公司</li><li>经过: 我的第二份工作，跑到了杭州，当时专程从天津跑到杭州来面试的，组长和部门领导人都非常好，所以决定过来。但是，还没等我过试用期，我的部门直接被拆掉了…</li></ul></div></div>  <div class="timenode"><div class="meta"><p><p>2018.10-2019.04左右</p></p></div><div class="body"><ul><li>公司: 杭州某基因科技公司</li><li>经过: 还是杭州这个公司，部门被拆开后，我被分到了隔壁部门负责算法开发的组，组长是个学数学的海归，人特别好，我还觉得这结果还不错，但是，后面我才知道部门领导对组长并不满意（当然组长从来没抱怨过这些），然后组长在4月份跑路，去做擅长的深度学习了（现在看来…无比正确的决定啊）。组长跑路后，我们组也并没有被合并的计划，我跟另外一个小伙伴快乐的什么正事也不干…还拿了好几个月的工资。但是最终觉得这样下去不是个事，又跑路了…</li></ul></div></div>  <div class="timenode"><div class="meta"><p><p>2019.07-2019.12</p></p></div><div class="body"><ul><li>公司: 杭州某生物科技公司</li><li>经过: 然后来到了，我干的最长的一间公司。招我进来的时候，说是准备招两个人，但是我入职后，一直都没招到下一个，组长说是领导不满意，都被卡掉了（为什么我没被卡呢，因为一些原因，领导没面我）。刚开始还挺开心，当时猛汉王上PC了，我这段时间还攒了电脑，打猛汉王打了100多小时。然后，组长突然就辞职了… 然后，我被老板指派顶替了组长…</li></ul></div></div>  <div class="timenode"><div class="meta"><p><p>2020.04-2021.04</p></p></div><div class="body"><ul><li>公司: 杭州某生物科技公司</li><li>经过: 这一个我具体的时间点记得不是那么清楚，但过程就是这样：首先，这间公司有两个生物信息相关的组，我的组是研发，隔壁组是生产。我继任研发组长后，由于研发向的任务并没有那么多，所以老板并不准备给我的组招人。在后续的一年期间，先是隔壁组的一个后备辞职结婚，然后老板一直对隔壁组的工作进度不是那么满意，矛盾比较多，所以先是组员自己离职，后来老板甚至直接把隔壁组组长也裁了… 甚至老板还找我讨论过这事… Woc这断人事业的事，在加上会让我工作翻倍，我当然说，可以先找接替的，找到再裁嘛… 然而未果… 于是，原本两个部门5个人干活，变成了我生产研发一把抓，然后就被拉去做临床实验申报了…</li></ul></div></div>  <div class="timenode"><div class="meta"><p><p>2022.01-2023.12</p></p></div><div class="body"><ul><li>公司: 杭州某生物科技公司</li><li>经过: 是的，居然还是这间公司… 干的久，克的人也就多。在接手申报工作后，人手明显是不够用了，早上九点半到晚上十二点，工作也难以干完，于是22年开始，开始允许我招人。印象中最多的时候，组里加我一共能到5人，然后因为申报并不顺利，资金链实在困难，在领导的要求下开始裁人… 缩减到3各人… 在此期间老板招我聊过人选，我从保证稳定的角度出发，因为我觉得有个组员明显有跑路的倾向，但是老板从能力的角度触发… 没有采纳我的方案… 于是果不其然，23年1月，组里就只剩下2个人…阿门。好在后续申报总算是成功，拿到了下一步投资，公司总算没黄。不然我就要达成克老板的成就了… 然后我自己在申报成功后离职了…</li></ul></div></div>  <div class="timenode"><div class="meta"><p><p>2024.04-2025.01</p></p></div><div class="body"><ul><li>公司: 杭州某医学科技公司</li><li>经过: 来到了现在的公司，是的故事并没有结束… 还是熟悉的配方。还算平静的度过了第一个半年，到了今年，部门突然就绷了，先是有同事被迫离职，然后我的部门领导自己辞职了… 不过这次有点不一样，我来的时候，部门里本来就是一个行政领导，一个技术领导，辞职的是行政领导。</li></ul></div></div>  <div class="timenode"><div class="meta"><p><p>2025.01-2025.07</p></p></div><div class="body"><ul><li>公司: 杭州某医学科技公司</li><li>经过: 终于走到了现在的时间线，又过了有惊无险的半年后，本周，技术领导也跟我说，他准备辞职了… 我，无语的笑了出来…</li></ul></div></div></div><p>嗯，纵观我的整个职业生涯，我真是克了领导克同事，克完同事还能差点把公司克黄… Emmmm，这都是什么个事…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生物信息 </tag>
            
            <tag> 职场 </tag>
            
            <tag> 离职 </tag>
            
            <tag> 职业生涯 </tag>
            
            <tag> 杭州 </tag>
            
            <tag> career </tag>
            
            <tag> job-hopping </tag>
            
            <tag> bioinformatics </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用AI的能与不能----两次失败的尝试</title>
      <link href="/2025/07/15/AI%E8%83%BD%E5%81%9A%E5%92%8C%E4%B8%8D%E8%83%BD%E5%81%9A%E7%9A%84-%E4%B8%A4%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%B0%9D%E8%AF%95/"/>
      <url>/2025/07/15/AI%E8%83%BD%E5%81%9A%E5%92%8C%E4%B8%8D%E8%83%BD%E5%81%9A%E7%9A%84-%E4%B8%A4%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%B0%9D%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<p>相比俩年前在前司，现在的我用AI更加频繁了。如果说之前限制我使用AI的是工具本身的便捷性，现在的限制似乎已经不在AI，而是我自己的知识和技术了。</p><span id="more"></span><p>上周末做了两个尝试，一是尝试用Aider和Openhands帮我修改Theia的remote模块。因为根据AI的回答，Theia的设计是完全前后端分离的，前端只显示，后端则负责处理一切请求。如果这是正确的，那么开发一个在Browser版本的Theia中可以使用的remote版本应该是可行的。而有了这个，就能永久的解决我在Fydetab Duo上用VScode的痛点—-图形性能不足导致VScode过卡了。</p><p>然而，虽然两个Agent都能给我一定的指引，但是没有Node.js &#x2F; Electron的基本知识，只靠Agent写的代码和回答，我无法了解Agent写的代码是否靠谱，由于我也不知道应该如何调试Theia这么大型的Node.js项目，我也无法根据一些报错来判断问题是什么。最后就是，以我的知识和技术，依然无法在AI指导下完成开发。</p><p>另外一个尝试还是想解决一样的问题，只不过我换了一个方向，既然我发构建我要的IDE，那我是否可以设法提升当前Fydetab Duo的图形性能，具体来说，是设法更新内核，让Duo上的FydeOS能支持Vulkan，有了Vulkan，也许VScode的性能可以提升不少。</p><p>然后这个想法还是失败了，AI虽然指引我找到了可能适用于RK3588的新版内核源码，但是我不太看得懂在编译时替换&#x2F;修改内容的描述。于是我尝试了最简单粗暴的方式—-直接替换overlay中的内核项目repo，强行用6.12当原来的6.1来用。我想这最多会有一堆功能不能用吧？然后我想简单了，直接给工程机刷成砖了…</p><p>这么说，也是一样的问题以我的知识和技术，我不知道我在做的到底对不对，也很难从结果中得到有效的改进信息，我只知道这不行，但是，怎样能行呢？以这两年的使用经验，按AI的建议一条条试是不靠谱的，因为其中可能有大量专业人士一眼就知道不对的方案，而我因为什么也不知道，在无穷尽的枚举后，无法得到什么正向反馈。</p><p>所以，我觉得我现在能用到的AI真的是Copilot，不应该指望它来从头实现任何我没有概念东西，而是应该在自己学习和构建了基本的体系，在能获得有效的反馈后（起码能测试和信息丰富的报错后），才有可能最大程度发挥它作为Copilot的作用。</p><p>也就是，从0到1依旧困难，但是起步后，1到10，应该是比过去更容易了。10到100… 我没到100过，还真不知道… 但是我觉得… 这些可能会被上下文长度限制吧。</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AI辅助开发 </tag>
            
            <tag> 技术尝试 </tag>
            
            <tag> Theia </tag>
            
            <tag> FydeOS </tag>
            
            <tag> 内核 </tag>
            
            <tag> aider </tag>
            
            <tag> openfyde </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>再次尝试编译openfyde（下)</title>
      <link href="/2025/06/19/%E5%86%8D%E6%AC%A1%E5%B0%9D%E8%AF%95%E7%BC%96%E8%AF%91openfyde-%E4%B8%8B/"/>
      <url>/2025/06/19/%E5%86%8D%E6%AC%A1%E5%B0%9D%E8%AF%95%E7%BC%96%E8%AF%91openfyde-%E4%B8%8B/</url>
      
        <content type="html"><![CDATA[<p>换了主板和CPU后，一切都顺畅了… 也不知道是原来主板还是CPU的问题，编译几十分钟就会报错，然后再进行编译又不会在上次的地方报错。着还是我人生第一次真遇到硬件不兼容这种问题… 再次活久见。</p><p>于是，编译openfyde的下篇这就来了，可惜在被破硬件折磨的过程中，r132-dev版本的 prebuilt image已经更新了… 没赶上热点呀…</p><span id="more"></span><p>其实我上次已经进行到最后几步了，只是在编译chorme这个庞然大物的时候因为我硬件的问题被卡住了。在完成编译后，就可以生成直接刷写到u盘的镜像了。</p><p>只是这一次我还真解决了一个上次的问题，即得到了<code>chromiumos.bin</code>之后，如何获得能够用Rockchip镜像工具刷写的镜像。按照起步走教程得到的是bin镜像，而官方的预编译都是img，明显格式不同。同时用Rockchip工具对官方的openfyde prebuilt镜像解包的话，似乎会得到一些不包含在bin中的内容。</p><p>其实官方是公布了工具的，它就是<a href="https://github.com/openFyde/rk3588-image-maker">openFyde&#x2F;rk3588-image-maker</a>，只是上次作为一个纯小白，都看不明白编译过程中到底在干些啥，也就更看不明白openfyde下的项目都是些啥了。</p><p>生成所需镜像的步骤很简单，还是先克隆这个项目，然后进根目录，跟着这个项目的说明运行下面的命令就行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从bin中挂载需要的内容</span></span><br><span class="line">./map_chromiumos_image.sh /PATH/TO/CHROMIUMOS/IMAGE.bin --board fydetab_duo</span><br><span class="line"><span class="comment"># 生成 update.img</span></span><br><span class="line">./rk3588-mkupdate.sh</span><br></pre></td></tr></table></figure><p>须注意，在我这次编译的r132版本上，项目下的 <code>Image/parameter.txt</code>文件需要修改，即<code>0xa0006d@0x00b02040(STATE)</code>要改成<code>0xa0006d@0x00b02040(STATE)</code></p><p>之后将生成的image拷贝下来，用rockchip官方工具刷写就好。这次编译的镜像触屏、蓝牙、Linux容器都正常，应该是没什么问题了。</p><p>接下来就可以试着往里头塞东西啦！</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openfyde </tag>
            
            <tag> fydeos </tag>
            
            <tag> 硬件兼容 </tag>
            
            <tag> 编译 </tag>
            
            <tag> 镜像生成 </tag>
            
            <tag> Rockchip </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用github_action编译arm版的theia_ide</title>
      <link href="/2025/06/16/%E4%BD%BF%E7%94%A8github-action%E7%BC%96%E8%AF%91arm%E7%89%88%E7%9A%84theia-ide/"/>
      <url>/2025/06/16/%E4%BD%BF%E7%94%A8github-action%E7%BC%96%E8%AF%91arm%E7%89%88%E7%9A%84theia-ide/</url>
      
        <content type="html"><![CDATA[<p>自从第一次接触chromeos&#x2F;fydeos开始，我就一直在尝试各种不同的 vscode(-like) 编辑器，最近因为看到华为的CodeArt，知道了它的上游项目theia，又开始了折腾。<br>奈何我手上的设备已经是只有8G内存的 fydeos 不是之前的16G Manjaro，也不是PixelBook 2017。在Linux容器下的可用内存十分受限，连编译个arm版的 theiaide-ide browser版都不得行… 那… 只有又来白嫖Github了</p><span id="more"></span><p>这次结合之前提到的 <a href="/2023/07/23/%E7%99%BD%E5%AB%96codespace%E7%94%A8%E6%9D%A5%E5%86%99hexo%E5%8D%9A%E5%AE%A2/" title="白嫖codespace用来写hexo博客">[白嫖codespace写博客]</a> 和 <a href="/2025/04/13/github-actions%E4%BD%BF%E7%94%A8/" title="Github Actions的基本使用">[github action的使用]</a> 。</p><p>首先在github上新建一个项目，然后找到右上角的<code>Code</code>创建该项目的codespace，即可在浏览器中使用vscode，直接进行代码编写和保存。<br>我直接参照之前已经写过的<a href="https://github.com/SilenWang/certimate_win7">certimate_win7</a>项目，创建一个github workflow，注意Runner用Github提供的Arm Runner。</p><p><a href="https://github.com/eclipse-theia/theia-ide">Theia-IDE的原项目</a>还没有正式的Release，所以不能根据Tag下载打包好的Release，改成使用checkout来获得特定的代码。</p><p>然后按照项目下的<a href="https://github.com/eclipse-theia/theia-ide/blob/master/browser.Dockerfile">browser.Dockerfile文件内容</a>，设置编译步骤，接着将整个代码目录打包，上传到我自己项目的<a href="https://github.com/SilenWang/theia-ide-browser-build/releases">Release中</a>。</p><p>下载编译文件后，容器内按照官方的说明安装好系统级别的依赖，<code>yarn browser start</code>就可以启动了。</p><p>因为我是fydeos用，直接编译的browser版，如果需要桌面版本，按照官方的说明生成Arm版就好了。</p>]]></content>
      
      
      <categories>
          
          <category> Script </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FydeOS </tag>
            
            <tag> ChromeOS </tag>
            
            <tag> ARM </tag>
            
            <tag> GitHub Actions </tag>
            
            <tag> Codespaces </tag>
            
            <tag> theia-ide </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>再次尝试编译openfyde（上）</title>
      <link href="/2025/06/15/%E5%86%8D%E6%AC%A1%E5%B0%9D%E8%AF%95%E7%BC%96%E8%AF%91openfyde-%E4%B8%8A/"/>
      <url>/2025/06/15/%E5%86%8D%E6%AC%A1%E5%B0%9D%E8%AF%95%E7%BC%96%E8%AF%91openfyde-%E4%B8%8A/</url>
      
        <content type="html"><![CDATA[<p>今年年初的时候，就尝试编译openfyde，想着学习下编译和修改openfyde系统，也利用一下我多余的一台工程机。然而半年都过去了… 上次编译出镜像的问题都还没解决…</p><span id="more"></span><p>看着最近最新的r132代码也在逐步更新了，那我先… 尝试再编译一次吧… </p><p>本次基本遵循<a href="/2025/01/04/%E7%BC%96%E8%AF%91openfyde/" title="编译openfyde">[之前的步骤]</a>，即装系统依赖，下载<code>depot_tools</code>，克隆代码，进入chroot环境然后开始编译。不同的是，目前 r132 版本的代码应该是还没有完整上传，因此编译中还会碰到一些问题：</p><ul><li><code>chromeos-kernel-6_1-6.1.115-r1676</code>的克隆地址还没有修改，无法获取源代码因此无法编译</li><li><code>libv4lplugins-0.0.1</code>代码还有Bug，需要再加一个补丁修复：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Index: libv4l-rkmpp/src/libv4l-rkmpp.c</span><br><span class="line">===================================================================</span><br><span class="line">--- libv4l-rkmpp.orig/src/libv4l-rkmpp.c</span><br><span class="line">+++ libv4l-rkmpp/src/libv4l-rkmpp.c</span><br><span class="line"></span><br><span class="line">@@ -1206,5 +1206,4 @@</span><br><span class="line"> .init = &amp;plugin_init,</span><br><span class="line"> .close = &amp;plugin_close,</span><br><span class="line"> .ioctl = &amp;plugin_ioctl,</span><br><span class="line">-.mmap = &amp;plugin_mmap,</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure></li></ul><p>目前我的破电脑还在编译着编译着就死机的状态… 回头完成了再更新… </p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openfyde </tag>
            
            <tag> fydeos </tag>
            
            <tag> 系统编译 </tag>
            
            <tag> Linux系统 </tag>
            
            <tag> 补丁修复 </tag>
            
            <tag> chroot环境 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用playwright控制浏览器进行测试</title>
      <link href="/2025/06/09/%E4%BD%BF%E7%94%A8playwright%E6%8E%A7%E5%88%B6%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95/"/>
      <url>/2025/06/09/%E4%BD%BF%E7%94%A8playwright%E6%8E%A7%E5%88%B6%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<p>对于要交互操作的网站，光使用pytest进行API测试是不够的，因为这不涉及前端。以前我使用过Selenium控制浏览器来完成爬虫任务，现在发现测试领域，微软的playwright也能控制浏览器以进行自动化的测试，且使用起来比Selenium还简单，因为它支持自动录制测试用例。</p><span id="more"></span><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>使用pixi可以快速完成playwright的安装，不过安装之后还需要调用playwright来安装浏览器依赖，这一点与Selenium不同，Selenium是直接调用系统中支持的浏览器的。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 firfox和 chromium</span></span><br><span class="line">playwright install --with-deps firefox chromium</span><br></pre></td></tr></table></figure><h2 id="结合Pytest使用"><a href="#结合Pytest使用" class="headerlink" title="结合Pytest使用"></a>结合Pytest使用</h2><p>Playwright支持多种语言，同时还支持Python下的Pytest框架，在命令行中使用<code>playwright codegen -b firefox http://127.0.0.1:8000</code> 打开浏览器后，在录制窗口中选择Pytest，就可以录制Pytest代码了。录制后一个测试会长这样：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">BASE_URL = <span class="string">&#x27;http://127.0.0.1:8000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_add_sample</span>(<span class="params">lab_mem_page</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        lab_mem_page.goto(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/page&quot;</span>, wait_until=<span class="string">&quot;load&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> TimeoutError: <span class="comment"># 如果失败，进行一次重试</span></span><br><span class="line">        lab_mem_page.reload(wait_until=<span class="string">&quot;load&quot;</span>)</span><br><span class="line"></span><br><span class="line">    lab_mem_page.get_by_role(<span class="string">&quot;button&quot;</span>, name=<span class="string">&quot;添加/修改样本&quot;</span>).click()</span><br><span class="line">    lab_mem_page.get_by_role(<span class="string">&quot;menuitem&quot;</span>, name=<span class="string">&quot;添加样本&quot;</span>).click()</span><br><span class="line">    lab_mem_page.get_by_role(<span class="string">&quot;textbox&quot;</span>, name=<span class="string">&quot;*内部编号&quot;</span>).fill(<span class="string">&quot;CODE&quot;</span>)</span><br><span class="line">    lab_mem_page.get_by_role(<span class="string">&quot;textbox&quot;</span>, name=<span class="string">&quot;*住院号&quot;</span>).fill(<span class="string">&quot;6666&quot;</span>)</span><br><span class="line">    lab_mem_page.get_by_role(<span class="string">&quot;textbox&quot;</span>, name=<span class="string">&quot;*姓名&quot;</span>).fill(<span class="string">&quot;2222&quot;</span>)</span><br><span class="line">    lab_mem_page.get_by_role(<span class="string">&quot;textbox&quot;</span>, name=<span class="string">&quot;*性别&quot;</span>).click()</span><br><span class="line">    lab_mem_page.get_by_role(<span class="string">&quot;listitem&quot;</span>).<span class="built_in">filter</span>(has_text=<span class="string">&quot;男&quot;</span>).click()</span><br><span class="line">    lab_mem_page.get_by_role(<span class="string">&quot;button&quot;</span>, name=<span class="string">&quot;提交&quot;</span>).click()</span><br><span class="line">    expect(lab_mem_page.get_by_text(<span class="string">&quot;添加成功&quot;</span>)).to_be_visible()</span><br></pre></td></tr></table></figure><p>完成测试用例后，可以进行测试，然后看是否有内容需要删减和调整。</p><h2 id="利用Pytest的特性"><a href="#利用Pytest的特性" class="headerlink" title="利用Pytest的特性"></a>利用Pytest的特性</h2><p>在结合Pytest使用进行测试时，Pytest的fixture系统以及特殊的<code>conftest.py</code>文件都是可用的，可以像普通Pytest测试一样进行某些信息的共享，以让测试更高效和稳定。</p><h2 id="录制系统的问题"><a href="#录制系统的问题" class="headerlink" title="录制系统的问题"></a>录制系统的问题</h2><p>录制功能确实很大程度上加速了测试的编写，但是自动录制对页面元素的选取不是那么一劳永逸的，尤其当页面上要交互的元素是动态生成的时候。所以要写出稳定的测试用例，还是要懂一些前端知识，能自己找出目标元素在资源树中的唯一定位方式才行。</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 自动化测试 </tag>
            
            <tag> 浏览器测试 </tag>
            
            <tag> playwright </tag>
            
            <tag> pytest </tag>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用pytest进行测试网络API测试</title>
      <link href="/2025/06/09/%E4%BD%BF%E7%94%A8pytest%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%E7%BD%91%E7%BB%9CAPI%E6%B5%8B%E8%AF%95/"/>
      <url>/2025/06/09/%E4%BD%BF%E7%94%A8pytest%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%E7%BD%91%E7%BB%9CAPI%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<p>这半年有相当一部分工作是维护公司的网站，由于是半路接手的代码，难保维护的时候不带来新的bug，因此根据领导的要求，学习了如何进行自动测试。</p><span id="more"></span><p>测试使用的是python下使用最多的测试框架，pytest。</p><p>框架使用非常简单，创建以<code>test_</code>开头的文件，然后在其中编写以<code>test_</code>开头的函数之后，在函数内写测试代码，并加上<code>assert</code>断言就能完成最基本的测试了：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BASE_URL = <span class="string">&#x27;http://127.0.0.1:4567&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_login_success</span>():</span><br><span class="line">    login_data = &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;USER&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;123456&quot;</span>&#125;</span><br><span class="line">    response = requests.post(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/login&quot;</span>, json=login_data)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 断言关键结果</span></span><br><span class="line">    <span class="keyword">assert</span> response.status_code == <span class="number">200</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="string">&quot;accessToken&quot;</span> <span class="keyword">in</span> response.json().get(<span class="string">&quot;data&quot;</span>)</span><br></pre></td></tr></table></figure><p>在实际测试的过程中，我们可能会需要设置一些在不同测试间共用的信息，比如我要测试的API全都是要登录验证才能使用的，因此正好使用pytest的<code>fixture</code>系统，在测试开始前先获取登录token，然后每个测试函数都用同样的token来访问API：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@pytest.fixture(<span class="params">scope=<span class="string">&#x27;session&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prod_admin_auth_header</span>():</span><br><span class="line">    <span class="keyword">return</span> auth_header(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123456&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_get_dictionary_id</span>(<span class="params">prod_admin_auth_header</span>):</span><br><span class="line">    response = requests.get(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/GetDictionaryid&quot;</span>, headers=lab_mem_auth_header)</span><br><span class="line">    <span class="keyword">assert</span> response.status_code == <span class="number">200</span></span><br></pre></td></tr></table></figure><p>这里，被设定为<code>fixture</code>的函数，其函数名可以作为测试函数的参数直接传到测试函数中去，不需要做额外的操作。</p><p>另外还可以在测试文件夹创建一个特殊文件<code>conftest.py</code>，将整个测试需要共享的<code>fixture</code>都放在里面，这样在其他测试文件中，不需要手动导入，也可以直接使用设定过的<code>fixture</code>。</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 自动化测试 </tag>
            
            <tag> pytest </tag>
            
            <tag> python </tag>
            
            <tag> 测试 </tag>
            
            <tag> API测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>活久见...公司服务器被恶意程序攻击了</title>
      <link href="/2025/06/07/%E6%B4%BB%E4%B9%85%E8%A7%81%E5%85%AC%E5%8F%B8%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A2%AB%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F%E6%94%BB%E5%87%BB%E4%BA%86/"/>
      <url>/2025/06/07/%E6%B4%BB%E4%B9%85%E8%A7%81%E5%85%AC%E5%8F%B8%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A2%AB%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F%E6%94%BB%E5%87%BB%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>从我大三（2011）开始玩当时远古版本的Linux Deepin起，到现在已经14年了。这么长的时间中，debian&#x2F;redhat&#x2F;arch系我都用过，但除了研三我自己把我的毕业论文误删了，我从来没有在Linux发行版下碰到过任何恶意程序或病毒。</p><p>然而上个星期，我公司的服务器… 居然中毒了…</p><span id="more"></span><p>起初维护的服务商跟我说我们服务器可能中毒的时候，我还半信半疑，毕竟给我技术支持的人，看上去相当不靠谱。</p><p>我全程看着对方远程操作服务器… 对命令的熟悉程度… 甚至还不如我… 就开着TOP然后一个个翻进程名，甚至过滤用户、按CPU占用排序都不会的样子。还对着TOP问了我几个明显没问题的进程… 并在重启后对着TOP说，看上去没问题呀（看不到CPU还是100%的样子）… 最后捣鼓了半天，只留下一句，可能是挖矿病毒，重装吧，就不回复了…</p><p>虽然我们的数据和系统是分开的，重装还是会让我们花费额外的时间在重新配置上，况且病因都没确定就下药，<del>满足不了我的好奇心</del> 也不一一定就能解决问题不是…</p><p>于是我还是Google了一下先…</p><h2 id="真是挖矿病毒啊"><a href="#真是挖矿病毒啊" class="headerlink" title="真是挖矿病毒啊"></a>真是挖矿病毒啊</h2><p>起初的Google其实也没什么成果，因为除了CPU被100%占用，看不到占用进程这两点符合，<code>netstat</code>没有看到挖矿程序用来连接挖矿池的链接，然后<code>systemctl</code>莫名其妙出了问题，导致我没法安装一些<a href="https://www.lwohvye.com/2021/02/03/%E6%9F%A5%E6%89%BE%E9%9A%90%E8%97%8F%E8%BF%9B%E7%A8%8B%EF%BC%88%E6%AF%94%E5%A6%82%E6%8C%96%E7%9F%BF%E8%BF%9B%E7%A8%8B%EF%BC%89/">博文</a>里说到的软件。</p><p>但是到这时我其实还是没往病毒想，直到我翻到一个博文要用<code>lsattr</code>和<code>chattr</code>查看并修改<code>systemctl</code>的权限，以解决安装软件的问题时，我发现服务器上没有<code>lsattr</code>，同时运行<code>chattr</code>会给一个很奇怪的提示。我当时还想，也许是这个服务器本来没装这俩？</p><p>直到我想起，我们特么还有一台一模一样的服务器呀… 然后登录上去看了看… woc, 另一台服务器是有<code>lsattr</code>和<code>chattr</code>的… 我这才想起翻回去看，出问题的服务器上的<code>chattr</code>是个什么玩意… <code>cat</code>一看，特么这程序明显是被替换了呀！</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749994077.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749994077.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="chattr"></p><p>接着我就反应过来了，特么<code>top</code>&#x2F;<code>htop</code>&#x2F;<code>netstat</code>这些，肯定全部被改了呀！</p><h2 id="发现恶意程序修改以及应对"><a href="#发现恶意程序修改以及应对" class="headerlink" title="发现恶意程序修改以及应对"></a>发现恶意程序修改以及应对</h2><ul><li>lsattr: 直接被删除，无法查看文件状态，用另一台服务器上的文件替换</li><li>chattr: 被替换后，赋予了’i’和’a’，以保证root都无法删除这个文件，无法重新安装chattr进行修复，用另一台服务器上的文件替换</li><li>top&#x2F;htop: 应该被修改过，所以看不到恶意程序进程，top用另一台服务器的替换，htop重装</li><li>systemctl&#x2F;添加服务: 添加了一个启动恶意程序的服务，同时程序被替换后看不到恶意程序服务，用chattr移除不可动权限后重新安装systemd<br><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749994100.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749994100.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="service"></li><li>ls: 被替换后，无法看到恶意程序的可执行文件，以及服务文件，用另一台服务器上的文件替换<br><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749994101.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749994101.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="lsattr"></li><li>reboot: 应该被修改过，发现sha与另一台服务器不一样，用另一台服务器上的文件替换，但是修复回来后，依然不能正常重启</li><li>netstat: 被替换后，无法看到恶意程序开启的网络链接，重装net-tools<br><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749994102.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749994102.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="netstat"></li></ul><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>只能说，果然是见多才能识广，我怎么就没想到，恶意程序也是要进化的… 直接能看它的全修改一遍…<br>另外，我这还… 真干上运维了呀…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux安全 </tag>
            
            <tag> 服务器安全 </tag>
            
            <tag> 恶意程序 </tag>
            
            <tag> 挖矿病毒 </tag>
            
            <tag> 系统工具 </tag>
            
            <tag> linux </tag>
            
            <tag> security </tag>
            
            <tag> malware </tag>
            
            <tag> mining-virus </tag>
            
            <tag> system-tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用aider辅助编程工作</title>
      <link href="/2025/04/25/%E4%BD%BF%E7%94%A8aider%E8%BE%85%E5%8A%A9%E7%BC%96%E7%A8%8B/"/>
      <url>/2025/04/25/%E4%BD%BF%E7%94%A8aider%E8%BE%85%E5%8A%A9%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<p>今年的deepseek着实让LLM又火了一把，虽然在chatGPT之后，copilot和cursor就一直在到处打广告，但是我其实一直没试过… 于是在今年，我… 试了试<a href="https://cline.bot/">Cline</a>，确实好用，但是也符合我的固有印象，没有那么方便，尤其是，我更需要一个能直接在命令行使用并能够快速迁入脚本的选项，以批量完成一些简单的编码初始化业务，于是我找到了<a href="https://aider.chat/">aider</a>…</p><span id="more"></span><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>软件安装比较简单，因为是一个python项目，使用pip就可以安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install aider-install</span><br><span class="line">aider-install</span><br></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>aider是一个CUI应用，输入aider就能进入。Aider 支持一系列以 <code>/</code> 开头的聊天命令，这些命令可以帮助你更高效地管理代码编辑任务、切换模式以及与代码库进行交互。以下是一些常用的命令及其功能：</p><ul><li>文件管理命令<ul><li><code>/add</code>：将文件添加到聊天会话中，以便 Aider 可以编辑或详细审查这些文件。</li><li><code>/drop</code>：从聊天会话中移除文件，释放上下文空间。</li><li><code>/ls</code>：列出所有已知文件，并指示哪些文件已包含在聊天会话中。</li></ul></li><li>编辑与代码操作命令<ul><li><code>/code</code>：请求对代码进行更改，如果没有提供提示信息，则切换到代码模式。</li><li><code>/diff</code>：显示自上次消息以来的更改差异。</li><li><code>/commit</code>：提交在聊天之外对代码库所做的更改（可选提交信息）。</li><li><code>/undo</code>：撤销 Aider 执行的最后一次 Git 提交。</li></ul></li><li>模式切换命令<ul><li><code>/chat-mode</code>：切换到新的聊天模式。</li><li><code>/architect</code>：进入架构师&#x2F;编辑模式，使用两种不同的模型进行代码设计或编辑。</li><li><code>/ask</code>：询问有关代码库的问题，而不编辑任何文件。</li></ul></li><li>其他实用命令<ul><li><code>/clear</code>：清除聊天历史记录。</li><li><code>/copy</code>：将上次助手的消息复制到剪贴板。</li><li><code>/model</code>：切换到新的语言模型。</li><li><code>/help</code>：获取有关 Aider 使用的帮助信息。</li><li><code>/exit</code> 或 <code>/quit</code>：退出 Aider 应用程序。</li></ul></li></ul><h2 id="嵌入shell脚本"><a href="#嵌入shell脚本" class="headerlink" title="嵌入shell脚本"></a>嵌入shell脚本</h2><p>作为CUI程序，aider 也有直接从命名行运行的方式，通过指定参数，然后直接将 prompt 写在命名行中，就可以（这方式还挺类似<code>ssh</code>）。</p><h3 id="用例1–批量翻译博客"><a href="#用例1–批量翻译博客" class="headerlink" title="用例1–批量翻译博客"></a>用例1–批量翻译博客</h3><p>因为可以通过命令行运行，aider也就可以方便的潜入到shell中，批量完成一些工作量不太大的问题，比如将过过去的博客都翻译一遍…</p><p>虽然在chatGPT刚火的时候，我就想过用它来完成翻译，但是实际操作后才发现，手动工作量仍然不小。因为我的博客已经有上百个文件了… 每次输入prompt,然后把内容贴近贴出以及进行校对，也还是很繁琐和无趣的工作。</p><p>使用aider，至少能再多偷些懒。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -e </span><br><span class="line"></span><br><span class="line">DIR_A=blog_cn/source/_posts</span><br><span class="line">DIR_B=blog_en/source/_posts</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> `<span class="built_in">ls</span> <span class="variable">$DIR_A</span>/*`; <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 获取文件名（去掉路径部分）</span></span><br><span class="line">    filename=$(<span class="built_in">basename</span> <span class="string">&quot;<span class="variable">$file</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查文件是否存在于目录B</span></span><br><span class="line">    <span class="keyword">if</span> [[ -e <span class="string">&quot;<span class="variable">$&#123;DIR_B&#125;</span>/<span class="variable">$&#123;filename&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;文件 <span class="variable">$&#123;filename&#125;</span> 存在于目录<span class="variable">$&#123;DIR_B&#125;</span>，跳过&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;文件 <span class="variable">$&#123;filename&#125;</span> 不存在于目录<span class="variable">$&#123;DIR_B&#125;</span>，启动aider翻译...&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;开始文稿校对&quot;</span></span><br><span class="line">        aider \</span><br><span class="line">            --no-show-model-warnings --<span class="built_in">yes</span> --no-auto-commits \</span><br><span class="line">            --message <span class="string">&quot;我这里有一篇blog，请把它翻译成英文，然后保存到 <span class="variable">$&#123;DIR_B&#125;</span>/<span class="variable">$&#123;filename&#125;</span> 文件中&quot;</span> \</span><br><span class="line">            <span class="variable">$file</span></span><br><span class="line">    <span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h3 id="用例2–批量生成api测试"><a href="#用例2–批量生成api测试" class="headerlink" title="用例2–批量生成api测试"></a>用例2–批量生成api测试</h3><p>与生成博客类似，根据openapi或者swagger文档理论上可以很快的编写出接口的测试代码，但是如果接口一多，实际写起来还是很麻烦的。这种时候，让aider来读取代码，并预先生成一个测试代码的框架，可以省下不少事情。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> group <span class="keyword">in</span> group1 group2 group3;<span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 获取文件名（去掉路径部分）</span></span><br><span class="line">    pytest=<span class="built_in">test</span>/<span class="variable">$&#123;group&#125;</span>.py</span><br><span class="line">    <span class="built_in">touch</span> <span class="variable">$pytest</span></span><br><span class="line">    aider \</span><br><span class="line">        --no-show-model-warnings --<span class="built_in">yes</span> --no-auto-commits \</span><br><span class="line">        --message <span class="string">&quot;这里有一份api的swagger描述文件 <span class="variable">$&#123;group&#125;</span>.swagger.json ，请根据它的内容，为这个api编写pytest测试脚本，并将写好的测试脚本放到 <span class="variable">$&#123;pytest&#125;</span> 文件中。&quot;</span> \</span><br><span class="line">        data/<span class="variable">$&#123;group&#125;</span>.swagger.json <span class="variable">$pytest</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> aider </tag>
            
            <tag> 自动化 </tag>
            
            <tag> automation </tag>
            
            <tag> AI编程 </tag>
            
            <tag> 命令行工具 </tag>
            
            <tag> 批量处理 </tag>
            
            <tag> AI-assisted programming </tag>
            
            <tag> command-line tool </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Github Actions的基本使用</title>
      <link href="/2025/04/13/github-actions%E4%BD%BF%E7%94%A8/"/>
      <url>/2025/04/13/github-actions%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>在现代软件开发中，持续集成（CI）和持续部署（CD）是提高开发效率和质量的关键实践。<a href="https://github.com/features/actions">GitHub Actions</a> 作为 GitHub 提供的强大自动化工具，能够帮助开发者轻松实现 CI&#x2F;CD 以及更广阔的自动化工作流程。</p><!-- 摘要部分 --><span id="more"></span><h2 id="GitHub-Actions-的作用"><a href="#GitHub-Actions-的作用" class="headerlink" title="GitHub Actions 的作用"></a>GitHub Actions 的作用</h2><p>GitHub Actions 是一个强大的自动化平台，允许开发者在 GitHub 仓库中定义和运行工作流。它可以根据特定的事件（如代码推送、拉取请求、标签发布等）自动执行一系列任务，例如代码构建、测试、部署等。通过 GitHub Actions，开发者可以实现从代码提交到部署的全流程自动化，从而节省时间和精力，减少人为错误。</p><h2 id="GitHub-Actions-的工作流结构"><a href="#GitHub-Actions-的工作流结构" class="headerlink" title="GitHub Actions 的工作流结构"></a>GitHub Actions 的工作流结构</h2><p>GitHub Actions 的工作流由多个部分组成，其中最重要的部分是 jobs 和 steps。</p><h3 id="Jobs"><a href="#Jobs" class="headerlink" title="Jobs"></a>Jobs</h3><p>一个工作流可以包含多个 jobs，每个 jobs 是一个独立的执行单元，可以在不同的环境中运行。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span> <span class="comment"># 工作名称</span></span><br><span class="line">    <span class="attr">runs-on:</span> [<span class="string">ubuntu-latest</span>] <span class="comment"># 运行环境，这里指定的是github hosted runners</span></span><br></pre></td></tr></table></figure><p>runs-on 指定了运行该 jobs 的环境，这里我们使用github准备的最新ubuntu环境。</p><h3 id="Steps"><a href="#Steps" class="headerlink" title="Steps"></a>Steps</h3><p>每个 jobs 可以包含多个 steps，每个 steps 是一个独立的任务，可以执行一系列命令或调用预定义的动作（actions）。预定义的动作可以在<a href="https://github.com/marketplace">github marketplace</a>搜索。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">current</span> <span class="string">tag</span> <span class="comment"># 步骤名称</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">get_tag</span> <span class="comment"># 步骤编号</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">zingimmick/github-action-get-current-tag@v1</span> <span class="comment"># 使用特定的已编写好的步骤</span></span><br></pre></td></tr></table></figure><h2 id="变量传递"><a href="#变量传递" class="headerlink" title="变量传递"></a>变量传递</h2><p>就如同我过去写的生物信息分析流程，不同的步骤之间，常常需要进行信息传递才能完成一项工作。yaml作为简单的配置文件，自然无法实现变量传递，因此我们需要以来github action框架中设置的一些环境变量来完成信息传递。</p><h3 id="跨Steps信息传递"><a href="#跨Steps信息传递" class="headerlink" title="跨Steps信息传递"></a>跨Steps信息传递</h3><p>在steps中执行代码时，可以通过向<code>$GITHUB_OUTPUT</code>这个特殊环境变量追加内容的方式来实现steps间信息传递的作用：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Save</span> <span class="string">info</span></span><br><span class="line">    <span class="attr">id:</span> <span class="string">save_info</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        echo &quot;tag=3&quot; &gt;&gt; $GITHUB_OUTPUT</span></span><br><span class="line"><span class="string"></span><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">info</span></span><br><span class="line">    <span class="attr">id:</span> <span class="string">use_info</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">echo</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.save_info.outputs.tag</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="跨Jobs信息传递"><a href="#跨Jobs信息传递" class="headerlink" title="跨Jobs信息传递"></a>跨Jobs信息传递</h3><p>在jobs中，可以规定将特定步骤的输出传递到jobs输入，方法如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">    <span class="attr">get_info:</span></span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Save</span> <span class="string">info</span></span><br><span class="line">                <span class="attr">id:</span> <span class="string">save_info</span></span><br><span class="line">                <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">                    echo &quot;tag=3&quot; &gt;&gt; $GITHUB_OUTPUT</span></span><br><span class="line"><span class="string"></span>    <span class="attr">outputs:</span></span><br><span class="line">      <span class="attr">tag:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.save_info.outputs.tag</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">use_info:</span></span><br><span class="line">        <span class="attr">needs:</span> [<span class="string">get_info</span>] <span class="comment"># 设定依赖，以获得其他jobs的信息</span></span><br><span class="line">        <span class="attr">steps:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Save</span> <span class="string">info</span></span><br><span class="line">                <span class="attr">id:</span> <span class="string">save_info</span></span><br><span class="line">                <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">                    <span class="string">echo</span> <span class="string">$&#123;&#123;</span> <span class="string">needs.get_info.outputs.tag</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="编译项目并进行发布的例子"><a href="#编译项目并进行发布的例子" class="headerlink" title="编译项目并进行发布的例子"></a>编译项目并进行发布的例子</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">BUILD</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;v*&quot;</span> <span class="comment"># 收到版本tag触发</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> [<span class="string">ubuntu-latest</span>]</span><br><span class="line">    <span class="attr">permissions:</span> <span class="comment"># 需要写release的权限</span></span><br><span class="line">      <span class="attr">contents:</span> <span class="string">write</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span> </span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">current</span> <span class="string">tag</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">get_tag</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">zingimmick/github-action-get-current-tag@v1</span></span><br><span class="line">  </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.get_tag.outputs.tag</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">frontend</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">pixi</span> <span class="string">run</span> <span class="string">front_prod</span></span><br><span class="line">        </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">backend</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">pixi</span> <span class="string">run</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Pack</span> <span class="string">to</span> <span class="string">zip</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">pixi</span> <span class="string">run</span> <span class="string">release</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">ncipollo/release-action@v1.15.0</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">draft:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">generateReleaseNotes:</span> <span class="literal">true</span>  <span class="comment">#自动生成发行说明。</span></span><br><span class="line">          <span class="attr">artifacts:</span> <span class="string">&#x27;$<span class="template-variable">&#123;&#123; github.workspace &#125;&#125;</span>/release/*.zip&#x27;</span></span><br><span class="line">          <span class="attr">tag:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.get_tag.outputs.tag</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">Release</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.get_tag.outputs.tag</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Script </category>
          
      </categories>
      
      
        <tags>
            
            <tag> workflow </tag>
            
            <tag> 持续集成 </tag>
            
            <tag> 自动化 </tag>
            
            <tag> 工作流 </tag>
            
            <tag> github actions </tag>
            
            <tag> ci </tag>
            
            <tag> cd </tag>
            
            <tag> automation </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>编写R中的对象</title>
      <link href="/2025/04/13/%E7%BC%96%E5%86%99R%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1/"/>
      <url>/2025/04/13/%E7%BC%96%E5%86%99R%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1/</url>
      
        <content type="html"><![CDATA[<p>面向对象是编程时一种常用的范式，在我的实际工作中，使用面向对象主要是为了通过继承特性减少重复代码，和将常用数据封装到对象内，避免过多、重复、嵌套的传递参数。</p><!-- 摘要部分 --><span id="more"></span><h2 id="R中不同的对象系统"><a href="#R中不同的对象系统" class="headerlink" title="R中不同的对象系统"></a>R中不同的对象系统</h2><p>是的… R中有不同的对象系统，除了之前接触的S3（如ggplot）和S4（被很多单细胞包采用），还有本次着重说明的R6。</p><p>S3是R语言中最基础、使用最广泛的面向对象系统，采用<strong>泛型函数</strong>实现方法分派。S3的对象，感觉本质上是list的延伸，它的继承比较简单，方法是通过泛型函数来实现的，跟我更熟悉的python中的类型差别较大。</p><p>S4提供更正式的面向对象编程框架，适合需要严格类型检查的复杂应用，它比S3要复杂，且有更全面的继承机制，但是其方法同样是通过泛型函数来实现的。虽然还是跟python中的不太一样，但是有继承，有方法，同时使用S4也能比较方便的使用<code>%&gt;%</code>管道，勉强能用。</p><p>本来我想基于S4来完成我的开发，但是，没想到S4和<code>box</code>居然还<a href="https://github.com/klmr/box/issues/284">有兼容性问题</a>，<code>box</code>的作者2022年就说明，不会兼容S4…</p><p>于是最后，我使用了<code>R6</code>类型，它是第三方的包（又是第三方…），其提供的对象，非常类似python的对象，有继承、有方法，支持<code>box::use</code>，美中不足，还没有找到接入<code>%&gt;%</code>的方法。</p><h2 id="使用R6对象"><a href="#使用R6对象" class="headerlink" title="使用R6对象"></a>使用R6对象</h2><p>R6的具体使用实例如下，方式确实非常类似python，不过R6不需要定义初始化函数。</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">box<span class="operator">::</span>use<span class="punctuation">(</span></span><br><span class="line">    R6<span class="punctuation">[</span>R6Class<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">Person <span class="operator">&lt;-</span> R6Class<span class="punctuation">(</span></span><br><span class="line">    <span class="string">&quot;Person&quot;</span><span class="punctuation">,</span></span><br><span class="line">    public <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span></span><br><span class="line">        name <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">        age <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span></span><br><span class="line">        initialize <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span>name<span class="punctuation">,</span> age<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">            self<span class="operator">$</span>name <span class="operator">&lt;-</span> name</span><br><span class="line">            self<span class="operator">$</span>age <span class="operator">&lt;-</span> age</span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        greet <span class="operator">=</span> <span class="keyword">function</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">            cat<span class="punctuation">(</span><span class="string">&quot;Hello, my name is&quot;</span><span class="punctuation">,</span> self<span class="operator">$</span>name<span class="punctuation">,</span> <span class="string">&quot;and I am&quot;</span><span class="punctuation">,</span> self<span class="operator">$</span>age<span class="punctuation">,</span> <span class="string">&quot;years old.\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用对象</span></span><br><span class="line">person <span class="operator">&lt;-</span> Person<span class="operator">$</span>new<span class="punctuation">(</span><span class="string">&quot;John&quot;</span><span class="punctuation">,</span> <span class="number">30</span><span class="punctuation">)</span> <span class="comment"># 实例化</span></span><br><span class="line">person<span class="operator">$</span>greet<span class="punctuation">(</span><span class="punctuation">)</span> <span class="comment"># 调用方法</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R语言 </tag>
            
            <tag> 面向对象 </tag>
            
            <tag> rlang </tag>
            
            <tag> R6 </tag>
            
            <tag> S3 </tag>
            
            <tag> S4 </tag>
            
            <tag> object-oriented </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用box包管理R脚本的依赖</title>
      <link href="/2025/04/13/%E4%BD%BF%E7%94%A8box%E5%8C%85%E7%AE%A1%E7%90%86R%E8%84%9A%E6%9C%AC%E7%9A%84%E4%BE%9D%E8%B5%96/"/>
      <url>/2025/04/13/%E4%BD%BF%E7%94%A8box%E5%8C%85%E7%AE%A1%E7%90%86R%E8%84%9A%E6%9C%AC%E7%9A%84%E4%BE%9D%E8%B5%96/</url>
      
        <content type="html"><![CDATA[<p>在习惯了python后，使用R进行脚本开发会让人感到十分痛苦，老声长谈的错误回溯不明确问题暂且不谈，当要写的脚本稍微复杂点，需要分文件的时候，才发现R的导入机制也挺蛋疼的…. 还好有<a href="https://klmr.me/box/index.html">box包</a>，可以用类似python的逻辑来进行模块化导入。</p><!-- 摘要部分 --><span id="more"></span><h2 id="R中默认的导入方式"><a href="#R中默认的导入方式" class="headerlink" title="R中默认的导入方式"></a>R中默认的导入方式</h2><p>R中自带的导入方式有两种，<code>source</code>和<code>library</code>，前者本质是将指定R文件内的内容全部运行一遍，后者需要将代码打包成R包，安装后才能使用。</p><p>前者在要写的东西相对简单的时候还是比较好用的，但是一旦要实现的功能相对没那么简单，需要多拆几个文件时，就会出现问题了。</p><ol><li><p>命名空间污染：<code>source()</code>会将脚本中的所有对象直接加载到当前环境，为防止冲突，需要额外配置。</p></li><li><p>依赖关系不明确：如果脚本之间存在依赖关系，导入顺序错误会导致错误。</p></li><li><p>后续阅读代码进行维护难度大：从<code>source()</code>的部分，很难看出到底引入了什么，当想找来源代码进行修改时，需要一级一级回溯，非常麻烦。</p></li></ol><p>如果使用<code>library</code>, 每次都要打包非常麻烦不说，命名空间污染和找函数&#x2F;对象来源的问题也是存在的。</p><p>总的来说，R自带的导入虽然能用，但是确实不好用…..</p><h2 id="使用Box"><a href="#使用Box" class="headerlink" title="使用Box"></a>使用Box</h2><p>Python 式模块化：支持 box::use() 语法实现类似 Python 的模块导入机制，使用方式见下：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">box<span class="operator">::</span>use<span class="punctuation">(</span></span><br><span class="line">  plots <span class="operator">=</span> .<span class="operator">/</span>modules<span class="operator">/</span>plot_functions<span class="punctuation">,</span> <span class="comment"># 根据路径导入./modules/plot_functions.R文件</span></span><br><span class="line">  shiny_utils <span class="operator">=</span> shiny<span class="operator">/</span>utils<span class="punctuation">,</span> <span class="comment"># 导入文件，并进行对象重命名</span></span><br><span class="line">  ggplot2<span class="punctuation">[</span>ggplot<span class="punctuation">,</span> aes<span class="punctuation">]</span> <span class="comment"># 导入ggplot2中的ggplot和aes</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>这种导入方式跟Python类似的地方在于，它一可以导入一个R文件中的特定内容，而不用全部引入，同时，它也可以想Python一样导入整个文件的内容到一个对象，然后通过<code>mod$func()</code>这样的方式来调用对象中的函数，实现python中使用对象内方法一样的使用方式。</p><p>除了上面的优势，使用<code>box</code>还可以实现相对路径解析，自动识别项目根目录，替代避免使用<code>setwd()</code>不停切换目录，这种使用方式也考虑了跨平台兼容，它可以自动统一处理 Windows&#x2F;Linux&#x2F;macOS 路径格式差异。</p><p>最后，使用<code>box</code>，也能解决导入时的溯源问题，不论是使用<code>mod$func()</code>还是<code>ggplot2[ggplot, aes]</code>这样的部分导入，都能一眼看出来使用函数&#x2F;对象的来源，避免在一堆文件中翻来翻去。</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R语言 </tag>
            
            <tag> 模块化开发 </tag>
            
            <tag> box包 </tag>
            
            <tag> 代码管理 </tag>
            
            <tag> rlang </tag>
            
            <tag> box </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>编译openfyde</title>
      <link href="/2025/01/04/%E7%BC%96%E8%AF%91openfyde/"/>
      <url>/2025/01/04/%E7%BC%96%E8%AF%91openfyde/</url>
      
        <content type="html"><![CDATA[<p>综合官方说明、论坛文章的内容，整理编译Fydetab duo的openfyde镜像的方法, 目标是编译最新的R120版本镜像</p><!-- 摘要部分 --><span id="more"></span><p>Fyde OS官方原本准备了国内的加速镜像，但是现在似乎已经不可用了，因此完成以下内容需要自备梯子</p><h2 id="系统准备"><a href="#系统准备" class="headerlink" title="系统准备"></a>系统准备</h2><ul><li>编译系统为Ubuntu 22.04, AMD Ryzen 5 1600 Six-Core @ 12x 3.2GHz, 64G</li><li>安装必要软件: <code>sudo apt-get install git gitk git-gui curl xz-utils python3-virtualenv python3-oauth2client lvm2 thin-provisioning-tools repo</code></li><li>安装<code>depot_tools</code>:<ul><li>克隆项目: <code>git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git &amp;&amp; cd depot_tools &amp;&amp; git checkout e121d14b12412e95ac833cfd31602b674499ea25</code></li><li>设置环境变量: <code>export PATH=/mnt/hdd1/chromeos/openfyde/depot_tools:$PATH</code></li><li>可以同时设置<code>export DEPOT_TOOLS_UPDATE=0</code>避免工具更新，网络稳定也可以不设置</li></ul></li></ul><h2 id="Api-Key准备"><a href="#Api-Key准备" class="headerlink" title="Api Key准备"></a>Api Key准备</h2><ul><li>由于我在Fydeos 下使用的还是Google账户，所以申请google api key，不申请fydeos的，步骤见<a href="https://www.chromium.org/developers/how-tos/api-keys/">官方说明文档</a></li><li>大致步骤:<ul><li>加入chromium-dev开发群组</li><li>登录<code>https://cloud.google.com/console</code></li><li>创建新项目，例如openfyde</li><li>选择API服务 &gt; 库，查找下面的所有API项目，逐一启用<ul><li>Cloud Search API</li><li>Google Drive API</li><li>Safe Browsing API</li><li>Time Zone API</li></ul></li><li>进入API服务 &gt; 凭据，根据提示先配置Oauth信息，然后创建凭据 &gt; 创建 OAuth 客户端 ID，应用类型我选择了桌面应用（没有文档描述的Others）</li><li>创建凭据 &gt; 创建 API密钥，获得密钥</li><li>保存客户端ID、客户端密钥、API密钥三个信息，按照下面方式存储到<code>~/.googleapikeys</code>文件中  <figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;google_api_key&#x27;: &#x27;your api key&#x27;,</span><br><span class="line">&#x27;google_default_client_id&#x27;: &#x27;your client id&#x27;,</span><br><span class="line">&#x27;google_default_client_secret&#x27;: &#x27;your client secret&#x27;,</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="源代码获取"><a href="#源代码获取" class="headerlink" title="源代码获取"></a>源代码获取</h2><ul><li>创建目录: <code>mkdir -p r120/openfyde</code></li><li>配置Git，否则克隆代码会报错:  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;sylens&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;silenseek14@gmail.com&quot;</span></span><br></pre></td></tr></table></figure></li><li>克隆源代码: R126版本的<code>openFyde/manifest.git</code>未更新，只能编译R120，<code>repo sync -j8</code>这里需要下载大量源代码内容，其中chromium最大，接近40G。如果网络问题导致下载失败，再次运行会重新下载，请确定梯子流量充足。  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">repo init -u https://chromium.googlesource.com/chromiumos/manifest.git --repo-url https://chromium.googlesource.com/external/repo.git -b release-R120-15662.B</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openFyde/manifest.git openfyde/manifest -b r120-dev</span><br><span class="line"><span class="built_in">ln</span> -snfr openfyde/manifest .repo/local_manifests</span><br><span class="line">repo <span class="built_in">sync</span> -j8</span><br><span class="line"><span class="built_in">cd</span> openfyde/chromium</span><br><span class="line">gclient <span class="built_in">sync</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="进入chroot环境"><a href="#进入chroot环境" class="headerlink" title="进入chroot环境"></a>进入chroot环境</h2><ul><li>回到<code>r120</code>这一层目录，运行<code>cros_sdk</code>，开始下载sdk并准备环境, 该过程时间较久</li></ul><h2 id="开始编译"><a href="#开始编译" class="headerlink" title="开始编译"></a>开始编译</h2><ul><li>由于当前版本archero无法使用，为避免报错，需要修改文件</li><li>进入chroot后，默认处在<code>/mnt/host/source/src/scripts</code>，需要修改的文件有:<ul><li><code>/mnt/host/source/src/overlays/overlay-fydetab_duo-openfyde/metadata/layout.conf</code>: 将第一行的<code>archero</code>、<code>tablet</code>、<code>ai-dev</code>删除</li><li><code>/mnt/host/source/openfyde/overlays/overlay-fydetab_duo-openfyde/profiles/base/parent</code>: 将其中第二行的<code>archero:base</code>删除</li></ul></li><li>注意: 编译的相关命令，都在chroot内执行</li><li>运行<code>setup_board --board=fydetab_duo-openfyde</code><ul><li>看上去设置工作没有全部完成, 但是目标目录已生成</li></ul></li><li>安装<code>capnproto</code>: <code>sudo emerge capnproto</code></li><li>修改<code>/mnt/host/source/chromite/lib/dlc_allowlist.py</code>: 第14行修改为<code>DLC_FACTORY_INSTALL = (r&quot;termina-dlc&quot;, r&quot;sample-dlc&quot;,)</code>, 即加入<code>r&quot;termina-dlc&quot;</code></li><li>继续运行<code>cros build-packages --jobs=4 &#39;--board=fydetab_duo-openfyde&#39; --no-withautotest --autosetgov --no-use-any-chrome</code></li><li>运行完成后构建镜像<code>cros build-image --board=fydetab_duo-openfyde --noenable_rootfs_verification</code></li></ul><h2 id="编译过程中的其他问题"><a href="#编译过程中的其他问题" class="headerlink" title="编译过程中的其他问题"></a>编译过程中的其他问题</h2><ul><li><p>编译异常中断: 遇到过一次异常中断，中断后直接进入环境再编译会有莫名其妙的问题，要从头开始需要删除<code>chroot</code>以及<code>out</code>文件夹，然后再次<code>cro_sdk</code>后从头再来。</p></li><li><p>虚拟硬盘设置: 经过<a href="https://community.fydeos.com/t/topic/48326/14">论坛大佬提示</a>，还需要进行一项设置:</p><ul><li>打开<code>/etc/sysctl.conf</code>添加<code>vm.max_map_count=524288</code></li><li>运行<code>sudo sysctl -p</code></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openfyde </tag>
            
            <tag> Linux </tag>
            
            <tag> chromeos </tag>
            
            <tag> fydeos </tag>
            
            <tag> 开发环境 </tag>
            
            <tag> 编译 </tag>
            
            <tag> Fydetab duo </tag>
            
            <tag> Chromium OS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于FydeTab Duo的碎碎念</title>
      <link href="/2024/09/24/%E5%9C%A8%E6%90%AD%E8%BD%BDFydeOS%E7%9A%84FydetabDuo%E4%B8%8A%E7%94%A8Pixi%E9%85%8D%E7%BD%AE%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83/"/>
      <url>/2024/09/24/%E5%9C%A8%E6%90%AD%E8%BD%BDFydeOS%E7%9A%84FydetabDuo%E4%B8%8A%E7%94%A8Pixi%E9%85%8D%E7%BD%AE%E5%B7%A5%E4%BD%9C%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<!-- 摘要部分 --><span id="more"></span><p>我当初参加<a href="https://www.indiegogo.com/projects/fydetab-duo--2">Indintogo上的众筹</a>时，已经在纯Linux的电脑上学习&#x2F;工作至少六年了。主役系统换了又换：Ubuntu、Linux Deepin（现在的Deepin OS的远古版本，当时是Ubuntu的下游）、Linux Mint、Manjaro。</p><p>Manjaro一轮下来最不容易出问题，且持续更新的系统了。却也免不了在升级后碰上依赖爆炸，导致重要工作软件打不开，耽误工作。</p><p>故，在看过FydeOS的网站后，有了再次尝试用一台稳定、不崩溃的”上网本”来工作的想法。毕竟不论从计算稳定，还是从信息保密角度，将全部的生物信息分析工作放在服务器或者云端，是更理想的解决方案。本地机器只要具备连通到服务器的最基本工具（SSH），然后能最低限度的处理文档、表格和幻灯，便足矣。</p><p>于是当时抱着一点点支持新国产方向的想法，参加了Fydetab的众筹。并在等待中开始了解ChromeOS系统，甚至后来真的用Chromebook 2017工作了整整一年。</p><p>经历漫长的等待后，在2024年的五月份，我终于拿到2024版本的Fydetab Duo，一台使用RK3588s处理器的开源平板，正式用上了FydeOS系统（其实2个月前已经从咸鱼淘到了二手工程版就是）。</p><p>老实来讲，即使不与完整的Linux发行版做比，只单单比较ChromeOS，这块开源平板上的FydeOS目前也存在一些令人难受的问题。</p><p>其中一部分来向自于Linux子系统。目前最大的问题有二，一是子系统有概率会在黑屏重点亮后，失去网络连接，一旦失去，我需要重启子系统内的网络服务，以及重启虚拟机。我没找到这个问题的规律，并且重启虚拟机很多时候会需要三五分钟。这就比较恼人，因为子系统内可能正跑着一个计算进程，然后在等待的时候，我会进行一些程序编译和其他环境准备的工作，而这些工作很多时候都需要网络。如果这时候，网络突然抽风了…..T T</p><p>另外一部分，就来自于硬件了，我目前拥有两个版本的FydeTab，一个是红色的工程版，一个是灰色的2024正式版。两个版本磁吸键盘套上的触控板都会被识别成鼠标，无法使用ChromeOS下的一系列手势，让已经用了一年ChromeOS的我非常不习惯。同时触控板的灵敏度有待调整，当前及其容易误触，打字的时候鼠标老乱动，同样的问题在Chromebook 2017在不曾出现过。</p><p>不过即使如此，公司还在，设备也拿到手了已实属不易，只希望后续能慢慢把这些问题都解决掉了。</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FydeOS </tag>
            
            <tag> pixi </tag>
            
            <tag> FydeTab Duo </tag>
            
            <tag> Linux子系统 </tag>
            
            <tag> Chromebook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fydetab duo 下使用 pixi部署hexo博客</title>
      <link href="/2024/08/04/fydetab-duo-%E4%B8%8B%E4%BD%BF%E7%94%A8-pixi%E9%83%A8%E7%BD%B2hexo%E5%8D%9A%E5%AE%A2/"/>
      <url>/2024/08/04/fydetab-duo-%E4%B8%8B%E4%BD%BF%E7%94%A8-pixi%E9%83%A8%E7%BD%B2hexo%E5%8D%9A%E5%AE%A2/</url>
      
        <content type="html"><![CDATA[<!-- 摘要部分 --><span id="more"></span><p>Fydetab duo 也拿到了一个多月了，目前还在持续想办法把设备用起来的阶段。最起码，我希望能用这个设备来抽空谢谢博客。因此有了下面的折腾。</p><!-- 摘要部分 --><!-- more --><p>老实说，fydeos作为中国版本的chromeos，推荐的使用linux方法本应该是直接使用linux子系统的。但是在这一个月内，linux子系统似乎还存在一些影响使用的问题，比如唤醒后会莫名其妙的连不了网、子系统内鼠标显示不正常、子系统启动相对慢等比较影响使用的小毛病。加之fydeos团队对宿主系统的限制暂时还是比chromeos宽松的（至少使用sudo不需要切tty），因此我还是尝试在宿主系统部署我需要的工具。</p><h2 id="安装pixi"><a href="#安装pixi" class="headerlink" title="安装pixi"></a>安装pixi</h2><ul><li>安装<code>pixi</code>需要进行额外的环境变量配置，因为chromium os体系下，不是所有地方都可以存放并运行可执行文件，只有<code>/usr/local/share</code>下可以，因此需要在环境变量文件中增加下面的内容，然后再运行<code>curl -fsSL https://pixi.sh/install.sh | bash</code></li></ul><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/usr/local/share/pixi/bin:$PATH</span><br><span class="line">export PIXI_HOME=/usr/local/share/pixi</span><br></pre></td></tr></table></figure><h2 id="安装code-server和git"><a href="#安装code-server和git" class="headerlink" title="安装code-server和git"></a>安装code-server和git</h2><p>原本首选的是微软官方给的<code>vscode-cli</code>工具，但可能是因为fydeos的文件结构和环境配置跟一般linux发行版还是有比较大的差异，因此实际上连接到服务时，会一直卡在下载vscode服务端的步骤，无法实际使用，因此暂时使用pixi安装<code>code-server</code></p><p>另外fydeos的宿主系统已经自带了</p><h2 id="arm平台特殊配置"><a href="#arm平台特殊配置" class="headerlink" title="arm平台特殊配置"></a>arm平台特殊配置</h2><ul><li>fydeos tab是arm架构的设备，所以<code>pixi</code>的配置中需要增加<code>linux-aarch64</code>平台，同时实际测试下来yarn安装以来会出现无法识别子环境的python问题，因此fydetab duo不使用yarn，用回npm，同时由于fydeos中默认并没有<code>make</code>、<code>gcc</code>、<code>gxx</code>这些，因此也要将这些内容补充到<code>linux-aarch64</code>的依赖中</li><li>fydeos的系统信息文件与常规linux有小差别，这会导致hexo的模块解析系统信息时错误，导致<code>hexo -v</code>和会调用它的<code>hexo g</code>无法运行，因此需要在部署任务中增加修复的语句</li></ul><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[target.linux-aarch64.tasks]</span></span><br><span class="line"><span class="attr">build_blog</span> = &#123;cmd = <span class="string">&quot;npm install -g hexo-cli &amp;&amp; npm install --python=$PWD/.pixi/envs/default/bin/python2 &amp;&amp; sed -i &#x27;34s/distro\\[1\\]/distro/&#x27; $PWD/.pixi/envs/default/lib/node_modules/hexo-cli/dist/console/version.js&quot;</span>, cwd = <span class="string">&quot;.&quot;</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="克隆代码并部署"><a href="#克隆代码并部署" class="headerlink" title="克隆代码并部署"></a>克隆代码并部署</h2><p>要额外进行的配置就是这些了，把项目克隆下来直接部署，就可以继续写博客了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/SilenWang/silen_blog</span><br><span class="line">pixi run build_blog</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FydeOS </tag>
            
            <tag> hexo </tag>
            
            <tag> arm </tag>
            
            <tag> Fydetab Duo </tag>
            
            <tag> Linux环境配置 </tag>
            
            <tag> pixi </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用新的R语言jupyter内核解决monocle3无法在notebook上选发育起始点的问题</title>
      <link href="/2024/06/23/%E4%BD%BF%E7%94%A8%E6%96%B0%E7%9A%84R%E8%AF%AD%E8%A8%80jupyter%E5%86%85%E6%A0%B8%E8%A7%A3%E5%86%B3monocle3%E6%97%A0%E6%B3%95%E5%9C%A8notebook%E4%B8%8A%E9%80%89%E5%8F%91%E8%82%B2%E8%B5%B7%E5%A7%8B%E7%82%B9%E7%9A%84%E9%97%AE%E9%A2%98/"/>
      <url>/2024/06/23/%E4%BD%BF%E7%94%A8%E6%96%B0%E7%9A%84R%E8%AF%AD%E8%A8%80jupyter%E5%86%85%E6%A0%B8%E8%A7%A3%E5%86%B3monocle3%E6%97%A0%E6%B3%95%E5%9C%A8notebook%E4%B8%8A%E9%80%89%E5%8F%91%E8%82%B2%E8%B5%B7%E5%A7%8B%E7%82%B9%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>看一看这个草稿的创建时间，居然是2024年06月了… 现在都2025年6月了，突然理解了为什么那么多UP主会成为鸽子，挖坑一时爽，填坑火葬场啊… 这篇是我位数不多的纯生物信息内容了…</p><p>问题起因是去年要运行 monocle3 进行拟时间分析，但是分析到最后发现一个很蛋疼的问题，monocle3 中的拟时间轨迹起点，是需要分析者来手动指定的，R代码执行过程中会自动开启浏览器，用户需要在浏览器打开的临时网站中指定起点，然后关闭页面，分析继续进行。</p><p>但是jupyter的<code>irkernel</code>内核并不支持这一特性。也就是说，我无法在juputer notebook中直接完成分析。这一问题在<a href="https://github.com/cole-trapnell-lab/monocle3/issues/179">2019年就被提出过</a>，但是直到我需要进行分析的2024年，5年过去，依然没有解决方案…</p><span id="more"></span><p>不过我当时还真偶然发现了解决方案，因为github给我推荐了一个项目，<a href="https://github.com/jupyter-xeus/">jupyter-xeus</a>，这个项目旨在重新开发一系列Jupyter内核，其中就包括新的R内核，<a href="https://github.com/jupyter-xeus/xeus-r">xeus-r</a>，这个新的内核支持交互模式，可以在运行 monocle3 的时候生成一个链接，用户点进链接完成选点后，再退出页面就能继续分析了。</p><p><code>xeus-r</code> 在conda上就有，用 conda &#x2F; mamba &#x2F; pixi 就能快速安装。安装完后，在jupyter的界面会看到对应的<code>xr</code>内核，选择使用就好</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749994103.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749994103.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="xeus-r"></p><p>需要执行的代码如下：</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>monocle3<span class="punctuation">)</span></span><br><span class="line">cds <span class="operator">&lt;-</span> readRDS<span class="punctuation">(</span><span class="string">&quot;/Your/rds/contain/monocle3/object.RDS&quot;</span><span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span><span class="built_in">browser</span><span class="operator">=</span><span class="string">&quot;firefox&quot;</span><span class="punctuation">)</span></span><br><span class="line">cds <span class="operator">&lt;-</span> order_cells<span class="punctuation">(</span>cds<span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>运行后在单元格下面就可以看见需要打开的链接，打开后，选择起点，再后关闭即可。</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749997047.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2025/06/upgit_20250615_1749997047.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="monocle3"></p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jupyter </tag>
            
            <tag> 单细胞分析 </tag>
            
            <tag> 拟时间分析 </tag>
            
            <tag> monocle3 </tag>
            
            <tag> xeus-r </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>新工具解决老问题----使用pixi进行生物信息环境配置</title>
      <link href="/2024/06/22/%E6%96%B0%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E8%80%81%E9%97%AE%E9%A2%98-%E4%BD%BF%E7%94%A8pixi%E8%BF%9B%E8%A1%8C%E7%94%9F%E7%89%A9%E4%BF%A1%E6%81%AF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
      <url>/2024/06/22/%E6%96%B0%E5%B7%A5%E5%85%B7%E8%A7%A3%E5%86%B3%E8%80%81%E9%97%AE%E9%A2%98-%E4%BD%BF%E7%94%A8pixi%E8%BF%9B%E8%A1%8C%E7%94%9F%E7%89%A9%E4%BF%A1%E6%81%AF%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>生物信息是一门交叉学科，而生物信息学中使用的工具集或技术栈，也是相当的“交叉”，其碎片化的程度，我绝对不亚于Linux发行版… 这也带来了大家都会面临的难题：生物信息分析环境部署。</p><!-- 摘要部分 --><span id="more"></span><h2 id="生信环境部署是个麻烦事"><a href="#生信环境部署是个麻烦事" class="headerlink" title="生信环境部署是个麻烦事"></a>生信环境部署是个麻烦事</h2><p>一般来说，用什么语言做开发，那就部署那个语言的开发环境，然后使用相应的环境&#x2F;包管理软件对库的依赖管理就好了。但是生物信息跟我之前学的医学统计一样，<strong>应用成分极重</strong>，有啥用啥，没有再写… 因此，接触多种语言这种事是<strong>极大概率事件</strong>。就我个人来说，由于前公司的研究领域较前沿… 很多时候都要使用大学里的研究者们遵循<code>会啥用啥</code>—–这一抓到老鼠就是好猫一般的原则写出来的工具。因此，我已经接触过一堆语言了：C、C++、Java、Scala、Perl、Python、R、Go、Julia、Nim、Js… 如果再要算上一些数据库语言、配置文件语法之类的… 数量还能再翻个一倍…</p><p>这么杂乱的技术栈，就让部署和设置生物信息开发环境，或者部署生物信息分析流程成了一件非常繁琐的事情。要知道生物信息学中有相当比例的工具或软件，在一年左右就不一定会再有人去维护了，这意味着软件需要的编译器和库会一直停留在过时的版本，然后逐渐开始和后续版本打架，造成比Linux发行版的跨版本升级更可怕的依赖爆炸问题。然后这个依赖还不是只有一个语言下的工具集会爆炸，是所有语言下的工具集都有爆炸的可能，且由于Python、R等一些脚本语言底层有C，所以还能交叉爆炸… 分分钟搞得人心态爆炸。</p><p>然而… 问题远不止步于此，出于一些大人的原因… 不是所有人都能拿到系统级别的权限，配置环境时仅能使用普通用户的权限，因此一些用发行版的包管理器装个包就能解决的问题，最后可能只能选择将整个软件的依赖从头编译一遍… 这又够人爆炸一个月的了…</p><p>基于前述种种令人恼火的问题，当我第一次知道有<a href="https://anaconda.org/">conda</a>这么个工具的时候，真的是感觉救我狗命啊… 大量的生物信息学软件都已预编译后打包上传，下载解压缩即用，还能自动计算依赖是否打架，保证不同语言下工具的基本使用，简直是太完美了！</p><p>不过用过一周之后就会了解到… 由于基于python，conda的依赖计算速度… 是真的慢，10个左右的工具可能就会算个20分钟了，这在依赖会有问题的时候尤其令人恼火… 约等于跑了20分钟的计算，发现变量名称写得有问题，又没有设好断点，只能从头再来一遍… 可能也就是这个缺点大到影响一般使用，就有人开发了Conda的C++实现：<a href="https://mamba.readthedocs.io/en/latest/user_guide/mamba.html">Mamba</a>，然后又有了<a href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">micromamba</a>，再后来有了今天的主角，<a href="https://pixi.sh/latest/">pixi</a></p><h2 id="pixi简介"><a href="#pixi简介" class="headerlink" title="pixi简介"></a>pixi简介</h2><p>简单来说，pixi是一个为开发者设计的多语言软件包管理程序，目的在于使开发者能够轻松的创建和锁定多语言开发环境，使计算结果更容易被重复。</p><p>pixi的简单使用方法(通过命令行)可以参见它的<a href="https://pixi.sh/latest/">官方文档</a>，这里不多说，因为对我来说主要会用它进行环境部署，会一次性安装一大堆的东西，因此一般都是用配置文件来进行配置的。</p><h2 id="pixi基本使用"><a href="#pixi基本使用" class="headerlink" title="pixi基本使用"></a>pixi基本使用</h2><p>pixi使用<code>toml</code>格式的配置文件(得，又多了一种)，其格式有点类似<code>ini</code>…但是语法更复杂，能支持更多的东西。</p><p>想使用<code>toml</code>来管理的话，安装好pixi后，使用<code>pixi init</code>就可以创建一个管理项目，并在当前目录生成一份配置文件了，刚生成的文件包含如下内容。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;demo&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">description</span> = <span class="string">&quot;Add a short description here&quot;</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;silenwang &lt;silenseek14@gmail.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>]</span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-aarch64&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[tasks]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br></pre></td></tr></table></figure><p>其中已经包含了项目基本信息、任务、依赖这三块最重要，也最主要的内容。任务不使用直接留空就可以了，在依赖块内写上需要的安装的内容（内容将从conda获取），保存后就可以使用<code>pixi install</code> 来安装需要的内容了，安装过程中还会生成一个lock文件，这个文件的作用跟nodejs中npm或yarn生成的lock文件作用类似，用于记录被安装的软件版本。将这个lock文件随项目一起管理，就能保证再次部署时能安装一模一样的依赖，保证软件可运行或计算可重复了。</p><h2 id="多种依赖一次性处理"><a href="#多种依赖一次性处理" class="headerlink" title="多种依赖一次性处理"></a>多种依赖一次性处理</h2><p>pixi的软件虽然主要从conda获取，但是它同时支持从pypi获取python包。如果有conda上没有，但是可以从pypi获取的包，可额外在配置文件中增加pypi区块。区块内的软件将会在conda依赖处理完成后自动从pypi获取软件包并进行安装，获取的包同样会记录到lock文件中。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[pypi-dependencies]</span></span><br><span class="line"><span class="attr">spats-shape-seq</span> = <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure><p>如果还有其他包要单独进行编译安装，或者下载后用脚本进一步处理，则可以使用<code>task</code>特性来设置任务。</p><p>在task块中设置好的任务可以通过<code>pixi run TASK_NAME</code>的方式来进行运行。当前官方虽然没有给在依赖处理完成后，直接运行特定任务的方式，但是可以通过下面的写法来通过任务执行<code>pixi install -a</code>命令以先处理依赖，从而达到在依赖处理完成后自动进行后续编译安装任务的目的：</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;demo&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">description</span> = <span class="string">&quot;Add a short description here&quot;</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;silenwang &lt;silenseek14@gmail.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>, <span class="string">&quot;bioconda&quot;</span>, <span class="string">&quot;milaboratories&quot;</span>, <span class="string">&quot;main&quot;</span>]</span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-64&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[tasks]</span></span><br><span class="line"><span class="attr">install</span> = &#123;cmd = <span class="string">&#x27;pixi install -a&#x27;</span>&#125;</span><br><span class="line"><span class="attr">deploy</span> = &#123;cmd = <span class="string">&#x27;echo &quot;Deploy done&quot;&#x27;</span>, depends-<span class="literal">on</span> = [<span class="string">&quot;instal&quot;</span>] &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">[feature.python3.dependencies]</span></span><br><span class="line"><span class="attr">python</span> = <span class="string">&quot;3.11.*&quot;</span></span><br><span class="line"><span class="attr">pip</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">jupyter</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">ipykernel</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">numpy</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">pandas</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">statsmodels</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">scipy</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">tensorflow</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">keras</span> = <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure><h2 id="多种环境一次性部署"><a href="#多种环境一次性部署" class="headerlink" title="多种环境一次性部署"></a>多种环境一次性部署</h2><p>pixi还支持了多环境一次性部署，大概的写法如下：</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[feature.python3.dependencies]</span></span><br><span class="line"><span class="attr">python</span> = <span class="string">&quot;3.11.*&quot;</span></span><br><span class="line"><span class="attr">pip</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">jupyter</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">ipykernel</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">numpy</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">pandas</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">statsmodels</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">scipy</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">tensorflow</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">keras</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.python2.dependencies]</span></span><br><span class="line"><span class="attr">python</span> = <span class="string">&quot;2.7.*&quot;</span></span><br><span class="line"><span class="attr">pip</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">jupyter</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">ipykernel</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.bioinfo.dependencies]</span></span><br><span class="line"><span class="attr">bwa</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">samtools</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">bedtools</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.rlang.dependencies]</span></span><br><span class="line"><span class="attr">r-base</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">r-irkernel</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">r-ggplot2</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">bioconductor-limma</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[environments]</span></span><br><span class="line"><span class="attr">python3</span> = [<span class="string">&quot;python3&quot;</span>]</span><br><span class="line"><span class="attr">python2</span> = [<span class="string">&quot;python2&quot;</span>]</span><br><span class="line"><span class="attr">bioinfo</span> = [<span class="string">&quot;bioinfo&quot;</span>]</span><br><span class="line"><span class="attr">rlang</span> = [<span class="string">&quot;rlang&quot;</span>]</span><br></pre></td></tr></table></figure><p>即在<code>environments</code>中指定环境的名称，然后使用名字类似<code>[feature.rlang.dependencies]</code>的块来处理环境内的依赖情况。配置好后，使用<code>pixi install -a</code>来安装所有的环境（使用<code>pixi intall</code>只会检查依赖是否有问题，但是不会实际安装）</p><h2 id="环境使用"><a href="#环境使用" class="headerlink" title="环境使用"></a>环境使用</h2><p>pixi虽然使用来自conda的包，但是其环境激活和使用方式却采用了<code>poetry</code>和<code>pipenv</code>的方式，激活环境需要在目录下运行<code>pixi shell</code>，如果有多个环境，则加<code>-e</code>指定环境名。同时pixi也支持<code>pixi run</code>的方式来运行环境内的软件（对，<code>pixi run</code>既用来运行任务，也用来运行环境内命令）。</p><h2 id="举个栗子"><a href="#举个栗子" class="headerlink" title="举个栗子"></a>举个栗子</h2><p>下面的 <code>pixi.toml</code> 来自于一个真实的单细胞分析项目，该项目定义多个环境（<code>rplot</code>、<code>analy</code> 和 <code>label</code>），并在 <code>label</code> 环境中使用了 <code>Seurat</code>、<code>azimuth</code> 等 R 包。与前面提到的情形类似，即使显式声明了 <code>r-BiocManager</code>，依然会遇到 <code>GenomeInfoDbData</code>、<code>BSgenome.Hsapiens.UCSC.hg38</code> 等数据包缺失的问题。因此，我们在 <code>[feature.label.tasks]</code> 中同样配置了四个独立的安装任务，并通过 <code>r_dep</code> 任务将它们串联起来。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Sylens Wong &lt;silenseek14@gmail.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">channels</span> = [<span class="string">&quot;conda-forge&quot;</span>, <span class="string">&quot;bioconda&quot;</span>, <span class="string">&quot;dnachun&quot;</span>]</span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;Single Cell&quot;</span></span><br><span class="line"><span class="attr">platforms</span> = [<span class="string">&quot;linux-64&quot;</span>]</span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[environments]</span></span><br><span class="line"><span class="attr">rplot</span> = [<span class="string">&#x27;kernel&#x27;</span>, <span class="string">&#x27;rplot&#x27;</span>]</span><br><span class="line"><span class="attr">analy</span> = [<span class="string">&#x27;kernel&#x27;</span>, <span class="string">&#x27;analy&#x27;</span>]</span><br><span class="line"><span class="attr">label</span> = [<span class="string">&#x27;kernel&#x27;</span>, <span class="string">&#x27;label&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[feature.kernel.dependencies]</span></span><br><span class="line"><span class="attr">ipykernel</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">r-irkernel</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">jupyterlab</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.rplot.dependencies]</span></span><br><span class="line"><span class="attr">r-ggpubr</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">r-ggforce</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">r-ggh4x</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">bioconductor-complexheatmap</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.label.dependencies]</span></span><br><span class="line"><span class="attr">r-base</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">r-azimuth</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">r-seurat</span> = <span class="string">&#x27;5.2.*&#x27;</span></span><br><span class="line"><span class="attr">r-SeuratObject</span>  = <span class="string">&#x27;5.0.*&#x27;</span></span><br><span class="line"><span class="attr">r-BiocManager</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">r-SeuratDisk</span> = &#123;version = <span class="string">&quot;*&quot;</span>, channel = <span class="string">&quot;dnachun&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">[feature.label.tasks]</span></span><br><span class="line"><span class="attr">GenomeInfoDbData</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;GenomeInfoDbData\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">BSgenome</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;BSgenome.Hsapiens.UCSC.hg38\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">EnsDb</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;EnsDb.Hsapiens.v86\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">JASPAR2020</span> = &#123;cmd = <span class="string">&#x27;Rscript -e &quot;BiocManager::install(\&quot;JASPAR2020\&quot;)&quot;&#x27;</span>&#125;</span><br><span class="line"><span class="attr">r_dep</span> = &#123;cmd = <span class="string">&#x27;echo &quot;bio dep for R done&quot;&#x27;</span>, depends-<span class="literal">on</span>=[<span class="string">&#x27;GenomeInfoDbData&#x27;</span>, <span class="string">&#x27;BSgenome&#x27;</span>, <span class="string">&#x27;EnsDb&#x27;</span>, <span class="string">&#x27;JASPAR2020&#x27;</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">[feature.analy.dependencies]</span></span><br><span class="line"><span class="attr">snakemake</span> = <span class="string">&#x27;9.8.*&#x27;</span></span><br><span class="line"><span class="attr">python</span> = <span class="string">&#x27;3.11.*&#x27;</span></span><br><span class="line"><span class="attr">jupyter</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">scanpy</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">gseapy</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">gprofiler-official</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">altair</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">scipy</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">pip</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">pandas</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">openpyxl</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">leidenalg</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">numpy</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">loompy</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">pixi-kernel</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">vegafusion-python-embed</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">vegafusion</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">vl-convert-python</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">pypairs</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">harmonypy</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">upsetplot</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[feature.analy.pypi-dependencies]</span></span><br><span class="line"><span class="attr">singler</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="attr">celldex</span> = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tasks]</span></span><br><span class="line"><span class="attr">install</span> = &#123;cmd = <span class="string">&#x27;pixi install -a&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><p>在该配置中，执行 <code>pixi run r_dep</code> 即可自动完成上述四个数据包的安装，从而确保 <code>Seurat</code> 等包能够正常加载所需的基因组注释信息。这种模式可以方便地扩展到其他需要额外数据包的 Bioconductor 依赖场景。</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 依赖管理 </tag>
            
            <tag> conda </tag>
            
            <tag> pixi </tag>
            
            <tag> 生物信息 </tag>
            
            <tag> 环境配置 </tag>
            
            <tag> mamba </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>还活着就是比较累</title>
      <link href="/2023/12/24/%E8%BF%98%E6%B4%BB%E7%9D%80%E5%B0%B1%E6%98%AF%E6%AF%94%E8%BE%83%E7%B4%AF/"/>
      <url>/2023/12/24/%E8%BF%98%E6%B4%BB%E7%9D%80%E5%B0%B1%E6%98%AF%E6%AF%94%E8%BE%83%E7%B4%AF/</url>
      
        <content type="html"><![CDATA[<!-- 摘要部分 --><span id="more"></span><p>过的真的很快…2023已经没有几天了，然而我从8月到12月什么都没写…</p><!-- 摘要部分 --><!-- more --><p>其实这几个月新学的东西还挺多的，不论是工作上还是工作外，但是什么也没来得及整理，估计过段时间会忘掉了… </p><p>所以之前看到某个博主写的确实很对（出处找不到了hhhh），技术博客容易拼命去折腾各种博客框架，炫库的插件等等，而最后在折腾及其他失误的干扰中，忽略了写博客本身。</p><p>我以后也还是要继续坚持记录，不管双链笔记和其他什么多么好用，继续写，继续整理本身，才是最重要的。毕竟公司的事情不存在告一段落，只有忙和更忙，该焦虑还是焦虑，甚至因为生活琐事变多只会越来越焦虑…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术博客 </tag>
            
            <tag> 写作困境 </tag>
            
            <tag> 时间管理 </tag>
            
            <tag> 焦虑 </tag>
            
            <tag> 持续记录 </tag>
            
            <tag> tech-blog </tag>
            
            <tag> writing </tag>
            
            <tag> time-management </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>chromebook折腾报告</title>
      <link href="/2023/08/16/chromebook%E6%8A%98%E8%85%BE%E6%8A%A5%E5%91%8A/"/>
      <url>/2023/08/16/chromebook%E6%8A%98%E8%85%BE%E6%8A%A5%E5%91%8A/</url>
      
        <content type="html"><![CDATA[<p>去年的时候，我突然看躺在床上的杂牌笔记本电脑特别不爽。好歹也是当年1999买回来的（对毕业半年的我来说是非常大件的消费），后续还因为键盘和触控板问题修了两次花了又快又1000块。这么贵重的东西，不给他安排点活，着时对不起自己的血汗钱。于是我又捣鼓起了几年前关注过，但是当时特别不能用的fydeos。这一捣鼓，我才发现，这几年不仅是deepin发展的很快（快到都有钱和时间把做好的框架和UI又推了重来），fydeos也进化了很多，不仅有了android，还有了linux子系统，日常使用突然就变得不再遥远了，于是！我，斥、重、金————————海鲜市场捡垃圾买了个<a href="https://www.lenovo.com/us/en/p/laptops/lenovo/lenovo-edu-chromebooks/lenovo-chromebook-duet-10/zziczctct1x?orgRef=https%253A%252F%252Fwww.google.com%252F">lenovo chromebook duet</a>..</p><!-- 摘要部分 --><span id="more"></span><h2 id="芯片架构于设备可及性"><a href="#芯片架构于设备可及性" class="headerlink" title="芯片架构于设备可及性"></a>芯片架构于设备可及性</h2><p>请不要怀疑我的精神状态，虽然前面的内容和后面的标题看上去像喝了假酒，但这————————都是有逻辑的！<br>首先，我知道fydeos和原版的chromeos已经越来越不一样了，fydeos觉得不错转头跑去买chromebook并不可取，可是fydeos的公司作为一家不主要面对普通消费者，而是主营企业业务的公司，他们并没有太多他们自主设计并长期维护的硬件产品，在我有玩一票这个想法的当时，旧的ITNs设备已经不卖了，fydetab duo只说会有但是众筹都没开，for you版本的二手设备又偏贵一些。所以我最后还是决定接盘个便宜的chromeos平板试试水，毕竟海鲜市场上那叫一个一大堆，好用则自用，不好哪来的卖哪去（然后血亏200）。</p><p>试水设备的选择上，我也考虑了好久，最终才选了arm架构的duet。这主要是为了获得更好的安卓体验。试用fydeos的时候发现，这一类系统下的安卓并不是于宿主系统完全隔离的模拟器，安卓产生的文件从宿主系统重相对方便的读取，宿主系统的文件图片也可以直接右键分享到安卓应用中，比想象的方便很多，另外宿主机的一切设备包括摄像头，都是可以直接被安卓应用调用的，相当于是可以直接运行全功能的安卓应用补足生态问题。然而国内很多应用完全不做x86的适配，导致很多应用打开旧闪退，完全不能用。因此我想，如果买一个arm架构的设备，没准技能直接替代我日常的笔记本，还能更轻薄，岂不美哉。</p><h2 id="设备定位与旧爱新欢"><a href="#设备定位与旧爱新欢" class="headerlink" title="设备定位与旧爱新欢"></a>设备定位与旧爱新欢</h2><p>然而事实证明我真的很容易在电子产品上上手，过去如此，现在如此，未来估计还是如此。</p><p>在上手的两天内，我就感觉到了Chrome duet极大的问题。一个廉价上网本定位的设备，其配置自然不会好到哪里去，虽然arm架构的cpu确实让安卓app能够顺利流畅的打开并运行，但是想要作为一个办公设备试用，同时只能流畅运行一个应用，显然是完全不够看的…chrome duet确实能很好的运行微信与钉钉，但是当我打开浏览器之后，微信和钉钉，必然被干掉一个或者都被干掉，再次唤醒，应用就要重开，然后chrome连切换个标签页都能卡30秒… 这个卡顿程度，就算我领导不觉得我摸鱼，我自己都能急的治好低血压了。4G的内存对一个移动设备来说本来应该不算小，但是就国内应用的这个臃肿程度…感觉已经可以宣告尝试失败了。</p><p>在显而易见的应用问题之外，还有硬件问题。chrome duet是一台二合一的平板，如果只算本体，它的重量和续航甚至比我曾经持有的华为平板更好一些。但是…当加上了键盘套后…设备的总体重量，着时让人疑惑…所以你说轻，它真没多轻。而在打字使用方面，由于是键盘套支架形式的二合一，这个设备并方便直接摆在腿上，因此没有桌子的场景就直接给毙了…感觉失去了一个编写办公社会的灵魂。最最最麻烦的，还有它的尺寸——————————10.1英寸意味着这个设备的配套键盘比一般的笔记本小很多很多。回弹这种东西我从来就不在意，但是让我在10.1英寸的小键盘和14英寸的普通尺寸键盘上来回切换，真的相当折磨，有种NS上玩了赛尔达，然后转头PC上又Xbox手柄打怪猎的那种，重新适应自己刚装上的十指的感觉…</p><p>总之，从硬件到软件都没能完成我预期的duet，最终被我自刀送走了，但是我并没有停止作死。因为即使有上面那么多的问题，我依然在这次试水中发现了一个惊人的事实：我的绝大多数工作，真的只要一个浏览器就能做了。</p><h2 id="我的工作需求"><a href="#我的工作需求" class="headerlink" title="我的工作需求"></a>我的工作需求</h2><p>我是一名生物信息学从业人员，我自己平时工作就四大法宝：</p><ul><li>写脚本的: VScode &#x2F; Jupyter</li><li>抄代码的: Chrome浏览器</li><li>登终端的: 发行版带啥就用啥</li><li>写文件的: WPS &#x2F; Office全家桶</li></ul><p>在跟Duet相杀（没有相爱）期间，我逐渐发现，在Web技术快速进化的今天，以上所有内容，都是可以通过浏览器来实现的。Jupyter和Vscode都能在浏览器运行，Vscode内部有集成的终端模拟器，WPS&#x2F;Office早就开始布局网页端的应用了。</p><p>虽然，有不等于全功能，否则也没有Linux和安卓什么事了，但是相比于chromeos起步的快10年前，已经完善了太多了。就好象我大学第一次用logo还是绿色，活像mint山寨的初版deepin时，linux发行版弄个中文支持都费劲… 现在不仅好多发行版中文有了，软件也多了，要配置的越来越少了，甚至manjaro这种晚steam都能算轻松惬意了…</p><p>所以，我选择继续作，前脚送走了duet，后脚入了pixelbook2017——————————————然后就翻车了（触控板发过来就是坏的，不想继续加钱的我选了个屏幕有亮点的治疗我的强迫症）</p><h2 id="pixelbook2017的应用兼容性"><a href="#pixelbook2017的应用兼容性" class="headerlink" title="pixelbook2017的应用兼容性"></a>pixelbook2017的应用兼容性</h2><p>不同于duet，pixelbook2017，以及其他一众品牌的高配chromebook，都是用intel芯片的（虽然不解但是我也没有办法），于是我就拿着这台外观确实出众（需要自行忽略B面航母跑道和发黄的掌托），但是续航只有宣称的一办的机器，开始了深度使用。</p><p>不出所料，四大法宝都是能相对轻松惬意解决的，但是问题最终还是落在了通讯软件上…和当年的Linux发行办面临的最大问题一毛一样。</p><p>X86架构的Pixelbook虽然可以通过Play安装国际版的微信以及钉钉，但是这两个软件…兼容性毕竟不是太行，一来容易假死，而来很多基于web做的必要功能完全不能用，最后还是得靠linux下的软件来救场。然而Linux又带来的新的问题，小问题是Linux应用不必安卓应用，Linux应用至今调用不了设备的摄像头与宿主机的桌面，性质上更接近虚拟机里单独跑App，大问题则是，如果…我这么的依赖Linux，那么我为什么不直接把chromeos格了，在这个设备上装Manjaro呢？</p><h2 id="So-Why-Dunit"><a href="#So-Why-Dunit" class="headerlink" title="So Why Dunit"></a>So Why Dunit</h2><p>于是兜兜转转，在获得了能用，但是又不那么好用的体验后，我开始怀疑自己，为啥要持有这么一个设备呢？为了装逼么？（不然呢？）</p><p>是图他接口少，图他发热大，还是图他续航比想的拉垮？</p><p>我思考良久，拿起这个1.1kg的本子，对着着这12.3英寸的2.5K屏幕……恩，还是高清的屏幕好呀！</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> chromebook </tag>
            
            <tag> 二合一设备 </tag>
            
            <tag> 安卓应用兼容性 </tag>
            
            <tag> chromeos </tag>
            
            <tag> fydeos </tag>
            
            <tag> arm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用singularity构建一个基于chatglm.cpp项目的ChatGLM2服务</title>
      <link href="/2023/08/16/%E4%BD%BF%E7%94%A8singularity%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8Echatglm-cpp%E9%A1%B9%E7%9B%AE%E7%9A%84ChatGLM2%E6%9C%8D%E5%8A%A1/"/>
      <url>/2023/08/16/%E4%BD%BF%E7%94%A8singularity%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%9F%BA%E4%BA%8Echatglm-cpp%E9%A1%B9%E7%9B%AE%E7%9A%84ChatGLM2%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<p>其实很早之前就知道singularity这个东西了，作为有别于docker，专门为HPC开发的容器，一直都想试试。奈何就像Illumina以外的其他NGS技术一样，singularity虽然没有挂，但是至今都没有什么声量，而且在k8s这种容器集群管理方案被绝大多数云厂商采纳后，singularity要竞争似乎更难了… 当然这跟我现在没什么关系… 咱目前离上云感觉至少还有三五年的距离，因此在本地集群启用这个感觉完全合乎情理。</p><!-- 摘要部分 --><span id="more"></span><p>那么还是从最基础的构建镜像开始，singularity的镜像构建文件（Definition File）和Dockerfile还是很不一样的，不是另一种从前往后执行的脚本，感觉更像是ini这种分区进行配置的配置文件。</p><p>构建一个镜像所必要的关键字包括：</p><ul><li><code>Bootstrap</code>: 用于定义base镜像从哪里来，有多种类型，可以是dockerhub可以是singularity维护的镜像lirary</li><li><code>From</code>: 构建base镜像的名称</li><li><code>%post</code>: 构建镜像时下载文件，安装软件，编译软件等的一系列命令</li></ul><p>鉴于<a href="https://github.com/li-plus/chatglm.cpp">chatglm.cpp</a>本身的依赖做的非常好，其实只要准备好c++编译器，用pip命令就能装了，所以写起来特别简单：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Bootstrap: library</span><br><span class="line">From: debian</span><br><span class="line"></span><br><span class="line">%post</span><br><span class="line">    apt-get update -y &amp;&amp; apt-get upgrade -y</span><br><span class="line">    apt-get install -y cmake gcc g++ pip</span><br><span class="line">    pip install &#x27;chatglm-cpp[api]&#x27;</span><br></pre></td></tr></table></figure><p>除了这些必要的内容，以后可能还用得上的东西包括：</p><ul><li><code>%files</code>：构建时向容器内拷贝文件用的部分</li><li><code>%environment</code>：用于规定换纪念馆变量</li><li><code>%runscript</code>：用于指定使用<code>run</code>子命令运行容器时会使用的脚本</li><li><code>%startscript</code>：用于指定使用<code>instance</code>（似乎是开机启动服务）子命令运行容器时会使用的脚本</li><li><code>%test</code>：指定容器构建完成后在容器内运行的命令（用于检查构建是否完成）</li><li><code>%labels</code>：填写镜像的meta信息</li><li><code>%help</code>：填写镜像的使用说明</li></ul><p>有了def文件，接下来运行命令就可以开始构建（使用fakeroot是使用非root用户构建，还需要作一定设置参见<a href="https://docs.sylabs.io/guides/3.11/user-guide/build_a_container.html#fakeroot-builds">官方文档</a>），构建完成的镜像不像docker是自己存储起来，而是会生成一个sif文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">singularity build --fakeroot chatglm.cpp.singularity.sif build.def</span><br></pre></td></tr></table></figure><p>构建好的镜像用如下命令就可以启用啦：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">singularity <span class="built_in">exec</span> \</span><br><span class="line">   --<span class="built_in">bind</span> model:/model/ \</span><br><span class="line">   --<span class="built_in">env</span> MODEL=/model/chatglm2-ggml.q4_0.bin \</span><br><span class="line">   chatglm.cpp.singularity.sif \</span><br><span class="line">   uvicorn chatglm_cpp.openai_api:app --host 0.0.0.0 --port 8877</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 容器技术 </tag>
            
            <tag> singularity </tag>
            
            <tag> ChatGLM2 </tag>
            
            <tag> chatglm.cpp </tag>
            
            <tag> 容器构建 </tag>
            
            <tag> HPC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用singularity部署Rstudio并指定conda环境下的R</title>
      <link href="/2023/07/26/%E4%BD%BF%E7%94%A8singularity%E9%83%A8%E7%BD%B2Rstudio%E5%B9%B6%E6%8C%87%E5%AE%9Aconda%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84R/"/>
      <url>/2023/07/26/%E4%BD%BF%E7%94%A8singularity%E9%83%A8%E7%BD%B2Rstudio%E5%B9%B6%E6%8C%87%E5%AE%9Aconda%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84R/</url>
      
        <content type="html"><![CDATA[<p>今天需要部署个Rstudio给别人用, 记录一下部署的步骤以及要点</p><!-- 摘要部分 --><span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Rstudio的运行是必须要靠Root权限来运行的, 不能像Jupyter那样conda或者mamba直装, 因此本次的部署使用了Singularity这种容器(也是我第一次实操使用). Sigularity与Docker或者Podmon在设计上有较大的不同, 主要为HPC环境下的应用而生, 权限管理有较大的不同. 不过这些都不太影响本次使用就是. Sigularity的安装在Rocky Linux下比较简单, 我记得是直接包管理器就能安装了, 因此不作记录</p><h2 id="1-容器准备"><a href="#1-容器准备" class="headerlink" title="1. 容器准备"></a>1. 容器准备</h2><p>虽然与Docker是不同的容器技术, Sigularity却提供了完善的Docker镜像兼容支持, 构建好的Docker容器可以很方便的被转换到Sigularity使用的<code>sif</code>格式镜像. 本次部署参考的是<a href="https://github.com/grst/rstudio-server-conda/blob/master/README.md">rstudio-server-conda</a>项目中的说明, 直接使用<code>singularity pull docker://rocker/rstudio:4.2</code>拉取docker镜像转换为<code>sif</code>镜像使用</p><h2 id="2-必要文件准备"><a href="#2-必要文件准备" class="headerlink" title="2. 必要文件准备"></a>2. 必要文件准备</h2><p>使用如下的bash脚本生成需要的若干目录和配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p run var-lib-rstudio-server</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&#x27;provider=sqlite\ndirectory=/var/lib/rstudio-server\n&#x27;</span> &gt; database.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;auth-minimum-user-id=100&quot;</span> &gt; rserver.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;session-default-working-dir=/home/silen/Rstudio/Workspace&quot;</span> &gt; rsession.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;session-default-new-project-dir=/home/silen/Rstudio/Workspace&quot;</span> &gt;&gt; rsession.conf</span><br></pre></td></tr></table></figure><p>这样一来将生成<code>run</code>, <code>var-lib-rstudio-server</code>两个文件夹, 以及<code>database.conf</code>, <code>rserver.conf</code>, <code>rsession.conf</code>三个配置文件. 其中<code>rserver.conf</code>里的<code>auth-minimum-user-id=100</code>配置非常重要, 因为在使用的容器中, Rstudio是以uid为999的rstudio用户来运行的, 如果没有这个用户或者没有切换到该用户的权限, 容器无法正常运行. 因此我参考<a href="https://github.com/grst/rstudio-server-conda/pull/18">网上帖子</a>中的说法使用<code>--server-user</code>参数制定用当前用户运行服务.</p><p>然而好巧不巧, 当前用户的uid小于513, 而<code>auth-minimum-user-id</code>这一参数默认为1000, 即禁止用户uid小于1000的用户运行服务(似乎是出于安全考虑). 因此就需要在<code>rserver.conf</code>里变更参数数值, 来让服务能正常的启动.</p><h2 id="3-指定参数启动容器"><a href="#3-指定参数启动容器" class="headerlink" title="3. 指定参数启动容器"></a>3. 指定参数启动容器</h2><p>使用如下命令启动服务即可, 运行的命令主要是将前面创建的目录和配置文件绑定到容器中供服务读取, 另外就是指定了ip与端口方便访问. 由于是担任使用, 就没有弄验证的东西了. 另外还参照<a href="https://github.com/grst/rstudio-server-conda/blob/master/README.md">rstudio-server-conda</a>项目中的内容制定了使用的conda环境, 这样就不用在容器中重复安装R包了.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">singularity <span class="built_in">exec</span> \</span><br><span class="line">   --<span class="built_in">bind</span> run:/run \</span><br><span class="line">   --<span class="built_in">bind</span> var-lib-rstudio-server:/var/lib/rstudio-server \</span><br><span class="line">   --<span class="built_in">bind</span> database.conf:/etc/rstudio/database.conf \</span><br><span class="line">   --<span class="built_in">bind</span> rserver.conf:/etc/rstudio/rserver.conf \</span><br><span class="line">   --<span class="built_in">bind</span> rsession.conf:/etc/rstudio/rsession.conf \</span><br><span class="line">   --<span class="built_in">bind</span> /home/silen/R-Plot:/etc/R-Plot \</span><br><span class="line">   --<span class="built_in">env</span> CONDA_PREFIX=/etc/R-Plot  \</span><br><span class="line">        --<span class="built_in">env</span> RSTUDIO_WHICH_R=/etc/R-Plot/bin/R \</span><br><span class="line">   rstudio_4.2.sif \</span><br><span class="line">   /usr/lib/rstudio-server/bin/rserver --www-address=0.0.0.0 --www-port=7788 --server-user=$(<span class="built_in">whoami</span>)</span><br></pre></td></tr></table></figure><p>启动后界面如下:</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2023/07/upgit_20230727_1690390228.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2023/07/upgit_20230727_1690390228.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="ui"></p><h2 id="4-注意"><a href="#4-注意" class="headerlink" title="4. 注意"></a>4. 注意</h2><p>Sigularity感觉上会更类似snap和flathub这种软件打包的项目, 宿主机和容器间并不是被那么完全的被隔开. Rstudio启动后, 直接可以访问到宿主机用户的Home目录, 不知道这是这个容器的特殊表现还是Sigularity都是如此? 之后我们需要对内部的分析流程做依赖梳理和容器话… 看来还需要更多的了解Sigularity的原理和使用方式.</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> conda </tag>
            
            <tag> 容器技术 </tag>
            
            <tag> singularity </tag>
            
            <tag> Rstudio部署 </tag>
            
            <tag> conda环境 </tag>
            
            <tag> rstudio-server </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>白嫖codespace用来写hexo博客</title>
      <link href="/2023/07/23/%E7%99%BD%E5%AB%96codespace%E7%94%A8%E6%9D%A5%E5%86%99hexo%E5%8D%9A%E5%AE%A2/"/>
      <url>/2023/07/23/%E7%99%BD%E5%AB%96codespace%E7%94%A8%E6%9D%A5%E5%86%99hexo%E5%8D%9A%E5%AE%A2/</url>
      
        <content type="html"><![CDATA[<p>最近出于…..emmmmmm心有不甘？我卖掉了之前拍的lenovo chrome duet2，但是转头又买了pixelbook 2017…..既然设备到手了，还是想要继续折腾一阵，力求找到用这台pixelbook 2017代替我的工作电脑进行一般办公的方式。然后找着找着，主要矛盾没解决，倒是诞生了几个实用的副产品…. 使用codespace写hexo博客是其一。</p><span id="more"></span><h2 id="在哪都能写博客啦"><a href="#在哪都能写博客啦" class="headerlink" title="在哪都能写博客啦"></a>在哪都能写博客啦</h2><p>Github codespace本来是云时代，github推出的一项纯云开发服务，这个服务可以为用户分配一个容器（可以自定义），然后直接将github上的项目代码拉入到容器中，给用户分配一个可以访问容器内容的vscode web客户端，这样就能直接在github提供的服务器上直接进行代码的编写和调试，也就是完全在云端进行开发了。项目的实现我猜和<a href="https://github.com/googlecreativelab/coder">coder</a>类似。</p><p>这么好的东西，当然不会是免费的，目前github提供15G的免费空间，以及120h的核心时间（<a href="https://docs.github.com/zh/billing/managing-billing-for-github-codespaces/about-billing-for-github-codespaces">详细见官方</a>）。这个存储和时间看上去不多，但是根据目前的使用来看，核心时间应该是不作计算就不算的，因此如果是非常轻量的项目，其实还是很充裕的。</p><p>这不就正适合用来写博客嘛！</p><p>我的Hexo博客代码量还没用的主题多，需要的计算也就是生成一下静态网页，要不了几秒。云上操作还能解决以前的博客只能在办公电脑上写的窘境（只有办公电脑我配置了环境，懒得再来一次），打开即用。而且试了一下，<code>hexo s</code>生成的静态网页预览甚至都可以正常访问！这样就能跟那种博客平台一样，有浏览器就能写啦～（虽然我鸽显然不是因为没有设备能写</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/2023/07/upgit_20230723_1690102891.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/2023/07/upgit_20230723_1690102891.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="ui"></p><h2 id="使用上的问题"><a href="#使用上的问题" class="headerlink" title="使用上的问题"></a>使用上的问题</h2><p>目前唯二的问题就是网络以及博客内的图片管理了。</p><h3 id="1-图片问题"><a href="#1-图片问题" class="headerlink" title="1. 图片问题"></a>1. 图片问题</h3><p>原来写博客用过<a href="https://picgo.github.io/PicGo-Doc/zh/guide/">picgo</a>和<a href="https://github.com/pluveto/upgit">upgit</a>两个工具进行图片上传和自动链接获取，目前实测下来，原本最方便的vscode-picgo插件并不能使用，即使安装<code>xclip</code>后，也识别不到剪贴板里的图像内容，大概是因为它是在云端容器中，而有图像的剪贴板，是我本地的吧… <code>upgit</code>倒是有办法使用，将软件下载到chromeos下的linux容器中，做好配置就可以了。 </p><h3 id="2-网络"><a href="#2-网络" class="headerlink" title="2. 网络"></a>2. 网络</h3><p>这个问题不用多说… 国外的服务想访问到都有一样的问题，目前来说编辑器的部分其实还好，应为不是即时响应的，因此码字相当流畅…就是不知道会不会写着写着发现保存不了。</p><p>但是命令行的部分还是感觉得到明显卡顿的，好在命令行也不多，就是个<code>hexo g</code>和<code>hexo d</code>，忍一忍也就过去了，大不了就现在不发布，改天再说嘛。</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> 云端开发 </tag>
            
            <tag> 博客写作 </tag>
            
            <tag> Github </tag>
            
            <tag> Codespace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在chatGPT的指导下写一个调用chatGPT的API进行文献解析的工具</title>
      <link href="/2023/03/27/%E5%9C%A8chatGPT%E7%9A%84%E6%8C%87%E5%AF%BC%E4%B8%8B%E5%86%99%E4%B8%80%E4%B8%AA%E8%B0%83%E7%94%A8chatGPT%E7%9A%84API%E8%BF%9B%E8%A1%8C%E6%96%87%E7%8C%AE%E8%A7%A3%E6%9E%90%E7%9A%84%E5%B7%A5%E5%85%B7/"/>
      <url>/2023/03/27/%E5%9C%A8chatGPT%E7%9A%84%E6%8C%87%E5%AF%BC%E4%B8%8B%E5%86%99%E4%B8%80%E4%B8%AA%E8%B0%83%E7%94%A8chatGPT%E7%9A%84API%E8%BF%9B%E8%A1%8C%E6%96%87%E7%8C%AE%E8%A7%A3%E6%9E%90%E7%9A%84%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<p>这个标题有点点套娃… 但是事实确实如此. 在之前认识到chatGPT确实能比较好的回答代码问题之后, 我突然觉得我行了! 我终于有可能做全栈了! 于是为了展示chatGPT加持下的个人实力, 我准备写个用chatGPT读论文的程序(其实有考虑用这个辅助做meta分析)!</p><!-- 摘要部分 --><span id="more"></span><h2 id="开始挖坑"><a href="#开始挖坑" class="headerlink" title="开始挖坑"></a>开始挖坑</h2><p>大概是两个星期前想到做这个东西的, 之前注册了号, 试用它辅助写了一个带token验证的静态服务, 后面就看到了同事分享的<a href="https://www.chatpdf.com/">chatPDF</a>, 以及同事说他靠chatGPT来快速阅读文献并写综述. 当时我就回忆起了在这里工作三年看文献的痛苦, 想着何不开发个工具用chatGPT加速我的阅读呢? 以来辅助自己工作, 而来有了demo可以蹭热度, 要是收获个几十上百的star, 那我也离自己想了很久的全栈独立开发者又更近了. 加之之前做不了是因为很多东西从头学根本没那个时间和能力, 现在有chatGPT辅助那还不是事半功倍?</p><h2 id="各种踩坑"><a href="#各种踩坑" class="headerlink" title="各种踩坑"></a>各种踩坑</h2><p>然后说干就干!(三分钟热度最擅长这个), 我想着有了此等外挂, 开发个简单的demo还不就三两天的事? 然后这两周就开始各种踩坑….</p><h3 id="想给钱都这么难…"><a href="#想给钱都这么难…" class="headerlink" title="想给钱都这么难…"></a>想给钱都这么难…</h3><p>我也没想到, 第一个坑居然是付钱… 之前新注册的OpenAI账号都会送30刀的免费API额度用于体验, 但可能是用户太多… 后面就减少甚至不送了… 我当时注册完… 账号上就是一个子没有的… 核心功能的API调用不了那怎么行… 就只能自掏腰包解决了… 吗? 还真没有这么简单, 因为OpenAI是不对中国大陆开发服务的… 因此我的Visa卡都没法登记… 只能办虚拟信用卡… 然后这个虚拟信用卡… 我也不知道它到底是不是个合法玩意… 最大的Depay要求用一种虚拟货币充值??? 虚拟货币我听着就发憷… 不敢乱碰, 最后只能找了个首付金额大, 但是我能直接付款的(多的钱大不了之后买塞尔达了…), 才解决了问题(最后好像还是靠钱解决了), 充上值, 开始开发!</p><p>emmmmmm, 然后此时已经过了半天…. </p><h3 id="chatGPT当前的局限性"><a href="#chatGPT当前的局限性" class="headerlink" title="chatGPT当前的局限性"></a>chatGPT当前的局限性</h3><p>chatGPT能执行各种各样的任务, 但是这改变不了它是一个文本生成AI的事实, 它本质上的功能是生成一段通顺的, 最好是没有错误的自然语言文字. 我在初期使用它的时候确实比较少碰到问题(可能是问题简单), 但是随着使用频率上升, 出问题的频率和严重程度就越来越大了… 总的来说, 我感觉由于我问的过于泛泛, 或者是我问的一些问题并不可能有答案, 因此会收到它的各种胡说八道的答案. 这会产生两个问题:</p><ol><li><p>实际开发时并没有想的那么飞速, 因为我好死不死采用了一个非常新的开发框架(<code>Pynecone</code>), 它的介绍很美好, 一次开发, 前端&#x2F;后端&#x2F;API全部都有, 多平台快捷部署. 然而由于太新, chatGPT完全不能给我任何建议, 我还是得自己学习文档和官方的示例来完成必要功能的实现. 而且在一些很基本的功能上都花了非常多的时间…</p></li><li><p>让chatGPT稳定的执行特定的任务不是一件那么简单的事情… 而且我用的是<code>gpt-3.5-turbo</code>(起步时还没有4, 当然现在我也排不上队), 因此并不如gpt4那样能轻易指定返回答案格式(我想用json格式返回便于解析). 所以说…面向prompts编程… 还真不是一句玩笑… 要使用得好, 调试prompts还是非常必要的</p></li></ol><p>总之, chatGPT很强, 但… 即使是gpt4, 我相信也没有微软宣传片里的那么强… 要使用得顺畅, 还是要具备使用的技巧, 把自己变成chatGPT的形状(误</p><h3 id="开发框架切换"><a href="#开发框架切换" class="headerlink" title="开发框架切换"></a>开发框架切换</h3><p>接前文… <code>Pynecone</code>真的是还不成熟… 导致我在一个半星期后真的受不了了, 还是切到了<code>Gradio</code>… 怎么说呢… 工具和框架的马太效应不要随意违背啊… 尤其是我本意是蹭热度, 那就更是应该找最快的实现方式, 切忌想太多</p><h3 id="HuggingFace你罪大恶极"><a href="#HuggingFace你罪大恶极" class="headerlink" title="HuggingFace你罪大恶极!"></a>HuggingFace你罪大恶极!</h3><p>虽然只是句玩笑, 但是我真的没想到… 我会在demo的上线卡了整整一个下午加一个晚上, HuggingFace是很好的平台(一个space提供8核16G, 这什么石油佬开的慈善平台), 但是你这个新建项目不让全空真的是为难我这种小白…</p><p>我经历了手动合并冲突, 强制推送代码, 最后还是妥协选择把原项目的代码和传到HuggingFace的分开弄了… 这个问题上我真的问题都问不到点, 没从chatGPT上获得什么有效的帮助…</p><h3 id="时间不够用"><a href="#时间不够用" class="headerlink" title="时间不够用"></a>时间不够用</h3><p>屋漏偏逢连夜雨, 说多了都是泪, 该肝还是要肝… (在成为国宝的路上一去不复返</p><h2 id="chatGPT带来的帮助"><a href="#chatGPT带来的帮助" class="headerlink" title="chatGPT带来的帮助"></a>chatGPT带来的帮助</h2><p>虽然前面也吐槽了chatGPT也没有那么的好用, 但是它带来的增益还是实打实的, 在这个项目中对我的帮助包括但不限于:</p><ol><li>帮忙解读类似的开源代码, 让我快速了解别人的实现方式</li><li>解答Gradio的各种使用问题(成熟的工具就能给出很多实用建议)</li><li>帮助生成英文README(然而还是没人看)</li><li>增加”我能做到!”的信心</li></ol><h2 id="体会到”独立”开发的痛苦"><a href="#体会到”独立”开发的痛苦" class="headerlink" title="体会到”独立”开发的痛苦"></a>体会到”独立”开发的痛苦</h2><p>这两周我也深刻体会过独立开发者的, 或者说个人自媒体的痛苦了… 同样是文献阅读辅助, <a href="https://github.com/kaixindelele/ChatPaper">chatPaper</a>项目和我的内容都是两周前开始陆续在github上开始披露代码的(当然我的不是披露, 是做一点就传一点…), 现在人家已经是4000+star了… 我特么最开始构想的两个功能和基本的app页面才刚完成… 对方是6个中科院的博士… 我…</p><p>这感觉大概就是兴致冲冲干自媒体, 然后视频发出来没人看时候的焦虑感了吧…</p><h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p>不过不管如何, 项目本身的目的之一就是开发自己觉得好用的东西… 热度要是蹭不到… 那就罢了吧… 我的项目叫 <a href="https://github.com/SilenWang/ReviewGPT">ResearchGPT</a>, <a href="https://huggingface.co/spaces/SilenWang/ReviewGPT">Demo</a>挂在了Huggingface上, 有兴趣可以试用哟~ 当然这个博文也做了Demo的嵌入就是了…</p><div style="display:flex;justify-content:center;align-items:center;overflow:scroll">   <iframe          src="https://silenwang-reviewgpt.hf.space"          frameborder="0"          width="850"          height="700"   ></iframe></div>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> ChatGPT </tag>
            
            <tag> API开发 </tag>
            
            <tag> 文献解析 </tag>
            
            <tag> 独立开发 </tag>
            
            <tag> Gradio </tag>
            
            <tag> HuggingFace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>chatGPT确实好用</title>
      <link href="/2023/02/23/chatGPT%E7%A1%AE%E5%AE%9E%E5%A5%BD%E7%94%A8/"/>
      <url>/2023/02/23/chatGPT%E7%A1%AE%E5%AE%9E%E5%A5%BD%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>chatGPT火了这么久, 我昨天才正式因为想用它生成一些东西才弄了个号, 就像网上很多人说的, 虽然在专业问题上他确实可能是大忽悠, 但是对于写代码来说, 反正我最后是要自己跑和自己测试的, 实践出真知, 给个大致正确的方向也好呀!</p><!-- 摘要部分 --><span id="more"></span><p>这个问题的背景是这样:</p><ul><li>我用<code>mkdocs</code>生成了一份公司内容用的技术文档(就像我手册的那种), 这是一个静态网页, 因此加上一个http服务器就能直接看了</li><li>我想把这个文档使用<code>iframe</code>嵌入到现有的系统中</li><li>由于这个文档比较重要, 所以有一定的保密需求, 所以这个文档不可以直接访问, 需要有一定验证</li></ul><p>经过与IT同时讨论, 最终讨论方案时, 他首次请求的时候给我一个token, 我用这个token去他给的API里做一个验证, 返回是true了再给内容. 我自己只会基本的flask和fastAPI, 然后flask用起来更简单一点, 所以小结下来, 我需要写这么个程序:</p><ul><li>用flask构建一个和python下simple http.server有同等功能的http服务器, 他能让用户访问mkdocs创建好的静态网站</li><li>这个服务器需要有验证更能, 即接受请求中的token后去进行验证, 判断用户是不是合法用户</li><li>第一次验证之后, 在静态网站内部跳转的请求是这个服务自己来处理的, 因此要持续验证的话需要我自己设法保存token, 然后自己完成验证</li></ul><p>我之前虽然有使用过flask和dash, 但是对web相关的技术其实基本是没有太多概念的, 之前测试caddy反代理的经验让我觉得上面这个程序肯定是能实现的, 但是具体怎么实现, 则没有太多实际想法, 而同时跟我说的自己保存token也是明白意思, 不明白如何操作的</p><p>这时就是chatGPT起作用的地方了, 我按照我的理解进行了大致的描述, 询问如何编写我想要的代码. 它并没有给我一个完全符合我要求的结果, 但是给了我一个代码示例, 让我可以边测试边猜这个程序应该怎么写, 然后对于不懂的地方则追加询问, 或者要求专门讲解, 它给的回答不说完全正确(当然也有我问的不明确的问题), 但是在讨论的过程中我确实逐步找到了我想要的实现方案.</p><p>最后我一个上午就完成了这个简单的程序, 虽然程序简单, 但是如果放在以前, 我自己可能先要找好几个中文网页看看有没有现成的例子可以参考, 然后猜一下英文的描述方法, 再在stackoverflow上翻阅10个左右的英文帖子, 找寻我想要的部分问题的答案, 然后自己尝试组出一个能用的方案… 这个过程不能说很痛苦, 毕竟是阅读学习的过程, 但是效率上来说肯定不咋样…</p><p>而现在只要我能基本描述清楚我要什么, chatGPT就可以直接给我一段代码示例让我来调试和学习, 等于节省了绝大部分查中文材料和英文材料的时间, 直接跳到用例子来调试, 效率上无疑是质变的…</p><p>瞬间感觉借助它学个前端的一招半式… 自己写网站和App不是梦了…</p><h4 id="update20220227"><a href="#update20220227" class="headerlink" title="update20220227"></a>update20220227</h4><p>今天chatGPT的请求过多,暂时没法使用了(不知道付费用户们如何), 看来还是早用早享受… 玩了可能免费使用都莫得了…</p><div class="note "><p><strong>附: 关于这个问题的完整对话过程</strong></p><h4 id="You"><a href="#You" class="headerlink" title="You:"></a>You:</h4><p>如何使用flask搭建一个使用token进行验证的http 服务器?</p><h4 id="ChatGPT"><a href="#ChatGPT" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>要使用 Flask 搭建一个使用 token 进行验证的 HTTP 服务器，您可以使用 Flask 的 <code>Flask-JWT</code> 扩展。此扩展为 Flask 应用程序提供了 JSON Web Token（JWT）身份验证机制。</p><p>下面是一个简单的 Flask 应用程序示例，用于验证用户 token：</p><p>首先安装所需的扩展：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install Flask</span><br><span class="line">pip install Flask-JWT</span><br></pre></td></tr></table></figure><p>接下来，编写 Flask 应用程序代码，如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, request</span><br><span class="line"><span class="keyword">from</span> flask_jwt <span class="keyword">import</span> JWT, jwt_required, current_identity</span><br><span class="line"><span class="keyword">from</span> werkzeug.security <span class="keyword">import</span> safe_str_cmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义用户类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, <span class="built_in">id</span>, username, password</span>):</span><br><span class="line">        self.<span class="built_in">id</span> = <span class="built_in">id</span></span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户列表</span></span><br><span class="line">users = [</span><br><span class="line">    User(<span class="number">1</span>, <span class="string">&#x27;user1&#x27;</span>, <span class="string">&#x27;password1&#x27;</span>),</span><br><span class="line">    User(<span class="number">2</span>, <span class="string">&#x27;user2&#x27;</span>, <span class="string">&#x27;password2&#x27;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 authenticate 和 identity 方法</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">username, password</span>):</span><br><span class="line">    <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">        <span class="keyword">if</span> user.username == username <span class="keyword">and</span> safe_str_cmp(user.password.encode(<span class="string">&#x27;utf-8&#x27;</span>), password.encode(<span class="string">&#x27;utf-8&#x27;</span>)):</span><br><span class="line">            <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">identity</span>(<span class="params">payload</span>):</span><br><span class="line">    user_id = payload[<span class="string">&#x27;identity&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">next</span>((user <span class="keyword">for</span> user <span class="keyword">in</span> users <span class="keyword">if</span> user.<span class="built_in">id</span> == user_id), <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Flask 应用程序实例</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 JWT 密钥</span></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;super-secret&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 JWT 对象</span></span><br><span class="line">jwt = JWT(app, authenticate, identity)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建受保护的路由</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/protected&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@jwt_required()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">protected</span>():</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;user_id&#x27;</span>: current_identity.<span class="built_in">id</span>, <span class="string">&#x27;username&#x27;</span>: current_identity.username&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行应用程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>在这个应用程序中，我们定义了一个 <code>User</code> 类来表示用户，然后创建了一个用户列表 <code>users</code>，其中包含两个用户的用户名和密码。我们还定义了 <code>authenticate</code> 和 <code>identity</code> 方法，用于在验证时查找用户。</p><p>在 Flask 应用程序实例中，我们设置了一个 SECRET_KEY，并创建了一个 JWT 对象。我们还定义了一个受保护的路由 <code>/protected</code>，只有在用户提供有效的 JWT 令牌时才能访问该路由。</p><p>最后，我们运行 Flask 应用程序。当您访问 <code>/protected</code> 路由时，您将需要提供有效的 JWT 令牌才能访问该路由。</p><h4 id="You-1"><a href="#You-1" class="headerlink" title="You:"></a>You:</h4><p>这个flask服务器在接收请求时会收到一个token, 我需要用这个token去某个服务器进行验证, 验证通过再返回静态内容出去, 要如何编写呢?</p><h4 id="ChatGPT-1"><a href="#ChatGPT-1" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>要在 Flask 应用程序中使用传入的 token 去验证另一个服务器，您可以使用 Python 的 <code>requests</code> 库，该库可以方便地向其他服务器发送 HTTP 请求并获取响应。</p><p>下面是一个简单的 Flask 应用程序示例，它将收到的 token 发送到其他服务器进行验证，并返回静态内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Flask 应用程序实例</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义验证 token 的方法</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_token</span>(<span class="params">token</span>):</span><br><span class="line">    <span class="comment"># 向其他服务器发送 HTTP 请求进行验证</span></span><br><span class="line">    response = requests.get(<span class="string">&#x27;https://example.com/verify-token&#x27;</span>, headers=&#123;<span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;Bearer &#x27;</span> + token&#125;)</span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建路由</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    token = request.headers.get(<span class="string">&#x27;Authorization&#x27;</span>).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> verify_token(token):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Hello, world!&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Invalid token&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行应用程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>在这个应用程序中，我们定义了一个 <code>verify_token</code> 方法，它将传入的 token 发送到其他服务器进行验证，并根据响应确定该 token 是否有效。我们还定义了一个根路由 <code>/</code>，它将从传入请求的 headers 中获取 token，并将其传递给 <code>verify_token</code> 方法进行验证。</p><p>如果传入的 token 有效，则返回 <code>&#39;Hello, world!&#39;</code>，否则返回 <code>&#39;Invalid token&#39;</code>。</p><p>请注意，此示例仅用于演示目的。在实际应用程序中，您需要将 <code>verify_token</code> 方法与实际的验证逻辑相匹配，并确保使用正确的验证头和其他参数。</p><h4 id="You-2"><a href="#You-2" class="headerlink" title="You:"></a>You:</h4><p>如果我要返回的不是简单的网站, 而是已经生成好了静态网页, 如mkdocs或者gitbook生成好的静态页面, 如何实现呢?</p><h4 id="ChatGPT-2"><a href="#ChatGPT-2" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>如果您要返回已经生成好的静态网页，可以使用 Flask 的 <code>send_from_directory</code> 方法。该方法可用于从特定目录中返回指定的文件，以供客户端下载或查看。</p><p>假设您已经生成了静态网页，并将其存储在 <code>static</code> 目录下的 <code>docs</code> 子目录中，可以使用以下 Flask 应用程序代码来提供该网页：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, send_from_directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Flask 应用程序实例</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建路由</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/docs/&lt;path:filename&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_docs</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">return</span> send_from_directory(<span class="string">&#x27;static/docs&#x27;</span>, filename)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行应用程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>在这个应用程序中，我们定义了一个 <code>serve_docs</code> 路由，它将根据客户端请求的文件名从 <code>static/docs</code> 目录中返回相应的文件。</p><p>例如，如果您要返回 <code>static/docs/index.html</code> 文件，可以使用以下 URL：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:5000/docs/index.html</span><br></pre></td></tr></table></figure><p>请注意，这只是一个基本示例。在实际应用程序中，您可能需要添加其他逻辑，例如身份验证和访问控制，以确保只有授权用户可以访问您的静态网页。</p><h4 id="You-3"><a href="#You-3" class="headerlink" title="You:"></a>You:</h4><p>flask在接收请求的时候如何获取get请求给的参数?</p><h4 id="ChatGPT-3"><a href="#ChatGPT-3" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>在 Flask 中获取 GET 请求的参数非常简单。您可以使用 <code>request.args</code> 对象来获取 GET 请求中的参数。这个对象是一个字典，它包含了 GET 请求中的所有参数和它们的值。</p><p>例如，如果您的 URL 是 <code>http://localhost:5000/search?q=python&amp;page=1</code>，那么您可以使用以下代码来获取 <code>q</code> 和 <code>page</code> 参数的值：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Flask 应用程序实例</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建路由</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/search&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>():</span><br><span class="line">    query = request.args.get(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">    page = request.args.get(<span class="string">&#x27;page&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;Searching for &quot;<span class="subst">&#123;query&#125;</span>&quot; on page <span class="subst">&#123;page&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行应用程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>在这个应用程序中，我们定义了一个 <code>search</code> 路由，它将获取 GET 请求中的 <code>q</code> 和 <code>page</code> 参数，并将它们包含在返回的字符串中。</p><p>请注意，<code>request.args.get</code> 方法返回的是字符串类型。如果您需要获取其他类型的参数值（例如整数或布尔值），则需要进行适当的转换。</p><h4 id="You-4"><a href="#You-4" class="headerlink" title="You:"></a>You:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, send_from_directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Flask 应用程序实例</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建路由</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;path:filename&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_docs</span>(<span class="params">filename</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        filename = <span class="string">&#x27;index.html&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> send_from_directory(<span class="string">f&#x27;static/docs/&#x27;</span>, filename)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行应用程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><h4 id="ChatGPT-4"><a href="#ChatGPT-4" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>这段代码的作用是创建一个 Flask 应用程序，并使用 <code>send_from_directory</code> 方法从 <code>static/docs</code> 目录中返回指定的文件，以响应客户端的请求。这个应用程序监听根路由 <code>&#39;/&#39;</code>，并使用 <code>filename</code> 参数来指定要返回的文件名。</p><p>在这个应用程序中，我们还添加了一些额外的逻辑。如果客户端请求的是根路由 <code>&#39;/&#39;</code>，则默认返回 <code>index.html</code> 文件。</p><p>请注意，如果您使用这个代码示例来返回您自己生成的静态网页，请确保将文件存储在 <code>static/docs</code> 目录中。您可以通过将 <code>static/docs</code> 替换为您存储静态网页的实际目录来修改代码。</p><p>如果您需要实现身份验证和访问控制等更高级的功能，则需要添加更多的逻辑代码。例如，您可以使用 Flask 提供的 <code>login_required</code> 装饰器来要求用户在访问受保护的页面之前进行身份验证。</p><h4 id="You-5"><a href="#You-5" class="headerlink" title="You:"></a>You:</h4><p>上面的代码只能访问static&#x2F;docs&#x2F;下的一级文件, 怎样写能访问子目录下的文件呢</p><h4 id="ChatGPT-5"><a href="#ChatGPT-5" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>如果您想要访问 <code>static/docs</code> 目录及其子目录中的文件，可以将 <code>send_from_directory</code> 函数的第一个参数更改为 <code>static</code>，并将 <code>filename</code> 参数作为子目录和文件名的组合。具体来说，您可以使用 <code>os.path.join</code> 函数将子目录和文件名拼接起来，然后将其作为 <code>send_from_directory</code> 函数的第二个参数。</p><p>以下是一个示例代码，它可以访问 <code>static/docs</code> 目录及其子目录中的所有文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, send_from_directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Flask 应用程序实例</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建路由</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;path:filename&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_docs</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">if</span> filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        filename = <span class="string">&#x27;index.html&#x27;</span></span><br><span class="line">    path = os.path.join(<span class="string">&#x27;static&#x27;</span>, filename)</span><br><span class="line">    <span class="keyword">return</span> send_from_directory(path, filename)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行应用程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>在这个应用程序中，我们定义了一个 <code>serve_docs</code> 路由，它可以处理所有路径的请求，包括子目录和文件名。我们使用 <code>os.path.join</code> 函数将路径中的子目录和文件名组合起来，并将结果传递给 <code>send_from_directory</code> 函数的第一个参数。由于这个函数可以处理子目录，因此它可以在 <code>static</code> 目录中查找任何子目录和文件名的组合。</p><p>请注意，这个代码示例仅提供了基本的路由和文件服务逻辑。如果您需要实现身份验证和访问控制等更高级的功能，您需要在代码中添加相应的逻辑。</p><h4 id="You-6"><a href="#You-6" class="headerlink" title="You:"></a>You:</h4><p>flask中如果请求的是’&#x2F;‘想重定向到’&#x2F;index.html’怎么写?</p><h4 id="ChatGPT-6"><a href="#ChatGPT-6" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>要将根路径 <code>/</code> 重定向到 <code>/index.html</code>，您可以使用 Flask 中提供的 <code>redirect</code> 函数。以下是一个示例代码，它可以实现这个功能：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, redirect</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Flask 应用程序实例</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建路由</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">redirect_to_index</span>():</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&#x27;/index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行应用程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>在这个应用程序中，我们定义了一个名为 <code>redirect_to_index</code> 的路由，它会将根路径 <code>/</code> 重定向到 <code>/index.html</code>。我们使用 Flask 中提供的 <code>redirect</code> 函数来实现重定向。该函数的参数是重定向目标的 URL。</p><p>当客户端请求根路径 <code>/</code> 时，该路由函数将调用 <code>redirect</code> 函数，并将其参数设置为 <code>/index.html</code>。这将导致客户端被重定向到 <code>/index.html</code> 页面。</p><p>请注意，重定向功能是基于 HTTP 协议中的 3xx 状态码实现的。因此，客户端会收到一个状态码为 302（Found）的响应，并被要求重定向到新的 URL。</p><h4 id="You-7"><a href="#You-7" class="headerlink" title="You:"></a>You:</h4><p>请给我一个flask <code>@app.route</code>的使用方法参考文章</p><h4 id="ChatGPT-7"><a href="#ChatGPT-7" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>以下是一些 Flask <code>@app.route</code> 的使用方法参考文章，您可以参考其中的代码和示例：</p><ol><li><a href="https://flask.palletsprojects.com/en/2.1.x/quickstart/#routing">https://flask.palletsprojects.com/en/2.1.x/quickstart/#routing</a></li></ol><p>Flask 官方文档提供了详细的路由使用说明，包括基本路由、动态路由、HTTP 方法、URL 构建和重定向等方面的内容。</p><ol start="2"><li><a href="https://www.pythondoc.com/flask/index.html">https://www.pythondoc.com/flask/index.html</a></li></ol><p>这是一份中文的 Flask 入门教程，其中包括了路由、模板、表单处理、数据库访问等方面的内容。对于初学者来说，这是一个很好的学习资源。</p><ol start="3"><li><a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world">https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world</a></li></ol><p>这是一篇英文的 Flask 教程，其中包括了从简单的 “Hello, World!” 程序到复杂的 Web 应用程序开发的全部过程。其中的第二部分介绍了路由的基本使用方法。</p><ol start="4"><li><a href="https://auth0.com/blog/flask-by-example-series-part-1-new-to-flask-should-i-stay-or-should-i-go/">https://auth0.com/blog/flask-by-example-series-part-1-new-to-flask-should-i-stay-or-should-i-go/</a></li></ol><p>这是一系列的英文博客文章，旨在通过示例演示 Flask 的各种功能。其中的第一篇文章介绍了路由的基本使用方法，并提供了一些示例代码。</p><p>希望这些参考文章能够对您学习 Flask 路由的使用方法有所帮助。如果您还有其他问题，请随时提问。</p><h4 id="You-8"><a href="#You-8" class="headerlink" title="You:"></a>You:</h4><p>如何使用flask建立一个类似python下simple https.erver的服务器, 可以自动访问建立好的静态网站?</p><h4 id="ChatGPT-8"><a href="#ChatGPT-8" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>要使用 Flask 建立一个类似 Python 下的 SimpleHTTPServer 的服务器，您可以使用 Flask 提供的 <code>send_from_directory</code> 函数来提供静态文件的访问。以下是一个简单的 Flask 应用程序示例，它可以实现这个功能：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, send_from_directory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Flask 应用程序实例</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建路由</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_index</span>():</span><br><span class="line">    <span class="keyword">return</span> send_from_directory(<span class="string">&#x27;static&#x27;</span>, <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;path:path&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve_static</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">return</span> send_from_directory(<span class="string">&#x27;static&#x27;</span>, path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行应用程序</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(ssl_context=<span class="string">&#x27;adhoc&#x27;</span>)</span><br></pre></td></tr></table></figure><p>在这个应用程序中，我们定义了两个路由：</p><ol><li><code>/</code> 路由：当客户端访问根路径时，会调用 <code>serve_index</code> 函数，并返回位于 <code>static</code> 文件夹中的 <code>index.html</code> 文件。</li><li><code>/&lt;path&gt;</code> 路由：当客户端访问任何其他路径时，会调用 <code>serve_static</code> 函数，并返回位于 <code>static</code> 文件夹中的相应文件。其中 <code>&lt;path&gt;</code> 参数可以是任何路径，包括子目录路径。</li></ol><p>在应用程序启动时，我们使用 <code>ssl_context=&#39;adhoc&#39;</code> 参数来启用自签名 SSL 证书，以实现 HTTPS 访问。这将使应用程序监听 443 端口，并使用自签名 SSL 证书进行加密通信。</p><p>请注意，在上面的示例代码中，我们将所有静态文件都存放在 <code>static</code> 文件夹中。如果您的静态文件存放在其他文件夹中，您需要相应地修改 <code>send_from_directory</code> 函数中的文件路径。</p><p>希望这个示例能够帮助您实现自己的 Flask 静态文件服务器。如果您还有其他问题，请随时提问。</p><h4 id="You-9"><a href="#You-9" class="headerlink" title="You:"></a>You:</h4><p>这里的<code>path:path</code>和<code>path:filename</code>有什么区别?</p><h4 id="ChatGPT-9"><a href="#ChatGPT-9" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p><code>path:path</code> 和 <code>path:filename</code> 的区别在于它们的用途和语义。</p><p>在 Flask 应用程序中，路由可以使用动态路由参数，以允许在 URL 中包含动态值。例如，我们可以在路由中使用 <code>&lt;filename&gt;</code> 作为动态参数，以允许客户端访问 <code>http://example.com/docs/index.html</code> 或 <code>http://example.com/docs/about.html</code> 等文件。在 Flask 中，动态路由参数的格式为 <code>&lt;parameter_name&gt;[:&lt;converter&gt;]</code>，其中 <code>parameter_name</code> 是参数的名称，<code>converter</code> 是可选的转换器，用于将参数值转换为特定的类型。如果未指定转换器，则默认为字符串类型。</p><p>因此，<code>path:filename</code> 中的 <code>filename</code> 是一个动态路由参数，它表示请求的文件名。使用 <code>path:</code> 前缀可以将该参数视为一个包含路径信息的字符串。例如，如果客户端请求的 URL 为 <code>http://example.com/docs/path/to/file.html</code>，则 <code>filename</code> 的值为 <code>path/to/file.html</code>。</p><p>相反，<code>path:path</code> 中的 <code>path</code> 是参数名称，表示一个包含路径信息的字符串。与 <code>path:filename</code> 不同的是，这个路由参数没有特定的名称，因此我们可以将它命名为任何有效的 Python 变量名。例如，我们可以将路由定义为 <code>@app.route(&#39;/&lt;path:file_path&gt;&#39;)</code>，并将参数命名为 <code>file_path</code>，以表示请求的文件路径。在这种情况下，如果客户端请求的 URL 为 <code>http://example.com/docs/path/to/file.html</code>，则 <code>file_path</code> 的值为 <code>path/to/file.html</code>。</p><p>总之，<code>path:path</code> 和 <code>path:filename</code> 的区别在于它们的名称和语义。<code>path:filename</code> 表示请求的文件名，而 <code>path:path</code> 表示请求的文件路径。</p><h4 id="You-10"><a href="#You-10" class="headerlink" title="You:"></a>You:</h4><p>flask服务器如何保存用户的状态? 第一访问时会收到一个token, 我需要将它保存下来, 保证这一次访问的期间这个token都可用</p><h4 id="ChatGPT-10"><a href="#ChatGPT-10" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>在 Flask 中，可以使用会话（Session）来保存用户的状态信息。会话是一种在服务器端存储用户数据的技术，可以让 Flask 应用程序在多个请求之间共享数据。在 Flask 中，会话数据被存储在客户端的 Cookie 中，而 Cookie 的内容则由服务器端签名和加密，以保证其不被篡改。</p><p>要在 Flask 应用程序中使用会话，可以使用 Flask 的 <code>session</code> 对象。在每个会话中，Flask 会为每个客户端生成一个唯一的 Session ID，并将 Session ID 存储在 Cookie 中。可以将任意 Python 对象存储在 Flask 的 <code>session</code> 对象中，这些数据会被自动序列化为字符串，并存储在 Cookie 中。要从 <code>session</code> 中获取数据，可以使用 <code>session.get(key, default=None)</code> 方法或 <code>session[key]</code> 语法。</p><p>在你的情况下，当客户端第一次访问服务器时，你可以将客户端提供的 token 存储在会话中，以便在之后的请求中使用。例如，以下是一个使用 Flask 会话来保存 token 的示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">&#x27;your-secret-key&#x27;</span>  <span class="comment"># 设置密钥，用于签名和加密 Cookie</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    token = request.form.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">    session[<span class="string">&#x27;token&#x27;</span>] = token  <span class="comment"># 将 token 存储在会话中</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Logged in successfully.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/protected&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">protected</span>():</span><br><span class="line">    token = session.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> token <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;You are not logged in.&#x27;</span></span><br><span class="line">    <span class="comment"># 在这里使用 token 进行验证，验证通过则返回静态内容</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Protected content.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>在这个例子中，当客户端向 <code>/login</code> 路由发送 POST 请求时，服务器会将客户端提供的 token 存储在会话中。然后，当客户端请求 <code>/protected</code> 路由时，服务器会从会话中获取存储的 token，并使用它进行验证。如果验证通过，则返回受保护的内容；否则，返回未经授权的消息。</p><p>注意，为了使用 Flask 会话，你需要在应用程序中设置一个密钥（即 <code>app.secret_key</code>），用于签名和加密 Cookie。这个密钥应该是一个随机的字符串，并且不应该被泄露。</p><h4 id="You-11"><a href="#You-11" class="headerlink" title="You:"></a>You:</h4><p>你有什么推荐的方法来生成这个密钥么</p><h4 id="ChatGPT-11"><a href="#ChatGPT-11" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>生成一个随机的密钥可以使用 Python 的 <code>secrets</code> 模块，这个模块提供了生成安全随机数的函数。在 Flask 应用程序中，可以使用 <code>secrets.token_hex(nbytes)</code> 函数生成一个指定长度的随机字符串，这个字符串可以用作 <code>app.secret_key</code> 的值。</p><p>例如，以下是一个使用 <code>secrets</code> 模块生成随机密钥的示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = secrets.token_hex(<span class="number">16</span>)  <span class="comment"># 生成一个长度为 16 字节的随机字符串作为密钥</span></span><br></pre></td></tr></table></figure><p>在这个例子中，我们使用 <code>secrets.token_hex(16)</code> 函数生成了一个长度为 16 字节的随机字符串，并将其用作 Flask 应用程序的密钥。</p><p>另外，如果你使用 Flask-WTF 或 Flask-Session 等 Flask 扩展，这些扩展会自动使用 Flask 应用程序的密钥来签名和加密数据，因此你不需要为这些扩展单独生成密钥。</p><h4 id="You-12"><a href="#You-12" class="headerlink" title="You:"></a>You:</h4><p>我想给上面这个密钥设置一个过期时间, 要怎么实现呢?</p><h4 id="ChatGPT-12"><a href="#ChatGPT-12" class="headerlink" title="ChatGPT:"></a>ChatGPT:</h4><p>在 Flask 中，应用程序的密钥（<code>app.secret_key</code>）并不是一种具有过期时间的对象，它通常是在应用程序启动时生成的，并在应用程序运行期间保持不变。</p><p>如果你想实现一个具有过期时间的密钥，可以考虑使用第三方库（如 <code>cryptography</code>）来生成一个带有过期时间的 JWT（JSON Web Token）。JWT 是一种基于 JSON 的开放标准，用于在网络上安全地传输信息。它可以包含有关用户身份验证和授权的信息，同时还可以包含过期时间等元数据。</p><p>例如，以下是一个使用 <code>cryptography</code> 库生成带有过期时间的 JWT 的示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;JWT_SECRET_KEY&#x27;</span>] = <span class="string">&#x27;mysecretkey&#x27;</span>  <span class="comment"># 设置 JWT 密钥</span></span><br><span class="line">app.config[<span class="string">&#x27;JWT_EXPIRATION_DELTA&#x27;</span>] = datetime.timedelta(seconds=<span class="number">3600</span>)  <span class="comment"># 设置 JWT 过期时间为 1 小时</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="comment"># 进行用户身份验证</span></span><br><span class="line">    <span class="keyword">if</span> authenticated:</span><br><span class="line">        <span class="comment"># 如果身份验证成功，则生成 JWT 并返回给客户端</span></span><br><span class="line">        payload = &#123;<span class="string">&#x27;sub&#x27;</span>: <span class="string">&#x27;1234567890&#x27;</span>, <span class="string">&#x27;exp&#x27;</span>: datetime.datetime.utcnow() + app.config[<span class="string">&#x27;JWT_EXPIRATION_DELTA&#x27;</span>]&#125;</span><br><span class="line">        token = jwt.encode(payload, app.config[<span class="string">&#x27;JWT_SECRET_KEY&#x27;</span>], algorithm=<span class="string">&#x27;HS256&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;access_token&#x27;</span>: token.decode(<span class="string">&#x27;UTF-8&#x27;</span>), <span class="string">&#x27;token_type&#x27;</span>: <span class="string">&#x27;Bearer&#x27;</span>&#125;</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;error&#x27;</span>: <span class="string">&#x27;Authentication failed&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/protected&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@jwt_required()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">protected</span>():</span><br><span class="line">    <span class="comment"># 如果 JWT 验证通过，则返回受保护的资源</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;data&#x27;</span>: <span class="string">&#x27;Protected resource&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><p>在这个示例中，我们使用 <code>jwt.encode()</code> 函数生成 JWT，并将其返回给客户端。JWT 的有效期是通过设置 <code>JWT_EXPIRATION_DELTA</code> 配置项实现的，这里设置为 1 小时。在访问受保护的资源时，我们使用 <code>@jwt_required()</code> 装饰器来验证 JWT 的有效性。如果 JWT 验证通过，则返回受保护的资源，否则返回错误信息。</p><p>需要注意的是，JWT 的安全性取决于密钥的保密性，因此在实际应用中应该采取措施保护密钥的安全性。同时，JWT 也有一些安全风险，如 CSRF 攻击等问题，需要在实现过程中注意安全性。</p></div>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Flask </tag>
            
            <tag> chatGPT </tag>
            
            <tag> 编程辅助 </tag>
            
            <tag> 静态网站 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>钉钉Linux版本次的更新喜忧参半</title>
      <link href="/2023/02/03/%E9%92%89%E9%92%89Linux%E7%89%88%E6%9C%AC%E6%AC%A1%E7%9A%84%E6%9B%B4%E6%96%B0%E5%96%9C%E5%BF%A7%E5%8F%82%E5%8D%8A/"/>
      <url>/2023/02/03/%E9%92%89%E9%92%89Linux%E7%89%88%E6%9C%AC%E6%AC%A1%E7%9A%84%E6%9B%B4%E6%96%B0%E5%96%9C%E5%BF%A7%E5%8F%82%E5%8D%8A/</url>
      
        <content type="html"><![CDATA[<p>钉钉Linux版虽然更新的不算勤, 但是确实一直在解决问题, 只是如果在解决问题的同时不引入新的大问题就好了…</p><!-- 摘要部分 --><span id="more"></span><p>目前我更新到了AUR上最新的<code>1.6.0.230113-2</code>, 更新之后, 不需要原本的环境变量设置也能正常进行中文输入了(程序本身及小程序都无问题), 界面缩放在非50%整数倍下也不再有锯齿了…</p><p>但是… 引入的更大的问题… 会议界面完全打不开了, 不论是发起会议或者是进入已经存在的会议, 点了都是毫无反应… 这个严重影响正常使用了… 希望能尽快解决吧…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 钉钉 </tag>
            
            <tag> 中文输入 </tag>
            
            <tag> 界面缩放 </tag>
            
            <tag> 会议功能 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>新年的Flag倒了</title>
      <link href="/2023/02/02/%E6%96%B0%E5%B9%B4%E7%9A%84Flag%E5%80%92%E4%BA%86/"/>
      <url>/2023/02/02/%E6%96%B0%E5%B9%B4%E7%9A%84Flag%E5%80%92%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>上个月还在吐槽一年不如一年, <a href="/2023/01/08/%E4%B8%80%E5%B9%B4%E6%AF%94%E4%B8%80%E5%B9%B4%E7%B3%9F%E7%B3%95/" title="null">并期望今年会更好</a>, 没想到Flag这么快就倒了, Fxxk… 真是糟心永不停歇…</p><!-- 摘要部分 --><span id="more"></span>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Daily </tag>
            
            <tag> 生活 </tag>
            
            <tag> 新年 </tag>
            
            <tag> 期望 </tag>
            
            <tag> 沮丧 </tag>
            
            <tag> New Year </tag>
            
            <tag> Expectation </tag>
            
            <tag> Frustration </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>给Github首页做点面子工作</title>
      <link href="/2023/01/27/%E7%BB%99Github%E9%A6%96%E9%A1%B5%E5%81%9A%E7%82%B9%E9%9D%A2%E5%AD%90%E5%B7%A5%E4%BD%9C/"/>
      <url>/2023/01/27/%E7%BB%99Github%E9%A6%96%E9%A1%B5%E5%81%9A%E7%82%B9%E9%9D%A2%E5%AD%90%E5%B7%A5%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<p>给博客升级了, 那也要给Github首页也做点面子工程…</p><!-- 摘要部分 --><span id="more"></span><p>Github目前可以创建一个特殊的Repo, 该Repo和用户的名称一致, 比如我的就是<code>SilenWang/SilenWang</code>, 在该Repo下的<code>README.md</code>可以显示在用户的Gtihub首页上, 可以理解给了一个可以自定义的看板</p><p>目前我在上面放了一个Github的统计和我常用的工具图标</p><h2 id="Github统计"><a href="#Github统计" class="headerlink" title="Github统计"></a>Github统计</h2><ul><li>这个很简单, 是用一个API实现的:</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">&quot;500px&quot;</span>  <span class="attr">alt</span>=<span class="string">&quot;GitHub Stats&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://github-readme-stats.vercel.app/api?username=SilenWang&amp;count_private=true&amp;show_icons=true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h2 id="工具图标"><a href="#工具图标" class="headerlink" title="工具图标"></a>工具图标</h2><ul><li>这个使用了<a href="https://shields.io/">Shilds.io</a>这个工具, 可以通过get请求从网站API处请求回各种带图标的标签, 比如Jupyter的标签就用:</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">&quot;Jupyter&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://img.shields.io/badge/-Jupyter-f37524?style=flat-square&amp;logo=Jupyter&amp;logoColor=white&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><ul><li><p>我把我用过的… 能查到有图标的都挖出来了…</p></li><li><p>可用的图标很丰富, 但也是不是什么都有, 目前已有的可以参见<code>simple-icons</code>下的<a href="https://github.com/simple-icons/simple-icons/blob/develop/slugs.md">这个文件</a></p></li></ul><h2 id="渲染效果"><a href="#渲染效果" class="headerlink" title="渲染效果"></a>渲染效果</h2><div class="img-wrap"><div class="img-bg"><img class="img lazyload" src="https://raw.githubusercontent.com/silenwang/Gallary/master/2023/01/upgit_github_front_20230127_1674830298.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2023/01/upgit_github_front_20230127_1674830298.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image"/></div></div><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>这边装饰好后, 我尝试把同样的标签用在<code>关于我</code>页面了, 然而Hexo渲染HTML Tag的时候似乎会强制加换行符, 导致所有标签拍成一列, 巨<ruby>壮观<rp> (</rp><rt>nán kàn</rt><rp>) </rp></ruby>… 我找了半小时没找到什么方法解决… 于是就摆烂用表格把每个标签框起来了… 以后找到如何解决再说吧…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Github </tag>
            
            <tag> 个人主页 </tag>
            
            <tag> 美化 </tag>
            
            <tag> Github Stats </tag>
            
            <tag> Shields.io </tag>
            
            <tag> README </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>个人博客2023年升级</title>
      <link href="/2023/01/26/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A22023%E5%B9%B4%E5%8D%87%E7%BA%A7/"/>
      <url>/2023/01/26/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A22023%E5%B9%B4%E5%8D%87%E7%BA%A7/</url>
      
        <content type="html"><![CDATA[<p>时隔… 已经不记得几年了, 本博客再次进行了主题升级, 主题依然使用了<code>Volantis</code>, 是一款使用简单, 但集成功能相当丰富的主题!</p><!-- 摘要部分 --><span id="more"></span><h2 id="更新内容一栏"><a href="#更新内容一栏" class="headerlink" title="更新内容一栏"></a>更新内容一栏</h2><ol><li><code>Volantis</code>升级到最新的稳定版本<code>5.7.7</code></li><li>按照主题升级后的方式更新了<code>关于</code>页面, 现在能正常显示两位<ruby>基<rp> (</rp><rt>sǔn</rt><rp>) </rp></ruby>友的链接了</li><li>启用了基于Github issue的评论插件<code>utterances</code>, 现在登陆Github账号后就可以给我留言啦!</li><li>安装插件启用站内文章链接</li><li>安装插件改变b站视频链接形式(由潜入播放器变成跳转卡片)</li><li>安装插件改变Github Repo的展现形式(卡片形式)</li><li>更新<code>关于我</code>页面, 使用主题自带的各种标签对页面进行了小小的美化</li><li>添加了一个类似萌娘百科的注音插件, 用来皮一下让自己开心~</li></ol><h2 id="新装插件使用"><a href="#新装插件使用" class="headerlink" title="新装插件使用"></a>新装插件使用</h2><h3 id="1-utterances评论"><a href="#1-utterances评论" class="headerlink" title="1. utterances评论"></a>1. utterances评论</h3><p><code>Volantis</code>主题下提供了14种不同的评论系统, 在<code>_config.volantis.yml</code>中按照<a href="https://volantis.js.org/v6/theme-settings/#%E9%80%89%E6%8B%A9%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F">文档说明的方式</a>进行配置后即可使用</p><p>本来打算使用<code>utterances</code>的本地化版本<code>beaudar</code>的, 但是出现了我完全看不懂的问题, 所以还是放弃了. </p><p>配置好首次使用时, Github会提示要安装<code>utterances</code>的Github App才能使用, 这个应用的作用是代替你在Github发表Issue, 不知道是我作为所有者安装一次就好, 还是每个评论的人都要安装…</p><h3 id="2-B站视频卡片"><a href="#2-B站视频卡片" class="headerlink" title="2. B站视频卡片"></a>2. B站视频卡片</h3><p>之前也有在博客中插入一些自己的视频, 但是实际上插入窗口的播放非常受限制, 随便点两下还是会跳到B站去, 那不如就还是用链接得了, 使用<code>hexo-bilibili-card</code>能让链接好看<ruby>一点点<rp> (</rp><rt>fēi cháng duō</rt><rp>) </rp></ruby>, 插入起来也简单的多:</p><ul><li>原来是:</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;//player.bilibili.com/player.html?aid=91147423&amp;cid=155618081&amp;page=1&quot;</span> <span class="attr">width</span>=<span class="string">&quot;700&quot;</span> <span class="attr">height</span>=<span class="string">&quot;500&quot;</span> <span class="attr">scrolling</span>=<span class="string">&quot;no&quot;</span> <span class="attr">border</span>=<span class="string">&quot;0&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;no&quot;</span> <span class="attr">framespacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">allowfullscreen</span>=<span class="string">&quot;true&quot;</span>&gt;</span> <span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>现在是:</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% bilicard av91147423 %&#125;</span><br></pre></td></tr></table></figure><h3 id="3-Github-Repo卡片"><a href="#3-Github-Repo卡片" class="headerlink" title="3. Github Repo卡片"></a>3. Github Repo卡片</h3><p>在关于我的页面… 很简陋的展示了一下自己几个不那么拿得出手的Repo…. 所以使用主题自带的标签实现:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% ghcard &#x27;SilenWang/silenwang.github.io&#x27; %&#125;</span><br></pre></td></tr></table></figure><details yellow><summary> 额外安装插件实现 </summary>              <div class='content'>              <p>在关于我的页面… 很简陋的展示了一下自己几个不那么拿得出手的Repo…. 所以找了个插件让它能稍微好看那么一丢丢丢丢…. 插件名称为<code>hexo-github-repo-tag</code>, 使用方式是:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% githubrepo &#x27;SilenWang/silenwang.github.io&#x27; %&#125;</span><br></pre></td></tr></table></figure><p>部署的时候遇到个小问题… 这个插件是利用API去项目页面抓取必要信息生成对应卡片的, 因此<code>hexo g</code>时需要访问github… 此时如果网络不好… 那只能多试几次了…</p>              </div>            </details>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 博客升级 </tag>
            
            <tag> Hexo </tag>
            
            <tag> Volantis主题 </tag>
            
            <tag> 插件配置 </tag>
            
            <tag> utterances </tag>
            
            <tag> B站卡片 </tag>
            
            <tag> Github卡片 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我这3年玩过的游戏</title>
      <link href="/2023/01/24/%E6%88%91%E8%BF%993%E5%B9%B4%E7%8E%A9%E8%BF%87%E7%9A%84%E6%B8%B8%E6%88%8F/"/>
      <url>/2023/01/24/%E6%88%91%E8%BF%993%E5%B9%B4%E7%8E%A9%E8%BF%87%E7%9A%84%E6%B8%B8%E6%88%8F/</url>
      
        <content type="html"><![CDATA[<p>2019年, 我为了玩怪物猎人XX买了3DS, 从此之后我开始为了玩特定的游戏买各种各样的设备… 为猛汉王组了PC, 为P4G买了PSV, 为崛起买了NSL, 最贵的是为节奏光剑买了Quest2. 本来19年底我就打算每年记录一下自己一年都玩了些啥… 然而人算不如天算… 疫情来了, 我的工作也突然繁重了好几个等级… 连打游戏都要靠半夜氪命, 也就没有精力去做很么回顾了, 只是对个别游戏表达了一丢丢感想.</p><!-- 摘要部分 --><span id="more"></span><p>于是, 三年就这么过去了… 自从买了NSL后, 我基本就不玩3DS, PSV以及PC了, 莫名其妙就从电脑+手机玩家, 变成了主机玩家… 三年间玩过的游戏大概有:</p><table><thead><tr><th>游戏</th><th>平台</th><th>时间</th><th>通关</th></tr></thead><tbody><tr><td>怪物猎人世界:冰原</td><td>PC</td><td>2020</td><td>只解禁</td></tr><tr><td>女神异闻录4G</td><td>PSV</td><td>2020</td><td>是</td></tr><tr><td>奥丁领域</td><td>PSV</td><td>2020</td><td>是</td></tr><tr><td>胧村正</td><td>PSV</td><td>2020</td><td>是</td></tr><tr><td>龙之王冠</td><td>PSV</td><td>2020</td><td>否</td></tr><tr><td>伊苏4:塞尔塞塔树海</td><td>PSV</td><td>2020</td><td>是</td></tr><tr><td>伊苏8:丹娜的陨涕日</td><td>PSV</td><td>2020</td><td>否</td></tr><tr><td>勇气默示录</td><td>3DS</td><td>2020</td><td>否</td></tr><tr><td>节奏天国</td><td>3DS</td><td>2020</td><td>否</td></tr><tr><td>密特罗德:归来</td><td>3DS</td><td>2020</td><td>是</td></tr><tr><td>极限脱出2:善人死亡</td><td>3DS</td><td>2020</td><td>是</td></tr><tr><td>煮糊了2</td><td>PC</td><td>2021</td><td>否</td></tr><tr><td>隐形守护者</td><td>PC</td><td>2021</td><td>是</td></tr><tr><td>双人成行</td><td>PC</td><td>2021</td><td>是</td></tr><tr><td>猫咪斗恶龙</td><td>PC</td><td>2021</td><td>是</td></tr><tr><td>极限脱出3:零时困境</td><td>3DS</td><td>2021</td><td>是</td></tr><tr><td>大逆转裁判2</td><td>3DS</td><td>2021</td><td>是</td></tr><tr><td>怪物猎人崛起</td><td>NS</td><td>2021</td><td>是</td></tr><tr><td>异度神剑</td><td>NS</td><td>2021</td><td>是</td></tr><tr><td>无尽宇宙</td><td>NS</td><td>2021</td><td>是</td></tr><tr><td>血污:夜之仪式</td><td>NS</td><td>2021</td><td>是</td></tr><tr><td>AI:梦境档案</td><td>NS</td><td>2021</td><td>是</td></tr><tr><td>塞尔达传说:荒野之息</td><td>NS</td><td>2021</td><td>否</td></tr><tr><td>暗黑破坏神3</td><td>NS</td><td>2021</td><td>否</td></tr><tr><td>节奏光剑</td><td>Quest2</td><td>2021</td><td>否</td></tr><tr><td>仙剑奇侠传7</td><td>PC</td><td>2022</td><td>否</td></tr><tr><td>怪物猎人崛起:曙光</td><td>NS</td><td>2022</td><td>只解禁</td></tr><tr><td>密特罗德:生存恐惧</td><td>NS</td><td>2022</td><td>是</td></tr><tr><td>哈迪斯</td><td>NS</td><td>2022</td><td>否</td></tr><tr><td>斯普拉顿3</td><td>NS</td><td>2022</td><td>是</td></tr><tr><td>马里奥赛车8</td><td>NS</td><td>2022</td><td>无</td></tr><tr><td>十三机兵防卫圈</td><td>NS</td><td>2022</td><td>是</td></tr><tr><td>昆特牌:王权陨落</td><td>NS</td><td>2022</td><td>否</td></tr><tr><td>雨中冒险2</td><td>NS</td><td>2022</td><td>是</td></tr><tr><td>尼尔:机械纪元</td><td>NS</td><td>2022</td><td>否</td></tr><tr><td>异度神剑2</td><td>NS</td><td>2022</td><td>是</td></tr><tr><td>异度神剑3</td><td>NS</td><td>2022</td><td>是</td></tr><tr><td>魔法使之夜</td><td>NS</td><td>2022</td><td>否</td></tr><tr><td>女神异闻录5R</td><td>NS</td><td>2022</td><td>否</td></tr></tbody></table><p>emmmm… 这么看来… 不论工作忙不忙… 我玩游戏的时间… 估计都不会太少(毕竟熬夜用命玩…</p><p>这些游戏里, 最有感触的<a href="/2021/10/17/%E5%A4%A7%E9%80%86%E8%BD%AC%E8%A3%81%E5%88%A42/" title="null">大逆转裁判2</a>, <a href="/2023/01/22/%E5%A5%B3%E7%A5%9E%E5%BC%82%E9%97%BB%E5%BD%954%E5%92%8C5/" title="null">女神异闻录</a>, <a href="/2021/10/18/%E5%AF%86%E7%89%B9%E7%BD%97%E5%BE%B7/" title="null">密特罗德</a>已经写过了, 尼尔, 仙剑, 异度神剑, 斯普拉顿就等通关或段位上去了再来填坑好了</p>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 游戏 </tag>
            
            <tag> 3DS </tag>
            
            <tag> 主机游戏 </tag>
            
            <tag> 游戏回顾 </tag>
            
            <tag> 游戏平台 </tag>
            
            <tag> PSV </tag>
            
            <tag> NS </tag>
            
            <tag> PC </tag>
            
            <tag> Quest2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>女神异闻录4和5</title>
      <link href="/2023/01/22/%E5%A5%B3%E7%A5%9E%E5%BC%82%E9%97%BB%E5%BD%954%E5%92%8C5/"/>
      <url>/2023/01/22/%E5%A5%B3%E7%A5%9E%E5%BC%82%E9%97%BB%E5%BD%954%E5%92%8C5/</url>
      
        <content type="html"><![CDATA[<p>女神异闻录大概是第二个让我为了游戏买游戏机的系列了, 最开始被P5天下第一的梗洗脑洗了一年, 后来又看了Lex的P4推荐视频, 一个没忍住, 就买了PSV, 如果不是P4G后来登陆了PC, 给女神异闻录跨平台留了念想(去年也确实登陆了), 我大概还会为了P5在未来的某天买个二手PS4…</p><!-- 摘要部分 --><span id="more"></span><p>去年拿到P5后, 我也是几度氪着命也想去年内把P5给打完, 奈何… 内容是真的多… 没进第三学期都将近80个小时, 至今也没有把最后通关(绝对不是因为中途跑去玩喷喷3了!)…</p><p>不过即使没有通关, 我也能感受到, 我跟大多数人感觉一样, 论系统P5完胜, 论故事确实P4更得我心. 我到不是觉得皇家版的剧情加的没有黄金版好, 而是觉得从题材或者立意上, P5就不是那么讨我喜欢.</p><p>可能因为我已经是个肮脏的大人了… 我在很多地方其实不是太能带入到主角团的视角上. 主角们的能力都觉醒自反抗的意志, 不希望被世俗所压迫、定义、以及束缚, 渴望展现真实的自己. 但是比较大的问题在于, P5里面的反派们写得特别的脸谱化和偏极化, 一群丑陋的大人为了自己的欲望无所不用其极, 解决问题的方式虽然很帅气, 但是也过于超现实和粗暴: 直接扭曲对方的心智和思想. 这种手段其实细想来, 跟传统RPG里的靠力量说话, 也即本质上的以暴制暴其实并没有什么分别, 所以其实我觉得明智最开始在电视上发表的观点并没有什么问题(虽然这人问题大了去了), 怪盗团确实可以非常的危险. 我觉得这种能力本质上跟夜神月拿到死亡笔记性质类似, 若非持有者本身觉悟够硬, 迟早会被用作不良用途, 当然剧情中的一些内容其实也提到了这个问题(比如三岛, 以及龙司)</p><p>P4在相应的部分上则好接受很多, 因为P4的主题是接纳与成长, 主角们的力量都觉醒自对真实自我的接纳, 敌人则来自角色对自己的否定与拒绝(虽然少不了人们的偏见), 角色们每打倒一个暗影, 都是让角色自己更全面的认识自己, 同时也让同伴们互相更为了解, 自然而然的加深羁绊, 而不是P5那样凭力量获得所谓正义的胜利, 然后角色们并无实际的成长(成长全靠刷COOP)</p><p>不过, 这也是没办法的事, 好的故事P4已经用过了… 总不能再来一次, 也只能期望下代作品, 两方面都能把握得更好了~</p>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 游戏评测 </tag>
            
            <tag> 女神异闻录 </tag>
            
            <tag> P4G </tag>
            
            <tag> P5R </tag>
            
            <tag> JRPG </tag>
            
            <tag> Persona </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在Jupyter中注册新的Python或R内核</title>
      <link href="/2023/01/17/%E5%9C%A8Jupyter%E4%B8%AD%E6%B3%A8%E5%86%8C%E6%96%B0%E7%9A%84Python%E6%88%96R%E5%86%85%E6%A0%B8/"/>
      <url>/2023/01/17/%E5%9C%A8Jupyter%E4%B8%AD%E6%B3%A8%E5%86%8C%E6%96%B0%E7%9A%84Python%E6%88%96R%E5%86%85%E6%A0%B8/</url>
      
        <content type="html"><![CDATA[<p>进行测试时经常要新建一个conda环境, 然后将环境装上jupyter内核后用notebook进行测试. 每次注册新内核都要重查, 所以还是做个记录好了…</p><!-- 摘要部分 --><span id="more"></span><h2 id="Python内核准备和注册"><a href="#Python内核准备和注册" class="headerlink" title="Python内核准备和注册"></a>Python内核准备和注册</h2><ul><li>进入要注册的环境中后, 再进行注册</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conda activate YOUR_ENV</span><br><span class="line">conda install jupyter ipykernel</span><br><span class="line">python -m ipykernel install --user --name ENV_NAME</span><br></pre></td></tr></table></figure><h2 id="R内核准备和注册"><a href="#R内核准备和注册" class="headerlink" title="R内核准备和注册"></a>R内核准备和注册</h2><ul><li>进入要注册的环境中后, 再进行注册</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda activate YOUR_ENV</span><br><span class="line">conda install jupyter r-irkernel</span><br></pre></td></tr></table></figure><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IRkernel<span class="operator">::</span>installspec<span class="punctuation">(</span>name <span class="operator">=</span> <span class="string">&#x27;REG_NAME&#x27;</span><span class="punctuation">,</span> displayname <span class="operator">=</span> <span class="string">&#x27;ENV_NAME&#x27;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> R </tag>
            
            <tag> conda </tag>
            
            <tag> Jupyter </tag>
            
            <tag> 内核注册 </tag>
            
            <tag> 技术教程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>夭寿啦!腾讯官方做新的LinuxQQ了?</title>
      <link href="/2023/01/15/%E8%85%BE%E8%AE%AF%E5%AE%98%E6%96%B9%E5%81%9A%E6%96%B0LinuxQQ%E4%BA%86/"/>
      <url>/2023/01/15/%E8%85%BE%E8%AE%AF%E5%AE%98%E6%96%B9%E5%81%9A%E6%96%B0LinuxQQ%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>曾几何时, 阻碍我日常使用Linux发行版的最大问题之一就是没有QQ, 当时还是大三, QQ还是学习生活的必备软件, 虽然已经有了智能手机这个东西, 但是当时在手机和Linux电脑间进行文件传输多有不便, 加之当时还没有WPS Linux版… 所以我最终还是用回了Windows. </p><!-- 摘要部分 --><span id="more"></span><p>在去年年末, 出于不明原因, 腾讯居然出了官方的linuxqq, 虽然基于Electron, 但似乎并不是把网上的开源项目抄来用, 而是用了Mac版本的布局? 目前界面还挺好看的:<br><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2023/01/upgit_linuxqq_ui_20230115_1673775364.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2023/01/upgit_linuxqq_ui_20230115_1673775364.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="qq_gui"></p><p>功能上, 最基本的聊天和文件传输没问题, 表情包显示也没问题, 空间和短视频也有了, 其他花里胡哨的一概没有, 暂时还挺小而美的…</p><p>那么… 曾经标榜自己小而美的那位… 什么时候能有动作呢?</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 腾讯 </tag>
            
            <tag> QQ </tag>
            
            <tag> Electron </tag>
            
            <tag> Tencent </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pandas下Apply和R下的一项重要区别</title>
      <link href="/2023/01/15/Pandas%E4%B8%8BApply%E5%92%8CR%E4%B8%8B%E7%9A%84%E4%B8%80%E9%A1%B9%E9%87%8D%E8%A6%81%E5%8C%BA%E5%88%AB/"/>
      <url>/2023/01/15/Pandas%E4%B8%8BApply%E5%92%8CR%E4%B8%8B%E7%9A%84%E4%B8%80%E9%A1%B9%E9%87%8D%E8%A6%81%E5%8C%BA%E5%88%AB/</url>
      
        <content type="html"><![CDATA[<p>我目前在工作中已经几乎不用R做数据处理或者数据清洗了, 因为日常工作的数据整理工作涉及大量的字符串提取&#x2F;处理工作, 这些用R弄起来很难受. 另外R的错误追踪实在是很吃对代码的熟练度和编写经验, 让我这种只是写写简单脚本, 没什么编程规范意识的人编写和维护R代码简直要命(上间公司尝试过了…), 但是最近有同学要求我使用R语言来完成这类工作(因为他只会R), 于是在艰难抄代码的过程中我发现了一条新的不用R做这种工作的理由…</p><!-- 摘要部分 --><span id="more"></span><p>需要完成的内容无非是对数据框取子集, 然后根据子集的行内容解析生成新的列, 再将解析的几个子集拼接起来. 这些内容我在Pandas做过无数次了… 也因此慢慢掌握了pandas里<code>apply</code>, <code>group</code>, <code>pivot_table</code>, <code>melt</code>这几个函数的使用, 目前完全没有碰到过这几个东西解决不了的处理, 唯一的问题… 就是代码编写的能力不太行, 因此有些东西写出来以后效率实在堪忧…</p><p>但是同样的操作在R下那要费了老命了… 毕竟是两种不同的语言, 想在R下找到对等物或者类似物来按照用Pandas的思路处理数据, 是非常困难的一件事, 就连有对等物的<code>apply</code>, 在这次编写中都出现了我无法解决的问题, 导致最后用回了<code>for</code>循环…</p><p>要进行的处理, 大概是从数据集<code>data</code>中选取子集<code>sub</code>, 这个<code>sub</code>实际包含两部分内容: <code>A</code>和<code>B</code>. 需要进行的处理是逐行进行判断, 如果<code>A</code>部分的内容没有缺失, 则返回<code>A</code>部分, 反之返回<code>B</code>部分, 每一行的返回值形成一个新的数据框.</p><p>这个用Pandas很好实现, 对子集<code>apply</code>, 然后编写函数对得到的行判断后, 返回行结果, <code>apply</code>完成后直接就是想要的数据框了. 但是在R下就不是这么回事了, 我最开始是这么弄的:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编写函数用于返回需要的内容</span></span><br><span class="line">mkSel <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>rec<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  mkA <span class="operator">&lt;-</span> rec<span class="punctuation">[[</span><span class="string">&#x27;MarkerA&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">  mkB <span class="operator">&lt;-</span> rec<span class="punctuation">[[</span><span class="string">&#x27;MarkerB&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">  <span class="keyword">if</span> <span class="punctuation">(</span><span class="built_in">is.na</span><span class="punctuation">(</span>mkB<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    row <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span>mkA<span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColA1&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColA2&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColA3&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">    row <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span>mkB<span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColB1&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColB2&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColB3&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="built_in">names</span><span class="punctuation">(</span>row<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;Marker&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Tag1&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;Tag2&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Tag3&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>row<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="comment"># 原代码没有文件记录，下面这个可能会有问题, 印象中用apply出来的只能是列，拼接成数据框， 所以转置</span></span><br><span class="line">sub<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;Marker&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Tag1&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;Tag2&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Tag3&#x27;</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>apply<span class="punctuation">(</span>sub<span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> mkSel<span class="punctuation">,</span> simplify<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>这段代码完全是按照用Pandas的处理在弄, 最后也确实能够运行. 但是这里面有个巨大的问题: 向量内元素的数据类型必须是相同的, 我在将收集的数值放到同一个向量中时, 非字符串元素的类型就被自动变成字符串了, 因此虽然能运行, 但是新生成的4列已经全部是字符串了.</p><p>为了尝试解决这个问题, 我用<code>list</code>来替代函数内的向量, 有了一个中间版本, 然后我想到第二个问题: <code>t()</code>的转置是把数据当作矩阵来处理的, 因为R的列是一个个向量, 如果不这么做, 转置后一列就有多个数据类型了… 因此我不私心的去网上翻了半天, 抄了一段代码避免使用<code>t()</code>, 有了如下版本:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编写函数用于返回需要的内容</span></span><br><span class="line">mkSel <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>rec<span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  mkA <span class="operator">&lt;-</span> rec<span class="punctuation">[[</span><span class="string">&#x27;MarkerA&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">  mkB <span class="operator">&lt;-</span> rec<span class="punctuation">[[</span><span class="string">&#x27;MarkerB&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">  <span class="keyword">if</span> <span class="punctuation">(</span><span class="built_in">is.na</span><span class="punctuation">(</span>mkB<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    row <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span>mkA<span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColA1&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColA2&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColA3&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">    row <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span>mkB<span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColB1&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColB2&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> rec<span class="punctuation">[[</span><span class="string">&#x27;ColB3&#x27;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="built_in">names</span><span class="punctuation">(</span>row<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;Marker&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Tag1&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;Tag2&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Tag3&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>row<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">sub<span class="punctuation">[</span><span class="punctuation">,</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;Marker&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Tag1&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;Tag2&#x27;</span><span class="punctuation">,</span><span class="string">&#x27;Tag3&#x27;</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> do.call<span class="punctuation">(</span>rbind.data.frame<span class="punctuation">,</span> apply<span class="punctuation">(</span>sub<span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> mkSel<span class="punctuation">,</span> simplify<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>但是测试完后我才发现了最大的问题… <code>apply</code>这个函数… 他根本就不能返回数据框, 只能返回矩阵, 矩阵本来就是行列同类型的… 甚至整个函数家族就没有一个是能完成我的需求的, 所以我无论怎么努力, 只要用<code>apply</code>这个目标就是无法实现的.</p><p>于是我最后还是用回了质朴的<code>for</code>循环解决了问题… 生成一个空数据框, 规定每一列的类型, 然后读取<code>sub</code>数据框的每一行来生成新数据框, 最后根据编号将两个数据框合并…</p><p>所以总结下来, R里的apply在设计的时候就没想我这么去用吧… 只能用基础函数… 通过比较麻烦(需要多写好几行, 同时代码效率和可复用性上似乎不太好)的方式来实现我用Pandas时的做法…</p><p>当然平心而论, 我对R的熟练度已经远不如Pandas了, 很多好用的R包我都没有怎么使用过(如<code>dplyr</code>), 所以也许R也能很好的完成这些工作… 只是… 我搜索不到相关的材料?</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 数据处理 </tag>
            
            <tag> 数据清洗 </tag>
            
            <tag> Pandas </tag>
            
            <tag> R </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>clash_nps自建内网穿透用vpn</title>
      <link href="/2023/01/08/clash-nps%E8%87%AA%E5%BB%BA%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E7%94%A8vpn/"/>
      <url>/2023/01/08/clash-nps%E8%87%AA%E5%BB%BA%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E7%94%A8vpn/</url>
      
        <content type="html"><![CDATA[<p>自疫情开始, 我就多少有一点远程办公的需求, 今天终于组合处了一个相对方便, 近似内网vpn使用体验的方案.</p><!-- 摘要部分 --><span id="more"></span><h2 id="过去使用过的方案"><a href="#过去使用过的方案" class="headerlink" title="过去使用过的方案"></a>过去使用过的方案</h2><p>我最开始的需求很简单, 只是通过ssh登陆目标服务器就好, 因此最开始的直接买了个VPS, 用这个VPS做跳板机, 在目标机器上用ssh或者autossh开启反向代理, 使得我可以经由VPS下的端口访问目标机器的22端口, 从而远程登陆目标机器. 这个方案最大的好处就是简单, ssh是所有linux系统必然会带的东西, 同时ssh能连通后, 可以通过ssh进行反代理, 因此理论上也能实现访问任意的内网ip和端口. 不过其弊端是, 当需要访问的内容越来越多, 每访问一个ip&#x2F;端口就要通过跳板登陆目标机器, 在该机器上再运行一条反代理命令, 就与简单易用没什么关系了… 而且万一断电要重启… 这些东西都要再来一次… 极其的麻烦</p><p>之后IT的同时开始启用NPS, 这是个用Go编写的内网穿透工具, 安装使用极其简单, 在设置好服务端和客户端后, 如果有新的访问需求, 在NPS自带的管理页面作相应设置新建一个私密链接就好, 如果遇到重启, 只要重启NPS的客户端就好, 另外如果有管理员权限, NPS客户端还能自己设置自启动服务. 这样就节省了很大一部分工作, 不过当要访问的东西实在是太多, 每一个端口还是要在本地运行一个NPC进程, 且因为是端口映射到本地, 内网地址会变成127.0.0.1, 有些服务访问起来会出问题(Gitea的部分内容就是)</p><p>前段时间在查看NPS管理界面时, 界面介绍Socks代理模式可用于访问各种内网资源, 实现VPN的功能, 于是我就又尝试了一下, 最后靠Socks模式和Clash客户端实现了内网资源的访问, 同时又不影响访问外网的流量</p><h2 id="当前Linux下的方案"><a href="#当前Linux下的方案" class="headerlink" title="当前Linux下的方案"></a>当前Linux下的方案</h2><h3 id="需要准备的软-硬件"><a href="#需要准备的软-硬件" class="headerlink" title="需要准备的软&#x2F;硬件"></a>需要准备的软&#x2F;硬件</h3><ul><li>一台有公网IP的VPS, 后面简称<code>VPS</code>, 同时需能够配置这台VPS的端口开放权限</li><li>一台位于目标内网中的, 能够访问到<code>VPS</code>的主机(系统没太大限制, 因为NPS的客户端是跨平台的), 改机器后面简称<code>跳板</code>, 访问内网的请求实际上是到达<code>跳板</code>后发出的</li><li>NPS服务端&#x2F;客户端软件, 可从github<a href="https://github.com/ehang-io/nps">获取</a></li><li>可以进行截取全局流量的Clash客户端软件, Linux下可以使用<a href="https://github.com/Fndroid/clash_for_windows_pkg">Clash For Windows</a>的Linux版本或者<a href="https://github.com/zzzgydi/clash-verge">Clash Verge</a>, 不过Clash Verge之前开Tun模式似乎存在权限问题, 不知道目前修复了没有</li></ul><h3 id="实施方法"><a href="#实施方法" class="headerlink" title="实施方法"></a>实施方法</h3><ol><li>在<code>VPS</code>搭建好NPS, 在<code>跳板</code>上开启VPS的客户端, 然后在NPS服务界面进行Socks代理设置, 具体操作方式可参见<a href="https://blog.csdn.net/ha0shenqi/article/details/111194246">这个博客</a>, 注意记录下socks服务的账户密码</li><li>安装好Clash For Windows, 然后按照<a href="https://docs.cfw.lbyczf.com/contents/tun.html#linux">官方文档</a>开启Tun模式(全局模式, 将创建虚拟网卡截取本机的所有流量)</li><li>由于我已经通过转换服务产生了Clash配置文件, 因此需要打开已有的配置文件, 手动添加<code>VPS</code>上的Socks5服务, 同时自行填写访问内网资源的Clash规则, 示例配置段如下(规则中的rules要写在最前, 因为前面匹配到了后面就不继续匹配了):</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">proxies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NPS_SOCKS</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">11.11</span><span class="number">.11</span><span class="number">.111</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">2233</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">socks5</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">socks5</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">socks123456</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">proxy-groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SOCKS5</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">select</span></span><br><span class="line">    <span class="attr">proxies:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NPS_SOCKS</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DIRECT</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">IP-CIDR,192.168.0.111/32,NPS_SOCKS</span></span><br></pre></td></tr></table></figure><ul><li>tips: 另外, ip规则如果匹配单个地址, 写法为<code>XXX.XXX.XXX.XXX/32</code>, 如果匹配整个网段, 则为<code>XXX.XXX.XXX.0/16</code>, 当然如果写了个具体地址配上<code>/16</code>, 整个网段都会被代理</li></ul><ol start="4"><li>重启<code>Clash</code>服务即可访问</li></ol><h2 id="当前Chromeos-ChromiumOS-安卓下的方案"><a href="#当前Chromeos-ChromiumOS-安卓下的方案" class="headerlink" title="当前Chromeos &#x2F; ChromiumOS &#x2F; 安卓下的方案"></a>当前Chromeos &#x2F; ChromiumOS &#x2F; 安卓下的方案</h2><p>这些系统下只有使用的Clash客户端发生变化, 用商店里的<code>Clash for Android</code>就好, chromeos需要先开启安卓子系统然后从商店安装(安装前设置系统代理, 之后关闭系统代理通过Clash客户端走流量), 由于<a href="https://github.com/Kr328/ClashForAndroid/issues/1647">安卓的VPN本来就是截取所有流量的</a>, 所以不需要作模式的设置, 直接配置好规则就行, 不过客户端默认设置下内网ip段的请求是不走代理的, 找到<code>设置 &gt; 网络 &gt; 绕过私有网络</code>选项, 把选项关闭即可</p><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>由于使用了Clash进行规则分流, 所以这套方案其实可以设置同时访问多个内网的资源, 当然前提是ip不能冲突, 之后把家里的ip段直接改掉好了…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内网穿透 </tag>
            
            <tag> VPN </tag>
            
            <tag> socks5代理 </tag>
            
            <tag> 远程办公 </tag>
            
            <tag> 流量代理 </tag>
            
            <tag> nps </tag>
            
            <tag> clash </tag>
            
            <tag> socks5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一年更比一年糟</title>
      <link href="/2023/01/08/%E4%B8%80%E5%B9%B4%E6%AF%94%E4%B8%80%E5%B9%B4%E7%B3%9F%E7%B3%95/"/>
      <url>/2023/01/08/%E4%B8%80%E5%B9%B4%E6%AF%94%E4%B8%80%E5%B9%B4%E7%B3%9F%E7%B3%95/</url>
      
        <content type="html"><![CDATA[<p>回忆起来2022真是基本没好事, 工作更累了, 收获更少了, 身体更差了, 精神更抑郁了, 自由时间马上要更少了, 连想吃个烧烤居然也会好几次找不到店… 这还能不能好了… 希望新的一年不要更糟糕了吧…</p><!-- 摘要部分 --><span id="more"></span>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生活感悟 </tag>
            
            <tag> 年度总结 </tag>
            
            <tag> 负面情绪 </tag>
            
            <tag> 2023 </tag>
            
            <tag> life-reflection </tag>
            
            <tag> year-summary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>chromebook入坑记?</title>
      <link href="/2022/10/16/chromebook%E5%85%A5%E5%9D%91/"/>
      <url>/2022/10/16/chromebook%E5%85%A5%E5%9D%91/</url>
      
        <content type="html"><![CDATA[<p>我一直有关注国产Linux系统的状态(虽然除了上古版本的Linux Deepin没有一个长时间使用过), 所以在Fyde OS还叫Flint OS的时候我就关注过这个基于Chromium OS的特别发行版, 也因为这个了解了在国外份额莫名其妙高(在过去的我看来)的Chrome OS</p><!-- 摘要部分 --><span id="more"></span><p>Chrome OS由Google推出, 其特点在于轻量, 简单以及大量使用云服务. 通俗点说这是个专为性能低下的上网本设备构建的发行版, 其理念还挺时髦的, 它认为绝大部分用户并不需要很强的性能以运行大量专业的本地软件, 他们只需要一台可以通过网络访问到所需服务的入口设备而已. 因此, Chrome OS最开始被设计为完全不在本地运行服务, 所有功能都需要通过网站服务的, 浏览器 Pro Max Plus系统(然后喜提大量吐槽).</p><p>从后面的发展来看, 这个理念可能并不完全错, 但是… 从后面又是加Linux子系统又是加安卓子系统的操作来看… 完全的云端化, 到目前来说都还太早了.</p><p>不过这不代表对我的工作来说太早…</p><p>我的工作中需要处理大量的基因测序数据, 这些数据过于巨大, 以至于完全使用移动设备来处理这些东西还为时过早, 因此我的工作本来就有将实际计算工作和其他工作分离的需求. 另一方面我现在用的很多重要工具, 像Jupyter, Rstudio, VsCode本来也都有了成熟的服务器版本, 搭建好相应服务后, 所以我就产生了尝试一下使用搭载Chrome OS或者类Chrome OS(上文说的Fyde)的设备是否能较好完成日常工作需求的念头.</p><p>于是, 我在之后的日子里, 先尝试了FydeOS(x86), 后在海鲜市场入了Lenovo Duet, 开始入了Chromebook的坑… 之前尝试搭建自部署的云端服务, 也是为了尝试只使用Chromebook办公作准备, 不过就像我用了Linux发行版10年里踩了无数的坑, 甚至经历过要命的损失后, 现在才能用的比较顺畅一样… 用这么一个过于精简的系统来办公, 现阶段来说问题也还是挺多的… 后面我再一一整理出来…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FydeOS </tag>
            
            <tag> Linux </tag>
            
            <tag> ChromeOS </tag>
            
            <tag> 云办公 </tag>
            
            <tag> chromebook </tag>
            
            <tag> 远程开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搭建云端工作环境</title>
      <link href="/2022/09/24/%E6%90%AD%E5%BB%BA%E8%BF%9C%E7%A8%8B%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
      <url>/2022/09/24/%E6%90%AD%E5%BB%BA%E8%BF%9C%E7%A8%8B%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<p>很早之前就关注过国内做的一个很特殊的操作系统, 叫FydeOS, 他是基于ChromiumOS构建的中国版的ChromeOS, 这种操作系统主打的理念是, 很多人在工作中其实并不需要性能多好的终端计算机设备, 而是需要一个能访问工作必备的服务的入口型设备就好, 具体到目前的情况, 就是终端设备只要能鱼形浏览器, 然后通过浏览器来访问云端的服务完成操作就好.</p><!-- 摘要部分 --><span id="more"></span><p>这个概念确实非常有意思, 让我想到了git和svn这两种版本管理软件的不同理念, git的理念是分布式, 每个开发者都会保留一份完整的项目代码, 并且保有不同人对这份代码做的不同分支的修改. 而svn则是集中式, 用户只需要通过服务访问他需要访问的那一部分即可.</p><p>我个人觉得分布式和集中式并无优劣之分, 而是有各自事宜的应用场景. 而具体到我的工作上, 目前的工作方式应该属于是没有任何备份的分布式, 工作环境和工作内容都位于我自己的或者公司里的个人电脑上, 如果哪天不好彩我的设备报废了…那…要恢复工作估计会相当花时间, 同时如果有一天我要紧急处理东西但是这台设备并不在身边或者并没有电…除了干着急也没什么辄</p><p>所以我也很像试试, 我现在的工作, 有没有可能完全云端化呢? 即部署一系列的自部署服务, 然后完全通过浏览器或其他支持连接远程项目的开发工具来完成工作, 编写调试都在服务端进行实际执行.</p><h2 id="我的工作需要用到的所有软件"><a href="#我的工作需要用到的所有软件" class="headerlink" title="我的工作需要用到的所有软件"></a>我的工作需要用到的所有软件</h2><p>生信的工作, 简练一些, 那就是: 写脚本, 画统计图, 图形精修, 撰写各种乱七八糟的文档, 实际会用到的软件包括:</p><ul><li>代码编写&#x2F;测试: VScode, Jupyter</li><li>环境部署: conda, docker</li><li>文件整理: 系统自带的文件管理器</li><li>文档处理: WPS系列</li><li>文献查阅: Zotero</li><li>图片处理: GIMP</li></ul><h2 id="搭建一个云端开发环境所需要的"><a href="#搭建一个云端开发环境所需要的" class="headerlink" title="搭建一个云端开发环境所需要的"></a>搭建一个云端开发环境所需要的</h2><p>为了实现一个完全云端的工作环境, 最理想的情况下上述所有软件都得找到可自部署的云端软件项目, 能解决的包括:</p><ul><li>代码编写&#x2F;测试: code-server, Jupyter本来就是服务, 可以远程访问</li><li>环境部署: 远程SSH登陆再操作就是, 或者找一个web的终端模拟器</li><li>文件整理: Nextcloud, firerun</li><li>文档处理: only office server</li><li>文献查阅: paperpile(要钱)</li></ul><p>那么数下来, 其实也就是修图这个…还真没找到能自部署的东西, 后续可以再持续关注</p><h2 id="进行尝试"><a href="#进行尝试" class="headerlink" title="进行尝试"></a>进行尝试</h2><h3 id="ML-Hub-ML-Workspace配置"><a href="#ML-Hub-ML-Workspace配置" class="headerlink" title="ML-Hub &#x2F; ML-Workspace配置"></a>ML-Hub &#x2F; ML-Workspace配置</h3><p>ML-Hub &#x2F; ML-Workspace是基于容器的多重网络服务集成项目, 其中包含了装好一大堆插件的JupyterHub, code-server和一个简单的文件管理器, 如果不是Docker运行有用户权限的问题需要处理, 瞬间就能完美解决六七成的问题了…</p><p>两者的使用都比较简单, 装了Docker或者Podman之后直接启动赴服务就好</p><h3 id="内网穿透-nps"><a href="#内网穿透-nps" class="headerlink" title="内网穿透(nps)"></a>内网穿透(nps)</h3><p>nps是一个用go语言实现的…复合网络工具? 其中一项就是实现内网穿透, nps包括服务端和客户端. 需要注意的是nps的服务端是作为中转站来使用的, 其作用是作为皮条客(<del>不是</del>)将各个客户端互联互通起来, 因此实际设置的时候, 先要找一个有公网ip的主机, 上面部署上nps, 然后被访问的机器需要通过客户端npc连接到nps服务端, 然后其他的客户端再公国nps这个中转站连接到要被访问的客户端.</p><p>总之…跟vnc, rdp以及SSH这种, 开服务的机器就是被访问的机器方式是挺不一样的.</p><h3 id="https代理设置"><a href="#https代理设置" class="headerlink" title="https代理设置"></a>https代理设置</h3><p>如果想把搭建的服务挂在某个域名下, 通过域名直接访问, 那处于安全考虑, https总还是要用的. 域名申请自然是找个最便宜的先买者, 然后就是使用Caddy进行反代理了, 在折腾了许久后, 我最后用的配置写法是这样的.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  http_port 8888</span><br><span class="line">  https_port 8384</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">:8384 &#123;</span><br><span class="line">    reverse_proxy localhost:7788</span><br><span class="line">    tls /etc/caddy/domain.top.cer /etc/caddy/domain.top.key</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">your.domain.top:8384 &#123;</span><br><span class="line">    reverse_proxy localhost:7788</span><br><span class="line">    tls /etc/caddy/domain.top.cer /etc/caddy/domain.top.key</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="防火墙设置-iptables"><a href="#防火墙设置-iptables" class="headerlink" title="防火墙设置(iptables)"></a>防火墙设置(iptables)</h3><p>同前…为了其安全…防火墙还是应该开起来意思一下…所以我也找了点教程来学怎么用iptables(<a href="https://iter01.com/616656.html">CENTOS 8开启iptables</a>), 不过这玩意也是老古董了… 好些新系统直接用别的防火墙管理程序了都…</p><p><a href="http://balalals.cn/archives/docker%E5%AE%B9%E5%99%A8%E8%AE%BF%E9%97%AE%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%AB%AF%E5%8F%A3">Docker访问宿主机端口方法</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">iptables -I INPUT -p tcp --dport 443 -j ACCEPT </span><br><span class="line">iptables -I INPUT -p tcp --dport 7788 -j REJECT</span><br><span class="line">iptables -I INPUT -p tcp -s 127.0.0.1 --dport 7788 -j ACCEPT</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nps </tag>
            
            <tag> jupyter </tag>
            
            <tag> 云端开发 </tag>
            
            <tag> 远程工作 </tag>
            
            <tag> 自部署服务 </tag>
            
            <tag> code-server </tag>
            
            <tag> https </tag>
            
            <tag> iptables </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>倒腾图数据库时想到的</title>
      <link href="/2022/08/25/%E5%80%92%E8%85%BE%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%B6%E6%83%B3%E5%88%B0%E7%9A%84/"/>
      <url>/2022/08/25/%E5%80%92%E8%85%BE%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%B6%E6%83%B3%E5%88%B0%E7%9A%84/</url>
      
        <content type="html"><![CDATA[<p>最近整理我们使用图数据库的资料时想到的一个问题, 其实如果单纯从性能上看, 图数据库未必就能达到更好的性能, 对我们来说其意义其实在于简化了数据库设计能力的要求.</p><!-- 摘要部分 --><span id="more"></span><p>我们要存的数据存在比较多的相互关联, 对我们这种不是专业数据库相关行业的人来说, 理清需要记录的信息之间的实际逻辑关系虽然也会费功夫, 但是这是必须切能做到的, 但是设计一套适合的库和表格来存储这些东西… 那可真是要了老命了…</p><p>这时候图数据库就有绝对的优势了, 因为… 只要逻辑关系理清楚了, 那直接按照这个逻辑关系去存储的就好了… 所以… 用这东西最大的意义… 就是省了数据库结构设计, 同时万一觉得自己的逻辑还不对, 改节点也更容易…</p><p>以上</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 图数据库 </tag>
            
            <tag> 数据库设计 </tag>
            
            <tag> 关系型数据库 </tag>
            
            <tag> Neo4j </tag>
            
            <tag> Graph Database </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Marp的使用</title>
      <link href="/2022/06/22/Marp%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
      <url>/2022/06/22/Marp%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>日常工作中总有需要做一个演示文档展示项目进度或项目结果的时候, 但做PPT其实是个比较花时间的工作(强迫症总是控制不住自己调字体和位置的手), 然后我每次展示的东西都只有一些简单的文字和图表, 从来没用过PPT那些高端大气上档次的元素和功能, 所以找了Marp来偷懒…</p><!-- 摘要部分 --><span id="more"></span><p>Marp是一个用markdown语法生成演示文档的项目, 用最基本的markdown语法即可快速生成一份还能看(其实有点丑)的掩饰文档出来, 支持生成pptx, pdf以及网页, 用了有一个月了体验还是很好的(看的人可能会觉得眼瞎?)</p><h2 id="Marp-VScode-基本使用"><a href="#Marp-VScode-基本使用" class="headerlink" title="Marp_VScode 基本使用"></a>Marp_VScode 基本使用</h2><p>Marp项目下有多个可用程序, 但是用起来最方便的当然还是VScode下的插件了, 不需要特别设置, 安装即用. </p><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/06/upgit_Marp_VScode_20220622_1655884337.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/06/upgit_Marp_VScode_20220622_1655884337.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>安装完成后打开markdown文件时编辑器右上角就会多出一个按钮, 可以切换当前文件为Marp模式</p><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/06/upgit_Marp_VScode_Set_20220622_1655884577.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/06/upgit_Marp_VScode_Set_20220622_1655884577.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>之后就可以开心的写的了… 因为都是基本markdown语法, 除了用<code>---</code>将每页的内容分隔开, 也没啥要注意的. 有啥看<a href="https://marpit.marp.app/markdown">官方文档</a>就行了</p><h2 id="用例备查"><a href="#用例备查" class="headerlink" title="用例备查"></a>用例备查</h2><h3 id="插入图片左-右置"><a href="#插入图片左-右置" class="headerlink" title="插入图片左&#x2F;右置"></a>插入图片左&#x2F;右置</h3><p>我的展示中经常需要放一张图然后对图片做一些说明, 这种事后图片在一侧, 文字在一侧的方式看上去比较合理, 但是markdown的基本语法显然没这么个东西… 可以通过Marp的背景图片语法来实现.</p><p>这里的<code>contain</code>是让图形自动调整大小, 否则一般都会超出幻灯范围, 例子用了右置, 用<code>left</code>也可以丢左边, 然后上下的话似乎<code>contain</code>就没效果了…</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"><span class="section">marp: true</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 右侧是一张统计图</span></span><br><span class="line"><span class="bullet">-</span> 图是乱找的</span><br><span class="line"></span><br><span class="line">![<span class="string">bg contain right</span>](<span class="link">https://seaborn.pydata.org/_images/grouped_barplot.png</span>)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/06/upgit_Marp_VScode_Slide1_20220622_1655885449.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/06/upgit_Marp_VScode_Slide1_20220622_1655885449.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="脚标和页码"><a href="#脚标和页码" class="headerlink" title="脚标和页码"></a>脚标和页码</h3><p>在开头增加两个设置项就能打开脚标和页码, 不过位置好像用markdown的语法没法调</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">marp: true</span><br><span class="line">footer: 20220610</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="section">## 展示页码用</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/06/upgit_Marp_VScode_Slide2_20220622_1655885767.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/06/upgit_Marp_VScode_Slide2_20220622_1655885767.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Marp </tag>
            
            <tag> VSCode </tag>
            
            <tag> Markdown </tag>
            
            <tag> 演示文档 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于我这两年工作看论文比读研还多这件事</title>
      <link href="/2022/04/05/%E5%85%B3%E4%BA%8E%E6%88%91%E8%BF%99%E4%B8%A4%E5%B9%B4%E5%B7%A5%E4%BD%9C%E7%9C%8B%E8%AE%BA%E6%96%87%E6%AF%94%E8%AF%BB%E7%A0%94%E8%BF%98%E5%A4%9A%E8%BF%99%E4%BB%B6%E4%BA%8B/"/>
      <url>/2022/04/05/%E5%85%B3%E4%BA%8E%E6%88%91%E8%BF%99%E4%B8%A4%E5%B9%B4%E5%B7%A5%E4%BD%9C%E7%9C%8B%E8%AE%BA%E6%96%87%E6%AF%94%E8%AF%BB%E7%A0%94%E8%BF%98%E5%A4%9A%E8%BF%99%E4%BB%B6%E4%BA%8B/</url>
      
        <content type="html"><![CDATA[<p>这是一个看论文看到想吐的夜晚(2022&#x2F;03&#x2F;29), 我再一次浏览着我Zotero中凌乱的目录树… 猛然想到, 我这几年到底看了多少文献了? 邮件导出…我自己都惊了… 561个文献条目, 419篇pdf下载论文… 真的… 如果我当年直博, 估计都不会看这么多论文.</p><!-- 摘要部分 --><span id="more"></span><p>于是我又只要不是工作都有点兴趣的… 简单捣鼓了一下我看的这些论文的信息.</p><h2 id="捣鼓步骤"><a href="#捣鼓步骤" class="headerlink" title="捣鼓步骤"></a>捣鼓步骤</h2><ol><li>使用Zotero导出文献目录为<code>ris</code>文件</li><li>使用<code>rispy</code>解析ris文件为数据框, 保留文献类型, 作者, 入库年份, 摘要, 刊发杂志的信息.</li><li>保留文献类型为杂志论文的条目</li><li>使用<code>wordcloud</code>对作者, 刊发杂志构建词云</li><li>将文献摘要做字符串合并后, 使用<code>wordcloud</code>自行分词并构建词云</li><li>对文献的入库年份做柱状图</li></ol><p>大概结果见下:</p><h2 id="作者词云"><a href="#作者词云" class="headerlink" title="作者词云"></a>作者词云</h2><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/04/upgit_auth_20220405_1649148811.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/04/upgit_auth_20220405_1649148811.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="作者词云"></p><p>对图形上看得到比较显眼的几位作者进行下简单的回顾:</p><ul><li><p>Griffith Malachi, Griffith Obi L.: 其中两位比较显眼的Griffith是双胞胎, 来自<a href="https://griffithlab.org/">Griffith Lab</a>, 该实验室是专门主攻生物信息技术在癌症各方面应用的. 他们开发了一系列与相关的软件&#x2F;数据库.</p></li><li><p>Sette Alessandro: 来自<a href="https://www.lji.org/labs/sette/">Sette Lab</a>, 是免疫学方面的专家. 其研究主攻的是病原体(尤其是病毒)的免疫研究. 自新冠爆发后, 参与发表的研究似乎基本都是新冠了…</p></li><li><p>Morten Nielsen: 来自丹麦技术大学(DTU)的研究者, 主攻方向应该是免疫识别相关的算法开发, 在图里显眼应该是我收录了多篇跟亲和力预测有关的研究吧, 学校的展示主页<a href="https://orbit.dtu.dk/en/persons/morten-nielsen-2/fingerprints/">见此</a></p></li><li><p>Nir Hacohen: Broad Institute的研究者, 看<a href="https://www.broadinstitute.org/bios/nir-hacohen">介绍</a>是主攻免疫方向的, 暂对该作者无特别印象</p></li><li><p>Bjoern Peters: 来自<a href="https://www.lji.org/labs/peters/">Peters Lab</a>, 主攻方向是免疫领域的生信利用. 与前面的Sette Alessandro同属La Jolla Institute For Immunology</p></li><li><p>Eilon Barnea: 来自<a href="https://mlandau.net.technion.ac.il/people/">Meytal Landau’s Lab</a>, 主攻似乎是免疫肽的计算和实验识别?</p></li><li><p>Arie Admon: 来自<a href="https://admon.net.technion.ac.il/">Arie Admon Lab</a>, 主要研究领域是蛋白组学, 应该是我收录了一些质谱鉴定相关的文章吧…</p></li><li><p>Michal Bassani-Sternberg: 肿瘤生物和肿瘤免疫学的专家, 看<a href="https://www.ludwigcancerresearch.org/scientist/michal-bassani-sternberg/">介绍</a>好像是以质谱为主要技术手段的? </p></li><li><p>Anthony Purcell: 看<a href="https://research.monash.edu/en/persons/anthony-purcell">介绍</a>, 研究方向是生信在肿瘤免疫, 自体免疫疾病上的应用</p></li><li><p>Anne Searls De Groot: EpiVax的联合创始人. 名字会这么大… 应该是当时查阅的他们公司的文献里都有他吧…</p></li><li><p>Ugur Sahin: BioNTech的CEO… emmm, 也是查阅公司文献时带进来的应该</p></li><li><p>Catherine J Wu: 主攻新生抗原领域的研究者, 最近被塞过好几篇他主导的研究结果文献… 另外这位也有协助Broad Institute进行抗肿瘤免疫相关的研究</p></li></ul><h2 id="刊发杂志词云"><a href="#刊发杂志词云" class="headerlink" title="刊发杂志词云"></a>刊发杂志词云</h2><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/04/upgit_jour_20220405_1649148783.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/04/upgit_jour_20220405_1649148783.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="刊发杂志词云"></p><p>杂志上…果然还是以生信的为主, 然后因为应用方向的问题, 生物技术和免疫技术也有一大堆的样子…</p><h2 id="摘要词云"><a href="#摘要词云" class="headerlink" title="摘要词云"></a>摘要词云</h2><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/04/upgit_abs_20220405_1649148797.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/04/upgit_abs_20220405_1649148797.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="摘要词云"></p><p>摘要词里大大的肽, 新生抗原, T细胞… 已经很明确的说明近几年的工作方向了…</p><h2 id="入库年份统计"><a href="#入库年份统计" class="headerlink" title="入库年份统计"></a>入库年份统计</h2><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/04/upgit_year.bar_20220405_1649148769.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/04/upgit_year.bar_20220405_1649148769.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="入库年份统计"></p><p>至于入库年份的统计…很明显能看出我为很么最近觉得看文章看得想吐了…</p><p>以上~</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生物信息学 </tag>
            
            <tag> 论文 </tag>
            
            <tag> 免疫学 </tag>
            
            <tag> 肿瘤研究 </tag>
            
            <tag> 文献管理 </tag>
            
            <tag> zotero </tag>
            
            <tag> rispy </tag>
            
            <tag> wordcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>R绘图问题记录</title>
      <link href="/2022/03/13/%E4%BD%BF%E7%94%A8ggpubr%E5%81%9A%E5%9B%BE%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/"/>
      <url>/2022/03/13/%E4%BD%BF%E7%94%A8ggpubr%E5%81%9A%E5%9B%BE%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>前段时间帮同事做图, 又解锁了一些新的问题和解决方式, 涉及ggpubr, 生存分析包, 做个记录.</p><!-- 摘要部分 --><span id="more"></span><h2 id="survminer绘制出图形的保存问题"><a href="#survminer绘制出图形的保存问题" class="headerlink" title="survminer绘制出图形的保存问题"></a>survminer绘制出图形的保存问题</h2><p><code>survminer</code>中包含一个很方便的函数<code>ggsurvplot</code>, 使用该函数可很方便的绘制生存曲线并加上分组的显著性检验, 还能在图形下方加上频数表.</p><p>但是这个函数跟一般的<code>ggplot</code>系函数的返回并不同, 他返回的并不是一个<code>ggplot()</code>对象, 而是<code>ggsurvplot</code>对象, 这个对象中包含<code>survObj$plot</code>为生存图形本地, <code>survObj$table</code>为频数表图形. 所以如果需要自己使用ggplot的一些语法对图形进行调整修饰的话, 应该对这两个对象内包含的对象进行操作.</p><h2 id="ggpubr至今存在分面图显著性检验标注bug"><a href="#ggpubr至今存在分面图显著性检验标注bug" class="headerlink" title="ggpubr至今存在分面图显著性检验标注bug"></a>ggpubr至今存在分面图显著性检验标注bug</h2><p>截止到去年12月, <code>ggpubr</code>的箱线图(其他未测试, 可能也有)的在分面后附加显著性检验时, 依然存在一定bug, 包括分面后数据不正确, 显著性检验标注位置不正确. 需要手动绘制单个图形然后把他们组合起来</p><h2 id="图内表格标注"><a href="#图内表格标注" class="headerlink" title="图内表格标注"></a>图内表格标注</h2><p>挖坑待补充</p><h2 id="多种显著性标注实现方式"><a href="#多种显著性标注实现方式" class="headerlink" title="多种显著性标注实现方式"></a>多种显著性标注实现方式</h2><p>由于某次甲方的图形提出了比较麻烦的要求, 即进行显著性检验的时候, 以某组作为参考进行, 然后这个某组, 有两个而不是一个, 因此<code>ggpubr</code>本身自带的函数无法满足需求, 我花了好大功夫查找如何手动进行绘制, 不同要求对应的不同实现方法记录在此:</p><p>挖坑待补充</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据可视化 </tag>
            
            <tag> R语言 </tag>
            
            <tag> ggplot2 </tag>
            
            <tag> ggpubr </tag>
            
            <tag> survminer </tag>
            
            <tag> 显著性检验 </tag>
            
            <tag> 生存分析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dash实现从图形上取数据点进行计算</title>
      <link href="/2022/03/13/Dash%E4%BA%A4%E4%BA%92%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE/"/>
      <url>/2022/03/13/Dash%E4%BA%A4%E4%BA%92%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE/</url>
      
        <content type="html"><![CDATA[<p>之前用dash实现了一个比较有趣的交互数据处理案例, 这里记录一下</p><!-- 摘要部分 --><span id="more"></span><p>大概的问题是有很多条的数据, 需要基于数据进行指标计算, 但是甲方并不想使用所有数据, 而是需要将数据条目画成一张点图上, 然后从图形上圈出一部分数据点来, 用这些数据点对应的数据条目完成指标计算, 即交互式的选择部分数据来进行指标计算.</p><p>我看到这个要求的第一反应是去翻Dash有没有相关功能, 没想到还真有, <a href="#">INVALID POST SLUG PROVIDED </a></p><p>最终写起来也比较简单, 给函数加上对选择事件的反馈就行了:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 绘制图形</span></span><br><span class="line">mport plotly.express <span class="keyword">as</span> px</span><br><span class="line">data_b1_p1 = pd.read_csv(<span class="string">&#x27;1st.part1.fmt.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fig_b1_p1 = px.scatter(data_b1_p1, x=<span class="string">&#x27;FFPE_X&#x27;</span>, y=<span class="string">&#x27;FFPE_Y&#x27;</span>, color = <span class="string">&#x27;Pos&#x27;</span>, opacity=<span class="number">0.5</span>)</span><br><span class="line">fig_b1_p1 = fig_b1_p1.update_layout(</span><br><span class="line">    width=<span class="number">600</span>,</span><br><span class="line">    height=<span class="number">600</span></span><br><span class="line">).update_traces(</span><br><span class="line">    mode=<span class="string">&#x27;markers&#x27;</span>, marker_size=<span class="number">2</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设定dash app组建的框架结构, 我这里只放一个div用来放前面的图</span></span><br><span class="line">app.layout = html.Div([</span><br><span class="line">    html.Div([</span><br><span class="line">        dcc.Markdown(<span class="string">&quot;demo titile&quot;</span>),</span><br><span class="line">        dcc.Graph(</span><br><span class="line">            <span class="built_in">id</span>=<span class="string">&#x27;fig_b1_p1&#x27;</span>,</span><br><span class="line">            figure=fig_b1_p1</span><br><span class="line">        ),</span><br><span class="line">        html.Pre(<span class="built_in">id</span>=<span class="string">&#x27;sel_b1_p1&#x27;</span>)</span><br><span class="line">    ],</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据处理函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_mean</span>(<span class="params">selectedData, base</span>):</span><br><span class="line">    <span class="keyword">if</span> selectedData:</span><br><span class="line">        selData = pd.DataFrame(selectedData[<span class="string">&#x27;points&#x27;</span>]).rename(columns=&#123;<span class="string">&#x27;x&#x27;</span>: <span class="string">&#x27;FFPE_X&#x27;</span>,<span class="string">&#x27;y&#x27;</span>: <span class="string">&#x27;FFPE_Y&#x27;</span>&#125;)</span><br><span class="line">        selData = selData.merge(base, how=<span class="string">&#x27;left&#x27;</span>, on=[<span class="string">&#x27;FFPE_X&#x27;</span>, <span class="string">&#x27;FFPE_Y&#x27;</span>]).drop(</span><br><span class="line">            columns=[<span class="string">&#x27;curveNumber&#x27;</span>,<span class="string">&#x27;pointNumber&#x27;</span>,<span class="string">&#x27;pointIndex&#x27;</span>,<span class="string">&#x27;FFPE_X&#x27;</span>,<span class="string">&#x27;FFPE_Y&#x27;</span>, <span class="string">&#x27;Pos&#x27;</span>, <span class="string">&#x27;OID&#x27;</span>, <span class="string">&#x27;Marker&#x27;</span>]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        mean = nanmean(selData[<span class="string">&#x27;col1&#x27;</span>])</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;mean&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;等待选择&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设定响应函数</span></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    Output(<span class="params"><span class="string">&#x27;sel_b1_p1&#x27;</span>, <span class="string">&#x27;children&#x27;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    [Input(<span class="params"><span class="string">&#x27;fig_b1_p1&#x27;</span>, <span class="string">&#x27;selectedData&#x27;</span></span>)]</span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse1</span>(<span class="params">selectedData</span>):</span><br><span class="line">    <span class="keyword">return</span> show_mean(selectedData, data_b1_p1)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>具体来说就是, 用plotly绘制的交互图形, 本来就有region select和lasso select两个功能, 这两个功能选取数据点后, 图形数据会直接存到<code>selectedData</code>这个属性的值中去, 用内置的装饰器可让函数得到这部分数据.</p><p>不过需要注意的是, 返回得到的只有用来绘制图形的数据, 比如我这里是点图, 所以通过<code>selectedData</code>能拿到的就是x, y坐标, 且数据以列表套字典的形式存储, 我需要将其数据框化后, 将原始数据根据坐标再次合并进来(向左合并), 这样就知道选择的点对应哪些数据条目, 之后计算出指标返回就好了.</p><p>原数据不好写示例, 之后找个别的数据写了例子后再更新本blog</p><p>以上~</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据可视化 </tag>
            
            <tag> 交互式分析 </tag>
            
            <tag> Dash </tag>
            
            <tag> Plotly </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Scrapy基本使用</title>
      <link href="/2022/03/13/Scrapy%E4%BD%BF%E7%94%A8/"/>
      <url>/2022/03/13/Scrapy%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>之前曾经尝试过Scrapy爬用药网站的信息, 但是没有做记录, 这次又帮同学爬了点东西所以趁机记录一下.</p><!-- 摘要部分 --><span id="more"></span><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Scrapy是Python下的一个专门用来爬网站的爬虫框架. 相比自己使用<code>request</code>的等比较基础的报来发送请求与解析信息, Scrapy自带了请求处理, 返回解析, 异常处理, 任务队列管理等等一系列功能, 使我们能更好更专业的进行数据爬取工作.</p><p>当然代价就是… 上手门槛变高了一丢丢, 因为得先理解这个框架里的一些基本概念和工作原理. 我当初直接看菜鸟教程给的图… 反正是一脸蒙逼的:</p><p><img src="https://www.runoob.com/wp-content/uploads/2018/10/8c591d54457bb033812a2b0364011e9c_articlex.png" class="lazyload" data-srcset="https://www.runoob.com/wp-content/uploads/2018/10/8c591d54457bb033812a2b0364011e9c_articlex.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="材料教程介绍图"></p><h2 id="案例操作"><a href="#案例操作" class="headerlink" title="案例操作"></a>案例操作</h2><p>本着简化的原则… 我只记录实际操作中需要了解的部分.</p><h3 id="1-新建项目"><a href="#1-新建项目" class="headerlink" title="1. 新建项目"></a>1. 新建项目</h3><p>首先, Scrapy作为框架, 不需要使用者从头开始一行一行写代码, 而是在既有模板下编写操作相关的方法就行. 开启一个新项目时, 使用<code>scrapy startproject demo</code>创建新的项目.</p><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/03/upgit_20220326_1648289689.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/03/upgit_20220326_1648289689.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="创建项目"></p><p>创建完成后, 项目目录下有一堆东西, 不用所有文件都了解, 知道下面几个就行了:</p><p><img src="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/03/upgit_spider_proj_20220326_1648293754.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/silenwang/Gallary/master/2022/03/upgit_spider_proj_20220326_1648293754.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="项目内容"></p><ul><li><code>demo/spiders</code>: 存放爬虫文件的目录, 刚刚建立项目而没有创建爬虫的话, 这个目录下除了<code>__init__.py</code>是没有东西的, 爬虫的具体内容后面介绍</li><li><code>demo/settings.py</code>: 爬虫的配置文件, 请求头, 反爬协议, 任务间隔, COOKIE设置等等等的设置全在里头, 大部分设置看文件内的注释条目就能看懂, 对应设置就行</li><li><code>demo/pipelines.py</code>: 对应上面示例图里的Item Pipeline, 这里是定义对Item处理方案的地方, 当需要使用item这一内置的对象来收集目标信息时需要设置</li><li><code>demo/items.py</code>: 定义Item的文件, 同上, 需要使用item的时候需要在文件内定义item(主要是定义一个item里头要存啥)</li></ul><h3 id="2-新建爬虫"><a href="#2-新建爬虫" class="headerlink" title="2. 新建爬虫"></a>2. 新建爬虫</h3><p>爬虫文件需要进一步运行<code>scrapy genspider</code>来生成, 比如项目下<code>scrapy genspider dSpider www.sample.com</code>就会在<code>demo/spiders/</code>文件夹下生成一个名字为<code>dSpider.py</code>的爬虫文件, 里面的内容大概是这样:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DspiderSpider</span>(scrapy.Spider):</span><br><span class="line">    name = <span class="string">&#x27;dSpider&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;www.sample.com&#x27;</span>]</span><br><span class="line">    start_urls = [<span class="string">&#x27;http://www.sample.com/&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, response</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>使用改爬虫本质上就是对生成的这个爬虫内的方法进行改写, 比如我这次写的:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> JsDemo.items <span class="keyword">import</span> JsdemoItem</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> ceil</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DemoSpider</span>(scrapy.Spider):</span><br><span class="line">    name = <span class="string">&#x27;demo&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;www.cssn.net.cn&#x27;</span>]</span><br><span class="line">    start_urls = [<span class="string">f&#x27;http://www.cssn.net.cn:8000/standards/?a104=IX-ISO&amp;orderby=&amp;post_publicyear=<span class="subst">&#123;year&#125;</span>&#x27;</span> <span class="keyword">for</span> year <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1960</span>, <span class="number">2021</span>)]</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, response</span>):</span><br><span class="line">        pMax = ceil(json.loads(response.text)[<span class="string">&#x27;count&#x27;</span>] / <span class="number">20</span>)</span><br><span class="line">        <span class="keyword">for</span> pNum <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, pMax+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(<span class="string">f&#x27;<span class="subst">&#123;response.request.url&#125;</span>&amp;page=<span class="subst">&#123;pNum&#125;</span>&#x27;</span>, callback=self.parse_next)        </span><br><span class="line">           </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_next</span>(<span class="params">self, response</span>):</span><br><span class="line">        obj = json.loads(response.text)</span><br><span class="line">        item = JsdemoItem()</span><br><span class="line">        item[<span class="string">&#x27;raw&#x27;</span>] = obj[<span class="string">&#x27;results&#x27;</span>]</span><br><span class="line">        <span class="keyword">yield</span> item</span><br></pre></td></tr></table></figure><p>方法<code>parse</code>的写的是爬虫在访问<code>url</code>获取页面信息后如何进行处理. 这里就有多种处理方式了. 如果想按照Scrapy推荐的方式来, 可以像上面一样, 将需要的信息从响应内容中提取出来, 然后存到item中并返回, 这样获取到的信息就会以打包好的item的方式进入千米您提到的Item Pipeline中, 在那里就可以编写获取到Item后最终如何处理和保存数据.</p><p>如果嫌麻烦, 想自己处理, 也可以在<code>parse</code>方法内就直接处理掉, 比如直接建立数据框, 然后直接将这些内容写到文件. 这样就不用走后面的东西了.</p><p>具体采取哪种方式视任务需要而定就好.</p><h3 id="3-处理Item"><a href="#3-处理Item" class="headerlink" title="3. 处理Item"></a>3. 处理Item</h3><p>如果采取使用item的方式, 那就还要去<code>demo/pipelines.py</code>中编写处理数据的部分:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define your item pipelines here</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Don&#x27;t forget to add your pipeline to the ITEM_PIPELINES setting</span></span><br><span class="line"><span class="comment"># See: https://docs.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># useful for handling different item types with a single interface</span></span><br><span class="line"><span class="keyword">from</span> itemadapter <span class="keyword">import</span> ItemAdapter</span><br><span class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> DataFrame</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JsdemoPipeline</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.full = []</span><br><span class="line">        self.col_map = &#123;</span><br><span class="line">            <span class="string">&#x27;yf001&#x27;</span>: <span class="string">&#x27;识别号&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;a000&#x27;</span>: <span class="string">&#x27;状态&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;a104&#x27;</span>: <span class="string">&#x27;发布单位&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;a104name&#x27;</span>: <span class="string">&#x27;发布单位名称&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;a100&#x27;</span>: <span class="string">&#x27;标准号&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;yf100&#x27;</span>: <span class="string">&#x27;其他标准号&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;a298&#x27;</span>: <span class="string">&#x27;中文题名(仅供参考)&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;a301&#x27;</span>: <span class="string">&#x27;原文题名&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;a826&#x27;</span>: <span class="string">&#x27;ICS分类号&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;a101&#x27;</span>: <span class="string">&#x27;发布日期&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">open_spider</span>(<span class="params">self, spider</span>):</span><br><span class="line">        self.file = <span class="built_in">open</span>(<span class="string">&#x27;items.jl&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self, item, spider</span>):</span><br><span class="line">        self.full.extend(item[<span class="string">&#x27;raw&#x27;</span>])</span><br><span class="line">        line = json.dumps(item[<span class="string">&#x27;raw&#x27;</span>]) + <span class="string">&quot;\n&quot;</span></span><br><span class="line">        self.file.write(line)</span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close_spider</span>(<span class="params">self, spider</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;#########run##########&quot;</span>)</span><br><span class="line">        df = DataFrame(self.full)[self.col_map.keys()].rename(columns=self.col_map)</span><br><span class="line">        df.to_csv(<span class="string">&#x27;full.data.csv&#x27;</span>, index=<span class="number">0</span>)</span><br><span class="line">        self.file.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><code>open_spider</code> 方法是爬虫启动时会执行的代码, 一般是打开需要写的文件或者与需要写入的数据库进行连接和初始化</li><li><code>process_item</code> 部分则是爬虫每返回一个item时, 对这个item进行何种处理, 我这里做的是把原始得到的json字串存到文件中, 另外是把key做替换后, 存到一个字典中</li><li><code>close_spider</code> 方法是当爬虫获取完所有信息后, 执行的内容, 比如我这里有将字典内的信息转换为数据框, 然后数据框内容写入文件, 另外就是把之前打开的文件句柄给关掉</li></ul><h3 id="4-其他设置"><a href="#4-其他设置" class="headerlink" title="4. 其他设置"></a>4. 其他设置</h3><p>如果有更改请求头, 挂代理, 设置访问间隔防止被封IP之类的需要, 那就回到<code>demo/setting.py</code>文件里去更改就好了.</p><h3 id="5-运行爬虫"><a href="#5-运行爬虫" class="headerlink" title="5. 运行爬虫"></a>5. 运行爬虫</h3><p>这个最简单了, 项目目录里<code>scrapy crawl demo</code>, 然后就可以观察运行状况了, 工作日志会直接打印在屏幕上, 可以根据日志进行调试</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>以上就是基本的使用了, 对Scrapy的工作方式进行小结的话, 就是我们需要自己定义爬虫要爬取什么网站, 然后在<code>parse</code>方法中写明如何解析请求返回的内容, </p><h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p>本次记录的爬虫案例有一个前提, 就是通过简单的get或post请求获得的响应就能包含我们想要获取的数据. 但是随着网页技术的发展, 月来越多网站不再是只有html的静态网站了… 大部分网站都多少有通过js加载的内容, 甚至整个网页都是js或其他框架渲染出来的, 这种时候简单的请求是无法取回想要的数据的, 也就要结合splash这样的渲染引擎一并使用了. </p><p>关于这个下次再记录.</p><p>以上~</p>]]></content>
      
      
      <categories>
          
          <category> Script </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 爬虫 </tag>
            
            <tag> 框架 </tag>
            
            <tag> 数据采集 </tag>
            
            <tag> Scrapy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>钉钉Linux版能正常用了</title>
      <link href="/2022/02/22/%E9%92%89%E9%92%89Linux%E7%89%88%E8%83%BD%E6%AD%A3%E5%B8%B8%E7%94%A8%E4%BA%86/"/>
      <url>/2022/02/22/%E9%92%89%E9%92%89Linux%E7%89%88%E8%83%BD%E6%AD%A3%E5%B8%B8%E7%94%A8%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>虽然钉钉某种程度上确实是个压榨人的工具, 但是毕竟工作要用到, 与又被压榨又被恶心… 能去掉一个恶心已经算不错了(说的就是你腾讯)</p><!-- 摘要部分 --><span id="more"></span><p>感谢<a href="https://aur.archlinux.org/packages/dingtalk-bin">FlyInWind</a>在AUR上给出的解决方案, 钉钉Linux版本在Arch系下也可以正常使用了, 目前我所有要用的组件都正常(聊天, 工作台的审批, 文档, 项目管理, 在线文档分析), 视频会议本周应该会试用到, 如果也正常…可就齐活了</p><p>目前开发者应该是已经把FlyInWind提出的方案直接写到构建文件里了, 使用AUR安装的钉钉直接就把<code>libgtk-x11-2.0.so</code>等两个文件删除了, 只要按照dbh625说的在启动脚本加入以下代码即可完美使用.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> XMODIFIERS=<span class="string">&quot;@im=fcitx&quot;</span></span><br><span class="line"><span class="built_in">export</span> QT_IM_MODULE=<span class="string">&quot;fcitx&quot;</span></span><br><span class="line"><span class="built_in">export</span> QT_QPA_PLATFORM=xcb</span><br></pre></td></tr></table></figure><p>期待所有国产常用软件都能有功能完整的Linux版本的一天</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 钉钉 </tag>
            
            <tag> AUR </tag>
            
            <tag> Arch Linux </tag>
            
            <tag> 办公软件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Graphviz配合draw.io使用</title>
      <link href="/2021/10/20/Graphviz%E9%85%8D%E5%90%88draw-io%E4%BD%BF%E7%94%A8/"/>
      <url>/2021/10/20/Graphviz%E9%85%8D%E5%90%88draw-io%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>自从会了Graphviz后, 经常会用它来做流程图或者简单的示意图, 大部分使用它都是比较好用的, 因为流程图比较小, 同时也只用来示意, 并不用于展示. 但是当流程图较复杂, 同时有美化和展示的需要, 就会比较麻烦了.</p><!-- 摘要部分 --><span id="more"></span><p>因此我找到了一个折中的办法, 先用graphviz确定草图, 然后使用<a href="https://github.com/hbmartin/graphviz2drawio">graphviz2drawio</a>来对写好的graphviz进行格式转换, 转换好的草图再导入<a href="https://github.com/jgraph/drawio">drawio</a>来手动进行编排</p><p>实际用下来这个方案也并不是特别好用… 导入的流程图大致框架是有, 但是原来graphviz中的图形不会保留(圆啊方块什么的), 同时部分graphviz里的对象在drawio中并不存在, 所以用graphviz做草图的话, 最多只能保留基本的骨架, 需要继续调整的东西还是挺多的. 所以之后还是要么再学一个使用drawio的语言, 要么找一个别的类似drawio的工具来导入graphviz后进行进一步的编辑.</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 流程图 </tag>
            
            <tag> 图表工具 </tag>
            
            <tag> graphviz </tag>
            
            <tag> drawio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密特罗德</title>
      <link href="/2021/10/18/%E5%AF%86%E7%89%B9%E7%BD%97%E5%BE%B7/"/>
      <url>/2021/10/18/%E5%AF%86%E7%89%B9%E7%BD%97%E5%BE%B7/</url>
      
        <content type="html"><![CDATA[<p>对我来说, 密特罗德是个很神奇的游戏, 因为我虽然知道其是银河城的鼻祖之一, 但是我从小就只玩过恶魔城, 对于这个系列却比较没兴趣…</p><p><img src="https://image.gcores.com/f3d38742-2986-468a-af44-5956200993f7.jpg?x-oss-process=image/resize,limit_1,m_lfit,w_1250/quality,q_90" class="lazyload" data-srcset="https://image.gcores.com/f3d38742-2986-468a-af44-5956200993f7.jpg?x-oss-process=image/resize,limit_1,m_lfit,w_1250/quality,q_90" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><!-- 摘要部分 --><span id="more"></span><p>直到20年初的新冠疫情, 当时在广州多待了两个星期, 笔记本上没有啥游戏可玩, 只带了3DS回家, 实在不知道玩啥所以下了3DS上的萨姆斯归来试试. 其实刚玩上的时候, 我也没觉得有啥特别, 毕竟玩过这个类型, 而且3DS玩动作类确实手累…</p><p>但是, 这个游戏神奇就神奇在, 我虽然不觉得有多么好玩, 但是我不知不觉… 就给它打通关了… 这一点跟3DS上的塞尔达三角力量如出一辙. 两者都不是我会心心念念想继续打的游戏, 但是一旦玩上了, 就… 直接给打通关了…</p><p>然后再一次让我重新认识这个系列的神奇, 是上手玩了血污之后… 血污是经典的月下+晓月的结合, 发售后大家也直呼去nmd精神续作, 这就是恶魔城正统续作. 但是在我实际玩之后, 我发现我没有当年喜欢晓月一样那么喜欢血污, 刨去它在NS上至今读盘表现欠佳之外, 我明确感受到了血污较重的RPG成分以及较重的战斗比例. 同时我也发现相比于战斗… 我其实更喜欢这类游戏的探索部分…</p><p>所以我就原价购买了生存恐惧… 同时在花了一星期通关后… 感觉到它的体验对我来说比血污好了太多…</p><p>希望横版的密特罗德以后还能有续作吧…</p>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 密特罗德 </tag>
            
            <tag> 银河城 </tag>
            
            <tag> 恶魔城 </tag>
            
            <tag> 3DS </tag>
            
            <tag> Metroid </tag>
            
            <tag> Samus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大逆转裁判2，精彩的同时让人不知道说什么好</title>
      <link href="/2021/10/17/%E5%A4%A7%E9%80%86%E8%BD%AC%E8%A3%81%E5%88%A42/"/>
      <url>/2021/10/17/%E5%A4%A7%E9%80%86%E8%BD%AC%E8%A3%81%E5%88%A42/</url>
      
        <content type="html"><![CDATA[<p>中秋的时候不想加班, 一口气把大逆2后两个案子打完了, 剧本真的不输成步堂三部曲, 同时相比最后一个案子, 倒数第二的“未来科学与亡灵归还”更让我印象深刻…</p><img src="http://static.dianwannan.com/static/allimg/191130/7-191130144042624.jpg" class="lazyload" data-srcset="http://static.dianwannan.com/static/allimg/191130/7-191130144042624.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" width="50%" height="50%"><!-- 摘要部分 --><span id="more"></span><p>这个案子里涉及到了两个研究人员, 其中一位在学生期间, 为了生存和研究经费, 跑去盗尸以卖给大学的医学院… 另外一位研究人员, 深信自己的理论没有问题, 然而苦于没有经费去验证, 结果被别有用心的商人利用来骗取政府提供的研究经费.</p><p>让我印象深刻的点有两个:</p><ul><li>学生盗取尸体以进行医学研究, 甚至老师指示学生去盗取尸体进行医学研究, 这在医学发展过程中是确实存在的, 制作组考证到了这一点, 并把这一点融入了故事, 挺用心的.</li><li>两个研究人员经历的事完全不一样, 但是都反映了一个问题, 对年轻的研究者来说, 科学研究不仅需要才华, 还需要资源或者大量的金钱, 这个矛盾至今都是存在的… 不知道制作组从哪取的材, 写出了这么一个有点影射现实的故事.</li></ul><p>其实虽然个人觉得大逆的剧本精彩程度跟成步堂三部曲差不多, 但是如果再去想现实意义的话… 感觉大逆还是更深刻和黑暗的多. 成步堂三部曲中存在不少的非现实元素, 什么审鹦鹉审电话这种情节, 加之大量有各种夸张表现的角色, 作为游戏, 让人玩的开心没有啥问题. </p><p>大逆转则非常不一样了, 除了最后一个案子里面的情节我觉得比较脱线… 其余很多案子中的情节感觉多少有些影射的意义: 与英国刺客相关案子中的外交困境, 夏目漱石两个案子里反映出身在异乡的留学生面临的非议, 前面说的青年研究者的困境, 以及本系列中强调的, 法庭上证据, 尤其是物证的重要性. 这一切都让大逆转更有解决疑难案件的感觉, 而不是精心设计的法庭辩论游戏.</p><p>希望以后还有续作吧~</p>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 大逆转裁判 </tag>
            
            <tag> 成步堂三部曲 </tag>
            
            <tag> 游戏评论 </tag>
            
            <tag> 医学伦理 </tag>
            
            <tag> 科研困境 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssh默认不支持rsa了</title>
      <link href="/2021/10/11/ssh%E9%BB%98%E8%AE%A4%E4%B8%8D%E6%94%AF%E6%8C%81rsa%E4%BA%86/"/>
      <url>/2021/10/11/ssh%E9%BB%98%E8%AE%A4%E4%B8%8D%E6%94%AF%E6%8C%81rsa%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>今天升级manjaro后最基本的ssh登陆突然出问题了, 提示有几种:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Unable to negotiate with UNKNOWN port 65535: no matching host key <span class="built_in">type</span> found. Their offer: ssh-rsa,ssh-dss</span><br><span class="line">lost connection</span><br><span class="line"></span><br><span class="line">sign_and_send_pubkey: no mutual signature supported</span><br></pre></td></tr></table></figure><p>一查发现…好嘛, <a href="https://www.openssh.com/releasenotes.html">openssh觉得ssh-rsa加密方式不安全, 直接从8.8开始默认不允许这种密钥用于登陆了</a>…</p><!-- 摘要部分 --><span id="more"></span><p>本来想这manjaro落后arch一定版本, 所以又跑去archwiki找解决办法, 没想到还没写到里面去…兜兜转转查了半小时, 发现可以在<code>~/.ssh/config</code>里面加这么一段解决:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Host *</span><br><span class="line">    PubkeyAcceptedKeyTypes +ssh-rsa</span><br><span class="line">    HostKeyAlgorithms +ssh-rsa</span><br></pre></td></tr></table></figure><p>第一行说明对所有主机生效, 第二行是将<code>ssh-rsa</code>加会允许使用的范围, 第三行是指定所有主机使用的都是<code>ssh-rsa</code>算法的key.<br>实测两行都得要写才行, 没有第二行提示没有<code>ssh-rsa</code>这么个类型, 没有第三行就提示<code>sign_and_send_pubkey: no mutual signature supported</code>.</p><p>以上~</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
            <tag> openssh </tag>
            
            <tag> manjaro </tag>
            
            <tag> rsa加密 </tag>
            
            <tag> ssh配置 </tag>
            
            <tag> 密钥认证 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于dash与flask搭建一个任务监控web-app</title>
      <link href="/2021/06/21/%E5%9F%BA%E4%BA%8Edash%E4%B8%8Eflask%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E7%9B%91%E6%8E%A7web-app/"/>
      <url>/2021/06/21/%E5%9F%BA%E4%BA%8Edash%E4%B8%8Eflask%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E7%9B%91%E6%8E%A7web-app/</url>
      
        <content type="html"><![CDATA[<p>鸽了都快大半年了, 自从接锅以来, 事情一直都多得做不完… 也就没那个兴致写东西, 不过这一次算是将半年来新学的一些东西做了综合应用, 写了我人生中第一个带数据库操作的Web-App, 所以还是应该纪念一下, 不过时间有限, 先写文本, 图片以后再补…</p><!-- 摘要部分 --><span id="more"></span><p>这个app实现的是类似NCBI Blast那种分析服务, 目的是让用户能通过Web界面提交分析任务, 并从监控列表中了解已提交任务的分状态, app提供了一个极其简陋的分析界面, 用户可在界面选择必要的输入文件和配置文件(事先登录到数据库)后, 开始分析任务, 并通过监控栏了解已提交任务的运行状态. 当然这个Web见面其实不是给用户用的, 而是作为与前端IT交流的Demo, 并在日后供我自己测试使用, 真正派上用场的是内建的Web-API, 应用通过响应前端发来的Web请求来完成实际的业务工作</p><h2 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h2><p>本次的Web-App功能虽然简陋, 但是实现起来其实用了不少东西, 同时也花了不少时间在一些内容的组合实现上, 本次只着重于实际实现过程中一些问题的解决方式, 一些新模块的基本操作(dash, python操作mongoDB之类)之后可能会单独再水一次</p><h3 id="Web-API"><a href="#Web-API" class="headerlink" title="Web API"></a>Web API</h3><p>API基于Flask构建, 之所以不采用Django是因为介绍里说Flask更轻量简洁, 毕竟我们也不是搭什么巨型高并发高计算量的API, 我觉得用这个更简单</p><h3 id="Web操作界面"><a href="#Web操作界面" class="headerlink" title="Web操作界面"></a>Web操作界面</h3><p>Web界面基于Dash构建, Dash与R语言中的Shiny是完全同性质的东西, 只不过这东西在中文生信群体中似乎完全没有存在感, 中文材料基本都是英文机翻. 当然英文材料似乎也不如Shiny来的多, 主要还是以官方的文档和官方的Q&amp;A为主. 不过我既然现在主语言是Python, 使用基于Python的东西肯定比和R混编简单得多. 另外虽然我的App很简单, 但是相对过去写的生信小脚本那还是复杂了好几个量级的… 因此Python的错误追踪还是及其救命的, 不至于让我在Debug上浪费巨量的时间</p><p>另外值得一提的是, Dash是从Plotly这个绘图包发展而来的, 同时Dash提供的Web-App也是在Flask基础上实现的, 所以Dash界面+Flask处理Web请求在我当前的应用场景下极佳的组合, 因为我可以在一个主程序文件内同时写Dash函数和Flask函数, 减少重复工作, 同时也保证我测试展现的东西和同事通过API获取的东西是一致的</p><h3 id="后端任务控制"><a href="#后端任务控制" class="headerlink" title="后端任务控制"></a>后端任务控制</h3><p>任务控制基于Snakemake进行, 这个就不多说了, 值得一提的是用了这么长时间之后, 我对Snakemake文档里面的那句, Snakemake is python code这句话有了更好的理解, 因为这个特性的存在, 我能在Snakemake里面通过自编写的一些函数实现Snakemake当前没有实现的特性. 比如在这个应用中的任务状态自动更新</p><h3 id="文件记录与任务记录-数据库"><a href="#文件记录与任务记录-数据库" class="headerlink" title="文件记录与任务记录(数据库)"></a>文件记录与任务记录(数据库)</h3><p>任务和文件记录使用了mongoDB进行数据存储, 其实如果单单只是要构建这个App的话, 并不需要用到任何数据库, 使用简单的文件做存储, 或者直接将内容存储在设定好结构的目录里也可以, 使用数据库纯粹是为了进行简单的数据库操作练习, 因为后面有别的工作会用.</p><p>而选择mongoDB, 不使用之前已经用过的SQLite, 也是出于后面工作的考虑, 因此提前拿简单的内容进行mongoDB练手</p><h3 id="Api文档"><a href="#Api文档" class="headerlink" title="Api文档"></a>Api文档</h3><p>Api文档这个其实最开始并不在应用规划内容里面, 是因为近期搭建了非常多简单的Web服务以实现公司内部的分析上系统, Api一多了, 一个Api准备一份文档存和查询起来相当不方便, 同时因为预计不同的Api会交给不同人, 另外维护一份总的文档也比较烦, 因此我想是否有方式能把Api文档直接生成在单个Web-App下面, 最后就选定了<code>flasgger</code>, 这个模块的作用是在flask内引入一系列API, 方便作者直接在Python代码内编写Api文档, 编写的文档可以调用Swagger UI直接在应用路径下形成一份Api文档</p><h2 id="应用总览"><a href="#应用总览" class="headerlink" title="应用总览"></a>应用总览</h2><p>本App其实逻辑很简单, 就是前端接受请求, 将请求转发到后端启动分析进程, 分析进程在运行过程中不断将状态更新到数据库, 然后前端定时或者根据请求从数据库获取程序运行状态就好, 大概的信息流见下图</p><p><img src="/" class="lazyload" data-srcset="/" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="这里咕了一张图"></p><h2 id="实现要点"><a href="#实现要点" class="headerlink" title="实现要点"></a>实现要点</h2><p>虽然这个应用简单, 但是实际实施过程中还是有问题是要额外想办法解决的:</p><ol><li>保证Dash-App处理和Flask-API处理的一致性, 即使用Dash-App完成测试后不需要额外对Flask-API部分进行改动</li><li>Dash-App&#x2F;Flask-App&#x2F;API文档的混用, 即让所有这些东西都在同一个App下, 而不是搭建多个Web-App然后相互跳转</li><li>利用Snakemake控制进程本身将运行状态更新到数据库, 而不另外设立单独的监控进程</li></ol><h3 id="Dash-App和Flask-API处理的一致性"><a href="#Dash-App和Flask-API处理的一致性" class="headerlink" title="Dash-App和Flask-API处理的一致性"></a>Dash-App和Flask-API处理的一致性</h3><p>这一点其实很好实现了… 就是把实际的业务处理函数跟Dash和Flask的函数分开就好, 也就是Dash和Flask的响应函数将数据处理成统一的格式, 然后交由一个实际的业务函数来执行数据处理, 两个响应函数得到处理的数据后再分别格式化为Dash需要的内容或API中设定好的格式:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">                [</span></span></span><br><span class="line"><span class="params"><span class="meta">                    Output(<span class="params"><span class="string">&#x27;info-div&#x27;</span>, <span class="string">&#x27;children&#x27;</span></span>)</span></span></span><br><span class="line"><span class="params"><span class="meta">                ],</span></span></span><br><span class="line"><span class="params"><span class="meta">                [</span></span></span><br><span class="line"><span class="params"><span class="meta">                    Input(<span class="params"><span class="string">&#x27;upload-info&#x27;</span>, <span class="string">&#x27;contents&#x27;</span></span>)</span></span></span><br><span class="line"><span class="params"><span class="meta">                ],</span></span></span><br><span class="line"><span class="params"><span class="meta">                [</span></span></span><br><span class="line"><span class="params"><span class="meta">                    State(<span class="params"><span class="string">&#x27;upload-info&#x27;</span>, <span class="string">&#x27;filename&#x27;</span></span>)</span></span></span><br><span class="line"><span class="params"><span class="meta">                ]</span></span></span><br><span class="line"><span class="params"><span class="meta">            </span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">step2_dash</span>(<span class="params">content, filename</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    dash响应函数</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 需要从文件解析目标路径</span></span><br><span class="line">    <span class="keyword">if</span> content:</span><br><span class="line">        _, content_stream = content.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        info_data = step2(content_stream, filename)</span><br><span class="line">        json_fmt = dumps(info_data, sort_keys=<span class="literal">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;:&quot;</span>), ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> [html.Pre(<span class="string">f&#x27;解析成功, 从信息表中提取的信息:\n<span class="subst">&#123;json_fmt&#125;</span>&#x27;</span>)]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> [html.Pre(<span class="string">&#x27;无解析结果&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.server.route(<span class="params"><span class="string">&#x27;/step2&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">step2_flask</span>():</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    flask响应函数</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">     data = loads(flask.request.form.get(<span class="string">&#x27;data&#x27;</span>))</span><br><span class="line">     fileUrl = <span class="string">f&#x27;<span class="subst">&#123;data[<span class="string">&quot;dowloadFileUrl&quot;</span>]&#125;</span>?type=<span class="subst">&#123;data[<span class="string">&quot;type&quot;</span>]&#125;</span>&amp;fileName=<span class="subst">&#123;data[<span class="string">&quot;fileName&quot;</span>]&#125;</span>&#x27;</span></span><br><span class="line">     filename = re.findall(<span class="string">r&#x27;fileName=(.+)&#x27;</span>, fileUrl)[<span class="number">0</span>]</span><br><span class="line">     r = requests.get(fileUrl)</span><br><span class="line">     info_data = step2(r.content, filename, decode=<span class="literal">False</span>)</span><br><span class="line">     res_data = &#123;<span class="string">&#x27;errCode&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;data&#x27;</span>: info_data, <span class="string">&#x27;msg&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">    json_fmt = dumps(res_data, sort_keys=<span class="literal">True</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> json_fmt.encode(encoding=<span class="string">&quot;UTF-8&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">step2</span>(<span class="params">content_stream, filename, decode=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    step2的实际处理部分, 拆分出来分别接收不同的请求</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> decode:</span><br><span class="line">        decoded = base64.b64decode(content_stream)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        decoded = content_stream</span><br><span class="line">    info_data = data_format(decoded, filename)</span><br><span class="line">    <span class="keyword">return</span> info_data</span><br></pre></td></tr></table></figure><h3 id="Dash-App-Flask-App-API文档混用"><a href="#Dash-App-Flask-App-API文档混用" class="headerlink" title="Dash-App&#x2F;Flask-App&#x2F;API文档混用"></a>Dash-App&#x2F;Flask-App&#x2F;API文档混用</h3><p>Flask和Api文档的混用其实比较简单, 因为flasgger本来就是个flask加API文档的. 而Dash和Flask的混用其实也不难, Dash对象有一个<code>server</code>属性, 这里面存的就是Flask App对象, 所以其实需要用到该对象的部分直接<code>app.server</code>就好了:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dash</span><br><span class="line"></span><br><span class="line">app = dash.Dash(<span class="string">&quot;Demo&quot;</span>)</span><br><span class="line"></span><br><span class="line">app.server.config[<span class="string">&#x27;SWAGGER&#x27;</span>] = &#123;</span><br><span class="line">    <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;质谱信息录入/报告生成服务文档&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;uiversion&#x27;</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line">swagger = Swagger(app.server)</span><br><span class="line"></span><br><span class="line">app.layout = html.Div(</span><br><span class="line">    [</span><br><span class="line">        html.H1(<span class="string">&#x27;Demo&#x27;</span>),</span><br><span class="line">        html.Div([</span><br><span class="line">            dcc.Upload(</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&#x27;upload-info&#x27;</span>,</span><br><span class="line">                children=html.Div([</span><br><span class="line">                    <span class="string">&#x27;upload here&#x27;</span>,</span><br><span class="line">                ]),</span><br><span class="line">            ),</span><br><span class="line">            html.Div([</span><br><span class="line">                html.Pre(<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            ], <span class="built_in">id</span>=<span class="string">&#x27;info-div&#x27;</span>)</span><br><span class="line">        ])</span><br><span class="line">    ],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">                [</span></span></span><br><span class="line"><span class="params"><span class="meta">                    Output(<span class="params"><span class="string">&#x27;info-div&#x27;</span>, <span class="string">&#x27;children&#x27;</span></span>)</span></span></span><br><span class="line"><span class="params"><span class="meta">                ],</span></span></span><br><span class="line"><span class="params"><span class="meta">                [</span></span></span><br><span class="line"><span class="params"><span class="meta">                    Input(<span class="params"><span class="string">&#x27;upload-info&#x27;</span>, <span class="string">&#x27;contents&#x27;</span></span>)</span></span></span><br><span class="line"><span class="params"><span class="meta">                ],</span></span></span><br><span class="line"><span class="params"><span class="meta">                [</span></span></span><br><span class="line"><span class="params"><span class="meta">                    State(<span class="params"><span class="string">&#x27;upload-info&#x27;</span>, <span class="string">&#x27;filename&#x27;</span></span>)</span></span></span><br><span class="line"><span class="params"><span class="meta">                ]</span></span></span><br><span class="line"><span class="params"><span class="meta">            </span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">step2_dash</span>(<span class="params">content, filename</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    dash响应函数</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> [html.Pre(<span class="string">&#x27;parsed&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.server.route(<span class="params"><span class="string">&#x27;/step2&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">step2_flask</span>():</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    flask响应函数</span></span><br><span class="line"><span class="string">    ---</span></span><br><span class="line"><span class="string">    tags:</span></span><br><span class="line"><span class="string">        - Step2</span></span><br><span class="line"><span class="string">    parameters:</span></span><br><span class="line"><span class="string">        - name: dowloadFileUrl</span></span><br><span class="line"><span class="string">          in: query</span></span><br><span class="line"><span class="string">          type: string</span></span><br><span class="line"><span class="string">          required: true</span></span><br><span class="line"><span class="string">          description: 文件下载地址</span></span><br><span class="line"><span class="string">    responses:</span></span><br><span class="line"><span class="string">        200:</span></span><br><span class="line"><span class="string">            description: 返回解析完成的数据</span></span><br><span class="line"><span class="string">            schema:</span></span><br><span class="line"><span class="string">                properties:</span></span><br><span class="line"><span class="string">                    errorCode:</span></span><br><span class="line"><span class="string">                        type: number</span></span><br><span class="line"><span class="string">                        description: 状态码</span></span><br><span class="line"><span class="string">                        default: 0</span></span><br><span class="line"><span class="string">                    data:</span></span><br><span class="line"><span class="string">                        type: string</span></span><br><span class="line"><span class="string">                        description: 投递任务的key</span></span><br><span class="line"><span class="string">                        default: parsed</span></span><br><span class="line"><span class="string">                    msg:</span></span><br><span class="line"><span class="string">                        type: string</span></span><br><span class="line"><span class="string">                        description: 正常时为空字串, 状态码不为0时会附带错误信息</span></span><br><span class="line"><span class="string">                        default: &quot;&quot;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;parsed&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="利用Snakemake控制进程本身更新运行状态"><a href="#利用Snakemake控制进程本身更新运行状态" class="headerlink" title="利用Snakemake控制进程本身更新运行状态"></a>利用Snakemake控制进程本身更新运行状态</h3><p>最开始我是考虑用Snakemake自带的<code>onstart</code>和<code>onerror</code>特性来实现的, 毕竟我要的其实就是任务开始和结束的时候向数据库提交最新的运行信息.<br>但实际操作以后发现这两个特性是针对整个Snakefile起效的, 也就是总任务开始前执行一次, 然后总任务失败的时候执行一次, 并不提供单个任务的响应, 那就只能自己动手了…</p><p>这时候就要利用Snakemake is python code的特性了. 在一条规则(rule)内, 指定<code>shell</code>关键字时其实是在调用snakemake内部Api中的<code>shell</code>函数执行系统级的命令, 所以其实写<code>run: shell(&#39;BASH_SCRIPT&#39;)</code>的方式是一样的(程序表现上还有一点额外差异, 这里忽略), 但是改用这种方式之后, 我就可以在系统命令的前后来额外增加其他的python代码来实现我要的功能了, 比如执行前后都更新一次任务状态:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rule step1:</span><br><span class="line">    input:</span><br><span class="line">        done = &#x27;&#123;rid&#125;/analysis.done&#x27;</span><br><span class="line">    output:</span><br><span class="line">        txt = &#x27;&#123;rid&#125;/done.txt&#x27;,</span><br><span class="line">    run:</span><br><span class="line">        # update_status是更新状态的函数, rid是任务编号</span><br><span class="line">        update_status(rid, &#x27;step1&#x27;, &#x27;running&#x27;)</span><br><span class="line">        shell(</span><br><span class="line">            &#x27;&#x27;&#x27;</span><br><span class="line">            cp &#123;input.done&#125; &#123;output.txt&#125;</span><br><span class="line">            &#x27;&#x27;&#x27;</span><br><span class="line">        )</span><br><span class="line">        update_status(rid, &#x27;step1&#x27;, &#x27;done&#x27;)</span><br></pre></td></tr></table></figure><p>如此就方便的实现了目的了. 另外, 对于错误时的处理不需要这么进行, 因为错误状态在本应用中不需要精确到规则, 利用<code>onerror</code>就可以了</p><p>不过还需要注意一点, 就是Sanakemake其实支持一项名为papernote的服务, 该服务可专门收集主控流程的任务状态的, 也就是说Snakemake其实内建有类似的东西, 不过这就需要去读一读相关部分的代码来了解怎么实现的了, 也许内部API有更好用的方式呢?</p><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>去年的时候我面试过一个生信工程师, 他在疫情期间回不了公司, 就自己在家自学代码然后写了个分析提交&#x2F;监控服务. 现在我总算是也会了… 回看一下的话, 其实真的不难, 只是需要时间和一定的外部动力推着我学… 另外就是实践还是重要的, 只有实践才能发现实际的问题, 然后解决了问题, 能力也就随之提高了, 我以后还是要多加油…</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生物信息学 </tag>
            
            <tag> snakemake </tag>
            
            <tag> python </tag>
            
            <tag> 任务监控 </tag>
            
            <tag> Web应用 </tag>
            
            <tag> flask </tag>
            
            <tag> dash </tag>
            
            <tag> mongoDB </tag>
            
            <tag> flasgger </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>给我的坚果Pro刷魔趣</title>
      <link href="/2021/02/12/%E7%BB%99%E6%88%91%E7%9A%84%E5%9D%9A%E6%9E%9CPro%E5%88%B7%E9%AD%94%E8%B6%A3/"/>
      <url>/2021/02/12/%E7%BB%99%E6%88%91%E7%9A%84%E5%9D%9A%E6%9E%9CPro%E5%88%B7%E9%AD%94%E8%B6%A3/</url>
      
        <content type="html"><![CDATA[<p>手上的坚果pro用了3年多了, 什么程序都卡, 空间成天不够用, 是在有些扶不住, 故趁此佳节… 做最后挣扎… 死马做活马医, 刷个机试试, 要是刷成了… 那再撑个一年半载, 要是不行壮烈了… 那就忍痛用年终奖买个新的吧…</p><!-- 摘要部分 --><span id="more"></span><h2 id="工具准备"><a href="#工具准备" class="headerlink" title="工具准备"></a>工具准备</h2><p>说起上次刷机, 真的是很久远的事情了… 那时候安卓机刚兴起, 大家除了玩手机软件, 也喜欢玩手机系统, 所以各种各样的定制rom层出不穷. 现在的话, 不是出于个人的特殊需求或者像我这样原生系统实在用不下去的, 大概不会刷机了吧? 现在刷机似乎也没有原来简单了… 至少我这台需要专门的线才行… 当然也得感谢有人在编译和维护这台机器的rom. 那么所有需要的东西如下:</p><ol><li>9008刷机线一根(淘宝10块)</li><li><a href="#">INVALID POST SLUG PROVIDED </a></li><li>刷入TWRP用工具(<code>QPST</code> for win, <code>qdl</code> for linux, 需要<code>yay -S qdl</code>, 是AUR的包)</li><li>坚果Pro对应的<a href="https://download.mokeedev.com/odin.html">底包</a>(<code>RADIO-odin*</code>和<a href="https://download.mokeedev.com/odin.html">系统包</a>(<code>MK90.0-odin*</code>)</li></ol><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><p>操作步骤基本是按开发者给的<a href="https://bbs.mokeedev.com/t/topic/14503">教程</a>来的, 不过我不是windows用户, 所以用的刷入工具不太一样(当然其实我这次两种都试了, 但是windows上的工具反而不行, 只是让我确定了机器处于9008模式). 另外了能因为买到的9008线和教程中提到的不一致, 因此实际进9008的方式跟教程不是很一致(我买的线上的按钮是按一下就会卡住, 再按一次会弹回的).</p><p>至于刷机前文件备份什么的… 我只备份了微信聊天记录… 其他随便吧… 反正我很久不打电话发短信了… 然后我的手机刷机前更新到的官方最新的系统, 之前没有进行过任何刷机.</p><h3 id="底包和系统包放入SD卡"><a href="#底包和系统包放入SD卡" class="headerlink" title="底包和系统包放入SD卡"></a>底包和系统包放入SD卡</h3><p>我的手机有个32g的SD卡, 我是直接把底包和系统包都放SD卡上了, 放内置存储应该是可以的, 因为后面刷的时候有看到选项, 不过因为没有实操暂且未知.</p><h3 id="电脑运行qdl-等待手机插入"><a href="#电脑运行qdl-等待手机插入" class="headerlink" title="电脑运行qdl, 等待手机插入"></a>电脑运行qdl, 等待手机插入</h3><p>下载好TWRP, 安装好<code>qdl</code>, 把TWRP解压出来进入解压的目录, 运行下面命令见到<code>Waiting for QDL tty...</code>就可以了. 当然如果失败了再尝试要再运行一次</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo qdl prog_emmc_firehose_8953_ddr.mbn rawprogram_unsparse.xml</span><br></pre></td></tr></table></figure><h3 id="手机进9008模式-自动开始刷机"><a href="#手机进9008模式-自动开始刷机" class="headerlink" title="手机进9008模式, 自动开始刷机"></a>手机进9008模式, 自动开始刷机</h3><ol><li>长按电源关机</li><li>9008线连接电脑USB口</li><li>同时按住音量+-两个键</li><li>保持9008线按钮处于未按下的状态, 然后插入到手机上. 正面左上角的提示灯会短暂闪红色, 看到红色后立刻按下按键, 之后手机的提示灯会保持红色闪烁, 代表进入9008模式, 此时按住音量键的手可以松开了</li><li>如果一切顺利, 电脑终端上应该能看到在刷入TWRP, 等待结束就行了</li></ol><h3 id="卡刷魔趣"><a href="#卡刷魔趣" class="headerlink" title="卡刷魔趣"></a>卡刷魔趣</h3><p>后面的完全按照<a href="https://bbs.mokeedev.com/t/topic/14503">教程</a>就行了, 我是完全照着做没有做任何多余的东西的… 印象中5-10分钟就结束了. 之后重启进入系统做好设置就能用了</p><h2 id="短期使用体验-小问题"><a href="#短期使用体验-小问题" class="headerlink" title="短期使用体验&#x2F;小问题"></a>短期使用体验&#x2F;小问题</h2><p>短期使用了2天, 感觉大部分时候还是比原声系统流畅了不少, 但是没有预想的那么好吧… 看来真的是CPU跟不上国内App暴涨的性能需求了… 不过由于App可以放到内存卡了, 撑个一年应该问题不大. 目前碰到的问题:</p><ol><li>指纹删除时, 需要先对待删除的指纹重命名, 然后才能删除</li><li>杀进程非常厉害, 如果一段时间不操作, 程序非后台进程肯定会挂. 当然这一点我专门看了一些评论… 说是国内厂商不按google要求开发app导致的… 凡是类原声安卓用国内App的通病.</li><li>小卡顿依然存在, 尤其是某些时候B站弹幕多了会卡</li></ol><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>刷机后系统层面非常流畅, 但是常用应用内偶尔还是会一言难尽… 然后突然想到了微信的”进化”过程… emmmm</p><p>于是尝试了用旧版App替换… 好吧… 真就好了, B战不卡了, 支付宝启动速度肉眼可见的增加了.</p><p>哎… 我说什么好… 之后水一个历史版本App的列表吧…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 安卓 </tag>
            
            <tag> android </tag>
            
            <tag> 手机 </tag>
            
            <tag> 刷机 </tag>
            
            <tag> 魔趣 </tag>
            
            <tag> 坚果Pro </tag>
            
            <tag> Mokee </tag>
            
            <tag> custom ROM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>主题升级</title>
      <link href="/2021/02/12/%E4%B8%BB%E9%A2%98%E5%8D%87%E7%BA%A7/"/>
      <url>/2021/02/12/%E4%B8%BB%E9%A2%98%E5%8D%87%E7%BA%A7/</url>
      
        <content type="html"><![CDATA[<p>2020年实在太忙… 年中就发现使用的material-x主题已经大升级了, 但是一直没有抽出时间来进行更新, 这一拖…都2021了…</p><!-- 摘要部分 --><span id="more"></span><p>再一看作者的文档… 好家伙… 时代真是面目全非了, 我也就放弃从原来的主题直接升级, 直接根据文档新开项目迁移了.</p><h2 id="hexo安装和设置"><a href="#hexo安装和设置" class="headerlink" title="hexo安装和设置"></a>hexo安装和设置</h2><p>好家伙… 原来新电脑连hexo都没有装… 正好测试上次说的hexo-cli&#x2F;hexo到底哪个是必要的问题. 实测下来其实有hexo-cli就好了:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S npm</span><br><span class="line">sudo npm install -g hexo-cli</span><br><span class="line"><span class="built_in">mkdir</span> neo_blog</span><br><span class="line">hexo init</span><br></pre></td></tr></table></figure><h2 id="volantis主题及其他插件安装"><a href="#volantis主题及其他插件安装" class="headerlink" title="volantis主题及其他插件安装"></a>volantis主题及其他插件安装</h2><p>根据官方文档的内容, 主题安装方式也不一样了, 现在直接使用<code>npm</code>进行, 之前是把项目用<code>git clone</code>放到博客项目的<code>themes</code>目录下, 不过这倒也方便就是了…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i hexo-theme-volantis</span><br><span class="line">npm i hexo-generator-search hexo-generator-json-content</span><br></pre></td></tr></table></figure><h2 id="编辑配置文件"><a href="#编辑配置文件" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h2><p>配置文件同样有了变化(似乎是hexo升级后的改动?), 主要是主题配置不推荐直接更改<code>themes/yourTheme/_config.yml</code>或<code>node_modules/yourTheme/_config.yml</code>, 而是在<code>_config.yml</code>同级目录下直接创建<code>_config.yourTheme.yml</code>文件, 然后把主题配置文件中需要更改的部分写到这个文件中, 这样文件里的内容会覆盖主题配置文件中的内容(感觉很像vscode中的配置json文件). 文档说这样的好处是更新主题后, 对主题的配置更改不会消失.</p><p>当然实际使用中发现volantis的主题配色相关内容在<code>_config.yourTheme.yml</code>更改后本地预览有用, 但部署后无效… 最后还是改了主题的配置文件才生效</p><p>在主题内容更改好后, 把原来的<code>_config.yml</code>复制过来, 然后整个目录的内容替换掉原来的博客目录, 就可以像之前一样部署了.</p><h2 id="手册添加"><a href="#手册添加" class="headerlink" title="手册添加"></a>手册添加</h2><p>另外本次把手册又加了进来, 内容完全没有更新… 只是测试用软链是否能直接把生成的手册上传… 实测无效… 我也暂时懒得学习如何更新博客同时更新手册… 先这样手动来吧… 以后再说…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> 主题升级 </tag>
            
            <tag> volantis </tag>
            
            <tag> npm </tag>
            
            <tag> 配置文件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mSINGS的安装和使用</title>
      <link href="/2020/09/06/mSINGS%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"/>
      <url>/2020/09/06/mSINGS%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>mSINGS是一个用来检测MSI的软件, 其优势似乎是可以用于tumor only的样品.</p><!-- 摘要部分 --><span id="more"></span><p><a href="https://bitbucket.org/uwlabmed/msings/src/master/">mSINGS</a>项目挂在bitbucket而不是github, 项目是一直都有在更新… 不过这个安装指引写的稍微硬核了一点… 然后它也没有一键安装之类的东西, 所以看着文档安装会有点绕…</p><p>这个项目的核心是用Python写的, 其核心是读取samtools生成的mpileup文件进行分析, 因此本质上的依赖应该是<code>Python3.6</code>和<code>samtools</code>就好了(里面的git应该是克隆项目用的吧?). 然后因为作者指定Python版本, 所以他才会建议使用Python虚拟环境(防止日后爆炸). 不过因为我不会用<code>virtualenv</code>, 所以用上手更简单的<code>miniconda</code>代替, 总的来说就是: 创建环境&#x2F;安装必要依赖 -&gt; 安装模块 -&gt; 测试.</p><ol><li>创建环境&#x2F;安装必要依赖</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda create -p /path/to/soft/mSINGS/conda python=3.6 git samtools</span><br></pre></td></tr></table></figure><ol start="2"><li>安装模块</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">conda activate /path/to/soft/mSINGS/conda           <span class="comment"># 进入环境准备安装模块本体</span></span><br><span class="line">git <span class="built_in">clone</span> https://bitbucket.org/uwlabmed/msings.git <span class="comment"># 项目克隆, 这个按作者建议来</span></span><br><span class="line"><span class="built_in">cd</span> msings                                           <span class="comment"># 进入目录</span></span><br><span class="line">python setup.py install                             <span class="comment"># 安装软件本体</span></span><br></pre></td></tr></table></figure><ol start="3"><li>测试</li></ol><p>作者在readme中提到了如何创建baseline(应该是根据已有数据确定哪些MSI位点需要扫), 但我只是测试, 所以直接用项目下准备好的文件进行(<code>doc/</code>目录下). 另外需要注意的是, 作者明确说了输入的bam需要比对到region不带<code>chr</code>字符串的参考基因组(GATK有提供的亚子), 所以我找了个fq数据从比对开始, 如果bam已经符合要求了可以跳过.</p><p>另外需要注意的是, 作者在运行脚本<code>run_msings.sh</code>, 指定了虚拟环境激活, 因为我没有按他的来, 所以脚本内的<code># source msings-env/bin/activate</code>这一句需要注释掉.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不要做sort, 因为mSINGS的分析过程带了sort...</span></span><br><span class="line">/path/to/apps/bwa-0.7.12/bwa mem \</span><br><span class="line">    -R <span class="string">&#x27;@RG\tID:group1\tSM:TUMOR\tPL:illumina\tLB:lib1\tPU:unit1&#x27;</span> \</span><br><span class="line">    -M -t 16 \</span><br><span class="line">    /path/to/Human_Genome_GRCh37_FASTA/human_g1k_v37.fasta \</span><br><span class="line">    /path/to/soft/mSINGS/run_test/test.fq.R1.gz \</span><br><span class="line">    /path/to/soft/mSINGS/run_test/test.fq.R2.gz \</span><br><span class="line">| /usr/local/bin/samtools view \</span><br><span class="line">    -Sb - \</span><br><span class="line">&gt; test.bam</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;test.bam&quot;</span> &gt; bam_list <span class="comment"># 因为给的脚本指定一定要给写了bam路径的文件, 所以只能这么指定</span></span><br><span class="line">sh /path/to/mSINGS/msings/scripts/run_msings.sh \</span><br><span class="line">    bam_list \</span><br><span class="line">    /path/to/mSINGS/msings/doc/mSINGS_TCGA.bed \</span><br><span class="line">    /path/to/mSINGS/msings/doc/mSINGS_TCGA.baseline \</span><br><span class="line">    /path/to/Human_Genome_GRCh37_FASTA/human_g1k_v37.fasta</span><br></pre></td></tr></table></figure><p>最终的结果会在<code>Combined_MSI.txt</code>这个文件中, 这里面应该是将每个bam的结果放到了一起, 当然我只测试给一个bam, 所以合并的结果会不会有啥特殊结构未知…</p><p>我测试的这个样品目标MSI位点1166个, 27个检测到不稳定, 不稳定的2%, 总体是MSS.</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Position        test</span><br><span class="line">unstable_loci   27</span><br><span class="line">passing_loci    1166</span><br><span class="line">msing_score     0.0232</span><br><span class="line">msi status      NEG</span><br></pre></td></tr></table></figure><p>最后来看一下作者的运行脚本<code>run_msings.sh</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"><span class="comment"># source msings-env/bin/activate</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#BAM_LIST is a file of absolute paths to each bam file</span></span><br><span class="line">BAM_LIST=<span class="variable">$1</span>;</span><br><span class="line">BEDFILE=<span class="variable">$2</span>;</span><br><span class="line">MSI_BASELINE=<span class="variable">$3</span>;</span><br><span class="line">REF_GENOME=<span class="variable">$4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#Check for required variables:</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$BAM_LIST</span>&quot;</span> ]; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">&quot;BAM_LIST is unset&quot;</span> &amp;&amp; <span class="built_in">exit</span> ; <span class="keyword">else</span> <span class="built_in">echo</span> <span class="string">&quot;BAM_LIST is set to &#x27;<span class="variable">$BAM_LIST</span>&#x27;&quot;</span>; <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$BEDFILE</span>&quot;</span> ]; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">&quot;BEDFILE is unset&quot;</span> &amp;&amp; <span class="built_in">exit</span> ; <span class="keyword">else</span> <span class="built_in">echo</span> <span class="string">&quot;BEDFILE is set to &#x27;<span class="variable">$BEDFILE</span>&#x27;&quot;</span>; <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$MSI_BASELINE</span>&quot;</span> ]; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">&quot;MSI_BASELINE is unset&quot;</span> &amp;&amp; <span class="built_in">exit</span> ; <span class="keyword">else</span> <span class="built_in">echo</span> <span class="string">&quot;MSI_BASELINE is set to &#x27;<span class="variable">$MSI_BASELINE</span>&#x27;&quot;</span>; <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$REF_GENOME</span>&quot;</span> ]; <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">&quot;REF_GENOME is unset&quot;</span> &amp;&amp; <span class="built_in">exit</span> ; <span class="keyword">else</span> <span class="built_in">echo</span> <span class="string">&quot;REF_GENOME is set to &#x27;<span class="variable">$REF_GENOME</span>&#x27;&quot;</span>; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#&quot;multiplier&quot; is the number of standard deviations from the baseline that is required to call instability</span></span><br><span class="line">multiplier=2.0 </span><br><span class="line"><span class="comment">#&quot;msi_min_threshold&quot; is the maximum fraction of unstable sites allowed to call a specimen MSI negative     </span></span><br><span class="line">msi_min_threshold=0.2</span><br><span class="line"><span class="comment">#&quot;msi_max_threshold&quot; is the minimum fraction of unstable sites allowed to call a specimen MSI positive</span></span><br><span class="line">msi_max_threshold=0.2</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> BAM <span class="keyword">in</span> `sed <span class="string">&#x27;/^$/d&#x27;</span> <span class="variable">$BAM_LIST</span>`; <span class="keyword">do</span></span><br><span class="line">    SAVEPATH=$(<span class="built_in">dirname</span> <span class="variable">$BAM</span>)</span><br><span class="line">    BAMNAME=$(<span class="built_in">basename</span> <span class="variable">$BAM</span>)</span><br><span class="line">    PFX=<span class="variable">$&#123;BAMNAME%.*&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> “Starting Analysis of <span class="variable">$PFX</span>” &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line">    <span class="built_in">date</span> +<span class="string">&quot;%D %H:%M&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;sorting bam of <span class="variable">$PFX</span>&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line">    <span class="built_in">date</span> +<span class="string">&quot;%D %H:%M&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line">    samtools <span class="built_in">sort</span> -o <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/<span class="variable">$PFX</span>.sorted.bam <span class="variable">$BAM</span>  &amp;&amp; samtools index <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/<span class="variable">$PFX</span>.sorted.bam</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Making mpileups&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line">    <span class="built_in">date</span> +<span class="string">&quot;%D %H:%M&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line">    samtools mpileup -f <span class="variable">$REF_GENOME</span> -d 100000 -A -E  -l <span class="variable">$BEDFILE</span> <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/<span class="variable">$PFX</span>.sorted.bam | awk <span class="string">&#x27;&#123;if($4 &gt;= 6) print $0&#125;&#x27;</span> &gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/<span class="variable">$PFX</span>.mpileup </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;MSI Analyzer start&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line">    <span class="built_in">date</span> +<span class="string">&quot;%D %H:%M&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line">    </span><br><span class="line">    msi analyzer <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/<span class="variable">$PFX</span>.mpileup <span class="variable">$BEDFILE</span> -o <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/<span class="variable">$PFX</span>.msi.txt</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;MSI calls start&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line">    <span class="built_in">date</span> +<span class="string">&quot;%D %H:%M&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line">     </span><br><span class="line">    msi count_msi_samples <span class="variable">$MSI_BASELINE</span> <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span> -m <span class="variable">$multiplier</span> -t <span class="variable">$msi_min_threshold</span> <span class="variable">$msi_max_threshold</span> -o <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/<span class="variable">$PFX</span>.MSI_Analysis.txt</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> “Completed Analysis of <span class="variable">$PFX</span>” &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line">    <span class="built_in">date</span> +<span class="string">&quot;%D %H:%M&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/<span class="variable">$PFX</span>/msi_run_log.txt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Creating summary analysis file for all samples&quot;</span> &gt;&gt; <span class="variable">$SAVEPATH</span>/msi_run_log.txt;</span><br><span class="line">msi count_msi_samples <span class="variable">$MSI_BASELINE</span> <span class="variable">$SAVEPATH</span> -m <span class="variable">$multiplier</span> -t <span class="variable">$msi_min_threshold</span> <span class="variable">$msi_max_threshold</span> -o <span class="variable">$SAVEPATH</span>/Combined_MSI.txt</span><br></pre></td></tr></table></figure><p>看着有点长, 其实内容还是比较简单的, 作者也给了一些基本的注释. 本质上就是将输入的bam一个一个去sort然后生成mpileup文件, 然后使用<code>msi</code>这个程序(之前<code>python setup.py install</code>装的东西)来进行分析和数据汇总.</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 生物信息学 </tag>
            
            <tag> 微卫星不稳定性 </tag>
            
            <tag> MSI </tag>
            
            <tag> mSINGS </tag>
            
            <tag> samtools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flask使用记录</title>
      <link href="/2020/08/09/Flask%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/"/>
      <url>/2020/08/09/Flask%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>因项目需要, 最近终于是实际看了下Flask怎么用, 照例来个记录.</p><!-- 摘要部分 --><span id="more"></span><p>由于我这次的任务比较简单, 只要用Flask做个服务器, 能接受请求然后调用Python代码计算结果就行, 因此我这次只涉及最基本的使用. 当然由于我本身并不熟HTML和js, 因此这里记录的东西纯属我自己的理解…可能包含大量不准确和有误导性的描述…</p><h2 id="创建一个Flask服务-App"><a href="#创建一个Flask服务-App" class="headerlink" title="创建一个Flask服务(App)"></a>创建一个Flask服务(App)</h2><p>所有的操作从创建个Flask App开始, 创建也比较简单, 把<code>Flask</code>对象实例化就行了.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p>上述代码保存为Python文件, 然后<code>python app.py</code>就能启动服务了. <code>host</code>参数设到<code>0.0.0.0</code>是为了所有ip都能访问这个服务.</p><h2 id="将访问与函数绑定"><a href="#将访问与函数绑定" class="headerlink" title="将访问与函数绑定"></a>将访问与函数绑定</h2><p>Flask可以将对页面的请求转换成对Python函数的调用. 具体在对应函数前用<code>@app.route</code>装饰器就行. <code>&#39;/&#39;</code>的话对应的是<code>index.html</code>, 如果是<code>&#39;/login&#39;</code>这种的话则对应<code>login.html</code>, 当然我实测下来对应的html文件不需要存在, 在返回值里直接写html字串就行.</p><p>我这里是准备好了一个说明API使用方法的页面, 读进来直接返回就好.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;index.html&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read()</span><br><span class="line">    <span class="keyword">return</span> content</span><br></pre></td></tr></table></figure><h2 id="处理POST请求"><a href="#处理POST请求" class="headerlink" title="处理POST请求"></a>处理POST请求</h2><p>我这次的程序需要接收一些参数和上传的文件内容以进行进一步处理, 文件的内容自然不能走<code>GET</code>, 所以只处理<code>POST</code>.</p><p>Flask内置的<code>request</code>对象可以方便的获取请求中带有的所有信息.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> iNeo_MS <span class="keyword">import</span> sheet_parse</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/parse&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>():</span><br><span class="line">    args = request.args</span><br><span class="line">    method = args[<span class="string">&#x27;method&#x27;</span>]</span><br><span class="line">    byteData = request.files.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    data = sheet_parse(BytesIO(byteData.read()), method)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(data.to_dict(<span class="string">&#x27;records&#x27;</span>))</span><br></pre></td></tr></table></figure><h2 id="用Python进行API测试"><a href="#用Python进行API测试" class="headerlink" title="用Python进行API测试"></a>用Python进行API测试</h2><p>进行<code>POST</code>服务测试是不能直接靠浏览器的, 得安装专门的插件… 然而家里网络堪忧… 于是还是靠Python了.</p><p>具体的方法当然是用<code>requests</code>模块的<code>post</code>方法了, 将参数放到<code>params</code>参数中, 文件则读入内容后通过<code>files</code>参数送出.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">params = &#123;</span><br><span class="line">    <span class="string">&#x27;method&#x27;</span>: <span class="string">&#x27;pNovo&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;data/results.res&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    content = f.read()</span><br><span class="line"></span><br><span class="line">files = &#123;</span><br><span class="line">    <span class="string">&quot;file&quot;</span> :(<span class="string">&#x27;result.res&#x27;</span>, content),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(</span><br><span class="line">    <span class="string">&#x27;http://127.0.0.1:5000/parse&#x27;</span>,</span><br><span class="line">    params=params,</span><br><span class="line">    files=files</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Flask </tag>
            
            <tag> Web开发 </tag>
            
            <tag> 后端 </tag>
            
            <tag> API </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>水一发:hexo一次性多仓库部署</title>
      <link href="/2020/08/02/hexo%E4%B8%80%E6%AC%A1%E6%80%A7%E5%A4%9A%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/"/>
      <url>/2020/08/02/hexo%E4%B8%80%E6%AC%A1%E6%80%A7%E5%A4%9A%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<p>最近github的访问越来越不行了, 有时候想查自己博客里的博文都费劲…所以在国内的git托管服务商gitee也托管了一份, 但是问题就来了…如何一次更新多地部署呢?</p><!-- 摘要部分 --><span id="more"></span><p>首先要设置在gitee上的仓库, 基本方式和github一致啦, 唯一需要注意的是gitee的默认展示项目和github不一样, github用<code>USERNAME.github.io</code>, 而gitee使用的是<code>USERNAME</code>.</p><p>由于gitee本身有fork github项目的功能, 因此在创建项目的时候选择fork原来在github上的博客仓库, 然后把仓库名改成<code>USERNAME</code>就可以(图里是迁移完成后举例的…所以显示已创建).</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/gitee_proj.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/gitee_proj.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="gitee_proj"></p><p>之后再项目页面选服务菜单进行一下设置, 就能从<code>USERNAME.gitee.io</code>访问博客了.</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/gitee_pages.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/gitee_pages.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="gitee_pages"></p><p>然后就是设置通过ssh等度gitee了, 这个也跟github的一致就不展开.</p><p>最后就是设置项目的<code>_config.yaml</code>文件, 在部署的部分如下配置, 这样就能部署的时候一次性传两次了.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">    <span class="attr">repo:</span></span><br><span class="line">      <span class="string">git@github.com:SilenWang/silenwang.github.io.git</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">    <span class="attr">repo:</span></span><br><span class="line">      <span class="string">git@gitee.com:silenwang/silenwang.git</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure><p>本来这样就该结束了…但是测试的时候发现另外一个问题…就是家里的网已经完全不能直连github, 导致部署不到github上了… 因此又搜索了下给git加代理的方式.</p><p>由于我配置里走的是ssh协议连接github, 经查需要通过ssh的配置文件添加一个<code>ProxyCommand</code>的设置, 如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">    User git</span><br><span class="line">    HostName github.com</span><br><span class="line">    ProxyCommand nc -x 127.0.0.1:1080 %h %p</span><br></pre></td></tr></table></figure><p>添加之后再次尝试<code>hexo d</code>, 确实成功部署了.</p><p>以上, 水完~</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> github </tag>
            
            <tag> 博客部署 </tag>
            
            <tag> gitee </tag>
            
            <tag> git代理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pandas常用操作记录</title>
      <link href="/2020/07/26/pandas%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%95/"/>
      <url>/2020/07/26/pandas%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<!-- 摘要部分 --><span id="more"></span><p>因为现在的工作有大量数据统计&#x2F;处理要求, 且论错误处理及第三方扩展性, Python方便得多, 因此目前我数据处理也开始从R移动到Pandas了. 在此记录一些实际工作中常用的操作及需要注意的问题:</p><h2 id="1-apply相关"><a href="#1-apply相关" class="headerlink" title="1. apply相关"></a>1. apply相关</h2><h3 id="1-1-基本使用"><a href="#1-1-基本使用" class="headerlink" title="1.1. 基本使用"></a>1.1. 基本使用</h3><p>同Pandas与R一样有<code>apply</code>函数, 不过仅此一个, 没有<code>apply</code>家族. <code>apply</code>本质上就是对表格进行按行循环, 而之所以用<code>apply</code>而不是直接<code>itterrow</code>, 则是出于并行的考虑. 有非常多的第三方模块可以直接将apply操作并行化, 因此最初写代码时就按照<code>apply</code>的写法来, 可以省下日后并行化时重写函数的过程.</p><p>当然另外一点就是将主处理逻辑和细部的详细执行内容分开, 一定程度上可以提高代码可读性, 不过个人感觉还是个习惯问题… 如果读代码的人从不这么写… 那用<code>apply</code>其实是提高读代码人的阅读难度…</p><p>目前我使用的方式一般是实际计算的部分写成通用函数, 然后套<code>apply</code>时使用匿名函数传参数.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">plus</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x+y</span><br><span class="line"></span><br><span class="line">data[<span class="string">&#x27;applyed&#x27;</span>] = data[<span class="string">&#x27;2apply&#x27;</span>].apply(<span class="keyword">lambda</span> x: plus(x[<span class="string">&#x27;x&#x27;</span>], x[<span class="string">&#x27;y&#x27;</span>]))</span><br></pre></td></tr></table></figure><p>当然, 如果同时要对同一行做很多行内操作, 那就单独写个<code>func_apply()</code>的函数, 防止反复对数据遍历.</p><h3 id="1-2-返回多列结果"><a href="#1-2-返回多列结果" class="headerlink" title="1.2. 返回多列结果"></a>1.2. 返回多列结果</h3><p><code>apply</code>的常规用法是返回一个数值形以形成一列数据, 但是实际应用中我其实会有返回多列的需要, 因此从网上找了一种解决方案:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">plus</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x+y, x-y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data[<span class="string">&#x27;x+y&#x27;</span>], data[<span class="string">&#x27;x-y&#x27;</span>] = <span class="built_in">zip</span>(*data[<span class="string">&#x27;2apply&#x27;</span>].apply(<span class="keyword">lambda</span> x: plus(x[<span class="string">&#x27;x&#x27;</span>], x[<span class="string">&#x27;y&#x27;</span>])))</span><br></pre></td></tr></table></figure><h2 id="2-Groupby相关"><a href="#2-Groupby相关" class="headerlink" title="2. Groupby相关"></a>2. Groupby相关</h2><h3 id="2-1-多行并为单行数据"><a href="#2-1-多行并为单行数据" class="headerlink" title="2.1. 多行并为单行数据"></a>2.1. 多行并为单行数据</h3><p>这个操作主要是用来将多行的数据统计为一行结果, 我印象中R里面有专门的处理方式, pandas应该也有…然而我一时没找到, 所以目前自己想了一种处理, 这种方式本质上是按待处理单位获取数据子集, 根据子集统计后生成新的数据行填入新表. 这种方式目前来看效率堪忧, 且因为本质是用了for循环, 并行化就没有<code>apply</code>那么简单了.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">result_list = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, sub_data <span class="keyword">in</span> data.groupby(by=[<span class="string">&#x27;Grp1&#x27;</span>, <span class="string">&#x27;Grp2&#x27;</span>]):</span><br><span class="line">    grp1, grp2 = k</span><br><span class="line">    result_list.append(&#123;</span><br><span class="line">        <span class="string">&#x27;Stat1&#x27;</span>: <span class="built_in">sum</span>(sub_data[<span class="string">&#x27;Var1&#x27;</span>]),</span><br><span class="line">        <span class="string">&#x27;Stat2&#x27;</span>: <span class="built_in">min</span>(sub_data[<span class="string">&#x27;Var1&#x27;</span>]),</span><br><span class="line">    &#125;)</span><br><span class="line">result = pd.DataFrame(result_list)</span><br></pre></td></tr></table></figure><h2 id="3-缺失处理相关"><a href="#3-缺失处理相关" class="headerlink" title="3. 缺失处理相关"></a>3. 缺失处理相关</h2><h3 id="3-1-读入时缺失指定"><a href="#3-1-读入时缺失指定" class="headerlink" title="3.1. 读入时缺失指定"></a>3.1. 读入时缺失指定</h3><p>通过<code>na_values</code>参数可以将多种数值替换为缺失:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df = pd.read_table(FILE, sep=<span class="string">&quot;\t&quot;</span>, header=<span class="number">0</span>, na_values=[<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span>])</span><br></pre></td></tr></table></figure><h3 id="3-2-输出时缺失指定"><a href="#3-2-输出时缺失指定" class="headerlink" title="3.2. 输出时缺失指定"></a>3.2. 输出时缺失指定</h3><p>输出时可通过参数指定缺失值用什么来填充：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.to_csv(FILE, sep=<span class="string">&quot;\t&quot;</span>, header=<span class="number">0</span>, na_values=[<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span>])</span><br></pre></td></tr></table></figure><h3 id="3-3-是否缺失判定"><a href="#3-3-是否缺失判定" class="headerlink" title="3.3 是否缺失判定"></a>3.3 是否缺失判定</h3><p>pandas内如果产生缺失, 会使用numpy内置的<code>nan</code>对象, 这个对象在判定上和R中存在的<code>NA</code>或<code>NULL</code>以及Python内置的<code>None</code>都不太一样, 因为从类型上<code>nan</code>居然是<code>float</code>… 通过<code>A==nan</code>这种逻辑判断是得不到<code>True</code>的结果的… 原因我暂时没有找到. 不过要判断是否缺失的话, 最好还是用pandas下面的<code>isnull</code>方法. 其他模块像<code>math</code>, <code>numpy</code>虽然也有内置缺失判断函数, 但是这些函数有个致命的缺陷…他们接受的参数类型只能是<code>float</code>… 所以如果用他们的我还得自己加一层类型判断, 着实有点麻烦, 所以还是用pandas下的<code>isnull</code>最方便.</p><h2 id="4-最常用的输出参数"><a href="#4-最常用的输出参数" class="headerlink" title="4. 最常用的输出参数"></a>4. 最常用的输出参数</h2><p>因为个人习惯性输出tsv文件, 因此用pandas输出文件的话最经常这么写:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.to_csv(FILE_PATH, sep=<span class="string">&quot;\t&quot;</span>, index=<span class="number">0</span>, na_rep=<span class="string">&quot;.&quot;</span>)</span><br></pre></td></tr></table></figure><p>需要注意的是, 如果输出的结果表是数据透视表, 很大概率是要将<code>index</code>输出的, 这种时候<code>index=0</code>就要去掉了</p><h2 id="5-其他可能需要的操作"><a href="#5-其他可能需要的操作" class="headerlink" title="5. 其他可能需要的操作"></a>5. 其他可能需要的操作</h2><h3 id="5-1-列类型转换"><a href="#5-1-列类型转换" class="headerlink" title="5.1 列类型转换"></a>5.1 列类型转换</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.astype(&#123;<span class="string">&#x27;col1&#x27;</span>: <span class="string">&#x27;int32&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 数据处理 </tag>
            
            <tag> Pandas </tag>
            
            <tag> 缺失值处理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>猛汉王狩猎日记-冰原开荒完结纪念</title>
      <link href="/2020/02/23/%E7%8C%9B%E6%B1%89%E7%8E%8B%E7%8B%A9%E7%8C%8E%E6%97%A5%E8%AE%B0-%E5%86%B0%E5%8E%9F%E5%BC%80%E8%8D%92%E5%AE%8C%E7%BB%93%E7%BA%AA%E5%BF%B5/"/>
      <url>/2020/02/23/%E7%8C%9B%E6%B1%89%E7%8E%8B%E7%8B%A9%E7%8C%8E%E6%97%A5%E8%AE%B0-%E5%86%B0%E5%8E%9F%E5%BC%80%E8%8D%92%E5%AE%8C%E7%BB%93%E7%BA%AA%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<p>本来想着春节期间好好肝一把… 结果大部分时间都加班了, 现在才开荒完毕… 而且在可以预期的未来工作也会比较繁忙… 趁没有正式复工, 留个几年bia…</p><iframe src="//player.bilibili.com/player.html?aid=91147423&cid=155618081&page=1" width="700" height="500" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><!-- 摘要部分 --><span id="more"></span>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 游戏 </tag>
            
            <tag> 怪物猎人 </tag>
            
            <tag> 冰原DLC </tag>
            
            <tag> Monster Hunter World </tag>
            
            <tag> Iceborne </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>破解了一个apk</title>
      <link href="/2020/02/02/%E7%A0%B4%E8%A7%A3%E4%BA%86%E4%B8%80%E4%B8%AAapk/"/>
      <url>/2020/02/02/%E7%A0%B4%E8%A7%A3%E4%BA%86%E4%B8%80%E4%B8%AAapk/</url>
      
        <content type="html"><![CDATA[<p>果然, 从小到大, 我最大的动力来源就是玩游戏耍帅… 今天本来是想打猎了但是回不去广州, 只好玩3ds上的4G, 然而这毕竟5年前的老游戏了, 那时怪猎在中文圈可能也不火… 基本找不到任何想要的中文资料(Ping’s Dex因为系统原因用着不太方便), 所以为了好好打游戏…我把黑手伸向了一个需要看广告才能好好用的app….</p><!-- 摘要部分 --><span id="more"></span><p>这个App的收费点在于看广告换积分, 然后凭积分兑换配装器的特定功能次数. 因此我原本的目标是让积分无限或者让兑换的使用次数无限. 我本来想的是程序代码里应该有这么个变量, 没使用一次变量数值就会下降, 我把下降的这一行代码去掉, 那就可以无限使用了.</p><p>那么就来操作上.</p><h2 id="解包和解析Apk"><a href="#解包和解析Apk" class="headerlink" title="解包和解析Apk"></a>解包和解析Apk</h2><p>实际上一个Apk文件就是个压缩包, 直接<code>unzip</code>就可以了, 解压后的软件包应该会包括很多部分, 其中实际的执行文件会是<code>*.dex</code>, 这是编译后的执行文件, 解析的话需要先把这个文件转换为<code>jar</code>, 我使用的是<code>enjarify</code>, 来自github, 克隆下来就能用.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unzip your.apk</span><br><span class="line">/path/tool/enjarify.sh classes.dex</span><br></pre></td></tr></table></figure><p>接下来就是查看java代码了, 我使用的是<code>jd-gui</code>, <code>AUR</code>上可以能找到(<code>aur/jd-gui-bin</code>), 将文件拖进去就行. 这里就纯粹是代码阅读了, 由于代码不是咱写的, 而且作者为了保护自己也可能会加上一些混淆的东西, 可能会难定位. 所以我就想到了靠日志定位的方式:</p><ol><li>首先使用<code>adb shell</code>连接手机终端, <code>pm list packages</code>查看目标app的名称</li><li>根据名称抓取指定app的日志<code>adb logcat device_id|grep you.app.name</code></li><li>在手机上操作这个app, 比如我就进入了app的付费页面, 就能从日志上看到是调用了什么<code>class</code>了</li></ol><p>完成定位后就很枯燥了… 猜指定文件中的代码逻辑怎样(毕竟我根本不懂java…), 然后尝试想一个解决方案,</p><h2 id="反编译Apk并对代码进行修改"><a href="#反编译Apk并对代码进行修改" class="headerlink" title="反编译Apk并对代码进行修改"></a>反编译Apk并对代码进行修改</h2><p>我使用的是<code>apktools</code>, 加了<code>archlinuxcn</code>源之后直接<code>sudo pacman -S android-apktool</code>就行, 安装好了之后<code>apktool d your.apk</code>进行反编译就行了.</p><p>反编译后进入产生文件夹的<code>smali</code>文件夹内, 这个文件夹和<code>jar</code>里面的看到的java项目的目录结构是一样的, 只不过里面的是<code>smali</code>这种汇编语言的代码, 而不是<code>java</code>. 虽然语言不一样(甚至里面部分实现逻辑都是不太一样的), 但是实现一样的东西, 所以根据前面看过的java代码, 可以对应去文件里找相应的部分, 找到之后就可以按照<code>smali</code>的语法对代码进行更改了.</p><h2 id="重打包与签名"><a href="#重打包与签名" class="headerlink" title="重打包与签名"></a>重打包与签名</h2><p>修改完代码文件就可以用修改后的文件夹重新生成Apk文件了: <code>apktool b -o your.mod.apk your_path</code>.</p><p>不过重新打包的Apk是不能直接用的, 还得签名… 这个签名完整的过程是要先给信息生成密钥, 然后再签名, 我觉得太麻烦就直接github上找了一个快速签名用的项目<a href="https://github.com/patrickfav/uber-apk-signer">uber-apk-signer</a>, 直接给未注册的Apk文件, 他会用内置的测试签名快速签, 然后就能装来用了.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar  uber-apk-signer-1.1.0.jar --apks your.mod.apk</span><br></pre></td></tr></table></figure><p>之后就是对修改后的App进行测试, 如果没有达到效果就再改就是了. 然后我实际上没有达到最初预想的效果, 因为我并没有在代码中找到那个数值下降的位置(因为实在看不懂java), 但是我却在购买的位置找到了判断积分是否充足的部分, 于是我直接跳过这个判断, 直接让积分兑换完成, 换了个方式实现了我要的效果… 唯一不足的就是… 我还得进购买页面疯狂兑换去…</p><p>嘛, 毕竟这么做对原作者不好… 所以我就不给App名称和实际的代码了…</p><p>不知道这次的技能以后会不会又在奇怪的地方有奇效…</p>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> adb </tag>
            
            <tag> APK破解 </tag>
            
            <tag> 反编译 </tag>
            
            <tag> Android逆向 </tag>
            
            <tag> Apktools </tag>
            
            <tag> enjarify </tag>
            
            <tag> jd-gui </tag>
            
            <tag> uber-apk-signer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从ggplot的箱线图中提取离群值并进行去除</title>
      <link href="/2020/01/05/%E4%BB%8Eggplot%E5%9B%BE%E5%BD%A2%E4%B8%AD%E6%8F%90%E5%8F%96%E6%95%B0%E6%8D%AE/"/>
      <url>/2020/01/05/%E4%BB%8Eggplot%E5%9B%BE%E5%BD%A2%E4%B8%AD%E6%8F%90%E5%8F%96%E6%95%B0%E6%8D%AE/</url>
      
        <content type="html"><![CDATA[<p>今天碰到一个做图问题, 学到了一个新的小技巧, 记录一下</p><!-- 摘要部分 --><span id="more"></span><p>ggplot提供了很多常用的图形的绘制函数, 相当方便, 且图形可以按照各种各样的分组进行绘制, 但是有的时候我有些特殊要求, ggplot无法满足, 所以需要自行进行一些操作.</p><p>比如我今天需要绘制一个分组的箱线图, 每一组的数据中都有自己的离群值, 这些离群值会使图形挤在某一测, 难以观察, 因此需要去除. <code>geom_boxplot</code>虽然有离群值处理的参数, 但是很可惜是这些参数并不会把离群点从数值中去除, 而是不在图形上显示, 这么一来该挤一起的图形还是挤一起, 达不到效果.</p><p>网上能查到的关于离群值去除的方案最多是利用内置<code>boxplot</code>函数里面<code>$out</code>的内容提取离群数值并进行去除, 可惜不巧的是这这种方案似乎不能分组给出离群值结果, 它给的是总体离群值, 如果需要分组去除的话还需要自己手动拆分数据集然后挨个处理.</p><p>那么有没有更偷懒一点的方式呢?</p><p>还真被我发现了…</p><p>ggplot的图形和内置函数一样, 是可以提取实际绘图用数据的:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plot <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>data<span class="operator">=</span>data<span class="punctuation">,</span>mapping<span class="operator">=</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>data<span class="operator">$</span>label<span class="punctuation">,</span> y<span class="operator">=</span>data<span class="punctuation">[</span><span class="punctuation">,</span>tag<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">plot_data <span class="operator">&lt;-</span> layer_data<span class="punctuation">(</span>plot<span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><code>layer_data</code>函数是提取的方式之一, 使用<code>build_plot(plot)$data</code>效果一样. </p><p><code>plot_data</code>中就存储这ggplot绘制图形时使用的一切数据. 其中我们需要的部分存储在<code>outliers</code>中. 并且顺序是按照图形上展示的顺序排列的. 因此只要在前期绘图时对分组手动指定factor level, 就可以对应从图形中拿到特定组的离群值.</p><p>然后利用ggplot绘图时自动去<code>NA</code>的特性, 将对应列的离群值以<code>NA</code>替换, 就能轻松的创造一个去过离群值的数据集, 然后再次画图就能解决问题啦~</p><p>完整的绘图代码与图形对比:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span><span class="string">&#x27;ggplot2&#x27;</span><span class="punctuation">)</span></span><br><span class="line">data <span class="operator">&lt;-</span> read.csv<span class="punctuation">(</span><span class="string">&quot;plot_data.tsv&quot;</span><span class="punctuation">,</span> sep<span class="operator">=</span><span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> stringsAsFactors<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span> na.strings <span class="operator">=</span> <span class="string">&#x27;.&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 对分组数据自定义等级, 后续对应必须</span></span><br><span class="line">data<span class="operator">$</span>grp <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>data<span class="operator">$</span>grp<span class="punctuation">,</span> levels<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Grp1&quot;</span><span class="punctuation">,</span><span class="string">&quot;Grp2&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 准备一个vector作映射</span></span><br><span class="line">classV <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>classV<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Grp1&quot;</span><span class="punctuation">,</span><span class="string">&quot;Grp2&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 第一轮, 利用ggplot获取离群值</span></span><br><span class="line">plot <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>data<span class="operator">=</span>data<span class="punctuation">,</span>mapping<span class="operator">=</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>data<span class="operator">$</span>grp<span class="punctuation">,</span> y<span class="operator">=</span>data<span class="punctuation">[</span><span class="punctuation">,</span><span class="string">&#x27;value&#x27;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">print<span class="punctuation">(</span>layer_data<span class="punctuation">(</span>plot<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">outlier_data <span class="operator">&lt;-</span> layer_data<span class="punctuation">(</span>plot<span class="punctuation">)</span><span class="punctuation">[</span><span class="string">&#x27;outliers&#x27;</span><span class="punctuation">]</span></span><br><span class="line"><span class="comment"># 利用获取数值改变原数据集的离群值为NA</span></span><br><span class="line">pdata<span class="operator">&lt;-</span>data</span><br><span class="line"><span class="keyword">for</span> <span class="punctuation">(</span>grp <span class="keyword">in</span> <span class="built_in">names</span><span class="punctuation">(</span>classV<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    pdata<span class="punctuation">[</span>pdata<span class="operator">$</span>grp<span class="operator">==</span>grp<span class="punctuation">,</span>  <span class="string">&#x27;value&#x27;</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> replace<span class="punctuation">(</span>pdata<span class="punctuation">[</span>pdata<span class="operator">$</span>grp<span class="operator">==</span>grp<span class="punctuation">,</span> <span class="string">&#x27;value&#x27;</span><span class="punctuation">]</span><span class="punctuation">,</span> pdata<span class="punctuation">[</span>pdata<span class="operator">$</span>grp<span class="operator">==</span>grp<span class="punctuation">,</span>  <span class="string">&#x27;value&#x27;</span><span class="punctuation">]</span> <span class="operator">%in%</span> outlier_data<span class="punctuation">[</span>classV<span class="punctuation">[</span>grp<span class="punctuation">]</span><span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">[[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="literal">NA</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="comment"># 准备比较组向量, 利用变更后的和数据作图</span></span><br><span class="line">comb_list <span class="operator">&lt;-</span> <span class="built_in">list</span><span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">comb <span class="operator">&lt;-</span> combn<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Negative&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Unkown&quot;</span><span class="punctuation">,</span><span class="string">&quot;Weak&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Medium&quot;</span><span class="punctuation">,</span><span class="string">&quot;Strong&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">)</span></span><br><span class="line"><span class="keyword">for</span> <span class="punctuation">(</span>id <span class="keyword">in</span> seq<span class="punctuation">(</span><span class="built_in">dim</span><span class="punctuation">(</span>comb<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    comb_list<span class="punctuation">[[</span>id<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> comb<span class="punctuation">[</span><span class="punctuation">,</span> id<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">pplot <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>data<span class="operator">=</span>pdata<span class="punctuation">,</span>mapping<span class="operator">=</span>aes<span class="punctuation">(</span>x<span class="operator">=</span>pdata<span class="operator">$</span>grp<span class="punctuation">,</span> y<span class="operator">=</span>pdata<span class="punctuation">[</span><span class="punctuation">,</span><span class="string">&#x27;value&#x27;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">geom_boxplot<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/display_boxplot.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/display_boxplot.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="display_boxplot.png"></p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据可视化 </tag>
            
            <tag> R语言 </tag>
            
            <tag> R </tag>
            
            <tag> ggplot </tag>
            
            <tag> ggplot2 </tag>
            
            <tag> 箱线图 </tag>
            
            <tag> 离群值处理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>爬虫内容学习</title>
      <link href="/2019/12/18/%E7%88%AC%E8%99%AB%E5%86%85%E5%AE%B9%E5%AD%A6%E4%B9%A0/"/>
      <url>/2019/12/18/%E7%88%AC%E8%99%AB%E5%86%85%E5%AE%B9%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p>之前没有系统对爬虫相关的东西学习过, 边看<a href="https://www.bilibili.com/video/av18202461/?p=7">视频</a>边做个笔记.</p><span id="more"></span><h1 id="request-response"><a href="#request-response" class="headerlink" title="request &#x2F; response"></a>request &#x2F; response</h1><p>request是浏览器&#x2F;程序向服务器发出的一些信息, 用于请求需要展示的内容, resoponse则是服务器对接收到的请求给出的回应信息.</p><ul><li><p>request的内容信息</p><ul><li>请求方式: GET &#x2F; POST(最常用)<ul><li>POST相对GET多了form data</li><li>GET的参数直接包含在URL中, 而POST请求则包含在表单中</li></ul></li><li>请求URL: URL是统一资源定位符, 就是文件&#x2F;对象的链接</li><li>请求头: 重要的配置信息, 以键值对方式存储</li><li>请求体: GET时一般无信息, POST需要</li></ul></li><li><p>response的内容信息</p><ul><li>响应状态码: 用来表示请求情况的数字代码</li><li>响应头</li><li>相应体: 请求的结果</li></ul></li></ul><h1 id="python-request模块使用"><a href="#python-request模块使用" class="headerlink" title="python request模块使用"></a>python request模块使用</h1><p>requests基于urllb3, 使用更方便功能更丰富</p><h2 id="GET请求相关"><a href="#GET请求相关" class="headerlink" title="GET请求相关"></a>GET请求相关</h2><h3 id="请求参数添加"><a href="#请求参数添加" class="headerlink" title="请求参数添加"></a>请求参数添加</h3><ul><li>params参数可以方便的给请求增加参数, 省去手动编写URL</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;arg1&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;arg2&#x27;</span>: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">response = request.get(<span class="string">&#x27;url&#x27;</span>, params=data)</span><br></pre></td></tr></table></figure><h3 id="json解析"><a href="#json解析" class="headerlink" title="json解析"></a>json解析</h3><ul><li>提供了<code>json</code>方法, 可直接把返回的json字符串变成json对象</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response = request.get(<span class="string">&#x27;url&#x27;</span>, params=data)</span><br><span class="line">response.json()</span><br></pre></td></tr></table></figure><h3 id="二进制数据获取"><a href="#二进制数据获取" class="headerlink" title="二进制数据获取"></a>二进制数据获取</h3><ul><li>使用get请求直接请求图片即可, 然后写入的时候以’wb’形式写入文件即可</li></ul><h3 id="添加header"><a href="#添加header" class="headerlink" title="添加header"></a>添加header</h3><ul><li>主要是为了保证获取成功, 有些网站会识别User-Agent以防止机器爬取</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;XXXX&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">response = requests.get(<span class="string">&#x27;url&#x27;</span>, headers = headers)</span><br></pre></td></tr></table></figure><h2 id="POST请求相关"><a href="#POST请求相关" class="headerlink" title="POST请求相关"></a>POST请求相关</h2><h3 id="请求参数-头添加"><a href="#请求参数-头添加" class="headerlink" title="请求参数 &#x2F; 头添加"></a>请求参数 &#x2F; 头添加</h3><ul><li>同GET部分(见上)</li></ul><h3 id="response属性"><a href="#response属性" class="headerlink" title="response属性"></a>response属性</h3><ul><li>常用属性包括:<ul><li>status_code</li><li>headers</li><li>cookies</li><li>url</li><li>history</li></ul></li></ul><h3 id="状态码分析"><a href="#状态码分析" class="headerlink" title="状态码分析"></a>状态码分析</h3><ul><li>requests库本身内置了状态码的分类情况, 所以直接调用内置的信息就可以快速判断请求是否正常&#x2F;成功, 比如<code>response.status_code.ok</code>就相当于<code>200</code></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response = requests.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">exit() <span class="keyword">if</span> response.status_code != response.status_code.ok <span class="keyword">else</span> <span class="built_in">print</span>(<span class="string">&#x27;All Right&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="代理设置"><a href="#代理设置" class="headerlink" title="代理设置"></a>代理设置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxy = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://127.0.0.1:9743&#x27;</span></span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://user:passwd@127.0.0.1:9743&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.get(<span class="string">&#x27;url&#x27;</span>, proxies=proxy)</span><br></pre></td></tr></table></figure><p>如果要使用ss, 则需要另外安装插件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install <span class="string">&#x27;requests[socks]&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxy = &#123;</span><br><span class="line">    <span class="string">&#x27;socks5&#x27;</span>: <span class="string">&#x27;http://127.0.0.1:9743&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.get(<span class="string">&#x27;url&#x27;</span>, proxies=proxy)</span><br></pre></td></tr></table></figure><h3 id="超时设置"><a href="#超时设置" class="headerlink" title="超时设置"></a>超时设置</h3><p>可以结合<code>try</code>进行异常处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = requests.get(<span class="string">&#x27;url&#x27;</span>, timeout = <span class="number">1</span>)</span><br></pre></td></tr></table></figure><h1 id="Selenium部分"><a href="#Selenium部分" class="headerlink" title="Selenium部分"></a>Selenium部分</h1><p>对于通过js获取数据并进行渲染展示的内容, 在分析页面请求的时候可能会有些东西找不到. 此时可以通过Selenium控制浏览器来进行操作. 虽然这样的效率不高, 但是对于我这种对Web相关的东西不熟的人来说非常适用.</p><h2 id="元素查找"><a href="#元素查找" class="headerlink" title="元素查找"></a>元素查找</h2><p>模拟网页操作首先要找到需要操作元素的位置, Selenium提供了多种元素定位的方式, 当使用的是<code>find_elememt</code>会返回第一个找到的符合要求的元素, 而使用<code>find_elememts</code>则会以列表返回所有对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">browser.find_element_by_id(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">browser.find_element_by_name(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">browser.find_element_by_xpath(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">browser.find_element_by_link_text(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">browser.find_element_by_partial_link_text(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">browser.find_element_by_tag_name(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">browser.find_element_by_class_name(<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">browser.find_element_by_css_selector(<span class="string">&#x27;123&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="iframe定位"><a href="#iframe定位" class="headerlink" title="iframe定位"></a>iframe定位</h2><p>一个网页可能是分了好几块的, 大的框架中可能内嵌了一个或多个<code>iframe</code>, 当位于大框架中时, 是无法搜索&#x2F;定位小框架内的内容的, 也就无法进行相应操作, 因此需要在操作前进行框切换</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">browser = webdriver.Firefox()</span><br><span class="line">browser.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line"><span class="comment"># 根据名称切换到iframe</span></span><br><span class="line">browser.switch_to.frame(<span class="string">&#x27;analyzeFrame&#x27;</span>)</span><br><span class="line"><span class="comment"># 切换回主框架</span></span><br><span class="line">browser.switch_to.default_content()</span><br><span class="line"><span class="comment"># 没有测试在iframe内是否可切换到其他iframe</span></span><br></pre></td></tr></table></figure><h2 id="弹窗操作"><a href="#弹窗操作" class="headerlink" title="弹窗操作"></a>弹窗操作</h2><p>有时候部分操作会弹出一个警示框, 需要切换到这个框进行相应操作, 然后才能继续后续步骤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换到弹窗</span></span><br><span class="line">al = browser.switch_to_alert()</span><br><span class="line"><span class="comment"># 点击窗口的接受</span></span><br><span class="line">al.accpet()</span><br></pre></td></tr></table></figure><h2 id="浏览器设置变更"><a href="#浏览器设置变更" class="headerlink" title="浏览器设置变更"></a>浏览器设置变更</h2><p>有时需要对浏览器进行特殊设置后才能完成所需操作, 比如我某次爬取的数据可以通过点击一个下载按钮获得, 但是正常情况下点击下载按钮浏览器会弹出下载窗口并</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">options = Options()</span><br><span class="line"><span class="comment"># 前面一项是设置项名称, 后面的是对应值, 可设置的项目可以浏览器输入&#x27;about:config&#x27;查看</span></span><br><span class="line">options.set_preference(<span class="string">&quot;browser.download.folderList&quot;</span>, <span class="number">2</span>)</span><br><span class="line">browser = webdriver.Firefox(firefox_options=options)</span><br><span class="line"><span class="comment"># 下面这个是设置使用socks代理</span></span><br><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--proxy-server=socks5://localhost:1080&#x27;</span>)</span><br><span class="line">browser =  webdriver.Chrome(chrome_options=chrome_options)</span><br></pre></td></tr></table></figure><h2 id="等待设定"><a href="#等待设定" class="headerlink" title="等待设定"></a>等待设定</h2><p>Selenium的所有操作会在页面加载完成之后才进行, 但是由于网络的问题, 如果等到加载完毕再执行非常影响效率(Selenium与纯靠代码发送请求的方式相比本来就比较没效率了), 所以可以通过一些设定在满足特定条件后立即执行相关操作. 比如下面就是等待一个特定的搜索按钮可以点击后, 再输入搜索内容并点击搜索.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">button = wait.until(EC.element_to_be_clickable((By.CLASS_NAME, <span class="string">&#x27;search-bar-btn&#x27;</span>)))</span><br><span class="line">browser.find_element_by_class_name(<span class="string">&#x27;search-input&#x27;</span>).send_keys(tar)</span><br><span class="line">button.click()</span><br></pre></td></tr></table></figure><h2 id="下载文件检查"><a href="#下载文件检查" class="headerlink" title="下载文件检查"></a>下载文件检查</h2><p>Selenium本身并不能完成下载文件的管理, 因此只能通过别的方式来进行下载文件管理&#x2F;重命名.</p><ul><li>对于可以通过网页代码解析出下载链接的, 可以通过调用别的工具进行下载</li><li>对于解析不出下载链接的, 可以通过<code>os</code>模块的相关内容监视下载文件, 并在下载后进行移动及重命名</li><li>我当时使用的是下面俩部分代码加起来的:</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># 抄来的一段代码, 这个函数每隔5s时间检查文件的大小情况, 如果大小跟上一次检查时没有变化, 则判定下载完毕, 会关闭浏览器对象</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wait_download</span>(<span class="params">file_path, browser, rep_name</span>):</span><br><span class="line">    current_size = getSize(file_path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; Downloading&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(current_size)))</span><br><span class="line">    <span class="keyword">while</span> current_size != getSize(file_path) <span class="keyword">or</span> getSize(file_path)==<span class="number">0</span>:</span><br><span class="line">        current_size =getSize(file_path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;current_size:&quot;</span>+<span class="built_in">str</span>(current_size))</span><br><span class="line">        time.sleep(<span class="number">5</span>)<span class="comment"># wait download</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Downloaded&quot;</span>)</span><br><span class="line">    os.rename(file_path, rep_name)</span><br><span class="line">    browser.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为下载启动本身需要时间, 目标文件出现后才启动上面的函数</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;waiting for download to start...&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">wait_download(file_path, browser, rep_name)</span><br></pre></td></tr></table></figure><h2 id="关于模拟点击的坑"><a href="#关于模拟点击的坑" class="headerlink" title="关于模拟点击的坑"></a>关于模拟点击的坑</h2><p>Selenium可以模拟对按钮, 链接, 复选框等的点击, 但是点击的前提是, 这些元素必须处于可见范围, 否则点击会无效或者会抛出异常. 因此, 在实际操作时, 需要自己测试一下是否要滚动页面, 以及滚动多少能保证元素可以被点击得到.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切出iframe</span></span><br><span class="line">browser.switch_to.default_content()</span><br><span class="line"><span class="comment"># 滚动浏览器到底部</span></span><br><span class="line">browser.execute_script(<span class="string">&quot;window.scrollTo(0,document.body.scrollHeight)&quot;</span>)</span><br><span class="line"><span class="comment"># 切回iframe</span></span><br><span class="line">browser.switch_to.frame(<span class="string">&#x27;analyzeFrame&#x27;</span>)</span><br></pre></td></tr></table></figure><h1 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h1><ul><li>一般第一个get请求得到的是网页的框架, 然后解析框架时再发出新的请求把需要的内容填充到页面</li><li>如果需要获得相应信息需要分析ajax请求<ul><li>Selenium&#x2F;WebDriver</li><li>Splash</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Script </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 爬虫 </tag>
            
            <tag> requests </tag>
            
            <tag> selenium </tag>
            
            <tag> 网页抓取 </tag>
            
            <tag> Web自动化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python中的一些魔术方法</title>
      <link href="/2019/11/25/Python%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/"/>
      <url>/2019/11/25/Python%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<p>原来之前使用的<code>__enter__</code>和<code>__exit__</code>就是以前耳闻的魔术方法, 这次我的程序开发因为以面向对象为主, 为了实现一些python中好用的功能所以涉及到了更多方法, 这里做个小笔记</p><!-- 摘要部分 --><span id="more"></span><h3 id="len"><a href="#len" class="headerlink" title="__len__"></a><code>__len__</code></h3><p>定义之后, 可以对实例使用<code>len()</code>函数.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    定义长度</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(self.Seq)</span><br></pre></td></tr></table></figure><h3 id="getitem"><a href="#getitem" class="headerlink" title="__getitem__"></a><code>__getitem__</code></h3><p>定以后, 可以对实例进行<code>[]</code>索引和切片操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, key</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    添加切片索引</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> self.d[key]</span><br></pre></td></tr></table></figure><h3 id="str"><a href="#str" class="headerlink" title="__str__"></a><code>__str__</code></h3><p>定义后, 使用<code>print()</code>打印实例时会打印这个方法内返回的内容</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(self.__dict__)</span><br></pre></td></tr></table></figure><h3 id="iter"><a href="#iter" class="headerlink" title="__iter__"></a><code>__iter__</code></h3><p>定以后, 可对对象进行迭代操作, 比如<code>for i in object</code>这种. 需要注意的是, 这个方法必须要返回迭代器(可迭代对象不行).</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> (mut <span class="keyword">for</span> mut <span class="keyword">in</span> self.muts)</span><br></pre></td></tr></table></figure><h3 id="eq-和-hash"><a href="#eq-和-hash" class="headerlink" title="__eq__和__hash__"></a><code>__eq__</code>和<code>__hash__</code></h3><p>这两个放一起是因为把实例放在<code>set()</code>中, 想要自动去重时, 这两个都要有, 否则无法达到目的效果. 其中<code>__eq__</code>是使对象可被比较是否相同(<code>==</code>和<code>!=</code>, <code>is</code>好像不可以). 注意这个方法里的<code>other</code>好像是固定的, 不要改动.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    保证利用set特性去重</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> self.muts == other.muts</span><br></pre></td></tr></table></figure><p><code>__hash__</code>则本质上是对象可被哈希化, 哈希化时的哈希值会是这个方法给的哈希值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    保证利用set特性去重</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hash</span>(self.muts)</span><br></pre></td></tr></table></figure><p>暂时就这么多, 以后有用到新的继续水~</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 魔术方法 </tag>
            
            <tag> 面向对象 </tag>
            
            <tag> 特殊方法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Snakemake的动态解析特性</title>
      <link href="/2019/11/24/Snakemake%E7%9A%84%E5%8A%A8%E6%80%81%E8%A7%A3%E6%9E%90%E7%89%B9%E6%80%A7/"/>
      <url>/2019/11/24/Snakemake%E7%9A%84%E5%8A%A8%E6%80%81%E8%A7%A3%E6%9E%90%E7%89%B9%E6%80%A7/</url>
      
        <content type="html"><![CDATA[<p>特么我终于成功使用这个特性了…我真是太南了…</p><!-- 摘要部分 --><span id="more"></span><p>在实际的流程中, 我们的流程可能会有一些”动态”的要求. 比如对fq进行比对, 或者对bam进行变异检测, 对应的比对&#x2F;检测软件可能并没有完善的多线程机制, 同时原始数据文件过分的大, 直接进行运算非常耗时. 这时候, 使用<code>源文件拆分-&gt;多进程并行-&gt;结果文件合并</code>就是一种非常实用的策略. 那么, 怎么拆呢? 我可以将文件按固定的方式来拆, 比如变异检测时经常会将bam按照染色体拆分开. 但是这种固定的拆分模式难免会出现效率不尽如人意的问题. 比如不同染色体的数据量是完全不一样的, 按染色体并行, 速度必然受数据量最大的那个染色体的限制. 但是如果不按照固定策略拆, 生成的拆分文件个数很可能是不固定的, 这与<code>snakemake</code>先解析要做什么再分配运行的逻辑冲突, 因此开发者在较新的版本中引入了动态解析机制(<code>Data-dependent conditional execution</code>).</p><p>这个机制的核心是<code>checkpoint</code>, 检查点是一种特殊的<code>rule</code>, 其在运行时与<code>rule</code>没有太大不同, 但是, 在流程运行到检查点后, 整个依赖图(<code>DAG</code>)会重新进行解析. 设计者的用意很明显: 将产生不定结果的规则设定为检查点, 在不定的文件实际产生后重新决定需要进行的步骤.</p><p>由于这个动态机制十分特殊, 因此检查点使用起来也比较麻烦, 无法像<code>rule</code>一样简单的使用. </p><p>首先<code>checkpoint</code>必须配合<code>function input</code>使用, 因为虽然加了新机制, 但是这个程序的运行逻辑依然是决定做什么然后分配. 而决定做什么这一点不是程序能自己决定的, 需要我们手动设计, 因此必须使用一个函数去获取检查点生成的文件, 然后将这些文件交给下游<code>rule</code>去解析. </p><p>我这有一个比官网那个稍微好理解点的例子:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> glob <span class="keyword">import</span> glob</span><br><span class="line"></span><br><span class="line">rule <span class="built_in">all</span>:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        <span class="string">&quot;&#123;sample&#125;.all.stat&quot;</span>.<span class="built_in">format</span>(sample=<span class="string">&quot;NL180614-2_S12_L001_R1_001&quot;</span>)</span><br><span class="line"></span><br><span class="line">checkpoint split:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        <span class="string">&quot;&#123;sample&#125;.fastq.gz&quot;</span></span><br><span class="line">    output:</span><br><span class="line">        touch(<span class="string">&quot;&#123;sample&#125;.splt.done&quot;</span>)</span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&quot;split -l 1000000 &#123;input&#125; &#123;wildcards.sample&#125;.split. &quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rule wc:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        <span class="string">&quot;&#123;sample&#125;.split.&#123;split&#125;&quot;</span></span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;&#123;sample&#125;.split.&#123;split&#125;.stat&quot;</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&quot;wc -l &#123;input&#125; &gt; &#123;output&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_split_files</span>(<span class="params">wildcards</span>):</span><br><span class="line">    split_output = checkpoints.split.get(**wildcards).output[<span class="number">0</span>]</span><br><span class="line">    split_dir = path.split(split_output)[<span class="number">0</span>]</span><br><span class="line">    split_files = glob(<span class="string">f&quot;*.split.*&quot;</span>)</span><br><span class="line">    tar_files = [<span class="string">f&quot;<span class="subst">&#123;f&#125;</span>.stat&quot;</span> <span class="keyword">for</span> f <span class="keyword">in</span> split_files]</span><br><span class="line">    <span class="keyword">return</span> tar_files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rule cat:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        get_split_files</span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;&#123;sample&#125;.all.stat&quot;</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        cat &#123;input&#125; &gt; &#123;output&#125;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>这个例子实现的是使用<code>split</code>将fq文件拆分成多个子文件, 分别计数行数然后将结果合并成一个文件. <code>checkpoint</code>的部分是拆分, 同时这个<code>rule</code>产生了一个不交由下游解析的结果, 也就是完全依赖无关. 真正有用的其实是<code>checkpoint</code>本身. <code>get_split_files()</code>函数中使用了<code>checkpoints</code>对象, 并且使用了其下<code>split</code>这个检查点的内容, 因此以这个函数作为输入的<code>cat</code>规则上游依赖是<code>checkpoint split</code>, 同时其也不会进行真正的依赖解析, 而是等待它的<code>checkpoint split</code>完成后再解析(也就是动态解析).</p><p>官方文档的例子基本也是这个原理, 只不过其<code>checkpoint</code>生成了目录结果, 以方便重解析生成的动态文件.</p><p>最后再补充一个bwa的例子:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> glob <span class="keyword">import</span> glob</span><br><span class="line"></span><br><span class="line">wildcard_constraints:</span><br><span class="line">    sample=<span class="string">r&quot;[A-Z,a-z,0-9,-]+&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rule <span class="built_in">all</span>:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        <span class="string">&quot;&#123;sample&#125;.srt.bam&quot;</span>.<span class="built_in">format</span>(sample=<span class="string">&quot;NL180614-2&quot;</span>)</span><br><span class="line"></span><br><span class="line">checkpoint split:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        fq1=<span class="string">&quot;&#123;sample&#125;_S12_L001_R1_001.fastq.gz&quot;</span>,</span><br><span class="line">        fq2=<span class="string">&quot;&#123;sample&#125;_S12_L001_R2_001.fastq.gz&quot;</span>,</span><br><span class="line">    output:</span><br><span class="line">        directory(<span class="string">&quot;&#123;sample&#125;_tmp&quot;</span>)</span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        mkdir -p &#123;output&#125;/R1</span></span><br><span class="line"><span class="string">        mkdir -p &#123;output&#125;/R2</span></span><br><span class="line"><span class="string">        zcat &#123;input.fq1&#125; | split -l 1000000 /dev/stdin &#123;output&#125;/R1/split.</span></span><br><span class="line"><span class="string">        zcat &#123;input.fq2&#125; | split -l 1000000 /dev/stdin &#123;output&#125;/R2/split.</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rule bwa:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        r1=<span class="string">&quot;&#123;sample&#125;_tmp/R1/split.&#123;split&#125;&quot;</span>,</span><br><span class="line">        r2=<span class="string">&quot;&#123;sample&#125;_tmp/R2/split.&#123;split&#125;&quot;</span>,</span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;&#123;sample&#125;_tmp/split.&#123;split&#125;.srt.bam&quot;</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        bwa mem -t 4 -M \\</span></span><br><span class="line"><span class="string">            -R &quot;@RG\\tID:&#123;wildcards.sample&#125;\\tPL:Illumina\\tPU:&#123;wildcards.sample&#125;\\tSM:&#123;wildcards.sample&#125;&quot; \\</span></span><br><span class="line"><span class="string">            /home/silen/git/Bio_Test/hg38-bwa/hg38.fa \\</span></span><br><span class="line"><span class="string">            &#123;input.r1&#125; \\</span></span><br><span class="line"><span class="string">            &#123;input.r2&#125; \\</span></span><br><span class="line"><span class="string">        | samtools view -Sb -@ 4  \\</span></span><br><span class="line"><span class="string">        | samtools sort -@ 4  \\</span></span><br><span class="line"><span class="string">        &gt; &#123;output&#125;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_split_files</span>(<span class="params">wildcards</span>):</span><br><span class="line">    split_dir = checkpoints.split.get(**wildcards).output[<span class="number">0</span>]</span><br><span class="line">    split_files_r1 = glob(<span class="string">f&quot;<span class="subst">&#123;split_dir&#125;</span>/R1/split.*&quot;</span>)</span><br><span class="line">    split_tag = [s.split(<span class="string">&quot;.&quot;</span>)[-<span class="number">1</span>] <span class="keyword">for</span> s <span class="keyword">in</span> split_files_r1]</span><br><span class="line">    split_bams = [path.join(split_dir,<span class="string">f&quot;split.<span class="subst">&#123;tag&#125;</span>.srt.bam&quot;</span>) <span class="keyword">for</span> tag <span class="keyword">in</span> split_tag]</span><br><span class="line">    <span class="keyword">return</span> split_bams</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rule cat:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        get_split_files</span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;&#123;sample&#125;.srt.bam&quot;</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        samtools merge -f &#123;output&#125; &#123;input&#125;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>目前已经在自己的一些项目中使用过这个特性了, 实际使用的感受是, 看上去很简单通用, 但是实际上碰到不同的问题还要结合软件情况不同考虑…</p><p>比如上面这个bwa的例子就尚有一个问题要解决: 这里生成的目录其实是临时目录, 我希望能在使用后删去, 但是现在<code>temp</code>和<code>directory</code>两个关键字是冲突的, 而临时文件夹中的文件是动态的, 没有办法直接指定, 因此暂时没法利用snakemake自有的特性自动删除.</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 生物信息学 </tag>
            
            <tag> 并行计算 </tag>
            
            <tag> snakemake </tag>
            
            <tag> 工作流管理 </tag>
            
            <tag> checkpoint </tag>
            
            <tag> DAG </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>让自写的对象可以用上with</title>
      <link href="/2019/11/14/%E8%AE%A9%E8%87%AA%E5%86%99%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%8F%AF%E4%BB%A5%E7%94%A8%E4%B8%8Awith/"/>
      <url>/2019/11/14/%E8%AE%A9%E8%87%AA%E5%86%99%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%8F%AF%E4%BB%A5%E7%94%A8%E4%B8%8Awith/</url>
      
        <content type="html"><![CDATA[<p><code>with open</code>是python中特别方便的一种写法, 对于支持的函数来说, 有了<code>with</code>这个语句可以很方便的在操作完成时自动关闭对象. 对于自己编写的对象其实也可以实现<code>with</code>语法的支持.</p><!-- 摘要部分 --><span id="more"></span><p>具体的做法就是在自己的<code>class</code>中定义<code>__enter__</code>和<code>__exit__</code>两个方法:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Start&quot;</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;End&quot;</span>)</span><br></pre></td></tr></table></figure><p>如此一来, 在使用<code>with</code>时就会先执行<code>__enter__</code>内的内容, 在代码块结束的时候则自动执行<code>__exit__</code>的内容了.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; with MyClass() as tClass:</span><br><span class="line">...     print(&quot;test&quot;)</span><br><span class="line">...</span><br><span class="line">Start</span><br><span class="line">test</span><br><span class="line">End</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 魔术方法 </tag>
            
            <tag> 上下文管理器 </tag>
            
            <tag> with语句 </tag>
            
            <tag> __enter__ </tag>
            
            <tag> __exit__ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>猛汉王狩猎日记_历战爆鳞龙</title>
      <link href="/2019/10/30/%E7%8C%9B%E6%B1%89%E7%8E%8B%E7%8B%A9%E7%8C%8E%E6%97%A5%E8%AE%B0-%E5%8E%86%E6%88%98%E7%88%86%E9%B3%9E%E9%BE%99/"/>
      <url>/2019/10/30/%E7%8C%9B%E6%B1%89%E7%8E%8B%E7%8B%A9%E7%8C%8E%E6%97%A5%E8%AE%B0-%E5%8E%86%E6%88%98%E7%88%86%E9%B3%9E%E9%BE%99/</url>
      
        <content type="html"><![CDATA[<p>男人的浪漫除了爆炸…还有社保!</p><p>沉迷狩猎…荒废事业ing…</p><iframe src="//player.bilibili.com/player.html?aid=73777571&cid=126193394&page=1" width="700" height="500" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><!-- 摘要部分 --><span id="more"></span>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 游戏 </tag>
            
            <tag> Monster Hunter World </tag>
            
            <tag> 怪物猎人世界 </tag>
            
            <tag> 历战爆鳞龙 </tag>
            
            <tag> 狩猎 </tag>
            
            <tag> Bazelgeuse </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>猛汉王狩猎日记_樱火龙</title>
      <link href="/2019/10/06/%E7%8C%9B%E6%B1%89%E7%8E%8B%E7%8B%A9%E7%8C%8E%E6%97%A5%E8%AE%B0-%E6%A8%B1%E7%81%AB%E9%BE%99/"/>
      <url>/2019/10/06/%E7%8C%9B%E6%B1%89%E7%8E%8B%E7%8B%A9%E7%8C%8E%E6%97%A5%E8%AE%B0-%E6%A8%B1%E7%81%AB%E9%BE%99/</url>
      
        <content type="html"><![CDATA[<p>果然就像我当年买了平板看了两天书之后就开始玩PSP模拟器一样…这次买了电脑也没有用来做软件测试太久…直接就被我用来打猛汉王了…我甚至还折腾了如何在宿主机上录客户机的视频…在折腾了一整天后最终选择了视频音频双串流…分别通过looking-glass和scream两个项目将视频和音频都串回宿主机, 然后在宿主机使用OBS进行录制. 至于你问我为啥不客户机直接录…那就不能体现抖m的本质了鸭!</p><p>奉上测试用的, 打得没有任何技术含量的樱火龙…</p><iframe src="//player.bilibili.com/player.html?aid=70256357&cid=118237953&page=1" width="700" height="500" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><!-- 摘要部分 --><span id="more"></span>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 游戏 </tag>
            
            <tag> 怪物猎人世界 </tag>
            
            <tag> 樱火龙 </tag>
            
            <tag> 视频录制 </tag>
            
            <tag> looking-glass </tag>
            
            <tag> scream </tag>
            
            <tag> OBS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大逆转裁判, 通关撒花&#92;(￣▽￣)/</title>
      <link href="/2019/10/05/%E5%A4%A7%E9%80%86%E8%BD%AC%E8%A3%81%E5%88%A4/"/>
      <url>/2019/10/05/%E5%A4%A7%E9%80%86%E8%BD%AC%E8%A3%81%E5%88%A4/</url>
      
        <content type="html"><![CDATA[<p>大逆转裁判通关了, 个人感觉这一作甚至在之前的成步堂三部曲之上, 因为与它们相比, 这一作没有超自然的元素, 故事中关于证据的部分更合理了一些(不是随便搬个物品&#x2F;人出来就能当证据). 当然, 在一个以推理的游戏性为重心的游戏里寻找合理性…我可能也是搞错了什么吧~</p><img src="https://gss1.bdstatic.com/-vo3dSag_xI4khGkpoWK1HF6hhy/baike/c0%3Dbaike220%2C5%2C5%2C220%2C73/sign=60bda97249166d222c7a1dc6274a6292/c8ea15ce36d3d5398346217a3087e950352ab00b.jpg" class="lazyload" data-srcset="https://gss1.bdstatic.com/-vo3dSag_xI4khGkpoWK1HF6hhy/baike/c0%3Dbaike220%2C5%2C5%2C220%2C73/sign=60bda97249166d222c7a1dc6274a6292/c8ea15ce36d3d5398346217a3087e950352ab00b.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" width="50%" height="50%"><!-- 摘要部分 --><span id="more"></span>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 游戏评测 </tag>
            
            <tag> 大逆转裁判 </tag>
            
            <tag> 推理游戏 </tag>
            
            <tag> 成步堂三部曲 </tag>
            
            <tag> game-review </tag>
            
            <tag> ace-attorney </tag>
            
            <tag> the-great-ace-attorney </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>编写Dockerfile构建docker镜像</title>
      <link href="/2019/10/05/%E7%BC%96%E5%86%99Dockerfile%E6%9E%84%E5%BB%BAdocker%E9%95%9C%E5%83%8F/"/>
      <url>/2019/10/05/%E7%BC%96%E5%86%99Dockerfile%E6%9E%84%E5%BB%BAdocker%E9%95%9C%E5%83%8F/</url>
      
        <content type="html"><![CDATA[<p>从过去的经验来看…我有很多的技能都属于副产物…今天这个也是, 我的本意在于使用网易提供的NemuBox源代码编译出一个网易改进过的Virtualbox, 结果…我学了几样跟docker有关的技能…</p><!-- 摘要部分 --><span id="more"></span><p>镜像的构建是docker的基本, 虽然也可以每次创建好基础镜像后进入手动构建或者通过类似dockerhub这样的平台直接拉取, 但是前者耗时且重复性差, 后者对网络有一定要求且自定义性差. 掌握编写和修改Dockerfile这一构建图纸的使用方法还是很必要的. 况且…其实这东西也非常简单.</p><p>我在Dockerfile中可能会用的比较多的关键字有:</p><ul><li><code>FROM</code>: 指定构建的基础镜像, 在构建开始前会pull指定的镜像作为构建基础.</li><li><code>COPY</code>: 从外部(宿主流经)复制文件到镜像内, 第一个参数是外部路径, 第二个参数是内部路径, 具体参数用法类似<code>cp</code>, 似乎不能多个文件同时使用, 没有尝试过通配符是否有效</li><li><code>ADD</code>: 类似<code>COPY</code>, 但是<code>ADD</code>可以获取网络上的文件, 这在向其他地方部署容器时非常有用</li><li><code>RUN</code>: 需要执行的命令</li><li><code>WORKDIR</code>: 构建好的镜像在启动时进入的目录</li><li><code>CMD</code>: 构建好的镜像在启动时运行的命令</li></ul><p>这里<code>COPY</code>和<code>RUN</code>两个命令需要特别注意:</p><ul><li><code>COPY</code>这个关键字在复制外部路径时, 只能获取<code>docker build</code>制定的构建路径下以及其下层的文件. 这个时是受docker运行时**上下文(context)**的限制. </li><li><code>RUN</code>命令每运行一次都会产生<strong>一层新镜像</strong>, 如果不是必须的, 最好精简需要运行的命令, 并将其以<code>&amp;&amp;</code>连接在同一个<code>RUN</code>下, 防止构建的镜像又大又慢.</li></ul><p>这里我写一个之前工作时需要部署的R包<code>sscClust</code>的例子:</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># sscClust Dockerfile</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># https://github.com/dockerfile/fpm</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pull base image.</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install dep-packages</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y epel-release wget \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mv</span> /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.bak \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; yum clean all \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; yum makecache -y \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; yum install -y R openssl-devel libcurl-devel libxml2-devel gsl-devel \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mkdir</span> -p /install_script</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install R packages</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> install.r /install_script/install.r</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> Rscript /install_script/install.r</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define working directory.</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define default command.</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /bin/bash</span></span><br></pre></td></tr></table></figure><p>其中涉及的R脚本为:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">options<span class="punctuation">(</span><span class="string">&quot;repos&quot;</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>CRAN<span class="operator">=</span><span class="string">&quot;https://mirrors.ustc.edu.cn/CRAN/&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span>BioC_mirror<span class="operator">=</span><span class="string">&quot;http://mirrors.ustc.edu.cn/bioc/&quot;</span><span class="punctuation">)</span></span><br><span class="line">install.packages<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;BiocManager&quot;</span><span class="punctuation">,</span> <span class="string">&quot;devtools&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;SingleCellExperiment&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;scran&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;SC3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;zinbwave&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;BiocParallel&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">devtools<span class="operator">::</span>install_github<span class="punctuation">(</span><span class="string">&quot;Japrin/sscClust&quot;</span><span class="punctuation">)</span>   </span><br></pre></td></tr></table></figure><p>执行<code>docker build -t=test_docker .</code>使用上面文件构建镜像</p><p>当然现在已经不保证这个例子能顺利构建了, 因为软件总是在不断更新, 而我的构建过程没有任何指定特定版本软件的内容, 随着时间的推进, 很有可能会出现各种依赖爆炸…不过作为使用记录还是阔以哒~</p>]]></content>
      
      
      <categories>
          
          <category> Script </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> R语言 </tag>
            
            <tag> Dockerfile </tag>
            
            <tag> 容器化 </tag>
            
            <tag> 镜像构建 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在Linux系统中添加自定义服务</title>
      <link href="/2019/10/05/%E5%9C%A8Linux%E7%B3%BB%E7%BB%9F%E4%B8%AD%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1/"/>
      <url>/2019/10/05/%E5%9C%A8Linux%E7%B3%BB%E7%BB%9F%E4%B8%AD%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<p>使用Linux系统的时候经常会需要设置一些开机自启动的东西, 对于使用systemd的发行版, 自行编写服务文件并启用是个非常不错的选择.</p><!-- 摘要部分 --><span id="more"></span><p>服务文件采用类似ini格式的配置文件编写, 一个基本的服务配置文件包含如下内容:</p><ul><li><code>Unit</code>: 定义的部分, 比如说明什么的</li><li><code>Service</code>: 实际执行执行内容, 包括这个服务是啥类型, 启动时要做什么, 结束时要做什么, 重启要做什么之类的</li><li><code>Install</code>: 基本都是以来关系, 比如服务什么时候启动, 或者在XX之前&#x2F;之后启动</li></ul><p>下面是一个v2ray服务的例子:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Daemon to start V2ray</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/v2ray -config /home/silen/script/v2ray/v2ray.json</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">Alias</span>=v2ray</span><br><span class="line"><span class="attr">WantedBy</span>=default.target</span><br></pre></td></tr></table></figure><p>这个服务如果开启了, 则默认自动启动(<code>WantedBy=default.target</code>), 启动时执行命令<code>/usr/bin/v2ray -config /home/silen/script/v2ray/v2ray.json</code>, 也就是开启v2ray代理. 对于服务的其他动作, 比如重启停止之类没有作定义.</p><p>写好上面的文件后就可以把这个文件命名为<code>v2ray.service</code>放到指定的位置(<code>/etc/systemd/system</code>或<code>/usr/lib/systemd/system</code>), 然后以root权限使用<code>systemctl enable v2ray.service</code>就可以激活服务(开机后根据配置情况启动), 使用<code>systemctl start v2ray.service</code>则可立刻启动服务.</p><p>需要注意的是, 调用root权限去启动服务, 那么执行用户也自然是root, 这在某些情况下并不是一个好选择. 因此我之前的同步服务和这次的v2ray服务实际都是以个人用户的权限去开启的. 也就是将上面的服务文件放到<code>/home/&lt;user&gt;/.config/systemd/user</code>下, 然后直接<code>systemctl start --uesr v2ray.service</code>来启动服务.</p><p>这种情况下的服务只会在我当前用户登入后才开始执行, 并且也不需要root权限(用户需要不需要在root group中我倒不清楚).</p><p>示例中使用的v2ray程序属于占着前台不放的类型, 因此可以直接使用<code>simple</code>类型. 除了该类型还有: <code>simple</code>, <code>forking</code>, <code>oneshot</code>, <code>notify</code>, <code>dbus</code>, <code>idle</code></p><p>当然我自定义的服务一般也就很简单, <code>sample</code>和<code>oneshot</code>应该够用了.</p><p>至于<code>ExecStart</code>, <code>ExecStop</code>, 和<code>ExecReload</code>, 前者是必须的, 后两者则可根据启动命令的情况选择是否需要编写.</p><p>最后是<code>Install</code>里的<code>WantedBy=default.target</code>这个根据我的尝试是必须加的, 因为不加服务不会自动启动…不知道是不是只有user层面的服务才会这样</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> systemd </tag>
            
            <tag> 服务管理 </tag>
            
            <tag> 自定义服务 </tag>
            
            <tag> service </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>台式机置备计划(下)</title>
      <link href="/2019/09/08/%E5%8F%B0%E5%BC%8F%E6%9C%BA%E7%BD%AE%E5%A4%87%E8%AE%A1%E5%88%92-2/"/>
      <url>/2019/09/08/%E5%8F%B0%E5%BC%8F%E6%9C%BA%E7%BD%AE%E5%A4%87%E8%AE%A1%E5%88%92-2/</url>
      
        <content type="html"><![CDATA[<p>在千辛万苦搞定了硬件之后, 接下来就是软件了.</p><!-- 摘要部分 --><span id="more"></span><p>按照我之前的规划, 我的机器需要达到一机多用的效果: 宿主机linux用来做计算, 虚拟机windows用来打游戏.</p><p>但凡用过虚拟机的人应该都知道…虚拟机的性能一直是个的问题, 就算牛X如vmware和mac专属的parallel, 其图形性能也还是不如原生硬件. 因此也就有了PCI Passthrough这种技术, 即将PCI插槽上的设备从宿主机屏蔽, 直接分配给虚拟机使用. 获得了实际的硬件, 没有中间商, 性能也就几乎与原生无异了. 这也是我当初买了个有两条显卡PCI插槽主板的原因, 因为如果日后要虚拟出两台打游戏用的电脑, 必须给每台机器都分配一张显卡, 然后宿主机启动也是要显卡的, 所以CPU需要有内建显卡.</p><p>本次虚拟化配置我使用的宿主系统为Manjaro, 参考的文档&#x2F;视频包括:</p><ul><li><a href="https://wiki.archlinux.org/index.php/PCI_passthrough_via_OVMF_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">ArchWiki上的GPU Passthrough教程</a></li><li><a href="https://www.bilibili.com/video/av54526748">Linus Tech Tips的虚拟MacOS视频</a></li><li><a href="#">INVALID POST SLUG PROVIDED </a></li></ul><p>由于这份配置是在基于Arch的发行版上进行的, 因此具体设置用的命令和组件会和中文网站中搜索到的材料比较不一样(基本都是基于Ubuntu的).</p><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><h3 id="1-准备系统盘"><a href="#1-准备系统盘" class="headerlink" title="1. 准备系统盘"></a>1. 准备系统盘</h3><ul><li>宿主系统: manjaro-architect-18.0.4-stable, 基于Arch的衍生发行版, 特点是简单易上手, 虽然被Arch教派认为是邪道, 单阻止不了其越来越高的人气(甚至我昨天看到Manjaro的社区和Ubuntu一样开了个公司). 使用architect而不是预搭载桌面的livecd主要是因为镜像小, 所有软件包全程联网下载就好.</li><li>子系统: 与宿主系统不一样, 子系统除了准备一份要安装到宿主机中的windows之外, 可能还需要准备一份<strong>支持EFI启动的ISO镜像</strong>. 因为ArchWiki上的教程使用了OVMF(这会让直通更简单, 少一些在虚拟BIOS上配置的过程), 用了这东西之后虚拟机内使用的就是EFI(only), 而不是BIOS了. 这就要求安装系统的ISO镜像一定要支持EFI启动. 但是我下载了很多个系统安装镜像都不支持…因此只好专门找了个支持UEFI的PE镜像, 用这个镜像引导启动, 然后安装另外一份安装镜像上的系统.</li></ul><h3 id="2-安装宿主系统"><a href="#2-安装宿主系统" class="headerlink" title="2. 安装宿主系统"></a>2. 安装宿主系统</h3><p>使用宿主系统盘在电脑上安装好Manjaro, 详细步骤其他地方找得到, 我这里就先略了, 以后有空再补截图(咕咕咕).</p><h3 id="3-进行GPU隔离设置"><a href="#3-进行GPU隔离设置" class="headerlink" title="3. 进行GPU隔离设置"></a>3. 进行GPU隔离设置</h3><p>进行直通就是让虚拟机直接使用被直通的硬件, 因此需要防止宿主机对硬件进行访问. 具体设置为:</p><ul><li>启动IOMMU<ul><li>打开配置文件(<code>/etc/default/grub</code>)更改内核参数, 以启用IOMMU:  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet udev.log_priority=3 audit=0 amd_iommu=on iommu=pt&quot;</span><br><span class="line">GRUB_CMDLINE_LINUX=&quot;&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li>进行上面的编辑后需要重新生成生成&#96;grub.cfg:  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure></li></ul></li><li>编辑配置文件使用vcfio屏蔽准备隔离的显卡组件<ul><li>使用<code>lspci -nnk</code>命令查看所有的PCI硬件信息, 从中找到需要直通的硬件, 并记录其ID:  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">01:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Baffin [Radeon RX 460/560D / Pro 450/455/460/555/555X/560/560X] [1002:67ef] (rev e5)</span><br><span class="line">    Subsystem: Tul Corporation / PowerColor Baffin [Radeon RX 460/560D / Pro 450/455/460/555/555X/560/560X] [148c:2385]</span><br><span class="line">    Kernel driver in use: vfio-pci</span><br><span class="line">    Kernel modules: amdgpu</span><br><span class="line">01:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] Baffin HDMI/DP Audio [Radeon RX 550 640SP / RX 560/560X] [1002:aae0]</span><br><span class="line">    Subsystem: Tul Corporation / PowerColor Baffin HDMI/DP Audio [Radeon RX 550 640SP / RX 560/560X] [148c:aae0]</span><br><span class="line">    Kernel driver in use: vfio-pci</span><br><span class="line">    Kernel modules: snd_hda_intel</span><br></pre></td></tr></table></figure></li><li>上面的信息是我屏蔽之后的信息, 因此两个设备的<code>Kernel driver in use</code>都显示为<code>vfio-pci</code>, 代表屏蔽成功, 屏蔽前应该是安装系统时安装的开源驱动; 需要记录的ID跟在设备名称的中括号中, 在上面的例子中分别是显示设备<code>[148c:2385]</code>和音频设备<code>[1002:aae0]</code>(现在的显卡很多都带音频输出…所以会显示为两个设备实际是要一起屏蔽的)</li><li>创建<code>/etc/modprobe.d/vfio.conf</code>, 并在其中加入<code>options vfio-pci ids=&lt;id to block&gt;</code></li><li>编辑<code>/etc/mkinitcpio.conf</code>, 在其中找到下面项目并添加如相应内容:  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">MODULES=(... vfio_pci vfio vfio_iommu_type1 vfio_virqfd ...)</span><br><span class="line">...</span><br><span class="line">HOOKS=(... modconf ...)</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li>编辑完成之后, 更改是不会生效的, 需要重新生成<code>initramfs</code>:<ul><li><strong>注意:</strong> 由于我对这个东西是什么并没有概念, 并且ArchWiki上相关的内容我也看不懂, 所以这里记录的是我进行的实际操作, 并不保证是最正确的操作</li><li>执行命令重新生成<code>/boot</code>下的启动用<code>img</code>文件: <code>sudo mkinitcpio -g /boot/initramfs-4.19-x86_64.img</code>(建议把原来的备份)</li><li>覆盖原来的<code>img</code>后, 需要重新启动宿主机, 如果设置成功, 则对应设备的驱动应该为<code>vfio-pci</code></li><li>在进行覆盖后, 宿主系统无法访问被屏蔽的硬件, 如果有需要访问的, 可以在启动时在grub菜单选择通过<code>initramfs-4.19-x86_64-fallback.img</code>启动, 这个没有被改动过, 可以正常访问硬件.</li></ul></li></ul></li></ul><h3 id="4-安装并配置虚拟机"><a href="#4-安装并配置虚拟机" class="headerlink" title="4. 安装并配置虚拟机"></a>4. 安装并配置虚拟机</h3><p>在做好硬件的设置后, 下面就要进行软件的配置了.</p><ul><li>安装虚拟机管理软件<ul><li>tip: 这里安装的是使用虚拟机的软件QEMU和简化QEMU设置的VirtManager和libvirt, kvm本身是linux内核中的一个模块, 只要在主板中设置开启虚拟化就可以使用了, 无须另外安装什么  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S qemu libvirt virt-manager ovmf</span><br></pre></td></tr></table></figure></li></ul></li><li>创建虚拟机<ul><li>打开virt-manager, 点击创建虚拟机<br>  <img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/add_vm.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/add_vm.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="add_vm.jpg"></li><li>选择安装镜像(非启动用), 由于下载的镜像不是官方的, 无法自动识别是啥系统, 所以去掉自动检测然后手动选择<code>Win10</code>然后进入下一步<br>  <img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/select_iso.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/select_iso.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="select_iso.jpg"></li><li>CPU和内存分配<br>  <img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/cpu_mem.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/cpu_mem.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="cpu_mem.jpg"></li><li>选择创建镜像(没啥特殊图略…)</li><li>确认信息, 选择网络为桥接, 并选择进一步编辑</li><li>分配需要直通的设备<br>  <img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/pci_device.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/pci_device.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="pci_device.jpg"></li><li>由于我手头的安装镜像不支持UEFI启动, 因此另外找了一个支持但是里面没有安装文件的启动镜像, 需要对启动顺序做点小设置, 保证挂载启动镜像并从它启动<br>  <img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/boot.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/boot.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="boot.jpg"></li><li>编辑CPU信息, 主要是勾选<code>复制主机CPU配置</code>(等同于<code>host-model</code>)<br>  <img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/set_cpu.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/set_cpu.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="set_cpu.jpg"></li><li>编辑使用的BIOS为OVMF(具体参照ArchWiki, 图忘截了…)</li><li>点击左上角的开始安装正常安装系统即可</li></ul></li></ul><h3 id="5-音频设备BUG修复及其他"><a href="#5-音频设备BUG修复及其他" class="headerlink" title="5. 音频设备BUG修复及其他"></a>5. 音频设备BUG修复及其他</h3><p>在完成上述步骤安装好系统后, 一台有物理显卡的虚拟机就搞定了, 将显卡的显示接口接到任意显示设备就能快乐的玩游戏了. 但是这时依然存在一个问题, 虽然显卡是自带音频设备的, 理论上一条HDMI线就可以把音频传到我显示器的扬声器上播放才是. 但是实际上在虚拟机里面连没有找到显卡附带的音频设备. 这个问题苦恼了我一个星期, 最后在Promox(一个专门用来作虚拟化宿主的发行版)的论坛上看到了类似的问题, 说这个问题是Q35 4.0的一个Bug导致的, 可以在虚拟机配置文件中将版本回退到3.1来解决. 因此我们需要手动编辑虚拟机的XML配置文件(需要打开直接编辑的选项), 找到对应的条目改成如下配置:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;type arch=&quot;x86_64&quot; machine=&quot;pc-q35-3.1&quot;&gt;hvm&lt;/type&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/game_xml_config.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/game_xml_config.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="game_xml_config.jpg"></p><p>终于…可以坐下来好好玩游戏了~~~~~</p><p>后记: 一篇9.8就开始写的博文硬生生被我鸽到了快10.8……猛汉王果然魅力巨大….</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Manjaro </tag>
            
            <tag> 显卡直通 </tag>
            
            <tag> KVM </tag>
            
            <tag> QEMU </tag>
            
            <tag> 虚拟化 </tag>
            
            <tag> AMD显卡 </tag>
            
            <tag> Windows虚拟机 </tag>
            
            <tag> 音频设备 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>台式机置备计划(上)</title>
      <link href="/2019/09/02/%E5%8F%B0%E5%BC%8F%E6%9C%BA%E7%BD%AE%E5%A4%87%E8%AE%A1%E5%88%92_1/"/>
      <url>/2019/09/02/%E5%8F%B0%E5%BC%8F%E6%9C%BA%E7%BD%AE%E5%A4%87%E8%AE%A1%E5%88%92_1/</url>
      
        <content type="html"><![CDATA[<p>本年年初的时候, 本来存了2000块, 准备用来买个二手服务器, 用来在测试软件之余顺便打打游戏. 但是看来看去, 感觉服务器还是太麻烦了…耗电大, 噪音也大, 如果要加装显卡还得改造…毕竟我在硬件方面毫无经验…所以最后还是改为了买个够用且够便宜的台式机. 本来我618都要下手了…可是碰上工作变动, 没有时间精力折腾, 于是作罢…前端时间看上的主板又在京东打特价, 终于没忍住剁了手…可是一查才发现…看中的CPU全网都很难买到全新了…(怕不是618全清完了), 几经周折, 最后好不容易把所有东西买全, 组起了我人生第一台自主组装的台式机~</p><!-- 摘要部分 --><span id="more"></span><h2 id="配件列表"><a href="#配件列表" class="headerlink" title="配件列表"></a>配件列表</h2><p>我的配置思路有点特别, 因为我对这台机器的预期有些特别. 我希望用它来满足一下所有需求:</p><ol><li>个人生信计算测试(多核心+大内存+linux)</li><li>个人基本游戏需要(入门显卡+win)</li><li>一机虚拟化为多机, 和女票一起打游戏(入门显卡x2+linux+显卡直通+win虚拟机)</li><li>机箱不要太大, 尽量小而美观</li></ol><p>综上, 我最后选了一个4内存插槽, 2显卡插槽的M-ATX的主板, 为的就是日后能上32G甚至64G内存(一些研究机构开发的原型软件内存开销巨大), 并且能上双显卡以虚拟化出两台Win机器. CPU方面就比较糟心, 因为宿主机需要, 集成显卡是必须的, 我又想支持AMD…所以本质上没得选, 现阶段只有2400G一个型号能用…</p><p>完整配件清单如下:</p><table><thead><tr><th>组件</th><th>型号</th><th>平台</th><th>价格</th><th>备注</th></tr></thead><tbody><tr><td>处理器</td><td>AMD Ryzen 2400G</td><td>淘宝</td><td>760</td><td>二手散片</td></tr><tr><td>显卡</td><td>迪兰恒进 RX560d 4G</td><td>淘宝</td><td>245</td><td>二手矿卡</td></tr><tr><td>主板</td><td>技嘉 B450M DS3H</td><td>京东</td><td>499</td><td>买完又降了50…</td></tr><tr><td>内存</td><td>十铨 火神DDR4 3000 8G x 2</td><td>京东</td><td>498</td><td></td></tr><tr><td>机箱</td><td>Thermaltake 启航者S3</td><td>京东</td><td>129</td><td></td></tr><tr><td>电源</td><td>Thermaltake Smart RGB 600W</td><td>京东</td><td>278</td><td>没看清…买了非模组化…</td></tr><tr><td>散热器</td><td>Thermaltake 彩虹D400P</td><td>京东</td><td>85</td><td>没看清…65W的CPU上了150W的散热器…</td></tr><tr><td>总计</td><td></td><td></td><td>2494</td><td>(760+245+499+498+129+278+85&#x3D;2494) <br>确实挺便宜的…</td></tr></tbody></table><p>买台式配件真的是比买笔记本复杂很多…我买的过程中就碰到了:</p><ul><li>CPU没货只好买二手散片, 结果二手散片也全网缺货, 来回找了三家才买到, 还从第一家那赚了30块的申诉赔偿(没货却不下架)…</li><li>显卡虽然知道是矿卡…但是没注意我买的这块是单DVI接口的…无奈后续补了个转换器</li><li>主板虽然有双显卡槽, 但是没法直接插俩显卡, 因为下面的显卡插槽会挡住PIN线和USB3.0的线, 需要额外转接头</li><li>看中的电源没货, 买替代的时候没注意替代的是非模组化电源…后续理线头疼</li><li>散热器的尺寸超出我想象…还好机箱买的比较大…</li><li>机箱比想象大好多…没想到跟散热歪打正着…</li></ul><p>买配件就够复杂了…后续装机坑也是一个接一个:</p><ul><li>散热器风扇装反, 重装卡歪了…以后有点难取下来…</li><li>非模组电源理线糟心</li><li>硬盘架装反, 差点拔不出来</li><li>没注意看风散热器说明书, 散热器装了两个半小时</li></ul><p>在前前后后折腾了将近两个星期后, 终于是把一切弄好了…作为缓冲, 先装了win10测试玩猛汉王. 比较惊喜的是原来2400G已经可以720p低画质流畅游戏了…而且我用的房东的电视…720p和1080p在这个电视上其实没有特别明显的差别…也就是说如果我只是买一台机器玩猛汉王, 砍掉8G内存(250), CPU直接买2200G加A320M的套装(1000以诶), 电源用100多块机箱送的300W电源, 甚至1500左右都可以玩猛汉王了…如此依赖…猛汉王真是亲民…</p><p>以上微制备计划的硬件篇, 回头更新更糟心的软件篇~</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 台式机 </tag>
            
            <tag> 硬件配置 </tag>
            
            <tag> 装机经验 </tag>
            
            <tag> AMD处理器 </tag>
            
            <tag> 二手配件 </tag>
            
            <tag> PC-building </tag>
            
            <tag> hardware-configuration </tag>
            
            <tag> AMD-Ryzen </tag>
            
            <tag> used-parts </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Syncthing进行文件同步</title>
      <link href="/2019/08/18/%E4%BD%BF%E7%94%A8Syncthing%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5/"/>
      <url>/2019/08/18/%E4%BD%BF%E7%94%A8Syncthing%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5/</url>
      
        <content type="html"><![CDATA[<p>只要使用多台设备进行工作, 就一定会涉及到不同设备之前互相同步的问题. 现在已经不是七八年前云服务刚兴起, 便宜又大碗的时代了. 一个实惠好用又不会突然跑路或改用户协议的服务商怕是并不存在, 所以还是要靠自己来搭了…</p><!-- 摘要部分 --><span id="more"></span><p>Syncthing在<a href="https://www.appinn.com/syncthing/">小众软件</a>和<a href="https://www.iplaysoft.com/syncthing.html">异次元软件</a>都有介绍, 是一款使用简单且开源的同步软件.</p><p>由于官方已经提供了打包好的可执行文件, 三大平台都是下载运行文件后即可使用, 因此我就不再重复了. 这里主要记录如何在我的电脑和VPS上将其设置为服务来运行.</p><p>CentOS7和Manjaro都有systemd, 且操作命令都是<code>systemctl</code>, 所以操作一样的. </p><p>首先找到Syncthing执行文件包, 里面的<code>Syncthing/etc/</code>下有已经准备好的各种服务配置文件实例. 我使用的是<code>Syncthing/etc/linux-systemd/user/syncthing.service</code>. 打开这个文件, 将其中的<code>[Service]</code>部分的<code>ExecStart</code>项目中的程序路径改成自己的程序位置. 我是将这个服务作为当前用户的服务而不是系统级服务使用, 所以将这个文件复制到<code>~/.config/systemd/user/</code>, 然后运行命令启动服务即可:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl --user <span class="built_in">enable</span> syncthing.service</span><br><span class="line">systemctl --user start syncthing.service</span><br></pre></td></tr></table></figure><p>启动后可像其他服务一样用<code>ststemctl</code>来查看服务运行状态.</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/Syncthing.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/Syncthing.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Syncthing"></p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件同步 </tag>
            
            <tag> 跨设备同步 </tag>
            
            <tag> Syncthing </tag>
            
            <tag> systemd </tag>
            
            <tag> 开源工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git钩子使用</title>
      <link href="/2019/08/17/Git%E9%92%A9%E5%AD%90%E4%BD%BF%E7%94%A8/"/>
      <url>/2019/08/17/Git%E9%92%A9%E5%AD%90%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>虽然我也用Git进行部分项目的代码管理, 但是其实很多Git的特性我都还不熟悉, 也没有用, 今天尝试了一下Githook的使用.</p><!-- 摘要部分 --><span id="more"></span><p>Hook, 直译就是钩子, 指的是预先定义好的一系列脚本. 这些脚本在我们使用特定的Git命令完成一些代码管理操作时自动执行, 以达到减少重复操作, 提高效率的目的.</p><p>比如我的博客源代码就是用Git管理的. 我现在写一篇博客并发布的步骤是:</p><ol><li><code>hexo new post</code>创建一篇新的博客文章的makrdown草稿</li><li>打开新建的markdown文件, 编写内容</li><li>编写完成后运行<code>hexo g</code>和<code>hexo d</code>将博客内容生成并推送到Gitpages的源上去</li><li>运行<code>git commit</code>提交博客源代码的修改, 然后<code>git push</code>到源代码源上去</li></ol><p>其中, 撰写博客的过程可能会有一些不固定的操作, 但是最后两部的内容其实是每次写博客一定会重复且不太会变动的步骤. 这些步骤就可以利用钩子来执行.</p><p>首先要来判断这些东西应该在什么时候执行: 我的博客源代码在<code>commit</code>之前, 我会首先确认内容. 所以理论上, 我使用任何一个<code>git commit</code>会触发的钩子都可以. 实际选用的钩子为<code>post-commit</code>, 这个钩子会在<code>commit</code>后执行, 所以我就把如下内容写到项目的<code>.git/hooks/post-commit</code>文件中(名字不要改, 特定的名称才会被执行).</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> /home/silen/git_proj/silen_blog/</span><br><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure><p>然后给这个文件加上可执行权限, 这样一来, 每次我对这个项目完成一次commit后, 就会调用这个脚本自动进行博客的生成和推送了.</p><p>当然现在这里举的例子可能没啥吸引力, 因为这两步其实也并不多…省不了太多功夫. 但是我现在的站点除了主站, 我还在子站里弄了个个人的速查手册. 这个手册使用mkdocs进行编写, 是另外一个独立项目. 如果想要达到两个项目其中一个更新就同步更新到博客的话, 钩子应该就很实用了.</p><p>最后需要注意的是, git钩子是分为客户端和服务端的, 我现在使用的是客户端的一种钩子. 客户端钩子的一个缺陷是无法在项目的不同副本间同步(不同副本是不同的客户端), 这个问题我之后再找方法解决好了…</p><p>以上~</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git钩子 </tag>
            
            <tag> 自动化部署 </tag>
            
            <tag> 博客管理 </tag>
            
            <tag> git </tag>
            
            <tag> githook </tag>
            
            <tag> post-commit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>装饰器入门</title>
      <link href="/2019/08/15/%E8%A3%85%E9%A5%B0%E5%99%A8%E5%85%A5%E9%97%A8/"/>
      <url>/2019/08/15/%E8%A3%85%E9%A5%B0%E5%99%A8%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<p>很早之前, 前公司的Python大神就有给我们科普过装饰器的使用, 但是由于个人愚钝, 一直没有很好理解这个东西, 也没有在实际的写代码的时候用过. 因此这里把这种工作总遇到的一个例子记录一下.</p><!-- 摘要部分 --><span id="more"></span><p>首先, Python中装饰器本身的作用是在不改动原函数代码的前提下为其附加新的功能, 因为它本身其实也要求你去定义一个函数, 只不过这个函数以函数为接收对象, 也以函数为返回对象.</p><p>我本周碰到的一个问题是, 我写了一个函数去计算<code>Bam</code>文件中UMI序列的一些指标, 但是输入的<code>Bam</code>带的UMI有两种情况: </p><ul><li>双端各N个bpUMI</li><li>单端N个bpUMI<br>这两种情况在从<code>Bam</code>文件中读取UMI的时候处理是不一样的, 单端的话要读取UMI全长, 双端的话只读UMI的半长. 原本单端的代码如下:</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">single_count</span>(<span class="params">file, tag, mode</span>):</span><br><span class="line">    umi_count = &#123;</span><br><span class="line">        <span class="string">&#x27;R1&#x27;</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line">    infos = load_single(file)</span><br><span class="line">    <span class="keyword">for</span> info <span class="keyword">in</span> infos:</span><br><span class="line">        <span class="keyword">if</span> info[<span class="string">&#x27;strand&#x27;</span>] == <span class="string">&#x27;R1&#x27;</span>:</span><br><span class="line">            umi_count[<span class="string">&#x27;R1&#x27;</span>].append(info[<span class="string">&#x27;umi&#x27;</span>])</span><br><span class="line">    umi_count[<span class="string">&#x27;R1&#x27;</span>] = Counter(umi_count[<span class="string">&#x27;R1&#x27;</span>])</span><br><span class="line">    total_umi = <span class="number">0</span></span><br><span class="line">    read_with_umi = <span class="number">0</span></span><br><span class="line">    max_grp_size = <span class="number">0</span></span><br><span class="line">    max_umi = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    size_stat = Counter([<span class="number">1</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">100</span>, <span class="number">1000</span>])</span><br><span class="line">    <span class="keyword">for</span> umi <span class="keyword">in</span> umi_count[<span class="string">&#x27;R1&#x27;</span>]:</span><br><span class="line">        <span class="keyword">if</span> umi_count[<span class="string">&#x27;R1&#x27;</span>][umi] &gt; max_grp_size:</span><br><span class="line">            max_grp_size = umi_count[<span class="string">&#x27;R1&#x27;</span>][umi]</span><br><span class="line">            max_umi = umi</span><br><span class="line">        <span class="keyword">for</span> size <span class="keyword">in</span> size_stat: <span class="comment"># 注意初始化的时候, 全都是1, 不是0, 所以最后要处理(-1)</span></span><br><span class="line">            <span class="keyword">if</span> umi_count[<span class="string">&#x27;R1&#x27;</span>][umi] &lt;= size:</span><br><span class="line">                size_stat[size] += <span class="number">1</span></span><br><span class="line">        total_umi += <span class="number">1</span></span><br><span class="line">        read_with_umi += umi_count[<span class="string">&#x27;R1&#x27;</span>][umi]</span><br><span class="line">    size_stat = OrderedDict(<span class="built_in">list</span>([(<span class="string">&quot;%%Group_Size_below_%s(%s)&quot;</span> % (size, tag), <span class="built_in">str</span>((size_stat[size] - <span class="number">1</span>) / total_umi )) \</span><br><span class="line">        <span class="keyword">for</span> size <span class="keyword">in</span> size_stat])) <span class="comment"># python所以要先list化</span></span><br><span class="line">    <span class="keyword">return</span> total_umi, read_with_umi, max_grp_size, max_umi, size_stat</span><br></pre></td></tr></table></figure><p>而双端读取的代码与单端的区别仅仅是<code>infos = load_single(file)</code>这一句需要替换成<code>infos = load_duplex(file)</code>而已. 为了实现这一目的其实也有很直接简单的方式, 就是更改这个函数, 加上一个参数, 然后在这一句前面加一个判断, 根据传入的参数决定调用<code>load_duplex</code>还是<code>load_single</code>. 但是这样一来会需要改动这个函数的代码, 以及调用这个函数的其他代码. 如果这样的地方一多, 其实难免会产生新的bug. 因此这次我尝试使用装饰器来解决这个问题:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_mod</span>(<span class="params">func</span>):</span><br><span class="line">    load_single = load_duplex</span><br><span class="line">    <span class="keyword">return</span> func</span><br><span class="line"></span><br><span class="line"><span class="meta">@load_mod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">duplex_count</span>(<span class="params">file, tag, mode</span>):</span><br><span class="line">    <span class="keyword">return</span> single_count(file, tag, mode)</span><br></pre></td></tr></table></figure><p>这里我新定义了两个函数, <code>duplex_count</code>想达到的效果是重复<code>single_count</code>中除了<code>infos = load_single(file)</code>之外的所有步骤, 然后只把调用的函数改成<code>load_duplex</code>. 因此可以看到这个函数的内容其实就是返回<code>single_count</code>的计算结果. 单这样一来并没有完成两个load函数的替换.<br> 这里就是<code>load_mod</code>发挥作用的地方了: 它用来对局部命名空间内的内容进行替换, 具体是将<code>load_single</code>的内容以<code>load_duplex</code>替换. 以<code>load_mod</code>装饰<code>duplex_count</code>后, 相当于在执行函数前先把<code>load_single</code>的内容以<code>load_duplex</code>替换, 这样一来, 这个函数的执行的东西就改变了.</p><p> 当然, 我这么用其实更像常见装饰器教程中的’闭包’用法, 而不是’为函数添加新功能’.</p><p> 其他的应用之后再继续水.</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 装饰器 </tag>
            
            <tag> 函数式编程 </tag>
            
            <tag> 闭包 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>黑历史计划,启动!</title>
      <link href="/2019/07/27/%E9%BB%91%E5%8E%86%E5%8F%B2%E8%AE%A1%E5%88%92-%E5%90%AF%E5%8A%A8/"/>
      <url>/2019/07/27/%E9%BB%91%E5%8E%86%E5%8F%B2%E8%AE%A1%E5%88%92-%E5%90%AF%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<p>作为一个曾经<del>其实现在还是</del>中二过的<del>怪叔叔</del>少年, 怎么能没有黑历史呢!</p><!-- 摘要部分 --><span id="more"></span><p>前天Google自己ID的时候, 猛然想起自己曾经是用过网易LOFTER和蚂蚁笔记发过博客的…<del>网易博客上有前女友的恩怨情仇就让它去吧</del>, 简单看了一下, 内容还不少, 原来我曾经也不是这么的自闭的嘛hhhhhhh. 那么正逢我的个人gitpage, 不如就学学卡婊, 把老料翻出来抄个冷饭好了, 也看看过去的自己是…多么的闲…<del>LOFTER加起来几百条, 我的导师对我真是太仁慈了</del></p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/lofter.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/lofter.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>因为过去的老料基本都是生活向的, 所以就统一丢<code>Daliy</code>好了… 因为是搬运, 所以文的日期会保持当时写的日期, 也就是说这些内容不会在首页前面出现. 然后因为有些短内容没有特别的搬运意义, 就忽略好了…</p><p>以上~</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Daily </tag>
            
            <tag> 博客迁移 </tag>
            
            <tag> 内容搬运 </tag>
            
            <tag> 个人博客 </tag>
            
            <tag> 黑历史 </tag>
            
            <tag> 网易LOFTER </tag>
            
            <tag> 蚂蚁笔记 </tag>
            
            <tag> gitpage </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MultiQC简单使用</title>
      <link href="/2019/07/27/MultiQC%E4%BD%BF%E7%94%A8/"/>
      <url>/2019/07/27/MultiQC%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>MultiQC是一个NGS数据的质控工具, 不过跟很多其他工具不同的一点是, 它本身并直接进行数据获取和指标计算, 而是读入各种常见质控工具的结果文件然后做综合展示.</p><!-- 摘要部分 --><span id="more"></span><p>目前MultiQC支持的工具已经达到了75种, 且支持自行添加更多信息(虽然我还没试过), 支持工具覆盖了碱基读取到变异检测的整个过程, 出具的报告也相当美观, 非常适合用来做最后的数据质量汇总.</p><p>MultiQC的使用很简单, 首先要将其他工具产生的结果文件放到一个统一的路径下, 然后运行<code>MultiQC /path/to/file</code>, MultiQC就会检索文件夹下的各种质控结果, 然后生成最后的汇总报告了, 比如我这里有一份使用MultiQC读取fastqc结果生成的fastq质控报告:</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/multiqc_report.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/multiqc_report.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>可以看见整个报告还是很漂亮的, 在报告顶部会有各个指标的汇总表格, 左侧是各个软件下计算指标的导航栏, 根据不同的软件, 具体的内容可能是展示图或者展示表. 在顶部的汇总表格中, 默认只显示部分指标, 如果想更改选择的指标可以点<code>configure columns</code>来对需要显示的指标进行调整.</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/multiqc_report_config.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/multiqc_report_config.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>然后还有一个比较方便的功能是, 可以点击<code>plot</code>按钮自行选择汇总表中的两个指标做散点图, 这个功能在后续查看一些异常的时候可能会特别有用.</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/multiqc_report_plot.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/multiqc_report_plot.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>简单的介绍就这么多, 更多高级的用法如自定义新的指标和变更样品名称匹配规则以让同一个样品的结果汇聚到一起等等, 之后有了新的成果之后再继续水~</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NGS </tag>
            
            <tag> 质控工具 </tag>
            
            <tag> 生物信息学 </tag>
            
            <tag> 数据分析 </tag>
            
            <tag> MultiQC </tag>
            
            <tag> fastqc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>常见机器学习方法</title>
      <link href="/2019/07/09/%E5%B8%B8%E8%A7%81%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95/"/>
      <url>/2019/07/09/%E5%B8%B8%E8%A7%81%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<p>最近工作需要了解了一下常见的机器学习方法, 顺便水一篇好了…</p><span id="more"></span><ul><li>决策树(Decision Trees): 根据属性构建多层递归二分类路径, 最后将输入对象根据这一系列二分类结果安排在合适的位置<ul><li>优点: 容易理解和解释</li><li>缺点: 缺失数据敏感; 容易过拟合; 不考虑属性的相互关联性(当作独立?)</li></ul></li><li>随机森林算法(Random Forest): 在决策树基础上构建. 首先将训练数据分成多个子集, 每个子集生成一个决策树, 然后输入待分类信息给每一个决策树, 最后以少数服从多数的方式决定最后结果<ul><li>优点: 不容易过拟合, 有很好的抗噪声能力, 对异常点离群点不敏感</li><li>缺点: 解释性差, 容易受多分类属性影响</li></ul></li><li>lasso回归(Lasso regression): 是对一般线性回归的改良, 通过对系数进行惩罚来降低模型复杂度<ul><li>优点: 解释力强, 解决过拟合</li><li>缺点: 惩罚会造成欠拟合</li></ul></li><li>逻辑回归(Logistic regression): 使用逻辑回归得到因变量分类结果与输入自变量概率比值的关系<ul><li>优点: 可解释性强</li><li>缺点: 本质是广义线模, 在一些复杂情况下不适用</li></ul></li><li>支持向量机(SVM): 将平面上的点以一条直线分开,两类中离直线最近的点的距离最大. 将这个问题拓展到多维空间, 就成了支持向量机<ul><li>优点: 适用小样本量, 泛用性好</li><li>缺点: 可解释性质差, 对缺失数据敏感</li></ul></li><li>K最近邻算法(KNN): 将新给的数据放在多维空间中, 里面有已知分类的点, 在与其最近的K的点中, 属于某一类的多, 这个点就属于哪一类<ul><li>优点: KNN理论简单，容易实现</li><li>缺点: 计算量大, 每次分类都重新计算, 受分类不平衡影响大</li></ul></li><li>朴素贝叶斯(Naive Bayes): 是用贝叶斯公式计算处于某类内的概率<ul><li>优点: 实现简单与只需要少量的训练数据, 大量计算时速度快</li><li>缺点: 应用朴素贝叶斯分类器时必须满足条件: 所有的属性都是条件独立的</li></ul></li><li>K均值算法(K-Mean): 聚类算法, 无监督学习; 首先在一堆数据中选K个初始点, 计算所有点与这K个点的距离, 然后将点与K个中最近的那一个归成一类. 在第一轮分类完成后, 根据每一类的点计算一个平均的中心点(K个), 然后再将所有点到这K个中心点的距离计算以便, 并将点归到最近的一类. 如此重复下去. 当重复一定次数后, 分组会固定不动, 此时停止.<ul><li>优点: 异常值不敏感</li><li>缺点: 数据量大时计算量大, 数据量少则效果不好; 易受分类不平衡影响</li></ul></li><li>Adaboost算法: 将多个分类器(多种模型)组合起来, 达到更好的分类效果.<ul><li>优点: 结合多种基本算法, 考虑不同分类器的权重</li><li>缺点: 训练耗时</li></ul></li><li>神经网络(NN): 比较复杂的深度学习(DL)方法, 个人理解神经网络中的神经元类似决策树, 会根据输入数据得到一个分类结果, 然后将这个结果交给下游神经元, 下游神经元接受上游信息后得出结果继续传递, 最后将最后一层的结果汇总起来给出分类结果.<ul><li>优点: 分类准确度高, 鲁棒性和容错性较强</li><li>缺点: 深度学习, 计算量大, 解释性差</li></ul></li><li>马尔可夫链(MarCov Model): 没有看懂…</li></ul><p>主要内容摘自:<br><a href="https://cloud.tencent.com/developer/article/1006091">轻松看懂机器学习十大常用算法</a><br><a href="https://blog.csdn.net/mach_learn/article/details/39501849">机器学习算法优缺点及其应用领域</a></p><p>当然…我写的解释完全不如这个视频讲的简单清楚明白, 果然现在学习要上B站了么…</p><iframe src="//player.bilibili.com/player.html?aid=20922906&cid=34291885&page=1" width="700" height="500" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe><p><a href="https://www.bilibili.com/video/av20922906?t=585">视频出处</a>, 喜欢的话一定去关注一下up然后三连一波哟~</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 逻辑回归 </tag>
            
            <tag> 机器学习 </tag>
            
            <tag> logistic regression </tag>
            
            <tag> machine learning </tag>
            
            <tag> 算法比较 </tag>
            
            <tag> 决策树 </tag>
            
            <tag> 随机森林 </tag>
            
            <tag> 支持向量机 </tag>
            
            <tag> KNN </tag>
            
            <tag> 朴素贝叶斯 </tag>
            
            <tag> K均值 </tag>
            
            <tag> Adaboost </tag>
            
            <tag> 神经网络 </tag>
            
            <tag> algorithm comparison </tag>
            
            <tag> decision tree </tag>
            
            <tag> random forest </tag>
            
            <tag> SVM </tag>
            
            <tag> naive bayes </tag>
            
            <tag> K-means </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用gitbook和mkdocs写文档</title>
      <link href="/2019/07/07/%E4%BD%BF%E7%94%A8Gitbook%E5%92%8Cmkdocs%E5%86%99%E6%96%87%E6%A1%A3/"/>
      <url>/2019/07/07/%E4%BD%BF%E7%94%A8Gitbook%E5%92%8Cmkdocs%E5%86%99%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<p>我的博客是使用hexo生成的, 这是一款基于Node.js的静态博客框架, 他可以帮助像我一样对前端一无所知的人快速搭建一个看上去有模有样的博客, 而我只需要会用markdown写博文就行. 同样, 在开发过程中总会有写技术文档的需要, 因此也就有了gitbook和mkdocs这样的工具.</p><!-- 摘要部分 --><span id="more"></span><p>gitbook和mkdocs的定位其实应该不太一样, gitbook的初衷是让人使用markdown快速写书(也就包括文档), 而mkdocs则是帮助技术人员快速撰写及形成一个可修改性好的文档. 不过到了我这种菜鸡手里…基本的够能都比较类似, 也就没有太大的区别了…</p><h2 id="gitbook"><a href="#gitbook" class="headerlink" title="gitbook"></a>gitbook</h2><p><code>gitbook-cli</code>是基于Node.js的工具, 可通过npm安装: <code>npm install gitbook-cli</code>. 需要注意的是, 由于gitbook项目组方向的调整, 这个命令行工具已经不再更新了. 不过基本的功能也差不多了, 继续用似乎也没啥问题…</p><p>安装完成之后就可以使用<code>gitbook</code>命令创建和编写文档, 创建命令是<code>gitbook init</code>, 目录下会产生<code>README.md</code>和<code>SUMMARY.md</code>两个文件, 其中<code>SUMMARY.md</code>是整个文档的目录文件兼结构文件, <code>gitbook-cli</code>会根据这个文件的内容生成最后的文档. <code>SUMMARY.md</code>本身也是个markdown文件:</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 第一章</span></span><br><span class="line"><span class="bullet">*</span> [<span class="string">文档说明</span>](<span class="link">README.md</span>)</span><br><span class="line"><span class="bullet">*</span> [<span class="string">第一部分</span>](<span class="link">Part1/README.md</span>)</span><br><span class="line"><span class="bullet">    *</span> [<span class="string">内容1</span>](<span class="link">Part1/content1.md</span>)</span><br><span class="line"><span class="bullet">        *</span> [<span class="string">内容小标题</span>](<span class="link">Part1/content1.md</span>)</span><br><span class="line"><span class="section"># 第二章</span></span><br><span class="line"><span class="bullet">*</span> [<span class="string">XXXX</span>](<span class="link">NNNN.md</span>)</span><br></pre></td></tr></table></figure><p>首先书的章节由一级标题的语法(<code>#</code>)控制, 不同章节的内容在目录树里会用分隔线分开, 如果开启自动序号的话, 不同章节的小序号也会不一样. </p><p>章节里面以无序列表的形式保存目录结构, 每一级列表项目都使用链接的语法(<code>[]()</code>)链接到具体的markdown文件. 具体的markdown文件内可以以一级标题作为锚点. 目前实测只有一级标题有锚点的作用, 如果想要锚定二级标题或其他内容则要手动添加html tag作为锚点.</p><p>gitbook支持所有的基本markdown语法, 同时也支持html, 因此如果需要在文档中加入比较复杂的表格, 可以写成html的格式的然后直接贴入.</p><p>基本上知道这些就能够写书了. 如果对文档的表现或者使用的插件有要求, 可以自行建立<code>book.json</code>配置文件, 在其中按格式填写配置信息, 即可在生成书籍的时候作调整.</p><p>书籍在写作完成后可以使用<code>gitbook serve</code>开启本地的书籍预览, 默认端口<code>8000</code>. 预览服务可以一直保持开启, 对markdown源文件进行的修改会实时反映在预览网页内(可能需要刷新). 当然如果确定写的书没有问题, 可以直接使用<code>gitbook build</code>, 创建好的html书籍会保存在<code>_book/</code>内.</p><h2 id="mkdocs"><a href="#mkdocs" class="headerlink" title="mkdocs"></a>mkdocs</h2><p><code>mkdocs</code>是基于python的工具, 使用<code>pip</code>或者<code>conda</code>都可以方便的安装. 安装完后<code>mkdocs</code>命令即可使用, 创建文档的命令是<code>mkdocs new proj_name</code>, 运行后会在名为<code>proj_name/</code>的文件夹内建立<code>mkdocs.yml</code>文件和<code>docs/</code>文件夹. 其中<code>mkdocs.yml</code>是配置文件兼目录结构文件, 采用<code>yaml</code>格式进行记录. 文件大概是这样:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">site_name:</span> <span class="string">&quot;我的文档&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">目录:</span> <span class="string">index.md</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">第一章:</span> <span class="string">chapter1.md</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">第二章:</span> <span class="string">chapter2.md</span></span><br><span class="line"></span><br><span class="line"><span class="attr">theme:</span> <span class="string">readthedocs</span></span><br></pre></td></tr></table></figure><p>mkdocs形成的目录基本等同于常见的markdown TOC, 不需要像gitbook一样去做额外的锚点设置. 然后由于我这次使用mkdocs写的文件比较简单, 对于其更多的功能没有涉及.</p><p>编写完成的文档可以通过<code>mkdocs serve</code>预览, 同样会根据markdown源文件实时更新. 也可以通过<code>mkdocs build</code>直接构建, 构建结果会在<code>site/</code>目录中.</p><h2 id="两款工具的比较"><a href="#两款工具的比较" class="headerlink" title="两款工具的比较"></a>两款工具的比较</h2><p>我这次整理离职文档的过程中两个工具都使用过一次, 也有一些对比使用的体会. </p><p>首先从基本功能上, 两个工具对我来说几乎没有区别, 都是用markdown写文档, 然后基本命令都很简单易用, 都可以本地浏览. 不过gitbook-cli毕竟是不更新了, 之后会不会出什么问题我也不知道.</p><p>然后从扩展性上来说呢…其实两者也差不多, 都有很多作者在给两个工具写插件. 不过有一点值得注意的是, gitbook似乎没什么第三方主题? 我搜了很多次也没有能够拿来直接用的主题, 而mkdocs内置的就有好几个了.</p><p>另外由于本次的是工作交接用的文档, 我的同事其实不太习惯看html的, 因此两个工具的第三方pdf导出插件我都用了…怎么说呢…能用…但是确实不是那么好用吧…跟html的效果比起来两个的pdf都显得比较砢碜了…不过硬要说的话mkdocs的稍微好一些.</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文档工具 </tag>
            
            <tag> 技术写作 </tag>
            
            <tag> gitbook </tag>
            
            <tag> mkdocs </tag>
            
            <tag> markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash小技巧两则</title>
      <link href="/2019/06/05/Bash%E5%B0%8F%E6%8A%80%E5%B7%A7%E4%B8%A4%E5%88%99/"/>
      <url>/2019/06/05/Bash%E5%B0%8F%E6%8A%80%E5%B7%A7%E4%B8%A4%E5%88%99/</url>
      
        <content type="html"><![CDATA[<p>使用Bash串联各个程序的过程中总是能发现一些神奇好用的技巧, 这里记录两个.</p><!-- 摘要部分 --><span id="more"></span><p>第一则是我前些时候尝试使用sambamba取代samtools的时候发现的, sambamba是用来取代samtools处理bam文件的一个工具, 其很多命令都跟samtools非常接近, 但是当时有一个子命令却不支持标准输出, 导致要先生成中间文件然后再读取中间文件进行下一步, 非常浪费IO资源, 所以我搜索了一下有没啥好的解决方案. 不搜不知道, 一搜才知道, 原来Linux下面是有三个特殊文件的, 分别是<code>/dev/stdin</code>, <code>/dev/stdout</code>, <code>/dev/null</code>, 分别对应标准输入, 标准输出和丢弃. 对于没有明确说明支持标准输入&#x2F;输出的程序, 可以尝试将输入&#x2F;输出文件替换为上述特殊文件, 这样就能实现从标准输入读取内容或者将接过输出到标准输出了:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sambamba merge -t 4 /dev/stdout input1.bam input2.bam \</span><br><span class="line">| sambamba <span class="built_in">sort</span> -o /dev/stdout /dev/stdin \</span><br><span class="line">| samtools view -Sb -f 30 \</span><br><span class="line">&gt; output.srt.flt.bam</span><br></pre></td></tr></table></figure><p><code>/dev/null</code>同样很有用, 比如<code>samblaster</code>, 默认只支持<code>-o</code>, 也就是主接过输出到标准输出, 但是我其实需要<code>-s</code>或者<code>-u</code>的接过, 并且我需要对这些接过做另外的处理, 那么就可以使用<code>/dev/null</code>将主要结果丢弃, 然后将需要的结果输出到<code>/dev/stdout</code>然后继续后续操作即可:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">samtools view -h \</span><br><span class="line">| samblaster \</span><br><span class="line">    --ignoreUnmated \</span><br><span class="line">    -o /dev/null \</span><br><span class="line">    -d /dev/null \</span><br><span class="line">    -s /dev/null \</span><br><span class="line">    -u /dev/stdout \</span><br><span class="line">| sed <span class="string">&quot;s/_[0-9]//g&quot;</span> \</span><br><span class="line">| /soft/bwa-0.7.15/bin/bwa mem \</span><br><span class="line">    -t 30 -k 32 -M -R <span class="string">&quot;@RG\tID:<span class="variable">$&#123;sam_id&#125;</span>\tLB:<span class="variable">$&#123;sam_id&#125;</span>\tSM:<span class="variable">$&#123;sam_id&#125;</span>\tPL:ILLUMINA&quot;</span> \</span><br><span class="line">    /resource/GV/ref_genome/hg38/bwa-0.7.15/hg38.fa /dev/stdin \</span><br><span class="line">| samtools view -Sb -f 256 \</span><br><span class="line">| samtools merge -f output.bam input.bam /dev/stdin</span><br></pre></td></tr></table></figure><p>另外一个技巧是将命令结果伪装成文件进行输入. 比如我现在有多个两列的文件, 一列是数据标题, 一列是数据值. 我现在需要把多个文件合并成一个, 同时还想保留第一列的标题, 那么就可以:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">paste</span> file1 \</span><br><span class="line">    &lt;(<span class="built_in">cut</span> -f 2 file2) \</span><br><span class="line">    &lt;(<span class="built_in">cut</span> -f 2 file3) \</span><br><span class="line">    &lt;(<span class="built_in">cut</span> -f 2 file4) \</span><br><span class="line">    &gt; pasted_file</span><br></pre></td></tr></table></figure><p>在上面的操作中, <code>file&#123;2..4&#125;</code>的数据被<code>cut -f 2</code>截取出来, 然后伪装成文件, 输入给了<code>paste</code>命令, 这样避免了使用中间文件, 更加快捷高效.</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Bash </tag>
            
            <tag> 命令行 </tag>
            
            <tag> 输入输出重定向 </tag>
            
            <tag> 进程替换 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>用Go语言重写我的项目</title>
      <link href="/2019/06/02/%E7%94%A8Go%E8%AF%AD%E8%A8%80%E9%87%8D%E5%86%99%E6%88%91%E7%9A%84%E9%A1%B9%E7%9B%AE/"/>
      <url>/2019/06/02/%E7%94%A8Go%E8%AF%AD%E8%A8%80%E9%87%8D%E5%86%99%E6%88%91%E7%9A%84%E9%A1%B9%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<p>为了学习Go语言, 我把之前工作中一个用的比较多的脚本用Go重写了. 所谓没有对比就没有伤害, 实际写下来的感受是, Python真的简单快捷易懂…好用的第三方模块多…中英文的学习资料更是非常容易找. 要不是为了性能…我真是不想换…</p><!-- 摘要部分 --><span id="more"></span><h2 id="一只Python菜鸡眼里的Go"><a href="#一只Python菜鸡眼里的Go" class="headerlink" title="一只Python菜鸡眼里的Go"></a>一只Python菜鸡眼里的Go</h2><p>由于我之前比较大一点的程序都是Python和R写的, 均不属于强类型语言, 对变量的声明和使用的都比较灵活, 所以开发的主要难度集中在第三方模块的使用和处理自己设计中的逻辑bug上.</p><p>Go就不一样了…它是一种强类型的语言, 变量要先声明再使用, 且一旦声明, 后面不可再更改类型, 这在我前期开始上手的时候着实让我难受了好久…</p><p>虽然Go为了一定程度上增加易用性设计了接口这个灵活的类型, 但我毕竟是菜鸡出身, 在Python R Bash内都没有类似概念的情况下…明白这到底是个什么东西着实花了我不少时间.</p><p>在解决了基本的变量使用后, 还有错误处理的方式不同, 第三方模块较少以及缺少Magic写法等种种问题要一点一点解决… 最终导致这个改写拖了整整两个星期才初步完成…</p><p>虽然困难不少, 但是只要体验过它的速度, 相信很多人会和我一样激动异常(虽然本次我重写的时候顺带着对算法也做了优化, 但是那点优化是绝对不足以带来200倍的差距)</p><p>嘛, 世界变化这么快, 多学一样东西总是不会错的~</p><p>附上这个重写项目的地址: <a href="https://github.com/SilenWang/FUEX">FUEX</a></p><h2 id="以Python为参照快速上手Go"><a href="#以Python为参照快速上手Go" class="headerlink" title="以Python为参照快速上手Go"></a>以Python为参照快速上手Go</h2><p>就像我学英语的时候总是扰不开从中文的角度进行思考, 我写这个练习项目的时候总是不可避免的想要按照Python里面的方式是来进行代码实现. 但是Python和Go毕竟是两种差异很大的语言, 一些Python里用到的东西在Go里只有类似物, 甚至是连类似物都没有, 这里就总结一下本次开发中涉及到的一些替代实现方案.</p><h3 id="变量-数据类型"><a href="#变量-数据类型" class="headerlink" title="变量&#x2F;数据类型"></a>变量&#x2F;数据类型</h3><h4 id="变量声明及初始化"><a href="#变量声明及初始化" class="headerlink" title="变量声明及初始化"></a>变量声明及初始化</h4><p>在Python中没有单独的变量声明及初始化的步骤, 想使用的话直接<code>var=value</code>就可以使用, 并且变量的类型可以在后续处理中进行变更. 比如:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var1 = <span class="literal">True</span></span><br><span class="line">var2 = <span class="number">1</span></span><br><span class="line">var1 = var2 <span class="keyword">if</span> var2 <span class="keyword">else</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>在上面的代码中, var1和var2在赋值的过程中会被自动赋予变量类型(boolean, int), 且两者虽然类型不同, 仍然可以把var2的值传递给var1, 在传递完成后var1会从boolean变成int.</p><p>而Go中, 一个变量首先要被声明才能使用, 且一个变量声明后类型固定, 是无法把<code>var2</code>内的数值赋给<code>var1</code>的</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Var var1 <span class="type">bool</span> <span class="comment">// 变量声明</span></span><br><span class="line">Var var2 <span class="type">int</span>  <span class="comment">// 变量声明</span></span><br><span class="line">var1 = True</span><br><span class="line">var2 = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>当然, 所有变量都要这么些的话确实有点麻烦, Go针对这个给出了简单的写法:<code>var1 := 1</code>, 这种写法在创建变量的同时给变量赋值, 同时变量的类型会自动指定. 不过由于是自动指定的, 如果对类型有什么特殊的需求, 可能还是自己声明比较好.</p><h4 id="Go是强类型的语言"><a href="#Go是强类型的语言" class="headerlink" title="Go是强类型的语言"></a>Go是强类型的语言</h4><p>所谓强类型, 就是对变量的类型有细致的分类, 并且在程序执行过程中对传递和使用的变量类型作严格的限制(个人理解). 比如在Python中, 变量的类型也就数字, 字符串, 逻辑和空(<code>None</code>), 复杂一点的也就只有数字, 因为下面还分为了浮点数和整数. 甚至, Python中连常量都砍掉了, 只有变量, 只是在语言编写建议中推荐使用全大写字母来提示常量(实际上值是可以被更改的).</p><p>Go就不同了…首先是分了常量(<code>Const</code>)和变量(<code>Var</code>)的, 而在变量中, 虽然也是有整数, 浮点数, 逻辑这几类, 但是整数和浮点数下面又细分了不同长度, 比如什么<code>int16</code>, <code>int32</code>, <code>int64</code>, 甚至还有我目前不是很明白的<code>uint</code>…这些变量类型在使用过程中如上一点中所说一样, 是不会自动转换的, 也就是如果某个函数给了你<code>int16</code>, 下一个函数要的是<code>int64</code>, 还得自己手动转换一次…这些类型的转换对我一个习惯了Python的人来说真的非常难受. </p><p>另外需要注意的一点是, Go的字符(<code>byte</code>)和字符串(<code>string</code>)也是两个不同的类型, 字符固定使用单引号(‘), 字符串则固定使用双引号(“).</p><h4 id="复杂数据类型—-数组-切片-集合-结构体"><a href="#复杂数据类型—-数组-切片-集合-结构体" class="headerlink" title="复杂数据类型—-数组&#x2F;切片&#x2F;集合&#x2F;结构体"></a>复杂数据类型—-数组&#x2F;切片&#x2F;集合&#x2F;结构体</h4><p>就像Python有Tuple, List, Dict, Set等存储多个元素&#x2F;映射的数据类型, Go中也有数据类型满足数据存储和处理需要:</p><p>数组(Array): 数组类似于List或Turple, 单又与它们都不同. 首先Go中数组的长度是固定的, 一单声明即不可更改. 同时, 虽然数组内存储内容是可变的, 但存储物的类型必须是固定的.</p><p>切片(Slice)基本跟数组差不多, 但是其长度是可变的.</p><p>集合(Map)相当于Dict, 同样其Key和Value的类型是固定不可变更的. Map的Key可使用的类型比较丰富, 只要能进行逻辑比较<code>==</code>操作的都可以. 这一点倒是跟Dict的Key只要能Hash化就行非常类似</p><p>最后也是我的项目中最需要的就是结构体了. 它比较类似R中的list或者Python中的嵌套Dict, 其中能存储各式各样的信息.</p><h4 id="强类型下的灵活处理—-接口-interface"><a href="#强类型下的灵活处理—-接口-interface" class="headerlink" title="强类型下的灵活处理—-接口(interface)"></a>强类型下的灵活处理—-接口(interface)</h4><p>接口是我在接触Go时接触到的一个全新概念, 它与我之前听过的API其实是很不一样的东西, 我查了好半天才对它有了一丢丢的了解…这里也记录一下.</p><p>首先根据上一节的内容, 我们知道Go是强类型的. 这个强类型贯穿了整个语言体系, 会在某些时候导致一些不必要的麻烦. 比如我们在写函数的时候, 要定义函数的接收和返回变量, 输入和返回变量是要给定类型的. 而一旦类型确定了, 函数就智能接收&#x2F;这个类型的变量, 不可以更改. 这就很蛋疼了, 我们写程序的时候, 多少都会有一些函数是要接收一些情况不明的对象, 然后根据对象的情况进行判断后做下一步处理的. 但是强类型的规则规定了接收的东西类型要确定, 这就逼着人写两个重复性很高的函数来接收不同类型的对象然后做类似的处理.</p><p>举一个实际的例子, <code>vcfgo</code>中的<code>Info().Get()</code>函数. 这个函数的作用是将vcf文件中INFO列的对应信息取出然后返回. 每一个INFO项目下可能会有多个值, 如果只有一个值, 则返回对应的字符串, 如果有多个, 则将他们放入一个以字符串为元素的列表返回. 这个看上去很简单, 但是在强类型的规则下是不能直接实现的. 因为在定义函数时, 就必须定义好返回变量的类型. 一个变量的类型如果定义成了字符串, 那它就不能存储字符串列表, 反之毅然. 那为了实现目标功能, 难道要让函数多一个返回值吗? 这种时候就是<code>interface</code>发挥作用的时候了. <code>interface</code>的定义是, 只要一个对象实现了<code>interface</code>中定义的方法, 那它就实现了这个接口, 可以被以这个类型的接口的方式传递. 回到刚才那个问题, 只要定义一个接口, 然后让要返回的东西都实现这个接口, 就可以将他们以接口的方式返回了.</p><p>最后需要注意的是, 由于返回的是接口, 所以他们的类型都是<code>interface</code>, 如果你需要进一步传递他们, 可能还需要用断言的方式将他们从接口中取出成为原来的类型. 比如我的项目里面就有这么一句:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> annObj, ok := anns.(<span class="type">string</span>); ok &#123; <span class="comment">// 单个注释, 直接解析</span></span><br><span class="line">annTarget = annObj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这句话中的ann就是<code>Info().Get()</code>函数返回给我的接口, 这个接口里可能是字符串, 也可能是一个字符串列表, 而我就使用<code>anns.(string)</code>尝试断言它里面是字符串, 如果断言正确, 则直接将取出的字符串赋值, 如果错误, 则进行另一种处理</p><h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><p>Python中的文件读写非常简单, 一条语句打开文件, 获得的对象是可迭代的, 直接<code>for</code>循环就可以对文件按行处理了. 写文件同理, 也是几条语句就能搞定. 同时Python还有<code>with</code>语句可以在操作完成后自动关闭文件句柄, 可谓非常方便了.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;file&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        <span class="built_in">print</span>(line)</span><br></pre></td></tr></table></figure><p>相比之下Go在读写就麻烦了很多, 比如我想按行读取文件内容并打印的话: </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">file, err := os.Open(vcfFile)</span><br><span class="line"><span class="keyword">defer</span> file.Close() <span class="comment">// 自动关闭文件文件, 相当于用python里用with</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">reader := bufio.NewReader(file)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">str, err := reader.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(str)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面步骤主要是先打开一个文件, 然后使用另外一个函数指定以<code>&#39;\n&#39;</code>作为分隔读取一行的内容, 然后将读到的内容打印到屏幕. 其实说来核心的东西可能跟Python差不多, 但是有些东西变成了自己处理, 代码自然就多了. 比如打开文件后的异常处理, Python如果读不到文件, 会自动抛出异常, 告诉你文件不存在, 所以退出. 而写Go则要自己手动<code>panic</code>, 把<code>err</code>中的错误显示出来进行提示并终止程序. Python中使用<code>for</code>便利打开的文件对象即可按行读取文件, 并且会在达到文件末时自动终止. 而Go中这个过程是自己手动写出来的, 甚至文件按<code>&#39;\n&#39;</code>分行都是自己指定的.</p><p>写文件的情况与读文件类似, 然后Go的写文件比读还要复杂一点, 这里先挖坑, 后面填.</p><h3 id="嵌套数据结构"><a href="#嵌套数据结构" class="headerlink" title="嵌套数据结构"></a>嵌套数据结构</h3><p>Python中常用的数据结构之间可以进行相互嵌套, 形成复杂的数据结构以满足实际的数据处理需要. 这种嵌套的数据结构非常自由, 因为dict&#x2F;list&#x2F;tuple&#x2F;set对其中存放的东西没有特别的限制, 所以我们可以轻松的把一系列不同的东西组成一个整理. 这是我在某些数据处理时喜欢用Python而不是R的原因之一(R的一些数据结构内部存同类的东西). 以我这个项目里存储的refGene文件信息为例. 我的程序需要从数据库文件中读取出一个基因的转录本号码, 外显子起止位点, 转录方向, 基因名称等等一系列信息. 其中转录本号码是一个字符串, 外显子起止点里存储的是一个列表的整数, 转录方向是单个字符, 基因名称则又是字符串. 这一系列信息我都可以以<code>Key: Value</code>的形式存储在一个大字典中, 需要的时候根据Key来获取对应的值就可以了.</p><p>这在Go中是不可能的, 因为<code>list</code>对应的数组, <code>dict</code>对应的集合, 在Go中都是只能存储声明好的东西的:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">outStrList := []<span class="type">string</span>&#123;<span class="string">&quot;out1&quot;</span>, <span class="string">&quot;out2&quot;</span>&#125; <span class="comment">// 只能存string</span></span><br><span class="line">gene2tran := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>) <span class="comment">// Key和Value都必须是string</span></span><br></pre></td></tr></table></figure><p>因此要做到类似Python里面那种不同类型数据的嵌套, 就智能使用结构体<code>struct</code>了:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 我代码里面定义的存储转录本信息的结构体</span></span><br><span class="line"><span class="keyword">type</span> geneRecord <span class="keyword">struct</span> &#123;</span><br><span class="line">exon        [][]<span class="type">int64</span></span><br><span class="line">intron      [][]<span class="type">int64</span></span><br><span class="line">transRegion [<span class="number">2</span>]<span class="type">int64</span></span><br><span class="line">cdsRegion   [<span class="number">2</span>]<span class="type">int64</span></span><br><span class="line">chr         <span class="type">string</span></span><br><span class="line">strand      <span class="type">string</span></span><br><span class="line">geneSymbol  <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line">tran2info := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]geneRecord) <span class="comment">// map 套结构体</span></span><br></pre></td></tr></table></figure><h3 id="控制结构"><a href="#控制结构" class="headerlink" title="控制结构"></a>控制结构</h3><p>Go中的控制结构甚至比Python还简单…判断用的<code>if/else</code>, 循环用的<code>for</code>, 多分支结构的<code>switch</code>——就只有这些了.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if else 和 for 举例</span></span><br><span class="line"><span class="keyword">if</span> cols[<span class="number">3</span>] == <span class="string">&quot;+&quot;</span> &#123;</span><br><span class="line"><span class="keyword">for</span> idx, _ := <span class="keyword">range</span> exonStarts &#123;</span><br><span class="line">exons = <span class="built_in">append</span>(exons, []<span class="type">int64</span>&#123;exonStarts[idx], exonEnds[idx], exonFrames[idx]&#125;)</span><br><span class="line"><span class="keyword">if</span> idx != <span class="built_in">len</span>(exonStarts)<span class="number">-1</span> &#123;</span><br><span class="line">introns = <span class="built_in">append</span>(introns, []<span class="type">int64</span>&#123;exonEnds[idx], exonStarts[idx+<span class="number">1</span>]&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">for</span> idx, _ := <span class="keyword">range</span> exonStarts &#123;</span><br><span class="line">exons = reverSlice(<span class="built_in">append</span>(exons, []<span class="type">int64</span>&#123;exonStarts[idx], exonEnds[idx], exonFrames[idx]&#125;))</span><br><span class="line"><span class="keyword">if</span> idx != <span class="built_in">len</span>(exonStarts)<span class="number">-1</span> &#123;</span><br><span class="line">introns = reverSlice(<span class="built_in">append</span>(introns, []<span class="type">int64</span>&#123;exonEnds[idx], exonStarts[idx+<span class="number">1</span>]&#125;))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// switch举例</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> AinA &amp;&amp; BinB: <span class="comment">// 目标fusion, 对应正确</span></span><br><span class="line">locates[<span class="string">&quot;breakA&quot;</span>] = locAinA</span><br><span class="line">locates[<span class="string">&quot;breakB&quot;</span>] = locBinB</span><br><span class="line"><span class="keyword">return</span> locates, <span class="string">&quot;right&quot;</span>, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> AinB &amp;&amp; BinA: <span class="comment">// 目标fusion, 对应颠倒</span></span><br><span class="line">locates[<span class="string">&quot;breakA&quot;</span>] = locAinB</span><br><span class="line">locates[<span class="string">&quot;breakB&quot;</span>] = locBinA</span><br><span class="line"><span class="keyword">return</span> locates, <span class="string">&quot;wrong&quot;</span>, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">err := errors.New(<span class="string">&quot;Not Fusion&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然东西是比较少, 但也够用了…</p><p>另外Go除了<code>break</code>和<code>continue</code>之外, 还提供了<code>goto</code>这种跳转性的控制语句. 不过我暂时没有使用过…</p><h3 id="构建函数"><a href="#构建函数" class="headerlink" title="构建函数"></a>构建函数</h3><p>Go中创建函数没有啥特别的…就是注意输入参数和返回值的类型要先声明好(下面例子中, <code>reverSlice</code>后面跟的是传入的参数, 括号外面的是返回值的声明), 声明好就不能变了. 如果需要灵活的输入和返回, 需要靠<code>interface</code>了</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reverSlice</span><span class="params">(a [][]<span class="type">int64</span>)</span></span> [][]<span class="type">int64</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="built_in">len</span>(a)/<span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">opp := <span class="built_in">len</span>(a) - <span class="number">1</span> - i</span><br><span class="line">a[i], a[opp] = a[opp], a[i]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>本质上来说, Go里面没有Python中那样专门的错误处理, 或者说, 并没有专门的异常抛出这一操作. 但是在使用Go的时候会发现, 很多函数的返回值会有两个, 比如打开文件的函数:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file, err := os.Open(yourFile)</span><br></pre></td></tr></table></figure><p>上面的文件打开函数除了返回打开的文件对象, 还会返回另外一个变量, 这个变量我个人理解为类似Shell执行命令后状态码一样的东西, 一般情况下, 函数内程序执行正常的话, 这个变量会是<code>nil</code>. 而一旦函数内的部分执行出错, 返回的就会是一个<code>error</code>类的对象, 对象里包含了错误的说明字符. 对这个变量进行处理, 也就等同于在Python里面用<code>Try: Except:</code>了</p><h3 id="字符处理"><a href="#字符处理" class="headerlink" title="字符处理"></a>字符处理</h3><p>Go的字符串处理基本依赖<code>strings</code>包, 包内基本的连接, 拆分, 替换, 前后去空白都有…实际使用感受类似于R中的<code>stringr</code>…就是东西都有…但是总觉得没那么好用.</p><p>另外Python中的格式化字符串在Go内暂时没有对等物. 所以无法像Python内弄一个硕大的文本模板然后填充内容.</p><h3 id="JSON处理"><a href="#JSON处理" class="headerlink" title="JSON处理"></a>JSON处理</h3><p>Go也有专门的<code>json</code>包来读取json文件内容形成Go的数据结构, 和将Go对象转化为json字串. 不过可能还是类型限制大, 实际用起来比Python还是复杂一点…</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tarTranFile := <span class="string">&quot;RXA_gene_trans.json&quot;</span></span><br><span class="line">data, err := ioutil.ReadFile(tarTranFile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> targetTransFile <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">err = json.Unmarshal(data, &amp;targetTransFile)</span><br><span class="line">targetTrans := targetTransFile.(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br></pre></td></tr></table></figure><p>可以看到我为了读取写好的json文件, 执行了打开文件, 载入内容, 将内容用特定函数处理, 然后因为返回的是<code>interface</code>, 所以最后又进行了类型断言.</p><p>类似的操作…在python中1~2行就可以完成了…</p><h3 id="程序编译"><a href="#程序编译" class="headerlink" title="程序编译"></a>程序编译</h3><p>与Python这种边翻译边执行的语言不同, Go语言是要先编译后使用的(虽然也有<code>go run</code>), 所以还要研究一下编译可执行文件的问题.<br>(挖坑占位)</p><h3 id="Python与Go的独有物"><a href="#Python与Go的独有物" class="headerlink" title="Python与Go的独有物"></a>Python与Go的独有物</h3><p>这一部分记录Python和Go各自独有的一些东西(挖坑占位).</p><h4 id="Python部分"><a href="#Python部分" class="headerlink" title="Python部分"></a>Python部分</h4><ul><li>列表&#x2F;字典生成式: 在Python中生成式是非常方便的可迭代对象生成&#x2F;处理方式, 可以有效的简化代码(效率有没提升我不太清楚), 然而Go里就智能乖乖写循环了.</li><li>字符串格式化: Python内的字符串格式化的好处就在于将常常的一段文本挖空后依次填充, 这种写法代码的可读性非常好. 可以一目了然的知道最后出现的字符串是个怎样的框架. 而Go中就只能自己拼接了.</li></ul><h4 id="Go部分"><a href="#Go部分" class="headerlink" title="Go部分"></a>Go部分</h4><ul><li>接口(见上)</li><li><code>switch</code>控制结构</li><li>方便的并行化: Python虽然多线程, 多进程, 协程都有…但确实是没那么高效或者好用…这也是促使我学Go的一个原因了.</li></ul>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 性能优化 </tag>
            
            <tag> golang </tag>
            
            <tag> Go语言 </tag>
            
            <tag> 编程语言对比 </tag>
            
            <tag> 项目重构 </tag>
            
            <tag> programming </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Caddy设置https</title>
      <link href="/2019/05/07/https%E9%85%8D%E7%BD%AE/"/>
      <url>/2019/05/07/https%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>之前自建了一个gogs, 但是并没有弄https, 直接用的http, 上次自己试了一下发现截密码太容易了…所以思考了一下…还是弄个域名然后上了https…</p><!-- 摘要部分 --><span id="more"></span><p>首先, 使用https需要申请SSL证书, 然后要申请证书的话, 似乎免费的SSL证书是基本都是要有域名的, 所以我找了最便宜的<a href="#">INVALID POST SLUG PROVIDED www.namesilo.com/‎</a>申请了一个. 域名申请和绑定IP见<a href="https://zhuanlan.zhihu.com/p/33921436">这个博文</a>.</p><p>有了域名之后下一步就是设置反代理服务器了, 我选择了简单易用的Caddy, 因为我查到的资料都说Caddy设置简单, 易用性完爆Nginx还能自动申请和更新SSL证书. 也许是我脸比较黑…设置虽然很简单完成了, 但是申请SSL证书怎么也用不了. 无奈只有在github上又找了个专门申请SSL证书的项目<a href="https://github.com/Neilpang/acme.sh">acme.sh</a>. 这个脚本使用非常简单, 作者的使用说明也写的详细, 照它说的做就可以. 当然这里也有个<a href="https://www.lizi.tw/soft/5049.html">更傻瓜化的教程</a></p><p>使用<code>acme.sh</code>会生成四个文件, 其中<code>fullchain.cer</code>, <code>your.domain.key</code>就是证书和密钥.</p><p>由于我使用docker部署gogs和caddy, 为了方便把两者都写到一个compose文件里:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;2&quot;</span><br><span class="line">services:</span><br><span class="line">    gogs:</span><br><span class="line">        image: 08fa8ee955da</span><br><span class="line">        container_name: gogs</span><br><span class="line">        restart: always</span><br><span class="line">        ports:</span><br><span class="line">            - &quot;3022:22&quot;</span><br><span class="line">        volumes:</span><br><span class="line">            - /var/gogs:/data</span><br><span class="line">    caddy:</span><br><span class="line">        container_name: caddy</span><br><span class="line">        image: abiosoft/caddy</span><br><span class="line">        environment:</span><br><span class="line">          - ACME_AGREE=true</span><br><span class="line">        volumes:</span><br><span class="line">          - &quot;~/gogs/Caddyfile:/etc/Caddyfile&quot;</span><br><span class="line">          - &quot;/root/.acme.sh/your.domain/fullchain.cer:/root/fullchain.cer&quot;</span><br><span class="line">          - &quot;/root/.acme.sh/your.domain/your.domain.key:/root/your.domain.key&quot;</span><br><span class="line">        ports:</span><br><span class="line">          - &quot;8080:2015&quot;</span><br><span class="line">          - &quot;80:80&quot;</span><br><span class="line">          - &quot;443:443&quot;</span><br><span class="line">        restart: always</span><br></pre></td></tr></table></figure><p>上面文件中配置了两个容器, gogs只暴露22端口用于ssh服务, http的端口不暴露, Caddy可以在配置文件里直接设置访问(虽然我不知道怎么做到的).<br>Caddy的容器则注意设置<code>ACME_AGREE=true</code>这个环境变量的设置, 不然acme会提示不能使用… 再就是要指定Caddy的配置文件<code>Caddyfile</code>和上面生成的证书和密钥了. Caddy容器的端口暴露这里设置的有问题…之后再看怎么改.</p><p>Caddyfile的具体内容如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">your.domain &#123;</span><br><span class="line">    proxy / gogs:3000 &#123;</span><br><span class="line">        header_upstream Host &#123;host&#125;</span><br><span class="line">        header_upstream X-Real-IP &#123;remote&#125;</span><br><span class="line">        header_upstream X-Forwarded-For &#123;remote&#125;</span><br><span class="line">        header_upstream X-Forwarded-Proto &#123;scheme&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    log /var/log/caddy.log</span><br><span class="line">    gzip</span><br><span class="line">    tls /root/fullchain.cer /root/your.domain.key</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTTPS </tag>
            
            <tag> SSL证书 </tag>
            
            <tag> Caddy </tag>
            
            <tag> 反向代理 </tag>
            
            <tag> 域名 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Graphviz的使用</title>
      <link href="/2019/04/25/Graphviz%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
      <url>/2019/04/25/Graphviz%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>进行软件开发时, 不论是为了展示或者是自己梳理需要都会要用到流程图, 如果自己开个绘图板或者word来画呢也不是不可以, 但是如果图一单复杂了, 或者图是不是会需要更改的话, 就很花时间了, 因此一个类似markdown这样可以让人专注与内容而不是形式的工具就非常重要了.</p><span id="more"></span><p>Graphviz是一个脚本化做图的工具, 其可以制作的图形很多, 我目前只使用了流程图. 作流程图需要编写一个<code>.dot</code>格式的文件, 这个文件的形式如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">digraph workflow&#123;</span><br><span class="line">    // 图形的总定义部分</span><br><span class="line">    label = &quot;Workflow For Mutation Call&quot;</span><br><span class="line">    node[shape = box]</span><br><span class="line"></span><br><span class="line">    // 流程图元素的定义部分</span><br><span class="line">    raw [label=&quot;Raw Bam&quot;];</span><br><span class="line">    clean [label=&quot;UMI Dedup Bam&quot;];</span><br><span class="line">    align [label=&quot;Split Bam&quot;];</span><br><span class="line">    vcf [label=&quot;Disc Bam(Prototype)&quot;];</span><br><span class="line"></span><br><span class="line">    // 流程图关系部分</span><br><span class="line">    raw -&gt; clean [label=&quot;fastp&quot;];</span><br><span class="line">    clean -&gt; align [label=&quot;bwa&quot;];</span><br><span class="line">    align -&gt; vcf [label=&quot;GATK Mutect2&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的代码我分成了三个部分:</p><ul><li>第一部分是图形中元素的默认设定, 比如<code>label</code>是图形的标题, <code>node</code>是流程图的各个节点, 我把默认的节点图形设定为方框(默认是圆)</li><li>第二部分是图形中节点的设定, 即定义有哪些节点, 然后在后面的<code>[]</code>中对节点进行自定义, 比如<code>label</code>就可以指定显示的文字</li><li>第三部分是流程图的顺序关系, 比如<code>raw -&gt; clean</code>就从<code>raw</code>到<code>clean</code>画了一个箭头, 同样后面可以用<code>[]</code>自定义</li></ul><p>完成上面代码编写后, 就可以调用<code>graphviz</code>的<code>dot</code>命令生成图片了:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dot -Tpng workflow.dot &gt; workflow.png</span><br></pre></td></tr></table></figure><ul><li><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/workflow.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/workflow.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="完成图形"></li></ul><p>vscode下有相应的插件, Linux上安装插件后就可以边写边预览流程图, 非常方便.</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 流程图 </tag>
            
            <tag> Graphviz </tag>
            
            <tag> 可视化工具 </tag>
            
            <tag> 软件开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux发行版的易用性越来越高了</title>
      <link href="/2019/04/06/Linux%E4%B8%8B%E7%9A%84%E8%BD%AF%E4%BB%B6%E8%B6%8A%E6%9D%A5%E8%B6%8A%E4%B8%B0%E5%AF%8C%E4%BA%86/"/>
      <url>/2019/04/06/Linux%E4%B8%8B%E7%9A%84%E8%BD%AF%E4%BB%B6%E8%B6%8A%E6%9D%A5%E8%B6%8A%E4%B8%B0%E5%AF%8C%E4%BA%86/</url>
      
        <content type="html"><![CDATA[<p>前些天帮师姐弄了一下序列比对, 才发现原来经常用的MEGA出到了X(10), 并且现在有了Linux的GUI版本. 不由得小感叹了一下: 世界真是在慢慢变化的.</p><!-- 摘要部分 --><span id="more"></span><p>记得我第一次装Linux发行版玩是在大三, 当时装的是Ubuntu. 界面和特效都很酷炫, 而且在我的老电脑上也比win来得顺畅的多, 然而界面这种东西很快就会看腻歪, 然后各种头疼的问题跟着就来了: 中文支持不行, 常用软件完全没有, 系统更新容易挂(涉及内核或跨大版本), 小白看的懂的资料几乎没有, 然后就是我至今已经记不起来的各种小问题. 当时深度的发行版还是基于Ubuntu的, 着重于在Ubuntu基础上优化中文用户的使用体验. 于是没半个月我就从Ubuntu换到了Deepin. 然而虽然在中文支持和系统更新上较原版Ubuntu好了很多, 但常用软件的缺失(办公&#x2F;通信)让人几乎不可能在一个大家都用Windows的环境下用这个系统. 于是一两个月之后为了作业和打游戏(其实本质上还是打游戏…)我就弃坑了…</p><p>之后再装回Linux发行版是研一下学期了, 初衷是想少玩游戏好好学习, 因为当时智能手机已经完全普及了, 基本的通信可以用手机, 不是非要用电脑, 而且当时WPS已经有Linux版本了, 基本的写个文档PPT完全没问题(虽然win下播放还是要调格式). 学业相关的东西上, 统计我可以用R, 序列分析我可以用Ugene, 而写脚本这种东西在Linux下远比在Win下容易(Linux一条命令, Win下得安装配置一堆东西), 所以很顺畅的就且到纯Linux环境了.</p><p>之后则是入Arch教的姿势错误入了Manjaro然后再也没出坑, 然后G胖致力推进Linux游戏生态的发展让我第一次体会了被打折支配的恐惧… 至此, 在日常生活中我已经能用Linux发行版作为主役操作系统并且不会出太大问题了.</p><p>当然, 这一方面是因为Linux GUI本身的发展, 另一方面则是其他的因素导致过去的问题不再是问题. 比如上面说的通讯软件, 其实至今也没有解决(微信 QQ 阿里旺旺至今没有原生客户端), 但是由于智能手机的崛起, 很多时候不再需要使用电脑来进行即时通讯了. 另一个例子则是Flash和HTML5, 本来Linux下Flash的支持极差, 然而大陆内有许多网站又恰好非要用这个, 导致过去很多必须要用的网站无法正常使用, 必须在系统里装个虚拟机. 然而Flash最终没落了, 开始全面被HTML5替代…</p><p>希望在我有生之年的某一天, Windows的市场份额真的会发生动摇, 我们可以不再被局限在单一的系统平台上</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Steam </tag>
            
            <tag> Ubuntu </tag>
            
            <tag> Deepin </tag>
            
            <tag> Manjaro </tag>
            
            <tag> 中文支持 </tag>
            
            <tag> 软件生态 </tag>
            
            <tag> 跨平台 </tag>
            
            <tag> Windows对比 </tag>
            
            <tag> MEGA </tag>
            
            <tag> WPS </tag>
            
            <tag> R语言 </tag>
            
            <tag> Ugene </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用GNU Parallel在Bash中执行并行</title>
      <link href="/2019/03/31/%E4%BD%BF%E7%94%A8GNU-Parallel%E5%9C%A8Bash%E4%B8%AD%E6%89%A7%E8%A1%8C%E5%B9%B6%E8%A1%8C/"/>
      <url>/2019/03/31/%E4%BD%BF%E7%94%A8GNU-Parallel%E5%9C%A8Bash%E4%B8%AD%E6%89%A7%E8%A1%8C%E5%B9%B6%E8%A1%8C/</url>
      
        <content type="html"><![CDATA[<p>之前已经在R和Python中都使用过并行了, 我是最近才知道原来Bash下面也有简单好用的并行程序: <em>GNU Parallel</em>[^1]. 这是一个Perl实现的程序, 可以方便的将Bash中各种命令并行执行.</p><!-- 摘要部分 --><span id="more"></span><p>[^1]: <a href="https://doi.org/10.5281/zenodo.1146014">GNU Parallel on Zeondo</a></p><p>由于刚刚上手, 现在暂时只知道一种使用方式, 就是替代For循环, 将并行的命令替换成并行执行, 比如下面写了一个分染色体合并vcf的例子:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> chr <span class="keyword">in</span> &#123;&#123;1..22&#125;,X,Y&#125;;<span class="keyword">do</span></span><br><span class="line">    bcftools view -f PASS -r chr<span class="variable">$&#123;chr&#125;</span> sample.vcf &gt; sample.chr<span class="variable">$&#123;chr&#125;</span>.flt.vcf</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">bcftools merge sample.chr&#123;&#123;1..22&#125;,X,Y&#125;.vcf &gt; sample.flt.vcf</span><br></pre></td></tr></table></figure><p>使用GNU Parallel替代可以是这样子:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> &#123;&#123;1..22&#125;,X,Y&#125; | <span class="built_in">tr</span> <span class="string">&quot; &quot;</span> <span class="string">&quot;\n&quot;</span> | parallel <span class="string">&#x27;bcftools view -f PASS -r chr&#123;&#125; sample.vcf &gt; sample.chr&#123;&#125;.flt.vcf&#x27;</span></span><br><span class="line">bcftools merge sample.chr&#123;&#123;1..22&#125;,X,Y&#125;.vcf &gt; sample.flt.vcf</span><br></pre></td></tr></table></figure><p>上面的会是循环<code>bcftools view</code>然后合并, 下面则是并行执行后再合并. 当然我这个例子没有意义…因为第一种先循环再合并…和直接过滤没有什么区别…</p><p>默认情况下<code>parallel</code>有多少核心就用多少核心, 所以实际使用可能会使用<code>-j</code>指定核心上限或者使用<code>--load 80%</code>指定用80%的核心.</p><p>有了这个东西, 只要使用的工具是支持输入参数定位分析区域的, 都可以快速的将其变成并行执行, 加快分析速度. 这么一来, 用Snakemake写流程舒心了很多…</p><p>关于这个程序的其他用法之后有缘继续更…</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 并行计算 </tag>
            
            <tag> bash </tag>
            
            <tag> GNU Parallel </tag>
            
            <tag> 命令行工具 </tag>
            
            <tag> 性能优化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Lumpy的算法解读</title>
      <link href="/2019/03/31/Lumpy%E7%9A%84%E7%AE%97%E6%B3%95%E8%A7%A3%E8%AF%BB/"/>
      <url>/2019/03/31/Lumpy%E7%9A%84%E7%AE%97%E6%B3%95%E8%A7%A3%E8%AF%BB/</url>
      
        <content type="html"><![CDATA[<p>Lumpy作者对这个项目的定位与其说是做一个好用的工具, 不如说是构建一个通用的结构变异信号生成方案, 然后顺便对这个方案做了一个基本的实现. 与其他工具相比, lumpy的文章中花了更多的篇幅去阐述这个方案中设定的证据概念, 及获取信息的方案. 解读这个工具让我更加了解如何从NGS测序数据中获取结构变异的信号.</p><!-- 摘要部分 --><span id="more"></span><h2 id="工具基本情况"><a href="#工具基本情况" class="headerlink" title="工具基本情况"></a>工具基本情况</h2><p>lumpy使用C++编写, 所有的功能似乎都是自己实现的, 没有引用什么已有的模块. 软件可以从conda上获得, 程序本身近几年似乎没有更新, 所以不需要自己头疼从源码编译的问题.</p><p>软件检测结果格式可在VCF及BEDPE中进行选择. 不过需要注意的是, 两种格式包含的接过信息似乎有差异, VCF的会更详细一些. 另外本工具完全依赖BAM文件中对比对情况的记录, 因此如果比对本身的情况不理想, 必然影响下游结果. 然后, 工具本身不含有任何随机化的成分, 输入的文件一样, 检测结果就会是一模一样的.</p><h2 id="Lumpy中的结构变异模型"><a href="#Lumpy中的结构变异模型" class="headerlink" title="Lumpy中的结构变异模型"></a>Lumpy中的结构变异模型</h2><p>Lumpy首先创建了一种结构变异断点模型: $b &#x3D; (E,l,r,v)$</p><p>在这个模型中, 断点被定义为在待测基因组相邻但是在参考基因组上不相邻的一对基因坐标. 这一对断点通过四个指标进行描述, 分别是:</p><ul><li>$E$: 支持断点的一系列证据集合</li><li>$l$: 左侧断点区间(interval), 包含区间的起止位点s和e(start&#x2F;end)一个向量p, 这个向量p代表区间内每一个点是这个点是真正断点位置的相对概率(relative probability)</li><li>$r$: 与$l$一致, 包含右侧断点的所有信息</li><li>$v$: 断点复杂性(variety)信息, 主要包含不同证据的方向信息. 这个指标的存在是为了保留更多原始信息, 因为当结果被检出时, 只会标注其为某一类结构变异(如deletion), 但是原始的信号中可能包含支持其它类型的证据.</li></ul><p>Lumpy对SR和RP信号都有使用, 每一个信号都能解析出一个断点的实例, 那么在读出所有断点实例后, 就需要根据包含的信息推断是否同一断点, 然后进行断点合并, 合并的条件是:</p><ol><li>两个断点的两侧断点区间<strong>均有重合部分</strong>(阈值不详)</li><li>两个断点的复杂性一致</li></ol><p>在满足上述条件后, 即可将两个断点合并起来, $E$中包含原先的两个信号, $v$不变(本来就一致), $l$和$r$则采取取算术均数(mean)的方式来合并, 即$l$的起点为原来两个起点的算术均数, 终点也是原来两个终点的算术均数, $r$也一样(但是多条时具体如何执行的未知, 两两依次去平均和直接取平均的结果是不一样的):</p><p>$$merge.start &#x3D; \frac{l1.start + l2.start}{2}\ \ merge.end &#x3D; \frac{l1.end + l2.end}{2}$$</p><p>根据作者描述, 这么做是为了减少离群证据对断点区间的影响. 证据合并完之后, 证据数目大于预设阈值的断点会被检测为结构变异. 确定检出的结构变异, 需要根据断点实例里包含的信息来确定, 以下是默认的计算方案:</p><ol><li>断点的可能<strong>区间</strong></li><li>区间内<strong>每个点</strong>是真实断点的<strong>可能性</strong></li></ol><p>首先, 变异的断点可能区间(interval)取断点实例的左侧断点的最大值, 和右侧断点的最小值(即取最小的可能区间). </p><p>而区间内每个点的可能性见下(以左侧断点为例):</p><p>$$l.p[i] &#x3D; \prod_{e{\in}E}e.l.p[i-o]$$</p><ul><li>$i$是某一个基因坐标位置</li><li>$l.p$是单个点是真断点的可能性向量, 前面的$l.$代表是左侧断点的</li><li>$E$是所有证据的集合</li><li>$e$是证据集合里面的每一个证据</li><li>$e.l.p$单个证据里左侧断点的可性向量</li><li>$o$是偏移量(offset value), $o &#x3D; e.l.s - s.l.s$, 即当前证据的左侧断点起点减去预检出的结构变异起点位置.</li></ul><p>$e.l.p[i-o]$这一个略微有点绕, 其实本质跟变异位点的覆盖类似, 最终区间里每一个位置的p是证据里有这个位置的e的p值的积. 所以, 理论上最终区间中的某个点与越多的原始证据区间重合, 这个点的p值就越小, 对应就越可能是真的断点所在位置.</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/BND_Prob.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/BND_Prob.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="BND_Prob"></p><p>在进行证据合并的时候, 由于是不断的取算术均数来却确定合并后的起止点的, 因此有可能最后的起点和止点中间是没有区间的(相等或颠倒?没有实例验证过), 在这种情况下, 作者会在所有的起点区间中, 找到坐标最大的那个坐标, 然后把没有经过这个坐标的区间删掉, 用剩下来的区间重新进行证据合并和区间以及概率向量的确定.(这一部分我不能完全确定, 因此原文贴出)</p><blockquote><p><strong>In the paper, Layer wrote:</strong><br>Given the liberal merge process, it is possible for b.E to contain nonoverlapping distributions that would result in a zerolength product. In this case, we identify the maximum point among the sum of the distributions in b.E, any distribution not intersecting this point is removed, and the resulting subset processed normally.</p></blockquote><p>如此一来, 就形成了最终的结果条目. 最终的结果条目中的断点区间还可以根据预设的百分比, 来进行缩小, 比如只取前99.9%等.</p><p>除了上述的方案, 还有一个<em>Summation</em>方案, 用于低质量数据, 这里暂时不解读.</p><p>从上面的方案可以看出, Lumpy本质上就是从bam里面读取含有信息的比对记录, 从记录抽取需要的信息, 然后根据信息解读结构变异. 那么一个关键的点就是从信号中抽取哪些信息. 为了定义需要的信息, Lumpy设计了一个叫做<code>Breakpoint evidence</code>的接口, 或者说通e用证据类:</p><p>这个接口要求下面3样信息:</p><ol><li>is_bp: 是否含有断点位置信息</li><li>get_v: 结构变异的类型信息</li><li>get_bpi: 断点的可能区间信息</li></ol><p>也就是说, 对于每一个信号&#x2F;证据, 都会解读出上述3样信息, 然后将这些信息做为一个单独的证据e, 加入到证据集E中, 进行之前说的解读过程.</p><p>那么如和从信号&#x2F;证据中解读上述信息呢, 文章分别从SR, RP以及<code>general breakpoint interface</code>三类证据举例:</p><h2 id="RP证据的解读"><a href="#RP证据的解读" class="headerlink" title="RP证据的解读"></a>RP证据的解读</h2><p>在双端测序中, Reads Pair内的插入片段是有一个正常的长度范围的, 且Read1和Read2的比对方向也是应该分别为+&#x2F;-, 任何不正常的比对都提示了断点的存在, 因此解读出的信息如下:</p><ul><li>is_bp: 是, 可以确定断点存在</li><li>get_v: 当两条Read在同一染色体上, 根据Read1和Read2的实际比对方向可推测变异类型(DEL&#x2F;INV&#x2F;DUP), 否则, 将统一为<code>inter-chromosomal</code></li><li>get_bpi: 通过两个Read的比对信息获取最终的断点区间以及区间的p, 有点复杂故见下</li></ul><p>获得断点区间本质上就是根据比对信息从一条read的信息映射出断点的l(包含区间及区间中点的p值), 另一条read映射出r. 以l为例子:</p><ol><li>根据Read的比对方向确定断点是在比对位置的上游还是下游</li><li>在进行判定前, 程序会通过从bam中抽取比对没有问题的Reads Pairs来估算插入片段的分布, 获取插入片段的平均长度$l$和标准偏差$s$(注意是标准偏差Standard Deivation, 非标准差), 另外要求一个人为指定的变量$v$, 以$l + vs$作为正常插入片段的预期数值. 由于打断时不太会出现超出预期的片段, 因此可以推测断点应该就在比对位置上游或下游$l + vs$(bp)长度的范围内, 也就有了断点的区间范围</li><li>对于上述区间内的每个点$i$, 其为真断点的可能性计算方式为$P(S(y).e-S(x).s &gt; i - R(x).s)$(这里的$S()$原文没有明确解释, 我推断是sample的缩写, 与$R()$相对, 代表实际片段上的情况)<ul><li>$y$代表Read2, $x$对应Read1</li><li>$S(y).e$是实际片段上Read2的终止位置, $S(x).s$就是实际片段上Read1的起始位置</li><li>$S(y).e-S(x).s$即为实际片段的长度</li><li>$i-R(x).s$即点$i$距离Read1比对起点的距离</li><li>$P()$应当为从正常比对Reads获得的插入片段长度分布得到出的p值函数, $P(a&gt;b)$的意义类似我们使用正态分布时里面的$P(Z&gt;2.94)$, 使用对应分布的曲线下面积可以获得最后的p值, 从而评估这个位点是真正断点的可能性</li></ul></li></ol><!-- ![补充方向类型推测图]()![补充3中的位置对应示意图]() --><h2 id="SR证据解读"><a href="#SR证据解读" class="headerlink" title="SR证据解读"></a>SR证据解读</h2><p>SR证据中, 一条read的相邻部分会比对到不相邻的基因组位置, 在lumpy中, 如果一条read存在多于两个小片端的比对, 则将这些小片端拆成两两小片段组分别考虑(比如三个片段就分$x_1,x_2$和$x_2,x_3$两组进行考虑), 从每一对小片段中解析出的信息如下:</p><ul><li>is_bp: 是, 可以确定断点存在</li><li>get_v: 当两个片段的比对方向一致, 结构变异可能是DEL或者DUP中的一种(依据比对方向+&#x2F;-不同), 比对方向不一致但在同一染色体上则为INV, 如果比对到不同的染色体则为inter-chromosomal</li><li>get_bpi: 断点的区间位置与推测的结构变异类型有关. 考虑到测序中可能存在的错误, SR证据给出的断点位置也是有范围的, 这个范围大小取决于上述提到的输入参数$v$, 样品的质量(?)以及比对是使用的算法(?). 由于文献中对这部分的描述不如RP部分详细, 所以下面这些是个人的推论, 有空的话需要通过实际测试证实:<ul><li>关于区间的获得: 理想的Split-Read断裂的两部分应该是相互不重叠的, 但是在实际中其实会存在两个部分有重叠的情况. 从lumpy作者自己写的SR Read提取脚本来看, 其确实是允许两个部分有一定长度的重叠的. 所以文中所说的SR证据的断点区间的与样品质量和比对算法有关可能就是指这个.</li><li>关于区间内的p值确定: 由于作者只说了这个区间的中点p值最小, 越靠近两边p值越大, 可能是内部分配了一个比例吧…这个可能需要自己造个证据bam一点一点去试了</li></ul></li></ul><h2 id="general-breakpoint-interface解读"><a href="#general-breakpoint-interface解读" class="headerlink" title="general breakpoint interface解读"></a><code>general breakpoint interface</code>解读</h2><p>这种证据本质上就是记录了确定存在结构变异信息的BEDPE文件, 由于BEDPE文件中原本就会记录双边断点区间和结构变异的类型, 所以将这些信息与get_v, get_bpi对应即可. 关于BEDPE格式因为后面会有专门叙述所以这里略. </p><p>该类证据的存在作用我觉得有两个: 第一是在做遗传相关的分析时, 可以让人群中确定存在的变异更容易检出. 另一方面, 在做多工具同时检出时, 可将其他工具检出的比较可靠的变异接过与Lumpy的结果进行合并.</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 结构变异 </tag>
            
            <tag> 算法解读 </tag>
            
            <tag> NGS数据分析 </tag>
            
            <tag> RP证据 </tag>
            
            <tag> SR证据 </tag>
            
            <tag> Bioinformatics </tag>
            
            <tag> SV检测 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NGS检测结构变异中的基本概念</title>
      <link href="/2019/03/16/%E7%BB%93%E6%9E%84%E5%8F%98%E5%BC%82%E6%A3%80%E6%B5%8B%E5%9F%BA%E6%9C%AC/"/>
      <url>/2019/03/16/%E7%BB%93%E6%9E%84%E5%8F%98%E5%BC%82%E6%A3%80%E6%B5%8B%E5%9F%BA%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<p>“我所知道的结构变异相关信息”这个博客构想的内容有点太多了, 一次写太多我自己回查也不是很方便, 所以还是决定拆成各个小的部分, 之后再用gitbook写个综合的.</p><!-- 摘要部分 --><span id="more"></span><h2 id="结构变异-拷贝数变异-基因融合"><a href="#结构变异-拷贝数变异-基因融合" class="headerlink" title="结构变异&#x2F;拷贝数变异&#x2F;基因融合"></a>结构变异&#x2F;拷贝数变异&#x2F;基因融合</h2><p>结构变异与SNP&#x2F;InDel这两种小范围的基因突变相对, 泛指所有相对大规模的基因变异(具体多少bp以上算, 我暂时也不清楚). 大部分文献中这些变异都称为结构变异( Structural Variation), 这些变异被认为来源于基因组的重组(reorgnization)或称重排(rearrangement)这些变异的大小和样式比较多样了, 有生物课上讲过的整段染色体的交换, 也有单纯的片段缺失, 只是片段相对大而已. </p><p>目前对结构变异更多是按下面的类型来分:</p><ul><li>插入&#x2F;缺失(Insertion&#x2F;Deletion, INS&#x2F;DEL): 本质上就是InDel, 但是片段大</li><li>重复(Duplication, DUP): 代表某个区域连续重复出现, 另外重复下还有一种由’串联重复’(Tandem duplication), 待进一步考证</li><li>倒位(Inversion, INV): 即染色体内某区域的5’端和3’端颠倒过来</li><li>易位(Translocation, ITX, CTX): 即某个区段的转移, 可能是染色体内的转移, 也可能是染色体间的. 易位本身其实是一种复杂的结构变异. 比如染色体内易位, 某个片段从染色体上的A位置整段移动到了B, 那么A位置就会有这个片段的缺失, 而B位置则会有插入. 而如果片段插入的时候不是按原来方向插入的, 则同时也发生了倒位.</li></ul><p>下面这幅图取自<a href="https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=1&cad=rja&uact=8&ved=2ahUKEwjMy7vFzojhAhWwct8KHe9mCM4QFjAAegQIARAC&url=https://theses.lib.sfu.ca/file/thesis/4696&usg=AOvVaw3e8XVzVestWLRfPy1qnkYE">Gawroński的博士论文</a>, 形象的展示了上述结构变异的类型.<br><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/type_of_sv.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/type_of_sv.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="type_of_sv"></p><p>在结构变异的基础之上, 我们就可以进一步的来了解一下拷贝数变异(Copy Number Variation)以及基因融合(Gene Fusion).</p><p>拷贝数变异的关键是拷贝(Copy), 拷贝的概念呢…emmmmmm…这么说吧: 假设<code>ATGCGGTAGCCGTAT</code>是一个基因的完整序列, 我们就把这段序列称作一个拷贝. 然后人是双倍体, 所以正常来说, 一个人应该有两份这个基因, 也就是两个拷贝. 那么当基因检测的时候, 发现一个人的基因组里这个基因的拷贝数不为2, 我们就说检测到了这个基因的拷贝数变异.</p><p>由上面的概念可以看出, 拷贝数变异本质就是结构变异, 或者更确切一点, 是结构变异导致的一种<strong>结果</strong>. 如果基因组发生了缺失, 那么势必会有基因的拷贝数下降. 而重复则很明显会导致拷贝数增加. 那么, 为何拷贝数变异会被单独拿出来呢? 我个人认为, 这可能跟概念的提出时间或者其背后的实际意义有关. 假设每个不同拷贝的基因都具有一样的表达能力, 那么, 基因拷贝数的增加势必会使得基因的表达增加, 而拷贝数减少则会导致基因表达下降甚至相关表达产物消失. 简而言之, 与结构变异侧重于弄清楚基因区段到底发生了怎样的变化, 比如消失的区段从哪到哪开始, 消失的区段有没有去到基因组的某一个位置, 有的话这个位置在哪等具体的信息相比. 拷贝数变异关切的重点在于, 某个基因&#x2F;区段的拷贝数是否变化了. 由于侧重点的不同, 拷贝数变异可以在结构变异检测中一并进行, 也可以单独进行, 当然实际上现在大多数时候是分开用不同策略进行的. 本篇主要还是侧重于结构变异, 所以后面的内容不会专门写拷贝数变异的相关内容.</p><p>与拷贝数变异类似, 基因融合(Gene Fusion)也是结构变异的结果. 比如某个基因区段整段缺失了, 那么区段的上下游必然会连接起来. 如果消失区段的前后两个断点刚好都在两个基因的表达区域内, 那么这两个基因就被连接在了一起, 这就是基因融合. 所以我们可以看出, 所有的结构变异都有可能导致基因的融合, 只是最终融合起来的方式不太一样. 基因融合受到关注由一些疾病&#x2F;癌症的病因确认有关. 比如癌症中的EML4-ALK融合, 慢性粒细胞白血病中的BCR-ABL融合. 由于基因融合关注的是最后是否有基因连在了一起, 以及怎么连接的(这关乎基因表达是上升还是下降了), 所以其在检测的时候也有专门的策略与工具, 详细见后.</p><h2 id="使用NGS数据检测结构变异-基因融合"><a href="#使用NGS数据检测结构变异-基因融合" class="headerlink" title="使用NGS数据检测结构变异&#x2F;基因融合"></a>使用NGS数据检测结构变异&#x2F;基因融合</h2><p>二代基因组重测序的基本原理是把完整的基因序列打碎, 对碎片序列进行测序后将其比对回参考基因组后重组序列的原貌. 在这个比对的过程中会产生一些”不正常”的比对结果, 这些结果中, 有些能提示我们待测基因组相对参考基因组发生了结构变异, 我们的检测也就是基于这些比对结果, 我们将之称为结构变异信号(signal)&#x2F;证据(evidence)</p><h3 id="结构变异检测策略"><a href="#结构变异检测策略" class="headerlink" title="结构变异检测策略"></a>结构变异检测策略</h3><p>结构变异检测的基本策略一般归类为4类, 一类一类来:</p><h4 id="1-Split-Reads"><a href="#1-Split-Reads" class="headerlink" title="1. Split-Reads"></a>1. Split-Reads</h4><p>如果之前有接触过NGS的序列比对文件(SAM&#x2F;BAM), 一定在文件中见过Clip-Reads. 简单来说, 这些序列在比对的时候并不能全长比对到基因组的某个地方, 而是一部分比对到一个地方, 另一部分比对到另外一个地方. 这些序列可能来自于刚好包含了结构变异断点的序列, 因此才会出现这种异常的”<a href="https://github.com/samtools/hts-specs/blob/master/SAMv1.pdf">嵌合比对(Chimeric alignment)</a>“. 通过将这些序列抽取出来, 并对两处Clip序列的比对情况进行回溯, 可以一定程度长推测发生的结构变异类型. 而基于这种信息进行结构变异检测的策略就是SR策略.</p><h4 id="2-Discordant-Read-Pairs"><a href="#2-Discordant-Read-Pairs" class="headerlink" title="2. Discordant Read Pairs"></a>2. Discordant Read Pairs</h4><p>如果采用了双端测序(Pair-End Sequencing), 那么测序结果将是成对出现的. 根据测序原理可知, 双端测序得到的是一个DNA单链5’端和3’端的序列. 由于测序文库制备时, 会将DNA打断到一个固定的范围内, 因此, 正常情况下一对序列的Read1和Read2在基因组上的距离应该是出于一个固定范围内, 并且应该是一条正向比对上参考基因组, 另一条则是反向互补比对. 但是在实际的比对结果中, 总会有一些序列对不符合上述情况, 比如比对距离相去甚远甚至不在同个染色体上, 或者Read1 Read2都正向比对到基因组上等等. 在这种情况下, 这一对序列就称作”Discordant Read Pairs”, 可能由于这种信号来自一对序列, 所以Lumpy中直接称其为”Pair-End Evidence, PE”, 但基于这种信号的检测策略好像更经常被RP(Read Pair)策略(这个需要之后多看一点评测文章确认). 这样的Reads对同样可能来自包含了结构变异断点的序列, 区别则在于断点的位置. 对于Split-Read, 断点位于序列一端, 所以刚好被测出来了. 而对于Discordant Read Pairs, 断点应该在插入片段范围内, 也就是并没有直接体现在测得的序列上.</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/PE_SR_BND_POS.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/PE_SR_BND_POS.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="PE_SR_BND_POS"></p><h4 id="3-Read-Count或者叫Read-Depth"><a href="#3-Read-Count或者叫Read-Depth" class="headerlink" title="3. Read Count或者叫Read Depth"></a>3. Read Count或者叫Read Depth</h4><p>这种策略就如其名字, 是基于特定片段的测序深度的检测方案. 很明显, 这是用来检测拷贝数变异的. 不论发生了何种结构变异, 如果最终导致了某基因的拷贝数减少, 那应该会直观反应到该基因的比对结果上—-该基因区域的测序深度明显下降. 反之, 如果发生了拷贝数增加, 测序深度就应该相应增加才是. 这个策略从原理上说来相当简单, 但是在实际应用的时候并不会必前面的两个策略简单多少. 因为其面临一个说来简单但非常麻烦的问题: 深度高多少算明显高, 低多少算明显少? 这个问题使用外显子或目标区域测序进行拷贝数变异检测时会变得更为复杂.</p><h4 id="4-de-novo-Assembly"><a href="#4-de-novo-Assembly" class="headerlink" title="4. de novo Assembly"></a>4. de novo Assembly</h4><p>这里的de novo Assembly和二代测序中的不依赖参考序列, 从头组装基因组其实是一个意思. 应用在结构变异检测上, 则是在查看SR或者PE信号之前, 先对获取下来的序列进行组装. 因为序列组装后获得更长的片段, 这些使用这些片段再次进行比对会获得比短序列更好的结果. 可以看出这种简称AS的策略不会单独使用, 因为其目的在于获取更长的片段, 重新比对后再按照SR的思路来进行检测.</p><h3 id="关于检测策略的个人思考"><a href="#关于检测策略的个人思考" class="headerlink" title="关于检测策略的个人思考"></a>关于检测策略的个人思考</h3><h4 id="1-测序方案的理论和现实"><a href="#1-测序方案的理论和现实" class="headerlink" title="1. 测序方案的理论和现实"></a>1. 测序方案的理论和现实</h4><p>就象<a href="http://www.huangshujia.me/2018/07/22/2018-07-22-Introduction-the-detection-of-structure-variants.html">黄树嘉老师博文</a>中写的那样, 想获得更可靠的结构变异检测结果, 提高片段长度, 进行全基因组测序是最简单直接的方式. 然而这两种方案都意味着单次检测成本的增加, 在测序的成本真正白菜价以前, 使用尽可能少的数据来获取更可靠的结果必然是结构变异检测应用在临检领域所必须面临的问题.</p><h4 id="2-PE和SR信号的获取难度的差异"><a href="#2-PE和SR信号的获取难度的差异" class="headerlink" title="2. PE和SR信号的获取难度的差异"></a>2. PE和SR信号的获取难度的差异</h4><p>假设一个结构变异断点周围的序列被测出来的可能性是相等的, 那么出现PE信号的可能应该是大于SR信号的, 因为测序时插入片段的长度往往是比Read本身要长, 自然断点位于插入片段区域的时候会更多一些. 另外, 由于大多数检测手段还是要基于比对, 那么一些SR信号还可能会因为断点位置不好(太靠近Read两端), 难以正确比对而导致信号丢失. 所以, 在同样的测序深度下, 尽量去应用PE信号理论上是能提高检测的灵敏度的.</p><h4 id="3-基于比对带来的检测瓶颈"><a href="#3-基于比对带来的检测瓶颈" class="headerlink" title="3. 基于比对带来的检测瓶颈"></a>3. 基于比对带来的检测瓶颈</h4><p>由于大部分工具都还是要基于序列的比对情况的, 因此如果真实的变异信号存在比对困难(序列太短无法比对), 必然会导致一些信号的丢失而影响检出. 这也催生了一些不基于比对的检测方案的尝试. </p><h3 id="基因融合专属检测策略"><a href="#基因融合专属检测策略" class="headerlink" title="基因融合专属检测策略"></a>基因融合专属检测策略</h3><p>在前面我们已经说过, 基因融合是结构变异的一种结果. 某种基因融合受关注, 多半是因为这种融合会导致基因表达的异常, 进而产生疾病. 因此在基因融合的检测中, 侧重点在于检测是否有基因融合在一起了, 以及它是怎么融合的. 由于这个侧重点的不同, 除了使用结构变异的检测策略从基因组上检出结构变异然后再进行融合可能的解读外, 也衍生出了专门进行融合检测的方案: RNA-Seq融合检测. 这种方案直接在转录组中进行融合检测, 如果检测到了来自与不同基因转录本的序列, 即可以说明存在基因的融合事件. 同时, 由于检测的是RNA, 也不用费力去推测融合会不会发生, 因为检测到即证明了融合的有效性.</p><p>当然, 个人认为这种方式也不是十全十美的, 能想到的缺点有如下:</p><ul><li>检测难度较DNA高, 毕竟RNA易降解…</li><li>作为应用于临床检测的方案, 使用RNA检测应该会有样品的限制和成本上的限制</li></ul><p>由于我暂时没有在实际工作中使用过这类工具, 也暂时没有使用的计划, 所以这个部分等下文的坑填完了再回来挖坑.</p><p>另外, 目前大多数结构变异&#x2F;融合的检出方案中, 向参考基因组比对都是必不可少的, 然而这个过程目前来说比较耗时的(使用了FGPA芯片做专门优化除外). 而基因融合本质上只需要了解是否有序列显示两个基因融合在一起了, 因此, 目前也见到有商业公司开发了基于非比对数据(fastq)的检测方案(<a href="#">INVALID POST SLUG PROVIDED </a>), 该方案但从检测速度来说确实快了非常多.</p><p>最后还有一点要注意, 由于侧重点的不同, 一些专门的基因融合检测软件在汇报融合结果的时候只汇报融合的基因及具体的外显子, 其形式多种多样, 无法直接与结构变异的检测工具进行比较.</p><h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>早期的结构变异软件会使用前述的一到两个检测策略, 而比较新的检测软件基本都是多策略的了…物尽其用嘛. 我之后解读的几个工具都是相对较新的, 他们在策略上都是多策略并用的. 其中Creast是我第一个使用较多的结构变异检测工具, 对结构变异的初步了解也是来自它, 不过它的年份也是相对久远了… Lumpy是我第二份工作中首要接触的工具. SvABA和SViCT是两个我在Github上找到的工具, 都比较新, 前者是2018年发布的, 是一个与Broad Insititute合作的项目, 后者2019年发布, 号称是第一个针对cfDNA设计的结构变异检测工具. 这里目前挖坑的都是我有实际用过的工具. 对于我在工作中见人提起的比较多的Manta, Delly以及后续新看到的工具, 如果有必要的话我再慢慢补充.</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 结构变异 </tag>
            
            <tag> 拷贝数变异 </tag>
            
            <tag> 基因融合 </tag>
            
            <tag> NGS检测 </tag>
            
            <tag> Split-Reads </tag>
            
            <tag> Discordant Read Pairs </tag>
            
            <tag> Read Depth </tag>
            
            <tag> de novo Assembly </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>R中的逻辑回归</title>
      <link href="/2019/03/16/R%E4%B8%AD%E7%9A%84%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92/"/>
      <url>/2019/03/16/R%E4%B8%AD%E7%9A%84%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92/</url>
      
        <content type="html"><![CDATA[<p>想不到4年之后, 又要弄回归了…这一次用的R而不是SPSS, 之前作的是统计分析, 这次…居然变成机器学习了…</p><!-- 摘要部分 --><span id="more"></span><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>逻辑(logistic)回归是广义线性模型的一种, 其特点在于因变量是分类变量, 通过将所有分类中的一个设为对照, 将其他的分类选项发生的的可能都与对照做比较的方式, 将分类变量转变成连续变量, 然后进行模型构建. 在逻辑回归中, 变量的系数取<code>exp(x)</code>后即为这个变量对应的OR值, 实际意义为, 该变量每增加一个单位, 接过被分类为<br>1的可能性将提高<code>exp(x)</code>.</p><h2 id="模型构建"><a href="#模型构建" class="headerlink" title="模型构建"></a>模型构建</h2><p>本次我使用的逻辑回归因变量是二分类的, 所以使用基本包的<code>glm()</code>函数就够了, 具体模型构建使用:</p><ul><li><code>family=binomial(link=&#39;logit&#39;)</code>指定调用二分类逻辑回归模型</li></ul><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model <span class="operator">&lt;-</span> glm<span class="punctuation">(</span>y <span class="operator">~</span> x1 <span class="operator">+</span> x2<span class="punctuation">,</span> family<span class="operator">=</span>binomial<span class="punctuation">(</span>link<span class="operator">=</span><span class="string">&#x27;logit&#x27;</span><span class="punctuation">)</span><span class="punctuation">,</span> data<span class="operator">=</span>fit_data<span class="punctuation">)</span></span><br><span class="line">summary<span class="punctuation">(</span>model<span class="punctuation">)</span> <span class="comment"># 显示模型信息</span></span><br></pre></td></tr></table></figure><p>在回归的时候, 很难保证第一次回归就能得到最好的结果. 在纳入的协变量中, 总会有系数过小的(也就是实际没太大作用), 或者统计检验不显著的(再抽样一次可能就没作用的), 因此我们需要变更变量多次进行回归.</p><p>在R中<code>step()</code>可以帮助我们自动进行回归, 并将对模型贡献小和不显著的变量自动去除:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">model.step <span class="operator">&lt;-</span> step<span class="punctuation">(</span>model<span class="punctuation">)</span></span><br><span class="line">summary<span class="punctuation">(</span>model.step<span class="punctuation">)</span> </span><br></pre></td></tr></table></figure><p>当然, 这仅仅是个自动化的参考, 最后模型怎么确定好还是要根据实际情况由人来进行具体判断.</p><h2 id="模型预测情况估计"><a href="#模型预测情况估计" class="headerlink" title="模型预测情况估计"></a>模型预测情况估计</h2><p>模型构建好后, 即可以用<code>predict()</code>对测试数据集做预测, 以对模型进行评价, 然后使用一些第三方包通过ROC曲线确定拟合情况, 并对最终的分类阈值做选择</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">test_data<span class="operator">$</span>prob <span class="operator">&lt;-</span> predict<span class="punctuation">(</span>model.step<span class="punctuation">,</span> test_data<span class="punctuation">,</span> type <span class="operator">=</span> <span class="string">&quot;response&quot;</span><span class="punctuation">)</span> <span class="comment"># response的话接过是0~1的概率, 不指定默认是个常数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用第三方的pROC</span></span><br><span class="line">library<span class="punctuation">(</span>pROC<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">obj_roc <span class="operator">&lt;-</span> roc<span class="punctuation">(</span>test_data<span class="operator">$</span>Real<span class="punctuation">,</span> test_data<span class="operator">$</span>prob<span class="punctuation">)</span> <span class="comment"># Real是分类的正确答案, prob是给的预测概率</span></span><br><span class="line">plot<span class="punctuation">(</span>obj_roc<span class="punctuation">,</span> print.auc<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span> auc.polygon<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span> grid<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.1</span><span class="punctuation">,</span> <span class="number">0.2</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 做图</span></span><br><span class="line">     grid.col<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;green&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> max.auc.polygon<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">     auc.polygon.col<span class="operator">=</span><span class="string">&quot;skyblue&quot;</span><span class="punctuation">,</span> print.thres<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># pROC给的ROC曲线图y轴是灵敏度(真阳性), x轴则是特异度(真阴性), 而非更常见的假阳性率, 所以x轴是1-&gt;0而非0-1</span></span><br></pre></td></tr></table></figure><h2 id="小Tips"><a href="#小Tips" class="headerlink" title="小Tips"></a>小Tips</h2><p>生成的模型对象本身也会包含详细的模型信息, 但是直接从模型上取信息与<code>summary()</code>看到的并不一致, 如系数的统计表, <code>summary()</code>给出的表格包含了系数数值, 系数表准误, 统计检验P值等详细信息, 但是直接从model取的话就只有系数数值.</p><p>想要取<code>summary()</code>信息的话, 要在其生成的对象上取, 或者先将其赋值后再取:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先赋值</span></span><br><span class="line">model_info <span class="operator">&lt;-</span> summary<span class="punctuation">(</span>model<span class="punctuation">)</span></span><br><span class="line">model_info<span class="operator">$</span>coefficients</span><br><span class="line"><span class="comment"># 直接取</span></span><br><span class="line">summary<span class="punctuation">(</span>model<span class="punctuation">)</span><span class="operator">$</span>coefficients</span><br></pre></td></tr></table></figure><h2 id="博客文章学习"><a href="#博客文章学习" class="headerlink" title="博客文章学习"></a>博客文章学习</h2><p>找了及篇使用R进行逻辑回归的博文, 主要是补充模型的评价方法</p><h3 id="Logistic-Regression"><a href="#Logistic-Regression" class="headerlink" title="Logistic Regression"></a><a href="http://r-statistics.co/Logistic-Regression-With-R.html">Logistic Regression</a></h3><ul><li>二分类变量的均一性: 逻辑回归中因变量的两个分类均衡的话, 分类结果会比较理想. 因此进行回归前应先查勘一下两个分类的情况: <code>table(your_data$val)</code>. 如果不均衡的话, 理论上应该对例数更大的一个分类进行抽样, 样本量以另一个分类的例数作参考.</li><li>多重共线性检测: 逻辑回归和线性回归一样需要例行检测一下共线性的问题, 博客中似乎推荐<code>VIF&lt;4</code></li></ul><h3 id="How-to-perform-a-Logistic-Regression-in-R"><a href="#How-to-perform-a-Logistic-Regression-in-R" class="headerlink" title="How to perform a Logistic Regression in R"></a><a href="https://www.r-bloggers.com/how-to-perform-a-logistic-regression-in-r/">How to perform a Logistic Regression in R</a></h3><ul><li>$R^2$获取: 逻辑回归不能计算$R^2$, 文章说可以计算<em>McFadden $R^2$ index</em>替代. 关于这个指标的更多信息: <a href="http://thestatsgeek.com/2014/02/08/r-squared-in-logistic-regression/">R squared in logistic regression</a></li></ul><h3 id="Logistic-regression-on-biased-data"><a href="#Logistic-regression-on-biased-data" class="headerlink" title="Logistic regression on biased data"></a><a href="https://datascience.stackexchange.com/questions/12234/logistic-regression-on-biased-data">Logistic regression on biased data</a></h3><ul><li>不均衡分类中评价指标的选择: 在分类不均衡时, <code>accuracy</code>并不是一个好的评价指标, 推荐使用<code>F1-score</code></li><li>解决分类不均衡的方案有两类: <a href="https://www.marcoaltini.com/blog/dealing-with-imbalanced-data-undersampling-oversampling-and-proper-cross-validation">oversampling the minority class</a>以及fixing the model by altering the <a href="#">INVALID POST SLUG PROVIDED </a> or <a href="#">INVALID POST SLUG PROVIDED </a></li><li>根据文章的描述, 对少数项目的<code>oversampling</code>和多数项的<code>undersampling</code>可以一定程度上提高检测结果准确性, 但是在测试用的数据中没有好到可以使用.</li></ul><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">library<span class="punctuation">(</span>pscl<span class="punctuation">)</span></span><br><span class="line">pR2<span class="punctuation">(</span>model<span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h3 id="其它材料"><a href="#其它材料" class="headerlink" title="其它材料"></a>其它材料</h3><ul><li><a href="https://blog.mythsman.com/2016/01/28/1/">逻辑回归算法</a></li><li><a href="https://blog.mythsman.com/2016/02/02/1/">机器学习中的交叉验证思想</a></li><li><a href="https://www.r-bloggers.com/dealing-with-unbalanced-data-in-machine-learning/">Dealing with unbalanced data in machine learning</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Statistic </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R语言 </tag>
            
            <tag> 逻辑回归 </tag>
            
            <tag> 机器学习 </tag>
            
            <tag> 统计分析 </tag>
            
            <tag> logistic regression </tag>
            
            <tag> machine learning </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>换新主题&amp;Hexo框架搭建博客记录</title>
      <link href="/2019/03/12/%E6%8D%A2%E6%96%B0%E4%B8%BB%E9%A2%98-Hexo%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2%E8%AE%B0%E5%BD%95/"/>
      <url>/2019/03/12/%E6%8D%A2%E6%96%B0%E4%B8%BB%E9%A2%98-Hexo%E6%A1%86%E6%9E%B6%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>昨天因为markdown文章里面用了无法解析的符号, 导致我以为hexo挂了, 遂折腾换了新的主题…顺便又回顾了一下搭建过程</p><!-- 摘要部分 --><span id="more"></span><h2 id="一般搭建过程"><a href="#一般搭建过程" class="headerlink" title="一般搭建过程"></a>一般搭建过程</h2><p>hexo基于Node.js, 在arch系系统下<code>sudo pacman -S nodejs npm</code>即可</p><p>安装后使用npm在全局环境中安装hexo和hexo-cli(hexo-cli必要, hexo是否必要线下次再测)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -g代表全局模块, 安装后可使用hexo命令行工具</span></span><br><span class="line">sudo npm install -g hexo</span><br><span class="line">sudo npm install -g hexo-cli</span><br></pre></td></tr></table></figure><p>接下来使用hexo创建新的博客项目, 一句<code>hexo init</code>就好, 不过要注意, 这一步需要在空目录进行, 否则会提示目录非空, 无法运行.</p><p>hexo创建的博客有个默认的主题, 不过一般我们不会去用它就是了…在网上搜索一个你喜欢的主题, 然后使用git克隆到项目的theme目录下即可</p><p>之后对项目下的<code>_config.yml</code>进行修改就可以修改博客设置了. 修改完毕后<code>hexo g &amp; hexo s</code>可生成并本地预览博客. <code>hexo d</code>则可以发布&#x2F;跟新博客网站, 不过这需要在配置文件内指定好使用的方式(我是git), 并按照提示使用npm装好相应的发布用模块(直接<code>npm install</code>, 这个不需要装到全局)</p><h2 id="博客项目备份"><a href="#博客项目备份" class="headerlink" title="博客项目备份"></a>博客项目备份</h2><p>在很多情况下, 都可能会涉及到在多个地方编辑博客内容的问题. 这个就很简单了….直接git整个项目就可以了, 唯一需要注意的是, 如果使用git安装主题, theme下每个文件夹本来就是一个git项目, 我个人觉得在建立整个项目的git时在<code>.gitignore</code>中设置主题文件夹内所有文件被忽略, 然后主题的<code>_config.yml</code>另外备份一下比价好</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/new_blog.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/new_blog.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="new_blog"></p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> 博客搭建 </tag>
            
            <tag> 主题更换 </tag>
            
            <tag> Node.js </tag>
            
            <tag> git备份 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Snakemake的一些有用特性</title>
      <link href="/2019/03/06/Snakemake%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%89%E7%94%A8%E7%89%B9%E6%80%A7/"/>
      <url>/2019/03/06/Snakemake%E7%9A%84%E4%B8%80%E4%BA%9B%E6%9C%89%E7%94%A8%E7%89%B9%E6%80%A7/</url>
      
        <content type="html"><![CDATA[<p>在使用snakemake一段时间后, 发现其中确实有很多实用的特性来方便平常的分析, 做个记录整理</p><span id="more"></span><h2 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h2><p>在<code>rule</code>内可使用<code>resources</code>关键字来限定资源, 这在需要用到GPU(只有一个GPU)或者磁盘性能有限(不能同时进行太多高IO操作)的时候非常有用. 如下面的设定</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="built_in">all</span>:</span><br><span class="line">    expand(<span class="string">&quot;&#123;sam&#125;.vcf&quot;</span>, sam=[<span class="string">&quot;sam1&quot;</span>, <span class="string">&quot;sam2&quot;</span>, <span class="string">&quot;sam3&quot;</span>, <span class="string">&quot;sam4&quot;</span>])</span><br><span class="line"></span><br><span class="line">rule samtools_sort:</span><br><span class="line">    <span class="built_in">input</span>: </span><br><span class="line">        rules.samtools_flt.output</span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;&#123;sam&#125;.flt.srt.bam&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">        IO=<span class="number">8</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&quot;samtools sort -@ 8 &#123;input&#125; &gt; &#123;output&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">rule samtools_call:</span><br><span class="line">    <span class="built_in">input</span>: </span><br><span class="line">        <span class="string">&quot;&#123;sam&#125;.bam&quot;</span></span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;&#123;sam&#125;.vcf&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">        IO=<span class="number">1</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        bcftools mpileup -Ou -f reference.fa &#123;input&#125; \\</span></span><br><span class="line"><span class="string">            | bcftools call -mv -O -o &#123;output&#125;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>上面的流程中, sort过程8线程同时进行, 相当消耗IO, 因此设定其使用的IO为8, 而call操作设<code>IO=1</code>, 之后在运行的时候设定最大IO数值就可以达到控制高IO任务数目的目的: <code>snakemake --resources IO=16</code></p><h2 id="任务组"><a href="#任务组" class="headerlink" title="任务组"></a>任务组</h2><p>需要使用集群时, 在特定的情况下, 将相互关联的任务投递到同一个节点会更节省IO(防止节点间来回传输中间文件, 大概吧…), 使用关键字是<code>group</code>, 同一个组内的任务会被一次性的投递到同一个节点中去执行(节点上会再启动一个snakemake用于控制).</p><p>实际使用很简单所以就不写例子. 但是需要注意一个问题, 同组同任务投递上节点后, 虽然有snakemake进行控制, 但是在投递任务结束后, 本地的snakemake进程是会再一次检查input和output是否满足的, 这一点要注意. 比如我使用这个功能是为了利用节点的本地磁盘, 但是这些磁盘是计算节点限定的, 登录节点并不能访问. 这就会导致登录节点的进程检查任务是否完成时, 部分中间结果找不到而导致任务执行失败.</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> snakemake </tag>
            
            <tag> 工作流管理 </tag>
            
            <tag> 资源控制 </tag>
            
            <tag> 任务分组 </tag>
            
            <tag> workflow </tag>
            
            <tag> resource management </tag>
            
            <tag> task grouping </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python中的itertools</title>
      <link href="/2019/02/13/python%E4%B8%AD%E7%9A%84itertools/"/>
      <url>/2019/02/13/python%E4%B8%AD%E7%9A%84itertools/</url>
      
        <content type="html"><![CDATA[<p>原来写脚本的时候很多实用的功能都没有用过, 这次学习了一点点, 做个记录</p><!-- 摘要部分 --><span id="more"></span><p>本次涉及到对大文件进行处理, 但是大部分时候是单行处理的, 所以想到用itertools以生成生成器. 这样之后也许可以将生成器分割成小部分, 应用到并行运算中.</p><p>本次用到的itertools中的三个函数:</p><ol><li>groupby</li><li>tee</li><li>chain</li></ol><ul><li>groupby用于对迭代对象进行聚类, 对应实例是UMI分组时, 需要对比对位置接近的reads进行判断, 将比对情况认为一致的reads放一起进一步判断UMI情况</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 后面是一个以iter_obj的单个对象作为输入的函数, 以函数的返回值作为判断依据</span></span><br><span class="line">grp_generator = groupby(iter_obj, <span class="keyword">lambda</span> x: x[<span class="number">0</span>])</span><br><span class="line"><span class="comment"># 需要注意的是, groupby只将临近的对象聚在一起, 所以有必要的话自行排序</span></span><br></pre></td></tr></table></figure><ul><li>tee则很简单, 如果迭代对象是生成器的话, 由于生成器只能用一次的, 对于要用到两次及以上的生成器就需要用tee函数做个副本出来</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iterable_fork_1, iterable_fork_2 = tee(iterable, <span class="number">2</span>) <span class="comment"># 2可以不写, 默认就是2</span></span><br></pre></td></tr></table></figure><ul><li>chain则是酱多个迭代对象的接过连起来, 我本次具体是用来展平嵌套结果:</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flat_iter = chain.from_iterable(ori_iter)</span><br><span class="line"><span class="comment"># [[1,2],3] -&gt; [1,2,3] 当然实际生成的是生成器, 要自己list(flat_iter)获取完整结果</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 迭代器 </tag>
            
            <tag> 生成器 </tag>
            
            <tag> itertools </tag>
            
            <tag> groupby </tag>
            
            <tag> tee </tag>
            
            <tag> chain </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python中的多进程</title>
      <link href="/2019/02/12/python%E4%B8%AD%E7%9A%84%E5%A4%9A%E8%BF%9B%E7%A8%8B/"/>
      <url>/2019/02/12/python%E4%B8%AD%E7%9A%84%E5%A4%9A%E8%BF%9B%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<p>R中可以方便的使用多进程, Python中也有类似的东西.</p><!-- 摘要部分 --><span id="more"></span><p>首先引用<a href="https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014319272686365ec7ceaeca33428c914edf8f70cca383000">廖雪峰的Python教程</a>解释一下进程和线程:</p><blockquote><p>对于操作系统来说，一个任务就是一个进程（Process），比如打开一个浏览器就是启动一个浏览器进程，打开一个记事本就启动了一个记事本进程，打开两个记事本就启动了两个记事本进程，打开一个Word就启动了一个Word进程。</p><p>有些进程还不止同时干一件事，比如Word，它可以同时进行打字、拼写检查、打印等事情。在一个进程内部，要同时干多件事，就需要同时运行多个“子任务”，我们把进程内的这些“子任务”称为线程（Thread）。</p><p>由于每个进程至少要干一件事，所以，一个进程至少有一个线程。当然，像Word这种复杂的进程可以有多个线程，多个线程可以同时执行，多线程的执行方式和多进程是一样的，也是由操作系统在多个线程之间快速切换，让每个线程都短暂地交替运行，看起来就像同时执行一样。当然，真正地同时执行多线程需要多核CPU才可能实现。</p><p>我们前面编写的所有的Python程序，都是执行单任务的进程，也就是只有一个线程。如果我们要同时执行多个任务怎么办？<br>有两种解决方案：<br>一种是启动多个进程，每个进程虽然只有一个线程，但多个进程可以一块执行多个任务。</p><p>还有一种方法是启动一个进程，在一个进程内启动多个线程，这样，多个线程也可以一块执行多个任务。</p><p>当然还有第三种方法，就是启动多个进程，每个进程再启动多个线程，这样同时执行的任务就更多了，当然这种模型更复杂，实际很少采用。</p></blockquote><p>我需要执行的任务并不是IO等待很久的, 所以没有选择Python的多线程或者协程, 而是用多进程进行尝试</p><p>主要的代码如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_to_process</span>(<span class="params">args</span>):</span><br><span class="line">    do someting</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    sub_procs = Pool(<span class="number">10</span>)  <span class="comment"># 10是使用的子进程数</span></span><br><span class="line">    results = [] <span class="comment"># 用来存结果</span></span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> iterable:</span><br><span class="line">        result = sub_procs.apply_async(func_to_process, (args))</span><br><span class="line">        <span class="comment"># 提交任务到进程池, apply_async代表等待提交任务完成, 直接继续提交</span></span><br><span class="line">        <span class="comment"># 直到进程池填满后阻塞</span></span><br><span class="line">        results.append(result)</span><br><span class="line">    sub_procs.close() <span class="comment"># 关闭进程池, 不再能提交新任务</span></span><br><span class="line">    sub_procs.join() <span class="comment"># 等待所有进程完毕, 这是为了下面正确的取回结果</span></span><br><span class="line">    results = [result.get() <span class="keyword">for</span> result <span class="keyword">in</span> results] <span class="comment"># 使用get()取出所有结果</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>这段代码存在两个问题:</p><ol><li>这种写法等于把我要处理的文件按照行数拆分并执行, 每一行就进程, 拆得太碎了. 尤其是在执行的任务中如果有比较长时间的准备步骤时, 这么做其实会大大降低效率(单进程只准备一次, 而多进程准备无数次)</li><li>这样执行后, 结果顺序是有可能打乱的, 如果任务要求结果保持一定顺序, 则需要对接过再次排序</li></ol><p>对于问题1, 经过今天学习, 可能是可以通过<code>itertools</code>中的部分功能实现对原文件的定量拆分的, 预计明天更新</p><p>对于问题2, 可以使用对应的map方法代替apply, 这个需要再进行尝试</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 并行计算 </tag>
            
            <tag> 多进程 </tag>
            
            <tag> multiprocessing </tag>
            
            <tag> Pool </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>R中parellel包的使用</title>
      <link href="/2019/01/01/R%E4%B8%ADparellel%E5%8C%85%E7%9A%84%E4%BD%BF/"/>
      <url>/2019/01/01/R%E4%B8%ADparellel%E5%8C%85%E7%9A%84%E4%BD%BF/</url>
      
        <content type="html"><![CDATA[<p>最近用写了个画图的脚本, 需要一次性用ggplot绘制大量的图片. 虽然在脚本内所有需要使用循环的地方都已经使用上apply了, 但依然架不住一次画几百图, 所以捣鼓了一下<code>parellel</code>, 将画图的部分并行执行已加快速度.</p><!-- 摘要部分 --><span id="more"></span><p>之前在用python的时候就有了解到多线程和多进程, 但是到了R这…好像没有太强调线程和进程的问题, 都是说并行计算…中文资料中能找得到的与并行计算相关的基本就是<code>parellel</code>以及<code>foreach</code>了, 当然我这里用的是<code>parellel</code>, 然后两种方案的异同…没研究过…</p><p>使用方法其实比较简单, 就是先注册集群, 然后把任务丢到集群上跑(以函数的形式), 然后合并结果(我这里不需要), 注销集群就行. 当然, 这里的集群并不是指集群服务器, 而是英文中就写的是’cluster’, 我也不知道怎么翻译好…随便叫一下算了. 具体的实现代码如下:</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备绘图函数</span></span><br><span class="line">plot_process <span class="operator">&lt;-</span> <span class="keyword">function</span> <span class="punctuation">(</span>data_list<span class="punctuation">,</span> args<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span></span><br><span class="line">    plot <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">+</span> geom_line<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">    ggsave<span class="punctuation">(</span><span class="string">&quot;plot.png&quot;</span><span class="punctuation">,</span> plot<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">cl <span class="operator">&lt;-</span> makeCluster<span class="punctuation">(</span>core_num<span class="punctuation">)</span> <span class="comment"># 注册</span></span><br><span class="line">parLapply<span class="punctuation">(</span>cl<span class="punctuation">,</span> data_list<span class="punctuation">,</span> plot_process<span class="punctuation">,</span> args<span class="punctuation">)</span> <span class="comment"># 除了第一个参数指定集群, 其他参数同lapply</span></span><br><span class="line">stopCluster<span class="punctuation">(</span>cl<span class="punctuation">)</span> <span class="comment"># 注销</span></span><br><span class="line"><span class="comment"># 由于我只是分别处理数据并绘图, 所以没有很多教程里的合并结果数据的那一步</span></span><br></pre></td></tr></table></figure><p>所以其实超简单的…唯一有点麻烦的问题是, 对于每一个集群节点, 计算需要的变量, 包, 函数都得单独加载一次. 对于变量和包都好说, 变量有专门的函数进行传递, 包的话可以把载入包的语句写到<code>plot_process</code>里面, 但是自己编写的函数就没有直接可用的方式了…<br>在查了很久都没有解决方案后, 我突发奇想的把函数作为参数写到了<code>plot_process</code>上, 居然有用…</p><p>在写完这个脚本后, 我还看到了另外一种解决方案, 就是把这些自定义函数单独写在另一个文件里, 然后在<code>plot_process</code>使用<code>source()</code>导入, 这个应该是个更好的方案, 回头我准备试试看….</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据可视化 </tag>
            
            <tag> R语言 </tag>
            
            <tag> R </tag>
            
            <tag> 并行计算 </tag>
            
            <tag> ggplot </tag>
            
            <tag> parallel </tag>
            
            <tag> performance </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>teamviewer+ssh跳转=vpn</title>
      <link href="/2018/12/23/teamviewer-ssh%E8%B7%B3%E8%BD%AC-vpn/"/>
      <url>/2018/12/23/teamviewer-ssh%E8%B7%B3%E8%BD%AC-vpn/</url>
      
        <content type="html"><![CDATA[<!-- 摘要部分 --><p>好久不更了, 今天来记录一下自制vpn的升级版~</p><span id="more"></span><p>之前因为一些原因笔记本装了win10, 然后又装回了manjaro. 于是又要重新开始配置一些东西, 其中一项就是回家加班要用的vpn.</p><p>由于现在的公司是没有搭vpn的, 所以之前一直用的teamviewer. 但是实际使用下来相当的不方便. 因为我在公司电脑上用的时虚拟机, 经常会出现一些莫名其妙的问题, 再就是网络繁忙的时候会出现明显的卡顿.</p><p>之前装win10的那段时间偶然发现teamviewer最新的14版本有一个vpn模式, 试用了一下, 是真的有用的…于是就效仿在上一间公司的自制vpn又如法炮制了一遍:</p><ul><li><p>材料准备</p><ol><li>virtualbox with micro xp</li><li>teamviewer 14 </li><li>cygwin with openssh</li></ol></li><li><p>tip: 本次试了tiny xp的镜像…发现cygwin在里面没法正常用…没办法还是回百度云下回了原来的备份镜像…</p></li><li><p>SSH设置: 配置<code>~/.ssh/config</code>, 在面设置好跳板就行了, 其中跳到公司工作电脑的那一级借助teamviewer14的vpn, 地址在连接后可从teamviewer中获取. 地址好像是固定的, 因此直接写在配置文件里面就好了.</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Host vpn_vm</span><br><span class="line">    User Administrator</span><br><span class="line">    HostName 127.0.0.1</span><br><span class="line">    Port 8022</span><br><span class="line">    IdentityFile ~/.ssh/vpn_vm_key</span><br><span class="line"></span><br><span class="line">Host Jump</span><br><span class="line">    HostName 123.456.789.0</span><br><span class="line">    Port 8022</span><br><span class="line">    User silen</span><br><span class="line">    IdentityFile ~/.ssh/jump_key</span><br><span class="line">    ProxyCommand ssh Administrator@vpn_vm -W %h:%p</span><br><span class="line"></span><br><span class="line">Host Target</span><br><span class="line">    HostName 123.456.789.1</span><br><span class="line">    Port 22</span><br><span class="line">    User silen</span><br><span class="line">    IdentityFile ~/.ssh/target_key</span><br><span class="line">    ProxyCommand ssh silen@Jump -W %h:%p</span><br></pre></td></tr></table></figure><ul><li>这里做了一个2级的跳转, <code>vpn_vm</code>是本地的虚拟机, 里面装好了teamviewer进行vpn连接, openssh则负责使本机能通过该虚拟机进行跳转</li><li>Jump是公司的机器, 上面用vobx装了manjaro并启动了sshd服务</li><li>Target时最终的服务器</li><li>上面ProxyCommand设置了每1级的跳转命令, 同时设置了密钥以实现无密直接登录</li><li>登陆时本机直接<code>ssh Target</code>就可以了, 相当方便, <code>scp</code>, <code>sftp</code>也直接用就好</li></ul>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> VPN </tag>
            
            <tag> SSH跳转 </tag>
            
            <tag> TeamViewer </tag>
            
            <tag> VirtualBox </tag>
            
            <tag> Cygwin </tag>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>用外门邪道的方式使用snakemake实现流程控制</title>
      <link href="/2018/11/17/%E7%94%A8%E5%A4%96%E9%97%A8%E9%82%AA%E9%81%93%E7%9A%84%E6%96%B9%E5%BC%8F%E4%BD%BF%E7%94%A8snakemake%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/"/>
      <url>/2018/11/17/%E7%94%A8%E5%A4%96%E9%97%A8%E9%82%AA%E9%81%93%E7%9A%84%E6%96%B9%E5%BC%8F%E4%BD%BF%E7%94%A8snakemake%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<!-- 摘要部分 --><p>Snakemake 确实是非常好用的流程开发及管理工具. 但是在特定的场景下…它也会带来一些问题, 然后在机缘巧合下, 我发现了一种非常蛋疼的使用方式: 只使用snakemake的依赖处理和人物管理, 执行脚本另外生成.</p><span id="more"></span><p>其实起因是因为让我写流程的时候要在特定位置放一份实际的执行脚本, 这样使用流程的人可以读这些脚本之后可以对特定的步骤进行修改后再次投递执行.</p><p>初衷是非常好的: 让使用流程, 但不了解snakemake的人也能轻松的对特定样本的分析参数作修改. 可是问题是…snakemake并不支持将实际执行的脚本单独导出形成文件, 只能使用<code>-p</code>参数将执行的内容直接输出在日志里, 并且之前在找解决方案的时候我还不知道可以在cluster模式的投递命令中使用wildcard…所以几经周折, 我找到了如下这个非常歪门邪道的解决方案.</p><ol><li>将整个流程划分为若干部分, 然后自写程序生成所有需要执行的脚本</li><li>在投递到SGE时, 使用<code>qsub</code>的<code>-sync y</code>参数, 使qsub投递后并不直接结束程序, 而是的等待到投递的完成&#x2F;失败, 如果人物失败, 会返回非0数值</li><li>使用snakemake构建流程依赖, <code>input</code> &#x2F; <code>output</code>照常指定, 在<code>input</code>中加上执行脚本, 然后<code>shell:</code>后只写<code>qsub</code>的投递命令</li></ol><p>这样一来, 可以曲线解决不能直接生成脚本的问题 –&gt; 我自己生成, 给你投递就好<br>同时也可以利用snakemake的依赖解决和任务管理特性 –&gt; 可以进度监测, 可以断点继续<br>但同时也挖了一个巨坑: 脚本执行内容和各文件名未在snakemake内指定, 如果不一致流程会出错, 且这种问题不会有什么比较好的方法能定位, 全靠写的人自己小心…</p><p>比如: 你写了这样一个脚本<code>test.sh</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#$ -sync y</span></span><br><span class="line"><span class="built_in">cat</span> test.txt | <span class="built_in">cut</span> -f 2 &gt; tset.col2.txt</span><br></pre></td></tr></table></figure><p>然后写的snakemakefile是这样的:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="built_in">all</span>:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        test.col2.txt</span><br><span class="line"></span><br><span class="line">rule test:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        &#123;sample&#125;.txt</span><br><span class="line">    output:</span><br><span class="line">        &#123;sample&#125;.col2.txt</span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        qsub test.sh</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>那么在使用snakemake运行的时候, 是永远不会运行成功的…因为脚本生成的结果名字和snakemake的目的文件名不一致…<br>然后在默认情况下, 因为判定<code>rule test</code>执行失败, 其他被用于判定的结果文件(如果存在的话)会被删除…</p><p>也就是说, 用这种方式的话, 得自己保证目标文件的一致性. 排除这个缺点之外, 这种方式能充分利用snakemake在任务管理上的优势, 又可以避免初期上手snakemake时在理解wildcard机制时所必须要花的时间.</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> snakemake </tag>
            
            <tag> workflow </tag>
            
            <tag> 流程控制 </tag>
            
            <tag> 任务管理 </tag>
            
            <tag> 脚本生成 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>snakemake的使用</title>
      <link href="/2018/10/30/snakemake%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/10/30/snakemake%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>写流程是生物信息分析中经常需要涉及的工作, 一个成熟完善的好工具可以使工作的效率大大提高.</p><span id="more"></span><p>最简单的流程编写方式可以是将所有需要运行的命令都写成一个shell脚本, 并使用<code>&amp;&amp;</code>或其他方式指定任务的先后顺序, 然后挂到后台就好.</p><p>这么做虽然容易, 但是其重复性和抗错误性实在堪忧. 因此也就有了各种各样的流程管理工具: 我过去单位用的<code>sjm</code>, 10x Genomics自己开发的<code>Martian</code>, Broad Institute的<code>WDL</code>, 我最近在用的<code>snakemake</code>等等.</p><h2 id="snakemake简介"><a href="#snakemake简介" class="headerlink" title="snakemake简介"></a>snakemake简介</h2><p><code>snakemake</code>是德国杜伊斯堡-埃森大学的Köster lab开发的生物信息分析流程管理工具, 其全部代码完全由python实现, 因此可以很好的和python程序整合在一起(当然其也有一套完整的命令行程序).</p><p><code>snakemake</code>的特点包括但不限于:</p><ul><li>简单易用</li><li>可直接使用python代码</li><li>内置分布式运算集群支持(SGE, LSF, etc.)</li><li>内置Conda环境部署支持</li><li>内置容器支持(注意这个容器不是docker)</li><li>自动处理依赖并进行断点重启</li><li>内置测试功能(benchmark)</li><li>与<code>make</code>完全一样的执行逻辑, 有相关基础的人可快速上手</li></ul><h2 id="snakemake简单示例"><a href="#snakemake简单示例" class="headerlink" title="snakemake简单示例"></a>snakemake简单示例</h2><p>snakemake文件中以<code>rule</code>为最基本单位, 一个<code>rule</code>就算是流程中的一个步骤. 在<code>rule</code>下可定义输入文件, 输出文件以及要执行的命令. 由于snakemake基于python, 所以其在语法格式上也与python一致, 也是以缩进来定义控制范围, 比如写一个简单的<code>rule</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rule samtools_sort:</span><br><span class="line">    <span class="built_in">input</span>: </span><br><span class="line">        <span class="string">&quot;test.bam&quot;</span></span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;test.srt.bam&quot;</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&quot;samtools sort &#123;input&#125; &gt; &#123;output&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>这个名称为”samtools_sort”的<code>rule</code>执行的步骤是将输入的<code>test.bam</code>通过<code>samtools</code>的<code>sort</code>命令进行排序, 然后将输出结果指定为”test.srt.bam”.</p><p>最后的<code>shell:</code>代表这里执行的是shell命令, 命令以字符串的形式给出, snakemake还支持直接执行python代码, 此时的关键词需要更改为<code>run:</code>. 此外也支持调用R代码以及其他外部脚本, 详情参考snakemake的<a href="#">INVALID POST SLUG PROVIDED </a>.</p><h2 id="使用snakemake进行样品批量处理"><a href="#使用snakemake进行样品批量处理" class="headerlink" title="使用snakemake进行样品批量处理"></a>使用snakemake进行样品批量处理</h2><p>了解了最基本的<code>rule</code>写法之后就可以写出一串<code>rule</code>, 然后把他们串成流程了, 不过虽然snakemake简单易学, 要写出一个能处理一堆样品的完整流程还是需要了解些东西的.</p><h3 id="snakemake中的特殊字符串格式化方式"><a href="#snakemake中的特殊字符串格式化方式" class="headerlink" title="snakemake中的特殊字符串格式化方式"></a>snakemake中的特殊字符串格式化方式</h3><p>从之前的简例中可以看出, snakefile中执行的命令, 输入及输出的文件都以字符串的形式给出. 而在这些字符串中可以使用类似<code>str.format()</code>的格式化字符串方式减少硬编码, 增加应用性.</p><p>比如前面的<code>&quot;samtools sort &#123;input&#125; &gt; &#123;output&#125;&quot;</code>中, <code>&#123;input&#125;</code>会被替换成<strong>该rule内定义的</strong><code>input</code>后面字符串(如果input不只一个, 则会以空格分隔全部列出). 类似的, 我们可以调用任意<code>rule</code>内定义过的内容来填充文本模板, 以生成最终需要运行的命令或者字符串.</p><p>但是有一点需要注意, 对于习惯了用<code>format()</code>的人来说可能会写类似下面的表达:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">path=<span class="string">&quot;path/to/input&quot;</span></span><br><span class="line"></span><br><span class="line">rule samtools_flt:</span><br><span class="line">    <span class="built_in">input</span>: </span><br><span class="line">        <span class="string">&quot;test.bam&quot;</span></span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;test.flt.bam&quot;</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&quot;samtools sort &#123;path&#125;/&#123;input&#125; &gt; &#123;output&#125;&quot;</span>.<span class="built_in">format</span>(path=path)</span><br></pre></td></tr></table></figure><p>即将python中的字符串格式化和snakamake的字符串格式化混用. <del>这种写法snakemake是没法正确处理的, 一个字符串要么只能使用内置的格式化方式, 要么只能用python原有的格式化方式, 上面那种写法, 会按照python原有的方式去处理, 即根据<code>format()</code>内给的信息去填充字符串, 没有指定的<code>input</code>和<code>output</code>会作留空处理.</del> snakemake是可以处理这种情况的, 但是写法上要进行变更:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">path=<span class="string">&quot;path/to/input&quot;</span></span><br><span class="line"></span><br><span class="line">rule samtools_flt:</span><br><span class="line">    <span class="built_in">input</span>: </span><br><span class="line">        <span class="string">&quot;test.bam&quot;</span></span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;test.flt.bam&quot;</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&quot;samtools sort &#123;path&#125;/&#123;&#123;input&#125;&#125; &gt; &#123;&#123;output&#125;&#125;&quot;</span>.<span class="built_in">format</span>(path=path)</span><br></pre></td></tr></table></figure><p>用python比较多的话, 一定了解<code>&quot;\&#123;\&#123;\&#125;\&#125;&quot;</code>代表不对字符串内的<code>&#123;&#125;</code>进行转义, 而当作一般符号. 结合snakemake的执行逻辑, 可知snakemake会自行处理一次纯字符串的输入, 而这一切发生在python部分执行完之后.</p><h3 id="snakemake的流程执行逻辑"><a href="#snakemake的流程执行逻辑" class="headerlink" title="snakemake的流程执行逻辑"></a>snakemake的流程执行逻辑</h3><p>snakemake并没有准备专门的顺序或依赖的语法关键词, 流程的串联完全依靠输入和输出文件的依赖关系自动完成. 由于snakemake默认会去解析并完成第一个<code>rule</code>, 因此官方文档推荐的使用方式是创建一个名称为”all”的<code>rule</code>, 然后在这个<code>rule</code>的<code>input</code>中(注意不是<code>output</code>)指定所有的最终文件. 然后程序会发现结果文件不存在, 便在文件中寻找到某条<code>rule</code>的<code>output</code>符合文件模式, 然后继续解析这个<code>rule</code>需要要什么作为<code>input</code>, 如果<code>input</code>(即执行依赖)已满足, 则会开始运行该规则下的命令&#x2F;脚本, 如果不满足, 则会继续向前查找, 直到找到源头或者找不到源头而报错为止, 例如:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="built_in">all</span>:</span><br><span class="line">    <span class="string">&quot;test.flt.srt.bam&quot;</span></span><br><span class="line"></span><br><span class="line">rule samtools_flt:</span><br><span class="line">    <span class="built_in">input</span>: </span><br><span class="line">        <span class="string">&quot;test.bam&quot;</span></span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;test.flt.bam&quot;</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&quot;samtools sort &#123;input&#125; &gt; &#123;output&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">rule samtools_sort:</span><br><span class="line">    <span class="built_in">input</span>: </span><br><span class="line">        rules.samtools_flt.output</span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;test.flt.srt.bam&quot;</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&quot;samtools sort &#123;input&#125; &gt; &#123;output&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>在上面的snakefile中, 流程运行的逻辑是:</p><ol><li>最终目标是<code>test.flt.srt.bam</code>, 搜寻可以产生这个文件的<code>rule</code></li><li>发现<code>samtools_sort</code>可产生需要的文件, 而这个规则需要输入<code>samtools_flt</code>规则的结果, 因此<code>samtools_flt</code>先执行</li><li><code>samtools_flt</code>需要输入<code>test.bam</code>, 查询该文件是否存在, 如果存在则按照<code>samtools_flt &gt; samtools_sort &gt; all</code>的顺序执行流程, 如果找不到该文件, 则会提示依赖不满足, 流程无法运行.</li></ol><p>由于这种回溯式的流程执行逻辑, 在流程中某一个<code>rule</code>失败后, 非常容易实现流程断点重启: 即回溯式的检查每个步骤的依赖是否已满足, 如果满足, 则从当前步骤执行, 如果不满足, 则继续向上回溯.</p><p>另外, snakemake在和执行流程的过程中, 本身会检查输出文件的更新情况以及文件完整性以确定规则是否顺利运行. 如果某个规则出错, 改规则下的结果文件默认会被删除, 所以除非snakemake本身的进程被异常终止, 否则不太会出现某个步骤未完成但是流程继续向后跑的情况.</p><h3 id="snakemake内建的实用函数"><a href="#snakemake内建的实用函数" class="headerlink" title="snakemake内建的实用函数"></a>snakemake内建的实用函数</h3><p>由于snakefile内是可以直接写python代码的, 所以对于用惯了python的人, 可以比较轻松的使用生成式之类的东西快速生成批量处理时需要的信息. 而对于没有太多python基础的人, snakemake也准备了一些内建的函数来快速实现类似的功能. 比如:</p><ul><li>expand: <ul><li>用来生成字符串列表的函数, 相当于组合了列表生成试和格式化字符串, 默认情况下会将多个替换变量两两组合, 但也可以设置为类似<code>zip()</code>的模式, 即依次组对, 可以满足不同情况下的需要</li><li><code>samples = expand(&quot;&#123;sample_id&#125;.&#123;fq&#125;.fasta&quot;, sample_id=[&#39;sam1&#39;, &#39;sam2&#39;], fq=[&#39;fq1&#39;, &#39;fq2&#39;])</code></li></ul></li></ul><h3 id="多样品-多文件的批量处理"><a href="#多样品-多文件的批量处理" class="headerlink" title="多样品&#x2F;多文件的批量处理"></a>多样品&#x2F;多文件的批量处理</h3><p>批量处理涉及到snakemake中的一个比较重要的内置对象—-<code>wildcards</code>. 我虽不是太清楚这个东西应该怎么翻译…大致上来说, 这个对象用来进行种带捕获效果的模式匹配(正则). 比如官方文档中给出的例子:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rule complex_conversion:</span><br><span class="line">    <span class="built_in">input</span>:</span><br><span class="line">        <span class="string">&quot;&#123;dataset&#125;/inputfile&quot;</span></span><br><span class="line">    output:</span><br><span class="line">        <span class="string">&quot;&#123;dataset&#125;/file.&#123;group&#125;.txt&quot;</span></span><br><span class="line">    shell:</span><br><span class="line">        <span class="string">&quot;somecommand --group &#123;wildcards.group&#125; &lt; &#123;input&#125; &gt; &#123;output&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>这里规则的输入输出中的<code>&#123;dataset&#125;</code>以及<code>&#123;group&#125;</code>就是两个<code>wildcard</code>, 而每一个<code>wildcard</code>都可以匹配近乎任意字符(对应正则表达式为<code>.+</code>)如果某个规则需要一个<code>file_path/file.001.txt</code>的文件. snakemake在进行查找的时候就会发现这个文件的命名符合<code>complex_conversion</code>下的<code>output</code>规定的模式, 因此snakemake认为<code>file_path/file.001.txt</code>由该规则产生, 并将<code>dataset</code>设定为”file_path”, <code>group</code>设定为”001”, 然后把这两个变量向上传递到<code>input</code>, 继续进行依赖解析.</p><p>如此依赖, 当请求的结果文件是按照一定规则去命名的(通常来说会有样品&#x2F;项目ID之类的信息), 就可以通过<code>wildcard</code>来匹配每个样品&#x2F;项目需要进行哪些步骤, 然后自动生成完整的流程路线并开始执行.</p><h2 id="snakemake-conda"><a href="#snakemake-conda" class="headerlink" title="snakemake &amp; conda"></a>snakemake &amp; conda</h2><p>为了保证已完成流程的可重复性, snakemake内置了使用conda来进行流程依赖部署的功能.<br>不过这个功能和我最开始理解的不太一样.</p><h2 id="snakemake-容器"><a href="#snakemake-容器" class="headerlink" title="snakemake &amp; 容器"></a>snakemake &amp; 容器</h2><p>除了conda, snakamake还支持使用容器来进行依赖部署. 只不过这个容器并非最火热的docker, 而是singularity. 我也是用了snakemake才知道原来docker只是容器计数中的一种实现, 只是它特别的广为人知. snakemake支持的singularity与docker相比的特点是:</p><ul><li>不需要root权限</li><li>更低的资源占用</li></ul><p>该项目从3.0版本开始从c++迁移到了go, 我虽然克服了网络压力装上了, 但应该是由于发行版的问题不能正常使用, 所以暂时没有实际的使用经验.</p><h2 id="问题解决方案收集"><a href="#问题解决方案收集" class="headerlink" title="问题解决方案收集"></a>问题解决方案收集</h2><p>本人在使用snakemake过程中时不时会碰到一些大小问题, 由于这个软件的中文使用者似乎并不多, 英文材料虽然完善但是由于我相关的储备不足, 并不能很快从中找到解决方案, 因此将我碰到的问题&amp;解决方案收集在此, 部分问题的描述可能并不专业, 以后有机会慢慢更正</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> snakemake </tag>
            
            <tag> conda </tag>
            
            <tag> 生物信息 </tag>
            
            <tag> 流程管理 </tag>
            
            <tag> singularity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bash-it</title>
      <link href="/2018/10/29/bash-it/"/>
      <url>/2018/10/29/bash-it/</url>
      
        <content type="html"><![CDATA[<p>bash-it是受oh-my-zsh启发而创建的bash插件集合项目. 安装上bash-it不仅可以让bash界面变得更炫酷, 也可以让命令行变得更为好用</p><span id="more"></span><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>根据bash-it首页的安装教程, 很快就能够安装好</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/Bash-it/bash-it.git ~/.bash_it</span><br><span class="line">~/.bash_it/install.sh</span><br></pre></td></tr></table></figure><p>不过选择的时候要注意, 会让你选择是否保留原来的<code>.bashrc</code>以及<code>.bash_profile</code>, 当然如果不保留这俩文件也不会被删除, 只是会被备份一下, 如果安装后出了什么问题手动换回来就好了.</p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p><code>bash-it -h</code>可查看所有可使用的命令, <code>bash-it show plugins</code>可以查看所有可用的插件, 目前我只用了<code>base</code>和<code>git</code>, 其他的日后再慢慢了解好了</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/bash_it.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/bash_it.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="display"></p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 命令行 </tag>
            
            <tag> bash </tag>
            
            <tag> plugin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python命令行解析</title>
      <link href="/2018/10/22/Python%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%A7%A3%E6%9E%90/"/>
      <url>/2018/10/22/Python%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>一直都在用<code>argparse</code>写命令行解析, 但是直到前段时间才发现原来它可以用来写子命令</p><span id="more"></span><h2 id="一般参数解析"><a href="#一般参数解析" class="headerlink" title="一般参数解析"></a>一般参数解析</h2><p>一般的参数解析很简单了, 示例化一个<code>argparse</code>, 然后调用对象的添加参数方法就可以</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> RawTextHelpFormatter</span><br><span class="line">parser = argparse.ArgumentParser(</span><br><span class="line">    prog=<span class="string">&#x27;program&#x27;</span>,</span><br><span class="line">    description=<span class="string">&#x27;Some description&#x27;</span>,</span><br><span class="line">    formatter_class=RawTextHelpFormatter</span><br><span class="line">    )</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-s&#x27;</span>,</span><br><span class="line">                    <span class="built_in">help</span>=<span class="string">&quot;description for args&quot;</span>,</span><br><span class="line">                    required=<span class="literal">False</span>,</span><br><span class="line">                    <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br></pre></td></tr></table></figure><h2 id="子命令创建"><a href="#子命令创建" class="headerlink" title="子命令创建"></a>子命令创建</h2><p>子命令需要在主参数解析对象(上面是<code>parser</code>)的基础上首先创建子解析对象,然后调用这个对象的方法添加子命令</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sub_parser = parser.add_subparsers(title=<span class="string">&#x27;sub-commands&#x27;</span>,</span><br><span class="line">                                    description=<span class="string">&#x27;Some description&#x27;</span>,</span><br><span class="line">                                    <span class="built_in">help</span>=<span class="string">&#x27;Some help description&#x27;</span>)</span><br><span class="line">sub_parser_a = sub_parser.add_parser(<span class="string">&#x27;a&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Some help description&#x27;</span>)</span><br><span class="line">sub_parser_a.add_argument(<span class="string">&#x27;-s&#x27;</span>, </span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;description for args&quot;</span>,</span><br><span class="line">                        <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br></pre></td></tr></table></figure><p>这样就可以实现在主程序下定义子程序了, <code>argparse</code>还提供了一个方法, 在特定子命令被调用时, 指定运行某函数, 这个函数会接收到所有子命令下参数值组成的一个命名空间, 可以进行参数解析后开始执行子程序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sub_parser_a.set_defaults(func=subFun)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countFun</span>(<span class="params">args</span>):</span><br><span class="line">    args = <span class="built_in">vars</span>(args)</span><br><span class="line">    <span class="built_in">print</span>(args)</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><code>argparse</code>还可以实现多重子程序以及子程序参数继承主程序参数, 这个还未实际使用过, 后面再更新~</p>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 命令行解析 </tag>
            
            <tag> argparse </tag>
            
            <tag> 子命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>写一个程序真不容易</title>
      <link href="/2018/10/18/%E5%86%99%E4%B8%80%E4%B8%AA%E7%A8%8B%E5%BA%8F%E7%9C%9F%E4%B8%8D%E5%AE%B9%E6%98%93/"/>
      <url>/2018/10/18/%E5%86%99%E4%B8%80%E4%B8%AA%E7%A8%8B%E5%BA%8F%E7%9C%9F%E4%B8%8D%E5%AE%B9%E6%98%93/</url>
      
        <content type="html"><![CDATA[<p>也没太多想说的, 就纪念一下自己第一个独立写完的命令行程序~</p><!-- 摘要部分 --><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/scSeq_pub.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/scSeq_pub.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="publish"></p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 编程 </tag>
            
            <tag> 命令行程序 </tag>
            
            <tag> scSeq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>conda安装sscClust</title>
      <link href="/2018/10/09/conda%E5%AE%89%E8%A3%85sscClust/"/>
      <url>/2018/10/09/conda%E5%AE%89%E8%A3%85sscClust/</url>
      
        <content type="html"><![CDATA[<p>原来又撞到了bug….</p><span id="more"></span><p>之前尝试conda安装sscClust失败, 原来是撞到了bug, 在特殊情况下conda安装的R可能会找不到conda安装的bioconductor包, 导致在R里运行时R会重新安装相关依赖.记录完整安装方法如下(假设conda已安装完毕)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/mro/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/pro/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/</span><br><span class="line">conda config --<span class="built_in">set</span> show_channel_urls <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 之后进入~/.condarc把里面的&#x27;- defualt&#x27;删除, 这步非常关键!</span></span><br><span class="line"></span><br><span class="line">conda install -y bioconductor-SingleCellExperiment bioconductor-scran bioconductor-SC3 bioconductor-zinbwave bioconductor-BiocParallel r-base r-devtools r-rcolorbrewer r-rtsne r-class r-factoextra r-cowplot r-data.table r-ggplot2 r-mass r-rjson r-cluster r-ks r-fields r-doparallel r-plyr r-igraph r-densityclust r-e1071</span><br></pre></td></tr></table></figure><p>之后进入R补充未收录的包</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">options<span class="punctuation">(</span>repos<span class="operator">=</span><span class="string">&quot;https://mirrors.shu.edu.cn/CRAN/&quot;</span><span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span>BioC_mirror<span class="operator">=</span><span class="string">&quot;http://mirrors.ustc.edu.cn/bioc/&quot;</span><span class="punctuation">)</span></span><br><span class="line">source<span class="punctuation">(</span><span class="string">&quot;http://bioconductor.org/biocLite.R&quot;</span><span class="punctuation">)</span></span><br><span class="line">install.packages<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;RhpcBLASctl&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;ADPclust&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;varSelRF&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span>unzip <span class="operator">=</span> <span class="string">&quot;internal&quot;</span><span class="punctuation">)</span></span><br><span class="line">devtools<span class="operator">::</span>install_github<span class="punctuation">(</span><span class="string">&quot;SilenWang/sscClust&quot;</span><span class="punctuation">,</span> dependencies<span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span> ref<span class="operator">=</span><span class="string">&quot;dev&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><ul><li>最后devtools::install_github时参数一定要保证不安装依赖, 可能是构建文件有问题, 不管依赖在不在都会强制重新安装依赖?或者是有包的版本不满足?</li></ul>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R </tag>
            
            <tag> conda </tag>
            
            <tag> sscClust </tag>
            
            <tag> Bioconductor </tag>
            
            <tag> 安装问题 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker内进行conda测试</title>
      <link href="/2018/10/06/docker%E5%86%85%E8%BF%9B%E8%A1%8Cconda%E6%B5%8B%E8%AF%95/"/>
      <url>/2018/10/06/docker%E5%86%85%E8%BF%9B%E8%A1%8Cconda%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<p>装软件的时候想了想, 用conda的移植性和可行性还是更好一些, 所以想用conda再尝试一下, 顺便可以看看snakemake怎么样…</p><span id="more"></span><h2 id="新建docker并安装miniconda"><a href="#新建docker并安装miniconda" class="headerlink" title="新建docker并安装miniconda"></a>新建docker并安装miniconda</h2><ul><li>初始化一个centos 7的容器, 然后安装<code>minicoda</code>, 因为容器是新初始化的所以啥都没…要安装一下必要的东西</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --name <span class="string">&quot;conda_test&quot;</span> -dti IMAGE_ID /bin/bash</span><br><span class="line">docker <span class="built_in">exec</span> -it DOCKER_ID /bin/bash</span><br><span class="line">yum -y install wget bzip2.x86_64 vim</span><br><span class="line">wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh</span><br><span class="line">sh Miniconda3-latest-Linux-x86_64.sh</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc  <span class="comment"># conda修改了环境变量, 手动让其生效</span></span><br></pre></td></tr></table></figure><h2 id="安装R和sscClust"><a href="#安装R和sscClust" class="headerlink" title="安装R和sscClust"></a>安装R和sscClust</h2><ul><li><p>本次要模拟的是普通用户使用conda安装sscClust(root获取不可), 因此所有需要的包均不使用yum安装, R包则进入R后进行安装, 不是用conda提供的二进制版本(防止有包conda未收录, 依赖出问题).</p></li><li><p>设置conda的镜像, 然后安装R</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda/</span><br><span class="line">conda config --<span class="built_in">set</span> show_channel_urls <span class="built_in">yes</span></span><br><span class="line">conda install r</span><br></pre></td></tr></table></figure><ul><li>必要包安装, 由于conda提供的包不包含用于编译的组件, 所以还是要自己编译一部分东西</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://xmlsoft.org/libxml2/libxml2-2.7.2.tar.gz ftp://ftp.gnu.org/gnu/gsl/gsl-2.5.tar.gz https://www.openssl.org/source/openssl-1.1.1.tar.gz https://curl.haxx.se/download/curl-7.61.1.tar.gz</span><br><span class="line"></span><br><span class="line">tar xvf openssl-1.1.1.tar.gz</span><br><span class="line">tar xvf gsl-2.5.tar.gz</span><br><span class="line">tar xvf libxml2-2.7.2.tar.gz</span><br></pre></td></tr></table></figure><ul><li><p>解压后进入相应目录编译安装, 注意编译前加<code>prefix=/path/to/install</code>, 然后进行<code>PATH</code>配置, 将上述软件安装到的路径加到<code>PATH</code>最前面, 这样会优先读取</p></li><li><p>curl需要在libgit2之前</p></li><li><p>R内安装sscClust</p></li></ul><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">options<span class="punctuation">(</span>repos<span class="operator">=</span><span class="string">&quot;https://mirrors.shu.edu.cn/CRAN/&quot;</span><span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span>BioC_mirror<span class="operator">=</span><span class="string">&quot;http://mirrors.ustc.edu.cn/bioc/&quot;</span><span class="punctuation">)</span></span><br><span class="line">install.packages<span class="punctuation">(</span><span class="string">&quot;BiocInstaller&quot;</span><span class="punctuation">,</span>repos<span class="operator">=</span><span class="string">&quot;https://bioconductor.org/packages/3.7/bioc&quot;</span><span class="punctuation">)</span></span><br><span class="line">install.packages<span class="punctuation">(</span><span class="string">&quot;devtools&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h2 id="测试暂停"><a href="#测试暂停" class="headerlink" title="测试暂停"></a>测试暂停</h2><ul><li>在测试过程遇到了各种依赖问题, 由于conda提供的包不包含编译需要用的<code>*-devel</code>系列包, 如果构建需要的所有包都要从头编译相当花费时间.</li></ul><h2 id="思路变更"><a href="#思路变更" class="headerlink" title="思路变更"></a>思路变更</h2><ul><li>对于比较新, 在R源或者bioconductor获取不了的包, 查看其构建的依赖情况, 使用conda安装其依赖项后R内安装该包</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">yum install -y unzip wget curl make gcc gcc-gfortran gcc-c++ bzip2.x86_64 vim</span><br><span class="line"></span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r/</span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda/</span><br><span class="line">conda config --<span class="built_in">set</span> show_channel_urls <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">conda install -y -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda/ bioconductor-SingleCellExperiment bioconductor-scran bioconductor-SC3 bioconductor-zinbwave bioconductor-BiocParallel</span><br><span class="line"></span><br><span class="line">conda install -y r-RColorBrewer r-Rtsne r-class r-factoextra r-cowplot r-data.table r-ggplot2 r-MASS r-rjson r-cluster r-ks r-fields r-doParallel r-plyr r-igraph r-densityClust r-e1071 r-devtools</span><br></pre></td></tr></table></figure><ul><li>R内安装的部分</li></ul><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">options<span class="punctuation">(</span>repos<span class="operator">=</span><span class="string">&quot;https://mirrors.shu.edu.cn/CRAN/&quot;</span><span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span>BioC_mirror<span class="operator">=</span><span class="string">&quot;http://mirrors.ustc.edu.cn/bioc/&quot;</span><span class="punctuation">)</span></span><br><span class="line">install.packages<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;varSelRF&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;RhpcBLASctl&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;ADPclust&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span>unzip <span class="operator">=</span> <span class="string">&quot;internal&quot;</span><span class="punctuation">)</span></span><br><span class="line">source<span class="punctuation">(</span><span class="string">&quot;http://bioconductor.org/biocLite.R&quot;</span><span class="punctuation">)</span></span><br><span class="line">devtools<span class="operator">::</span>install_github<span class="punctuation">(</span><span class="string">&#x27;SilenWang/sscClust&#x27;</span><span class="punctuation">,</span> dependencies<span class="operator">=</span><span class="literal">FALSE</span><span class="punctuation">,</span> ref<span class="operator">=</span><span class="string">&quot;dev&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><ul><li>使用conda安装的r依然会有依赖问题, 包虽然安装成功, 但是会无法载入(有依赖安装不完全)</li></ul><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在无法取得root权限的情况下安装R包会特别麻烦, 还是获取权限装好必要组件后在R内编译安装比较简单, 或者让管理员装了docker之后给docker的使用权限然后自行在docker内操作比较方便.</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生物信息学 </tag>
            
            <tag> R </tag>
            
            <tag> 依赖管理 </tag>
            
            <tag> conda </tag>
            
            <tag> sscClust </tag>
            
            <tag> docker </tag>
            
            <tag> 容器 </tag>
            
            <tag> 软件安装 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>单细胞相关记录</title>
      <link href="/2018/09/28/%E5%8D%95%E7%BB%86%E8%83%9E%E7%9B%B8%E5%85%B3%E8%AE%B0%E5%BD%95/"/>
      <url>/2018/09/28/%E5%8D%95%E7%BB%86%E8%83%9E%E7%9B%B8%E5%85%B3%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>因为工作需要了解了一些单细胞研究的基本思路及方案, 写个记录, 当作整理一下</p><span id="more"></span><h1 id="总体思路"><a href="#总体思路" class="headerlink" title="总体思路"></a>总体思路</h1><p>总的来说, 单细胞测序是为了考虑细胞间的差异, 将细胞作为测序单位进行测序的一种研究方式, 目前我看的都是单细胞转录组测序, 尚不涉及基因组测序. 实现单细胞测序的实验手段我目前看到了两种:</p><ol><li>流式细胞仪分选细胞, 然后但个细胞在版孔内进行后续反应</li><li>10X Genomics提供的单细胞测序方案, 其实看原理图也有点流式的影子, 但是并不是把单个版孔中, 而是把细胞送到GEM液滴中, 在液滴内加上条码后上illumina的机器测序</li></ol><p>从原理上可以看出两种思路在建库和拆分的时候不太一样. 前者本质上是通过流式筛选后, 但个细胞在版孔中单独反应并建库. 因此本质上是将单个细胞当作单个样品, 然后混样测序.</p><p>而后者则采用了特殊的建库方式, 即使用基于GEM的实验系统, 在建库前先给每个细胞的核酸加上标签(16nt的10X Barcode以及10nt的UMI), 然后把所有核酸混在一起建库. 这样一个illumina sample index下的核酸其实来自不同细胞, 依靠核酸上的10X Barcode进行细胞数据拆分, 然后由于UMI存在, 可以依据它来进行后续的duplicate处理</p><h1 id="技术路线"><a href="#技术路线" class="headerlink" title="技术路线"></a>技术路线</h1><h2 id="基于流式的方案"><a href="#基于流式的方案" class="headerlink" title="基于流式的方案"></a>基于流式的方案</h2><ul><li>由于本质上是按照经典的方式进行转录组建库, 只是通过流式的方法将样品个体缩小到了细胞, 所以这种方案下的软件&#x2F;技术路线原则上和原来单样本的并无太大差异, 但可能会需要注意duplicate和运行效率的问题.</li></ul><h2 id="基于10X-GEM的方案"><a href="#基于10X-GEM的方案" class="headerlink" title="基于10X GEM的方案"></a>基于10X GEM的方案</h2><ul><li>由于使用了特殊的建库方式, 最方便的方式是使用10X Genomics提供的cellranger软件套件, 改软件涵盖了数据从下机到出矩阵, 以及一些下游分析(降维展示, 细胞聚类, 差异表达, marker选取)的完整分析流程, 使用还是很方便的.</li></ul><h1 id="下游分析思路"><a href="#下游分析思路" class="headerlink" title="下游分析思路"></a>下游分析思路</h1><p>细胞分类&#x2F;聚类 -&gt; 差异表达 -&gt; marker选取 -&gt; 关联?</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 生物信息学 </tag>
            
            <tag> 单细胞测序 </tag>
            
            <tag> 转录组 </tag>
            
            <tag> 10X Genomics </tag>
            
            <tag> cellranger </tag>
            
            <tag> single cell </tag>
            
            <tag> RNA-seq </tag>
            
            <tag> scRNA-seq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git使用笔记</title>
      <link href="/2018/09/28/Git%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/"/>
      <url>/2018/09/28/Git%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>很早之前就看过Git的教程, 一直没实际使用过, 现在用起来, 感觉自己有那么点像程序员了呢~</p><span id="more"></span><p>Git 是一种分布式的版本管理程序, 方便多人协作&#x2F;管理一个项目的代码. 不过对我来说, 因为绝大多数时候是单人使用, 所以对我来说更多的是在不同设备上同步我的代码了.</p><h1 id="操作方法记录"><a href="#操作方法记录" class="headerlink" title="操作方法记录"></a>操作方法记录</h1><ul><li>用户初始化, 新设备上第一次使用时需要</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;Silen Wang&quot;</span> <span class="comment"># 设置用户名称</span></span><br><span class="line">git config --global user.email <span class="string">&quot;mymail@gmail.com&quot;</span> <span class="comment"># 设置用户邮箱</span></span><br><span class="line">git config --global core.editor <span class="string">&#x27;vim&#x27;</span> <span class="comment"># 设置提价commit时使用的</span></span><br></pre></td></tr></table></figure><ul><li>克隆一个项目的所有代码:</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> PROJ_URL</span><br></pre></td></tr></table></figure><ul><li>拉取更新</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git pull <span class="comment"># 适用项目来自克隆的情况, 如果有多个来源好像要指定从哪个来源拉</span></span><br><span class="line">git pull origin master <span class="comment"># 指定拉取origin远程库的master分支上的修改</span></span><br></pre></td></tr></table></figure><ul><li>推送更新</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git push</span><br><span class="line">git push origin master <span class="comment"># 指定推送到origin的master分支, 如果不指定好像会调用某种默认情况? 具体不是很清楚</span></span><br></pre></td></tr></table></figure><ul><li>远程管理</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote <span class="comment"># 查看远程信息</span></span><br><span class="line">git remote add REMOTE_URL <span class="comment"># 添加信息的远程库</span></span><br></pre></td></tr></table></figure><ul><li>修改提交, Git在对本地文件作出修改后, 修改是存在暂存区域的, 要提交这些更改, 首先得确认提交修改</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add FILE <span class="comment"># 新增跟踪的文件/或将对文件的修改变成准备提交的状态</span></span><br><span class="line">git commit <span class="comment"># 提交所有未提交的修改, 这里会要求给一个简单的描述, 说明修改了什么东西, 通过这个描述可以回溯自己之前做了什么</span></span><br><span class="line">git commit -a <span class="comment"># 直接提交所有未提交修改, 并加上相同的描述</span></span><br></pre></td></tr></table></figure><ul><li>分支操作, 分支的概念允许创造当前项目的一个分支(就是一个备份), 然后在这个分支进行修改, 原分支(比如master)不受影响, 等修改的分支测试无问题后再将修改合并到需要修改的分支即可</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git chcekout -b dev <span class="comment"># 创建并切换到dev分支</span></span><br><span class="line">git chcekout dev <span class="comment"># 切换到dev分支</span></span><br><span class="line">git merge dev <span class="comment"># 将dev分支的改动合并到当前分支</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 命令行 </tag>
            
            <tag> Git </tag>
            
            <tag> 版本控制 </tag>
            
            <tag> 分支管理 </tag>
            
            <tag> 远程仓库 </tag>
            
            <tag> 代码同步 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gogs部署</title>
      <link href="/2018/09/21/Gogs%E9%83%A8%E7%BD%B2-md/"/>
      <url>/2018/09/21/Gogs%E9%83%A8%E7%BD%B2-md/</url>
      
        <content type="html"><![CDATA[<p>买个VPS, 一个月百分之一的流量都用不到, 确实挺浪费的…所以还是多搭点东西利用起来吧, 毕竟一个月$5呢….</p><span id="more"></span><h1 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h1><p>Gogs是一个Go语言实现的轻量级的git托管服务. 其资源占用之小, 甚至可以直接放在树莓派上.</p><p>之前虽然搭建了一次了…但是没有做记录, 这次搭的时候又查了半天….</p><p>总的来说, 使用docker部署(简单), 所以实际上配置个文件执行几个就好了, docker的安装不另外说明, archwiki中有了. 主要的安装命令:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.io/gogs/gogs</span><br></pre></td></tr></table></figure><p>然后准备一个含有下面内容的文件(<code>docker-compose.yml</code>), 执行在有这个文件下的目录执行<code>docker-compose start</code>, 就可以开始用了, gogs的访问端口是10080</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;2&quot;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  gogs:</span><br><span class="line">    image: docker.io/gogs/gogs</span><br><span class="line"></span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;10022:22&quot;</span><br><span class="line">      - &quot;10080:3000&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - /var/gogs:/data</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后为了免密码推送, 还需要设置一下ssh, 默认开启gogs之后, 内置的ssh是没有开启的, 需要编辑<code>/var/gogs/gogs/conf/app.ini</code>修改到如下样子(这是我的配置文件目录, 根据<code>volumes</code>后面实际挂载的位置修改)</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[server]</span></span><br><span class="line"><span class="attr">DOMAIN</span>           = http://XXX.XXX.XXX.XXX</span><br><span class="line"><span class="attr">HTTP_PORT</span>        = <span class="number">3000</span></span><br><span class="line"><span class="attr">ROOT_URL</span>         = http://localhost:<span class="number">10080</span>/</span><br><span class="line"><span class="attr">DISABLE_SSH</span>      = <span class="literal">false</span></span><br><span class="line"><span class="attr">SSH_PORT</span>         = <span class="number">10022</span></span><br><span class="line"><span class="attr">START_SSH_SERVER</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">OFFLINE_MODE</span>     = <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>剩下的跟github一样设置就好了~</p><h1 id="无法添加多个密钥问题解决-update-20180921"><a href="#无法添加多个密钥问题解决-update-20180921" class="headerlink" title="无法添加多个密钥问题解决(update@20180921)"></a>无法添加多个密钥问题解决(update@20180921)</h1><p>gogs 虽然自带有图形化的密钥设置界面, 但是可能时我当时拉取的版本有bug, 添加第一个密钥时是没问题的, 但是当有多台机器, 需要添加一个以上的密钥时, 在图形化界面虽然显示为添加成功, 但并不能正常的通过ssh进行免密登陆, 还需要进一步设置:</p><ul><li><p>因为我的docker容器是把<code>/data</code>挂载到容器外目录的, 所以不需要登陆docker内系统直接进行修改.</p></li><li><p>对应的文件是:<code>挂载目录/gogs/git/.ssh/authorized_keys</code>. 自行对照格式添加公钥内容进去就可以, 比如:</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command=&quot;/app/gogs/gogs serv key-1 --config=&#x27;/data/gogs/conf/app.ini&#x27;&quot;,no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA test</span><br></pre></td></tr></table></figure></li><li><p>保存后即可登陆, 不需要重启容器</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gogs部署 </tag>
            
            <tag> Docker </tag>
            
            <tag> Git托管 </tag>
            
            <tag> SSH配置 </tag>
            
            <tag> VPS </tag>
            
            <tag> gogs </tag>
            
            <tag> docker-compose </tag>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>G胖牛逼!!!!!!!!!!!!!!!</title>
      <link href="/2018/09/07/G%E8%83%96%E7%89%9B%E9%80%BC/"/>
      <url>/2018/09/07/G%E8%83%96%E7%89%9B%E9%80%BC/</url>
      
        <content type="html"><![CDATA[<p>这TM一定是历史性的一刻!</p><span id="more"></span><p>一周前看新闻说steam最新的linux版内置了一项叫steam play功能, 整合了wine及Proton, 让用户在linux上可以直接运行windows游戏, 并给出了第一批适配完成的游戏名单(27个)的时候, 我是无感的, 觉得这种技术估计还是开发阶段, 要等真的成熟又要等号长时间.</p><p>但是昨晚睡前, 觉得无聊, 就下了steam试试………………………………………</p><p>…………………………………………………………………….</p><p>哎呀真香, 真特么超级香!!!!!!!!!!!!!!!!!!!</p><p>我运行的是之前补票的仙剑4, 我特么点点鼠标, 就真的能玩了! 在一台只是core M5的破笔记本上!!!!!!!!!!!!</p><p><img src="http://7xluqf.com1.z0.glb.clouddn.com/PAL4_1.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/PAL4_1.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br><img src="http://7xluqf.com1.z0.glb.clouddn.com/PAL4_2.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/PAL4_2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br><img src="http://7xluqf.com1.z0.glb.clouddn.com/PAL4_3.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/PAL4_3.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>woc…….心情久久不能平复.</p><p>多少一般用户, 就因为没有足够的游戏玩所以离不开windows, 或者双系统尝鲜一下之后又把linux删了, 这一切在未来的一年半内有望出现翻天覆地的变化!</p><p>GTMD windows!</p>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 游戏 </tag>
            
            <tag> Steam </tag>
            
            <tag> Wine </tag>
            
            <tag> Proton </tag>
            
            <tag> 仙剑4 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>R小技巧收集</title>
      <link href="/2018/09/07/R%E5%B0%8F%E9%97%AE%E9%A2%98%E6%94%B6%E9%9B%86/"/>
      <url>/2018/09/07/R%E5%B0%8F%E9%97%AE%E9%A2%98%E6%94%B6%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<p>用R总是会碰到各种问题, 收集一下</p><span id="more"></span><h1 id="数据框操作"><a href="#数据框操作" class="headerlink" title="数据框操作"></a>数据框操作</h1><h2 id="取单列-行不返回向量"><a href="#取单列-行不返回向量" class="headerlink" title="取单列&#x2F;行不返回向量"></a>取单列&#x2F;行不返回向量</h2><ul><li>使用<code>df[]</code>的方式对数据框取子集时, 若取出的是单列&#x2F;行, 或者删除后只剩下但列&#x2F;行的话返回的对象会是向量而不再是数据框, 需要的时候要加参数指定以返回数据框</li><li>本方法对matrix一样有效</li></ul><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df<span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="operator">-</span><span class="number">2</span><span class="punctuation">,</span> drop <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><h2 id="合并数据时以row-names为key"><a href="#合并数据时以row-names为key" class="headerlink" title="合并数据时以row.names为key"></a>合并数据时以row.names为key</h2><ul><li>大多中文材料对合并时的描述都是采用某一列数据作为key进行列合并, 其实也可以以row.names作为key, 但是合并后row.name就变成一列数据了, 需要再次指定row.names</li></ul><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分两步进行</span></span><br><span class="line">merge_data <span class="operator">&lt;-</span> merge<span class="punctuation">(</span>x<span class="punctuation">,</span> y<span class="punctuation">,</span> all.x <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> by <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span></span><br><span class="line">merge_data <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>merge_data<span class="punctuation">)</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 合并成一步</span></span><br><span class="line">merge_data <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>merge<span class="punctuation">(</span>x<span class="punctuation">,</span> y<span class="punctuation">,</span> all.x <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> by <span class="operator">=</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="R中的Python-Dict替代"><a href="#R中的Python-Dict替代" class="headerlink" title="R中的Python Dict替代"></a>R中的Python Dict替代</h2><ul><li>许多网上的资料会使用list配合match函数实现类dict功能, 但其实R中的向量是可以被命名的, 通过命名向量即可实现key-value的映射, 十分方便. 不过这么做的效率是否好就不得而知了..</li></ul><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>a<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;a&quot;</span><span class="punctuation">,</span> <span class="string">&quot;b&quot;</span><span class="punctuation">,</span> <span class="string">&quot;c&quot;</span><span class="punctuation">)</span></span><br><span class="line">tmp <span class="operator">&lt;-</span> a<span class="punctuation">[</span><span class="string">&quot;a&quot;</span><span class="punctuation">]</span></span><br><span class="line">print<span class="punctuation">(</span>tmp<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R语言 </tag>
            
            <tag> R </tag>
            
            <tag> 数据操作 </tag>
            
            <tag> 数据框 </tag>
            
            <tag> 数据结构 </tag>
            
            <tag> dataframe </tag>
            
            <tag> data structure </tag>
            
            <tag> data manipulation </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo代码高亮插件</title>
      <link href="/2018/09/05/hexo%E9%AB%98%E4%BA%AE%E4%B8%BB%E9%A2%98%E6%8F%92%E4%BB%B6/"/>
      <url>/2018/09/05/hexo%E9%AB%98%E4%BA%AE%E4%B8%BB%E9%A2%98%E6%8F%92%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<p>感觉hexo默认的主题不是太好看, 想找个亮色的, 所以找了个插件来试用.</p><span id="more"></span><p>插件的地址在<a href="https://github.com/ele828/hexo-prism-plugin">这里</a>, 安装相当简单, 直接<code>npm i -S hexo-prism-plugin</code>, 就行. 然后打开博客的配置文件<code>_config.yml</code>, 关闭自带的高亮, 在下面添加这个插件的设置字段就ok了.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">highlight:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">prism_plugin:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">&#x27;preprocess&#x27;</span>    <span class="comment"># realtime/preprocess</span></span><br><span class="line">  <span class="attr">theme:</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line">  <span class="attr">line_number:</span> <span class="literal">false</span>    <span class="comment"># default false</span></span><br><span class="line">  <span class="attr">custom_css:</span> <span class="string">&#x27;path/to/your/custom.css&#x27;</span>     <span class="comment"># optional</span></span><br></pre></td></tr></table></figure><p>之后像往常一样更新就行, 该插件支持多种高亮方式及自定义css, 支持的语言在上面的地址中也有.</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> 代码高亮 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>R安装github上的包出现timeout问题解决</title>
      <link href="/2018/09/05/R%E5%AE%89%E8%A3%85git%E5%8C%85%E5%87%BA%E7%8E%B0timeout%E9%97%AE%E9%A2%98/"/>
      <url>/2018/09/05/R%E5%AE%89%E8%A3%85git%E5%8C%85%E5%87%BA%E7%8E%B0timeout%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>R安装github上面的包有时会出现连接不到github的问题, 记录一下解决方案</p><span id="more"></span><p>本质上是加载<code>curl</code>包, 通过curl来下载的样子, 这个可能只使用于linux了.</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">options<span class="punctuation">(</span>download.file.method <span class="operator">=</span> <span class="string">&quot;libcurl&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span><span class="string">&#x27;curl&#x27;</span><span class="punctuation">)</span></span><br><span class="line">install_github<span class="punctuation">(</span>PACKAGENAME<span class="punctuation">)</span></span><br></pre></td></tr></table></figure><ul><li>重新安装的包依然不能返回对象, 尝试手动下载包然后更改源代码, 直接从源代码安装</li></ul><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">install.packages<span class="punctuation">(</span>path_to_file<span class="punctuation">,</span> repos <span class="operator">=</span> <span class="literal">NULL</span><span class="punctuation">,</span> type<span class="operator">=</span><span class="string">&quot;source&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R </tag>
            
            <tag> github </tag>
            
            <tag> 包安装 </tag>
            
            <tag> timeout </tag>
            
            <tag> curl </tag>
            
            <tag> 手动安装 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker使用记录</title>
      <link href="/2018/09/02/docker%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/"/>
      <url>/2018/09/02/docker%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>为了充分利用二手不出去的烂设备…我决定自己搭服务器积累经验…考虑到搭建的东西的移植性, 使用docker放在容器内执行, 这样以后方面迁移与使用.</p><span id="more"></span><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>环境系统使用manjaro, 毕竟这个我最熟悉. 并且archwiki能为许多奇怪的问题提供帮助, 安装docker的话很简单:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S docker</span><br><span class="line"><span class="comment"># 为了让普通用户使用docker, 需要添加相应用户组并把要使用的用户加入组中</span></span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo gpasswd -a <span class="variable">$&#123;USER&#125;</span> docker</span><br><span class="line"><span class="comment"># 上面用usermod命令也可以:</span></span><br><span class="line">sudo usermod -Ga docker <span class="variable">$&#123;USER&#125;</span></span><br><span class="line"><span class="comment"># 如果已经启用过则`restart`, 不需要`enable`</span></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure><p>为加快镜像(images)拉取速度, 设施dockerhub的国内镜像源(registry mirror), 配置文件是<code>/etc/docker/daemon.json</code>, 配置完成后执行<code>sudo systemctl restart docker</code>:</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn/&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="镜像创建及镜像内部操作"><a href="#镜像创建及镜像内部操作" class="headerlink" title="镜像创建及镜像内部操作"></a>镜像创建及镜像内部操作</h1><p>准备在镜像内安装R并安装<code>sscClust</code>包, 公司的服务器是CentOS6, 所以使用拉取相应镜像:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull centos:6</span><br></pre></td></tr></table></figure><p>但是在进行了上述拉取之后, 一直不能正常的运行镜像, 根据<a href="https://forums.docker.com/t/docker-run-it-has-started-failing-with-status-139/18309">这里</a>的描述, 似乎这是官方镜像有问题, 所以改为拉取了<code>centos:7</code>, 确实在更换版本后正常启动.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -dti IMAGE_ID /bin/bash</span><br><span class="line"><span class="comment"># 登陆入dcoker进行操作, 注意, 登陆后是root, 操作小心...</span></span><br><span class="line">docker <span class="built_in">exec</span> -it CONTAINER_ID /bin/bash</span><br></pre></td></tr></table></figure><p>登陆后安装vim, 对环境变量作基本设置, 然后开始安装R</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line"><span class="comment"># 更改镜像源</span></span><br><span class="line">yum install wget</span><br><span class="line"><span class="built_in">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak</span><br><span class="line"><span class="built_in">mv</span> /etc/yum.repos.d/epel.repo /etc/yum.repos.d/epel.repo.bak</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"><span class="comment"># 不同的镜像源包版本会不一样, 删除已有缓存防止报错</span></span><br><span class="line">yum clean all</span><br><span class="line">yum -y makecache</span><br><span class="line">yum -y install R</span><br></pre></td></tr></table></figure><p>补充R包安装需要的一些系统软件包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y openssl-devel libcurl-devel libxml2-devel gsl-devel</span><br></pre></td></tr></table></figure><p>之后进入R开始安装<code>sscClust</code>(安装R本来就会自动安装一大堆依赖, 安装这个包的时候会有更多依赖…)</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">options<span class="punctuation">(</span><span class="string">&quot;repos&quot;</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span>CRAN<span class="operator">=</span><span class="string">&quot;https://mirrors.ustc.edu.cn/CRAN/&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">options<span class="punctuation">(</span>BioC_mirror<span class="operator">=</span><span class="string">&quot;http://mirrors.ustc.edu.cn/bioc/&quot;</span><span class="punctuation">)</span></span><br><span class="line">source<span class="punctuation">(</span><span class="string">&quot;http://bioconductor.org/biocLite.R&quot;</span><span class="punctuation">)</span></span><br><span class="line">install.packages<span class="punctuation">(</span><span class="string">&quot;devtools&quot;</span><span class="punctuation">)</span></span><br><span class="line">biocLite<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&#x27;SingleCellExperiment&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;scran&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;SC3&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;zinbwave&#x27;</span><span class="punctuation">,</span> <span class="string">&#x27;BiocParallel&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">devtools<span class="operator">::</span>install_github<span class="punctuation">(</span><span class="string">&quot;Japrin/sscClust&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure><p>如果网络没有特别问题, <code>sscClust</code>应该是能够顺利安装的, 最后将docker容器的更改保存为一个镜像(image), 保存完成后会显示一串sha256值, 使用<code>docker images</code>可看到已经保存下来的镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit CONTAINER_ID r/sscclust</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R语言 </tag>
            
            <tag> sscClust </tag>
            
            <tag> docker </tag>
            
            <tag> 容器技术 </tag>
            
            <tag> 镜像配置 </tag>
            
            <tag> CentOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SGE系统使用笔记</title>
      <link href="/2018/08/30/SGE%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/"/>
      <url>/2018/08/30/SGE%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>在新公司使用SGE的方式有点不太一样, 做个笔记</p><span id="more"></span><h1 id="脚本编写"><a href="#脚本编写" class="headerlink" title="脚本编写"></a>脚本编写</h1><p>脚本写完后, 并不在投递时进行参数指定, 而是写到被投递的脚本中, 然后直接<code>qsub shell.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#！/bin/bash</span></span><br><span class="line"><span class="comment">#$ -S /bin/bash          //表明此脚本为bash</span></span><br><span class="line"><span class="comment">#$ -V                    //传递当前命令的所有环境变量</span></span><br><span class="line"><span class="comment">#$ -cwd                  //将当前路径设置为工作路径</span></span><br><span class="line"><span class="comment">#$ -N WorkName           //任务名</span></span><br><span class="line"><span class="comment">#$ -o WorkName.log       //任务输出日志文件名</span></span><br><span class="line"><span class="comment">#$ -j y                  //指定任务的标准错误流是否合并到标准输出流y[es] n[o]</span></span><br><span class="line"></span><br><span class="line">shell script</span><br></pre></td></tr></table></figure><p>投递含有上述内容本质上等价于:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qsub -S -V -cwd \</span><br><span class="line">    -N WorkName \</span><br><span class="line">    -o WorkName.<span class="built_in">log</span> \</span><br><span class="line">    -j y \</span><br><span class="line">    shell script</span><br></pre></td></tr></table></figure><h1 id="qlogin的使用"><a href="#qlogin的使用" class="headerlink" title="qlogin的使用"></a>qlogin的使用</h1><p>在进行测试时, 可使用<code>qlogin</code>登陆到计算节点, 然后在计算节点环境下进行的操作与写好脚本<code>qsub</code>投递到集群上效果一致</p>]]></content>
      
      
      <categories>
          
          <category> Bioinformatics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SGE </tag>
            
            <tag> 网格引擎 </tag>
            
            <tag> qsub </tag>
            
            <tag> qlogin </tag>
            
            <tag> 集群计算 </tag>
            
            <tag> sge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pandas操作笔记</title>
      <link href="/2018/08/29/Pandas%E6%93%8D%E4%BD%9C%E7%AC%94%E8%AE%B0/"/>
      <url>/2018/08/29/Pandas%E6%93%8D%E4%BD%9C%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>最近用Pandas比较多, 把常用的东西摘抄一下备查</p><span id="more"></span><h1 id="数据读取"><a href="#数据读取" class="headerlink" title="数据读取"></a>数据读取</h1><ul><li>基本读取直接<code>read_csv</code>就可以了, 主要是涉及到一些参数</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">df = pd.read_csv(file_path, sep=<span class="string">&quot;\t&quot;</span>, index_col=<span class="number">0</span>, header=<span class="number">0</span>)</span><br><span class="line"><span class="comment"># index_col等同R里面的row.names, 都是把特定列作为行标签使用, 并且将该列从数据中去除, 如果不指定则会生成0-length的数字作为标签</span></span><br><span class="line"><span class="comment"># header函数与R里的逻辑不太一样, 默认是header=0, 即将读取的第一行作为表头, 如果不要表头的话用header=None, 如果制定别的行为表头, 则表头行以上的数据会被丢弃</span></span><br></pre></td></tr></table></figure><ul><li>在处理很大的数据时, 为防止爆内存, 需要生成迭代器分块读取文件</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="comment"># reader是以一个生成器</span></span><br><span class="line">reader = pd.read_csv(file_path, sep=<span class="string">&quot;\t&quot;</span>, iterator=<span class="literal">True</span>, chunksize=<span class="number">1000</span>))</span><br><span class="line"><span class="comment"># iterator / chunksize这两个参数指定一个就会生成迭代器, 其实如果指定了chunksize可以不写iterator了</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果生成reader时指定过chunksize, 那可可以直接调用get_chunk()</span></span><br><span class="line"><span class="comment"># 获得特定数量的行, 否则就要写get_chunk(num), 这个我还没详尽测试过</span></span><br><span class="line"><span class="comment"># 注意, 这里的行数是数据的行数, 不包括表头, 因为生成reader的时候</span></span><br><span class="line"><span class="comment"># 默认以第一行作为表头了, 所以后面生成的df都是带表头的</span></span><br><span class="line">chunk = reader.get_chunk()</span><br><span class="line">df = pd.DataFrame(chunk)</span><br></pre></td></tr></table></figure><ul><li>另外, <code>pandas</code>可以智能识别读入文件是否是压缩文件(通过扩展名识别), 所以经过压缩的文本文件只要分隔符指定无问题就可以读取, 写入时也是</li></ul><details yellow><summary> 已淘汰的`read_table` </summary>              <div class='content'>              <p>不记得从哪个版本开始, <code>read_table</code>就被放弃了, 只保留<code>read_csv</code>, 说是<code>csv</code>文件的读写效率更高处理更快</p><p>但是比较蛋疼的是生信领域其实是有大量内容都是用<code>tsv</code>文件, 或者类<code>tsv</code>文件的…</p>              </div>            </details><h1 id="数据写入"><a href="#数据写入" class="headerlink" title="数据写入"></a>数据写入</h1><ul><li>我最常用的主要是<code>tsv</code>格式和<code>xlsx</code>格式</li></ul><h2 id="普通文本文件"><a href="#普通文本文件" class="headerlink" title="普通文本文件"></a>普通文本文件</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h2 id="写入Excel"><a href="#写入Excel" class="headerlink" title="写入Excel"></a>写入Excel</h2><ul><li>写法很简单:</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.to_excel(FILE, sheet_name=<span class="string">&#x27;SHEET&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>需要注意的是如果想一次性将多个数据表写入多个sheet可以这样操作:</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.to_excel(FILE, sheet_name=<span class="string">&#x27;SHEET&#x27;</span>)</span><br></pre></td></tr></table></figure><h1 id="子集选取"><a href="#子集选取" class="headerlink" title="子集选取"></a>子集选取</h1><ul><li>与R类似, pandas也支持多种子集选取方式, 部分选取逻辑也跟R非常类似, 但是有些东西与R并不一样, 一般来说在pandas里能实现的方式R都可以, 但是反过来则不然, 这里只记录与R中选取逻辑类似的方法</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">df = pd.read_table(file_path, sep=<span class="string">&quot;\t&quot;</span>)</span><br><span class="line"><span class="comment"># 依据标签选取行列使用.loc[row, col]</span></span><br><span class="line">df = df.loc[[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>], [<span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>]]</span><br><span class="line"><span class="comment"># 注意与R不一样的是, 单取列时, 前面不可以留空, 单取行则可以后面留空</span></span><br><span class="line">df = df.loc[:, [<span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>]]</span><br><span class="line">df = df.loc[[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>], ]</span><br><span class="line"><span class="comment"># 与.loc对应有一个.iloc, 这里使用的行/列序号, 而不是标签, 注意需要从0起算</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="行列删减"><a href="#行列删减" class="headerlink" title="行列删减"></a>行列删减</h1><h1 id="遍历处理"><a href="#遍历处理" class="headerlink" title="遍历处理"></a>遍历处理</h1>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 数据分析 </tag>
            
            <tag> 数据处理 </tag>
            
            <tag> Pandas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用conda安装R包及jupyter</title>
      <link href="/2018/08/28/%E4%BD%BF%E7%94%A8conda%E5%AE%89%E8%A3%85R%E5%8C%85/"/>
      <url>/2018/08/28/%E4%BD%BF%E7%94%A8conda%E5%AE%89%E8%A3%85R%E5%8C%85/</url>
      
        <content type="html"><![CDATA[<p>由于工作需要, 得安装一篇文献中提及的一个包, 本两想着两条命令完事, 谁知道一大堆依赖要解决…然后linux下的R包都是要编译的, 这可是要了老命了…还好有conda这个东西…</p><span id="more"></span><p>说起来原来看公众号的时候还不知道为啥里面推荐的用conda来装需要的工具…这次算是体会了linux的依赖有多烦人…而且作为普通用户又没有完全权限…路被赌死了不少…像conda这种直接在自己山头自立为王的方式…虽然浪费空间, 可是非常又用啊!</p><h1 id="conda安装"><a href="#conda安装" class="headerlink" title="conda安装"></a>conda安装</h1><ul><li>conda有两个…emmm我也不知道能不能说是发行版? 一个是ancoda, 另一个是minicoda, 可以理解是完整安装和最小安装的区别, ancoda自带一套异常完整的python环境, 连jupyter都打包好了, 而miniconda除了最基本的pyton, 好像没太多别的东西了, 因为我主要是用来装r的, 所以选择了<a href="https://conda.io/miniconda.html">miniconda</a></li><li>下载到的linux安装文件是一个异常大的shell脚本, 直接运行即可开始安装</li><li>安装完之后即可调用conda命令安装想要的东西, 比如我就可以开始安装r了</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install r</span><br></pre></td></tr></table></figure><ul><li>调用conda安装的东西全部都由conda统一放置在conda的安装目录下, 里面的文件夹分布好像跟根目录的不是特别一样</li><li>在最初完成conda安装时, 如果不作特别制定, conda会改写原本的<code>~/.bash</code>文件, 在里面把conda的bin目录添加到<code>PATH</code>变量中, 但是优先级在系统默认的目录(<code>/bin</code>)之后, 因为我是要用conda的覆盖系统默认配置, 所以手动把这一行加到了<code>~/.bash_profile</code>中并把conda的bin目录调到了系统默认的前面</li><li>conda在国内也是有镜像源的, 编辑<code>~/.condarc</code>(没有可以直接创建), 加入下列内容即可使用中科大的镜像(清华的看人说有问题, 就没用了). 当然这只是个示例, <code>pkg</code>下还有其他的源, 需要的可以都添加上</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">channels:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">https://mirrors.ustc.edu.cn/anaconda/pkgs/free/</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">defaults</span></span><br><span class="line"><span class="attr">show_channel_urls:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><ul><li>之后进入R, 在里面再安装相关包就好. 这时安装的R包不会放在<code>~/R</code>下, 也是全部在conda的目录下面, 具体可参考安装时的输出.</li><li>由于R包都是要编译的, 我又是用的minicoda, 所以难免会有依赖不满足. 不满足的包可以使用<code>conda install</code>安装, 另外也可以上anconda的网站先所有有哪些版本, 再对应执行命令安装即可</li></ul><p>本次安装在conda的助力下解决了绝大多数的依赖问题, 唯一不能解决的我在本地编译后上传了…花了两天总算是把包装好了…但愿用不要出什么问题</p><h1 id="jupyter安装与配置"><a href="#jupyter安装与配置" class="headerlink" title="jupyter安装与配置"></a>jupyter安装与配置</h1><p>R放在集群上, 调试起来多少有些不便, 毕竟我习惯了Rstudio或者jupyter notebook的那种编写边测试的方式. 正好conda也能装jupyter, 就搜索了一下远程访问的配置方式.</p><ul><li>首先肯定使用conda安装jupyter了</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda install jupyter</span><br></pre></td></tr></table></figure><ul><li>完成后对jupyter进行配置</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成配置文件</span></span><br><span class="line">jupyter notebook --generate-config</span><br><span class="line"><span class="comment"># 设定密码, 根据提示输入两次即可</span></span><br><span class="line">jupyter notebook password</span><br></pre></td></tr></table></figure><ul><li>使用编辑器打开生成的配置文件(普通用户的话是, 具体看生成文件后的提示<code>~/.jupyter/jupyter_notebook_config.py</code>)</li><li>找到下面几项, 取消注释后更改相应数值, 其中密码见生成时提示的那个json文件, 里面会有一段长长的字符串, 全部复制贴过来就好</li></ul><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c.NotebookApp.ip=&#x27;*&#x27;</span><br><span class="line">c.NotebookApp.password = u&#x27;your_key_str&#x27;</span><br><span class="line">c.NotebookApp.open_browser = False # 代表启动notebook服务时不打开浏览器并访问</span><br><span class="line">c.NotebookApp.port = 8888 # 这个可以不指定, 会自动分配一个端口</span><br></pre></td></tr></table></figure><ul><li>然后就可以在能连接到集群ip的电脑上打开浏览器以<code>0.0.0.0:8888</code>的方式访问了, 输入密码即可使用</li></ul>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R语言 </tag>
            
            <tag> R </tag>
            
            <tag> conda </tag>
            
            <tag> jupyter </tag>
            
            <tag> 包管理 </tag>
            
            <tag> 环境配置 </tag>
            
            <tag> 远程访问 </tag>
            
            <tag> jupyter notebook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用minicap从手机中截图</title>
      <link href="/2018/08/28/%E4%BD%BF%E7%94%A8minicap%E4%BB%8E%E6%89%8B%E6%9C%BA%E4%B8%AD%E6%88%AA%E5%9B%BE/"/>
      <url>/2018/08/28/%E4%BD%BF%E7%94%A8minicap%E4%BB%8E%E6%89%8B%E6%9C%BA%E4%B8%AD%E6%88%AA%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<p>练习手机自动操作不可避免要涉及到截取手机当前的图像, 手机adb自带的截图实在太慢, 所以安装minicap取代之.</p><span id="more"></span><h1 id="软件编译"><a href="#软件编译" class="headerlink" title="软件编译"></a>软件编译</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆项目代码并进行初始化</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/openstf/minicap</span><br><span class="line"><span class="built_in">cd</span> minicap/</span><br><span class="line">git submodule init</span><br><span class="line">git submodule update</span><br><span class="line"><span class="comment"># 编译需要ndk(archlinuxcn源内有, 直接安装即可)</span></span><br><span class="line">sudo pacman -S android-ndk</span><br><span class="line"><span class="comment"># 进行编译, 书面包安装之后不会自行添加到bin, 需要给绝对路径运行</span></span><br><span class="line">/opt/android-ndk/ndk-build</span><br></pre></td></tr></table></figure><h1 id="软件部署到手机"><a href="#软件部署到手机" class="headerlink" title="软件部署到手机"></a>软件部署到手机</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 要使用adb连接到设备, 如果没有安装adb首先安装</span></span><br><span class="line"><span class="comment"># manjaro community里面有, 我记得官方版本是自带的, 现在用的社区发行版可能处于精简考虑没有默认安装</span></span><br><span class="line">sudo pacman -S android-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手机打开usb调试然后连接到电脑, device现实未注册的话在手机上选择允许当前设备的调试</span></span><br><span class="line">adb devices</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取手机基本信息以推送对应版本的minicap到手机</span></span><br><span class="line">ABI=$(adb shell getprop ro.product.cpu.abi | <span class="built_in">tr</span> -d <span class="string">&#x27;\r&#x27;</span>)</span><br><span class="line">SDK=$(adb shell getprop ro.build.version.sdk | <span class="built_in">tr</span> -d <span class="string">&#x27;\r&#x27;</span>)</span><br><span class="line">adb push libs/<span class="variable">$ABI</span>/minicap /data/local/tmp/</span><br><span class="line">adb push jni/minicap-shared/aosp/libs/android-<span class="variable">$SDK</span>/<span class="variable">$ABI</span>/minicap.so /data/local/tmp/</span><br><span class="line">adb shell <span class="built_in">chmod</span> 777 /data/local/tmp/minicap</span><br><span class="line"><span class="comment"># 测试是否可运行</span></span><br><span class="line">adb shell LD_LIBRARY_PATH=/data/local/tmp /data/local/tmp/minicap -P 1080x1920@1080x1920/0 –t</span><br><span class="line"><span class="comment"># 如果运行成功最后会显示&#x27;OK&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="截图"><a href="#截图" class="headerlink" title="截图"></a>截图</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前面的环境变量设定是必须的, 因为要指定运行库位置, -P后面是截图参数, 详情可参见minicap的项目网页, -s但表截图并输出到</span></span><br><span class="line"><span class="comment"># 标准输出, 所以重定向就好</span></span><br><span class="line">adb shell LD_LIBRARY_PATH=/data/local/tmp /data/local/tmp/minicap -P 1080x1920@1080x1920/0 –s &gt; /sdcard/minicap/test.jpg</span><br></pre></td></tr></table></figure><h1 id="待完成"><a href="#待完成" class="headerlink" title="待完成"></a>待完成</h1><ul><li>把上述命令封装成脚本, 然后顺便设定wifi连接的信息, 这样可以实现同时控制多个设备</li></ul>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 安卓 </tag>
            
            <tag> 截图 </tag>
            
            <tag> minicap </tag>
            
            <tag> adb </tag>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python使用Sqlite3</title>
      <link href="/2018/08/26/Python%E4%BD%BF%E7%94%A8Sqlite3/"/>
      <url>/2018/08/26/Python%E4%BD%BF%E7%94%A8Sqlite3/</url>
      
        <content type="html"><![CDATA[<p>为了以后操作使用Sqlite3做准备, 上周上班的时候特意试了一下用操作数据库的数据, 为了方便直接用了sqlite3, 没想到sqlite3并不是所有语句都支持, 并且sqlite自由的点命令是无法被python的sqlite模块调用的….</p><span id="more"></span><h2 id="简单的使用方式"><a href="#简单的使用方式" class="headerlink" title="简单的使用方式:"></a>简单的使用方式:</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3   <span class="comment"># 导入模块</span></span><br><span class="line">conn = sqlite3.connect(<span class="string">&#x27;test.db&#x27;</span>)   <span class="comment"># 连接数据库(如果不存在的话会被创建)</span></span><br><span class="line">cursor = conn.cursor()    <span class="comment"># 从数据库对象创建指针</span></span><br><span class="line">cursor.execute(<span class="string">&#x27;sql cmd&#x27;</span>)   <span class="comment"># 向数据库传入sql语句, 注意这里的操作不是立刻保存/同步到数据库中</span></span><br><span class="line">cursor.close()   <span class="comment"># 关闭指针</span></span><br><span class="line">conn.commit()   <span class="comment"># 确认更改</span></span><br><span class="line">conn.close()   <span class="comment"># 关闭连接</span></span><br></pre></td></tr></table></figure><ul><li>使用中的注意事项<ul><li>只支持标准的SQL语句, 由于使用的是sqlite, 其不支持的SQL语法一概无法使用, 也不支持使用sqlite特有的点命令, 因为这些命令本质上是在shell内执行的, 不是SQL语句</li><li>如果一定要使用点命令, 则需要使用os模块或其他可以调用shell的模块, 本质上是在执行shell命令</li><li>不是所有的操作都一定要指针对象完成, 有部分可以使用数据库对象, 这样可以少写两句, 具体见<a href="http://www.runoob.com/sqlite/sqlite-python.html">菜鸟教程网站的介绍</a></li><li>注意一定要确认更改(<code>obj.commit() </code>), 否则数据库内的内容是不会变化的</li><li>尝试使用了with的方式进行连接, 但是在with语句的范围外是不会自动断开连接的(<code>obj.close()</code>), 所以还是得老实写</li></ul></li></ul><h2 id="调用点命令的方式"><a href="#调用点命令的方式" class="headerlink" title="调用点命令的方式"></a>调用点命令的方式</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, textwrap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里是使用textwrap进行了shell命令的缩进调整, 并不必要, 只是输出的时候方便看</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd_gen</span>(<span class="params">cmd_str</span>):</span><br><span class="line">    cmd_str = textwrap.dedent(cmd_str)</span><br><span class="line">    cmd_str = cmd_str.strip()</span><br><span class="line">    <span class="keyword">return</span> cmd_str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db_file = <span class="string">&#x27;test.db&#x27;</span></span><br><span class="line">index_file = <span class="string">&#x27;index.txt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成命令, 这个写法是我从网上搜回来的, 是找到的唯一有效的写法, 具体意义日后再看...</span></span><br><span class="line">cmd = cmd_gen(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    sqlite3 &#123;db_file&#125; &lt;&lt; EOF</span></span><br><span class="line"><span class="string">    .separator &quot;\\t&quot;</span></span><br><span class="line"><span class="string">    .import &#123;index_file&#125; idx_tab</span></span><br><span class="line"><span class="string">    EOF</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(db_file=db_file, index_file=index_file))</span><br><span class="line">os.system(cmd)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 数据库 </tag>
            
            <tag> SQLite3 </tag>
            
            <tag> sqlite </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>桌面叒迁移</title>
      <link href="/2018/08/26/%E6%A1%8C%E9%9D%A2%E5%8F%92%E8%BF%81%E7%A7%BB/"/>
      <url>/2018/08/26/%E6%A1%8C%E9%9D%A2%E5%8F%92%E8%BF%81%E7%A7%BB/</url>
      
        <content type="html"><![CDATA[<p>用linux后时不时就会看见一句名言: 生命不息, 折腾不止. 不过说真的, 去年工作之后, 由于公司抠门不配电脑, 需要用自己的电脑进行工作…真的是不敢乱折腾(犹记当年删了自己的论文找不回来的绝望…). 但是在换了工作, 所有东西丢上百度云盘之后…我就又蠢蠢欲动了.</p><span id="more"></span><p>说起来本质上这次的折腾并不是由于蛋疼, 而是由于现在的系统确实叒出问题了——莫名其妙的屏幕闪烁.<br>我已经不记得这是从什么时候开始的了, 笔记本的屏幕会随机不规律的黑屏闪烁, 有时候会出现横条的雪花闪烁. 最开始我觉得可能是比本大限将之了…毕竟在淘宝工厂店买的(真的便宜…), 电脑到手的时候感觉是被翻新过的(盒子有点破, 笔记本背部的螺有磨损), 然后用了3个月键盘背光失效了. 不过在观察一段时间后发现…这个闪屏挺蹊跷的, 因为明显在外接屏幕的时候和使用浏览器的时候闪烁严重, 如果不用浏览器不外接的话, 几乎不会出事. 并且闪烁之出现在普通用户上, 如果使用root登陆…怎么玩都不会闪…<br>综上, 我判定是我又不小心动了什么配置文件导致软件有问题了, 就琢磨着重装试试(绝对不是因为联系商家要求保修被无视了~).</p><p>既然要重装, 且本子现在又不用于工作了, 那不如这次再尝试点新的~</p><p>其实本人观望deepin的dde很久了…怎么说呢…要不怎么说还是自己人了解自己人…感觉dde的团队真的很会抓主国内用户的需求点, 从最开始的虚有其表(一开始真的是漂亮归漂亮, 但用起来bug一大堆还不让自定义的那种), 到现在的颜值依旧, 并且功能 &amp; 易用性 &amp; 性能都有提升…真的是进步神速. 以至于dde在国际上也有了不少用户(deepin的国际区还是有挺多人发帖的, manjaro的社区维护发行版板块也经常有人讨论deepin).</p><p>虽然我之前每次dde有最新的社区发行版, 都会下一个live cd来试试, 不过奈何一是有些xfce的快捷键和功能deepin里面没有, 而是本次版本之前, deepin的资源消耗和&#x2F;流畅性&#x2F;稳定性还是远不如xfce, 所以都是试了一晚上最终没有安装到实机上.</p><p>这次就不一样了, 一来我不需要用个人笔记本工作了, 二来现在相对比较闲, 也不差那点时间去适应新的操作模式了, 加上deepin前两天更新了15.7, manjaro的deepin源也得到更新了. 所以果断格了电脑开始使用.</p><p>不得不说…头几个小时的感受根之前的差异还是不大, 不过过了两天之后其实也在逐渐适应了…所以人哪…一旦接受了设定…</p><p>另外我还发现了一个hin牛逼的事情: deepin<em>去年就已经内置了触控板手势操作了.</em> 支持三指最大化及还原窗口, 以及快速将窗口左右分割. 有了这个手势能很大程度上缓解不能<code>super+鼠标拖动窗口</code>带来的不习惯. 注意这个手势目前是dde内置的, 并且与<code>libinput-gesture</code>并不互斥, 所以如果再安装一份<code>libinput-gesture</code>, 是会俩手势同时打架的…dde内置的手势在控制面板里每见到开关, 默认为开, 可以通过dconf软件内搜索’gesture’找到对应选项并关闭. 目前的dde手势配置文件是: <code>/usr/share/dde-daemon/gesture.json</code>, 是json格式, 感觉比<code>libinput-gesture</code>更容易看懂.</p><p>还是附上我历代的桌面截图:</p><ul><li><p>Mint(Cinnamon)<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-02-28%2016:51:03%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-02-28%2016:51:03%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br><img src="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-03-06%2021:56:24%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-03-06%2021:56:24%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></li><li><p>Manjaro(Cinnamon)<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/Manjaro-desktop-2016-05-15%2020-55-08%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/Manjaro-desktop-2016-05-15%2020-55-08%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></li><li><p>Manjaro(Xfce)<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/desktop.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/desktop.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br><img src="http://7xluqf.com1.z0.glb.clouddn.com/consel.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/consel.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></li><li><p>Manjaro(deepin)<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/deepin_desktop.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/deepin_desktop.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br><img src="http://7xluqf.com1.z0.glb.clouddn.com/deepin_desktop2.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/deepin_desktop2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Deepin </tag>
            
            <tag> Manjaro </tag>
            
            <tag> 桌面环境 </tag>
            
            <tag> DDE </tag>
            
            <tag> 触控板手势 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>换工作小记</title>
      <link href="/2018/08/14/%E6%8D%A2%E5%B7%A5%E4%BD%9C%E5%B0%8F%E8%AE%B0/"/>
      <url>/2018/08/14/%E6%8D%A2%E5%B7%A5%E4%BD%9C%E5%B0%8F%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>旧坑跳新坑, 也不知道是不是越来越坑…</p><span id="more"></span><p>2017年7月, 我终于告别学生身份正式参加工作. 岗位是生物信息工程师, 就职单位天津诺禾致源.</p><p>2018年8月, 氪着命勉强完成了工作交接, 总算是在一年零一个月后顺利离开了诺禾. 新公司为杭州瑞普基因, 仍然是生物信息工程师.</p><p>对于前东家本来没太多感想, 虽然真的从提前转正开始就疯狂氪命了, 但总算是学到了东西, 付出也算有了回报. 但是偶然了解了公司IT组的状况之后…请容我把心里的MMP大声喊出来, 然后祝还在坑的小伙伴早日找到好的下家, 脱离这个天坑…</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工作变动 </tag>
            
            <tag> 生物信息工程师 </tag>
            
            <tag> 诺禾致源 </tag>
            
            <tag> 瑞普基因 </tag>
            
            <tag> 职业发展 </tag>
            
            <tag> job-change </tag>
            
            <tag> bioinformatics-engineer </tag>
            
            <tag> career-development </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>正则匹配符号收录</title>
      <link href="/2018/07/29/%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D%E7%AC%A6%E5%8F%B7%E6%94%B6%E5%BD%95/"/>
      <url>/2018/07/29/%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D%E7%AC%A6%E5%8F%B7%E6%94%B6%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>正则在很多时候时候都还是相当实用的的, 然而不同程序中正则的写法总用些差异, 所以做个cheatsheet备查不亏~</p><span id="more"></span><h1 id="基本通用部分"><a href="#基本通用部分" class="headerlink" title="基本通用部分"></a>基本通用部分</h1><p>表格来源:<a href="http://www.cnblogs.com/yirlin/archive/2006/04/12/373222.html">yirlin的博客</a></p><ul><li><code>\</code>: 将下一个字符标记为一个特殊字符、或一个原义字符、或一个 向后引用、或一个八进制转义符。例如，<code>n</code> 匹配字符 <code>n</code>。<code>\n</code> 匹配一个换行符。序列 <code>\\</code> 匹配 <code>\</code> 而 <code>\(</code> 则匹配 <code>(</code>。</li><li><code>^</code>: 匹配输入字符串的开始位置。如果设置了 RegExp 对象的 Multiline 属性，^ 也匹配 <code>\n</code> 或 <code>\r</code> 之后的位置。</li><li><code>\$</code>: 匹配输入字符串的结束位置。如果设置了RegExp 对象的 Multiline 属性，<code>\$</code> 也匹配 <code>\n</code> 或 <code>\r</code> 之前的位置。</li><li><code>*</code>: 匹配前面的子表达式零次或多次。例如，<code>zo*</code> 能匹配 <code>z</code> 以及 <code>zoo</code>。<code>*</code> 等价于<code>&#123;0,&#125;</code>。</li><li><code>+</code>: 匹配前面的子表达式一次或多次。例如，<code>zo+</code> 能匹配 <code>zo</code> 以及 <code>zoo</code>，但不能匹配 <code>z</code>。+ 等价于 <code>&#123;1,&#125;</code>。</li><li><code>?</code>: 匹配前面的子表达式零次或一次。例如，<code>do(es)?</code> 可以匹配 <code>do</code> 或 <code>does</code> 中的<code>do</code> 。? 等价于 <code>&#123;0,1&#125;</code>。</li><li><code>&#123;n&#125;</code>: n 是一个非负整数。匹配确定的 n 次。例如，<code>o&#123;2&#125;</code> 不能匹配 <code>Bob</code> 中的 <code>o</code>，但是能匹配 <code>food</code> 中的两个 o。</li><li><code>&#123;n,&#125;</code>: n 是一个非负整数。至少匹配n 次。例如，<code>o&#123;2,&#125;</code> 不能匹配 <code>Bob</code> 中的 <code>o</code>，但能匹配 <code>foooood</code> 中的所有 o。<code>o&#123;1,&#125;</code> 等价于 <code>o+</code>。<code>o&#123;0,&#125;</code> 则等价于 <code>o*</code>。</li><li><code>&#123;n,m&#125;</code>: m 和 n 均为非负整数，其中n &lt;&#x3D; m。最少匹配 n 次且最多匹配 m 次。例如，<code>o&#123;1,3&#125;</code> 将匹配 <code>fooooood</code> 中的前三个 o。<code>o&#123;0,1&#125;</code> 等价于 <code>o?</code>。请注意在逗号和两个数之间不能有空格。</li><li><code>?</code>: 当该字符紧跟在任何一个其他限制符 (<code>*, +, ?, &#123;n&#125;, &#123;n,&#125;, &#123;n,m&#125;</code>) 后面时，匹配模式是非贪婪的。非贪婪模式尽可能少的匹配所搜索的字符串，而默认的贪婪模式则尽可能多的匹配所搜索的字符串。例如，对于字符串 <code>oooo</code>，<code>o+?</code> 将匹配单个 <code>o</code>，而 <code>o+</code> 将匹配所有 <code>o</code>。</li><li><code>.</code>: 匹配除 <code>\n</code> 之外的任何单个字符。要匹配包括 <code>\n</code> 在内的任何字符，请使用象 <code>[.\n]</code> 的模式。</li><li><code>(pattern)</code>: 匹配 pattern 并获取这一匹配。所获取的匹配可以从产生的 Matches 集合得到，在VBScript 中使用 SubMatches 集合，在JScript 中则使用 $0…$9 属性。要匹配圆括号字符，请使用 <code>\(</code> 或 <code>\)</code>。</li><li><code>(?:pattern)</code>: 匹配 pattern 但不获取匹配结果，也就是说这是一个非获取匹配，不进行存储供以后使用。这在使用”或”字符来组合一个模式的各个部分是很有用。例如， <code>industr(?:y|ies)</code> 就是一个比 <code>industry|industries</code> 更简略的表达式。</li><li><code>(?=pattern)</code>: 正向预查，在任何匹配 pattern 的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如，<code>Windows (?=95|98|NT|2000)</code> 能匹配 <code>Windows 2000</code> 中的 <code>Windows</code> ，但不能匹配 <code>Windows 3.1</code> 中的 <code>Windows</code>。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始。</li><li><code>(?!pattern)</code>负向预查，在任何不匹配 pattern 的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如<code>Windows (?!95|98|NT|2000)</code> 能匹配 <code>Windows 3.1</code> 中的 <code>Windows</code>，但不能匹配 <code>Windows 2000</code> 中的 <code>Windows</code>。预查不消耗字符，也就是说，在一个匹配发生后，在最后一次匹配之后立即开始下一次匹配的搜索，而不是从包含预查的字符之后开始</li><li><code>x|y</code>: 匹配 x 或 y。例如，<code>z|food</code> 能匹配 <code>z</code> 或 <code>food</code>。<code>(z|f)ood</code> 则匹配 <code>zood</code> 或 <code>food</code>。</li><li><code>[xyz]</code>: 字符集合。匹配所包含的任意一个字符。例如， <code>[abc]</code> 可以匹配 <code>plain</code> 中的 <code>a</code>。</li><li><code>[^xyz]</code>: 负值字符集合。匹配未包含的任意字符。例如， <code>[^abc]</code> 可以匹配 <code>plain</code> 中的<code>p</code>。</li><li><code>[a-z]</code>: 字符范围。匹配指定范围内的任意字符。例如，<code>[a-z]</code> 可以匹配 <code>a</code> 到 <code>z</code> 范围内的任意小写字母字符。</li><li><code>[^a-z]</code>: 负值字符范围。匹配任何不在指定范围内的任意字符。例如，<code>[^a-z]</code> 可以匹配任何不在 <code>a</code> 到 <code>z</code> 范围内的任意字符。</li><li><code>\b</code>: 匹配一个单词边界，也就是指单词和空格间的位置。例如， <code>er\b</code>可以匹配<code>never</code> 中的 <code>er</code>，但不能匹配 <code>verb</code> 中的 <code>er</code>。</li><li><code>\B</code>: 匹配非单词边界。<code>er\B</code> 能匹配 <code>verb</code> 中的 <code>er</code>，但不能匹配 <code>never</code> 中的 <code>er</code>。</li><li><code>\cx</code>: 匹配由 x 指明的控制字符。例如， <code>\cM</code> 匹配一个 Control-M 或回车符。x 的值必须为 A-Z 或 a-z 之一。否则，将 c 视为一个原义的 <code>c</code> 字符。</li><li><code>\d</code>: 匹配一个数字字符。等价于 <code>[0-9]</code>。</li><li><code>\D</code>: 匹配一个非数字字符。等价于 <code>[^0-9]</code>。</li><li><code>\f</code>: 匹配一个换页符。等价于 <code>\x0c</code> 和 <code>\cL</code>。</li><li><code>\n</code>: 匹配一个换行符。等价于 <code>\x0a</code> 和 <code>\cJ</code>。</li><li><code>\r</code>: 匹配一个回车符。等价于 <code>\x0d</code> 和 <code>\cM</code>。</li><li><code>\s</code>: 匹配任何空白字符，包括空格、制表符、换页符等等。等价于 <code>[\f\n\r\t\v]</code>。</li><li><code>\S</code>: 匹配任何非空白字符。等价于<code>[^\f\n\r\t\v]</code>。</li><li><code>\t</code>: 匹配一个制表符。等价于 <code>\x09</code> 和 <code>\cI</code>。</li><li><code>\v</code>: 匹配一个垂直制表符。等价于 <code>\x0b</code> 和 <code>\cK</code>。</li><li><code>\w</code>: 匹配包括下划线的任何单词字符。等价于<code>[A-Za-z0-9_]</code>。</li><li><code>\W</code>: 匹配任何非单词字符。等价于 <code>[^A-Za-z0-9_]</code>。</li><li><code>\xn</code>: 匹配 n，其中 n 为十六进制转义值。十六进制转义值必须为确定的两个数字长。例如，<code>\x41</code> 匹配 <code>A</code>。<code>\x041</code> 则等价于 <code>\x04 &amp;1</code>。正则表达式中可以使用 ASCII 编码。.</li><li><code>\num</code>: 匹配 num，其中 num 是一个正整数。对所获取的匹配的引用。例如，<code>(.)&#39;\1</code> 匹配两个连续的相同字符。</li><li><code>\n</code>: 标识一个八进制转义值或一个向后引用。如果 <code>\n</code> 之前至少 n 个获取的子表达式，则 n 为向后引用。否则，如果 n 为八进制数字 (0-7)，则 n 为一个八进制转义值。</li><li><code>\nm</code>: 标识一个八进制转义值或一个向后引用。如果 <code>\nm</code> 之前至少有 nm 个获得子表达式，则 nm 为向后引用。如果 <code>\nm</code> 之前至少有 n 个获取，则 n 为一个后跟文字 m 的向后引用。如果前面的条件都不满足，若 n 和 m 均为八进制数字 (0-7)，则 <code>\nm</code> 将匹配八进制转义值 nm。</li><li><code>\nml</code>: 如果 n 为八进制数字 (0-3)，且 m 和 l 均为八进制数字 (0-7)，则匹配八进制转义值 nml。</li><li><code>\un</code>: 匹配 n，其中 n 是一个用四个十六进制数字表示的 Unicode 字符。例如， <code>\u00A9</code> 匹配版权符号 (?)。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 正则表达式 </tag>
            
            <tag> 正则语法 </tag>
            
            <tag> 正则符号 </tag>
            
            <tag> 正则匹配 </tag>
            
            <tag> regex </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>系统迁移记录</title>
      <link href="/2018/07/29/%E7%B3%BB%E7%BB%9F%E8%BF%81%E7%A7%BB%E8%AE%B0%E5%BD%95/"/>
      <url>/2018/07/29/%E7%B3%BB%E7%BB%9F%E8%BF%81%E7%A7%BB%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<p>自我大二开始接触linux桌面发行版起, 我就不断的在更换不同的发行版本, 折腾了几年才最后稳定使用manjaro.</p><span id="more"></span><h1 id="Mint-迁移记录"><a href="#Mint-迁移记录" class="headerlink" title="Mint 迁移记录"></a>Mint 迁移记录</h1><p>由于ubuntu挂掉, 重装ubuntu过程中出现一些问题, 索性就换成了世界人气第一的mint, 据说比ubuntu更加对新手友好, 开箱可用.</p><p>不过实践出真知…对于稍微习惯了unity的我来说并不是那么简单…</p><p>安装上倒是还好, 几乎和ubuntu的liveCD一模一样, 本来想连home都不要格式化了, 后来想想昨天重装的ubuntu依然有问题, 所以还是咬咬牙格掉了, 于是复制一些东西回来又花了时间.</p><p>安装好之后进入mint界面, 登陆的窗口真的是比ubuntu漂亮多了, 超高清晰度的美景(并不是美女&#x3D; &#x3D;|||)照片, 比ubuntu暗色调的设计感觉清爽多了. 登陆之后的界面就….花了半年去习惯的unity布局, 换回Gnome&#x2F;win样的界面, 实在是有点蛋疼.除了布局不一样, mint的显示效果对我来说感觉没有ubuntu好, 中文字体感觉发虚明显, 可能随时是Noto sans的问题? 在换了文泉驿微米黑之后大部分地方都好多了, 不过惨淡依旧不太性, 百度说温泉以在字体小的时候本来就发虚…于是鄙人直接把所有字体都调大了.</p><h2 id="输入法设置"><a href="#输入法设置" class="headerlink" title="输入法设置"></a>输入法设置</h2><p>mint本身不预置任何输入法, 虽然firefox有了, 但是没有输入法总不能完全英文百度…<br>mint的输入发在语言设置下, 虽然里面又显示支持的输入法, 但是软件源里并没有, 无法直接从软件中心安装.</p><ul><li>PPA安装代码:</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:fcitx-team/nightly</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install fcitx</span><br></pre></td></tr></table></figure><p>安装后还需要一些依赖包, 我没有使用PPA安装, 直接进入语言-&gt;输入法, 选择fcitx可以直接安装需要依赖. 安装完成后上搜狗网站下载搜狗linux版本, 安装完毕后重启(注销是否可未尝试), 输入法即可使用. 重装的时候有把之前ubuntu的&#x2F;home复制过来, 但是搜狗输入法的词库好像没有保留.</p><h2 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h2><ul><li><p>PPA安装:</p><ul><li>VirtualBox</li><li>GoldenDict</li><li>Shadowsocks-Qt5</li><li>PlayOnLinux</li><li>Okular</li><li>WizNote</li><li>R-base</li><li>Numix-circle</li></ul></li><li><p>PPA添加代码</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:hzwhuang/ss-qt5 ppa:wiznote-team ppa:numix/ppa</span><br></pre></td></tr></table></figure><ul><li>R-base直接将源信息<code>deb http://mirror.bjtu.edu.cn/cran/bin/linux/ubuntu trusty/</code>添加至软件源</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit /etc/apt/sources.list</span><br></pre></td></tr></table></figure><ul><li>PPA安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install VirtualBox GoldenDict Shadowsocks-Qt5 PlayOnLinux Okular WizNote R-base numix-icon-theme-circle kolourpaint</span><br></pre></td></tr></table></figure><ul><li>Deb安装<ul><li>mendeley</li><li>haroopad</li><li>Rstudio</li><li>bcloud</li><li>wps</li></ul></li></ul><h2 id="配置迁移"><a href="#配置迁移" class="headerlink" title="配置迁移"></a>配置迁移</h2><p>将原来的&#x2F;home进行备份, 重装完成后复制即可, 大部分软件配置会保留(firefox插件、配置丢失, 原因不明)</p><h2 id="程序设置"><a href="#程序设置" class="headerlink" title="程序设置"></a>程序设置</h2><p>由于已习惯使用unity, 对mint界面做了些许调整, 降低重适应难度.</p><ul><li>面板上移</li><li>用户小程序置于最左侧</li></ul><h2 id="Firefox设置与插件"><a href="#Firefox设置与插件" class="headerlink" title="Firefox设置与插件"></a>Firefox设置与插件</h2><p>由于firefox配置丢失, 所以特别记录一下相关设定以防下次再丢失</p><ul><li><p>使用插件</p><ul><li>Adblock Plus</li><li>FxoyProxy</li><li>Hide Cpation Titlebar Plus</li><li>Stylish</li></ul></li><li><p>Stylish设置(另一贴有,重复记录下)</p></li><li><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@-moz-document regexp(&quot;https?://(?!.+\\.coursera\\.org).*&quot;)&#123;</span><br><span class="line">*:not([class*=&quot;icon&quot;]):not(i)&#123;font-family: &quot;WenQuanYi Microhei&quot;  !important;&#125;</span><br><span class="line">    span.fui-logo-text&#123;font-family: &quot;IterCast-Icon&quot;  !important;&#125;</span><br><span class="line">    span.diffstat-bar&#123;font-family: &quot;octicons&quot;  !important;&#125;</span><br><span class="line">    span.diff-added&#123;font-family: &quot;octicons&quot;  !important;&#125;</span><br><span class="line">    #indexbutton&#123;font-family: &quot;html5test&quot;  !important;&#125;</span><br><span class="line">    .toolbox ins a&#123;font-family: &quot;2345&quot;  !important;&#125;</span><br><span class="line">    .tool_ul li a ins&#123;font-family: &quot;2345&quot;  !important;&#125;</span><br><span class="line">    .panel ins a&#123;font-family: &quot;2345&quot;  !important;&#125;</span><br><span class="line">    span.nba_matchnav_score&#123;font-family: &quot;Sans-Serif&quot;  !important;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="Ubuntu-unity-与-Mint-cinnamon使用对比"><a href="#Ubuntu-unity-与-Mint-cinnamon使用对比" class="headerlink" title="Ubuntu unity 与 Mint cinnamon使用对比"></a>Ubuntu unity 与 Mint cinnamon使用对比</h2><ul><li>显示效果&#x2F;界面布置</li></ul><p>个人是更习惯于unity的, 毕竟也用了半年, 虽然ubuntu本身的配色确实不太好看, 但是安装了numix主题, 换个壁纸之后还是挺不错的. unity的程序面板放在了左侧, 上面板用于整合标题栏, 这种设计在现在16:9的屏幕上确实是节省了很多空间, 能让更多内容显示出来. 并且ubuntu本身字体、图标都挺大的, 看习惯了换回win下以及现在的mint下一下真是有点难以适应, 即使笔记本是15.6都觉得整个世界都小了….只好强制调大字体了. ubuntu的默认字体效果感觉也比mint好, 可能也是因为字体比较大, 使用微米黑不会发虚…</p><ul><li>易用性</li></ul><p>这方面mint确实是比ubuntu好, 不愧是常年点击量第一. mint对操作的图形化程度确实更高. 设置中心相比ubuntu集成了更多的选项, 甚至登陆窗口软件源都可以通过Gui进行非常方便的管理. 文件操作上右键菜单里就可以选择以root打开, 不需要命令行操作. 当然…其实知道路径可拖拽之后命令行其实也很快就是. </p><p>细节方面也很贴心, 比如root权限打开的管理器会有特别提示, 不会出现ubuntu下傻傻分不清楚的状况. </p><p>mint面板的扩展性以及主题切换也十分方便, 有可以直接下载的资源, 不用自己另外找.</p><p>当然因为我是从unity又迁移回来的, 所以有些习惯对易用性有不小影响, 如果是对于直接从win迁移的人来说mint易用性肯定爆表. 然后我觉得在软件更新方面mint真的做的很好…它设置了对核心部分更新的特殊保护, 不会让用户轻易更新内核什么的, 这对我这种半新手又强迫症的人来说非常友好(上一个ubuntu是否因为更新挂掉至今未知).</p><ul><li>小问题<br>从3年前第一次用ubuntu系的各种发行版起, 小问题就没有断过. 像字体乱码这种由于win的用户基数问题完全不可避免. 另外一些零碎的不一定影响使用的问题….就只能期待后续修复了.<ul><li>ubuntu下遇见的小问题<ol><li>双显卡,独立显卡驱动(无法解决)</li><li>触控板(开机默认打开)</li><li>屏幕亮度(无法记忆上一次亮度)</li><li>错误报告(不知道哪里冒出来的错误提示, 没有任何实际影响)</li><li>偶尔长时间看视频时死机</li><li>偶尔卡, 不知道为何卡(程序运行不多)</li></ol></li><li>mint下小问题<ol><li>双显卡,独立显卡驱动</li><li>屏幕亮度</li><li>偶尔小卡</li><li>睡眠&#x2F;挂起无法唤醒</li><li>字体总觉得有点虚</li><li>某有线鼠标自动休眠</li><li>firefox下载菜单中点击打开文件位置firefox卡死</li></ol></li></ul></li><li>okular修复<br>安装mint后直接使用<code>sudo apt-get install okular</code>安装okular无法使用, 需要补充安装其他软件包.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install kdelibs5-plugins kdelibs5-data oxygen-icon-theme</span><br></pre></td></tr></table></figure><p>安装后可正常使用.</p><h1 id="界面重布"><a href="#界面重布" class="headerlink" title="界面重布"></a>界面重布</h1><p>人无聊的时候就会干无聊事, 前段时间不知道为什么又觉得看自己桌面不顺眼了所以就开启折腾模式.<br>其实归根结底还是更喜欢unity的布局方式, 虽然很多人觉得很奇怪, 但是我接受了这个设定之后….还真是觉得挺带感的….奈何显卡驱动我折腾不来. </p><p>最开始我的mint布局是这样:<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-02-14%2014:26:36%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-02-14%2014:26:36%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>基本上就是win(而且是xp)下的样子, 菜单-&gt;快捷启动-&gt;已开窗口, 通知栏. 本来刚从ubuntu转win的时候还保留了窗口栏按钮左置, 在误触菜单无数次之后还是换回了右边….</p><p>但是用着用着就觉得中间放已开窗口的位置实在太小, 同时开四个以上窗口标签就要被部分遮盖了, 然后因为看不见标签切换起来略蛋疼….</p><p>于是我就尝试使用dock工具尝试替代工具栏上的快捷启动, 有了下面这个布局:<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-02-28%2016:51:03%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-02-28%2016:51:03%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br>啊, 有那么一点unity的感觉呢! 不过并没unity好用就是…..<br>有尝试过使用工具栏模式, 无奈docky在工具栏模式下会被系统自带工具栏遮挡….<br>这个布局使用了几天之后又发现问题, 毕竟相当多的软件在左侧都会有些按钮啊菜单什么的….习惯直接一鼠标飞过去的我经常会误触然后打开别的程序…</p><p>于是, 我还是把docky放到了底部…<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-03-06%2021:56:24%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-03-06%2021:56:24%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><br>&#x3D; &#x3D;|||啊….于是我的桌面布局变得跟大部分gnome2时代的用户一毛一样了…….该说这个布局是经过实践检验的么……所以我的挣扎都是无意义的么…上帝…</p><h1 id="mint2manjaro"><a href="#mint2manjaro" class="headerlink" title="mint2manjaro"></a>mint2manjaro</h1><h2 id="从Ubuntu系到Arch系"><a href="#从Ubuntu系到Arch系" class="headerlink" title="从Ubuntu系到Arch系"></a>从Ubuntu系到Arch系</h2><p>鄙人从大三开始尝试使用Linux系统, 一直以来都是用的Ubuntu以及基于Ubuntu的发行版, 所以这次的系统更换为基于Arch的Manjaro算是一次比较大的改变. 其实换之前也是很忐忑, 毕竟咱出了名的脸黑….而且虽然用了挺久的linux但是其实在linux依旧是小白状态, 总怕过程中粗大事导致电脑挂掉…..不过从好在这次结果是好的, 到目前为止更换系统刚好满一周了, 个人需要用的常用软件都顺利安装了(包括游戏), 没有严重妨碍使用的问题(虽然小bug遍地…), 目前计划继续这么跑两个月. 如果两个月后系统不出太大的问题的话就可以考虑卸掉mint了.</p><h2 id="为什么选Manjaro"><a href="#为什么选Manjaro" class="headerlink" title="为什么选Manjaro"></a>为什么选Manjaro</h2><p>因为简单! 虽然我受人安利转入Arch系, 但我毕竟对linux不是那么熟悉, 所以我并没有考虑直接装原版的Arch, 而是从DistrioWatch上搜索了人气比较高的Arch衍生版, 也就是现在在用的Manjaro了.<br>虽然真正的原生Arch粉可能觉得这属于歪门邪道….毕竟Manjaro不符合Arch最精简, 把一切交给用户的理念, 但是对于我这种又想体验Pacman又不想花太多时间去细读Arch Wiki的人来说Manjaro真是非常好的解决方案…</p><h2 id="安装方案"><a href="#安装方案" class="headerlink" title="安装方案"></a>安装方案</h2><p>由于第一次使用Ubuntu系之外的Linux, 为了给自己留条后路当然是要选择双系统的安装方案了.<br>我的笔记本硬盘使用了GPT分区, 只安装了一个Linux Mint, 没有安装过任何Windows, 引导的问题解决起来还是挺方便的, 安装的时候设置让Manjaro把它的Grub2装到已经存在的EFI分区中, 然后直接手动把Linux Mint放在EFI分区中的efi文件删除就可以了.<br>之所以直接删除有两个原因:</p><ol><li>从Mint的Grub2中无法正确引导Manjaro, 但是Manjaro的Grub2可以正确引导Mint, 问题原因不明, 可能是Mint的版本太低?</li><li>不知道如何让系统自动选择用Manjaro安装的Grub2, 干脆就删掉Mint的只留Manjaro的.<br>总的来说安装挺顺利的, 跟安装Ubuntu或者Mint一样点几下鼠标就好了. 不过第一次安装完成后我尝试折腾了一下显卡的驱动, 然后桌面的分辨率变得不正常且无法复原了, 于是重新安装过一遍….</li></ol><h2 id="Manjaro-Cinnamon-Edition-与Linux-Mint的比较"><a href="#Manjaro-Cinnamon-Edition-与Linux-Mint的比较" class="headerlink" title="Manjaro(Cinnamon Edition)与Linux Mint的比较"></a>Manjaro(Cinnamon Edition)与Linux Mint的比较</h2><h3 id="桌面环境"><a href="#桌面环境" class="headerlink" title="桌面环境"></a>桌面环境</h3><p>Manjaro支持多种桌面环境, 为了减小我的迁移阻力, 我选择了搭载Cinnamon的版本.所以虽然是不同的系统了, 但是外观看上去其实没有什么不同, 在默认搭载软件上两者比较一致, 发现的不一样之处有:</p><ul><li>一些系统选项驱动程序管理需要使用”Manjaro Setting Manager”进行, 而Mint下是全部整合在设置面板中的</li><li>Mint语言与输入法位于同一设置项中, 可同时管理语言与输入法, Manjaro下仅有位于”Manjaro Setting Manager”中的独立语言设置项, 未见输入法管理</li><li>对于双显卡的电脑Manjaro默认会安装bumblebee, 并且于软件库内并未找到Nvidia Prime的相关软件包, 推测Arch系的系统里都是使用bumblebee来进行双显卡切换的</li><li>软件包管理软件于源更新软件不同</li><li>Manjaro没有默认安装字体管理程序</li><li>计算器程序不一样</li></ul><h3 id="中文化情况"><a href="#中文化情况" class="headerlink" title="中文化情况"></a>中文化情况</h3><p>这一项Manjaro比Mint好很多, 选择中文进行安装后基本上该中文化的都中文化了(包括Gimp &#x2F; Firefox &#x2F; Libre Office). 并且后续安装的软件有中文语言包的话也会一并被安装, 如Okular &#x2F; Kolour Paint 这些KDE下的软件.<br>而Mint 17经常出现中文化不全, 系统安装完毕后仅有部分常用菜单项是中文, Gimp &#x2F; Firefox &#x2F; Libre Office这些全部都是英文, 需要自己重新安装语言包. 并且后续安装的软件也都会一直是默认为英文.</p><h3 id="字体效果"><a href="#字体效果" class="headerlink" title="字体效果"></a>字体效果</h3><p> 在没有进行任何配置的情况下, 个人感觉Manjaro的效果比Mint差一些, 这个比较出乎我的意料, 因为我之前有用Live CD体验过Manjaro的KDE版本, 字体看上去挺舒服的. 使用系统设置中的字体项进行简单设置后显示效果感觉依然不如Mint, 总感觉中文字的边缘特别虚…..不过这一些可以通过安装fontconfig-ubuntu和freetype2-ubuntu这两个包解决, 安装过后可以获得和Mint一致的显示效果.</p><h3 id="常用软件获取"><a href="#常用软件获取" class="headerlink" title="常用软件获取"></a>常用软件获取</h3><p>一个基于Ubuntu, 一个基于Arch, 软件包管理自然大不同. Arch受到许多用户喜爱的原因之一就是其几乎什么都有并且随时保持最新的软件库.<br>官方库与AUR中确实是什么软件都有, 所有我在U系系统中用到的软件都能在官方库与AUR中获得. 并且像Rstudio &#x2F; sogou-pinyin &#x2F; WPS &#x2F; Steam等等一些软件以前是要自己去下载deb包或者添加PPA源进行安装的, 但是换了Manjaro后一条命令或者在Pamac中点几下鼠标就能解决了.<br>但是, 上述方便是建立在网络环境良好的情况下的.<br>像我学校的校园网, 长期不定时抽风, 本来理论下行速度就只有512kb&#x2F;s, 平常实际使用的时候一般就只有100-200kb&#x2F;s, 万一是从国外网站获取软件包, 速度能有50kb&#x2F;s我就要偷笑了…..因此实际的软件安装体验相当之糟……特别是从AUR安装, 即使勾选不需要确认, 大部分包都是要输入密码获取权限的, 因为下载太慢时间长, 装软件时无法实现自动安装, 得守在旁边一遍遍输入密码……然后还不一定能安装成功……<br>好在国内的Arch爱好者开了一个叫做”archliunxcn”的软件源造福国内用户, 源中有许多AUR中才能获取的软件, 其下载速度飞快并且安装不会出什么错误. <a href="https://wiki.archlinux.org/index.php/Unofficial_user_repositories#archlinuxcn">依据ArchWiki的指导添加”archlinuxcn”源</a>后我顺利完成了绝大部分常用软件的安装.<br>值得一提的是, 在安装软件的过程中我发现Arch库中并不是所有软件都保持最新, 比如R.<br>Arch官方库中提供的R为3.2.4版本, 而最新版本为3.3.0. 虽然AUR中的r-kml是最新的3.3.0版本, 但是我怕安装出问题所以没有考虑使用.<br>如果是使用Mint, 我可以通过添加第三方PPA方便的获取最新的R, 但Arch系的系统下并不能这么干, 于是我最后选择了编译安装, 具体安装过程参看之前的<a href="http://blog.leanote.com/post/silenseek/R-3.3.0-%E5%AE%89%E8%A3%85-Arch">另一篇记录</a>.</p><h3 id="显卡驱动"><a href="#显卡驱动" class="headerlink" title="显卡驱动"></a>显卡驱动</h3><p>Linux下的双显卡驱动一直是个我折腾不来的问题, 这也是我最早从原生Ubuntu迁移到Mint的最重要原因: 能一键安装显卡驱动.<br>可能是Manjaro在设计理念上与Mint颇有相似之处, 因此在显卡驱动这方面做得也挺好的, 系统安装之初所有驱动就默认安装好了, 并且使用时没有什么大问题, 不过我在Mint下进行显卡切换时用的是Nvidia-prime, Manjaro下似乎只能用Bumblebee. 而最近这段时间我可能只打个炉石和火炬之光2就可以了, 也并不需要用到独显, 所以暂时也不折腾了…</p><h3 id="输入法"><a href="#输入法" class="headerlink" title="输入法"></a>输入法</h3><p>Manjaro下并没有专门的输入法管理项, 直接从库安装输入法使用就成. 不得不说有搜狗拼音的感觉真好! 虽然之前在Mint下也适应了Rime, 但是总的来说还是不如搜狗顺手啊!求老天不要再让fcitx挂掉了! 我都换系统了就放过我吧!!!!!!</p><h3 id="小问题与小Bug"><a href="#小问题与小Bug" class="headerlink" title="小问题与小Bug"></a>小问题与小Bug</h3><p>不知道是不是我真的脸黑得没治了, 从我开始用Linux起, 各种小Bug就没有断过, 这次从Mint转到Manjaro有一部分也是因为Firefox的Flash说挂就挂了, 而且我还找不到解决办法……..<br>然而我转到了Manjaro下…..依然是各种小Bug不断…..整理了一下, 转Manjaro至今遇到的小问题与小Bug有:</p><ul><li>leanote默认编辑器下字体不正常(升级内核后解决)</li><li>vivaldi安装flash后闪烁(放弃使用)</li><li>启动时提示: [failed]failed to start setup virtual console(已解决)</li><li>启动时无鼠标指针, 重新登陆后指针出现(<a href="http://cncc.bingj.com/cache.aspx?q=Mouse+cursor+won%27t+appear+on+startup&d=4702496862111540&mkt=zh-CN&setlang=zh-CN&w=bFoHO6AgL5lacrZXtcV-NuAyXavoIkTi">已解决</a>)</li><li>使用截图程序的区域截图功能时程序不响应(未解决)</li><li>unzip解决乱码无效(已解决)</li><li>字体模糊(已解决)</li><li>steam 无法直接启动(已解决)</li><li>neemo 无法锁定到docky后启动, 因为docky将其辨认为root manager(未解决)</li><li>Rstudio无法输入中文(未解决)</li><li>telegram无法输入中文(已解决)</li><li>pdf不显示中文(已解决)</li><li>桌面显示不正常, 仅能使用低分辨率(原因未知, 重装解决)</li><li>文本拖动复制时, 拖动无法通过面板跨窗口(未解决)</li><li>rename不支持正则表达式(已解决)</li><li>全局快捷键小概率失灵(未解决)</li></ul><p>…问题如此之多, 以至于小伙伴说, 你用的不是Arch, 是充满Bug的Arch…<br>不过好在上述问题中并没有严重影响使用的, 并且在Manjaro下我的电脑可以正常的休眠于挂起, 全局快捷键的失灵也没有Mint下那么严重. 所以总的来说, 顺利完成了Mint到Manjaro的迁移.</p><h3 id="学习资料"><a href="#学习资料" class="headerlink" title="学习资料"></a>学习资料</h3><p>Arch Wiki的详尽细致一直为所有Arch用户及一些非Arch用户所称道, 在使用一周Arch衍生版之后我也对这一点有了一点体会. 但是对我来说, 对比Ubuntu及其衍生版, 搜索一个Arch下问题的解决办法要难得多.<br>举Vivaldi安装Flash出现闪烁这个问题为例, 我直接中文百度&#x2F;Bing&#x2F;Google”Arch Vivaldi Flash 闪烁”出不了任何有用的结果……<br>考虑到Vivaldi毕竟是小众中的小众, 所以把”Vivaldi”换成 “Chrome” &#x2F; “Chromium”, 依然找不到任何有用的结果……这个就相当尴尬了…<br>原来我在Mint下都是先搜索中文, 实在找不到才搜索英文的. 毕竟Mint基于Ubuntu, 而Ubuntu在国内的用户还是相当多的, 大部分时候都能找到有效的解决方案. 即使找不到有效解决方案, 我也能通过中文的搜索结果对问题进行初步了解, 在了解基础上尝试进行英文结果的搜索, 从而找到解决方法.<br>换了Manjaro就不行了, 且不谈国内Manjaro的用户极少(论坛贴吧等连灌水的都没有), 就连Archlinux中文论坛以及贴吧的用户活跃程度也远远不及Ubuntu,  于是中文搜索的难度实在是高了不只一点.<br>虽然Linux下非常多问题都是相通的, 以”Linux”作为关键词可以得到一部分问题的解决方案, 但是总不如直接用”Ubuntu”做关键词就能解决来得快捷舒心.</p><h2 id="迁移后感"><a href="#迁移后感" class="headerlink" title="迁移后感"></a>迁移后感</h2><p>历时一周, 目前我已经能在Manjaro下完成所有我之前完成的事情了, 虽然依然有小Bug缠身(说得像之前就没有一样…), 但是也有非常多的惊喜(搜狗能用了, 休眠&#x2F;挂起正常了)支持我继续用下去. 期待接下来两个月Manjaro能保持稳定了…….至于内核……到底是更新还是不更新好呢…….</p><h2 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h2><p>在此郑重感谢安利我入坑的晨星姐! 有个用过的人能问总是比较安心的~</p><h2 id="桌面截图留念"><a href="#桌面截图留念" class="headerlink" title="桌面截图留念"></a>桌面截图留念</h2><p>其实吧…前后两张图还真看不出有多大区别, 毕竟都是Cinnamon, 毕竟都用了风格类似的主题…</p><ul><li><p>Mint截图<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-03-06%2021:56:24%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/desktop-2016-03-06%2021:56:24%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></li><li><p>Manjaro截图<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/Manjaro-desktop-2016-05-15%2020-55-08%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/Manjaro-desktop-2016-05-15%2020-55-08%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></li></ul><h2 id="备忘录-额外安装软件与包一览"><a href="#备忘录-额外安装软件与包一览" class="headerlink" title="备忘录(额外安装软件与包一览)"></a>备忘录(额外安装软件与包一览)</h2><h3 id="官方库"><a href="#官方库" class="headerlink" title="官方库"></a>官方库</h3><ul><li>docky</li><li>virtualbox</li><li>steam</li><li>fcitx</li><li>fcitx-sogoupinyin</li><li>steam-manjaro</li><li>steam-native</li><li>kdegraphics-okular</li><li>kdegraphics-kolourpaint</li><li>texmaker</li><li>uget</li><li>qbittorrent</li><li>flashplugin</li><li>perl-rename</li><li>gnome-font-viewer</li><li>goldendict</li></ul><h3 id="Archlinuxcn"><a href="#Archlinuxcn" class="headerlink" title="Archlinuxcn"></a>Archlinuxcn</h3><ul><li>telegram-desktop</li><li>mendeleydesktop</li><li>rstudio-desktop-bin</li><li>shadowsocks-qt5</li><li>atom-editor</li></ul><h3 id="AUR"><a href="#AUR" class="headerlink" title="AUR"></a>AUR</h3><ul><li>crossover</li></ul><h3 id="下载即用"><a href="#下载即用" class="headerlink" title="下载即用"></a>下载即用</h3><ul><li>Leanote</li><li>Unipro Ugene</li><li>VirtualBox Extention Pack</li></ul><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><ul><li>R-3.3.0</li></ul><h1 id="界面设置-manjaro"><a href="#界面设置-manjaro" class="headerlink" title="界面设置(manjaro)"></a>界面设置(manjaro)</h1><p>今天在油管上看到了一个manjaro deepin 16.08的体验视频,</p><iframe width="560" height="315" src="https://www.youtube.com/embed/rMsOtFfrl6s" frameborder="0" allowfullscreen></iframe><p>于是手痒痒下了dde下来尝试.</p><p>不得不说deepin团队还是有用心做软件的, 最新的deepin15.3已经比较流畅了, 而且整个界面的设计简洁美观(在我心目中未配置状态下仅次于kde了…), 感觉很有前景呀~<br>可是毕竟现在的布局用了快半年了, 一下切去dde总觉得好空虚…另外毕竟是发展中的桌面环境, 插件和可配置(嗯…对我来说是通过GUI来配置)的地方还比较少, 所以虽然看上去很美…15分钟之后我还是卸掉了继续xfce…</p><p>…不过…在看了年轻漂亮的之后, 再回到原来的环境…咳…总觉得有点难受…(果然我也是喜新厌旧的渣…)于是又开始各种换主题…在浏览pamac里的软件时偶然发现了个插件:<code>xfce4-windowck-plugin</code>, 这个插件可以把标题栏和标题按钮放到面板上, 这一下让我想起了unity…</p><p>就想我之前说的, 我还是挺喜欢unity的布局的, 可惜之前配置的时候没有找到比较好的解决方案. 有了这个插件, 虽然不能达到unity的效果(unity同时整合标题栏和菜单到面板), 但总算也能节省一点空间了~<br>具体方案如下:</p><ul><li>安装<code>xfce4-windowck-plugin</code></li><li>将插件放到上面板</li><li>在窗口管理器里设置窗口最大化时隐藏标题栏</li><li>将所有按钮左置</li><li>将菜单按钮移到左面板, 工作区指示器移到下面板</li><li>铛铛铛铛~<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/leanote-xfce-unityLike.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/leanote-xfce-unityLike.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></li></ul><h1 id="manjaro挂掉之后"><a href="#manjaro挂掉之后" class="headerlink" title="manjaro挂掉之后"></a>manjaro挂掉之后</h1><h2 id="挂的这么突然-还要作大死"><a href="#挂的这么突然-还要作大死" class="headerlink" title="挂的这么突然, 还要作大死"></a>挂的这么突然, 还要作大死</h2><p>当初迁移的时候就有想过…以自己的人品估计半年内怎么也得挂一次, 没想到真的就挂了…<br>本周2的时候因为不明原因GUI就进不去了, 卡在了Manjaro Logo载入的地方, 切换到控制台什么也不显示…根本不知道什么问题, 然后又急着用电脑, 想着之前重装Mint的时候保留home, 重装完成后直接挂上home软件设置和个人文件都不会丢, 就想着不如重装吧!<br>然后就作!大!!死!!!了!!!!<br>重装进入GUI的时候瞬间懵逼…我的home怎么被格式化了!!!<br>推想是重装的时候手抖勾了格式化了…<br>啊…真特么是晴天霹雳…我的实验数据全放在home没有备份啊…<br>在忧伤了半个小时之后开始寻找恢复的办法, 淘宝问了好几个店发现数据恢复服务全都是win的…真是欲哭无泪…<br>尝试使用photorec以及testdisk进行了一下修复, 并没有卵用…<br>于是在周二晚…终于认清现实, 重头来过…(你妹啊…)</p><h2 id="桌面环境变更-不知道第几次了…"><a href="#桌面环境变更-不知道第几次了…" class="headerlink" title="桌面环境变更(不知道第几次了…)"></a>桌面环境变更(不知道第几次了…)</h2><p>反正整个系统要重装加重新配置, 所以就想要不要这次连桌面环境一起也换了, 毕竟上次迁移时为了最快上手保留了Cinnamon, 这次不如再学习点新东西, 反正自己一直以来都想试一试传说中的Xfce…恰好Xfce是Manjaro官方支持的桌面环境, 就直接下了Manjaro Xfce准备再次重装.</p><h2 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h2><p>Manjaro各个版本安装起来都是相当简单…点点点就好了…只要记得不要像我一样手抖去勾格式化就好…</p><h2 id="Xfce与Cinnamon"><a href="#Xfce与Cinnamon" class="headerlink" title="Xfce与Cinnamon"></a>Xfce与Cinnamon</h2><p>Xfce与之前从Unity或者Cinnamon不太相同. Unity与Cinnamon都是旨在提供漂亮易用并且功能完善的操作界面, 而Xfce是把轻量列为重要考虑因素的桌面, 所以使用起来跟前两者的感受还是很不一样的.<br>简单来说, Xfce给人的感受真的是非常非常快!不论是启动电脑还是加载程序, 速度差异真的是肉眼可见的…这个真是只有用了才有感受. 当初从Mint转到Manjaro Cinnamon就觉得速度有了明显的提升, 现在从Cinnamon换到Xfce速度又有了明显的提升…现在倒回去打开Mint真的会觉得慢的有点不能忍…<br>轻量 &amp; 简洁, Xfce非常符合这两点, 不过对于我一个从Cinnamon转过来的人来说…有些小地方太简洁了我有点难受:</p><ul><li>面板的音量插件非常之简洁…简洁到很多时候我不知道这个插件要怎么用…经常莫名其妙的调不了声音…</li><li>unzip不支持-O这个参数…导致zip文件乱码成了问题…</li><li>键盘快捷键设置的地方没有太多预设方案…需要自己先找要实现的功能的命令怎么写(我的笔记本没有专门开关触控板的功能键, 必须自己另外设置快捷键)…</li><li>自带文件管理器不支持前进后退键, 并且在设置里耶找不到相应选项…另外…这货长得真是没nemo好看…</li><li>没有disk(管理磁盘分区挂载的程序)…于是在自动挂载设置方面瞬间懵逼…</li><li>找不到自带的mousepad(文本编辑器)的设置在哪…对着白底和小得我快受不了黑字好难受…</li><li>自带音乐播放器看上去功能很多可是完全不知道怎么用…也不支持拖拽打开文件…</li><li>网络设置页面没有系统代理的设置项, 只有VPN</li></ul><p>这些问题都不是很大, 更多的属于突然转换桌面环境后的不适应. 作为用户来说, 我可以选择慢慢的改变习惯来适应, 另一方面其实也可以根据习惯去对环境作相应修改…毕竟这是linux, 只要想折腾…大部分还是可以实现的.<br>对于我个人来说, Xfce这飞一般的速度给了我足够的动力继续使用下去, 毕竟特效再炫, 也没有炫的对象, 还是自己用的流畅舒适比较重要…</p><h2 id="再看Arch-Wiki"><a href="#再看Arch-Wiki" class="headerlink" title="再看Arch Wiki"></a>再看Arch Wiki</h2><p>当时脱U系入A系的时候感觉A系系统的资料还没U系丰富, 现在Manjaro用了一个半月之后对这一点有了改观, 讲道理…丰富还是Arch Wiki丰富…一个半月以来8成以上问题都是能在里面找到答案的, Arch Wiki里没有的, 基本也很难找到答案了…<br>其实, A系的资料并不是难找, 而是没有U系的那么傻瓜式.<br>原来用U系系统时, 在网上找到的材料里一般都会附有可以直接运行的问题解决命令或代码, 只要能确定描述问题一致, 把那几行代码复制下来终端直接跑就可以了. Arch Wiki则不同, 其在编写时候大概是默认读者有一定Linux基础了, 里面会写到问题的原因与解决方案, 但很少会直接写一步到位的代码出来给大家直接用.<br>从这个角度上, Arch确实是不适合新手, 但非常适合用来学Linux.</p><h2 id="对系统进行配置"><a href="#对系统进行配置" class="headerlink" title="对系统进行配置"></a>对系统进行配置</h2><p>我的配置原则是尽量符合原来在Cinnamon下的工作习惯, 因此主要对面板进行了重拍(最后其实回到了Gnome2的布局…), 删除了部分自带软件并以原来在Cinnamon下使用的进行替换. 另外Xfce下Steam的运行库再次除了问题…之前Cinnamon下使用本地运行库后所有游戏就能正常运行, 现在Xfce下这招不好使了, 于是从Arch Wiki翻到了另外的解决方案.<br>具体如下:</p><h3 id="替换音量控制插件"><a href="#替换音量控制插件" class="headerlink" title="替换音量控制插件"></a>替换音量控制插件</h3><ul><li>卸载自带的音量控制插件<code>pa-applet</code>, 安装<code>xfce4-pulseaudio-plugin</code>, 手动将后者添加到面板(不支持在通知栏出现)</li><li>安装上述插件后调整音量时会有两个音量改变通知, 在插件上右键属性可关掉一个(另一个大概是系统自带的…不知道怎么关).</li></ul><h3 id="替换unzip包"><a href="#替换unzip包" class="headerlink" title="替换unzip包"></a>替换unzip包</h3><ul><li>安装<code>unzip-iconv</code>(archlinuxcn repo)取代<code>unzip</code></li></ul><h3 id="设置开关触控板的快捷键"><a href="#设置开关触控板的快捷键" class="headerlink" title="设置开关触控板的快捷键"></a>设置开关触控板的快捷键</h3><ul><li>解决方案来自<a href="https://wiki.archlinux.org/index.php/Touchpad_Synaptics#Software_toggle">Arch Wiki: Touchpad_Synaptics#Software_toggle</a></li><li>进入页面后将脚本代码复制后保存到制定位置, 然后进入Xfce的键盘快捷键设置页面进行按键绑定即可.</li></ul><h3 id="替换文件管理器"><a href="#替换文件管理器" class="headerlink" title="替换文件管理器"></a>替换文件管理器</h3><ul><li>自行安装<code>nemo</code>(软件源里有)</li><li>一并<code>nemo-fileroller</code>, <code>nemo-previewer</code>以及<code>nemo-share</code>已保证功能完整</li></ul><h3 id="增加磁盘管理程序"><a href="#增加磁盘管理程序" class="headerlink" title="增加磁盘管理程序"></a>增加磁盘管理程序</h3><ul><li>安装<code>gnome-disk-utility</code></li></ul><h3 id="替换文本编辑器"><a href="#替换文本编辑器" class="headerlink" title="替换文本编辑器"></a>替换文本编辑器</h3><ul><li>卸载<code>mousepad</code>, 安装<code>gedit</code></li></ul><h3 id="替换音乐播放器"><a href="#替换音乐播放器" class="headerlink" title="替换音乐播放器"></a>替换音乐播放器</h3><ul><li>卸载<code>guayadeque</code>, 安装<code>pragha</code>, <code>netease-cloud-music</code></li></ul><h3 id="配置中文输入法"><a href="#配置中文输入法" class="headerlink" title="配置中文输入法"></a>配置中文输入法</h3><ul><li>按照Arch Wiki指引为输入法声明环境变量, 使绝大部分程序可以正常输入中文</li></ul><h3 id="Steam无法启动"><a href="#Steam无法启动" class="headerlink" title="Steam无法启动"></a>Steam无法启动</h3><ul><li>解决方案来自:<a href="https://wiki.archlinux.org/index.php/Steam/Troubleshooting#Steam_runtime_issues">Arch Wiki:Steam_runtime_issues</a></li><li>按照说明添加环境变量即可</li></ul><p>##未解决的Bug</p><ul><li>Pamac内无法更新Archlinuxcn源软件, 可在命令行下使用pacman正常更新</li><li>使用无线网卡时, 挂起唤醒后无线网卡无法接受信号, 必须注销重登陆</li><li>leanote普通编辑器内字体显示不太正常</li><li>浪漫雅圆字体安装后无法正常显示</li><li>蓝牙耳机暂停键无用</li></ul><h2 id="软件清单"><a href="#软件清单" class="headerlink" title="软件清单"></a>软件清单</h2><ul><li><p>安装软件(库):<br>docky<br>virtualbox<br>steam<br>fcitx<br>fcitx-sogoupinyin<br>steam-manjaro<br>steam-native<br>kdegraphics-kolourpaint<br>texmaker<br>uget<br>qbittorrent<br>flashplugin<br>perl-rename<br>gnome-font-viewer<br>goldendict<br>telegram-desktop<br>mendeleydesktop<br>rstudio-desktop-bin<br>r<br>shadowsocks-qt5<br>atom-editor<br>inkscape</p></li><li><p>AUR:<br>crossover</p></li><li><p>下载即用:<br>ugene<br>leanote</p></li></ul><h2 id="新桌面纪念"><a href="#新桌面纪念" class="headerlink" title="新桌面纪念"></a>新桌面纪念</h2><ul><li><p>照例来一发新桌面的截图<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/desktop.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/desktop.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></li><li><p>顺带秀一下自带的下拉控制台, 实际使用起来还挺带感的~<br><img src="http://7xluqf.com1.z0.glb.clouddn.com/consel.png" class="lazyload" data-srcset="http://7xluqf.com1.z0.glb.clouddn.com/consel.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ubuntu </tag>
            
            <tag> Manjaro </tag>
            
            <tag> manjaro </tag>
            
            <tag> Linux系统 </tag>
            
            <tag> 桌面环境 </tag>
            
            <tag> linux </tag>
            
            <tag> 系统迁移 </tag>
            
            <tag> Mint </tag>
            
            <tag> 双系统 </tag>
            
            <tag> 显卡驱动 </tag>
            
            <tag> 输入法 </tag>
            
            <tag> linuxmint </tag>
            
            <tag> ubuntu </tag>
            
            <tag> desktop-environment </tag>
            
            <tag> dual-boot </tag>
            
            <tag> graphics-driver </tag>
            
            <tag> input-method </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>用R绘制地图的笔记</title>
      <link href="/2018/07/29/%E7%94%A8R%E7%BB%98%E5%88%B6%E5%9C%B0%E5%9B%BE%E7%9A%84%E7%AC%94%E8%AE%B0/"/>
      <url>/2018/07/29/%E7%94%A8R%E7%BB%98%E5%88%B6%E5%9C%B0%E5%9B%BE%E7%9A%84%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>研究生期间曾有作地图展示结果的需要, 使用R绘制过地图, 将当时的代码记录如下</p><span id="more"></span><p>#流行病学数据地图展示</p><h2 id="代码来源"><a href="#代码来源" class="headerlink" title="代码来源"></a>代码来源</h2><p>脚本代码主要改写自统计之都文章:<br><a href="http://cos.name/2014/08/r-maps-for-china/">R绘制中国地图，并展示流行病学数据</a></p><h2 id="代码本体-已包含备注"><a href="#代码本体-已包含备注" class="headerlink" title="代码本体(已包含备注)"></a>代码本体(已包含备注)</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####loading packages 载入需要的程序包####</span></span><br><span class="line">library<span class="punctuation">(</span>maptools<span class="punctuation">)</span> <span class="comment">#用于读取并操作地图数据</span></span><br><span class="line">library<span class="punctuation">(</span>ggplot2<span class="punctuation">)</span> <span class="comment">#用于绘制地图</span></span><br><span class="line"><span class="comment">####set working directory####</span></span><br><span class="line">getwd<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;/home/silen/R _Data/Map&quot;</span><span class="punctuation">)</span> <span class="comment">#设定当前工作目录,将目录设置为地图数据所在位置即可</span></span><br><span class="line"><span class="comment">####loading map data(shape data)####</span></span><br><span class="line">map <span class="operator">&lt;-</span> readShapePoly<span class="punctuation">(</span><span class="string">&quot;countries_shp/countries.shp&quot;</span><span class="punctuation">)</span> <span class="comment">#读取*.shp格式的地图数据,注意*.shp数据须和其他文件放置在一起如*.shx才可读取,否则会出现错误</span></span><br><span class="line"><span class="comment">####check loaded data 调试部分,用于查看已读取地图数据情况####</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>map<span class="punctuation">)</span></span><br><span class="line">str<span class="punctuation">(</span>map<span class="operator">$</span>NAME<span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>map<span class="operator">$</span>EU<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####Normal method, using geom_polygon / geom_path 使用基本的polygon方法与path方法进行地图绘制(暂不清楚如何展示流行病数据)####</span></span><br><span class="line">DB <span class="operator">&lt;-</span> fortify<span class="punctuation">(</span>map<span class="punctuation">)</span> <span class="comment">#重要语句,通过此步骤将读入地图数据转化为ggplot可以识别的格式</span></span><br><span class="line">p <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>DB<span class="punctuation">,</span> aes<span class="punctuation">(</span>x<span class="operator">=</span>long<span class="punctuation">,</span>y<span class="operator">=</span>lat<span class="punctuation">,</span> group <span class="operator">=</span> group<span class="punctuation">)</span><span class="punctuation">)</span> <span class="comment">#creat a plot 图形初始化,确定使用数据库并将经纬度映射到x,y轴;group=group保证绘制图形无错乱</span></span><br><span class="line"><span class="comment"># World map, using geom_path instead of geom_polygon(来自ggplot帮助文档,暂不明为何)</span></span><br><span class="line">World <span class="operator">&lt;-</span> p <span class="operator">+</span> geom_polygon<span class="punctuation">(</span>color<span class="operator">=</span><span class="string">&quot;white&quot;</span><span class="punctuation">,</span> fill <span class="operator">=</span> <span class="string">&quot;grey&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment">#使用polygon(多边形)绘制地图,并设置填充色为灰,线条色为白</span></span><br><span class="line">  theme<span class="punctuation">(</span>panel.grid.major<span class="operator">=</span>element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment">#theme()内都为样式效果设定,主要为隐藏x.y轴以及相应文字,背景去除,网格去除,</span></span><br><span class="line">        panel.background<span class="operator">=</span>element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.title.x<span class="operator">=</span>element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.title.y<span class="operator">=</span>element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.text.x<span class="operator">=</span>element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.text.y<span class="operator">=</span>element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.line<span class="operator">=</span>element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.ticks<span class="operator">=</span>element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  ggtitle<span class="punctuation">(</span><span class="string">&quot;World&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  scale_y_continuous<span class="punctuation">(</span>breaks <span class="operator">=</span> <span class="punctuation">(</span><span class="operator">-</span><span class="number">2</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">)</span> <span class="operator">*</span> <span class="number">30</span><span class="punctuation">)</span> <span class="operator">+</span><span class="comment">#忘了干嘛的</span></span><br><span class="line">  scale_x_continuous<span class="punctuation">(</span>breaks <span class="operator">=</span> <span class="punctuation">(</span><span class="operator">-</span><span class="number">4</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">)</span> <span class="operator">*</span> <span class="number">45</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">  <span class="comment">#coord_map(&quot;orthographic&quot;) #极视图</span></span><br><span class="line">  <span class="comment">#coord_map(&quot;gilbert&quot;) #ball 球形视图</span></span><br><span class="line">  coord_map<span class="punctuation">(</span><span class="string">&quot;lagrange&quot;</span><span class="punctuation">)</span> <span class="comment">#flat</span></span><br><span class="line"><span class="comment">#coord_map()内为特殊坐标轴映射,具体见ggplot包说明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####Epi method using geom_map 使用专有的geom_map方法绘制地图,可展示流行病学数据(热图)####</span></span><br><span class="line"><span class="comment">#load data and get prepared for plotting 生成需要的地图数据,载入部分在开头</span></span><br><span class="line">DB <span class="operator">&lt;-</span> fortify<span class="punctuation">(</span>map<span class="punctuation">,</span> region <span class="operator">=</span> <span class="string">&quot;NAME&quot;</span><span class="punctuation">)</span><span class="comment">#transform map shape data to object can be read by ggplot</span></span><br><span class="line"><span class="comment">#DB &lt;- transform(DB, id = iconv(id, from = &#x27;GBK&#x27;), code = iconv(code, from = &#x27;GBK&#x27;))#transform coding from GBK</span></span><br><span class="line">head<span class="punctuation">(</span>DB<span class="punctuation">)</span> <span class="comment">#查看数据情况</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>DB<span class="punctuation">)</span><span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;x&quot;</span><span class="punctuation">,</span> <span class="string">&quot;y&quot;</span><span class="punctuation">)</span><span class="comment">#change head of data, for purpose of using expand_limits() 改变数据表中变量的名称,此处为geom_map方法所需</span></span><br><span class="line"><span class="comment">#prepare Epidemiology data -&gt; crude death rate 准备好流行病学数据,注意对应问题</span></span><br><span class="line">mor <span class="operator">&lt;-</span> read.csv<span class="punctuation">(</span><span class="string">&quot;mapRate.csv&quot;</span><span class="punctuation">,</span>head <span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span> sep <span class="operator">=</span><span class="string">&quot;,&quot;</span><span class="punctuation">)</span> <span class="comment">#从*.csv文件中读入流行病学数据</span></span><br><span class="line">epi <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span>id <span class="operator">=</span> unique<span class="punctuation">(</span>sort<span class="punctuation">(</span>DB<span class="operator">$</span>id<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="comment"># 使用名为epi的数据框保存流行病学数据,从DB(地图数据)中获得所有区域(或地点)的名称(对应用)</span></span><br><span class="line">epi <span class="operator">&lt;-</span> merge<span class="punctuation">(</span>epi<span class="punctuation">,</span> mor<span class="punctuation">,</span> by.x<span class="operator">=</span> <span class="string">&quot;id&quot;</span><span class="punctuation">,</span> all.x <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span><span class="comment"># 以id变量为对应标准,合并区域名称及相应流行病数据</span></span><br><span class="line"><span class="comment">#write.csv(epi, &quot;1234.csv&quot;) #调试用</span></span><br><span class="line"><span class="comment">#epi</span></span><br><span class="line">p1 <span class="operator">&lt;-</span> ggplot<span class="punctuation">(</span>epi<span class="punctuation">,</span> fill <span class="operator">=</span> <span class="string">&quot;#595959&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">              geom_map<span class="punctuation">(</span>aes<span class="punctuation">(</span>map_id <span class="operator">=</span> id<span class="punctuation">,</span> fill <span class="operator">=</span> rate <span class="punctuation">)</span><span class="punctuation">,</span><span class="comment">#使用geom_map绘制地图并展示数据</span></span><br><span class="line">                       colour <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span></span><br><span class="line">                           map <span class="operator">=</span> DB<span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">                    expand_limits<span class="punctuation">(</span>DB<span class="punctuation">)</span> <span class="operator">+</span><span class="comment">#重要语句,无此语句无法绘制出地图,语句意义待查</span></span><br><span class="line">                    <span class="comment">#changing theme, make backgroud blank/transparent</span></span><br><span class="line">                    theme<span class="punctuation">(</span>panel.grid.major <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment">#主题设置,大致为隐藏x.y轴并去掉背景、网格,使背景透明</span></span><br><span class="line">                          panel.background <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          plot.background <span class="operator">=</span> element_rect<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;transparent&quot;</span><span class="punctuation">,</span>colour <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          legend.background <span class="operator">=</span> element_rect<span class="punctuation">(</span>fill <span class="operator">=</span> <span class="string">&quot;transparent&quot;</span><span class="punctuation">,</span>colour <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          legend.title <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          axis.title.x <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          axis.title.y <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          axis.text.x <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          axis.text.y <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          axis.line <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          axis.ticks <span class="operator">=</span> element_blank<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">                    <span class="comment">#ggtitle(&quot;World&quot;) + #title of plot</span></span><br><span class="line">                    scale_fill_gradient<span class="punctuation">(</span>high <span class="operator">=</span> <span class="string">&quot;#F70909&quot;</span><span class="punctuation">,</span> low <span class="operator">=</span> <span class="string">&quot;#E99799&quot;</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="comment">#设定热图颜色</span></span><br><span class="line">                    scale_y_continuous<span class="punctuation">(</span>breaks <span class="operator">=</span> <span class="punctuation">(</span><span class="operator">-</span><span class="number">2</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">)</span> <span class="operator">*</span> <span class="number">30</span><span class="punctuation">)</span> <span class="operator">+</span><span class="comment">#意义不明</span></span><br><span class="line">                    scale_x_continuous<span class="punctuation">(</span>breaks <span class="operator">=</span> <span class="punctuation">(</span><span class="operator">-</span><span class="number">4</span><span class="operator">:</span><span class="number">4</span><span class="punctuation">)</span> <span class="operator">*</span> <span class="number">45</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">                    <span class="comment">#coord_map(&quot;orthographic&quot;)</span></span><br><span class="line">                    <span class="comment">#coord_map(&quot;gilbert&quot;) #ball</span></span><br><span class="line">                    coord_map<span class="punctuation">(</span><span class="string">&quot;lagrange&quot;</span><span class="punctuation">)</span> <span class="comment">#flat#坐标设定</span></span><br><span class="line"><span class="comment">####print plot 输出图像,只有在需要输出透明背景图像时使用####</span></span><br><span class="line">png<span class="punctuation">(</span><span class="string">&#x27;world.png&#x27;</span><span class="punctuation">,</span>width<span class="operator">=</span><span class="number">600</span><span class="punctuation">,</span>height<span class="operator">=</span><span class="number">600</span><span class="punctuation">,</span>units<span class="operator">=</span><span class="string">&quot;px&quot;</span><span class="punctuation">,</span>bg <span class="operator">=</span> <span class="string">&quot;transparent&quot;</span><span class="punctuation">)</span><span class="comment">#设定名称、大小、大小单位以及设背景为透明</span></span><br><span class="line">print <span class="punctuation">(</span>p1<span class="punctuation">)</span><span class="comment">#输出p1</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span><span class="comment">#表示完成输出</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R语言 </tag>
            
            <tag> ggplot2 </tag>
            
            <tag> 地图绘制 </tag>
            
            <tag> 流行病学数据 </tag>
            
            <tag> 热图 </tag>
            
            <tag> shapefile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>R培训笔记</title>
      <link href="/2018/07/29/R%E5%9F%B9%E8%AE%AD%E7%AC%94%E8%AE%B0/"/>
      <url>/2018/07/29/R%E5%9F%B9%E8%AE%AD%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>研究生期间参加广东省疾控R培训的笔记, 这算是我真正意义上的编程入门课了</p><span id="more"></span><h1 id="R培训笔记整理"><a href="#R培训笔记整理" class="headerlink" title="R培训笔记整理"></a>R培训笔记整理</h1><h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><hr><p>本次培训共计3天,包含5部分内容,分别为:</p><ul><li>R语言简介及基本概念、操作</li><li>使用R绘制统计图(graph &amp; ggplot2)</li><li>时间序列分析简介以及广义线性模型(GLM)及广义相加模型(GAM)的使用</li><li>分布滞后非线性模型的使用</li><li>R中的meta分析</li></ul><h2 id="R语言简介及基本概念、操作"><a href="#R语言简介及基本概念、操作" class="headerlink" title="R语言简介及基本概念、操作"></a>R语言简介及基本概念、操作</h2><hr><h3 id="R特点"><a href="#R特点" class="headerlink" title="R特点"></a>R特点</h3><ul><li>优:免费、功能多、更新快、过程可视化、作图美观</li><li>劣:难精、不统一、学习须时间、运行慢(可通过特定包优化)</li></ul><h3 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h3><ul><li>R以及Rstudio可从官网获取安装包</li><li>package&#x2F;包 可从官网自行获取后安装,亦可软件内安装</li><li>R内函数需要先加载相应软件包后才可使用, 也仅有加载后才可在帮助中查看对应帮助.</li></ul><h3 id="软件界面简介-略"><a href="#软件界面简介-略" class="headerlink" title="软件界面简介(略)"></a>软件界面简介(略)</h3><h3 id="R常用语法"><a href="#R常用语法" class="headerlink" title="R常用语法"></a>R常用语法</h3><ul><li>大小写区分</li><li>语句由函数与赋值构成</li><li>所有符号须使用半角英文</li><li><code>#</code>用于注释,<code>#文本####</code>可索引(script模式下)</li><li>每行句末不需要特殊符号,语句未完成时程序向下行继续执行直到完成</li><li><code>&lt;-</code>为赋值符号, 如<code>x&lt;-3</code>, <code>=</code>可替换之</li><li><code>==</code>为逻辑运算符等于, <code>&amp;</code>为和, <code>|</code>为或, <code>&gt;=</code>大于等于, <code>&lt;=</code>小于等于</li><li>单双引号大多数情况无差别</li><li>路径有两种等价的表达方式, <code>C:\\R\\Data</code>等同 <code>C:/R/Data</code>; R对中文支持不佳, 尽量使用全英文路径</li><li><code>$</code>可用于提取对象内变量, 提取后可进行赋值或改写等操作.</li><li><code>[]</code>可用于提取数据框的子集</li><li><code>!</code>为反义符号</li></ul><h3 id="工作目录设置-数据读写"><a href="#工作目录设置-数据读写" class="headerlink" title="工作目录设置 &amp; 数据读写"></a>工作目录设置 &amp; 数据读写</h3><ul><li>目录:<br><code>getwd(&quot;路径&quot;)/setwd(&quot;路径&quot;)</code></li><li>数据导入:<ul><li>Excel(仅支持.csv):<br>  <code>read.csv(&quot;路径+文件名, header= , sep=&quot;,&quot;)</code></li><li>txt:<br>  <code>read.table(&quot;路径+文件名&quot;, header= , )</code></li><li>Spss(.sav):<br>  <code>read.spss(&quot;路径+文件名&quot;, use.value.labels= )</code></li><li>SAS(.sav):<br>  <code>read.sas7bdat(&quot;路径+文件名&quot;)</code></li><li>R(.rda):<br>  <code>load(&quot;路径+文件名&quot;)</code></li><li>直接读取:<br>  <code>read.table(textConnection(&quot;内容&quot;), header=, sep=)</code></li></ul></li><li>数据导出<ul><li>R:<br>  <code>save(对象, file=&quot;路径+文件名&quot;)</code></li><li>Excel(.csv):<br>  <code>write.csv(对象, file=&quot;路径+文件名&quot;)</code></li><li>txt:<br>  <code>write.table(对象, file=&quot;test.txt&quot;,sep = &quot;分隔符&quot;)</code></li></ul></li></ul><h3 id="对象-数据-查看"><a href="#对象-数据-查看" class="headerlink" title="对象(数据)查看"></a>对象(数据)查看</h3><ul><li>可使用多种函数对已经加载(创建)的对象进行查看, 每种函数的功能各有侧重.<ul><li><code>View(对象)</code>可在左上调出窗口显示对象&#x2F;数据情况;</li><li><code>head(对象, 条目数)</code>可在控制台内显示前n条数据情况, 不设置数目时默认6条;</li><li><code>tail(对象, 条目数)</code>可在控制台内显示后n条数据情况, 不设置数目时默认6条;</li><li><code>names(对象)</code> 可在控制台内显示对象内所有变量的名称(即header).</li><li><code>str(对象)</code> 可在控制台显示对象的条目数及变量数, 并显示每个变量的名称、类型以及前10条目的值.</li><li><code>dim(对象)</code> 可在控制台显示对象的条目数及变量数</li></ul></li></ul><h3 id="对象-数据-的统计描述"><a href="#对象-数据-的统计描述" class="headerlink" title="对象(数据)的统计描述"></a>对象(数据)的统计描述</h3><table><thead><tr><th>函数最基本形式</th><th>函数用途</th><th>备注</th></tr></thead><tbody><tr><td><code>summary(对象)</code></td><td>数值变量显示最大,最小,算数均,中位,四分位距;<br>分类变量显示各值对应计数; <br>若存在缺失值显示缺失值数目.</td><td></td></tr><tr><td><code>mean(对象)</code></td><td>计算算数平均数</td><td>对象须为数值型变量</td></tr><tr><td><code>sd(对象)</code></td><td>计算标准差</td><td>对象须为数值型变量</td></tr><tr><td><code>max(对象)</code></td><td>计算最大值</td><td>对象须为数值型变量</td></tr><tr><td><code>min(对象)</code></td><td>计算最小值</td><td>对象须为数值型变量</td></tr><tr><td>tips: 使用<code>rm.na=</code>参数可在计算相应统计量时自动移除缺失值</td><td></td><td></td></tr></tbody></table><h3 id="对象-数据-简单操作"><a href="#对象-数据-简单操作" class="headerlink" title="对象(数据)简单操作"></a>对象(数据)简单操作</h3><table><thead><tr><th>函数表达式</th><th>操作效果</th><th>备注</th></tr></thead><tbody><tr><td><code>names(data)&lt;-c(&quot;1&quot;,&quot;2&quot;,&quot;3&quot;)</code></td><td>将data数据框前三个变量的变量名更改为1. 2. 3</td><td>数据框内变量超出3个时, 3个之后的变量名将丢失,如果赋予名称过多则无法执行</td></tr><tr><td><code>data=rename(data,c(&quot;old1&quot;=&quot;new1&quot;, &quot;old2&quot;=&quot;new2&quot;))</code></td><td>将data数据框内变量名指定替换</td><td>rename()为plyr包函数</td></tr><tr><td><code>as.date(data)</code><br><code>as.numeric(data)</code><br><code>as.charactor(data)</code><br><code>as.factor(data)</code><br>等等</td><td>将制定变量转换类型, 转换后可赋值给对象</td><td></td></tr><tr><td><code>subset(data, select=c(v1,v2))</code><br><code>subset(data, v1==n)</code><br><code>data[row,colum]</code></td><td>提取指定数据框的行&#x2F;列</td><td>两种方式是否完全等价未知; <code>t[]</code>默认取行</td></tr><tr><td><code>data$v=data$v1+test$v2</code></td><td>对数据框内已有数据进行计算并写入到数据框中成为新变量</td><td></td></tr><tr><td><code>substr(strData,1,3)</code></td><td>从字符串变量中提取特定位数的字符串</td><td></td></tr><tr><td><code>mutate(data,)</code></td><td>对data数据框同时进行多种操作, mutate()的主要作用是简化代码</td><td></td></tr><tr><td><code>join(data1, data2, by= ,type=)</code></td><td>将不同数据框按照一定标准合并</td><td>join()函数不需要对表格进行排序</td></tr><tr><td><code>str_count(data, v)</code></td><td>对data数据框内的v变量的每一种值进行计数</td><td>stringr包函数</td></tr><tr><td><code>order(x)</code></td><td>对数据框按照特定变量进行排序</td><td>使用<code>-</code>可调节为降序</td></tr></tbody></table><h2 id="使用R绘制统计图"><a href="#使用R绘制统计图" class="headerlink" title="使用R绘制统计图"></a>使用R绘制统计图</h2><hr><ul><li>R中常用的统计图绘制包有两种:<ul><li>graph(自带): 基本作图</li><li>ggplot2(需要安装):高级作图, 作图自定义程度高, 成品漂亮</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Coding </category>
          
      </categories>
      
      
        <tags>
            
            <tag> R语言 </tag>
            
            <tag> 数据分析 </tag>
            
            <tag> R </tag>
            
            <tag> 统计绘图 </tag>
            
            <tag> 数据操作 </tag>
            
            <tag> 培训笔记 </tag>
            
            <tag> data analysis </tag>
            
            <tag> statistics </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>宿命传说2</title>
      <link href="/2016/07/22/%E5%AE%BF%E5%91%BD%E4%BC%A0%E8%AF%B42/"/>
      <url>/2016/07/22/%E5%AE%BF%E5%91%BD%E4%BC%A0%E8%AF%B42/</url>
      
        <content type="html"><![CDATA[<p>感冒伴发过敏…在家里躺了两天半, 一件正事没干, 通了宿命传说2(PSP版本)…果然打游戏对我来说比什么动力都大…</p><p>我还在上小学的时候就知道这个游戏了…那时电视上还有挺多电玩介绍节目, 报刊亭也还买得到各种游戏攻略杂志, 我至少在两个节目里、以及三本中看过宿命传说2, 印象中他们对这个游戏的评价都非常好…</p><p>然而我毕竟不是主机玩家(那时也没有可能成为, 太贵…), 对于这等大作也只能看着手痒了…不过感谢科技的进步, 十四年之后我终于有机会玩到这个游戏了~</p><p>不过不知道是不是期望越高失望越高…这个游戏很多地方真的是特别的糟心…</p><p>首先是画风…该说人变得太快么…我记得小学的时候我看片头动画觉得还是挺好的…然而现在再来看…总觉得这些个人物肖像看着好难受…奇大的眼睛…奇瘦的躯干和四肢…然后特别是主角的这个衣服…实在是有点过于…咳咳…</p><p>然后是性格设定…主要是针对主角…就好像大多数人的感觉一样…真的是典型的中二小屁孩…啊…我这果然是长大了然后无法直面过去的自己么&#x3D; &#x3D;|||</p><p>接着是地图和部分解谜…尤其是世界地图. 说实话刚开始我还觉得游戏的引导做的还挺好的, 会在小地图上标志目标地点, 然而我发现除了刚开始的兰格那遗迹可以直线走过去之外, 几乎所有的地点都是必!须!绕!路!才能到达的! 并且从小地图上根本看!!不!!出!!怎么走!!! 导致每去一个新地点几乎都要把能走的地方跑遍才能到达, 然后绕路过程中要杀无数的怪…解谜方面…有些触发点实在是做的太tm不明显了…也是导致跑来跑去杀了无数怪才明白要怎么搞…</p><p>最后是战斗…刚开始玩的时候感觉这个战斗系统还挺有意思的…可是后面敌人越来越恶心…前排的敌人难以击飞, 后排的晶术咏唱快得离谱, 万一甩一个上级晶术出来至少要跪一两个…尝试用控制的人物直接绕到后排打断, 那这个人多半跳进去就回不来了…到最后只好碰到恶心的组合就直接不打了…</p><p>总的来说…从游戏系统上…个人感觉这是一个玩着特别累的游戏…剧情方面由于主角实在太中二, 反复穿越时间的各种不合理, 反派的智商硬伤, 最后没道理的强行团圆等等, 也不能给这个游戏带来什么加分…所以对我来说, 打通这个游戏只能算是消除心中的残念, 至于再打一次或者向别人推荐…免了吧…</p><p><img src="https://gss2.bdstatic.com/9fo3dSag_xI4khGkpoWK1HF6hhy/baike/w%3D268%3Bg%3D0/sign=2e902d16e3f81a4c2632ebcfef110764/a5c27d1ed21b0ef43976073cd5c451da81cb3e31.jpg" class="lazyload" data-srcset="https://gss2.bdstatic.com/9fo3dSag_xI4khGkpoWK1HF6hhy/baike/w%3D268%3Bg%3D0/sign=2e902d16e3f81a4c2632ebcfef110764/a5c27d1ed21b0ef43976073cd5c451da81cb3e31.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 游戏评测 </tag>
            
            <tag> 宿命传说2 </tag>
            
            <tag> 童年回忆 </tag>
            
            <tag> 游戏系统 </tag>
            
            <tag> Tales of Destiny 2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Melody&#39;s Escape</title>
      <link href="/2016/06/05/Melody-s-Escape/"/>
      <url>/2016/06/05/Melody-s-Escape/</url>
      
        <content type="html"><![CDATA[<p>不知这首歌的原出处是哪, 反正我是玩Melody’s Escape听到的…  </p><p>这游戏的一大特点是音乐自选, 官方只自带的5首歌(就包括这首Regain Control), 但是你可以选择任何自己有的音乐进行游戏(支持MP3s, WMAs, iTunes, FLAC等格式), 把原来喜欢听的ACG歌曲翻出来一首首跑一遍还是挺带感的~</p><p>对于音游粉丝来说旋律逃脱应该还挺简单的, 一共就八个按键…..如果是和我一样第一次玩音游的手残来, 从Medium(四个按键)开始会比较容易上手, 两个手都有点手感了再尝试八个按键.</p><p>另外感觉初玩最好还是选节奏感强的乐曲跑, 因为这种乐曲大部分按键都在节奏点上, 比较容易按.  </p><p>个人玩了一个星期左右发现比较带感且相对简单的乐曲有:</p><p>AlieZ, βios, X.U, Hero’s Come Back, only my railgun, hollow World  </p><p>唯一的遗憾是这个游戏目前是完全的单人游戏, 不知道作者之后会不会加入本地对抗的模式呢……</p><p><a href="https://store.steampowered.com/app/270210/Melodys_Escape/">steam链接</a></p><iframe src="https://media.st.dl.bscstorage.net/steam/apps/256664362/movie480.webm?t=1463677466" width="700" height="500" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 音游 </tag>
            
            <tag> 音乐游戏 </tag>
            
            <tag> 节奏游戏 </tag>
            
            <tag> 游戏体验 </tag>
            
            <tag> 游戏推荐 </tag>
            
            <tag> 独立游戏 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>哔哩哔哩 - ( ゜- ゜)つロ 乾杯~</title>
      <link href="/2016/02/21/%E5%B0%8F%E7%94%B5%E8%A7%86%E9%BC%A0%E6%A0%87%E5%9E%AB/"/>
      <url>/2016/02/21/%E5%B0%8F%E7%94%B5%E8%A7%86%E9%BC%A0%E6%A0%87%E5%9E%AB/</url>
      
        <content type="html"><![CDATA[<!-- 摘要部分 --><span id="more"></span><p>啊, 昨天鼠标垫到了耶…..这是本人第一次买周边…..</p><p>弄了好大一个箱子过来, 我还幻想发错货多给了个小电视什么的…….</p><p>当然现实总是残酷的…….毕竟我也就买了一个鼠标垫嘛&#x3D; &#x3D;||||</p><p>不过见到实物后还是不由得感叹, 果然很大大大大大大~~~~</p><p>摆在桌上的效果还是不错的~可以看着2233还有小电视卖一年的萌了2333333</p><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/bilibili_mouse.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/bilibili_mouse.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="bilibili_mouse"></p><p>我很开心的把照片分享给了基友, 然而他的回答&#x3D; &#x3D;||||………</p><p>好吧….我祝你和你女神元宵节愉快&#x3D; &#x3D;|||||</p>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 哔哩哔哩 </tag>
            
            <tag> 小电视 </tag>
            
            <tag> 鼠标垫 </tag>
            
            <tag> 周边 </tag>
            
            <tag> 开箱 </tag>
            
            <tag> Daily </tag>
            
            <tag> Bilibili </tag>
            
            <tag> Mousepad </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>晶体管</title>
      <link href="/2016/01/01/%E6%99%B6%E4%BD%93%E7%AE%A1/"/>
      <url>/2016/01/01/%E6%99%B6%E4%BD%93%E7%AE%A1/</url>
      
        <content type="html"><![CDATA[<p>这是一个非常有特色的游戏, 画面非常出彩, 披着ARPG的皮的策略游戏. 故事叙事上有点魂的意思(如果不自己探寻隐藏信息的话完全不知道讲了个XX). 印象中这是我在Steam上购买的第一个游戏(当时刚开放国区, 到库还花了小几天), 也是因为这个游戏我开始关注游戏的制作组, 后来还补了堡垒和后来的柴堆(柴堆至今没打开过…)</p><!-- 摘要部分 --><span id="more"></span><p><img src="https://raw.githubusercontent.com/SilenWang/Gallary/master/transistor.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/SilenWang/Gallary/master/transistor.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p>]]></content>
      
      
      <categories>
          
          <category> Gaming </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 独立游戏 </tag>
            
            <tag> 策略游戏 </tag>
            
            <tag> 晶体管 </tag>
            
            <tag> ARPG </tag>
            
            <tag> Transistor </tag>
            
            <tag> Supergiant-Games </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
